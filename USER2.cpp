#include "stdafx.h"
#include "Server.h"
#include "USER.h"
#include "COM.h"
#include "CircularBuffer.h"
#include "BufferEx.h"
#include "Item.h"
#include "Hyper.h"
#include "Mcommon.h"
#include "Search.h"
#include "ServerDlg.h"
#include "Mcommon.h"
#include "UserManager.h"
#include "UNI_CHAR.h"
#include "RoyalRumble.h"

#include "EventZone.h"
#include "ShopSystem.h"

extern ShopSystem g_Shop;

#ifdef _DEBUG
#undef THIS_FILE
static char THIS_FILE[]=__FILE__;
#define new DEBUG_NEW
#endif

#include "Extern.h"		//	¿ÜºÎº¯¼ö ¼±¾ð

extern CUserManager *g_pUQM;
extern CSearch *g_pUserList;
extern CServerDlg *g_pMainDlg;

//extern CRITICAL_SECTION m_CS_ReceiveData[];
extern CRITICAL_SECTION m_CS_FileWrite;
extern CRITICAL_SECTION m_CS_EventItemLogFileWrite;
extern CPtrList RecvPtrList[];
extern long nRecvDataLength[];

// IKING 2002.1.
extern CRITICAL_SECTION m_CS_LoginData;
extern CPtrList RecvLoginData;
extern long nLoginDataCount;
extern CRITICAL_SECTION m_CS_LogoutData;
extern CPtrList RecvLogoutData;
extern long nLogoutDataCount;				


extern CPtrList RecvSqlData;
extern CRITICAL_SECTION m_CS_SqlData;
extern long nSqlDataCount;	
extern int g_ChatEnable[];
extern  struct convert_table convert[80];

extern CHATDATAPACKET *g_WaitRecvDataChat[DATA_BUF_SIZE_FOR_THREAD+1][AUTOMATA_THREAD+1];
extern int g_nChatDataHead[];
extern int g_nChatDataTail[];

extern BYTE g_ServerId;
extern CRoyalRumble g_RR;

extern short		g_sHPConst[NEW_CLS_NUM];
extern short		g_sPPConst[NEW_CLS_NUM];
extern short		g_sSPConst[NEW_CLS_NUM];

extern short		g_sHPLV[NEW_CLS_NUM];
extern short		g_sPPLV[NEW_CLS_NUM];
extern short		g_sSPLV[NEW_CLS_NUM];

extern short		g_sHPAdd[NEW_CLS_NUM];
extern short		g_sPPAdd[NEW_CLS_NUM];
extern short		g_sSPAdd[NEW_CLS_NUM];

extern TCHAR g_arServerIPAddr[16];
extern CString g_strARKRRWinner;

// Quest Event Class
extern CEventZone	g_QuestEventZone;

extern long	g_PotionViewOnOff;

const char* g_pszReservedLoveName[] = 
{
"GM",
"gm",
"¹ÜÀí",
"¾öÕ½",
"admin",
};
const char* g_pszReservedID[] = 
{
	"GM",
	"gm",
"¹ÜÀí",
"¾öÕ½",
"¡£",
"!",
"£¡",
"Ðû´«",
"¡¡",
"¤ô",
"¤õ",
"¤ö",
"¤÷",
"¤ø",
"¤ù",
"¤ú",
"¤û",
"¤ü",
"¤ý",
"¤þ",
"¥÷",
"¥ø",
"¥ù",
"¥ù",
"¥ú",
"¥û",
"¥ü",
"¥ý",
"¥þ",
"¦¹",
"¦º",
"¦»",
"¦¼",
"¦½",
"¦¾",
"¦¿",
"¦À",
"¦ö",
"¦÷",
"¦ø",
"¦ù",
"¦ú",
"¦û",
"¦ü",
"¦ý",
"¦þ",
"§Â",
"§Ã",
"§Ä",
"§Å",
"§Æ",
"§Ç",
"§È",
"§É",
"§Ê",
"§Ë",
"§Ì",
"§Í",
"§Î",
"§ü",
"§ý",
"§þ",
"¨Á",
"¨Â",
"¨Ã",
"¨Ä",
"¨ê",
"¨ë",
"¨ì",
"¨ì",
"¨í",
"¨î",
"¨ï",
"¨ð",
"¨ñ",
"¨ò",
"¨ó",
"¨ô",
"¨õ",
"¨ö",
"¨÷",
"¨ø",
"¨ù",
"¨ú",
"¨û",
"¨ü",
"¨ý",
"¨þ",
"©¡",
"©¢",
"©£",
"©ð",
"©ñ",
"©ò",
"©ó",
"©ô",
"©õ",
"©ö",
"©÷",
"©ø",
"©ù",
"©ú",
"©û",
"©ü",
"©ý",
"©þ",
"¯Î¯Î¯Î¯Î¯Î",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
".",
"!",
"#",
"$",
"%",
"&",
"'",
"(",
")",
"*",
"+",
",",
"-",
".",
"/",
":",
";",
"<",
"=",
">",
"@",
"[",
"]",
"^",
"_",
"`", 
"{",
"|",
"}",
"~",
"",
"¡é",
"¡ê",
"¡è",
"£¤",
"|",
"¡ì",
"¡§",
"-",
"¡¥",
"¡ã",
"¡À",
"¡ä",
"¦Ì",
"¡¤",
"¨¤",
"¨¢",
"¨¨",
"¨¦",
"¨º",
"¨¬",
"¨ª",
"¨°",
"¨®",
"¡Á",
"¨´",
"¨²",
"¨¹",
"¨¤",
"¨¢",
"¨¨",
"¨¦",
"¨º",
"¨¬",
"¨ª",
"¨°",
"¨®",
"¡Â",
"¨´",
"¨²",
"¨¹",
"¨¡",
"¨¡",
"¨¥",
"¨¥",
"¨§",
"¨§",
"¨©",
"¨©",
"¨½",
"¨¾",
"¨­",
"¨­",
"¨±",
"¨±",
"¡Î",
"¨£",
"¨£",
"¨«",
"¨«",
"¨¯",
"¨¯",
"¨³",
"¨³",
"¨µ",
"¨µ",
"¨¶",
"¨¶",
"¨·",
"¨·",
"¨¸",
"¨¸",
"¨»",
"¨À",
"¡¦",
"¡¥",
"¨@",
"¨A",
"¨B",
"¦¡",
"¦¢",
"¦£",
"¦¤",
"¦¥",
"¦¦",
"¦§",
"¦¨",
"¦©",
"¦ª",
"¦«",
"¦¬",
"¦­",
"¦®",
"¦¯",
"¦°",
"¦±",
"¦²",
"¦³",
"¦´",
"¦µ",
"¦¶",
"¦·",
"¦¸",
"¦Á",
"¦Â",
"¦Ã",
"¦Ä",
"¦Å",
"¦Æ",
"¦Ç",
"¦È",
"¦É",
"¦Ê",
"¦Ë",
"¦Ì",
"¦Í",
"¦Î",
"¦Ï",
"¦Ð",
"¦Ñ",
"¦Ò",
"¦Ó",
"¦Ô",
"¦Õ",
"¦Ö",
"¦×",
"¦Ø",
"§§",
"§¡",
"§¢",
"§£",
"§¤",
"§¥",
"§¦",
"§¨",
"§©",
"§ª",
"§«",
"§¬",
"§­",
"§¯",
"§°",
"§±",
"§²",
"§³",
"§´",
"§µ",
"§¶",
"§·",
"§¸",
"§¹",
"§º",
"§»",
"§¼",
"§½",
"§¾",
"§¿",
"§À",
"§Á",
"§Ñ",
"§Ò",
"§Ó",
"§Ô",
"§Õ",
"§Ö",
"§Ø",
"§Ù",
"§Ú",
"§Û",
"§Ü",
"§Ý",
"§Þ",
"§ß",
"§à",
"§á",
"§â",
"§ã",
"§ä",
"§å",
"§æ",
"§ç",
"§è",
"§é",
"§ê",
"§ë",
"§ì",
"§í",
"§î",
"§ï",
"§ð",
"§ñ",
"§×",
"©\",
"¨C",
"¡ª",
"¨D",
"¡¬",
"'",
"'",
"¨E",
"¡­",
"¡ë",
"¡ä",
"¡å",
"¨F",
"¡ù",
"£þ",
"€",
"¡æ",
"¨G",
"¨H",
"¡í",
"©Y",
"¢ñ",
"¢ò",
"¢ó",
"¢ô",
"¢õ",
"¢ö",
"¢÷",
"¢ø",
"¢ù",
"¢ú",
"¢û",
"¢ü",
"¢¡",
"¢¢",
"¢£",
"¢¤",
"¢¥",
"¢¦",
"¢§",
"¢¨",
"¢©",
"¢ª",
"¡û",
"¡ü",
"¡ú",
"¡ý",
"¨I",
"¨J",
"¨K",
"¨L",
"¡Ê",
"¡Ç",
"¡Æ",
"¨M",
"¡ã",
"¡Ì",
"¡Ø",
"¡Þ",
"¨N",
"¡Ï",
"¨O",
"¡Î",
"¡Ä",
"¡Å",
"¡É",
"¡È",
"¡Ò",
"¡Ó",
"¡à",
"¡ß",
"¡Ã",
"¡Ë",
"¡«",
"¡×",
"¡Ö",
"¡Õ",
"¨P",
"¡Ù",
"¡Ô",
"¡Ü",
"¡Ý",
"¨Q",
"¨R",
"¡Ú",
"¡Û",
"¨’",
"¡Ñ",
"¡Í",
"¨S",
"¡Ð",
"¢Ù",
"¢Ú",
"¢Û",
"¢Ü",
"¢Ý",
"¢Þ",
"¢ß",
"¢à",
"¢á",
"¢â",
"¢Å",
"¢Æ",
"¢Ç",
"¢È",
"¢É",
"¢Ê",
"¢Ë",
"¢Ì",
"¢Í",
"¢Î",
"¢Ï",
"¢Ð",
"¢Ñ",
"¢Ò",
"¢Ó",
"¢Ô",
"¢Õ",
"¢Ö",
"¢×",
"¢Ø",
"¢±",
"¢²",
"¢³",
"¢´",
"¢µ",
"¢¶",
"¢·",
"¢¸",
"¢¹",
"¢º",
"¢»",
"¢¼",
"¢½",
"¢¾",
"¢¿",
"¢À",
"¢Á",
"¢Â",
"¢Ã",
"¢Ä",
"©¤",
"©¥",
"©¦",
"©§",
"©¨",
"©©",
"©ª",
"©«",
"©¬",
"©­",
"©®",
"©¯",
"©°",
"©±",
"©²",
"©³",
"©´",
"©µ",
"©¶",
"©·",
"©¸",
"©¹",
"©º",
"©»",
"©¼",
"©½",
"©¾",
"©¿",
"©À",
"©Á",
"©Â",
"©Ã",
"©Ä",
"©Å",
"©Æ",
"©Ç",
"©È",
"©É",
"©Ê",
"©Ë",
"©Ì",
"©Í",
"©Î",
"©Ï",
"©Ð",
"©Ñ",
"©Ò",
"©Ó",
"©Ô",
"©Õ",
"©Ö",
"©×",
"©Ø",
"©Ù",
"©Ú",
"©Û",
"©Ü",
"©Ý",
"©Þ",
"©ß",
"©à",
"©á",
"©â",
"©ã",
"©ä",
"©å",
"©æ",
"©ç",
"©è",
"©é",
"©ê",
"©ë",
"©ì",
"©í",
"©î",
"©ï",
"¨T",
"¨U",
"¨V",
"¨W",
"¨X",
"¨Y",
"¨Z",
"¨[",
"¨\",
"¨]",
"¨^",
"¨_",
"¨`",
"¨a",
"¨b",
"¨c",
"¨d",
"¨e",
"¨f",
"¨g",
"¨h",
"¨i",
"¨j",
"¨k",
"¨l",
"¨m",
"¨n",
"¨o",
"¨p",
"¨q",
"¨r",
"¨s",
"¨t",
"¨u",
"¨v",
"¨w",
"¨x",
"¨y",
"¨z",
"¨{",
"¨|",
"¨}",
"¨~",
"¨€",
"¨",
"¨‚",
"¨ƒ",
"¨„",
"¨…",
"¨†",
"¨‡",
"¨ˆ",
"¨‰",
"¨Š",
"¡ö",
"¡õ",
"¡ø",
"¡÷",
"¨‹",
"¨Œ",
"¡ô",
"¡ó",
"¡ð",
"¡ò",
"¡ñ",
"¨",
"¨Ž",
"¨",
"¨",
"¡ï",
"¡î",
"¨‘",
"¡â",
"¡á",
"¡¢",
"¡£",
"¡¨",
"¡©",
"©e",
"©–",
"¡´",
"¡µ",
"¡¶",
"¡·",
"¡¸",
"¡¹",
"¡º",
"¡»",
"¡¾",
"¡¿",
"¨“",
"¡þ",
"¡²",
"¡³",
"¡¼",
"¡½",
"¨”",
"¨•",
"©@",
"©A",
"©B",
"©C",
"©D",
"©E",
"©F",
"©G",
"©H",
"¤¡",
"¤¢",
"¤£",
"¤¤",
"¤¥",
"¤¦",
"¤§",
"¤¨",
"¤©",
"¤ª",
"¤«",
"¤¬",
"¤­",
"¤®",
"¤¯",
"¤°",
"¤±",
"¤²",
"¤³",
"¤´",
"¤µ",
"¤¶",
"¤·",
"¤¸",
"¤¹",
"¤º",
"¤»",
"¤¼",
"¤½",
"¤¾",
"¤¿",
"¤À",
"¤Á",
"¤Â",
"¤Ã",
"¤Ä",
"¤Å",
"¤Æ",
"¤Ç",
"¤È",
"¤É",
"¤Ê",
"¤Ë",
"¤Ì",
"¤Í",
"¤Î",
"¤Ï",
"¤Ð",
"¤Ñ",
"¤Ò",
"¤Ó",
"¤Ô",
"¤Õ",
"¤Ö",
"¤×",
"¤Ø",
"¤Ù",
"¤Ú",
"¤Û",
"¤Ü",
"¤Ý",
"¤Þ",
"¤ß",
"¤à",
"¤á",
"¤â",
"¤ã",
"¤ä",
"¤å",
"¤æ",
"¤ç",
"¤è",
"¤é",
"¤ê",
"¤ë",
"¤ì",
"¤í",
"¤î",
"¤ï",
"¤ð",
"¤ñ",
"¤ò",
"¤ó",
"©a",
"©b",
"©f",
"©g",
"¥¡",
"¥¢",
"¥£",
"¥¤",
"¥¥",
"¥¦",
"¥§",
"¥¨",
"¥©",
"¥ª",
"¥«",
"¥¬",
"¥­",
"¥®",
"¥¯",
"¥°",
"¥±",
"¥²",
"¥³",
"¥´",
"¥µ",
"¥¶",
"¥·",
"¥¸",
"¥¹",
"¥º",
"¥»",
"¥¼",
"¥½",
"¥¾",
"¥¿",
"¥À",
"¥Á",
"¥Â",
"¥Ã",
"¥Ä",
"¥Å",
"¥Æ",
"¥Ç",
"¥È",
"¥É",
"¥Ê",
"¥Ë",
"¥Ì",
"¥Í",
"¥Î",
"¥Ï",
"¥Ð",
"¥Ñ",
"¥Ò",
"¥Ó",
"¥Ô",
"¥Õ",
"¥Ö",
"¥×",
"¥Ø",
"¥Ù",
"¥Ú",
"¥Û",
"¥Ü",
"¥Ý",
"¥Þ",
"¥ß",
"¥à",
"¥á",
"¥â",
"¥ã",
"¥ä",
"¥å",
"¥æ",
"¥ç",
"¥è",
"¥é",
"¥ê",
"¥ë",
"¥ì",
"¥í",
"¥î",
"¥ï",
"¥ð",
"¥ñ",
"¥ò",
"¥ó",
"¥ô",
"¥õ",
"¥ö",
"©`",
"©c",
"©d",
"¨Å",
"¨Æ",
"¨Ç",
"¨È",
"¨É",
"¨Ê",
"¨Ë",
"¨Ì",
"¨Í",
"¨Î",
"¨Ï",
"¨Ð",
"¨Ñ",
"¨Ò",
"¨Ó",
"¨Ô",
"¨Õ",
"¨Ö",
"¨×",
"¨Ø",
"¨Ù",
"¨Ú",
"¨Û",
"¨Ü",
"¨Ý",
"¨Þ",
"¨ß",
"¨à",
"¨á",
"¨â",
"¨ã",
"¨ä",
"¨å",
"¨æ",
"¨ç",
"¨è",
"¨é",
"¢å",
"¢æ",
"¢ç",
"¢è",
"¢é",
"¢ê",
"¢ë",
"¢ì",
"¢í",
"¢î",
"©Z",
"©I",
"©J",
"©K",
"©L",
"©M",
"©N",
"©O",
"©P",
"©Q",
"©R",
"©S",
"©T",
"¨¼",
"¨¿",
"©‰",
"©Š",
"©‹",
"©Œ",
"©",
"©Ž",
"©",
"©",
"©‘",
"©’",
"©“",
"©”",
"©•",
"þP",
"þQ",
"þR",
"þS",
"þT",
"þW",
"þX",
"þY",
"þ]",
"þ^",
"þa",
"þf",
"þg",
"þk",
"þl",
"þm",
"þn",
"þq",
"þs",
"þt",
"þu",
"þv",
"þy",
"þ~",
"þ„",
"©U",
"¦ò",
"¦ô",
"¦õ",
"¦à",
"¦á",
"¦ð",
"¦ñ",
"¦â",
"¦ã",
"¦î",
"¦ï",
"¦æ",
"¦ç",
"¦ä",
"¦å",
"¦è",
"¦é",
"¦ê",
"¦ë",
"©h",
"©i",
"©j",
"©k",
"©l",
"©m",
"©n",
"©o",
"©p",
"©q",
"©r",
"©s",
"©t",
"©u",
"©v",
"©w",
"©x",
"©y",
"©z",
"©{",
"©|",
"©}",
"©~",
"©€",
"©",
"©‚",
"©ƒ",
"©„",
"©…",
"©†",
"©‡",
"©ˆ",
"£¡",
"£¢",
"££",
"¡ç",
"£¥",
"£¦",
"£§",
"£¨",
"£©",
"£ª",
"£«",
"£¬",
"£­",
"£®",
"£¯",
"£°",
"£±",
"£²",
"£³",
"£´",
"£µ",
"£¶",
"£·",
"£¸",
"£¹",
"£º",
"£»",
"£¼",
"£½",
"£¾",
"£¿",
"£À",
"£Û",
"£Ü",
"£Ý",
"£Þ",
"£ß",
" ",
"£à",
"£û",
"£ü",
"£ý",
"¡«",
"¡é",
"¡ê",
"©V",
"£þ",
"©W",
"£¤",
"Ø­",
"L",
"ãÜ",
"Ø¼",
"R",
"Ø¯",
"T",
"U",
"V",
"W",
"X",
"^",
"|",
"Ùï",
"Øé",
"Øç",
"Ùû",
"ØÖ",
"Ú¥",
"åÁ",
"áŽ",
"îÄ",
"Úâ",
"ïz",
" «",
"â»",
"…m",
"…›",
"ÛÌ",
"…Ÿ",
"æÞ",
"å²",
"çÝ",
"Žw",
"áÜ",
"ÛÈ",
"áê",
"åæ",
"áÜ",
"âà",
"ÞÐ",
"ë¶",
"ãß",
"ìá",
" ",
"áë",
"ðÚ",
"°h",
"ìê",
"¼i",
"æù",
"ÀŸ",
"À ",
"ÂS",
"Ü³",
"ò®",
"Ó…",
"Ò‚",
"þW",
"þX",
"þP",
"þQ",
"þR",
"þS",
"þT",
"þY",
"þ]",
"þ^",
"þf",
"þg",
"þk",
"þl",
"þm",
"þn",
"þq",
"þs",
"þt",
"þu",
"þv",
"þy",
"þ„",
"þU",
"þV",
"ƒÇ",
"‘",
"’",
"",
"‚",
"…¹",
"Í¹",
"°¼",
"…j",
"…d",
"…e",
"…[",
"°z",
"”ú",
"«T",
"Œ¨",
"ŽÔ",
"–W",
"‡ß",
"‡à",
"Çô",
"ËÄ",
"‡á",
"àî",
"»Ø",
"Ø¶",
"Òò",
"àï",
"ÍÅ",
"‡â",
"¶Ú",
"‡ã",
"‡ä",
"‡å",
"‡æ",
"‡ç",
"‡è",
"àñ",
"‡é",
"Ô°",
"‡ê",
"‡ë",
"À§",
"´Ñ",
"‡ì",
"‡í",
"Î§",
"àð",
"‡î",
"‡ï",
"‡ð",
"àò",
"¹Ì",
"‡ñ",
"‡ò",
"¹ú",
"Í¼",
"àó",
"‡ó",
"‡ô",
"‡õ",
"ÆÔ",
"àô",
"‡ö",
"Ô²",
"‡÷",
"È¦",
"àö",
"àõ",
"‡ø",
"‡ù",
"‡ú",
"‡û",
"‡ü",
"‡ý",
"‡þ",
"ˆ@",
"ˆA",
"ˆB",
"ˆC",
"ˆD",
"ˆE",
"ˆF",
"ˆG",
"ˆH",
"ˆI",
"à÷",
"ˆJ",
"ˆK",
"÷Ñ",
".",
"¡¢",
"¦á",
"¨ã",
"©¬",
"©â",
"¤Ù",
"_",
"þu",
"©è",
"¡ú",
"^",
"o",
"^",
"^",
"¨¯",
"^",
"¨q",
"¥¡",
"þu",
"_",
"þu",
"/",
"~",
"¨K",
"¨{",
"¦î",
"©ß",
"©×",
"¨T",
"Ò»",
"¤¸",
"¨°",
"¤Ô",
"¨¦",
".",
".",
".",
".",
".",
".",
"þy",
";",
"þy",
"©Æ",
"©Ê",
"(",
"*",
"^",
"©n",
"^",
"*",
")"
};

//
static short g_sBabyArray[] ={256,257,512,513,768,769};
TCHAR *g_szBabyName[]={"Å¦ÌØÁú","ÅÁÌØÊ¨"};
void USER::AccountLoginReqWithDbServer(TCHAR *pBuf)
{
	char id[MAX_ID+1];
	int index = 0;
	BYTE	result = FAIL, error_code = 0;

	int	nIDLength = GetVarString(sizeof(id), id, pBuf, index);
	if(nIDLength == 0 || nIDLength > ACCOUNT_LENGTH)	
	{
		error_code = 1;
		index = 0;
		SetByte(m_TempBuf, ACCOUNT_LOGIN_RESULT, index );
		SetByte(m_TempBuf, result, index );
		SetByte(m_TempBuf, error_code, index);
		Send( m_TempBuf, index );
		SoftClose();
		return;
	}

	if ( IsDoubleAccount(id) )
	{
		error_code = ERR_2;
		index = 0;
		SetByte(m_TempBuf, ACCOUNT_LOGIN_RESULT, index );
		SetByte(m_TempBuf, result, index );

		SetByte(m_TempBuf, error_code, index);
		Send( m_TempBuf, index );
		SoftClose();
		return;
	}

	strcpy( m_strAccount, id );

	char TempBuf[1024];
	index = 0;
	SetByte(TempBuf, g_ServerId, index );
	SetByte(TempBuf, ACCOUNT_LOGIN_REQ, index );
	SetShort(TempBuf, m_uid, index );
	SetString(TempBuf, id, ACCOUNT_LENGTH, index);
	g_pMainDlg->Send2DBsvr( TempBuf, index );

}

void USER::GameStartWithDbServer(TCHAR *pBuf)
{
	int			index = 0;
	BYTE		result = FAIL;
	TCHAR		szID[CHAR_NAME_LENGTH+1];

	int	nIDLength = GetVarString(sizeof(szID), szID, pBuf, index);
	if ( nIDLength == 0 || nIDLength > CHAR_NAME_LENGTH )
	{
		CBufferEx TempBuf;

		ReInitMemoryDB();

		TempBuf.Add(GAME_START_RESULT);
		TempBuf.Add(result);
		TempBuf.Add(ERR_1);
		Send(TempBuf, TempBuf.GetLength());
		SoftClose();
		return;
	}

	memcpy( m_strUserID, szID, CHAR_NAME_LENGTH );

	char TempBuf[1024];
	index = 0;
	SetByte(TempBuf, g_ServerId, index );
	SetByte(TempBuf, GAME_START_REQ, index );
	SetShort(TempBuf, m_uid, index );
	SetString(TempBuf, szID, CHAR_NAME_LENGTH, index);
	g_pMainDlg->Send2DBsvr( TempBuf, index );
}

void USER::LogOutWithDbServer()
{
	if(m_bLogOut == TRUE) return;
	if(m_state != STATE_GAMESTARTED) return;	// ÀÌ¿Ü STATE_CONNECTEDµî ÀÏ¶§´Â ÇØ´ç ÃÊ±âÈ­°¡ ¸Þ¸ð¸®¿¡¾øÀ¸¹Ç·Î Á¦¿ÜÇØ¾ßÇÑ´Ù.

	m_bLogOut = TRUE;
	USER *pUser = NULL;
												// ÀÏ¹Ý ÇÊµåÀü ÁßÀÌ¶ó¸é..		
	if(m_tGuildWar == GUILD_WARRING && m_dwFieldWar > 0)		
	{
		if(m_bGuildMaster) 
		{
			CString strMsg = _T("");
			strMsg.Format( IDS_USER_GUILD_DEFEAT, m_strGuildName);
			SendGuildWarFieldEnd((LPTSTR)(LPCTSTR)strMsg);// Ç×º¹
		}
	}

	if(m_tGuildHouseWar == GUILD_WARRING) CheckGuildUserListInGuildHouseWar(); // ´Ù¸¥ À¯ÀúµéÀº ¹»ÇÏ³ª Ã¼Å©..

	if(m_bNowBuddy == TRUE)				// ¹öµðÁßÀÌ¸é Åëº¸ÇÑ´Ù.
	{
		for(int i = 0; i < MAX_BUDDY_USER_NUM; i++)
		{
			if(m_MyBuddy[i].uid == m_uid + USER_BAND) SendBuddyUserLeave(i);
		}
	}

	// °Å·¡ÁßÀÌ¸é °Å·¡Ãë¼Ò Ã³¸®
	if(m_bNowTrading == TRUE) 
	{
		BYTE result = 0x00;
		USER *pTradeUser = NULL;
		if(m_iTradeUid != -1)	pTradeUser = GetUser(m_iTradeUid - USER_BAND);

		if(pTradeUser != NULL)	pTradeUser->SendExchangeFail(result, (BYTE)0x05);
	}

	{
	// 
	//UpdateMemBankDataOnly();
	//UpdateUserData(TRUE);
	char send_buffer[RECEIVE_BUF_SIZE+1];
	int send_index = 0, c_index = 0;;
	TCHAR strBankItem[_BANK_DB];

	SetByte(send_buffer, g_ServerId, send_index );
	SetByte( send_buffer, (BYTE)LOGOUT_REQ, send_index );
	SetShort( send_buffer, m_uid, send_index );

	// UpdateMemBankDataOnly() PART...
	::ZeroMemory(strBankItem, sizeof(strBankItem));
	::CopyMemory(strBankItem, m_pMD->m_UB.m_UserBankItem, _BANK_DB);

	c_index = send_index;

	SetString( send_buffer, m_strUserID, CHAR_NAME_LENGTH, send_index );
	SetDWORD( send_buffer, m_pMD->m_UB.m_dwBankDN, send_index );
	SetString( send_buffer, strBankItem, sizeof(strBankItem), send_index );
	//

	// UpdateUserData(TRUE) PART...
	DBUpdateUserData( send_buffer, send_index );
	//

	// ¾ÐÃàÇÏ±â...
	m_CompMng.FlushAddData();
	m_CompMng.AddData( &send_buffer[c_index], (send_index-c_index) );

	m_CompMng.PreCompressWork();
	m_CompMng.Compress();

	int comp_data_len = m_CompMng.GetCompressedDataCount();
	int org_data_len = m_CompMng.GetUnCompressDataLength();
	DWORD crc_value = m_CompMng.GetCrcValue();
	char *packet_buffer;
	packet_buffer = m_CompMng.GetExtractedBufferPtr();

	SetShort( send_buffer, comp_data_len, c_index );
	SetShort( send_buffer, org_data_len, c_index );
	SetDWORD( send_buffer, crc_value, c_index );
	SetString( send_buffer, packet_buffer, comp_data_len, c_index );
	m_CompMng.FlushAddData();

	// Àü¼Û.
	g_pMainDlg->Send2DBsvr( send_buffer, c_index );
	}

	m_pMD->m_UB.m_uid = -1;

	ReInitMemoryDB();

	if( g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser == USER_BAND + m_uid ) 
		::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);

	SendMyInfo(TO_INSIGHT, INFO_DELETE);

	m_state = STATE_LOGOUT;
}

void USER::DBUpdateUserData(char *temp_buffer, int &temp_index )
{
	TCHAR			szSQL[8000];		
	TCHAR			strFace[10], strSkill[_SKILL_DB], strItem[_ITEM_DB], strPsi[_PSI_DB], strTel[_TEL_DB];
	TCHAR			strQuickItem[_QUICKITEM_DB];
	TCHAR			strHaveEvent[_EVENT_DB];
	

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strFace, sizeof(strFace));
	::ZeroMemory(strSkill, sizeof(strSkill));
	::ZeroMemory(strItem, sizeof(strItem));
	::ZeroMemory(strPsi, sizeof(strPsi));	
	::ZeroMemory(strTel, sizeof(strTel));
	::ZeroMemory(strHaveEvent, sizeof(strHaveEvent));
	::ZeroMemory(strQuickItem, sizeof(strQuickItem));	
	::CopyMemory(strFace, m_strFace, sizeof(m_strFace));

	UserSkillToDBStr(strSkill);
	UserItemToStr(strItem);
	UserPsiToStr(strPsi);
	UserTelToStr(strTel);
	UserHaveEventDataToStr(strHaveEvent);

	DWORD dwCurTime = ConvertCurTimeToSaveTime();			// ÇöÀç ½Ã°£ ¹öÁ¯À» ¼ÂÆÃ

	m_tPsiOneKind = m_tPsiTwoKind = m_tPsiThreeKind = 0;
	m_dwPsiOneTime = m_dwPsiTwoTime = m_dwPsiThreeTime = 0;

	// Psionic One
	if(m_dwHasteTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_HASTE;
		m_dwPsiOneTime = m_dwHasteTime;
	}
	if(m_dwShieldTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_SHIELD;
		m_dwPsiOneTime = m_dwShieldTime;
	}
	if(m_dwDexUpTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_DEXUP;
		m_dwPsiOneTime = m_dwDexUpTime;
	}
	if(m_dwMaxHPUpTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_HPUP;
		m_dwPsiOneTime = m_dwMaxHPUpTime;
	}
	if(m_dwFastRunTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_FAST_RUN;
		m_dwPsiOneTime = m_dwFastRunTime;
	}
	if(m_dwMindShockTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_MIND_SHOCK;
		m_dwPsiOneTime = m_dwMindShockTime;
	}
	if(m_dwPsiShieldTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_PSI_SHIELD;
		m_dwPsiOneTime = m_dwPsiShieldTime;
	}
	if(m_dwBigShieldTime != 0) 
	{
		m_tPsiOneKind = 30;
		m_dwPsiOneTime = m_dwBigShieldTime;
	}
	if(m_dwPiercingShieldTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_PIERCING_SHIELD;
		m_dwPsiOneTime = m_dwPiercingShieldTime;
	}

	// Psionic Two
	if(m_dwAdamantineTime != 0) 
	{
		m_tPsiTwoKind = PSIONIC_ADAMANTINE;
		m_dwPsiTwoTime = m_dwAdamantineTime;
	}
	if(m_dwMightyWeaponTime != 0) 
	{
		m_tPsiTwoKind = PSIONIC_MIGHTYWEAPON;
		m_dwPsiTwoTime = m_dwMightyWeaponTime;
	}
	if(m_dwBerserkerTime != 0) 
	{
		m_tPsiTwoKind = PSIONIC_BERSERKER;
		m_dwPsiTwoTime = m_dwBerserkerTime;
	}

	// Psionic Three
	if(m_dwMindGuardTime != 0) 
	{
		m_tPsiThreeKind = PSIONIC_MIND_GUARD;
		m_dwPsiThreeTime = m_dwMindGuardTime;
	}
	  //////////////////¼Ó×Ö¶Î
    _sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_DATA (\'%s\',%d,%d,%d,%d,%d,%d,%d,%d,\
		?, %d,%d,%d, %d, %d,%d,  %d,%d,  %d, \
		%d,%d,%d,%d,%d,%d, %d,%d,%d,%d, \
		?,?,?,?, %d,%d,\
		%d, %d, ?, %d, %d,\
		?, %d,\
		%d, %d, %d, %d, %d, %d, %d, %d, %d, %d,%d,%d,%d,,%d,%d,%d,%d,%d,%d,%d,%d,\
		\'%s\', \
		%d,%d,		%d,%d,		%d,%d)}"), 
		m_strUserID,	m_sSTR,	m_sCON,	m_sDEX,	m_sVOL,	m_sWIS,	m_iSkin, m_iHair, m_sGender,	
		m_curz,	m_curx,	m_cury,		m_dwBuddy,		m_dwGuild, m_dwExp,		m_sPA, m_sSkillPoint,	m_dwXP,
		m_sMaxHP, m_sHP, m_sMaxPP, m_sPP, m_sMaxSP,	m_sSP,		m_dwDN,	m_sCityRank, m_sLevel,	m_byClass,

		m_tAbnormalKind, m_dwAbnormalTime,

		m_bLive, m_iCityValue, m_sKillCount, dwCurTime, 
		m_dwSaintTime, 
		m_dwHiExpTime, m_dwHtExpTime, m_dwMagicFindTime, m_dwMagicFtTime, m_dwNoChatTime,m_dwZF,m_dwXL, m_dwCloseTime, m_dwAutoMoney,m_dwPD,m_dwLingQu,m_dwShaGuai, m_dwGuarDianTianShi, m_dwShopPingDN,m_dwVIPTime,m_dwZaiXianTime,m_dwBFindTime,m_dwHXTime,m_dwSGTime,m_dwXYTime,m_dwZFTime,
		m_strLoveName, //--yskang 0.1 
		m_tPsiOneKind, m_dwPsiOneTime,		m_tPsiTwoKind, m_dwPsiTwoTime,		m_tPsiThreeKind, m_dwPsiThreeTime); 

	int sql_len = strlen(szSQL);
	SetShort( temp_buffer, sql_len, temp_index );
	SetString( temp_buffer, szSQL, sql_len, temp_index );

	//SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strFace),	0, (TCHAR*)strFace,		0, &sFaceLen );
	SetString( temp_buffer, strFace, sizeof(strFace), temp_index );

	//SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strSkill),	0, (TCHAR*)strSkill,	0, &sSkillLen );
	SetString( temp_buffer, strSkill, sizeof(strSkill), temp_index );

	//SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );
	SetString( temp_buffer, strItem, sizeof(strItem), temp_index );

	//SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strPsi),		0, (TCHAR*)strPsi,		0, &sPsiLen );
	SetString( temp_buffer, strPsi, sizeof(strPsi), temp_index );

	//SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strHaveEvent),	0, (TCHAR*)strHaveEvent,	0, &sEventLen );
	SetString( temp_buffer, strHaveEvent, sizeof(strHaveEvent), temp_index );

	//SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strQuickItem),	0, (TCHAR*)strQuickItem,	0, &sQuickLen );
	SetString( temp_buffer, strQuickItem, sizeof(strQuickItem), temp_index );

	//SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strTel),			0, (TCHAR*)strTel,			0, &sTelLen );
	SetString( temp_buffer, strTel, sizeof(strTel), temp_index );

	
}


//-----------------------------------------------------------------------------
// DB PHASER PART...
//-----------------------------------------------------------------------------


void USER::DBAccountLoginResult(TCHAR *pBuf, int s_index, int dlength )
{
	int		index = 0, i;
	BYTE	result = FAIL, error_code = 0;
	int		old_index = 0;
	int		s_result, length;

	strcpy(m_strChar[0], "");
	strcpy(m_strChar[1], "");
	strcpy(m_strChar[2], "");
	m_nCharNum = 0;

	s_result = GetByte( pBuf, s_index );
	if ( s_result == FALSE )
	{
		// Load Character Data Fail...
		error_code = UNKNOWN_ERR;
		goto result_send;
	}

	m_state = STATE_CONNECTED;
	result = SUCCESS;

	// LOGIN SERVER¿¡¼­ ¾òÀº Ä³¸¯ÅÍ °¹¼ö+ÀÌ¸§ º¹»ç...
	m_nCharNum = GetByte( pBuf, s_index );
	for ( i = 0; i < 3; i++ )
	{
		GetString(m_strChar[i], pBuf, 20, s_index );
	}
	//
	length = dlength - s_index;
	if ( length <= 0 ) result = FAIL;

result_send:
	index = 0;
	SetByte(m_TempBuf, ACCOUNT_LOGIN_RESULT, index );
	SetByte(m_TempBuf, result, index );

	if ( result == FAIL )
	{
		SetByte(m_TempBuf, error_code, index);
		Send( m_TempBuf, index );
		SoftClose();
		return;
	}

	// LOGIN SERVER¿¡¼­ ¾òÀº Ä³¸¯ÅÍ °¹¼ö+Á¤º¸ º¹»ç...
	SetString(m_TempBuf, (pBuf+s_index), length, index);

	Send(m_TempBuf, index);
}

void USER::DBGameStartResult( char *pBuf, int s_index, int dlength )
{

}

void USER::DressingWindowOpen()
{
	CBufferEx TempBuf;

	TempBuf.Add(DRESSING_WINDOW_OPEN);

	Send(TempBuf, TempBuf.GetLength());
}

void USER::DressingReq(TCHAR *pBuf)
{
	int index = 0;

	int itemslot = (int)GetShort( pBuf, index );
	int itemcount = (int)GetShort( pBuf, index );

	int i = 0;

	CItemTable* pItem = NULL;
	ItemList* pOrgItem = NULL;

	DRESSING_DATA* pDS = NULL;

	int makecount = itemcount / 10;
	int termcount = 0;
	int randseed[200];
	int randcount = 0;
	int randindex = 0;
	int randresult = -1;
	int j = 0;
	int k = 0;

	DressingResultArray arResult;	
	DRESSING_RESULT* pNewDRResult = NULL;
	BOOL bSameExist = FALSE;

	ItemListArray	arEmpty, arSame;
	CWordArray		arEmptySlot, arSameSlot;
	ItemList		MyItem[TOTAL_ITEM_NUM], SameItem[TOTAL_ITEM_NUM];
	int				pTotalEmpty[INVENTORY_NUM];

	short sid = -1, num = -1; 
	int iSlot, iEmptyNum = 0;
	int iWeight = 0;
	int iBasicItemWeight = 0;

	// º¯¼ö ÃÊ±âÈ­ ------------------------------------------------//
	BOOL bFlag = FALSE;
	DWORD dwCost = 0;

	DWORD dwTemp = m_dwDN;

	ItemList	*pDSItem = NULL;

	CBufferEx TempBuf;

	int iItemSize = g_arItemTable.GetSize();
	if( itemslot < EQUIP_ITEM_NUM || itemslot >= TOTAL_INVEN_MAX )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¿ø¼®ÀÌ ÀÖ´Â ÀÎº¥ÀÇ ½½·Ô ¹øÈ£°¡ Àß¸øµÇ¾ú½¿
		SendSystemMsg( IDS_USER_CANT_DRESSING_ITEM, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}

	if( itemcount >= 32767 || itemcount < 0 )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¼±±¤ÇÏ·Á´Â ¿ø¼®ÀÇ °³¼ö Overflow
		SendSystemMsg( IDS_USER_INVALID_DRESSING_COUNT, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}

	if( itemcount % 10 )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¼±±¤ÇÏ·Á´Â ¿ø¼®ÀÇ °³¼ö°¡ 10°³´ÜÀ§°¡ ¾Æ´Ô
		SendSystemMsg( IDS_USER_DRESSING_COUNT_FORMAT, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}

	pOrgItem = &m_UserItem[itemslot];

	if( !pOrgItem )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ÀÎº¥¿¡¼­ ¿ø¼®À» Ã£À» ¼ö ¾øÀ½
		SendSystemMsg( IDS_USER_CANT_DRESSING, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}
	
	if( m_UserItem[itemslot].sSid >= 0 && m_UserItem[itemslot].sSid < g_arItemTable.GetSize() )
	{
		pItem = g_arItemTable[m_UserItem[itemslot].sSid];
	}

	if( !pItem )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¾ÆÀÌÅÛ Å×ÀÌºí¿¡¼­ ¾ÆÀÌÅÛ Ã£À» ¼ö ¾øÀ½
		SendSystemMsg( IDS_USER_CANT_DRESSING_ITEM, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}

	if( pItem->m_byWear != 107 )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¼±±¤ÇÒ ¼ö ¾ø´Â ¾ÆÀÌÅÛ
		SendSystemMsg( IDS_USER_CANT_DRESSING_ITEM, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}

	if( m_UserItem[itemslot].sCount < itemcount )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¾ÆÀÌÅÛ Å×ÀÌºí¿¡¼­ ¾ÆÀÌÅÛ Ã£À» ¼ö ¾øÀ½
		SendSystemMsg( IDS_USER_INVALID_DRESSING_COUNT, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}

	iBasicItemWeight = pItem->m_byWeight * itemcount;

	for( i = 0; i < g_arDressingData.GetSize(); i++ )
	{
		if( g_arDressingData[i] )
		{
			if( g_arDressingData[i]->sItemSid == pItem->m_sSid )
			{
				pDS = g_arDressingData[i];
				break;
			}
		}
	}

	if( !pDS )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¼±±¤ Å×ÀÌºí¿¡¼­ ÇØ´ç ¿ø¼®À» Ã£À» ¼ö ¾øÀ½
		SendSystemMsg( IDS_USER_CANT_DRESSING_ITEM, SYSTEM_ERROR, TO_ME);
		bFlag = TRUE; goto go_dressing_result;
	}

	for( i = 0; i < makecount; i++ )
	{
		termcount = myrand( pDS->sCountMin, pDS->sCountMax );

		// ¾ÆÀÌÅÛ ¼±Á¤ ·£´ý ½Ãµå ÃÊ±âÈ­
		for( j = 0; j < 200; j++ )
		{
			randseed[j] = -1;
		}

		randindex = 0;
		for( j = 0; j < 10; j++ )
		{
			for( k = 0; k < pDS->sItemRatio[j]; k++ )
			{
				if( randindex >= 100 ) break;

				randseed[randindex] = pDS->sItem[j];
				randindex++;
			}
		}

		for( j = 0; j < termcount; j++ )
		{
			randcount = myrand( 0, 99 );

			randresult = randseed[randcount];

			if( randresult < 0 )
			{
				// ½ÇÆÐ ÄÚµå Àü¼Û - Å×ÀÌºí Á¤º¸°¡ Àß¸ø ÀÔ·ÂµÇ¾î ÀÖ´Ù(¾ÆÀÌÅÛ ¼±Á¤ È®·üÀÌ ÅäÅ» 100ÀÌ ¾Æ´Ï´Ù)
				SendSystemMsg( IDS_USER_CANT_DRESSING, SYSTEM_ERROR, TO_ME);
				bFlag = TRUE; goto go_dressing_result;
			}

			bSameExist = FALSE;
			for( k = 0; k < arResult.GetSize(); k++ )
			{
				if( arResult[k] )
				{
					if( arResult[k]->sSid == randresult )
					{
						arResult[k]->sCount++;
						bSameExist = TRUE;
						break;
					}
				}
			}

			if( !bSameExist )
			{
				pNewDRResult = new DRESSING_RESULT;
				pNewDRResult->sSid = randresult;
				pNewDRResult->sCount = 1;
				arResult.Add( pNewDRResult );
			}
		}
	}

	if( arResult.GetSize() == 0 )
	{
		// ½ÇÆÐ ÄÚµå Àü¼Û - ¸¸µé¾îÁø °ÍÀÌ ¾ø´Ù
		SendSystemMsg( IDS_USER_DRESSING_NO_RESULT, SYSTEM_ERROR, TO_ME);
//		bFlag = TRUE; goto go_dressing_result;
	}

	for(i = 0; i < TOTAL_ITEM_NUM; i++)		// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
		SameItem[i] = m_UserItem[i];
	}

	arSameSlot.RemoveAll();
	arSame.RemoveAll();
	arEmpty.RemoveAll();
	arEmptySlot.RemoveAll();

	::ZeroMemory(pTotalEmpty, sizeof(pTotalEmpty));

	GetEmptyInvenSlot(pTotalEmpty);

	char strResult[1024];
	char strTempResult[128];
	sprintf( strResult, _ID(IDS_USER_DRESSING_RESULT) );

	// ¼±±¤ °á°ú ¸ñ·Ï ---------------------------------------------------//
	for( i = 0; i < arResult.GetSize(); i++ )
	{
		if( !arResult[i] ) continue;

		iSlot = -1;

		sid = (short)arResult[i]->sSid;
		num = (short)arResult[i]->sCount;

		if(iEmptyNum > INVENTORY_NUM) { bFlag = TRUE; goto go_dressing_result; }
		if(sid < 0 || num <= 0 || sid > iItemSize) { bFlag = TRUE; goto go_dressing_result; }

		pDSItem = NULL;
		pDSItem = new ItemList;
		if(pDSItem == NULL) { bFlag = TRUE; goto go_dressing_result; }

		ReSetItemSlot(pDSItem);

		pDSItem->sLevel = g_arItemTable[sid]->m_byRLevel;
		pDSItem->sSid = sid;
		pDSItem->sCount = num;
		pDSItem->sDuration = g_arItemTable[sid]->m_sDuration;
		pDSItem->sBullNum = g_arItemTable[sid]->m_sBullNum;
		for( k =0; k< MAGIC_NUM; k++ ) pDSItem->tMagic[k] = 0;
		pDSItem->tIQ = 0;
		pDSItem->iItemSerial = 0;

		sprintf( strTempResult, "%s(%d) ", g_arItemTable[sid]->m_strName, num );
		strcat( strResult, strTempResult );

		iSlot = GetSameItem(*pDSItem, INVENTORY_SLOT);

		if(iSlot != -1)
		{ 
			if(num != 0)
			{
				pDSItem->sCount = num;
				arSame.Add(pDSItem); 
				arSameSlot.Add(iSlot); 

				iWeight += g_arItemTable[sid]->m_byWeight * num;
			}
		}
		else			
		{
			iSlot = pTotalEmpty[iEmptyNum];
//			if(iSlot == 0) { bFlag = TRUE; goto go_dressing_result; }
			if(iSlot == 0) 
			{ 
				CPoint ptCell = FindNearRandomPoint(m_curx, m_cury);

				if(ptCell.x < 0 || ptCell.y < 0) { if(pDSItem) { delete pDSItem; pDSItem = NULL; } continue; }
				if(ptCell.x >= g_zone[m_ZoneIndex]->m_sizeMap.cx || ptCell.y >= g_zone[m_ZoneIndex]->m_sizeMap.cy) { if(pDSItem) { delete pDSItem; pDSItem = NULL; } continue; }

				if(InterlockedCompareExchange((LONG*)&g_zone[m_ZoneIndex]->m_pMap[ptCell.x][ptCell.y].m_FieldUse, (long)1, (long)0) == (long)0)
				{
					if(m_iMaxWeight < m_iCurWeight + iWeight - iBasicItemWeight)
					{
						::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[ptCell.x][ptCell.y].m_FieldUse, 0);

						if(pDSItem) { delete pDSItem; pDSItem = NULL; }

						SendSystemMsg( IDS_USER_OVER_WEIGHT1, SYSTEM_ERROR, TO_ME);
						goto go_dressing_result;
					}

					pDSItem->tType = TYPE_ITEM;
					pDSItem->uid[0] = m_uid;				// ¿ì¼± ¼øÀ§
					pDSItem->SuccessRate[0] = (BYTE)100;	// ¿ì¼± ¼øÀ§ ºñÀ²
					pDSItem->dwTime = ConvertCurTimeToSaveTime();

					//m_pCom->DelThrowItem();
					m_pCom->SetThrowItem( pDSItem, ptCell.x, ptCell.y, m_ZoneIndex );

					::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[ptCell.x][ptCell.y].m_FieldUse, 0);
				}
				else 
				{
					if(pDSItem) { delete pDSItem; pDSItem = NULL; }
				}
			}
			else
			{
				arEmpty.Add(pDSItem); 
				arEmptySlot.Add(iSlot); 
				iEmptyNum++;

				iWeight += g_arItemTable[sid]->m_byWeight * num;
			}
		}		
	}

	if(m_iMaxWeight < m_iCurWeight + iWeight - iBasicItemWeight)
	{
		SendSystemMsg( IDS_USER_OVER_WEIGHT1, SYSTEM_ERROR, TO_ME);
		goto go_dressing_result;
	}

	// ¸ñ·ÏÀ» ÀÎº¥¿¡ -------------------- --------------------//
	for( i = 0; i < arSame.GetSize(); i++ )
	{
		CheckMaxValue((short &)m_UserItem[arSameSlot[i]].sCount, (short)arSame[i]->sCount); 
	}

	for(i = 0; i < arEmpty.GetSize(); i++)
	{
		m_UserItem[arEmptySlot[i]].sLevel = arEmpty[i]->sLevel;
		m_UserItem[arEmptySlot[i]].sSid = arEmpty[i]->sSid;
		m_UserItem[arEmptySlot[i]].sCount = arEmpty[i]->sCount;
		m_UserItem[arEmptySlot[i]].sBullNum = arEmpty[i]->sBullNum;
		m_UserItem[arEmptySlot[i]].sDuration = arEmpty[i]->sDuration;
		m_UserItem[arEmptySlot[i]].tIQ = arEmpty[i]->tIQ;
		for(j =0; j < MAGIC_NUM; j++) m_UserItem[arEmptySlot[i]].tMagic[j] = arEmpty[i]->tMagic[j];
	}

	// ¿ø¼®À» ¾ø¾Ö´Â ÄÚµå ÇÊ¿äÇÔ !!!!
	if( pOrgItem->sCount ==  itemcount ) ReSetItemSlot( &m_UserItem[itemslot] );//ReSetItemSlot(sSlot);
	else m_UserItem[itemslot].sCount = m_UserItem[itemslot].sCount - (short)itemcount;

	if(UpdateUserItemDN() == FALSE)
	{
		for(i = 0; i < TOTAL_ITEM_NUM; i++)		// ¾ÆÀÌÅÛ Á¤º¸ È¯¿ø
		{
			m_UserItem[i] = MyItem[i];
		}
		SendSystemMsg( IDS_USER_DRESSING_FAIL, SYSTEM_NORMAL, TO_ME);
		bFlag = TRUE;
		goto go_dressing_result;
	}

	m_iCurWeight += ( iWeight - iBasicItemWeight );
	GetRecoverySpeed();

	UpdateInvenSlot(&arEmptySlot, &arSameSlot);

	SendSystemMsg( strResult, SYSTEM_ERROR, TO_ME);

	TempBuf.Add(DRESSING);
	TempBuf.Add(SUCCESS);

	TempBuf.Add( (short)itemslot );
	TempBuf.Add(pOrgItem->sLevel);
	TempBuf.Add(pOrgItem->sSid);
	TempBuf.Add(pOrgItem->sDuration);
	TempBuf.Add(pOrgItem->sBullNum);
	TempBuf.Add(pOrgItem->sCount);
	for( i = 0; i < MAGIC_NUM; i++ ) TempBuf.Add(pOrgItem->tMagic[i]);
	TempBuf.Add(pOrgItem->tIQ);

	Send(TempBuf, TempBuf.GetLength());

go_dressing_result:
	int dddd = 0;

	if( bFlag )
	{
		TempBuf.Add(DRESSING);
		TempBuf.Add(FAIL);

		Send(TempBuf, TempBuf.GetLength());
	}

	// ¸Þ¸ð¸® ÇØÁ¦ -------------------- --------------------//
	for(i = 0; i < arSame.GetSize(); i++)
	{
		if(arSame[i] != NULL) delete arSame[i];
	}
	arSame.RemoveAll();
	arSameSlot.RemoveAll();
	for(i = 0; i < arEmpty.GetSize(); i++)
	{
		if(arEmpty[i] != NULL) delete arEmpty[i];
	}
	arEmpty.RemoveAll();
	arEmptySlot.RemoveAll();

	for(i = 0; i < arResult.GetSize(); i++ )
	{
		if( arResult[i] ) delete arResult[i];
	}
	arResult.RemoveAll();
}

void USER::ItemDataVersionCheck()
{
/*
	int i;

	switch( m_tItemVer )
	{
	case	0x00:
		{
			for(i = 0; i < TOTAL_ITEM_NUM; i++)
			{
				m_UserItem[i].iItemSerial = GenerateItemSerial( &(m_UserItem[i]) );
			}

			for(i = 0; i < TOTAL_BANK_ITEM_NUM; i++)
			{
				m_UserBankItem[i].iItemSerial = GenerateItemSerial( &(m_UserBankItem[i]) );
			}

			m_tItemVer = 0x01;

			UpdateMemUserAll( TRUE );
		}

	case	0x01:
	default:
		break;
	}

	switch( m_tAccountBankItemVer )
	{
	case	0X00:
		{
			for(i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++)
			{
				m_AccountBankItem[i].iItemSerial = GenerateItemSerial( &(m_AccountBankItem[i]) );
			}

			m_tAccountBankItemVer = 0x01;

			UpdateMemUserAll( TRUE );
		}
	}
*/	
}

void USER::SelectOver100Skill(TCHAR *pBuf)
{
	if( m_sLevel < 100 ) return;		// 100·¦ ÀÌ»ó¸¸ ¼±ÅÃ ÇÒ ¼ö ÀÖ´Ù.

	int emptyskillslot = -1;

/*
#define BRAWL				0
#define STAFF				1
#define	EDGED				2
#define FIREARMS			3
*/
	switch( m_byClass )
	{
	case	BRAWL:
		emptyskillslot = 4;
		break;

	case	STAFF:
		emptyskillslot = 9;
		break;

	case	EDGED:
		emptyskillslot = 14;
		break;

	case	FIREARMS:
		emptyskillslot = 19;
		break;
	case	JUDGE:
		emptyskillslot = 24;
		break;

	default:
		return;
	}

	if( emptyskillslot == -1 ) return;	// ±× °è¿­¿¡¼­ »ç¿ëÇÏÁö ¾Ê°í ÀÖ´Â ¸¶Áö¸· ½ºÅ³

	int skillsid = m_UserSkill[emptyskillslot].sSid;

	if(skillsid < 0 || skillsid >= g_arSkillTable.GetSize()) return;

	if( g_arSkillTable[skillsid]->m_sSid != -1 )		// ÀÌ¹Ì 100·¦ ÀÌ»ó ½ºÅ³À» °ñ¶úÀ»¶§
	{
		if( emptyskillslot != skillsid ) return;
	}

	int index = 0;

	int selectedskill = GetByte( pBuf, index );

	if( selectedskill < 20 || selectedskill >= 24 ) return;	// Å¬¶óÀÌ¾ðÆ®¿¡¼­ ³Ñ¾î¿À´Â ½ºÅ³ ¹øÈ£´Â 0-3ÀÌ´Ù

/*	20 - ¸Í°ø
	21 - Àý´ë¹æ¾î
	22 - »çÀÌÅ± ÀúÇ×
	23 - µðÆæ½º ¾÷ */

/*	if(selectedskill == 20)
	{
		if(m_byClass != 0)
		{
			SendUserStatusSkill();
			return;
		}
	} */

	int backupskill = m_UserSkill[emptyskillslot].sSid;
	int backupskilllevel = m_UserSkill[emptyskillslot].tLevel;

	m_UserSkill[emptyskillslot].sSid = selectedskill;
	m_UserSkill[emptyskillslot].tLevel = (BYTE)((m_sLevel % 100) + 1);
//niuniuadd
	if(m_UserSkill[emptyskillslot].tLevel>20)
			m_UserSkill[emptyskillslot].tLevel=20;
	if( !UpdateUserData() )
	{
		m_UserSkill[emptyskillslot].sSid = backupskill;
		m_UserSkill[emptyskillslot].tLevel = backupskilllevel;
		return;
	}

	SendUserStatusSkill();
}

UINT64 USER::GenerateItemSerial(ItemList* pItem)
{
	/*if( pItem->tIQ == MAGIC_ITEM ||		// ¸ÅÁ÷¾ÆÀÌÅÛÀÌ°Å³ª
		pItem->tIQ == RARE_ITEM ||		// ·¡¾î¾ÆÀÌÅÛÀÌ°Å³ª
		pItem->sLevel >= 20 ||			// ·¹º§ 20ÀÌ»ó ¾ÆÀÌÅÛÀÌ°Å³ª
		pItem->tMagic[5] >= 1 ||		// ¾÷±×·¹ÀÌµå°¡ 1¹øÀÌ»ó µÈ ¾ÆÀÌÅÛÀÌ¶ó¸é
		pItem->sSid == 756 )			// ±Ø¾à
	{
		CTime t;

		t = CTime::GetCurrentTime();

		MYINT upper;		// ½Ã°£À¸·Î »óÀ§ 4¹ÙÀÌÆ®¸¦ ¸¸µç´Ù
		MYINT under;		// ½Ã¸®¾ó·Î ÇÏÀ§ 3¹ÙÀÌÆ®¸¦ ³ª¸ÓÁö ÇÑ¹ÙÀÌÆ®´Â ¼­¹ö ÀÏ·Ã¹øÈ£

		memcpy( &(upper), &t, sizeof(CTime) );
		TRACE("111111: %d   =? %d\n", sizeof(CTime),sizeof(upper.i) );
		under.i = (int)(g_dwItemSerial);
		under.b[3] = g_ItemSerialIndex;

		g_dwItemSerial++;

		if( g_dwItemSerial >= 255*255*255 ) g_dwItemSerial = 0;

		MYINT64 total;

		total.b[7] = upper.b[3];
		total.b[6] = upper.b[2];
		total.b[5] = upper.b[1];
		total.b[4] = upper.b[0];

		total.b[3] = under.b[3];
		total.b[2] = under.b[2];
		total.b[1] = under.b[1];
		total.b[0] = under.b[0];

		TRACE("GenerateSerial - %I64d\n", total.i );

		return total.i;

	}
	*/

	return 0;
}

void USER::AccountBankItemMoveReq(TCHAR *pBuf)
{
#ifdef _ACTIVE_USER
//	if(m_iDisplayType == 6 && m_sLevel > 25) return; //yskang 0.5
	if(m_iDisplayType == 6) return; //yskang 0.5
#endif

	int index = 0;
	int bSuccess = FALSE;//½­ºþ
	BYTE type = GetByte(pBuf, index);
	/////////////////////////////////////½­ºþ
	if(!LoadCharData(m_strAccount))
	{
		return;
	}

	for (int i =0; i < 3 ; i++)	//bug ·ÀÖ¹µÁºÅË¢×°±¸
	{
		if (m_strChar[i][0] == 0)
			continue;
		if (strcmp(m_strChar[i],m_strUserID) == 0)
			bSuccess = TRUE;
	}

	if (bSuccess == FALSE)	return;//BUG  
		
	if (m_bNowTrading == TRUE || m_bPShopOpen == TRUE) 
	   {
            CString strDate ="";
			SYSTEMTIME st;
			GetLocalTime(&st);
			strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
			TCHAR m_Log[500];
			sprintf_s(m_Log,"[ %s ]%s %d,%d ÎïÆ·ÒÆ¶¯´æÔÚ·Ç·¨5 \r\n",strDate,m_strUserID,m_bNowTrading,m_bPShopOpen);
		    WriteUserShopLog(m_Log);
			SendItemMoveFail();
		    return;
	 }           
	
		
	
	////////////////////////////////////////

	switch(type)
	{
	case BANK_ITEM_INPUT:
		AccountBankInPut(pBuf + index);
		break;
	case BANK_ITEM_OUTPUT:
		AccountBankOutPut(pBuf + index);
		break;
	case BANK_DN_INPUT:
		AccountBankInPutDN(pBuf + index);
		break;
	}
}

void USER::AccountBankInPut(TCHAR *pBuf)//×ÛºÏ²Ö¿â ´æÈë
{
	int i;
	int tDestSlot;
	int index = 0;
	int iOver = 0;
	short sSid = -1;
	short sHaveCount = 0;
	DWORD dwCost = 150;

	BYTE result = SUCCESS;

	CBufferEx TempBuf;

	ItemList MyItem[TOTAL_ITEM_NUM], BackItem;

	BYTE tSourceSlot = GetByte(pBuf, index);	// »ç¿ëÀÚ ¾ÆÀÌÅÛÀÌ ÀÖ´ø ½½·Ô À§Ä¡
	short sCount = GetShort(pBuf, index);		// ¾ó¸¶¸¸Å­ º¸°ü
												// ¿À·ÎÁö ÀÎº¥¸¸ °¡´ÉÇÏ´Ù.	
	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE) { result = FAIL; goto go_result; }//Î´ÖªBUG
	if(tSourceSlot < EQUIP_ITEM_NUM || tSourceSlot >= EQUIP_ITEM_NUM + INVENTORY_NUM) { result = FAIL; goto go_result; }

	sSid = m_UserItem[tSourceSlot].sSid;
	sHaveCount = m_UserItem[tSourceSlot].sCount;
	//======================================================================================= ÏÞÖÆ×ÛºÏ²Ö¿â´æÈëÊýÁ¿
	if ( sSid == 724)
	{
		for(int k = 0; k < TOTAL_ACCOUNT_BANK_ITEM_NUM; k++)
	    {
			if (m_AccountBankItem[k].sSid == 724 )
			{
				if ( sCount + m_AccountBankItem[k].sCount > 32000)
				{

					SendEventMsg("×ÛºÏ²Ö¿â³¬¹ý×î´ó´æ´¢Á¿");
					result = FAIL;
					goto go_result; 
				}
			}
		}
	}

//========================================================================================
	if(sHaveCount <= 0) { result = FAIL; goto go_result; }	// ¾ÆÀÌÅÛÀÌ ¾ø´Ù.
												
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) { result = FAIL; goto go_result; }	// Àß¸øµÈ sSid

	if(g_arItemTable[sSid]->m_sEvent >= EVENT_RR_ITEM_BAND)		// ·Î¿­·³ºí »óÇ°Àº ÅëÇÕÃ¢°í¿¡ ³ÖÀ» ¼ö ¾ø´Ù.
	{
		SendSystemMsg( IDS_USER_CANT_SHARE_EVENT_ITEM, SYSTEM_ERROR, TO_ME);
		result = FAIL; goto go_result; 
	}

	if(sCount > ACCOUNT_BANK_MAX_ITEM) 
	{
		SendSystemMsg( IDS_USER_SAME_ITEM_COUNT_MAX, SYSTEM_ERROR, TO_ME);
		result = FAIL; goto go_result;
	}
												
	if(sCount <= 0 || sCount > sHaveCount) { result = FAIL; goto go_result; }	// ¼ÒÁöÇÑ ¾ÆÀÌÅÛ ¼öº¸´Ù ¸¹À» °æ¿ì
												//³»±¸µµ Ã¼Å©¸¦ wearÁ¤º¸·Î Çß´Ù.
	//if(g_arItemTable[sSid]->m_byWear <= 5 && sCount > 1) { result = FAIL; goto go_result; }
	if(g_arItemTable[sSid]->m_sDuration > 0 && sCount > 1) { result = FAIL; goto go_result; }	// °ãÄ¥¼ö ¾ø´Âµ¥ °¹¼ö°¡ 1º¸´Ù Å¬¼ö ¾ø´Ù.
	if((sHaveCount < 0) && sCount < 0) { result = FAIL; goto go_result; }
	for(i = 0; i < TOTAL_ITEM_NUM; i++)	// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

	ReSetItemSlot(&BackItem);					// DB½ÇÆÐ¿¡ ´ëºñÇÑ ¹é¾÷¿ë ÃÊ±âÈ­
												// ÀÏ´Ü °ãÄ¥¼ö ÀÖ´ÂÁö, °ãÄ¡¸é °°Àº ¾ÆÀÌÅÛÀÌ ÀÖ´ÂÁö Ã£¾Æº»´Ù.
	tDestSlot = GetSameItem(m_UserItem[tSourceSlot], ACCOUNT_BANK_SLOT);
	
	/***************************ÀºÇà ¾÷¹« Ã³¸®********************************************/
	if(tDestSlot >= 0)							// Ç×»ó »õ·ÎÀÌ Ãß°¡ µÇ´Â°ÍÀ» ±âÁØÀ¸·Î Ã³¸®
	{											
		BackItem = m_AccountBankItem[tDestSlot];

		if(m_AccountBankItem[tDestSlot].sCount >= ACCOUNT_BANK_MAX_ITEM)
		{
			SendSystemMsg( IDS_USER_SAVE_MAX_COUNT, SYSTEM_ERROR, TO_ME);
			result = FAIL; goto go_result;
		}

		if((m_AccountBankItem[tDestSlot].sCount + sCount) > ACCOUNT_BANK_MAX_ITEM)
		{										// MAX°ªÀ» ³ÑÀ¸¸é ²ËÃ¤¿ì°í ³ª¸ÓÁö Ã³¸®			
			iOver = m_AccountBankItem[tDestSlot].sCount + sCount - ACCOUNT_BANK_MAX_ITEM;
			if(iOver <= 0) { result = FAIL; goto go_result; }

			m_AccountBankItem[tDestSlot].sCount = ACCOUNT_BANK_MAX_ITEM;
			sCount = sCount - iOver;
		}
		else m_AccountBankItem[tDestSlot].sCount += sCount;
	}
	else
	{											//	Ãß°¡
		tDestSlot = GetEmptySlot(ACCOUNT_BANK_SLOT);

		if(tDestSlot == -1) 
		{
			result = FAIL; goto go_result; 
		}

		m_AccountBankItem[tDestSlot].sLevel = m_UserItem[tSourceSlot].sLevel;
		m_AccountBankItem[tDestSlot].sSid = m_UserItem[tSourceSlot].sSid;
		m_AccountBankItem[tDestSlot].sDuration = m_UserItem[tSourceSlot].sDuration;
		m_AccountBankItem[tDestSlot].sBullNum = m_UserItem[tSourceSlot].sBullNum;
		m_AccountBankItem[tDestSlot].sCount = sCount;
		for(i = 0; i < MAGIC_NUM; i++) m_AccountBankItem[tDestSlot].tMagic[i] = m_UserItem[tSourceSlot].tMagic[i];
		m_AccountBankItem[tDestSlot].tIQ = m_UserItem[tSourceSlot].tIQ;
		m_AccountBankItem[tDestSlot].iItemSerial = m_UserItem[tSourceSlot].iItemSerial;
	}

	index = 0;
	index = g_arItemTable[m_UserItem[tSourceSlot].sSid]->m_byWeight * sCount;
	/**************************À¯Àú ÀÎº¥ Ã³¸®*********************************************/
	if(sCount >= sHaveCount && iOver == 0)
	{
		MakeItemLog( &m_AccountBankItem[tDestSlot], ITEMLOG_ACCOUNT_BANKIN );
		ReSetItemSlot(&m_UserItem[tSourceSlot]);	
	}
	else m_UserItem[tSourceSlot].sCount -= sCount;
	
	/**************************DB Update Ã³¸®*********************************************/
	if(UpdateUserBank() == FALSE)
	{
		for(i = 0; i < TOTAL_ITEM_NUM; i++)// ¾ÆÀÌÅÛ Á¤º¸ º¹¿ø
		{
			m_UserItem[i] = MyItem[i];
		}
		m_AccountBankItem[tDestSlot] = BackItem;

		result = FAIL;
		FlushItemLog( FALSE );
		goto go_result;
	}

	FlushItemLog( TRUE );

go_result:
	TempBuf.Add(ACCOUNT_BANK_ITEM_MOVE_RESULT);

	if(result == FAIL)
	{
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	result = (BYTE)0x01;
	TempBuf.Add(result);

	TempBuf.Add((BYTE)tDestSlot);				// ÒøÐÐÀï¶«Î÷¡£
	TempBuf.Add( dwCost );
	TempBuf.Add(m_AccountBankItem[tDestSlot].sLevel);
	TempBuf.Add(m_AccountBankItem[tDestSlot].sSid);
	TempBuf.Add(m_AccountBankItem[tDestSlot].sDuration);
	TempBuf.Add(m_AccountBankItem[tDestSlot].sBullNum);
	TempBuf.Add(m_AccountBankItem[tDestSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_AccountBankItem[tDestSlot].tMagic[i]);
	TempBuf.Add(m_AccountBankItem[tDestSlot].tIQ);

	TempBuf.Add((BYTE)tSourceSlot);				// ÉíÉÏµÄ¶«Î÷
	TempBuf.Add(m_UserItem[tSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[tSourceSlot].sSid);
	TempBuf.Add(m_UserItem[tSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[tSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[tSourceSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tSourceSlot].tMagic[i]);
	TempBuf.Add(m_UserItem[tSourceSlot].tIQ);

	Send(TempBuf, TempBuf.GetLength());

	m_iCurWeight -= index;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...
}

void USER::AccountBankOutPut(TCHAR *pBuf) //×ÛºÏ²Ö¿â È¡³ö
{
	int i, j, iWeight = 0;
	int tDestSlot;
	int index = 0;
	int iOver = 0;
	short sSid = -1;
	short sHaveCount = 0;

	short myslot;
	BYTE result = SUCCESS;

	CWordArray		arChangeMy, arChangeBank;
	ItemList		MyItem[TOTAL_ITEM_NUM], BankItem[TOTAL_ACCOUNT_BANK_ITEM_NUM];
	BYTE			arSlot[TOTAL_ACCOUNT_BANK_ITEM_NUM];
	short			arCount[TOTAL_ACCOUNT_BANK_ITEM_NUM];

	for( i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++ ) arSlot[i] = -1;
	for( i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++ ) arCount[i] = -1;

	CBufferEx TempBuf;

	CStore* pStore = NULL;
	short sStoreID = GetShort(pBuf, index);
	if(sStoreID < 0) return;
	pStore = GetStore(sStoreID);
	if(pStore == NULL) return;
	short sRate = pStore->m_sRate;

	DWORD OutCost = 0;
	DWORD dwTax = 0;

	DWORD OutputDN = GetDWORD(pBuf, index);

	if(OutputDN > m_dwAccountBankDN)			// ³Ê¹« Å©¸é
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE)
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return; //Î´ÖªBUG
	}
	
	if( OutputDN > 0 ) OutCost += 150;

	DWORD BackMyDN = m_dwDN;					// ¹é¾÷
	DWORD BackBankDN = m_dwAccountBankDN;

	short slotcount = GetShort( pBuf, index );

	if( slotcount < 0 || slotcount >= TOTAL_ACCOUNT_BANK_ITEM_NUM ) { result = FAIL; goto go_result; }
	
	for( i = 0; i < slotcount; i++ )
	{
		arSlot[i] = GetShort( pBuf, index );
		arCount[i] = GetShort( pBuf, index );

		if(arSlot[i] >= TOTAL_ACCOUNT_BANK_ITEM_NUM) { result = FAIL; goto go_result; }

		sSid = m_AccountBankItem[arSlot[i]].sSid;
		sHaveCount = m_AccountBankItem[arSlot[i]].sCount;
		//=====================================================================ÏÞÖÆ×ÛºÏ²Ö¿âÈ¡³öÊýÁ¿

		if ( sSid == 724) //ºÇºÇ
	    {
			if ( arCount[i] +  FindItem( 724) > 32000 )
			{
				SendEventMsg("³¬¹ý¿ÉÐ¯´øµÄ×î´óÊýÁ¿");
				result = FAIL;
				goto go_result; 
			}
		}
	
//=============================================================================================	

		if(sSid < 0 || sSid >= g_arItemTable.GetSize()) { result = FAIL; goto go_result; }

		if(arCount[i] <= 0 || arCount[i] > sHaveCount) { result = FAIL; goto go_result; }

		if(g_arItemTable[sSid]->m_sDuration > 0 && arCount[i] > 1) { result = FAIL; goto go_result; }

		iWeight += g_arItemTable[sSid]->m_byWeight * arCount[i];

		if(m_iMaxWeight < m_iCurWeight + iWeight)
		{
			SendSystemMsg( IDS_USER_OVER_WEIGHT1, SYSTEM_ERROR, TO_ME);
			result = FAIL; 
			goto go_result;
		}

		OutCost += 150;
	}

	if( OutCost > m_dwDN )
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY_FOR_OUT, SYSTEM_ERROR, TO_ME);
		result = FAIL; 
		goto go_result;
	}
	else m_dwDN -= OutCost;

	for( i = 0; i < TOTAL_ITEM_NUM; i++ )	// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

	for( i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++ )
	{
		BankItem[i] = m_AccountBankItem[i];
	}

	for( i = 0; i < slotcount; i++ )
	{
		tDestSlot = GetSameItem( m_AccountBankItem[arSlot[i]], INVENTORY_SLOT );

		if( tDestSlot >= 0 )
		{
			m_UserItem[tDestSlot].sCount += arCount[i];
		}
		else
		{
			tDestSlot = GetEmptySlot( INVENTORY_SLOT );

			if( tDestSlot == -1 )
			{
				for( j = 0; j < TOTAL_ITEM_NUM; j++)// ¾ÆÀÌÅÛ Á¤º¸ º¹¿ø
				{
					m_UserItem[j] = MyItem[j];
				}
				for( j = 0; j < TOTAL_ACCOUNT_BANK_ITEM_NUM; j++ )
				{
					m_AccountBankItem[j] = BankItem[j];
				}
				m_dwDN = BackMyDN;
				m_dwAccountBankDN = BackBankDN;

				result = FAIL; goto go_result;
			}

			m_UserItem[tDestSlot].sLevel = m_AccountBankItem[arSlot[i]].sLevel;
			m_UserItem[tDestSlot].sSid = m_AccountBankItem[arSlot[i]].sSid;
			m_UserItem[tDestSlot].sDuration = m_AccountBankItem[arSlot[i]].sDuration;
			m_UserItem[tDestSlot].sBullNum = m_AccountBankItem[arSlot[i]].sBullNum;
			m_UserItem[tDestSlot].sCount = arCount[i];
			for(j = 0; j < MAGIC_NUM; j++) m_UserItem[tDestSlot].tMagic[j] = m_AccountBankItem[arSlot[i]].tMagic[j];
			m_UserItem[tDestSlot].tIQ = m_AccountBankItem[arSlot[i]].tIQ;
			m_UserItem[tDestSlot].iItemSerial = m_AccountBankItem[arSlot[i]].iItemSerial;

			MakeItemLog( &m_UserItem[tDestSlot], ITEMLOG_ACCOUNT_BANKOUT );
		}

		arChangeMy.Add( tDestSlot );

		if( arCount[i] >= m_AccountBankItem[arSlot[i]].sCount ) ReSetItemSlot( &m_AccountBankItem[arSlot[i]] );
		else m_AccountBankItem[arSlot[i]].sCount -= arCount[i];

		arChangeBank.Add( arSlot[i] );
	}

	if(!CheckMaxValueReturn(m_dwDN, OutputDN))
	{									// ´Ü, MAX°ªÀÌ¸é Â÷¾×Àº...
		CheckMaxValue(m_dwDN, OutputDN);
		if(m_dwDN < OutputDN) OutputDN = 0;
		else OutputDN = m_dwDN - OutputDN;
	}
	else m_dwDN += OutputDN;
										// ÀºÇà¿¡¼­ »«´Ù.
	if(OutputDN >= m_dwAccountBankDN) m_dwAccountBankDN = 0;
	else m_dwAccountBankDN -= OutputDN;

	if( OutputDN > 0 )
		MakeMoneyLog( OutputDN, ITEMLOG_ACCOUNT_BANKOUT_MONEY, NULL, m_dwAccountBankDN );

	// Æ÷Æ®¸®½º¿¡ ¼¼±ÝÀ» ´©Àû½ÃÄÑ ÁØ´Ù.
	dwTax = (DWORD)( OutCost * ((double)sRate/100) );
	UpdateFortressTax(sStoreID, dwTax); // Æ÷Æ®¸®½º ¼¼±ÝÀÌ¸é ÀúÀå...


	/**************************DB Update Ã³¸®*********************************************/
	if(UpdateUserBank() == FALSE)
	{
		for( i = 0; i < TOTAL_ITEM_NUM; i++)// ¾ÆÀÌÅÛ Á¤º¸ º¹¿ø
		{
			m_UserItem[i] = MyItem[i];
		}
		for( i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++ )
		{
			m_AccountBankItem[i] = BankItem[i];
		}
		m_dwDN = BackMyDN;
		m_dwAccountBankDN = BackBankDN;

		result = FAIL;

		goto go_result;
	}

	FlushItemLog( TRUE );

go_result:
	TempBuf.Add(ACCOUNT_BANK_ITEM_MOVE_RESULT);

	if(result == FAIL)
	{
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		FlushItemLog( FALSE );
		return;
	}

	result = (BYTE)0x02;
	TempBuf.Add(result);

	TempBuf.Add( m_dwDN );
/*	TempBuf.Add( m_dwAccountBankDN );

	TempBuf.Add( (short)(arChangeBank.GetSize()) );

	for( i = 0; i < arChangeBank.GetSize(); i++ )
	{
		bankslot = arChangeBank[i];

		TempBuf.Add( (BYTE)bankslot );
		TempBuf.Add(m_AccountBankItem[bankslot].sLevel);
		TempBuf.Add(m_xxxxxxxxeiAccountBankItem[bankslot].sSid);
		TempBuf.Add(m_AccountBankItem[bankslot].sDuration);
		TempBuf.Add(m_AccountBankItem[bankslot].sBullNum);
		TempBuf.Add(m_AccountBankItem[bankslot].sCount);
		for( j = 0; j < MAGIC_NUM; j++) TempBuf.Add(m_AccountBankItem[bankslot].tMagic[j]);
		TempBuf.Add(m_AccountBankItem[bankslot].tIQ);
	}
*/
	TempBuf.Add( (short)(arChangeMy.GetSize()) );

	for( i = 0; i < arChangeMy.GetSize(); i++ )
	{
		myslot = arChangeMy[i];

		TempBuf.Add( (BYTE)myslot );
		TempBuf.Add( m_UserItem[myslot].sLevel );
		TempBuf.Add( m_UserItem[myslot].sSid);
		TempBuf.Add( m_UserItem[myslot].sDuration);
		TempBuf.Add( m_UserItem[myslot].sBullNum);
		TempBuf.Add( m_UserItem[myslot].sCount);
		for( j = 0; j < MAGIC_NUM; j++ ) TempBuf.Add( m_UserItem[myslot].tMagic[j] );
		TempBuf.Add( m_UserItem[myslot].tIQ );
	}

	Send(TempBuf, TempBuf.GetLength());

	m_iCurWeight += iWeight;
	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...
}

void USER::AccountBankInPutDN(TCHAR *pBuf)  //×ÛºÏ²Ö¿â ´æÈë½ðÇ®
{
	CBufferEx TempBuf;

	BYTE result; 
	int index = 0;
	DWORD BackBankDN = 0, BackMyDN = 0;

	DWORD InputDN = GetDWORD(pBuf, index);

	TempBuf.Add(ACCOUNT_BANK_ITEM_MOVE_RESULT);

	if(InputDN == 0 || InputDN > m_dwDN) 
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE)
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return; //Î´ÖªBUG
	}
	BackMyDN = m_dwDN;
	BackBankDN = m_dwAccountBankDN;
										// ÀºÇà¿¡ ÀÔ±Ý
	if(!CheckMaxValueReturn(m_dwAccountBankDN, InputDN))
	{									// ´Ü, MAX°ªÀÌ¸é Â÷¾×Àº...
		CheckMaxValue(m_dwAccountBankDN, InputDN);
		if(m_dwAccountBankDN < InputDN) InputDN = 0;
		else InputDN = m_dwAccountBankDN - InputDN;
	}
	else m_dwAccountBankDN += InputDN;
										// °¡Áö°í ÀÖ´Â ¼ÒÁö±Ý¿¡¼­ »«´Ù.
	if(m_dwDN <= InputDN) m_dwDN = 0;
	else m_dwDN -= InputDN;

	MakeMoneyLog( InputDN, ITEMLOG_ACCOUNT_BANKIN_MONEY, NULL, m_dwAccountBankDN );

	if(UpdateUserBank() == FALSE)		// DB UpDate
	{
		m_dwDN = BackMyDN;
		m_dwBankDN = BackBankDN;

		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());

		FlushItemLog( FALSE );
		return;
	}

	result = (BYTE)0x03;				// 3 : DN ÀÔ±Ý
	TempBuf.Add(result);

	TempBuf.Add(m_dwAccountBankDN);			
	TempBuf.Add(m_dwDN);				

	Send(TempBuf, TempBuf.GetLength());

	FlushItemLog( TRUE );
}

void USER::AccountBankOpenReq(int nStoreID)
{
	CStore* pStore = NULL;
	pStore = GetStore(nStoreID);
	if(pStore == NULL) return;
	DWORD dwCost = 150;

	int i, j;
	CBufferEx TempBuf;

	CByteArray arItemSlotList;

//	m_dwAccountBankDN = 0;

//	if(!LoadMemAccountBank())
//	{
//		if(!LoadAccountBank()) return;						// À¯Àú°¡ º¸°üÇÑ ÀºÇà ¾ÆÀÌÅÛÀ» Ã³À½ Á¢¼ÓÇÒ¶§ °¡Áö°í ¿Â´Ù.
//	}

	for(i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++)
	{												// ÇöÀç º¸°üµÈ ¾ÆÀÌÅÛ¸¸ º¸¿©ÁÖ±âÀ§ÇØ Á¤·ÄÇÑ´Ù. 
		if(m_AccountBankItem[i].sSid >= 0)
		{
			arItemSlotList.Add(i);
		}
	}

	TempBuf.Add(ACCOUNT_BANK_OPEN);

	TempBuf.Add((short)nStoreID);

	TempBuf.Add((DWORD)m_dwAccountBankDN);
	TempBuf.Add((BYTE)arItemSlotList.GetSize());

	for(i = 0; i < arItemSlotList.GetSize(); i++)
	{
		BYTE tempSlot = 0;
		tempSlot = arItemSlotList[i];
		TempBuf.Add(tempSlot);
		TempBuf.Add((short)m_AccountBankItem[tempSlot].sLevel);
		TempBuf.Add((short)m_AccountBankItem[tempSlot].sSid);
		TempBuf.Add((short)m_AccountBankItem[tempSlot].sDuration);
		TempBuf.Add((short)m_AccountBankItem[tempSlot].sBullNum);
		TempBuf.Add((short)m_AccountBankItem[tempSlot].sCount);

		for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add((BYTE)m_AccountBankItem[tempSlot].tMagic[j]);

		TempBuf.Add((BYTE)m_AccountBankItem[tempSlot].tIQ);
		TempBuf.Add( dwCost );
	}

	Send(TempBuf, TempBuf.GetLength());
	CheckBadItem();

}

////////////////////////////////////////////////////////////////////////////////
//	»çÀÌ¿À´Ð ½ÃÀü½Ã ¸Í°ø¿¡ ÀÇÇÑ Áõ°¡À²À» ±¸ÇÑ´Ù.
//
int USER::GetPsyAssault(bool bMax)
{
	int iLevel = 0;
	int iSkillSid = 0;

	int iAttackUp = 0;
	int tClass = 0;

	BYTE tWeaponClass = 0;

	IsCanUseWeaponSkill(tWeaponClass);
	tClass = tWeaponClass * SKILL_NUM;

	for(int i = tClass; i < tClass + SKILL_NUM; i++)
	{
		iSkillSid  = m_UserSkill[i].sSid;
		if(iSkillSid == SKILL_ASSAULT) // ¸Í°ø			// 20 index
		{
			// ¼ø¼ö ½ºÅ³ ·¹º§ 
			iLevel = m_UserSkill[i].tLevel;		
			if(iLevel < 0) iLevel = 0;
			
			// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
			if(iLevel >= 1) iLevel += m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ m_DynamicUserData[MAGIC_ALL_SKILL_UP];
			
			if(iLevel >= SKILL_LEVEL) iLevel = SKILL_LEVEL - 1;
			if(iSkillSid >= g_arSkillTable.GetSize()) return 0;
			int iRandom = (int)((double)XdY(1, 1000) / 10 + 0.5);
			if((iRandom < g_arSkillTable[iSkillSid]->m_arSuccess.GetAt(iLevel))|| bMax)
			{
				iAttackUp = g_arSkillTable[iSkillSid]->m_arInc.GetAt(iLevel);
			}
		}
	}

	return iAttackUp;	
}

////////////////////////////////////////////////////////////////////////////////
//	»çÀÌ¿À´Ð ½ÃÀü½Ã Àý´ë¹æ¾î ½ºÅ³¿¡ ÀÇÇÑ Áõ°¡À²À» ±¸ÇÑ´Ù.
//
int USER::GetPsyAbsoluteDefense()
{
	int iLevel = 0;
	int iSkillSid = 0;

	int iAttackUp = 0;
	int tClass = 0;

	BYTE tWeaponClass = 0;

	IsCanUseWeaponSkill(tWeaponClass);
	tClass = tWeaponClass * SKILL_NUM;

	for(int i = tClass; i < tClass + SKILL_NUM; i++)
	{
		iSkillSid  = m_UserSkill[i].sSid;
		if(iSkillSid == SKILL_ABSOLUTE_DEFENSE) //¾ø¶Ô·ÀÓù			21 index
		{
			// ¼ø¼ö ½ºÅ³ ·¹º§ 
			iLevel = m_UserSkill[i].tLevel;		
			if(iLevel < 0) iLevel = 0;
			
			// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
			if(iLevel >= 1) iLevel += m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ m_DynamicUserData[MAGIC_ALL_SKILL_UP];
			
			if(iLevel >= SKILL_LEVEL) iLevel = SKILL_LEVEL - 1;
			if(iSkillSid >= g_arSkillTable.GetSize()) return 0;
			iAttackUp = g_arSkillTable[iSkillSid]->m_arInc.GetAt(iLevel);
		}
		if(iSkillSid == SKILL_PSYCHIC_RESIST) //Ä§·¨¿¹²ð			22 index
		{
			iLevel = m_UserSkill[i].tLevel;		
			if(iLevel < 0) iLevel = 0;
			
			
			if(iLevel >= 1) iLevel += m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ m_DynamicUserData[MAGIC_ALL_SKILL_UP];
			
			if(iLevel >= SKILL_LEVEL) iLevel = SKILL_LEVEL - 1;
			if(iSkillSid >= g_arSkillTable.GetSize()) return 0;
			iAttackUp += g_arSkillTable[iSkillSid]->m_arInc.GetAt(iLevel);
		}
	}

	return iAttackUp;	
}

////////////////////////////////////////////////////////////////////////////////
//	»çÀÌ¿À´Ð ½ÃÀü½Ã »çÀÌ¿À´Ð ÀúÇ× ½ºÅ³¿¡ ÀÇÇÑ Áõ°¡À²À» ±¸ÇÑ´Ù.
//
int USER::GetPsyPsyResist()
{
	int iLevel = 0;
	int iSkillSid = 0;

	int iAttackUp = 0;
	int tClass = 0;

	BYTE tWeaponClass = 0;

	IsCanUseWeaponSkill(tWeaponClass);
	tClass = tWeaponClass * SKILL_NUM;

	for(int i = tClass; i < tClass + SKILL_NUM; i++)
	{
		iSkillSid  = m_UserSkill[i].sSid;
		if(iSkillSid == SKILL_PSYCHIC_RESIST) // »çÀÌ¿À´Ð ÀúÇ×			// 22 index
		{
			// ¼ø¼ö ½ºÅ³ ·¹º§ 
			iLevel = m_UserSkill[i].tLevel;		
			if(iLevel < 0) iLevel = 0;
			
			// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
			if(iLevel >= 1) iLevel += m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ m_DynamicUserData[MAGIC_ALL_SKILL_UP];
			
			if(iLevel >= SKILL_LEVEL) iLevel = SKILL_LEVEL - 1;
			if(iSkillSid >= g_arSkillTable.GetSize()) return 0;
			iAttackUp = g_arSkillTable[iSkillSid]->m_arInc.GetAt(iLevel);
		}
	}

	return iAttackUp;	
}

void USER::ResetOver100LevelSkill(int sLevel)//°Ù¼¶¼¼ÄÜ¿ØÖÆ
{
	int emptyskillslot = -1;
	int skillsid = 0;

	switch( m_byClass )
	{
	case	BRAWL:
		emptyskillslot = 4;
		break;

	case	STAFF:
		emptyskillslot = 9;
		break;

	case	EDGED:
		emptyskillslot = 14;
		break;

	case	FIREARMS:
		emptyskillslot = 19;
		break;
	case	JUDGE:
		emptyskillslot = 24;
		break;

	default:
		return;
	}

	if( emptyskillslot == -1 ) return;

	skillsid = m_UserSkill[emptyskillslot].sSid;

	if( sLevel <= 99 )		// ¸¸¾à 99·¦À¸·Î ¼ÂÆÃÇÏ¶ó°í µé¾î¿À¸é
	{
		m_UserSkill[emptyskillslot].sSid = emptyskillslot;		// ±âÁ¸ 100·¦ ½ºÅ³ Á¤º¸¸¦ Áö¿î´Ù
		m_UserSkill[emptyskillslot].tLevel = 0;

		return;
	}
	else
	{
		if( skillsid < 0 || skillsid >= g_arSkillTable.GetSize() ) return;

		if( g_arSkillTable[skillsid]->m_sSid == -1 ) return;

		if (sLevel > 99 || sLevel < 120) //¿ØÖÆ100-120¼¼ÄÜµã
		{
			m_UserSkill[emptyskillslot].tLevel = (BYTE)((sLevel % 100) + 1);
		}
		if (sLevel >= 120)//¿ØÖÆ120ÒÔºó¹Ì¶¨=20
		{
			m_UserSkill[emptyskillslot].tLevel = (BYTE)(20);					
		}
	}
	
	if(sLevel >=120 && sLevel<130)
	{//120¼¼ÄÜ×ª»»ºóÉý¼¶..¼ÓµÄµÄ...
		int iIndex=m_byClass *SKILL_NUM;
		//ÖÙ²ÃÖ°Òµ
		if(m_byClass == JUDGE)
		{
			iIndex = 25;
		}else
		{
			iIndex =m_byClass *SKILL_NUM;
		}
		int i;
		for(i = iIndex; i < iIndex + SKILL_NUM-1; i++)
		{
			if(m_UserSkill[i].sSid>=20&&m_UserSkill[i].sSid<=23)
			{
				m_UserSkill[i].tLevel++;
				if(m_UserSkill[i].tLevel>=20)
					m_UserSkill[i].tLevel=20;
			}
		}
	}
	if(sLevel >= 130 && o_yehuoini[0]->chaoneng == 1 ){   
		CheckMaxValue((short &)m_sSkillPoint_, (short)1);
	}
}

BOOL USER::CheckMoneyMinMax(int min, int max)
{
	if( min < -1 || max < -1 ) return FALSE;
	if( min == -1 && max == -1 ) return FALSE;

	DWORD dwMin = 0;
	DWORD dwMax = 0;

	if( min == -1 && max > 0 )		// max¹Ì¸¸ÀÇ µ·¸¸ ÀÖÀ¸¸é TRUE
	{
		dwMax = max;

		if( m_dwDN < dwMax )
		{
			return TRUE;
		}
	}
	else if( min > 0 && max == -1 )	// minÀÌ»óÀÇ µ·¸¸ ÀÖÀ¸¸é TRUE
	{
		dwMin = min;

		if( m_dwDN >= dwMin )
		{
			return TRUE;
		}
	}
	else if( min > 0 && max > 0 )
	{
		dwMin = min;
		dwMax = max;

		if( m_dwDN >= dwMin && m_dwDN < dwMax )
		{
			return TRUE;
		}
	}

	return FALSE;
}

BOOL USER::CheckRandom(int rand)
{
	if( rand <= 0 ) return FALSE;

	if( rand >= 100 ) return TRUE;

	int temp_rand = rand * 100;

	int rand_result = myrand( 0, 10000 );

	if( rand_result <= temp_rand ) return TRUE;

	return FALSE;
}
void USER::GiveDN(int dn)
{
	if( dn <= 0 ) return;

	DWORD dwBackup = m_dwDN;
	DWORD dwGiveDN = dn;

	CheckMaxValue( (DWORD &)m_dwDN, dwGiveDN );

	if( !UpdateUserItemDN() )
	{
		m_dwDN = dwBackup;
		return;
	}

	SendMoneyChanged();
}
void USER::GiveShopPingDN(int shoppingDN)
{
	if( shoppingDN <= 0 ) return;

	DWORD dwBackup = m_dwShopPingDN;
	DWORD dwGiveShopPingDN = shoppingDN;

	CheckMaxValue( (DWORD &)m_dwShopPingDN, dwGiveShopPingDN );

	if( !UpdateUserItemShopPingDN() )
	{
		m_dwShopPingDN = dwBackup;
		return;
	}
    SendUserStatusSkill();	//¸üÐÂÔª±¦ÊýÁ¿
}
//////////////////////////////////////////////////////////////////////////////////////////
void USER::GiveHiExpTime(int HiExpTime)
{
	if( HiExpTime <= 0 ) return;

	DWORD dwBackup = m_dwHiExpTime;
	DWORD dwGiveHiExpTime = HiExpTime;

	CheckMaxValue( (DWORD &)m_dwHiExpTime, dwGiveHiExpTime );

	if( !UpdateUserItemHiExpTime() )
	{
		m_dwHiExpTime = dwBackup;
		return;
	}

}

//¸øÐÒÔËÊ±¼ä
void USER::GiveMagicFindTime(int MagicFindTime)
{
	if( MagicFindTime <= 0 ) return;

	DWORD dwBackup = m_dwMagicFindTime;
	DWORD dwGiveMagicFindTime = MagicFindTime;

	CheckMaxValue( (DWORD &)m_dwMagicFindTime, dwGiveMagicFindTime );

	if( !UpdateUserItemMagicFindTime() )
	{
		m_dwMagicFindTime = dwBackup;
		return;
	}

}

void USER::GiveVIPTime( int VIPTime )
{
	if( VIPTime <= 0 ) return;


	DWORD dwBackup = m_dwVIPTime;
	DWORD dwGiveHiExpTime = VIPTime;

	CheckMaxValue( (DWORD &)dwBackup, dwGiveHiExpTime );

	if(m_dwVIPTime == 0)
	{
		AddAbnormalInfo(ABNORMAL_FUDAI);
		int index = 0;
		SetByte(m_TempBuf, SET_USER_STATE, index);
		SetInt(m_TempBuf, m_uid + USER_BAND, index);
		SetDWORD(m_TempBuf, m_dwAbnormalInfo, index);
		SetDWORD(m_TempBuf, m_dwAbnormalInfo_, index);					
		Send(m_TempBuf, index);			
	}
	m_dwVIPTime = dwBackup;

}


//////////////////////////////////////////////////////////////////////////////////////////

void USER::RobDN(int dn)
{
	if( dn <= 0 ) return;

	DWORD dwBackup = m_dwDN;
	DWORD dwRobDN = dn;
	DWORD dwTemp = m_dwDN;

	if( m_dwDN <= dwRobDN )
	{
		m_dwDN = 0;
	}
	else
	{
		m_dwDN = dwTemp - dwRobDN;
	}

	if( !UpdateUserItemDN() )
	{
		m_dwDN = dwBackup;
		return;
	}

	SendMoneyChanged();
}

void USER::RobLING(int dn)
{
	if( dn <= 0 ) return;

	DWORD dwBackup = m_dwLingQu;
	DWORD dwRobLing = dn;
	DWORD dwTemp = m_dwLingQu;

	if( m_dwLingQu <= dwRobLing )
	{
		m_dwLingQu = 0;
	}
	else
	{
		m_dwLingQu = dwTemp - dwRobLing;
	}

}
void USER::Collect(TCHAR *pBuf)
{
	USER*	pUser	= NULL;
	CNpc*	pNpc	= NULL;
	int		nTPosX	= 0;
	int		nTPosY	= 0;
	int		nAttackRange = 0;
	int		nDist	= 100;

	int		nDamage = 0;
	int		nDefense = 0;
//	double	nIronSkin = 0;
	int		nFinalDamage = 0;

	BYTE	tWeaponClass = 0;
	BYTE	tTargetClass = 0;

	BOOL	bCanUseSkill = FALSE;
	int		iRandom = 100;

	int		nHit	= 0;
	int		nAvoid	= 0;
//	int		nWeaponHit	= 0;

	BOOL	bIsHit	= FALSE;
	double	nVCHit	= 0;
	double	nCGuard	= 0;
	BOOL	bIsCritical = FALSE;

	int		nInitDamage = 0;
	
	short	sItemDefense[4] = {0, 0, 0, 0};

	BOOL	bSuccessSkill[SKILL_NUM] = {FALSE, FALSE, FALSE, FALSE, FALSE};
	BOOL	bTargetSkill[SKILL_NUM] = {FALSE, FALSE, FALSE, FALSE, FALSE};
	
	BYTE	tActionIndex = HIT_NONE;
	BYTE	tNpcClass = 0;

	short	sOldDuration = 0, sNewDuration = 0;
	short	sOldBullNum = 0;

	int		iFireErrDec = 0;
	int	determine = 0;
	int iDexHitRate = 0, iLevelHitRate = 0;
	int iMyDex = 0, iYourDex = 0;

	CByteArray	arSkillAction1, arSkillAction2;							// Skill Action Array

	DWORD dwExp = 0;
	int index = 0;
	int nTargetID = GetShort(pBuf, index);								// Target ID ¸¦ ¾ò´Â´Ù.

	if(nTargetID < USER_BAND || nTargetID >= INVALID_BAND) return;		// Àß¸øµÈ Target ÀÌ¸é return

	int sSid = m_UserItem[RIGHT_HAND].sSid;

	if( sSid < 0 || sSid >= g_arItemTable.GetSize() ) return;

	// °ø°Ý Delay Ã¼Å© ---------------------------------------------------------//
	DWORD dwCurrTick = GetTickCount();
	DWORD dwMinDelay = (DWORD)g_arItemTable[sSid]->m_sAttackDelay;
	if(dwMinDelay < DEFAULT_AT_DELAY) dwMinDelay = DEFAULT_AT_DELAY;

	if(m_dwLastAttackTime >= dwCurrTick) return;

	if(dwCurrTick - m_dwLastAttackTime >= dwMinDelay)
	{
		m_dwLastAttackTime = dwCurrTick;
	}

	// ³»±¸µµ °Ë»ç -------------------------------------------------------------//
	if(m_UserItem[RIGHT_HAND].sDuration <= 0)
	{
//		SendAttackFail(ERR_BROKEN);
		SendSystemMsg( IDS_USER_DAMAGED_ITEM, SYSTEM_NORMAL, TO_ME);
		return;
	}

	// Target °úÀÇ °Å¸®°è»ê ----------------------------------------------------//
	if(nTargetID >= USER_BAND && nTargetID < NPC_BAND)	// USER : Ã¤Áý µµ±¸¸¦ Â÷°í À¯Àú¸¦ °ø°ÝÇÒ ¼ö ¾ø´Ù
	{
		SendAttackMiss(nTargetID);
		return;
	}
	else if(nTargetID >= NPC_BAND)				// NPC
	{
		pNpc = GetNpc(nTargetID - NPC_BAND);	// NPC Point ¸¦ ¾ò´Â´Ù.
		if(pNpc == NULL) return;				// Àß¸øµÈ NPC ÀÌ¸é ¸®ÅÏ
		if(pNpc->m_NpcState == NPC_DEAD || pNpc->m_sHP <= 0)
		{
			//pNpc->m_Delay = pNpc->SendDead(m_pCom, 0);
			return;// NPC °¡ ÀÌ¹Ì Á×¾î ÀÖÀ¸¸é ¸®ÅÏ
		}
		if(pNpc->m_tNpcType != 0) return;

		nTPosX = pNpc->m_sCurX;
		nTPosY = pNpc->m_sCurY;
	}

	nAttackRange = GetAttackRange(m_UserItem[RIGHT_HAND].sSid);
	nAttackRange += 1;	// ¹°¸®ÀûÀÎ Å¸°ÝÀ»°¡ÇÒ¶§¸¸ +1¸¦ ÇØÁØ´Ù.(ÀÌµ¿ ¼Óµµ¶§¹®¿¡ ¸÷À» ÀâÁö ¸øÇØ¼­ º¸Á¤À¸·Î...)

	if(GetDistance(nTPosX, nTPosY, nAttackRange, &nDist) == FALSE)		// °ø°Ý°¡´É°Å¸® ¹ÛÀÌ¸é ¸®ÅÏ
	{
		if(g_bDebug) SendSystemMsg(_T("### Too Long Distance!!!"), SYSTEM_NORMAL, TO_ME);
		return;
	}

	// ¸íÁß °ª -------------------------------------------------------//
	int nBasicSuccess = 70;
	int nTotalSuccess = 0;

	if( m_UserItem[RIGHT_HAND].sSid == 699 )
	{
		nBasicSuccess = 80;
	}
	else if( m_UserItem[RIGHT_HAND].sSid == 670 )
	{
		nBasicSuccess = 100;
	}

	nTotalSuccess = (int)( (double)m_sMagicDEX * 0.1 + 0.5 );
	nTotalSuccess += nBasicSuccess;

	if( nTotalSuccess < 100 )
	{
		if( nTotalSuccess < myrand( 1, 100 ) )
		{
			SendAttackMiss(nTargetID);
			return;
		}
	}

	// È¸ÇÇ°ª/¸íÁßÆÇÁ¤/µ¥¹ÌÁö °è»ê/³»±¸µµ °è»ê/ÃÖÁ¾ °ø°Ý½Ã°£ ¼ÂÆÃ----------//
	if(nTargetID >= USER_BAND && nTargetID < NPC_BAND)	// USER : À¯Àú´Â Ã¤Áý´ë»óÀÌ ¾Æ´Ï´Ù
	{
		return;
	}

	if(nTargetID >= NPC_BAND)				// NPC
	{
		pNpc = GetNpc(nTargetID - NPC_BAND);		// NPC Point ¸¦ ¾ò´Â´Ù.
		
		if(pNpc == NULL) return;					// Àß¸øµÈ NPC ÀÌ¸é ¸®ÅÏ
		if(pNpc->m_NpcState == NPC_DEAD) return;
		if(pNpc->m_sHP == 0) return;

		if(pNpc->m_tNpcType == NPCTYPE_GUARD)					// °æºñº´ÀÌ¸é Å¸°ÙÀ» ÇØ´ç À¯Àú·Î
		{
			pNpc->m_Target.id = m_uid + USER_BAND;
			pNpc->m_Target.x = m_curx;
			pNpc->m_Target.y = m_cury;
			pNpc->m_Target.failCount = 0;
			pNpc->Attack(m_pCom);

			return;
		}

		pUser = GetUser(m_uid);
        if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
		if(pNpc->m_tNpcType == NPCTYPE_GUILD_GUARD)	pNpc->ChangeTarget(pUser, m_pCom);

		// NPC ¹æ¾î°ª 
		nDefense = pNpc->GetDefense();

		nFinalDamage = 1;		// Ã¤Áý µµ±¸·Î Ä¥¶§´Â damage°¡ 1ÀÌ´Ù

		// °ø°ÝÃø ³»±¸µµ °¨¼Ò
		// ³»±¸µµ
		sNewDuration = (int)((double)nDefense/10 + 0.5);
		sOldDuration = m_UserItem[RIGHT_HAND].sDuration;

		iRandom = (int)((double)XdY(1, 1000) / 10 + 0.5);
		if(m_UserItem[RIGHT_HAND].sSid >= 0 && m_UserItem[RIGHT_HAND].sSid < g_arItemTable.GetSize())
		{
			if(iRandom < g_arItemTable[m_UserItem[RIGHT_HAND].sSid]->m_byErrorRate)
			{
				//iFireErrDec = 10 - GetBreakDec();
				iFireErrDec=4;
				if(iFireErrDec < 0) iFireErrDec = 0;

				//m_UserItem[RIGHT_HAND].sDuration -= iFireErrDec;
				SendDuration(RIGHT_HAND, iFireErrDec);
			}
		}

		// °ø°ÝÀÌ ¼º°ø ÇßÀ¸¹Ç·Î ÀÌº¥Æ®¸¦ Ã£¾Æ¼­ ½ÇÇà ---------------------------------//
		int i, j;
		int event_zone_index = -1;
		int real_event = -1;
		EVENT*	pEvent = NULL;

		if( pNpc->m_sEvent >= MONSTER_ATTACK_EVENT_BAND && m_iDisplayType != 6 )	// ¸ó½ºÅÍ°¡ °¡Áö±¸ ÀÖ´Â ÀÌº¥Æ®°¡ °ø°Ý ÀÌº¥Æ®ÀÎÁö È®ÀÎ
		{
			real_event = pNpc->m_sEvent % MONSTER_ATTACK_EVENT_BAND;

			for(i = 0; i < g_event.GetSize(); i++)
			{
				if(g_event[i]->m_Zone == m_curz)
				{				
					event_zone_index = i;
					break;
				}
			}

			if(event_zone_index != -1)// return;			// ÇöÀç Zone ¿¡´Â define µÈ ÀÌº¥Æ®°¡ ¾ø´Ù.
			{
				pEvent = g_event[event_zone_index];

				if(pEvent)
				{
					if(real_event < pEvent->m_arEvent.GetSize() && real_event > 0)
					{
						if(pEvent->m_arEvent[real_event])
						{
							if(CheckEventLogic(pEvent->m_arEvent[real_event]))// return;	// Á¶°Ç°Ë»ç
							{
								for(j = 0; j < pEvent->m_arEvent[real_event]->m_arExec.GetSize(); j++)
								{
									if(RunNpcEvent(pNpc, pEvent->m_arEvent[real_event]->m_arExec[j]) == NULL) break;
								}
							}
						}
					}
				}
			}
		}

		// Calculate Target HP -------------------------------------------------------//
		short sOldNpcHP = pNpc->m_sHP;

		if(pNpc->SetDamage(nFinalDamage, m_uid + USER_BAND, m_pCom) == FALSE)
		{
			pNpc->SendExpToUserList(m_pCom); // °æÇèÄ¡ ºÐ¹è!!
			int diffLevel = abs(m_sLevel - pNpc->m_byClassLevel); //¹ÖÎïµÈ¼¶Ïà²î30¼¶Ã»¾­Ñé
			if(diffLevel <= o_yehuoini[0]->djxz || pNpc->m_sEvent != 0 )
			{
				if (m_isDoubleBAOLV  > 0 || g_sanBaoLv == TRUE || m_dwGuarDianTianShi > 0)
					pNpc->SendDead(m_pCom,1,TRUE);
				else
					pNpc->SendDead(m_pCom);
			}
			else
			{
				pNpc->SendDead(m_pCom,0);
				SendSystemMsg("ÄúºÍµ±Ç°¹ÖÎïµÈ¼¶Ïà²î20,Ã»ÓÐÈÎºÎËùµÃ", SYSTEM_ERROR,TO_ME);
			}
			/*if (m_dwShaGuai >= 3000 ) 
			{
	            SendSystemMsg("Äú½ñÈÕÉ±¹ÖÊýÁ¿ÒÑÂú,´ò¹ÖÎÞ·¨»ñµÃÈÎºÎ¾­ÑéÖµ", SYSTEM_ERROR,TO_ME);
			}  */
			 //if(diffLevel <= o_yehuoini[0]->djxz  &&  pNpc->m_tNpcType == 0 )
			 //  {
				//   CString strMsg;
				//   if (m_dwShaGuai == 1000)
				//   {
				//	   SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 5 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	   m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 2000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 10 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	  m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 3000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	    
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 15 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 4000)
				//   {
				//	   SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	    
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 20 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 5000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 30 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }
			 //  }

			
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

			if(m_tGuildHouseWar == GUILD_WARRING && pNpc->m_NpcVirtualState == NPC_WAIT)
			{
				CheckGuildHouseWarEnd();
			}
			else
			{
				int diffLevel = abs(m_sLevel - pNpc->m_byClassLevel);
				if(diffLevel < 40)
				{
					CheckMaxValue(m_dwXP, 1);		// ¸÷ÀÌ Á×À»¶§¸¸ 1 Áõ°¡!	
					SendXP();
				}
			}
		}

		// °ø°Ý °á°ú Àü¼Û
		SendAttackSuccess(nTargetID, bIsCritical, pNpc->m_sHP, pNpc->m_sMaxHP);

		m_dwLastAttackTime = GetTickCount();
	}
}

void USER::SendEventMsg(char *pMsg)
{
	if( strlen( pMsg ) >= 128 ) return;

//	SendSystemMsg( pMsg, SYSTEM_ERROR, TO_ME);
//////////////¸Ä³É»Æ×ÖÌáÐÑ//////////////
	CString str;
	str.Format(pMsg);
    CBufferEx	TempBuf,TempBuf1;
	TempBuf.Add((byte)CHAT_RESULT);
	TempBuf.Add((byte)1);
	TempBuf.Add(WHISPER_CHAT);
	TempBuf.Add((int)0x00);
	TempBuf.Add("", _tcslen(""));
	TempBuf.Add(str.GetBuffer(0), str.GetLength());
	Send(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////
// NPCËµ»°
//
void USER::SendNpcToUserMsg(CNpc *pNpc,int Type,char* pMsg)
{
	if(strlen(pMsg) >= 128) return;
	if(!pNpc) return;
	CString strMsg =_T("");
	CBufferEx TempBuf;
	TempBuf.Add(CHAT_RESULT);
	TempBuf.Add(SUCCESS);
	TempBuf.Add((BYTE)Type);
	if(Type == 2)
	{
	TempBuf.Add((int)0x01);
	}else{
	TempBuf.Add(pNpc->m_sNid + NPC_BAND);
	}
	TempBuf.AddString(pNpc->m_strName);
	strMsg.Format(pMsg);
	TempBuf.AddString((LPTSTR)(LPCTSTR)strMsg);
	//SendScreen(TempBuf, TempBuf.GetLength());//·¢ËÍËùÓÐÈË
	Send(TempBuf, TempBuf.GetLength());//·¢ËÍ×Ô¼º
}

void USER::WriteItemLog(ItemList *pItem, int type, char *strEtc)
{
	if( !pItem ) return;
	if( !CheckItemLog( pItem ) ) return;

	ITEMLOG* pItemLog = new ITEMLOG;
	pItemLog->t = CTime::GetCurrentTime();
	pItemLog->m_sLogType = type;
	memset( pItemLog->m_strUserId, NULL, CHAR_NAME_LENGTH+1 );
	memcpy( pItemLog->m_strUserId, m_strUserID, CHAR_NAME_LENGTH );

	memset( pItemLog->m_strEtc, NULL, CHAR_NAME_LENGTH+1 );
	if( strEtc != NULL )	memcpy( pItemLog->m_strEtc, strEtc, CHAR_NAME_LENGTH );
	else					memcpy( pItemLog->m_strEtc, m_strUserID, CHAR_NAME_LENGTH );

	pItemLog->m_sLevel		= pItem->sLevel;
	pItemLog->m_sSid		= pItem->sSid;
	pItemLog->m_sDuration	= pItem->sDuration;
	pItemLog->m_sBullNum	= pItem->sBullNum;
	pItemLog->m_sCount		= pItem->sCount;

	for( int i = 0; i < MAGIC_NUM; i++ )
	{
		pItemLog->m_tMagic[i] = pItem->tMagic[i];
	}

	pItemLog->m_tIQ			= pItem->tIQ;

	pItemLog->m_iItemSerial	= pItem->iItemSerial;

	if( !UpdateMemItemLog( pItemLog ) )
	{
	}

	delete pItemLog;
}

BOOL USER::CheckItemLog(ItemList *pItem)
{
	if( !pItem ) return FALSE;

	if( pItem->iItemSerial == 0 ) pItem->iItemSerial = GenerateItemSerial( pItem );
	if( pItem->iItemSerial == 0 ) return FALSE;

	return TRUE;
}

BOOL USER::UpdateMemItemLog(ITEMLOG *pItemLog)
{
	if( !m_pSharedMemory )				return FALSE;
	if( !m_pSharedMemory->m_hMapping )	return FALSE;
	if( !m_pMD )						return FALSE;
	if( m_pMD->m_uid == -1 )			return FALSE;

	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return FALSE;

	for( int i = 0; i < 100; i++ )
	{
		if( m_pMD->m_arItemLogData[i][0] != NULL ) continue;
		memcpy( m_pMD->m_arItemLogData[i], pItemLog, sizeof(ITEMLOG) );
		break;
	}

	return TRUE;
}

void USER::MakeItemLog(ItemList *pItem, int type, char *strEtc)
{
	if( !pItem ) return;
	//if( !CheckItemLog( pItem ) ) return;

	ITEMLOG* pItemLog = new ITEMLOG;
	pItemLog->t = CTime::GetCurrentTime();
	pItemLog->m_sLogType = type;
	memset( pItemLog->m_strUserId, NULL, CHAR_NAME_LENGTH+1 );
	memcpy( pItemLog->m_strUserId, m_strUserID, CHAR_NAME_LENGTH );

	memset( pItemLog->m_strEtc, NULL, CHAR_NAME_LENGTH+1 );
	if( strEtc != NULL )	memcpy( pItemLog->m_strEtc, strEtc, CHAR_NAME_LENGTH );
	else					memcpy( pItemLog->m_strEtc, m_strUserID, CHAR_NAME_LENGTH );

	pItemLog->m_sLevel		= pItem->sLevel;
	pItemLog->m_sSid		= pItem->sSid;
	pItemLog->m_sDuration	= pItem->sDuration;
	pItemLog->m_sBullNum	= pItem->sBullNum;
	pItemLog->m_sCount		= pItem->sCount;

	for( int i = 0; i < MAGIC_NUM; i++ )
	{
		pItemLog->m_tMagic[i] = pItem->tMagic[i];
	}
	pItemLog->m_tIQ			= pItem->tIQ;

	pItemLog->m_iItemSerial	= pItem->iItemSerial;

	pItemLog->m_dwResultDN	= 0;
	pItemLog->m_dwInOutDN	= 0;
	pItemLog->m_dwRelateDN	= 0;
	m_arItemLog.Add( pItemLog );
}


void USER::MakeMoneyLog(DWORD dwAddMoney, int type, char *strEtc, DWORD dwChangeMoney)
{
	if( dwAddMoney < 10000 ) return;

	ITEMLOG* pItemLog = new ITEMLOG;
	pItemLog->t = CTime::GetCurrentTime();
	pItemLog->m_sLogType = type;
	memset( pItemLog->m_strUserId, NULL, CHAR_NAME_LENGTH+1 );
	memcpy( pItemLog->m_strUserId, m_strUserID, CHAR_NAME_LENGTH );

	memset( pItemLog->m_strEtc, NULL, CHAR_NAME_LENGTH+1 );
	if( strEtc != NULL )	memcpy( pItemLog->m_strEtc, strEtc, CHAR_NAME_LENGTH );
	else					memcpy( pItemLog->m_strEtc, m_strUserID, CHAR_NAME_LENGTH );

	pItemLog->m_sLevel		= 0;
	pItemLog->m_sSid		= -1;
	pItemLog->m_sDuration	= 0;
	pItemLog->m_sBullNum	= 0;
	pItemLog->m_sCount		= 0;

	for( int i = 0; i < MAGIC_NUM; i++ )
	{
		pItemLog->m_tMagic[i] = 0;
	}

	pItemLog->m_tIQ			= 0;

	pItemLog->m_iItemSerial	= 0;

	pItemLog->m_dwResultDN	= m_dwDN;
	pItemLog->m_dwInOutDN	= dwAddMoney;
	pItemLog->m_dwRelateDN	= dwChangeMoney;

	m_arItemLog.Add( pItemLog );
}

void USER::FlushItemLog(BOOL bSave)
{
	if( !m_arItemLog.GetSize() ) return;

	int i = 0;

	if( bSave )
	{
		for( i = 0; i < m_arItemLog.GetSize(); i++ )
		{
			if( m_arItemLog[i] )
			{
				UpdateMemItemLog( m_arItemLog[i] );
			}
		}
		m_arItemLog.RemoveAll();
	}
	else
	{
		for( i = 0; i < m_arItemLog.GetSize(); i++ )
		{
			if( m_arItemLog[i] )
			{
				delete m_arItemLog[i];
			}
		}
		m_arItemLog.RemoveAll();
	}
}

int USER::GetMinusExpRatioByCityRank(int enemyrank)
{
	if( enemyrank == -1 ) return 10;

	int otherrank = enemyrank;
	int merank = m_sCityRank + CITY_RANK_INTERVAL;

	if( merank < 0 || merank > 12 ) return 10;
	if( otherrank < 0 || otherrank > 12 ) return 10;

	//			 ¼¼  °¡
	//			 ³ª  ³²
	int exptable[13][13] = 
	{//                ³ª»Û <-  c  -> ÁÁÀº
		{  10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10	},
		{  10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10	},
		{  10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10	},
		{  10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10	},// ³ª»Û
		{  10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10	},//  |
		{	0,  2,	3,	4,	6, 10, 10, 10, 10, 10, 10, 10	},//  c
		{	0,  2,	3,	4,	6, 10, 10, 10, 10, 10, 10, 10	},//  |
		{	0,  2,	3,	4,	6, 10, 10, 10, 10, 10, 10, 10	},// ÁÁÀº
		{	0,  2,	3,	4,	6, 10, 10, 10, 10, 10, 10, 10	},
		{	0,	1,	2,	3,	5, 10, 10, 10, 10, 10, 10, 10	},
		{	0,	1,	2,	3,	5, 10, 10, 10, 10, 10, 10, 10	},
	};

	return exptable[merank][otherrank];
}

int USER::GetDropItemRankByAttackerCityRank(int enemyrank)
{
	if( enemyrank == -1 )
	{
		return m_sCityRank + CITY_RANK_INTERVAL;	// »ó´ë¸¦ ±¸ÇÒ ¼ö ¾øÀ» °æ¿ì¿£ ¿ø·¡ ·©Å©¸¦ ¸®ÅÏÇÑ´Ù
	}

	int otherrank = enemyrank;
	int merank = m_sCityRank + CITY_RANK_INTERVAL;

	if( merank < COMMOM_RANK )	// ³» ¼ºÇâÀÌ ÄÉÀÎ ÀÌÇÏ¶ó¸é Á×ÀÎ ³ÑÀÇ ·©Å©¿Í »ó°ü¾øÀÌ ¿ø·¡ ·©Å©¸¦ ¸®ÅÏ
	{
		return merank;
	}

	if( otherrank == CHAONISE_RANK )	// ³¯ Á×ÀÎ ³ÑÀÌ Ä«¿À´Ï½º¶ó¸é ³ª´Â ¾ÆÀÌÅÛÀ» ¾È¶³¾î¶ß¸°´Ù
	{
		return SAINT_RANK + 1;			// ¼¼ÀÎÆ®µµ ¾ÆÅÛÀ» ¶³±¸°Ô µÇ¾î ÀÖÀ¸¹Ç·Î ¼¼ÀÌÆ®º¸´Ù ³ôÀº µî±ÞÀ» ¼ÂÆÃÇÑ´Ù
	}

	if( otherrank >= DEATH_RANK && otherrank < COMMOM_RANK )	// ¿©±â±îÁö ¿ÔÀ¸¸é ³ª´Â ½ÃÆ¼Áð ÀÌ»óÀÌ´Ù. ±×·±µ¥ ³¯ Á×ÀÎ³ÑÀÌ
	{															// µ¥½º ÀÌ»ó, ÄÉÀÎ ÀÌÇÏÀÌ¸é ¾ÆÅÛÀ» ¶³¾î¶ß¸± È®·üÀº ¼¼ÀÎÆ®·Î °íÁ¤µÈ´Ù
		return SAINT_RANK;
	}

	return merank;		// ³ª´Â ½ÃÆ¼Áð ÀÌ»óÀÌ°í, ³¯ Á×ÀÎ ³Ñµµ ½ÃÆ¼Áð ÀÌ»óÀÌ´Ù. ±×·¸´Ù¸é ¿ø·¡ ·©Å©´ë·Î ¶³¾î¶ß¸°´Ù
}

///////////////////////////////////////////////////////////////////////////////////////
//	Memory DB ¿¡ ÀÖ´Â ³»¿ëÀ» °ÔÀÓº¯¼ö·Î ¿Å±ä´Ù.
//
BOOL USER::Mem2Game(CMemUser *pMD)
{
	if(IsBadReadPtr((CONST VOID*)pMD, sizeof(CMemUser))) return FALSE;

	int i;

	// Copy User Data
	::ZeroMemory( m_strUserID, CHAR_NAME_LENGTH + 1 );
	::CopyMemory(m_strUserID, pMD->m_strUserID, strlen(pMD->m_strUserID));	// User ID
	
	m_sSTR = pMD->m_sSTR;				// Èû
	m_sCON = pMD->m_sCON;				// °Ç°­
	m_sDEX = pMD->m_sDEX;				// ¹ÎÃ¸
	m_sVOL = pMD->m_sVOL;				// ÀÇÁö
	m_sWIS = pMD->m_sWIS;				// ÁöÇý

	m_sTempSTR = pMD->m_sTempSTR;		// ÃÊ±â ·Ñ°ª¸¦ ¹Þ¾Æ¿Â´Ù.(·¹º§´Ù¿îÀÏ¶§ ¾¸)
	m_sTempCON = pMD->m_sTempCON;
	m_sTempDEX = pMD->m_sTempDEX;
	m_sTempVOL = pMD->m_sTempVOL;
	m_sTempWIS = pMD->m_sTempWIS;

	m_iSkin = pMD->m_iSkin;			// ÇÇºÎ»ö
	m_iHair = pMD->m_iHair;			// ¸Ó¸®»ö

	m_curz = pMD->m_curz;				// Zone
	m_curx = pMD->m_curx;				// À§Ä¡ x
	m_cury = pMD->m_cury;				// À§Ä¡ y

	m_sGender = pMD->m_sGender;		// ¼ºº°

	::CopyMemory(m_strFace, pMD->m_strFace, 10);	// ¸Ó¸®¸ð¾ç

	m_dwBuddy = pMD->m_dwBuddy;			// Buddy
	m_dwGuild = pMD->m_dwGuild;			// Guild

	m_tFortressWar		= GUILD_WAR_AFFTER;
	m_tGuildWar			= GUILD_WAR_AFFTER;
	m_tGuildHouseWar	= GUILD_WAR_AFFTER;

	if(m_dwGuild >= 0)			// ±æµå¿¡ ´ëÇÑ µ¥ÀÌÅÍ¸¦ ÃÊ±âÈ­ÇÑ´Ù.
	{
		SetGuildVariable();
	}

	CheckGuildWar();			// ¸¸¾à °ø¼ºÀü ÁßÀÌ¶ó¸é ¸ðµç À¯Àú¿¡°Ô ¾Ë¸°´Ù.(Áö±ÝÀº °ø¼ºÀü¸¸)

	m_bFieldWarApply = FALSE;
	m_FieldWarGMUid = 0;		// ÇÊµåÀüÀÏ¶§ »ó´ë¹æ ±æ¸¶ uid
	m_dwFieldWar = 0;			// ÇÊµåÀü ½ÃÀÛÀÌ¸é »ó´ëÆí ±æµå ¹øÈ£°¡ µé¾î¿Â´Ù.

	m_sLevel	= pMD->m_sLevel;		// ·¹º§

	if(pMD->m_dwExp > GetNextLevel(m_sLevel)) pMD->m_dwExp = GetNextLevel(m_sLevel);	// ¾ÈÀü ÄÚµå.
	m_dwExp = pMD->m_dwExp;		// Experience

	m_sPA = pMD->m_sPA;			// PA Point

	m_sSkillPoint = pMD->m_sSkillPoint;	// Skill Point

	m_dwXP = pMD->m_dwXP;		// X Point
	
	m_byClass	= pMD->m_byClass;		// Å¬·¡½º

	m_sMaxHP	= g_sHPConst[m_byClass] * m_sCON + g_sHPLV[m_byClass] * (m_sLevel - 1) + g_sHPAdd[m_byClass];
	m_sMaxPP	= g_sPPConst[m_byClass] * m_sWIS + g_sPPLV[m_byClass] * (m_sLevel - 1) + g_sPPAdd[m_byClass];
	m_sMaxSP	= g_sSPConst[m_byClass] * m_sCON + g_sSPLV[m_byClass] * (m_sLevel - 1) + g_sSPAdd[m_byClass];

	m_bLive		= pMD->m_bLive;	// Á×¾ú´ÂÁö, »ì¾Ò´ÂÁö?

	m_sHP		= pMD->m_sHP;	// ÇöÀç HP
	m_sPP		= pMD->m_sPP;	// ÇöÀç PP
	m_sSP		= pMD->m_sSP;	// ÇöÀç SP

	if(m_sHP <= 0 || m_bLive == USER_DEAD) 
	{
		m_bLive = USER_DEAD;
		SetZoneIndex(m_curz);
		IsDeadUser();		// Á×Àº À¯Àú¸é ¸¶À»·Î...

		m_bLive = USER_LIVE;
		m_sHP = m_sMaxHP;	
	}
	else SetZoneIndex(m_curz);

	if(m_sHP > m_sMaxHP) m_sHP = m_sMaxHP;
	if(m_sPP > m_sMaxPP) m_sPP = m_sMaxPP;
	if(m_sSP > m_sMaxSP) m_sSP = m_sMaxSP;

	if(pMD->m_dwDN < 0) pMD->m_dwDN = 0;
	m_dwDN		= pMD->m_dwDN;			// ¼ÒÁö±Ý

	m_iCityValue = pMD->m_iCityValue;	// ½Ã¹Î ´©Àû°ª
	m_sKillCount = pMD->m_sKillCount;	// PK´©Àû È½¼ö

	for(i = 0; i < 13; i++)
	{
		if(m_iCityValue < g_CityRankValue[i])// ´©ÀûÄ¡°ªÀÌ ±âÁØ ¼³Á¤°ªº¸´Ù ÀÛÀºÁö ÆÇ´ÜÇÑ´Ù.
		{
			if(i < 6) { m_sCityRank = i - CITY_RANK_INTERVAL; }
			else { m_sCityRank = i -1 - CITY_RANK_INTERVAL; }
			break;
		}
	}

	if(m_iCityValue >= g_CityRankValue[12]) m_sCityRank = 7;

	::CopyMemory(m_strSkill, pMD->m_strSkill, sizeof(m_strSkill));	// ½ºÅ³
	::CopyMemory(m_strItem, pMD->m_strItem, sizeof(m_strItem));		// ¾ÆÀÌÅÛ
	::CopyMemory(m_strPsi, pMD->m_strPsi, sizeof(m_strPsi));		// »çÀÌ¿À´Ð

	StrToUserSkill((LPTSTR)pMD->m_strSkill);
	StrToUserItem((LPTSTR)pMD->m_strItem);
	StrToUserPsi((LPTSTR)pMD->m_strPsi);
	StrToHaveEventData((LPTSTR)pMD->m_strHaveEvent);
	StrToUserTel((LPSTR)pMD->m_strTel);

	m_dwExpNext	= GetNextLevel(m_sLevel);						// ´ÙÀ½·¹º§ÀÌ µÇ±âÀ§ÇÑ °æÇèÄ¡

	for(i = 0; i < TOTAL_SKILL_NUM; i++)						// ½ºÅ³ ¼º°øÀ² 
	{
		GetSkillInfo(i, m_UserSkillInfo[i]);
	}
//	m_UserChangeSkillInfo;										// ÀüÁ÷ÀÌ ÀÖÀ»°æ¿ì ?(5)½ºÅ³¸¦ ÀúÀå

	for(i = 0; i < CLASS_NUM; i++)
	{
		m_sChangeClass[i] = pMD->m_sChangeClass[i];
	}

	// »óÅÂÀÌ»ó Á¤º¸
	m_tAbnormalKind = pMD->m_tAbnormalKind;	
	m_dwAbnormalTime = pMD->m_dwAbnormalTime;

//	dwMaxDN = m_sLevel * MAX_LEVEL_DN;									// ¼ÒÁö±ÝÀÌ ÀÌ»óÇÑÁö Ã¼Å©
//	if( m_dwDN > dwMaxDN ) m_dwDN = dwMaxDN; 
	m_tDir = myrand(0, 7);												// ÇöÀç º¸°íÀÖ´Â ¹æÇâÀ» ·¥´ýÀ¸·Î ÃÊ±âÈ­ÇÑ´Ù.
		
	m_tIsOP = pMD->m_tIsOP;
	if(pMD->m_tIsOP == 1) AddAbnormalInfo(OPERATION_MODE);				// ±âº»ÀÌ Åõ¸í¸ðµåÀÓ...

	CheckInvalidGuildZone();

	m_dwSaintTime = pMD->m_dwSaintTime;

	m_dwHiExpTime		= pMD->m_dwHiExpTime;
	m_dwHtExpTime		= pMD->m_dwHtExpTime;
	m_dwMagicFindTime	= pMD->m_dwMagicFindTime;
	m_dwMagicFtTime		= pMD->m_dwMagicFtTime;
	m_dwNoChatTime		= pMD->m_dwNoChatTime;
	m_dwZF		= pMD->m_dwZF;
	m_dwXL		= pMD->m_dwXL;
    m_dwCloseTime		= pMD->m_dwCloseTime;
	m_dwAutoMoney		= pMD->m_dwAutoMoney;
	m_dwPD      		= pMD->m_dwPD;
	m_dwLingQu  		= pMD->m_dwLingQu;
	m_dwShaGuai  		= pMD->m_dwShaGuai;
	m_dwGuarDianTianShi = pMD->m_dwGuarDianTianShi;//ÊØ»¤ÌìÊ¹
	m_dwShopPingDN		= pMD->m_dwShopPingDN;
	m_dwVIPTime		    = pMD->m_dwVIPTime;
	m_dwZaiXianTime		= pMD->m_dwZaiXianTime;
	m_dwBFindTime		= pMD->m_dwBFindTime;
	m_dwHXTime		    = pMD->m_dwHXTime;
	m_dwSGTime		    = pMD->m_dwSGTime;
	m_dwXYTime		    = pMD->m_dwXYTime;
	m_dwZFTime		    = pMD->m_dwZFTime;
	
	m_dwHasteTime = m_dwShieldTime = m_dwDexUpTime = m_dwMaxHPUpTime = 0;					// Psi One
	m_dwFastRunTime = m_dwMindShockTime = m_dwBigShieldTime = m_dwPsiShieldTime = m_dwPiercingShieldTime = 0;	// Psi One

	m_dwAdamantineTime	= m_dwMightyWeaponTime = m_dwBerserkerTime = 0;						// Psi Two

	m_dwMindGuardTime = 0;																	// Psi Three

	if(pMD->m_tPsiOneKind == PSIONIC_HASTE)				m_dwHasteTime		= pMD->m_dwPsiOneTime;
	if(pMD->m_tPsiOneKind == PSIONIC_SHIELD)			m_dwShieldTime		= pMD->m_dwPsiOneTime;
	if(pMD->m_tPsiOneKind == PSIONIC_DEXUP)				m_dwDexUpTime		= pMD->m_dwPsiOneTime;
	if(pMD->m_tPsiOneKind == PSIONIC_HPUP)				m_dwMaxHPUpTime		= pMD->m_dwPsiOneTime;
	if(pMD->m_tPsiOneKind == PSIONIC_FAST_RUN)			m_dwFastRunTime		= pMD->m_dwPsiOneTime;
	if(pMD->m_tPsiOneKind == PSIONIC_MIND_SHOCK)		m_dwMindShockTime	= pMD->m_dwPsiOneTime;
	if(pMD->m_tPsiOneKind == PSIONIC_PSI_SHIELD)		m_dwPsiShieldTime	= pMD->m_dwPsiOneTime;
    if(pMD->m_tPsiOneKind == 30 )                       m_dwBigShieldTime   = pMD->m_dwPsiOneTime;
	if(pMD->m_tPsiOneKind == PSIONIC_PIERCING_SHIELD)	m_dwPiercingShieldTime = pMD->m_dwPsiOneTime;

	if(pMD->m_tPsiTwoKind == PSIONIC_ADAMANTINE)		m_dwAdamantineTime		= pMD->m_dwPsiTwoTime;
	if(pMD->m_tPsiTwoKind == PSIONIC_MIGHTYWEAPON)		m_dwMightyWeaponTime	= pMD->m_dwPsiTwoTime;
	if(pMD->m_tPsiTwoKind == PSIONIC_BERSERKER)			m_dwBerserkerTime		= pMD->m_dwPsiTwoTime;
	
	if(pMD->m_tPsiThreeKind == PSIONIC_MIND_GUARD)		m_dwMindGuardTime		= pMD->m_dwPsiThreeTime;
	//m_dwBSTime=pMD->m_dwBSTime;
	m_dwDNMoney = pMD->m_dwDNMoney;
	m_dwShTsTime = pMD->m_dwShTsTime;
	m_isDoubleExp = pMD->m_isDoubleExp;
	m_isDoubleBAOLV = pMD->m_isDoubleBAOLV;
	
    DWORD dwCurrTime = GetTickCount();
	m_dwLastSpeedTime = dwCurrTime;
	m_dwLastMoveAndRun = dwCurrTime;
	m_dwLastAttackTime = dwCurrTime;
	m_dwLastPsiAttack = dwCurrTime;
	m_dwCastDelay = 0;
	m_dwLastTimeCount = dwCurrTime;
	m_dwLastAbnormalTime = dwCurrTime;
	m_dwLastHPTime = dwCurrTime;

	m_dwLastHasteTime = dwCurrTime;
	m_dwLastShieldTime = dwCurrTime;
	m_dwLastDexUpTime = dwCurrTime;
	m_dwLastMaxHPUpTime = dwCurrTime;
	m_dwLastWISUpTime = dwCurrTime;
	m_dwLastFANTAnTime = dwCurrTime;
	m_dwLastFENGLiTime = dwCurrTime;
	m_dwLastYINENgTime = dwCurrTime;
	m_dwLastDUOCHONgTime = dwCurrTime;

	m_dwLastHiExpTime		= dwCurrTime;
	m_dwLastHtExpTime		= dwCurrTime;
	m_dwLastMagicFindTime	= dwCurrTime;
	m_dwLastMagicFtTime	    = dwCurrTime;
	m_dwLastNoChatTime		= dwCurrTime;
	m_dwLastZF		= dwCurrTime;
	m_dwLastXL		= dwCurrTime;
    m_dwLastCloseTime		= dwCurrTime;
	m_dwLastAutoMoney		= dwCurrTime;
	m_dwLastPD		        = dwCurrTime;
	m_dwLastLingQu		= dwCurrTime;
	m_dwLastShaGuai		= dwCurrTime;
	m_dwLastGuarDianTianShi = dwCurrTime;
	m_dwLastVIPTime			= dwCurrTime;
	m_dwLastBFindTime		= dwCurrTime;
	m_dwLastHXTime		    = dwCurrTime;
	m_dwLastSGTime		    = dwCurrTime;
	m_dwLastXYTime		    = dwCurrTime;
	m_dwLastZFTime		    = dwCurrTime;
	
	m_dwLastAdamantineTime	= dwCurrTime;
	m_dwLastMightyWeaponTime= dwCurrTime;
	m_dwBerserkerTime		= dwCurrTime;

	m_iMyServer = pMD->m_iMyServer;

	GetRecoverySpeed();													// À¯Àú Å¬·¡½ºÀÇ È¸º¹¼Óµµ¸¦ °áÁ¤ÇÑ´Ù.

	// User Bank --------------------------------
	StrToUserBankItem((LPTSTR)pMD->m_UB.m_UserBankItem);
	m_dwBankDN = pMD->m_UB.m_dwBankDN;

	// Account Bank -----------------------------
	StrToAccountBankItem((LPTSTR)pMD->m_AB.m_AccountBankItem);
	m_dwAccountBankDN = pMD->m_AB.m_dwBankDN;

	return TRUE;
}

int USER::CheckMemoryAccountBankDB(char *strAccount)
{
	CSharedMemory*	pSharedMemory;
	CMemUser*		pMD;
	int				mem_index = -1;
	int				nCount = 0;
	CString			str;

	SYSTEMTIME time;
	GetLocalTime(&time);

	for( int i = 0; i < MAX_USER; i++ )
	{
		pSharedMemory = NULL;
		pMD = NULL;

		pSharedMemory = g_arSharedMemory[i];
		if(!pSharedMemory) continue;

		pMD = (CMemUser*)pSharedMemory->m_lpData;
		if(!pMD) continue;

		if(pMD->m_uid == -1 || pMD->m_sSTR == 0) continue;		// Á¤¸®°¡ µÈ À¯Àú´Â ´Ù½Ã ÀúÀåÇÏÁö ¾Ê´Â´Ù.
		if(pMD->m_strUserID[0] == 0) continue;

		if( _stricmp( pMD->m_strAccount, strAccount ) == 0 )
		{
			nCount++;
			// ÆÄÀÏ¿¡ ¾´´Ù
			if(nCount >= 1)
			{
				GetLocalTime(&time);
				str.Format("(%04d-%02d-%02d %02d:%02d:%02d)\tuid-%d str-%d ubuid-%d count-%d id-%s (AccountBank)\r\n",
					time.wYear, time.wMonth, time.wDay, time.wHour, time.wMinute, time.wSecond,
					pMD->m_uid, pMD->m_sSTR, pMD->m_AB.m_uid, nCount, pMD->m_strAccount );
				
				// IKING 2002.1.
				EnterCriticalSection( &m_CS_FileWrite );
				g_fpBackServer.Write( str, str.GetLength() );
				LeaveCriticalSection( &m_CS_FileWrite );
			}

//			if( !Mem2GameAccountBank(pMD) )			// Shared Memory -> Game º¯¼ö·Î
//			{
//				nCount--;
//			}

			UpdateMem2DB(pMD);		// ¾ÈÀüÀ» À§ÇØ¼­ DB¿¡µµ ÀúÀåÀ»
			UpdateBankMem2DB(pMD);
			UpdateAccountBankMem2DB(pMD);

			pMD->m_uid = -1;
			pMD->m_sSTR = 0;			
			pMD->m_UB.m_uid = -1;
			pMD->m_AB.m_uid = -1;
			pMD->m_dwSaveTime = 0;
			::ZeroMemory(pMD->m_strUserID, sizeof(pMD->m_strUserID));
			::ZeroMemory(pMD->m_strAccount, sizeof(pMD->m_strAccount));
		}
	}

	return nCount;
}

BOOL USER::Mem2GameAccountBank(CMemUser *pMD)
{
	if(IsBadReadPtr((CONST VOID*)pMD, sizeof(CMemUser))) return FALSE;

	// Account Bank -----------------------------
	StrToAccountBankItem((LPTSTR)pMD->m_AB.m_AccountBankItem);
	m_dwAccountBankDN = pMD->m_AB.m_dwBankDN;

	return TRUE;
}

BOOL USER::GiveMagicItem(int sid, int iCount)
{
	int tMagic[12]={36,81,141,33,76,132,97,102,100,130,79,139};
	if( sid < 0 || sid >= g_arItemTable.GetSize() ) return FALSE;
	if( iCount <= 0 ) return FALSE;

	ItemList GiveItem;
	ReSetItemSlot( &GiveItem );
	if(sid==809||sid==811||sid==812||sid==810){ //ÔÂÉñÌ××° 50Ñª10·À »Ø±ÜÂÊ6£¥ 5·À
		int iRandom1 =(myrand(0,15)%12);
		int iRandom2 =(myrand(0,15)%12);
		CWordArray		arEmptySlot, arSameSlot;
		int iSlot = GetEmptySlot( INVENTORY_SLOT );
		
		if( iSlot < 0 ) return FALSE;

		ReSetItemSlot( &m_UserItem[iSlot]);

		m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
		m_UserItem[iSlot].sSid = sid;
		m_UserItem[iSlot].sCount = iCount;
		m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
		m_UserItem[iSlot].sBullNum = 3;
		m_UserItem[iSlot].tMagic[0] = tMagic[iRandom1];
		m_UserItem[iSlot].tMagic[1] = tMagic[iRandom2];
		m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		m_UserItem[iSlot].iItemSerial = 0;

		MakeItemLog( &m_UserItem[iSlot], ITEMLOG_EVENT_GIVE );

		arEmptySlot.Add(iSlot); 
		UpdateInvenSlot(&arEmptySlot, &arSameSlot);
		return true;
	}
	if( g_arItemTable[sid]->m_bySpecial == 0 ) return FALSE;		// º¹»çÇØÁÙ ¸ÅÁ÷ ¼Ó¼ºÀÌ ¾ø´Ù

	GiveItem.sLevel			= g_arItemTable[sid]->m_byRLevel;
	GiveItem.sSid			= sid;
	GiveItem.sCount			= iCount;
	GiveItem.sDuration		= g_arItemTable[sid]->m_sDuration;
	GiveItem.sBullNum		= g_arItemTable[sid]->m_sBullNum;
	GiveItem.tMagic[0]		= g_arItemTable[sid]->m_bySpecial;
	GiveItem.tIQ			= MAGIC_ITEM;

	CWordArray		arEmptySlot, arSameSlot;

	int iSlot = GetSameItem( GiveItem, INVENTORY_SLOT);

	if(iSlot != -1)	
	{ 
		if(iCount != 0)
		{
			CheckMaxValue((short &)m_UserItem[iSlot].sCount, (short)iCount); 
			arSameSlot.Add(iSlot); 
		}
//		return FALSE;		// ¸ÅÁ÷ ¾ÆÀÌÅÛÀº °ãÄ¡±â°¡ ¾ÈµÇ´Â °ÍÀ¸·Î ÆÇ´ÜÇÑ´Ù
	}
	else			
	{
		iSlot = GetEmptySlot( INVENTORY_SLOT );

		if( iSlot < 0 ) return FALSE;

		ReSetItemSlot( &m_UserItem[iSlot] );

		m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
		m_UserItem[iSlot].sSid = sid;
		m_UserItem[iSlot].sCount = iCount;
		m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
		m_UserItem[iSlot].sBullNum = g_arItemTable[sid]->m_sBullNum;
		m_UserItem[iSlot].tMagic[0] = g_arItemTable[sid]->m_bySpecial;
		m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		m_UserItem[iSlot].iItemSerial = 0;

		MakeItemLog( &m_UserItem[iSlot], ITEMLOG_EVENT_GIVE );

		arEmptySlot.Add(iSlot); 
	}			

	UpdateInvenSlot(&arEmptySlot, &arSameSlot);

//	GetMagicItemSetting();		// ´ÜÁö ¸ÅÁ÷ ¾ÆÀÌÅÛÀ» ÁÖ´Â °Í ¸¸À¸·Î´Â ¸ÅÁ÷ ¿É¼ÇÀÌ ¾È¹Ù²ï´Ù : jjs07
/*
	int iSlot = GetEmptySlot(INVENTORY_SLOT);

	if(iSlot < 0) return FALSE;

	ReSetItemSlot(&m_UserItem[iSlot]);

	m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
	m_UserItem[iSlot].sSid = sid;
	m_UserItem[iSlot].sCount = iCount;
	m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
	m_UserItem[iSlot].sBullNum = g_arItemTable[sid]->m_sBullNum;
	m_UserItem[iSlot].tIQ = NORMAL_ITEM;
*/

	FlushItemLog( TRUE );

	return TRUE;
}

void USER::EventItemSerialWindowOpen()
{
	CBufferEx TempBuf;
	
	TempBuf.Add(PRE_REG_USER_EVENT_REQ);

	Send(TempBuf, TempBuf.GetLength());
}

void USER::RecvEventItemSerial(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	int j;
	int iSlot = 0;
	int iRet = 0;
	int index = 0;
	int iEventItemSid = 0, iEvent = 0;

	TCHAR strSerial[30];	::ZeroMemory(strSerial,	sizeof(strSerial));
	
	iSlot = GetEmptySlot(INVENTORY_SLOT);

	CString strMsg;

	if(iSlot <= -1)
	{
		strMsg.Format( IDS_USER_NEED_EMPTY_SLOT_CHANGE );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;		// ÀÎº¥ÀÌ ºñ¾î ÀÖ´ÂÁö È®ÀÎÇÑ´Ù.
	}

	if(!GetVarString(sizeof(strSerial), strSerial, pBuf, index)) return;

	iRet = UpdateEventItemSerial(strSerial, iEventItemSid);

	if(iRet < 0)
	{
		// DB¿Í ¿¬°áÀÌ ÁÁÁö ¾Ê½À´Ï´Ù.
		strMsg.Format( IDS_USER_UNSTABLE_CONNECTION );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}
	else if(iRet == 1)
	{
		if(iEventItemSid == 0)
		{
			strMsg.Format( IDS_USER_EVENT_COMMON_CURE );

			m_UserItem[iSlot].tType = TYPE_ITEM;
			m_UserItem[iSlot].sLevel = g_arItemTable[NPC_EVENT_B_ITEM]->m_byRLevel;
			m_UserItem[iSlot].sSid = g_arItemTable[NPC_EVENT_B_ITEM]->m_sSid;
			m_UserItem[iSlot].sCount = 1000;
			m_UserItem[iSlot].sDuration = g_arItemTable[NPC_EVENT_B_ITEM]->m_sDuration;
			m_UserItem[iSlot].sBullNum = g_arItemTable[NPC_EVENT_B_ITEM]->m_sBullNum;
			m_UserItem[iSlot].tIQ = 0;
			m_UserItem[iSlot].iItemSerial = 0;

			for(j = 0; j < MAGIC_NUM; j++)
			{
				m_UserItem[iSlot].tMagic[j] = 0;
			}

			CBufferEx TempBuf;

			TempBuf.Add(ITEM_LOAD_RESULT);
			TempBuf.Add(SUCCESS);
			TempBuf.Add((BYTE)0x01);

			TempBuf.Add((BYTE)iSlot);
			TempBuf.Add(m_UserItem[iSlot].sLevel);
			TempBuf.Add(m_UserItem[iSlot].sSid);
			TempBuf.Add(m_UserItem[iSlot].sDuration);
			TempBuf.Add(m_UserItem[iSlot].sBullNum);
			TempBuf.Add(m_UserItem[iSlot].sCount);
			for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add((BYTE)m_UserItem[iSlot].tMagic[j]);

			TempBuf.Add((BYTE)m_UserItem[iSlot].tIQ);

			Send(TempBuf, TempBuf.GetLength());
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

			m_iCurWeight += g_arItemTable[NPC_EVENT_B_ITEM]->m_byWeight * 1000;
			GetRecoverySpeed();			// ¾ÆÀÌÅÛ ¹«°Ô¿¡ º¯µ¿ÀÌ »ý±â¸é È¸º¹¼Óµµ º¯È¯
			return;
		}
		else if(iEventItemSid > 100 && iEventItemSid <= 255)
		{
			switch(iEventItemSid)
			{
			case EVENT_ATT7_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_ATT7_CHANGE );
				break;
			case EVENT_DEF7_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_DEF7_CHANGE );
				break;
			case EVENT_ATT6_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_ATT6_CHANGE );
				break;
			case EVENT_DEF6_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_DEF6_CHANGE );
				break;
			case EVENT_ATT_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_ATT5_CHANGE );
				break;
			case EVENT_DEF_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_DEF5_CHANGE );
				break;
			case EVENT_INIT_STAT_ITEM:
				iEvent = NPC_EVENT_INIT_STAT; 
				strMsg.Format( IDS_USER_EVENT_RESET_STAT );
				break;
			default:
				return;
				break;
			}

			m_UserItem[iSlot].tType = TYPE_ITEM;
			m_UserItem[iSlot].sLevel = g_arItemTable[iEvent]->m_byRLevel;
			m_UserItem[iSlot].sSid = g_arItemTable[iEvent]->m_sSid;
			m_UserItem[iSlot].sCount = 1;
			m_UserItem[iSlot].sDuration = g_arItemTable[iEvent]->m_sDuration;
			m_UserItem[iSlot].sBullNum = g_arItemTable[iEvent]->m_sBullNum;
			m_UserItem[iSlot].tIQ = (BYTE)iEventItemSid;

			for(j = 0; j < MAGIC_NUM; j++)
			{
				m_UserItem[iSlot].tMagic[j] = 0;
			}

			CBufferEx TempBuf;

			TempBuf.Add(ITEM_LOAD_RESULT);
			TempBuf.Add(SUCCESS);
			TempBuf.Add((BYTE)0x01);

			TempBuf.Add((BYTE)iSlot);
			TempBuf.Add(m_UserItem[iSlot].sLevel);
			TempBuf.Add(m_UserItem[iSlot].sSid);
			TempBuf.Add(m_UserItem[iSlot].sDuration);
			TempBuf.Add(m_UserItem[iSlot].sBullNum);
			TempBuf.Add(m_UserItem[iSlot].sCount);
			for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add((BYTE)m_UserItem[iSlot].tMagic[j]);

			TempBuf.Add((BYTE)m_UserItem[iSlot].tIQ);

			Send(TempBuf, TempBuf.GetLength());
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

			m_iCurWeight += g_arItemTable[iEvent]->m_byWeight;
			GetRecoverySpeed();			// ¾ÆÀÌÅÛ ¹«°Ô¿¡ º¯µ¿ÀÌ »ý±â¸é È¸º¹¼Óµµ º¯È¯

			return;
		}
	}
	else	// ½Ã¸®¾óÀÌ Æ²¸®°Å³ª µî·Ï¿¡ ¾ø´Â À¯Àú°Å³ª DB¿¡ º¯µ¿ÀÌ ¾øÀ» °æ¿ì
	{
		if(iRet == 10)
		{
			strMsg.Format( IDS_USER_CHECK_INPUT_NUMBER );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
		else if(iRet == 11)
		{
			strMsg.Format( IDS_USER_NOT_SUBSCRIPTION );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
		else if(iRet == 12)
		{
			strMsg.Format( IDS_USER_ONE_MORE_APPLY );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
		else if(iRet == 13)
		{
			strMsg.Format( IDS_USER_ALREADY_LOTTO );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
		else if(iRet == 14)
		{
			strMsg.Format( IDS_USER_CANCEL_LOTTO );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
	}
}

int USER::UpdateEventItemSerial(TCHAR *pstrSerial, int &item)
{
	short sItemType = 0;

	SQLHSTMT	hstmt = NULL;
	SQLRETURN	retcode;
	TCHAR		szSQL[8000];	::ZeroMemory(szSQL, sizeof(szSQL));

	SWORD	sParam1 = 0;
	SDWORD	cbParam1 = SQL_NTS, cbParam2 = SQL_NTS;

	memset(szSQL, 0x00, 1024);
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_PRE_USER_EVENT (\'%s\', \'%s\', \'%s\',\'%s\',?,?)}"), 
		m_strAccount, pstrSerial, g_arServerIPAddr, m_strUserID, sParam1, sItemType);

	hstmt = NULL;
	retcode = 0;

	int db_index = -1;
	CDatabase* pDB = g_DBSession[m_iModSid].GetDB( db_index );
	if( !pDB ) 
	{
		return -1;
	}
	
	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode!=SQL_SUCCESS)
	{
		return -1;
	}
	
	if( retcode != SQL_SUCCESS )
	{
		SQLFreeHandle((SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		return -1;
	}

	retcode = SQLBindParameter(hstmt, 1,SQL_PARAM_OUTPUT, SQL_C_SSHORT, SQL_SMALLINT,0,0,&sParam1,0,&cbParam1);
	retcode = SQLBindParameter(hstmt, 2,SQL_PARAM_OUTPUT, SQL_C_SSHORT, SQL_SMALLINT,0,0,&sItemType,0,&cbParam2);

    retcode = SQLExecDirect (hstmt, (unsigned char *)(LPCTSTR)szSQL, SQL_NTS);
	if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
	{
	}
	else if (retcode==SQL_ERROR)
	{
//		DisplayErrorMsg(hstmt);
	}
	else if (retcode==SQL_NO_DATA)
	{
	}
	
	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBSession[m_iModSid].ReleaseDB(db_index);

	item = (int)sItemType;
	return sParam1;
}


void USER::EventItemSerialForGameRoomWindowOpen()
{
	CBufferEx TempBuf;
	
	TempBuf.Add(PRE_REG_GAMEROOM_EVENT_REQ);

	Send(TempBuf, TempBuf.GetLength());
}

int USER::UpdateEventItemSerialForGameRoom(TCHAR *pstrSerial, TCHAR *pstrSocNum, int &item)
{
	short sItemType = 0;

	SQLHSTMT	hstmt = NULL;
	SQLRETURN	retcode;
	TCHAR		szSQL[8000];	::ZeroMemory(szSQL, sizeof(szSQL));

	SWORD	sParam1 = 0;
	SDWORD	cbParam1 = SQL_NTS, cbParam2 = SQL_NTS;

	memset(szSQL, 0x00, 1024);
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_PRE_GAMEROOM_EVENT (\'%s\', \'%s\', \'%s\', \'%s\',\'%s\',?,?)}"), 
		pstrSocNum, m_strAccount, pstrSerial, g_arServerIPAddr, m_strUserID, sParam1, sItemType);

	hstmt = NULL;
	retcode = 0;

	int db_index = -1;
	CDatabase* pDB = g_DBSession[m_iModSid].GetDB( db_index );
	if( !pDB ) 
	{
		return -1;
	}
	
	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode!=SQL_SUCCESS)
	{
		return -1;
	}
	
	if( retcode != SQL_SUCCESS )
	{
		SQLFreeHandle((SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		return -1;
	}

	retcode = SQLBindParameter(hstmt, 1,SQL_PARAM_OUTPUT, SQL_C_SSHORT, SQL_SMALLINT,0,0,&sParam1,0,&cbParam1);
	retcode = SQLBindParameter(hstmt, 2,SQL_PARAM_OUTPUT, SQL_C_SSHORT, SQL_SMALLINT,0,0,&sItemType,0,&cbParam2);

    retcode = SQLExecDirect (hstmt, (unsigned char *)(LPCTSTR)szSQL, SQL_NTS);
	if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
	{
	}
	else if (retcode==SQL_ERROR)
	{
//		DisplayErrorMsg(hstmt);
	}
	else if (retcode==SQL_NO_DATA)
	{
	}
	
	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBSession[m_iModSid].ReleaseDB(db_index);

	item = (int)sItemType;
	return sParam1;
}

void USER::RecvEventItemSerialForGameRoom(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	int j;
	int iSlot = 0;
	int iRet = 0;
	int index = 0;
	int iEventItemSid = 0, iEvent = 0;

	TCHAR strSerial[30];		::ZeroMemory(strSerial,	sizeof(strSerial));
	TCHAR strSocNum[30];		::ZeroMemory(strSocNum,	sizeof(strSocNum));
	
	iSlot = GetEmptySlot(INVENTORY_SLOT);

	CString strMsg;

	if(iSlot <= -1)
	{
		strMsg.Format( IDS_USER_NEED_EMPTY_SLOT_CHANGE );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;		
	}
	
	if((m_iMaxWeight + m_iMaxWeight) < m_iCurWeight) // ÇöÀç ¹«°Ô°¡ ÃÖ´ë ¹«°ÔÀÇ 2¹èÀÌ»óÀÌ¸é...
	{
		strMsg.Format( IDS_USER_OVER_WEIGHT2 );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;		// ÀÎº¥ÀÌ ºñ¾î ÀÖ´ÂÁö È®ÀÎÇÑ´Ù.
	}

	if(!GetVarString(sizeof(strSerial),	strSerial, pBuf, index))
	{
		strMsg.Format(IDS_USER_CHECK_INPUT_NUMBER);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}
	if(!GetVarString(sizeof(strSocNum), strSocNum,	pBuf, index))
	{
		strMsg.Format(IDS_USER_CHECK_INPUT_NUMBER);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}

	iRet = UpdateEventItemSerialForGameRoom(strSerial, strSocNum, iEventItemSid);

	if(iRet < 0)
	{
		// DB¿Í ¿¬°áÀÌ ÁÁÁö ¾Ê½À´Ï´Ù.
		strMsg.Format( IDS_USER_UNSTABLE_CONNECTION );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}
	else if(iRet == 1)
	{
		if(iEventItemSid == 0)
		{
			strMsg.Format( IDS_USER_EVENT_COMMON_CURE );

			m_UserItem[iSlot].tType = TYPE_ITEM;
			m_UserItem[iSlot].sLevel = g_arItemTable[NPC_EVENT_B_ITEM]->m_byRLevel;
			m_UserItem[iSlot].sSid = g_arItemTable[NPC_EVENT_B_ITEM]->m_sSid;
			m_UserItem[iSlot].sCount = 1000;
			m_UserItem[iSlot].sDuration = g_arItemTable[NPC_EVENT_B_ITEM]->m_sDuration;
			m_UserItem[iSlot].sBullNum = g_arItemTable[NPC_EVENT_B_ITEM]->m_sBullNum;
			m_UserItem[iSlot].tIQ = 0;

			for(j = 0; j < MAGIC_NUM; j++)
			{
				m_UserItem[iSlot].tMagic[j] = 0;
			}

			CBufferEx TempBuf;

			TempBuf.Add(ITEM_LOAD_RESULT);
			TempBuf.Add(SUCCESS);
			TempBuf.Add((BYTE)0x01);

			TempBuf.Add((BYTE)iSlot);
			TempBuf.Add(m_UserItem[iSlot].sLevel);
			TempBuf.Add(m_UserItem[iSlot].sSid);
			TempBuf.Add(m_UserItem[iSlot].sDuration);
			TempBuf.Add(m_UserItem[iSlot].sBullNum);
			TempBuf.Add(m_UserItem[iSlot].sCount);
			for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add((BYTE)m_UserItem[iSlot].tMagic[j]);

			TempBuf.Add((BYTE)m_UserItem[iSlot].tIQ);

			Send(TempBuf, TempBuf.GetLength());
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

			m_iCurWeight += g_arItemTable[NPC_EVENT_B_ITEM]->m_byWeight * 1000;
			GetRecoverySpeed();			// ¾ÆÀÌÅÛ ¹«°Ô¿¡ º¯µ¿ÀÌ »ý±â¸é È¸º¹¼Óµµ º¯È¯
			return;
		}
		else if(iEventItemSid > 100 && iEventItemSid <= 255)
		{
			switch(iEventItemSid)
			{
			case EVENT_ATT7_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_ATT7_CHANGE );
				break;
			case EVENT_DEF7_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_DEF7_CHANGE );
				break;
			case EVENT_ATT6_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_ATT6_CHANGE );
				break;
			case EVENT_DEF6_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_DEF6_CHANGE );
				break;
			case EVENT_ATT_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_ATT5_CHANGE );
				break;
			case EVENT_DEF_ITEM:
				iEvent = NPC_EVENT_ITEM; 
				strMsg.Format( IDS_USER_EVENT_DEF5_CHANGE );
				break;
			case EVENT_INIT_STAT_ITEM:
				iEvent = NPC_EVENT_INIT_STAT; 
				strMsg.Format( IDS_USER_EVENT_RESET_STAT );
				break;
			default:
				return;
				break;
			}

			m_UserItem[iSlot].tType = TYPE_ITEM;
			m_UserItem[iSlot].sLevel = g_arItemTable[iEvent]->m_byRLevel;
			m_UserItem[iSlot].sSid = g_arItemTable[iEvent]->m_sSid;
			m_UserItem[iSlot].sCount = 1;
			m_UserItem[iSlot].sDuration = g_arItemTable[iEvent]->m_sDuration;
			m_UserItem[iSlot].sBullNum = g_arItemTable[iEvent]->m_sBullNum;
			m_UserItem[iSlot].tIQ = (BYTE)iEventItemSid;

			for(j = 0; j < MAGIC_NUM; j++)
			{
				m_UserItem[iSlot].tMagic[j] = 0;
			}

			CBufferEx TempBuf;

			TempBuf.Add(ITEM_LOAD_RESULT);
			TempBuf.Add(SUCCESS);
			TempBuf.Add((BYTE)0x01);

			TempBuf.Add((BYTE)iSlot);
			TempBuf.Add(m_UserItem[iSlot].sLevel);
			TempBuf.Add(m_UserItem[iSlot].sSid);
			TempBuf.Add(m_UserItem[iSlot].sDuration);
			TempBuf.Add(m_UserItem[iSlot].sBullNum);
			TempBuf.Add(m_UserItem[iSlot].sCount);
			for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add((BYTE)m_UserItem[iSlot].tMagic[j]);

			TempBuf.Add((BYTE)m_UserItem[iSlot].tIQ);

			Send(TempBuf, TempBuf.GetLength());
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

			m_iCurWeight += g_arItemTable[iEvent]->m_byWeight;
			GetRecoverySpeed();			// ¾ÆÀÌÅÛ ¹«°Ô¿¡ º¯µ¿ÀÌ »ý±â¸é È¸º¹¼Óµµ º¯È¯

			return;
		}
	}
	else	// ½Ã¸®¾óÀÌ Æ²¸®°Å³ª µî·Ï¿¡ ¾ø´Â À¯Àú°Å³ª DB¿¡ º¯µ¿ÀÌ ¾øÀ» °æ¿ì
	{
		if(iRet == 10)
		{
			strMsg.Format( IDS_USER_CHECK_LOTTO_NUMBER );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
		else if(iRet == 11)
		{
			strMsg.Format( IDS_USER_CHECK_SOCIAL_NUMBER );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
		else if(iRet == 12)
		{
			strMsg.Format( IDS_USER_ONE_MORE_APPLY );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
		else if(iRet == 13)
		{
			strMsg.Format( IDS_USER_ALREADY_LOTTO );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
	}
}
////////////////////////////////////////////////////////////////////////////////
//
// À¯Àú ·¹º§ÀÌ ¹«·á Ã¼Çè ±â°£ÀÌ ³Ñ¾ú´ÂÁö Ã¼Å©ÇÑ´Ù.
BOOL USER::CheckUserLevel()
{
//	if(m_iDisplayType == 6 && m_sLevel > 25)//yskang 0.5
	if(m_iDisplayType == 6)
	{			
		
		CString strMsg = _T("");
		strMsg.Format("TEST À¯Àú´ÔÀÌ Á¢¼ÓÇÏ½Å Ã¼ÇèÆÇ ¼­¹ö½º´Â ±â´É»ó Á¦¾àÀÌ ÀÖ½À´Ï´Ù.");
//		SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_NORMAL, TO_ME);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE, TO_ME);

	}

	return FALSE;
}

void USER::GiveEventGameTime(int item_index, int quality)
{
	int sid = item_index;
	int num = 1;

	int i, j;
	int iSlot = -1;

	CBufferEx TempBuf;
	BYTE result = SUCCESS;

	if(sid < 0 || sid >= g_arItemTable.GetSize()) return;

	ItemList	TempItem;
	ReSetItemSlot(&TempItem);

	TempItem.sSid		= g_arItemTable[sid]->m_sSid;
	TempItem.sBullNum	= g_arItemTable[sid]->m_sBullNum;
	TempItem.sDuration	= g_arItemTable[sid]->m_sDuration;

	for(i =0; i < MAGIC_NUM; i++) TempItem.tMagic[i] = 0;
	TempItem.tIQ = quality;
	
	for(i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + INVENTORY_NUM; i++)
	{
		if(m_UserItem[i].sSid == TempItem.sSid)
		{
//			for(j = 0; j < MAGIC_NUM; j++)
//			{
//				if(m_UserItem[i].tMagic[j] != TempItem.tMagic[j]) break;
//			}
				
			if(m_UserItem[i].tIQ == TempItem.tIQ) { iSlot = i; break; } 
		}
	}

	CString strMsg = _T("");

	if(iSlot == -1)
	{
		strMsg.Format( IDS_USER_FAIL_CHECK_INVEN );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}

	if(m_UserItem[iSlot].sSid < 0)
	{
		strMsg.Format( IDS_USER_FAIL_CHECK_INVEN );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}

	if(m_UserItem[iSlot].sCount < num)		
	{
		strMsg.Format( IDS_USER_FAIL_CHECK_INVEN );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}

	int nRet = 0;
	CString strSerial = _T("");
	strSerial.Format("%d-%d-%d-%d-%d-%d", m_UserItem[iSlot].tMagic[0],m_UserItem[iSlot].tMagic[1],m_UserItem[iSlot].tMagic[2],m_UserItem[iSlot].tMagic[3],m_UserItem[iSlot].tMagic[4],m_UserItem[iSlot].tMagic[5]);

	nRet = UpdateGameTimeForEvent((LPTSTR)(LPCTSTR)strSerial);

	if(nRet != 1)
	{
		if(nRet == 2)
		{
			strMsg.Format( IDS_USER_ONE_MORE_APPLY );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
			return;
		}
		else if(nRet == 3)
		{
			strMsg.Format( IDS_USER_ALREADY_REG_NUMBER );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
			return;
		}
		else
		{
			strMsg.Format( IDS_USER_FAIL_CHECK_INVEN );
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
			return;
		}
	}

	if((m_UserItem[iSlot].sCount - num) <= 0)				// ´ÙÀ½ ³» ÀÎº¥¸¦ »© ÁØ´Ù.		
	{														// Äü¾ÆÀÌÅÛ º¯È­°¡ ÀÖÀ¸¸é		
//		if(g_arItemTable[iSlot]->m_byWear >= 6) bQuickChange = TRUE;

		ReSetItemSlot(&m_UserItem[iSlot]);
	}
	else m_UserItem[iSlot].sCount -= num;

	int iWeight = num * g_arItemTable[iSlot]->m_byWeight;

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();			// ´Ù½Ã È¸º¹¼Óµµ¸¦ °è»ê

	TempBuf.Add(ITEM_GIVE_RESULT);
	TempBuf.Add(result);
	TempBuf.Add((BYTE)iSlot);
	TempBuf.Add(m_UserItem[iSlot].sLevel);
	TempBuf.Add(m_UserItem[iSlot].sSid);
	TempBuf.Add(m_UserItem[iSlot].sDuration);
	TempBuf.Add(m_UserItem[iSlot].sBullNum);
	TempBuf.Add(m_UserItem[iSlot].sCount);
	for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[iSlot].tMagic[j]);

	TempBuf.Add(m_UserItem[iSlot].tIQ);

	Send(TempBuf, TempBuf.GetLength());

	strMsg.Format( IDS_USER_YOUR_ACCOUNT_REG, m_strAccount);
	SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
}

//////////////////////////////////////////////////////////////////////
//
//	ÀÌº¥Æ®¿¡¼­ °³ÀÎ Á¤¾×±Ç »óÇ°±ÇÀ» È¸¼öÇÑ´Ù.
//
int USER::UpdateGameTimeForEvent(TCHAR *pstrSerial)
{
	SQLHSTMT	hstmt = NULL;
	SQLRETURN	retcode;
	TCHAR		szSQL[8000];	::ZeroMemory(szSQL, sizeof(szSQL));

	SWORD	sParam1 = 0;
	SDWORD	cbParam1 = SQL_NTS;

	memset(szSQL, 0x00, 1024);
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_EVENT_GAMETIME_USER(\'%s\', \'%s\', \'%s\', \'%s\',?)}"), 
		m_strAccount, pstrSerial, g_arServerIPAddr, m_strUserID, sParam1);
 
	hstmt = NULL;
	retcode = 0;

	int db_index = -1;
	CDatabase* pDB = g_DBSession[m_iModSid].GetDB( db_index );
	if( !pDB ) 
	{
		return -1;
	}
	
	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode!=SQL_SUCCESS)
	{
		return -1;
	}
	
	if( retcode != SQL_SUCCESS )
	{
		SQLFreeHandle((SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		return -1;
	}

	retcode = SQLBindParameter(hstmt, 1,SQL_PARAM_OUTPUT, SQL_C_SSHORT, SQL_SMALLINT,0,0,&sParam1,0,&cbParam1);

    retcode = SQLExecDirect (hstmt, (unsigned char *)(LPCTSTR)szSQL, SQL_NTS);
	if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
	{
	}
	else if (retcode==SQL_ERROR)
	{
//		DisplayErrorMsg(hstmt);
	}
	else if (retcode==SQL_NO_DATA)
	{
	}
	
	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBSession[m_iModSid].ReleaseDB(db_index);

	return sParam1;
}
/*
Ò°»ð¼ÓÈë 
¹¦ÄÜ ÏÔÊ¾¹¥»÷ÊýÖµ
0 ren\
1 ¹Ö
*/
void USER::SendDamageNum(BYTE type,short nTarget, short dDamage)
{
	CBufferEx TempBufnum;
	TempBufnum.Add(DH_DAMAGE_NUM);
	TempBufnum.Add((BYTE)1);
	TempBufnum.Add((short)nTarget);
	TempBufnum.Add((BYTE)type);
	TempBufnum.Add((short)dDamage);				
	SendInsight(TempBufnum, TempBufnum.GetLength());
}
/*
Ò°»ð¼ÓÈë
¹¦ÄÜ ÉèÖÃ¹ÖÎïÑªÌõ
*/
void USER::SendNpcHP(int nTarget,int npchp)
{
	CBufferEx TempBufnum;
	TempBufnum.Add(M_SET_HP);		
	TempBufnum.Add((DWORD)nTarget);		
	TempBufnum.Add((DWORD)npchp);				
	SendInsight(TempBufnum, TempBufnum.GetLength());
}

void USER::SendSystemMsg(UINT strID, BYTE type, int nWho)
{
	CBufferEx TempBuf;

	char pMsg[1280];	memset( pMsg, NULL, 1280 );
	strcpy( pMsg, _ID( strID ) );

	TempBuf.Add(SYSTEM_MSG);
	TempBuf.Add(type);
	TempBuf.Add(pMsg, _tcslen(pMsg));

	switch(nWho)
	{
	case TO_ALL:
		SendAll(TempBuf, TempBuf.GetLength());
		break;

	case TO_ME:
		Send(TempBuf, TempBuf.GetLength());
		break;

	case TO_ZONE:
		SendZone(TempBuf, TempBuf.GetLength());
		break;

	case TO_INSIGHT:
	default:
		SendInsight(TempBuf, TempBuf.GetLength());
		break;

	}
}

////////////////////////////////////////////////////////////////////////////////
//	¾ÆÀÌÅÛ Æ¯¼ºÀ» ¹Ù²Ù´Â ÀÎÅÍÆäÀÌ½º È°¼ºÈ­
//
void USER::UpgradeItemOpen(int event_num)
{
	CBufferEx TempBuf;
	//static int a=0;

	TempBuf.Add(UPGRADE_ITEM_DIALOG);
	TempBuf.Add(BYTE(event_num));
	//TempBuf.Add(BYTE(a));
	//a++;
	Send(TempBuf, TempBuf.GetLength());
}

void USER::UpgradeItemReqBegin(TCHAR *pBuf)
{
	int index = 0;

	BYTE tType = GetByte(pBuf, index);	// ¾÷±×·¹ÀÌµå Å¸ÀÔ
	m_bNoItemMove = TRUE;
	switch(tType)
	{
	case 0:				// ÆÕÍ¨Éý¼¶
		UpgradeItemReq(pBuf + index);
		break;
	case 1:				////Ê×ÊÎºÏ³É
		UpgradeAccessoriReq(pBuf + index);
		break;

	case 2: case 3: case 12: case 9: case 49:// 2 ³¬¼¶ÁéÊ¯ ³¬¼¶ÁéÊ¯  3ÁéÊ¯¾§Ê¯  12 ÐäÕäÊ¯Í·Éý¼¶ 9×£¸£±¦Ê¯  49ÍõÕßÊ¯Í·
		UpgradeBlessingItemReq(pBuf + index, tType); 
		break;

	case 4:				// 1´Ü°³Á¶, 2´Ü°³Á¶, 3´Ü°³Á¶
		RemodelingItemReq(pBuf + index);
		break;

	case 5:				//Ä§·¨Ê¥×°
		RemagicItemReq(pBuf + index);
		break;

	case 6:				// ¸®¸ÅÁ÷ (Áßº¹¿É¼Ç Çã¿ëÇÔ)
		RemagicItemReq(pBuf + index, TRUE);
		break;

	case 7:				//Ç¿»¯»úÐµ 
		EBodyUpgradeReq(pBuf + index);
		break;
	case 8: //ÊØ»¤Éý¼¶.
		ShouHouUpgradeReq(pBuf + index);
		break;
	case 11:
		DownAccessoriReq(pBuf + index);
		break;
	case 13://»úÐµ»¹Ô­±¦Öé
		{
			EbodyReset(pBuf + index);
			break;
		}
	case 14://ÖÆ×÷½ø»¯Ð¾Æ¬.
		ShouHouMake(pBuf + index);
		break;
	case 15:
		ShouHouAdd(pBuf + index);
		break;
	case 16://°Ù¼¶×ª»»
		ItemConvert(pBuf + index);
		break;
	case 17://½â³ýÊôÐÔÏÞÖÆ
		RemagicItem_100_3(pBuf + index);
		break;
	case 18:
		RemagicItem_UpgradeReq(pBuf + index);//Ìí¼ÓÊôÐÔ
		break;
	case 19:
		RemagicItem1_UpgradeReq(pBuf + index);//±ä¸üÊôÐÔ
		break;
	case 20:
		RemagicItem_HuanShi(pBuf + index);
		break;
	case 21: //·À¾ß²ÄÁÏ»¯
		RemagicItem_100_1(pBuf + index);
		break;
	case 22://½â³ý·À¾ß²ÄÁÏ»¯
		RemagicItem_100_2(pBuf + index);
		break;
	case 50://xiaoke
		DUBOxitong(pBuf + index);
		break;

	case 32://xiaoke
		DELSX(pBuf + index);
		break;
	case 27: //»ú¼×¿ØÖÆÏµÍ³ÖÆ×÷Ê¹ÓÃÉè¼ÆÍ¼
		HeChengJJ(pBuf + index);
		break;
	case 28://¿ØÖÆÏµÍ³Éý¼¶
		SuitUpgrade(pBuf + index);
		break;
	case 29://°²×°³ÌÐò¿¨		
		ChengXuKa(pBuf + index);
		break;
	case 30://¸½¼þ		
		JjPeiJian(pBuf + index);
		break;
	case 25:case 31: //»Æ½ðÊ¯Í·31
		UpgradeHJItemReq(pBuf + index);
		break;
	case 34://»úÐµÉíÌå²ÄÁÏ»¯0x22 0x0a 0x00
		{
			short sMetrial = GetShort(pBuf,index);
			EbodyMatrial(sMetrial);
			break;
		}
	case 35://»úÐµÉíÌå½â³ý²ÄÁÏ»¯
		{
			short sMetrial = GetShort(pBuf,index);

			EbodyCancelMetral(sMetrial);
			break;
		}
	case 36://»úÐµÉíÌåºÏ³É 0x24 0x1f 0x00 0x11 0x00 0x0a 0x00 0xff 0xff 0xff 0xff 
		{
			short sMaster = GetShort(pBuf,index);
			short sMetrial1 = GetShort(pBuf,index);
			short sMetrial2 = GetShort(pBuf,index);
			EbodyConvertSuperEbody(sMaster,sMetrial1,sMetrial2);
			break;
		}
	case 37: //ÎïÆ·ºÏ³É  5¾§ÁéÊ¯ºÏ³ÉÒ»¸ö³¬¾§Áé  ·ÑÓÃ10W  2»úÐµºÏ³ÉÒ»¸öï¯Ê¯,·ÑÓÃ200W  2ï¯Ê¯ºÏ³ÉÒ»¸öÑ©»ê·ÑÓÃ100
		ItemExchange(pBuf + index);
		break;
/*	case 49://ÍõÕßÁéÊ¯ Ä§·¨ÎäÆ÷Ç°6¸ÄÔö¼Ó13,7¸ÄÔö¼Ó15,ÎïÀíÔö¼Ó30Ëð,10¸ÄÒÔÉÏ±ØÐëÊ¹ÓÃÍõÕßÁéÊ¯£¬ÍõÕß¾§Ê¯+ÉñÊ¯Ò»¸ö£¬·À¾ßÃ¿¸ÄÔö¼Ó10·À
		{
			short sMaster = GetShort(pBuf,index);
			short sMetrial = GetShort(pBuf,index);
			BYTE bReceive = GetByte(pBuf,index);
			short sAdd1 = GetShort(pBuf,index);
			short sAdd2 = GetShort(pBuf,index);
			short sAdd3 = GetShort(pBuf,index);
			short sAdd4 = GetShort(pBuf,index);
			Update130Item(sMaster,sMetrial,bReceive,sAdd1,sAdd2,sAdd3,sAdd4);

			break;
		}*/
	case 55://130¼¶×°±¸¸ÄÔì
		{
			short sMaster = GetShort(pBuf,index);
			short sMetrial1 = GetShort(pBuf,index);
			short sMetrial2 = GetShort(pBuf,index);
			short sMetrial3 = GetShort(pBuf,index);
			Item130Convert(sMaster,sMetrial1,sMetrial2,sMetrial3);
			break;
		}

	default: 
		break;
	}
	m_bNoItemMove = FALSE;
}
void USER::DownAccessoriReq(TCHAR *pBuf)
{
	
	int index=0;
	short Slot = GetShort(pBuf, index);//
	short Slot1 = GetShort(pBuf, index);//±ù·âË®¾§

	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;
	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
	if(m_UserItem[Slot].tMagic[5] != 8) return;
	if(m_UserItem[Slot1].sSid!=1006) return;
	
	if(m_dwDN < 100000)
	{
		SendSystemMsg("¾öÕ½±Ò²»×ã,Ê¹ÓÃ±ù·çË®¾§Ðè10Íò.", SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}
	short sSourceSid = m_UserItem[Slot].sSid;//µÃµ½ÎïÆ·ID
	if(sSourceSid < 0 || sSourceSid >= g_arItemTable.GetSize()) return;
	if(g_arItemTable[sSourceSid]->m_byWear <= 5 || g_arItemTable[sSourceSid]->m_byWear >= 9) return;//ÅÐ¶ÏÎïÆ·ÀàÐÍ

	if(m_UserItem[Slot].tMagic[1] == 137 || m_UserItem[Slot].tMagic[2] == 137 || m_UserItem[Slot].tMagic[3] == 137)
	{
		int iCrestCount = 0;
		int iAllSkill = 0;
		while(1)
		{
			int iMagicRandom  = 0;
			int sMagicSid  = 0;
			int iCrestRandom = myrand(1, 5);
			if(iCrestRandom == 1) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelTop.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelTop[iMagicRandom];
				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom == 2) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelBottom.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelBottom[iMagicRandom];
				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom == 3) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelLeft.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelLeft[iMagicRandom];
				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom == 4) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelRight.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelRight[iMagicRandom];
				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom == 5 && iAllSkill == 0) 
			{
				iAllSkill = 1;
				iMagicRandom = myrand(0, g_Ripel.m_arRipelCrest.GetSize() - 1);
				sMagicSid = g_Ripel.m_arRipelCrest[iMagicRandom];
				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestCount >= 3) break;
		}
		if(m_UserItem[Slot].tMagic[1] != 137 && m_UserItem[Slot].tMagic[2] != 137 && m_UserItem[Slot].tMagic[3] != 137)
		{
			int iCrestRandom = myrand(1, 3);
			m_UserItem[Slot].tMagic[iCrestRandom] = 137;
		}
		m_UserItem[Slot].tIQ = RARE_ITEM;
		CString strMsg;
		    CString GoodsMagic; //×Ô¶¯Éý¼¶ÌáÐÑ
			for(int i = 0; i < 4; i++)
			{
				if(m_UserItem[Slot].tMagic != 0)
				{
					GoodsMagic+=g_arMagicItemTable[m_UserItem[Slot].tMagic[i]]->m_strText;
			     	GoodsMagic+=",";
				}
			}
					strMsg.Format("%s:",g_arItemTable[m_UserItem[Slot].sSid]->m_strName );//¹«¸æÌáÊ¾
					strMsg+=GoodsMagic;
					m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL);
	}
	else
	{
			m_UserItem[Slot].tMagic[1]=0;
			m_UserItem[Slot].tMagic[2]=0;
			m_UserItem[Slot].tMagic[3]=0;
			m_UserItem[Slot].tMagic[4]=0;
			m_UserItem[Slot].tMagic[5]=5;
			m_UserItem[Slot].tIQ=MAGIC_ITEM;

		}

		if (m_UserItem[Slot1].sCount > 1)
			m_UserItem[Slot1].sCount -= 1;
		else
			ReSetItemSlot(&m_UserItem[Slot1]);

		if( m_dwDN <= 100000 ) m_dwDN = 0;
	    else m_dwDN = m_dwDN - 100000;
	    UpdateUserItemDN();						
	    SendMoneyChanged();

		CBufferEx TempBuf;
		int j;
		TempBuf.Add(UPGRADE_ITEM_RESULT);
		TempBuf.Add((BYTE)1);
		TempBuf.Add((BYTE)2);
		BYTE bySlot = (BYTE)Slot;
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);
		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
		TempBuf.Add(m_UserItem[bySlot].tIQ);


		bySlot = (BYTE)Slot1;
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);
		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
		TempBuf.Add(m_UserItem[bySlot].tIQ);

		Send(TempBuf, TempBuf.GetLength());
		}

//±ù·âË®¾§¡¡°Ñ£¸¸Ä½µ³É£µ¸ÄµÄ  ×î³õµÄ
//void USER::DownAccessoriReq(TCHAR *pBuf)
//{
//    int index=0;
//	short Slot = GetShort(pBuf, index);//
//	short Slot1 = GetShort(pBuf, index);//±ù·çË®¾§
//	if(m_UserItem[Slot1].sSid!=1006)		return;
//
//	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;
//	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
//	if(m_UserItem[Slot].tMagic[5] != 8) return;
//
//	if(m_dwDN < 100000)
//	{
//		SendSystemMsg("¾öÕ½±Ò²»×ã,Ê¹ÓÃ±ù·çË®¾§Ðè10Íò.", SYSTEM_ERROR, TO_ME);
//		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
//	}
//	if( m_dwDN <= 100000 ) m_dwDN = 0;
//	else m_dwDN = m_dwDN - 100000;
//	UpdateUserItemDN();						
//	SendMoneyChanged();
//
//	short sSourceSid = m_UserItem[Slot].sSid;//µÃµ½ÎïÆ·ID
//	if(sSourceSid < 0 || sSourceSid >= g_arItemTable.GetSize()) return;
//	if(g_arItemTable[sSourceSid]->m_byWear <= 5 || g_arItemTable[sSourceSid]->m_byWear >=9) return;//ÅÐ¶ÏÎïÆ·ÀàÐÍ
//    	//niuniu add 456
//	if(m_UserItem[Slot].tMagic[1] == 137 || m_UserItem[Slot].tMagic[2] == 137 || m_UserItem[Slot].tMagic[3] == 137)
//	{
//		int iCrestCount = 0;
//		int iAllSkill = 0;
//
//		while(1)
//		{
//			int iMagicRandom  = 0;
//			int sMagicSid  = 0;
//			int iCrestRandom = myrand(0, 10000);
//			if(iCrestRandom <= 3500) 
//			{
//				iMagicRandom = myrand(0, g_Ripel.m_arRipelTop.GetSize() - 1);				
//				sMagicSid = g_Ripel.m_arRipelTop[iMagicRandom];
//				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
//				iCrestCount++;
//			}
//			if(iCrestRandom > 3500 && iCrestRandom <= 7000) 
//			{
//				iMagicRandom = myrand(0, g_Ripel.m_arRipelBottom.GetSize() - 1);				
//				sMagicSid = g_Ripel.m_arRipelBottom[iMagicRandom];
//				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
//				iCrestCount++;
//			}
//			if(iCrestRandom > 7000 && iCrestRandom <= 9000) 
//			{
//				iMagicRandom = myrand(0, g_Ripel.m_arRipelLeft.GetSize() - 1);				
//				sMagicSid = g_Ripel.m_arRipelLeft[iMagicRandom];
//				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
//				iCrestCount++;
//			}
//			if(iCrestRandom > 9000 && iCrestRandom <= 9900) 
//			{
//				iMagicRandom = myrand(0, g_Ripel.m_arRipelRight.GetSize() - 1);				
//				sMagicSid = g_Ripel.m_arRipelRight[iMagicRandom];
//				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
//				iCrestCount++;
//			}
//			if(iCrestRandom > 9900 && iAllSkill == 0)	//ËùÓÐ1¼¼ÄÜ
//			{
//				iAllSkill = 1;
//				iMagicRandom = myrand(0, g_Ripel.m_arRipelCrest.GetSize() - 1);
//				sMagicSid = g_Ripel.m_arRipelCrest[iMagicRandom];
//				m_UserItem[Slot].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
//				iCrestCount++;
//			}
//
//			if(iCrestCount >= 3) break;
//		}
//		if(m_UserItem[Slot].tMagic[1] != 137 && m_UserItem[Slot].tMagic[2] != 137 && m_UserItem[Slot].tMagic[3] != 137)
//		{
//			int iCrestRandom = myrand(1, 3);
//			m_UserItem[Slot].tMagic[iCrestRandom] = 137;
//
//		}
//		m_UserItem[Slot].tIQ = RARE_ITEM;
//		
//		//if(m_UserItem[Slot].tMagic[1] == 56  || m_UserItem[Slot].tMagic[2] == 56 || m_UserItem[Slot].tMagic[3] == 56 ||
//	 //       m_UserItem[Slot].tMagic[1] == 49 || m_UserItem[Slot].tMagic[2] == 49 || m_UserItem[Slot].tMagic[3] == 49||
//	 //       m_UserItem[Slot].tMagic[1] == 61 || m_UserItem[Slot].tMagic[2] == 61 || m_UserItem[Slot].tMagic[3] == 61||
//	 //       m_UserItem[Slot].tMagic[1] == 53 || m_UserItem[Slot].tMagic[2] == 53 || m_UserItem[Slot].tMagic[3] == 53) { 
//	 //
//		//CString strMsg;
//		//CString GoodsMagic;
//		//for(int i = 0; i < 4; i++)
//		//{
//		//	if(m_UserItem[Slot].tMagic != 0)
//		//	{
//		//		GoodsMagic+=g_MagicArray[m_UserItem[Slot].tMagic[i]];
//		//		GoodsMagic+=",";
//		//	}
//		//}
//		//strMsg.Format("Íæ¼Ò:¡¾%s¡¿Ï´³ö¡¾%s¡¿:", this->m_strUserID,g_arItemTable[m_UserItem[Slot].sSid]->m_strName );//¹«¸æÌáÊ¾
//		//strMsg+=GoodsMagic;
//		//m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
//		//
//		//}
////==========================================================================================================================
//		CString strMsg;
//		    CString GoodsMagic; //×Ô¶¯Éý¼¶ÌáÐÑ
//			for(int i = 0; i < 4; i++)
//			{
//				if(m_UserItem[Slot].tMagic != 0)
//				{
//					GoodsMagic+=g_arMagicItemTable[m_UserItem[Slot].tMagic[i]]->m_strText;
//			     	GoodsMagic+=",";
//				}
//			}
//					strMsg.Format("Ï´³ö¡¾%s¡¿:",g_arItemTable[m_UserItem[Slot].sSid]->m_strName );//¹«¸æÌáÊ¾
//					strMsg+=GoodsMagic;
//					m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL);
////===========================================================================================================================
//	}
//	else
//	{
//		m_UserItem[Slot].tMagic[1]=0;
//		m_UserItem[Slot].tMagic[2]=0;
//		m_UserItem[Slot].tMagic[3]=0;
//		m_UserItem[Slot].tMagic[4]=0;
//		m_UserItem[Slot].tMagic[5]=5;
//		m_UserItem[Slot].tIQ=MAGIC_ITEM;
//	}
//	if (m_UserItem[Slot1].sCount > 1)
//		m_UserItem[Slot1].sCount -= 1;
//	else
//	ReSetItemSlot(&m_UserItem[Slot1]);
//	CBufferEx TempBuf;
//	int j;
//	TempBuf.Add(UPGRADE_ITEM_RESULT);
//	TempBuf.Add((BYTE)1);
//	TempBuf.Add((BYTE)2);
//	BYTE bySlot = (BYTE)Slot;
//	TempBuf.Add((BYTE)bySlot);
//	TempBuf.Add(m_UserItem[bySlot].sLevel);
//	TempBuf.Add(m_UserItem[bySlot].sSid);
//	TempBuf.Add(m_UserItem[bySlot].sDuration);
//	TempBuf.Add(m_UserItem[bySlot].sBullNum);
//	TempBuf.Add(m_UserItem[bySlot].sCount);
//	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
//	TempBuf.Add(m_UserItem[bySlot].tIQ);
//	bySlot = (BYTE)Slot1;
//	TempBuf.Add((BYTE)bySlot);
//	TempBuf.Add(m_UserItem[bySlot].sLevel);
//	TempBuf.Add(m_UserItem[bySlot].sSid);
//	TempBuf.Add(m_UserItem[bySlot].sDuration);
//	TempBuf.Add(m_UserItem[bySlot].sBullNum);
//	TempBuf.Add(m_UserItem[bySlot].sCount);
//	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
//	TempBuf.Add(m_UserItem[bySlot].tIQ);
//	Send(TempBuf, TempBuf.GetLength());
//    
//
//}
////////////////»úÐµ»¹Ô­±¦Öé//////////////////////
void USER::EbodyReset(TCHAR *pBuf)
{
	int index=0,i;
	short Slot = GetShort(pBuf, index);//»¹Ô­Öé±¦
	short Slot1 = GetShort(pBuf, index);//»¹Ô­»úÐµ

	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX)
		return;
	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX)
		return;
	//
	short sMaterialSid = m_UserItem[Slot].sSid;//µÃµ½ÎïÆ·ID
	if(sMaterialSid < 0 || sMaterialSid >= g_arItemTable.GetSize())
		return;
	if(sMaterialSid != 1030)
		return;
	if(m_UserItem[Slot].sCount<=0)
		return;
	//
	short sMasterSid = m_UserItem[Slot1].sSid;//µÃµ½ÎïÆ·ID
	if(sMasterSid < 0 || sMasterSid >= g_arItemTable.GetSize())
		return;
	//»úÐµ
	if(!IsEbodyItem(sMasterSid)&&!IsSuperEbodyItem(sMasterSid) )
		return;
	BYTE bLastMagic=0xff;
	BYTE bPos = 0xff;
	for(i = 4;i>0;i--)
	{
		if(m_UserItem[Slot1].tMagic[i] != 0)
		{
			bLastMagic = m_UserItem[Slot1].tMagic[i];
			bPos = i;
			break;
		}
	}
	if(bPos == 0xff)
		return ;
	if(bLastMagic>g_arEBodyTable.GetSize())
		return ;
	//ÊÇ·ñÓÐÎ»ÖÃ
	int bEmptyPos = GetEmptySlot(INVENTORY_SLOT);
	if(bEmptyPos == -1)
	{
		return ;
	}
	CByteArray arMaterial;
	arMaterial.RemoveAll();
	arMaterial.Add((BYTE)Slot);
	arMaterial.Add((BYTE)Slot1);
	arMaterial.Add((BYTE)bEmptyPos);


	m_UserItem[Slot].sCount--;
	if(m_UserItem[Slot].sCount<=0)
		ReSetItemSlot(&m_UserItem[Slot]);
	m_UserItem[Slot1].tMagic[bPos] = 0;
	m_UserItem[Slot1].sLevel -= g_arEBodyTable[bLastMagic]->m_tLevel;
	
	ReSetItemSlot(&m_UserItem[bEmptyPos]);
	m_UserItem[bEmptyPos].sSid = 907;
	m_UserItem[bEmptyPos].sCount = 1;
	m_UserItem[bEmptyPos].sLevel = g_arItemTable[907]->m_byRLevel;
	m_UserItem[bEmptyPos].sDuration = g_arItemTable[907]->m_sDuration;
	m_UserItem[bEmptyPos].tMagic[0] = bLastMagic;
	m_UserItem[bEmptyPos].tIQ = 2;

	FlushItemLog( TRUE );//Çå¿Õ»º³å

	CBufferEx TempBuf;// µ·º¯°æ Á¤º¸¸¦ º¸³½´Ù.
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add(SUCCESS);
	TempBuf.Add((BYTE)arMaterial.GetSize());
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];

		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);
		for(int j =0; j < MAGIC_NUM; j++) 
			TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	arMaterial.RemoveAll();
}
//Îª°Ù¼¶×°±¸Ìí¼ÓÊôÐÔ 100W
void USER::RemagicItem_UpgradeReq(TCHAR *pBuf)
{
	bool isSuccess = false;
	int index=0;
	short Slot = GetShort(pBuf, index);//×°±¸
	short Slot1 = GetShort(pBuf, index);//»ÃÊ¯
	
	
	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;
	if(m_UserItem[Slot].tIQ!=12) return;
	if(m_UserItem[Slot1].sSid!=1096) return ;
	if(m_UserItem[Slot1].tMagic[0] < 3 || m_UserItem[Slot1].tMagic[0] > 72) return;
	if(m_UserItem[Slot].tMagic[10] > 1 ) return;
	if(m_dwDN < 1000000)
	{SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);	return ;	}
	if(FANGJUCAILIAOHUA_XP > m_dwXP) { SendSystemMsg( IDS_XP_ERROR, SYSTEM_ERROR, TO_ME); return; }
	if(m_UserItem[Slot].tMagic[6] != 1 && m_UserItem[Slot].tMagic[6] != m_UserItem[Slot1].tMagic[0] - 1) return;

	int iUpgradeCount = -1;
	int magicSlot = -1;
	for(int i = 6; i < 11; i++)
	{
		if(m_UserItem[Slot].tMagic[i] == 1) 
		{
			magicSlot = i;
			iUpgradeCount = i-6;
			break;
		}
	}
	if(iUpgradeCount == -1) return;
	int iRandom = myrand(1, 10000);
	//iRandom = UpgradeSucc(iRandom);
	if(iRandom <= g_HuanShiJiLv[iUpgradeCount]) isSuccess = true;

	if(isSuccess)
	{
		if(m_UserItem[Slot].tMagic[magicSlot] == 1)			m_UserItem[Slot].tMagic[magicSlot] = m_UserItem[Slot1].tMagic[0];

		if( m_dwDN <= 1000000 ) m_dwDN = 0;
		else m_dwDN = m_dwDN - 1000000;
		UpdateUserItemDN();						
		SendMoneyChanged();	
	}


	if(m_UserItem[Slot1].sCount > 1)
		m_UserItem[Slot1].sCount = m_UserItem[Slot1].sCount -1;
	else
	ReSetItemSlot(&m_UserItem[Slot1]);
	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	if(isSuccess)	TempBuf.Add((BYTE)1);
	else TempBuf.Add((BYTE)2);
	TempBuf.Add((BYTE)2);
	BYTE bySlot = (BYTE)Slot;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ); 

	bySlot = (BYTE)Slot1;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ);

	Send(TempBuf, TempBuf.GetLength());
}
//Îª°Ù¼¶×°±¸±ä¸üÊôÐÔ 100W
void USER::RemagicItem1_UpgradeReq(TCHAR *pBuf)
{
	int index=0,iSuccess=2;
	short Slot = GetShort(pBuf, index);//×°±¸
	short Slot1 = GetShort(pBuf, index);//»ÃÊ¯
	
	
	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;
	if(m_UserItem[Slot].tIQ!=12) return;
	if(m_UserItem[Slot1].sSid!=1096) return ;
	if(m_UserItem[Slot1].tMagic[5]!=1) return ;

	if(m_dwDN < 1000000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}
	if( m_dwDN <= 1000000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 1000000;
	UpdateUserItemDN();						
	SendMoneyChanged();
	
	int rand=myrand(0,100)%100;
	int s=(m_UserItem[Slot1].tMagic[0]-2)%10*7+10;
	if(rand>s){
		iSuccess=1;
		m_UserItem[Slot].tMagic[6]=m_UserItem[Slot1].tMagic[0];
	}
	ReSetItemSlot(&m_UserItem[Slot1]);
	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)iSuccess);
	TempBuf.Add((BYTE)2);
	BYTE bySlot = (BYTE)Slot;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ); 
	
	bySlot = (BYTE)Slot1;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ);
	
	Send(TempBuf, TempBuf.GetLength());
}
//»ÃÊ¯ÊôÐÔÉý¼¶¡£¡£¡£¡£
void USER::RemagicItem_HuanShi(TCHAR *pBuf)
{
	bool isSuccess = false;
	int index=0;
	short Slot = GetShort(pBuf, index);//¿Õ
	short Slot1 = GetShort(pBuf, index);//»ÃÊ¯
	short Slot2 = GetShort(pBuf, index);//»ÃÊ¯

	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
	if(Slot2 < EQUIP_ITEM_NUM || Slot2 >= TOTAL_INVEN_MAX) return;
	if(m_UserItem[Slot1].sSid!=1096 || m_UserItem[Slot2].sSid!=1096)return ;
	if(m_UserItem[Slot1].tMagic[5] >= 10 || m_UserItem[Slot2].tMagic[5] >=10) return;
	if(m_UserItem[Slot1].tMagic[0]!=m_UserItem[Slot2].tMagic[0]) return ;
	if(m_UserItem[Slot1].tMagic[5]!=m_UserItem[Slot2].tMagic[5]) return;
	if(m_dwDN < 500000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}
	if( m_dwDN <= 500000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 500000;
	UpdateUserItemDN();						
	SendMoneyChanged();
	ReSetItemSlot(&m_UserItem[Slot2]);
	int iRandom = myrand(1, 10000);
	if(iRandom <= g_ItemHsUpgrade[m_UserItem[Slot1].tMagic[5]]) isSuccess = true;
	if(isSuccess)
	{
		m_UserItem[Slot1].tMagic[5]++;
		m_UserItem[Slot1].tMagic[0]++;
	}

	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	if(isSuccess) TempBuf.Add((BYTE)1);
	else TempBuf.Add((BYTE)2);
	TempBuf.Add((BYTE)2);
	BYTE bySlot = (BYTE)Slot1;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ); 
	
	bySlot = (BYTE)Slot2;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ);
	
	Send(TempBuf, TempBuf.GetLength());


}
void USER::ShouHouAdd(TCHAR *pBuf)
{
	int index=0,iSuccess=0,s;
	int Magic[3]={0,0,0};
	int newMagic=-1,up=1;

	short Slot = GetShort(pBuf, index);//ÈïÆ¬
	short Slot1 = GetShort(pBuf, index);//ÊØ»¤
	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;

	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
	if(m_UserItem[Slot].sSid==-1 ||m_UserItem[Slot1].sSid==-1)
		return ;
	if(m_UserItem[Slot].sSid!=1051)
		return ;
	if(g_arItemTable[m_UserItem[Slot1].sSid]->m_byWear!=130)
		return ;
	
	for(int i=1;i<4;i++){
		switch (m_UserItem[Slot1].tMagic[i]){//¼ÆËãÊØ»¤666ÊôÐÔ
			case 0:
				newMagic=i;
				break;
			case 1:case 2:case 3:case 4:case 5://Ã¿´Î¼Óµã3·À
				Magic[0]=i;
				break;
			case 6:
				Magic[0]=-1;
				break;
			case 7:case 8:case 9:case 10:case 11:
				Magic[1]=i;
				break;
			case 12://Ã¿¼¶¼Ó15Ñª
				Magic[1]=-1;
				break;
			case 13:case 14:case 15:case 16:case 17:
				Magic[2]=i;
				break;
			case 18://Ã¿¼¶Ôö¼Ó5¿¹AGIC_DEFENSE_UP
				Magic[2]=-1;
				break;
		 default:
		 	break;
		}
	}
	int rand=myrand(0,1000)%100;

	switch(m_UserItem[Slot].tMagic[0]){
		case 5://Ã¿´Î¼Óµã3·À
			if(Magic[0]==-1) return;
			if(Magic[0]!=0) 
				newMagic=Magic[0];
			else
				up=1;
			
			break;
		case 12://Ã¿¼¶¼Ó15Ñª
		if(Magic[1]==-1) return;
			if(Magic[1]!=0) 
				newMagic=Magic[1];
			else
				up=7;
			break;
			
		case 6://Ã¿¼¶Ôö¼Ó5¿¹
			if(Magic[2]==-1) return;
			if(Magic[2]!=0) 
				newMagic=Magic[2];
			else 
				up=13;
			break;
		default:
			return;
	}
	s=(m_UserItem[Slot1].tMagic[newMagic]%6)*10+10;
	if(rand>s){
		iSuccess=1;
		m_UserItem[Slot1].tMagic[newMagic]+=up;
		////////////////////////////////////////////////////////////////////////////
		if (m_UserItem[Slot1].tMagic[0] == 30 && 
			
			( m_UserItem[Slot1].tMagic[1] == 18 ||  m_UserItem[Slot1].tMagic[2] == 18 || m_UserItem[Slot1].tMagic[3] == 18)
			
			&&


          ( m_UserItem[Slot1].tMagic[1] == 12 || m_UserItem[Slot1].tMagic[2] == 12 || m_UserItem[Slot1].tMagic[3] == 12)

		  &&
         
		  ( m_UserItem[Slot1].tMagic[1] == 6 || m_UserItem[Slot1].tMagic[2] == 6 || m_UserItem[Slot1].tMagic[3] == 6)){

	 
		CString strMsg;
		strMsg.Format("Íæ¼Ò [%s] ºÏ³É 666¼¼ÄÜÊØ»¤!", this->m_strUserID);//¹«¸æÌáÊ¾
		m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
		}

		if (m_UserItem[Slot1].tMagic[0] == 6 && 
			
			( m_UserItem[Slot1].tMagic[1] == 18 ||  m_UserItem[Slot1].tMagic[2] == 18 || m_UserItem[Slot1].tMagic[3] == 18)
			
			&&


          ( m_UserItem[Slot1].tMagic[1] == 12 || m_UserItem[Slot1].tMagic[2] == 12 || m_UserItem[Slot1].tMagic[3] == 12)

		  &&
         
		  ( m_UserItem[Slot1].tMagic[1] == 6 || m_UserItem[Slot1].tMagic[2] == 6 || m_UserItem[Slot1].tMagic[3] == 6)){

	 
		CString strMsg;
		strMsg.Format("Íæ¼Ò [%s] ºÏ³É 666ÎäÆ÷ÊØ»¤!", this->m_strUserID);//¹«¸æÌáÊ¾
		m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
		}



	}
		//============================================================================
	
	//È¥µôÈïÆ¬
	ReSetItemSlot(&m_UserItem[Slot]);

	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	if(iSuccess)
		TempBuf.Add((BYTE)6);
	else
		TempBuf.Add((BYTE)7);
	TempBuf.Add((BYTE)2);
	BYTE bySlot = (BYTE)Slot;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ); 
	
	bySlot = (BYTE)Slot1;
	TempBuf.Add((BYTE)bySlot);
	TempBuf.Add(m_UserItem[bySlot].sLevel);
	TempBuf.Add(m_UserItem[bySlot].sSid);
	TempBuf.Add(m_UserItem[bySlot].sDuration);
	TempBuf.Add(m_UserItem[bySlot].sBullNum);
	TempBuf.Add(m_UserItem[bySlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);
	TempBuf.Add(m_UserItem[bySlot].tIQ);
	
	Send(TempBuf, TempBuf.GetLength());


}
void USER::ShouHouMake(TCHAR *pBuf)
{
	int iWeight=0;
	int index=0;
	BYTE tMagic=0;
	CUIntArray arMaterial;

	short Slot = GetShort(pBuf, index);//ºÐ×Ó
	short Slot1 = GetShort(pBuf, index);//¾§Ìå
	short Slot2 = GetShort(pBuf, index);//À¬»øÊØ»¤
	short Slot3 = GetShort(pBuf, index);//À¬»øÊØ»¤
	short Slot4 = GetShort(pBuf, index);//À¬»øÊØ»¤
	short Slot5 = GetShort(pBuf, index);//À¬»øÊØ»¤
	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;
	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
	if(m_UserItem[Slot].sSid!=1050)
		return;
	arMaterial.Add(Slot);
	arMaterial.Add(Slot1);
	if(m_UserItem[Slot1].sSid==665||m_UserItem[Slot1].sSid==668||m_UserItem[Slot1].sSid==663){
		if(m_UserItem[Slot1].sCount<100)
			return;
		if(m_UserItem[Slot1].sSid==665)//·À¼Ó3
			tMagic=5;
		if(m_UserItem[Slot1].sSid==668)//Ñª¼Ó15
			tMagic=6;
		if(m_UserItem[Slot1].sSid==663)//¿¹¼Ó5
			tMagic=12;
	}else{
		return;
	}
	if(Slot2!=-1){
		if(Slot2 < EQUIP_ITEM_NUM || Slot2 >= TOTAL_INVEN_MAX) return;
		iWeight=iWeight+g_arItemTable[m_UserItem[Slot2].sSid]->m_byWeight;
		ReSetItemSlot(&m_UserItem[Slot2]);
		arMaterial.Add(Slot2);
		
	}
	if(Slot3!=-1){
		if(Slot3 < EQUIP_ITEM_NUM || Slot3 >= TOTAL_INVEN_MAX) return;
		iWeight=iWeight+g_arItemTable[m_UserItem[Slot3].sSid]->m_byWeight;
		ReSetItemSlot(&m_UserItem[Slot3]);
		arMaterial.Add(Slot3);
		
	}
	if(Slot4!=-1){
		if(Slot4 < EQUIP_ITEM_NUM || Slot4 >= TOTAL_INVEN_MAX) return;
		iWeight=iWeight+g_arItemTable[m_UserItem[Slot4].sSid]->m_byWeight;
		ReSetItemSlot(&m_UserItem[Slot4]);
		arMaterial.Add(Slot4);
		
	}
	if(Slot5!=-1){
		if(Slot5 < EQUIP_ITEM_NUM || Slot5 >= TOTAL_INVEN_MAX) return;
		iWeight=iWeight+g_arItemTable[m_UserItem[Slot5].sSid]->m_byWeight;
		ReSetItemSlot(&m_UserItem[Slot5]);
		arMaterial.Add(Slot5);
		
	}
	iWeight=iWeight+g_arItemTable[m_UserItem[Slot1].sSid]->m_byWeight;
	if(m_UserItem[Slot1].sCount>100){
		m_UserItem[Slot1].sCount=m_UserItem[Slot1].sCount-100;
	}else
		ReSetItemSlot(&m_UserItem[Slot1]);
	ReSetItemSlot(&m_UserItem[Slot]);
	int sSid=1051;
	m_UserItem[Slot].sLevel = g_arItemTable[sSid]->m_byRLevel;
	m_UserItem[Slot].sSid = sSid;
	m_UserItem[Slot].sCount = 1;
	m_UserItem[Slot].sDuration = g_arItemTable[sSid]->m_sDuration;
	m_UserItem[Slot].sBullNum = 1;
	m_UserItem[Slot].tMagic[0] = tMagic;
	m_UserItem[Slot].tMagic[1] = 0;
	m_UserItem[Slot].tMagic[2] = 0;
	m_UserItem[Slot].tMagic[3] = 0;
	m_UserItem[Slot].tMagic[4] = 0;
	m_UserItem[Slot].tMagic[5] = 0;
	m_UserItem[Slot].tIQ = 2;
	m_UserItem[Slot].iItemSerial = 0;
	
	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)5);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());

}
void USER::ShouHouUpgradeReq(TCHAR *pBuf)
{
	int index=0;
	int n;
	int iSuccess = 2;
	BYTE tSourceWear = 0;		// À´Ô´ÀàÐÍ
	int iWeight=0;
	///////////////////////////////////////////////////////
	if(m_dwDN < 1000000)
	{
		SendSystemMsg("Éý¼¶ÊØ»¤Òª100Íò¾öÕ½±Ò,Éý¼¶Ê§°ÜÊØ»¤²»ÏûÊ§", SYSTEM_ERROR, TO_ME);
		return;
	}
    //////////////////////////////////////////////////////////
	short sSrcSlot = GetShort(pBuf, index);//Ö÷Ìå
	short sDstSlot = GetShort(pBuf, index);//¾§Ìå
	if(sSrcSlot < EQUIP_ITEM_NUM || sSrcSlot >= TOTAL_INVEN_MAX) return;
	if(sDstSlot < EQUIP_ITEM_NUM || sDstSlot >= TOTAL_INVEN_MAX) return;
	if(m_UserItem[sDstSlot].sSid!=964)//Éý¼¶µÄÎïÆ·²»ÊÇ¾§Ìå.
		return;
	if(m_UserItem[sSrcSlot].tIQ!=9)
		return;
	n=m_UserItem[sSrcSlot].tMagic[5];
	if(n>=2){
		m_UserItem[sSrcSlot].tMagic[5]=2;
		return;
	}
	// Èç¹ûÎïÆ·ÀàÐÍ²»µÈÓÚ130ÍË³ö
	tSourceWear = g_arItemTable[m_UserItem[sSrcSlot].sSid]->m_byWear;
	if(tSourceWear != 130)								// ¼ì²éÊÇ·ñÊÇ¿ÉÒÔÉú¼ÆµÄÎïÆ·ÀàÐÍ(ÊØ»¤)
	{
		SendSystemMsg( IDS_USER_CANT_UPGRADE_ITEM, SYSTEM_ERROR, TO_ME);
		return;
	}
	int rand=myrand(0,100)%100;
	if(n==0&&rand<40)
		iSuccess=1;
	if(n==1&&rand<15)
		iSuccess=1;
	if(iSuccess==1){//³É¹¦ÁË.....
		m_UserItem[sSrcSlot].tMagic[0]++;
		m_UserItem[sSrcSlot].tMagic[5]++;
	}else{//Ê§°ÜÁË.....
		////////////////////////////////////////////////////////////////////////////////
		if (m_UserItem[sSrcSlot].tMagic[5] == 1 )
		{
			m_UserItem[sSrcSlot].tMagic[0] -=1;
			m_UserItem[sSrcSlot].tMagic[5] -=1;
		}

		/////////////////////////////////////////////////////////////////////////////////
		 iWeight+= g_arItemTable[m_UserItem[sSrcSlot].sSid]->m_byWeight;
		// ReSetItemSlot(&m_UserItem[sSrcSlot]);
		
	}
	iWeight+= g_arItemTable[m_UserItem[sDstSlot].sSid]->m_byWeight;
	ReSetItemSlot(&m_UserItem[sDstSlot]);
	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;
	///////////////////////////////////////////////////////////////////////////////////
	if( m_dwDN <= 1000000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 1000000;
	UpdateUserItemDN();	
	SendMoneyChanged();

	//////////////////////////////////////////////////////////////////////////////////
	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)iSuccess);
	TempBuf.Add((BYTE)2);
	TempBuf.Add((BYTE)sSrcSlot);
	TempBuf.Add(m_UserItem[sSrcSlot].sLevel);
	TempBuf.Add(m_UserItem[sSrcSlot].sSid);
	TempBuf.Add(m_UserItem[sSrcSlot].sDuration);
	TempBuf.Add(m_UserItem[sSrcSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSrcSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSrcSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSrcSlot].tIQ); 

	TempBuf.Add((BYTE)sDstSlot);
	TempBuf.Add(m_UserItem[sDstSlot].sLevel);
	TempBuf.Add(m_UserItem[sDstSlot].sSid);
	TempBuf.Add(m_UserItem[sDstSlot].sDuration);
	TempBuf.Add(m_UserItem[sDstSlot].sBullNum);
	TempBuf.Add(m_UserItem[sDstSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sDstSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sDstSlot].tIQ); 

	Send(TempBuf, TempBuf.GetLength());
}
int USER::FindItemSid(short sSid)
{
	int i;
	for(i=0;i<60;i++){
		if(convert[i].Ssid==sSid)
			return i;
	}
	return -1;

}
////°Ù¼¶×ª»»
void USER::ItemConvert(TCHAR *pBuf)
{
	
	int index=0,n;
	int i,count1=0,count2=0;
	short sid;
	short sSrcSlot = GetShort(pBuf, index);//Ö÷Ìå
	short sDstSlot = GetShort(pBuf, index);//²ÄÁÏ
	BYTE itemClass = -1;
	short sSourceSid = -1;//Ö÷Ìå
	short sMaterialSid = -1;//²ÄÁÏ
	
	if(sSrcSlot < EQUIP_ITEM_NUM || sSrcSlot >= TOTAL_INVEN_MAX) return;
	if(sDstSlot < EQUIP_ITEM_NUM || sDstSlot >= TOTAL_INVEN_MAX) return;
	for(i=EQUIP_ITEM_NUM;i<TOTAL_INVEN_MAX;i++){
		if(1093==m_UserItem[i].sSid)
			break;
	}
	if(i>=TOTAL_INVEN_MAX)
		return;
	if(m_UserItem[sSrcSlot].sSid==-1&&m_UserItem[sDstSlot].sSid==-1)
		return;
	if( g_arItemTable[m_UserItem[sSrcSlot].sSid]->m_byWear !=  g_arItemTable[m_UserItem[sDstSlot].sSid]->m_byWear)
		return ;
	sSourceSid = m_UserItem[sSrcSlot].sSid;//Ö÷Ìå
	sMaterialSid = m_UserItem[sDstSlot].sSid;//²ÄÁÏ
	if(sSourceSid < 0 || sSourceSid >= g_arItemTable.GetSize()) return;
	if(sMaterialSid < 0 || sMaterialSid >= g_arItemTable.GetSize()) return;
	if(g_arItemTable[sSourceSid]->m_byWear <= 1 || g_arItemTable[sSourceSid]->m_byWear >= 6) return;
	if(g_arItemTable[sMaterialSid]->m_byWear <= 1 || g_arItemTable[sMaterialSid]->m_byWear >= 6) return;

	itemClass  = g_arItemTable[m_UserItem[sDstSlot].sSid]->m_byClass; 
	if(g_arItemTable[m_UserItem[sSrcSlot].sSid]->m_byClass == BRAWL_ITEM)//È­Ö°Òµ
	{
		if(itemClass != BRAWL_ITEM && itemClass != STAFF_ITEM && itemClass != EDGED_ITEM && itemClass != FIREARMS_ITEM) return;//È­ ·¨ µ¶ Ç¹
	}
	else if(g_arItemTable[m_UserItem[sSrcSlot].sSid]->m_byClass == STAFF_ITEM)//·¨Ö°Òµ
	{
		if(itemClass != STAFF_ITEM) return;//·¨
	}
	else if(g_arItemTable[m_UserItem[sSrcSlot].sSid]->m_byClass == EDGED_ITEM )//µ¶Ö°Òµ
	{
		if(itemClass != STAFF_ITEM && itemClass != EDGED_ITEM && itemClass != FIREARMS_ITEM) return;//µ¶ ·¨ Ç¹
	}
	else if(g_arItemTable[m_UserItem[sSrcSlot].sSid]->m_byClass == FIREARMS_ITEM )//Ç¹Ö°Òµ
	{
		if(itemClass != STAFF_ITEM && itemClass != FIREARMS_ITEM) return;//µ¶ ·¨ Ç¹
	}


	if(m_UserItem[sSrcSlot].tMagic[5]<7) return;
	//=================================================================·â°Ù¼¶¹Ò
	if( m_UserItem[sSrcSlot].sLevel < 70 || m_UserItem[sDstSlot].sLevel < 70   )
	{
		SendEventMsg("Çë·ÅÈë70¼¶µÄÃ±×ÓÐ¬×Ó,80¼¶µÄÒÂ·þ¿ã×Ó!");
		return;
	}
	if( m_UserItem[sSrcSlot].tMagic[5] < m_UserItem[sDstSlot].tMagic[5] )
	{
		SendEventMsg("Ö÷ÌåµÄ¸ÄÊý±ØÐë´óÓÚ²ÄÁÏµÄ¸ÄÊý!");
		return;
	}

       if( m_UserItem[sSrcSlot].tIQ != m_UserItem[sDstSlot].tIQ  )
	{
		SendEventMsg("Ö÷ÌåºÍ²ÄÁÏµÄÑÕÉ«²»ÏàÍ¬");
		return; 
    } 

      if(m_UserItem[sDstSlot].tMagic[6] != 2)
      {
			CString str = _T("");
			SYSTEMTIME st;
			CString strDate;
			GetLocalTime(&st);
			strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
			str.Format("[%s]Íæ¼Ò[%s]·Ç·¨ºÏ°Ù¼¶1 \r\n",strDate ,m_strUserID);
			EnterCriticalSection( &m_CS_FileWrite );
			g_fpSpeedHack1.Write( str, str.GetLength() );
			LeaveCriticalSection( &m_CS_FileWrite);
			SendSystemMsg("×°±¸Ã»ÓÐ²ÄÁÏ»¯", SYSTEM_ERROR, TO_ME);
			return;
	}
	   if( m_UserItem[sSrcSlot].tMagic[3] != 0 && m_UserItem[sDstSlot].tMagic[3] == 0 )
      {
			CString str = _T("");
			SYSTEMTIME st;
			CString strDate;
			GetLocalTime(&st);
			strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
			str.Format("[%s]Íæ¼Ò[%s]·Ç·¨ºÏ°Ù¼¶2 \r\n",strDate,m_strUserID );
			EnterCriticalSection( &m_CS_FileWrite );
			g_fpSpeedHack1.Write( str, str.GetLength() );
			LeaveCriticalSection( &m_CS_FileWrite);
			SendSystemMsg("ºÏ³ÉÊ§°Ü·Ç·¨²Ù×÷", SYSTEM_ERROR, TO_ME);
			return;
	}
//-------------------------------------------------------------------------------
	
	for(i=0;i<4;i++){
		if(m_UserItem[sSrcSlot].tMagic[i]!=0) count1++;
		if(m_UserItem[sDstSlot].tMagic[i]!=0) count2++;
	}
	if(count1!=count2||count1==0)
		return;

	n=FindItemSid(m_UserItem[sDstSlot].sSid);
	if(n==-1)
		return;
	n=FindItemSid(m_UserItem[sSrcSlot].sSid);
	if(n==-1)
		return;
	sid=convert[n].Dsid;
	//½ðÇ®1000W
	if(m_dwDN < 10000000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}
	if( m_dwDN <= 10000000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 10000000;
	UpdateUserItemDN();						
	SendMoneyChanged();
	//Çå³ýµô±ù»ê
	RobItem(1093, 1);
//¿ªÊ¼×ª»»

	m_UserItem[sSrcSlot].sSid=sid;
	m_UserItem[sSrcSlot].tIQ=0x0c;
	m_UserItem[sSrcSlot].tMagic[5]=m_UserItem[sSrcSlot].tMagic[5]-7;
	int rand = myrand(1, 100)%count1;
	count2=0;
	for(i=0;i<4;i++){
		if(rand==count2){
			m_UserItem[sSrcSlot].tMagic[4]=m_UserItem[sDstSlot].tMagic[i];
		}
		if(m_UserItem[sDstSlot].tMagic[i]!=0)
			count2++;
	}
	ReSetItemSlot(&m_UserItem[sDstSlot]);
	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)3);
	TempBuf.Add((BYTE)2);
	TempBuf.Add((BYTE)sSrcSlot);
	TempBuf.Add(m_UserItem[sSrcSlot].sLevel);
	TempBuf.Add(m_UserItem[sSrcSlot].sSid);
	TempBuf.Add(m_UserItem[sSrcSlot].sDuration);
	TempBuf.Add(m_UserItem[sSrcSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSrcSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSrcSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSrcSlot].tIQ); 
	
	TempBuf.Add((BYTE)sDstSlot);
	TempBuf.Add(m_UserItem[sDstSlot].sLevel);
	TempBuf.Add(m_UserItem[sDstSlot].sSid);
	TempBuf.Add(m_UserItem[sDstSlot].sDuration);
	TempBuf.Add(m_UserItem[sDstSlot].sBullNum);
	TempBuf.Add(m_UserItem[sDstSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sDstSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sDstSlot].tIQ); 

	Send(TempBuf, TempBuf.GetLength());

}


////////////½â³ýÊôÐÔÏÞÖÆ//////////////////////////////////////////////////////////////////////////////////
void USER::RemagicItem_100_3(TCHAR *pBuf)
{
	int index=0,i;
	short sSourceSlot = GetShort(pBuf, index);	
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;
	if( m_UserItem[sSourceSlot].tMagic[5]<3) return;
	if( m_UserItem[sSourceSlot].tIQ!=12)	return;
	if(FindItem(1094) == 0) return;
	if(m_dwDN < 1000000)
	{	SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);		return ;	}
	if(m_UserItem[sSourceSlot].tMagic[10] !=0) return;
	

	for(i = 6; i < 11;i++)
	{		
		if(m_UserItem[sSourceSlot].tMagic[i]==0)
		{
			m_UserItem[sSourceSlot].tMagic[i] = 1;
			//break;
		}	
	}
	
	if( m_dwDN <= 1000000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 1000000;

	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();
	//Çå³ýµôÏûÈÚÖ®ÐÇ
	RobItem(1094, 1);
	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)sSourceSlot);
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 
	Send(TempBuf, TempBuf.GetLength());

}
//·À¾ß²ÄÁÏ»¯
void USER::RemagicItem_100_1(TCHAR *pBuf)
{
	int index=0;
	short sSourceSlot = GetShort(pBuf, index);	
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;
	if( m_UserItem[sSourceSlot].tMagic[5]<7){
		return;
	}
	if(m_UserItem[sSourceSlot].tIQ!=1&&m_UserItem[sSourceSlot].tIQ!=3&&m_UserItem[sSourceSlot].tIQ!=2)
		return ;
	////////////////////½­ºþ//////////////////////////////////////////
	if (m_UserItem[sSourceSlot].sSid < 0 || m_UserItem[sSourceSlot].sSid >= g_arItemTable.GetSize()) return;

	if (g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_byWear < 2 || g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_byWear > 5 ) return;
	////////////////////////////////////////////////////////
	if(m_dwDN < 100000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}

	if( m_dwDN <= 100000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 100000;

	m_UserItem[sSourceSlot].tMagic[6]=2;

	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)9);
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)sSourceSlot);
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 
	Send(TempBuf, TempBuf.GetLength());

}
//½â³ý·À¾ß²ÄÁÏ»¯
void USER::RemagicItem_100_2(TCHAR *pBuf)
{
	int index=0;
	short sSourceSlot = GetShort(pBuf, index);	
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;
	if( m_UserItem[sSourceSlot].tMagic[5]<7){
		return;
	}
	if(m_UserItem[sSourceSlot].tIQ!=1&&m_UserItem[sSourceSlot].tIQ!=3&&m_UserItem[sSourceSlot].tIQ!=2)
		return ;
	//////////////////////////////////////////////////////////////////////////
	if (m_UserItem[sSourceSlot].sSid < 0 || m_UserItem[sSourceSlot].sSid >= g_arItemTable.GetSize()) return;

	if (g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_byWear < 2 || g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_byWear > 5 ) return;

	///////////////////////////////////////////////////////////////////////////½­ºþ
	if(m_dwDN < 100000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}

	if( m_dwDN <= 100000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 100000;

	m_UserItem[sSourceSlot].tMagic[6]=0;

	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)10);
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)sSourceSlot);
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 
	Send(TempBuf, TempBuf.GetLength());
}
void USER::UpgradeItemReq(TCHAR *pBuf)
{
	if(!m_MItemLock && o_yehuoini[0]->mimabaohu == 1 )
	{
        SendSystemMsg( "ÇëÏÈ½â³ýÃÜÂë±£»¤ºóÔÚ²Ù×÷", SYSTEM_ERROR, TO_ME);
		return;
	}


	int iSid = -1;
	int iIQ = -1;
	int iCount = 0, iThings = 0;
	int i, j, index = 0;
	int iWeight = 0;
	short sMaterialSlot;

	int iSuccess = 0;

	BYTE tIQ = 0, bySlot = 0;

	CBufferEx TempBuf;

	ItemList	MyItem[TOTAL_ITEM_NUM];

	CByteArray arMaterial;
	arMaterial.RemoveAll();

	short sSourceSlot = GetShort(pBuf, index);			// ¼±ÅÃÇÑ ¾ÆÀÌÅÛ ½½·Ô¹øÈ£

	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;	// ÀÎº¥¿¡¼­¸¸ ¾÷±×·¹ÀÌµå °¡´É

	iSid = m_UserItem[sSourceSlot].sSid;
	if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return;
	if( iSid == 669 || iSid == 670 )					// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ ±Û·¯±×Á¾·ù¶ó¸é
	{
		SendSystemMsg( IDS_USER_CANT_UPGRADE_ITEM, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(g_arItemTable[iSid]->m_byWear > 5 && g_arItemTable[iSid]->m_byWear < 9)
		return ;



	iIQ = m_UserItem[sSourceSlot].tIQ;
	switch(iIQ)
	{
	case NORMAL_ITEM:
		break;
	case MAGIC_ITEM:
		iCount = 1;
		iThings = MATERIAL_MAGIC_UP_ITEM;
		break;
	case RARE_ITEM:
		iCount = 1;
		iThings = MATERIAL_RARE_UP_ITEM;
		break;
	case REMODEL_ITEM:
	case REMODEL_MAGIC_ITEM:
		iCount = 2;
		iThings = MATERIAL_REMODEL_UP_ITEM;
		break;
	case 12: //ÆÕÍ¨°Ù¼¶
		iCount = 1;
		iThings = MATERIAL_RARE_UP_ITEM;
		break;
	case 18: //130Ì×
		iCount = 1;
		iThings = MATERIAL_RARE_UP_ITEM;
		break;
	default:

		return;
	}
	if(iSid != 1236 && (g_arItemTable[iSid]->m_byWear == 122) || (g_arItemTable[iSid]->m_byWear == 123) 
		|| (g_arItemTable[iSid]->m_byWear == 124) || (g_arItemTable[iSid]->m_byWear == 125)) return;//ÐÞ¸´Ë¢»úÐµ

	for(i = 0; i < TOTAL_ITEM_NUM; i++)			// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}
	for(i = 0; i < iCount; i++)
	{
		sMaterialSlot = -1;
		sMaterialSlot = GetShort(pBuf, index);			// ¸ÅÁ÷¼Ó¼º 1°³ ºÙÀº Àç·á ( ¾øÀ¸¸é -1 )
		if(sMaterialSlot >= EQUIP_ITEM_NUM && sMaterialSlot < TOTAL_INVEN_MAX)
		{												// Àç·áÁß¿¡ ÇØ´ç wearÁ¤º¸°¡ ´Ù¸£¸é ½ÇÆÐ		
			iSid = MyItem[sMaterialSlot].sSid;
			if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return;
			if(iSid != iThings) return;			
			if(MyItem[sMaterialSlot].sCount <= 0) return;

			iWeight += g_arItemTable[iSid]->m_byWeight;

			MyItem[sMaterialSlot].sCount -= 1;
			arMaterial.Add((BYTE)sMaterialSlot);
		}
		else
		{
			SendSystemMsg(IDS_USER_SHENGSHI, SYSTEM_ERROR, TO_ME);
			return;
		}
	}


	iSuccess = SetUpgeadeItem(sSourceSlot);	
	if(iSuccess == 0) iWeight += g_arItemTable[iSid]->m_byWeight;			// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.
	if(iSuccess == -1) return;

	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.

	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = 1 + arMaterial.GetSize();

	if(!iSuccess)	TempBuf.Add((BYTE)0x00); //½ÇÆÐ
	else			TempBuf.Add((BYTE)0x01);
	
	SendMoneyChanged();

	TempBuf.Add((BYTE)index);

	TempBuf.Add((BYTE)sSourceSlot);					// ÁÖ ¾ÆÀÌÅÛ¸¦ ¸ÕÀú 	
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 

	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		bySlot = (BYTE)arMaterial[i];
		
		if(m_UserItem[bySlot].sCount <= 1) ReSetItemSlot(&m_UserItem[bySlot]);// ¼Òºñ¼º ÀÌ¹Ç·Î ¸ÕÀú ÃÊ±âÈ­ÇÏ°í 
		else							   m_UserItem[bySlot].sCount -= 1;

		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

	Send(TempBuf, TempBuf.GetLength());

	arMaterial.RemoveAll();
}

int USER::SetUpgeadeItem(short sSlot)
{
	BYTE tCount = 0;

	int iSuccess = 0;

	int temp = 0;
	int last = 0;
	int rand = 0;

	if(m_UserItem[sSlot].sSid < 0 || m_UserItem[sSlot].sSid >= g_arItemTable.GetSize()) return -1;
	if(g_arItemTable[m_UserItem[sSlot].sSid]->m_sDuration <= 0) return -1;
	if(g_arItemTable[m_UserItem[sSlot].sSid]->m_byWear > 5 && g_arItemTable[m_UserItem[sSlot].sSid]->m_byWear > 9) return -1;
	
	tCount = m_UserItem[sSlot].tMagic[5];
	if(tCount >= MAX_ITEM_UPGRADE_COUNT) return -1;

	if(g_arItemTable[m_UserItem[sSlot].sSid]->m_byWear == ATTACK_ITEM)
	{
		if(m_dwDN < ATTACK_UPGRADE_COST)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
			return -1;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
		}

		if( m_dwDN <= ATTACK_UPGRADE_COST ) m_dwDN = 0;
		else m_dwDN = m_dwDN - ATTACK_UPGRADE_COST;			// ÇØ´ç ºñ¿ë¸¦ °á°ú¿¡ »ó°ü¾øÀÌ ¹Ì¸® °è»ê

		if(g_arItemTable[m_UserItem[sSlot].sSid]->m_byClass == STAFF_ITEM)
		{
			last = ATTACK_UPGRADE_PSI_BAND;					// ¾÷±×·¹ÀÌµå ¼º°ø½Ã Áß°¡µÇ´Â °ª
		}
		else
		{
			last = ATTACK_UPGRADE_BAND;						// ¾÷±×·¹ÀÌµå ¼º°ø½Ã Áß°¡µÇ´Â °ª
		}


		rand = myrand(1, 10000);							// ¼º°ø·ü°ú ºñ±³À§ÇØ ·£´ý¼ö¸¦ ±¸ÇÔ
		if(rand <= g_ItemAttUpgrade[tCount]) iSuccess = 1;// ÇØ´ç ¹øÂ°ÀÇ ¼º°ø·üº¸´Ù ÀÛÀ¸¸é
		int dwTemp = FindItem(1043);
		if (dwTemp >= 1)
		{
			RobItem(1043,1);//12ÔÂ22ÈÕ
			SendSystemMsg("±¾´ÎÊ¹ÓÃÐÒÔËÐÇ[100%³É¹¦ÂÊ]", SYSTEM_ERROR, TO_ME);
			iSuccess = 1;
		}

	}
	else
	{
		if(m_dwDN < DEFENSE_UPGRADE_COST)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
			return -1;		// ¹æ¾î¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
		}

		if( m_dwDN <= DEFENSE_UPGRADE_COST ) m_dwDN = 0;
		else m_dwDN = m_dwDN - DEFENSE_UPGRADE_COST;				// ÇØ´ç ºñ¿ë¸¦ °á°ú¿¡ »ó°ü¾øÀÌ ¹Ì¸® °è»ê

		last = DEFENSE_UPGRADE_BAND;						// ¹æ¾î¿ë ¹üÀ§

//		if(tCount < 6)					// ÀÓ½Ã·Î 6¾÷º¸´Ù Å©¸é ¹«Á¶°Ç ½ÇÆÐ 02-05-04 by Youn Gyu
//		{
		rand = myrand(1, 10000);	
		if(m_UserItem[sSlot].tIQ==12){
			if(rand <= g_ItemDefUpgrade_[tCount]) 
				iSuccess = 1;
		}else{
			if(rand <= g_ItemDefUpgrade[tCount]) 
				iSuccess = 1;
		}
		int dwTemp = FindItem(1043);//12ÔÂ22ÈÕ
		if (dwTemp >= 1)
		{
			RobItem(1043,1);//¼õÉÙÒ»¸öÎïÆ·
			SendSystemMsg("±¾´ÎÊ¹ÓÃÐÒÔËÐÇ[100%³É¹¦ÂÊ]", SYSTEM_ERROR, TO_ME);
			iSuccess = 1;
		}
	}

	if(iSuccess == 1)						// ÇØ´ç ¹øÂ°ÀÇ ¼º°ø·üº¸´Ù ÀÛÀ¸¸é
	{	
		m_UserItem[sSlot].tMagic[5] = tCount + 1;	// ¸¶Áö¸· ½½·Ô¿¡ ¼º°øÈ½¼ö¸¦ Áõ°¡ ½ÃÅ²´Ù.
		//m_UserItem[sSlot].tMagic[4] = (BYTE)((tCount + 1) * last);
		
		MakeItemLog( &m_UserItem[sSlot], ITEMLOG_UPGRADE_SUCCESS );
	}
	else
	{ 
		MakeItemLog( &m_UserItem[sSlot], ITEMLOG_UPGRADE_FAIL );
		ReSetItemSlot(&m_UserItem[sSlot]);	iSuccess = 0; 
	}	

	FlushItemLog( TRUE );
	return iSuccess;
}

////////////////////////////////////////////////////////////////////////////////////////
//	Ê×ÊÎÉý¼¶
///////////////////////////////////////////////////////////////////////////////////////
void USER::UpgradeAccessoriReq(TCHAR *pBuf)
{
if(m_dwDN < ACCESSORI_UPGRADE_COST) 
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}
	//////////////////////////½»Ò×ÃÜÂë
	if(!m_MItemLock && o_yehuoini[0]->mimabaohu == 1)
	{
        SendSystemMsg( "ÇëÏÈ½â³ýÃÜÂë±£»¤ºóÔÚ²Ù×÷", SYSTEM_ERROR, TO_ME);
		return;
	}
	/////////////////// 

//	int iSid = 0;
//	int iIQ = -1;
	int iSid = -1;
	int iCount = 0;
	int i, j, index = 0;
	int iWeight = 0;
	short sMaterialSlot[4] = {-1, -1, -1, -1};
	short sSid[4] = {-1, -1, -1, -1};
	short sAid = 0;
	short sMagicSid = 0;
	int iSuccess = 0;
	BYTE bySlot = 0;

	int	iRandom, iMagicRandom, iCrestRandom, iCrestCount = 0;
	int iUpgradeCount = 0, iAllSkill = 0;
	BOOL bUseCrest = 0;

	CByteArray arMaterial;
	arMaterial.RemoveAll();

	short sAccessori = -1, sRipel = -1;				// 5¾÷ ÀÌ»ó ¸µ¿¡ ´ëÇØ¼­ ÁØºñÇÑ´Ù.

	short sSlot = GetShort(pBuf, index);			// ¼±ÅÃÇÑ ¾ÆÀÌÅÛ ½½·Ô¹øÈ£
//	if(sSlot != -1) return;							// ¾×¼¼¼­¸®´Â ¼Ò½º°¡ ¾ø´Ù.
	if(sSlot != -1)									// 5¾÷ÀÌ»óÀÎÁö
	{
		short sTemp = -1;
		if(sSlot < EQUIP_ITEM_NUM || sSlot >= TOTAL_INVEN_MAX) return;
		sTemp = m_UserItem[sSlot].sSid;
		if(sTemp < 0 || sTemp >= g_arItemTable.GetSize()) return;

		if(g_arItemTable[sTemp]->m_byWear <= 5 || g_arItemTable[sTemp]->m_byWear >= 9) return;

		if(m_UserItem[sSlot].tMagic[5] <= 4) 
		{
			SendSystemMsg(IDS_USER_ACCESSORI_INVALID, SYSTEM_ERROR, TO_ME);	// 5¾÷ ÀÌÇÏÀÇ ¾ÆÀÌÅÛÀº ¸®ÆçÀÇÁ¶°¢, ¹®ÀåÀ¸·Î ¾÷±×·¹ÀÌµå ÇÏÁö ¾Ê´Â´Ù.
			return;		
		}

        if( iSid == 818 || iSid == 733 || iSid == 735 )  return;
		if(m_UserItem[sSlot].tMagic[5] > 7) return; // ÇÒ ¼öÀÖ´Â ¾÷±×·¹ÀÌµå´Â ÀÌ¹Ì ´ÙÇß´Ù.

		if(m_UserItem[sSlot].sDuration == 0)
		{
			SendSystemMsg( IDS_USER_ACCESSORI_OLD, SYSTEM_ERROR, TO_ME);
			return;
		}

		sSid[0] = sTemp;
		sAccessori = sSlot;

		sSlot = -1, sTemp = -1;
		sSlot = GetShort(pBuf, index);
		if(sSlot == -1) return;
		if(sSlot < EQUIP_ITEM_NUM || sSlot >= TOTAL_INVEN_MAX)	return;

		sTemp = m_UserItem[sSlot].sSid;
			if(sTemp != 798 && sTemp != 799 && sTemp != 800 && sTemp != 801 && sTemp != 802 )
					return;
		if(sTemp < 0 || sTemp >= g_arItemTable.GetSize()) 
		{
			SendSystemMsg(IDS_USER_ACCESSORI_RIPEL, SYSTEM_ERROR, TO_ME);	// ¸®ÆçÀÇ Á¶°¢ÀÌ³ª ¹®ÀåÀ» °¡Á® ¿À·¡µÎ.
			return;
		}

		sSid[1] = sTemp;
		sRipel = sSlot;

		iCount = 100;							// 5¾÷±Û ÀÌ»ó ¸µ¿¡ ´ëÇØ¼­ 100¹øÀ» ºÎ¿©ÇÑ´Ù.
	}
	else
	{	
		int magic_slot = -1;
		int dynamic_slot = -1;

		for(i = 0; i < 4; i++)							
		{
			sMaterialSlot[i] = GetShort(pBuf, index);
			if(sMaterialSlot[i] <= -1) break;
			if(sMaterialSlot[i] < EQUIP_ITEM_NUM || sMaterialSlot[i] >= TOTAL_INVEN_MAX) return;
			sSid[i] = m_UserItem[sMaterialSlot[i]].sSid;
			if(sSid[i] == -1)//³ö´í
				return ;
			if(g_arItemTable[sSid[i]]->m_byWear <= 5 || g_arItemTable[sSid[i]]->m_byWear >= 9) 
				if(sSid[i] != 798 || sSid[i] != 799 || sSid[i] != 800 || sSid[i] != 801 )
					return;

			if(sSid[i] < 0 || sSid[i] >= g_arItemTable.GetSize()) return;
			if(sSid[i] == SID_RING_OF_LIFE || sSid[i] == SID_NECKLACE_OF_SHIELD || sSid[i] == SID_EARRING_OF_PROTECT || sSid[i] == 755)
			{
				SendSystemMsg(IDS_USER_ACCESSORI_SKILLUP, SYSTEM_ERROR, TO_ME);	// ¾÷±×·¹ÀÌµå ÇÒ ¼ö ¾ø´Â ¾Ç¼¼»ç¸®
				return;
			}

			magic_slot = -1;
			dynamic_slot = -1;
			magic_slot = m_UserItem[sMaterialSlot[i]].tMagic[0];
			if(magic_slot < 0 || magic_slot >= g_arMagicItemTable.GetSize()) return;

			dynamic_slot = g_arMagicItemTable[magic_slot]->m_sSubType;	
			if(dynamic_slot < 0 || dynamic_slot >= MAGIC_COUNT) return;
			
			if(dynamic_slot == MAGIC_ALL_SKILL_UP)	// ÆÊÇÇ¿ÂÀÇ¸µ ¾÷±×·¹ÀÌµå ¸·±â
			{
				SendSystemMsg( IDS_USER_ACCESSORI_SKILLUP, SYSTEM_ERROR, TO_ME);				
				return;
			}

			iCount++;
		}

		for(i = 0; i < iCount; i++)
		{
			if(g_arItemTable[sSid[i]]->m_byWear >= 6 && g_arItemTable[sSid[i]]->m_byWear <= 8)
			{
				if(m_UserItem[sMaterialSlot[i]].sDuration == 0)
				{
					SendSystemMsg( IDS_USER_ACCESSORI_OLD, SYSTEM_ERROR, TO_ME);
					return;
				}
			}
		}
	}

	switch(iCount)
	{
	case 100:
/*		if(m_UserItem[sMaterialSlot[0]].tMagic[5] <= 4) 
		{
			SendSystemMsg(IDS_USER_ACCESSORI_INVALID, SYSTEM_ERROR, TO_ME);	// 5¾÷ ÀÌÇÏÀÇ ¾ÆÀÌÅÛÀº ¸®ÆçÀÇÁ¶°¢, ¹®ÀåÀ¸·Î ¾÷±×·¹ÀÌµå ÇÏÁö ¾Ê´Â´Ù.
			return;		
		}
		if(m_UserItem[sMaterialSlot[0]].tMagic[5] > 7) return; // ÇÒ ¼öÀÖ´Â ¾÷±×·¹ÀÌµå´Â ÀÌ¹Ì ´ÙÇß´Ù.
*/
/*		if(g_arItemTable[sSid[0]]->m_byWear >= 6 && g_arItemTable[sSid[0]]->m_byWear <= 8)
		{
			sAccessori = sMaterialSlot[0];
			sRipel = sMaterialSlot[1];
		}
		else
		{
			sAccessori = sMaterialSlot[1];
			sRipel = sMaterialSlot[0];
			sSid[3] = sSid[1];
			sSid[1] = sSid[0];
			sSid[0] = sSid[3];
		}
*/
		if(sAccessori == -1 || sRipel == -1) return;

		iRandom = myrand(1, 10000);
		iUpgradeCount = m_UserItem[sAccessori].tMagic[5] - 5;
		switch(m_UserItem[sRipel].sSid)
		{
		case RIPEL_TOP:
			if(iRandom <= g_ItemAccessoriUpgrade[iUpgradeCount])	// Upgrade Success;
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelTop.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelTop[iMagicRandom];
				iSuccess = 1;
			}
			else ReSetItemSlot(&m_UserItem[sAccessori]);		// Ugrade Fail

			break;
		case RIPEL_BOTTOM:
			if(iRandom <= g_ItemAccessoriUpgrade[iUpgradeCount])	// Upgrade Success;
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelBottom.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelBottom[iMagicRandom];
				iSuccess = 1;
			}
			else ReSetItemSlot(&m_UserItem[sAccessori]);		// Ugrade Fail

			break;
		case RIPEL_LEFT:
			if(iRandom <= g_ItemAccessoriUpgrade[iUpgradeCount])	// Upgrade Success;
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelLeft.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelLeft[iMagicRandom];
				iSuccess = 1;
			}
			else ReSetItemSlot(&m_UserItem[sAccessori]);		// Ugrade Fail

			break;
		case RIPEL_RIGHT:
			if(iRandom <= g_ItemAccessoriUpgrade[iUpgradeCount])	// Upgrade Success;
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelRight.GetSize() - 1);				
				sMagicSid = g_Ripel.m_arRipelRight[iMagicRandom];
				iSuccess = 1;
			}
			else ReSetItemSlot(&m_UserItem[sAccessori]);		// Ugrade Fail

			break;
		case RIPEL_CREST:
			if(m_UserItem[sAccessori].tMagic[5] != 5 || m_UserItem[sAccessori].sSid==755)
			{
				SendSystemMsg(IDS_USER_ACCESSORI_CREST, SYSTEM_ERROR, TO_ME);	// ¸®ÆçÀÇ¹®ÀåÀ¸·Î´Â 5¾÷ÀÇ ¾×¼¼¼­¸®¸¸ ¾÷±×·¹ÀÌµå ÇÒ ¼öÀÖ½À´Ï´Ù.
				return;
			}

			bUseCrest = TRUE;
			if(iRandom <= g_ItemAccessoriUpgrade[2])	// Upgrade Success;
			{
				while(1)
			{
				iCrestRandom = myrand(0, 100);
				if(iCrestRandom <= 15) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelTop.GetSize() - 1); 
				sMagicSid = g_Ripel.m_arRipelTop[iMagicRandom];
				m_UserItem[sAccessori].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom > 15 && iCrestRandom <= 20) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelBottom.GetSize() - 1); 
				sMagicSid = g_Ripel.m_arRipelBottom[iMagicRandom];
				m_UserItem[sAccessori].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom > 20 && iCrestRandom <= 30) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelLeft.GetSize() - 1); 
				sMagicSid = g_Ripel.m_arRipelLeft[iMagicRandom];
				m_UserItem[sAccessori].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom > 30 && iCrestRandom <= 49) 
			{
				iMagicRandom = myrand(0, g_Ripel.m_arRipelRight.GetSize() - 1); 
				sMagicSid = g_Ripel.m_arRipelRight[iMagicRandom];
				m_UserItem[sAccessori].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}
			if(iCrestRandom > 49 && iAllSkill == 0) //ËùÓÐ1¼¼ÄÜ
			{
				iAllSkill = 1;
				iMagicRandom = myrand(0, g_Ripel.m_arRipelCrest.GetSize() - 1);
				sMagicSid = g_Ripel.m_arRipelCrest[iMagicRandom];
				m_UserItem[sAccessori].tMagic[iCrestCount + 1] = (BYTE)sMagicSid;
				iCrestCount++;
			}

					if(iCrestCount >= 3) break;
				}

				m_UserItem[sAccessori].tMagic[5] += 3;
				m_UserItem[sAccessori].tIQ = RARE_ITEM;
				iSuccess = 1;
				//===============================================================ºÏ³ÉÊ×ÊÎÌáÐÑ
				
				/*if(m_UserItem[sAccessori].tMagic[0] == 137 || m_UserItem[sAccessori].tMagic[1] == 137 || m_UserItem[sAccessori].tMagic[2] == 137|| m_UserItem[sAccessori].tMagic[3] == 137)
				{ 
                     CString strMsg;
					strMsg.Format("Íæ¼Ò:[%s] ºÏ³É¡º 1¼¼ÄÜ %s ¡»", this->m_strUserID,g_arItemTable[m_UserItem[sAccessori].sSid]->m_strName );
                    m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				}*/
	//			if(m_UserItem[sAccessori].tMagic[0] == 137 || m_UserItem[sAccessori].tMagic[1] == 137 || m_UserItem[sAccessori].tMagic[2] == 137|| m_UserItem[sAccessori].tMagic[3] == 137)
	//			{ 
 //                   CString strMsg;
	//	            CString GoodsMagic;
	//	        for(int i = 0; i < 4; i++)
	//	       {
	//		if(m_UserItem[sAccessori].tMagic != 0)
	//		{
	//			GoodsMagic+=g_MagicArray[m_UserItem[sAccessori].tMagic[i]];
	//			GoodsMagic+=",";
	//		}
	//	}
 //                               
 //    strMsg.Format("Íæ¼Ò:¡¾%s¡¿ºÏ³É¡¾%s¡¿:", this->m_strUserID,g_arItemTable[m_UserItem[sAccessori].sSid]->m_strName );//¹«¸æÌáÊ¾
	//	strMsg+=GoodsMagic;
	//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
	//}
		if (iSuccess == 1) //×Ô¶¯Éý¼¶ÌáÐÑ
		{
			CString strMsg;
		    CString GoodsMagic;
			for(int i = 0; i < 4; i++)
			{
				if(m_UserItem[sAccessori].tMagic != 0)
				{
					GoodsMagic+=g_arMagicItemTable[m_UserItem[sAccessori].tMagic[i]]->m_strText;
			     	GoodsMagic+=",";
				}
			}
					strMsg.Format("%s:",g_arItemTable[m_UserItem[sAccessori].sSid]->m_strName );//¹«¸æÌáÊ¾
					strMsg+=GoodsMagic;
					m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL);
		}
//=============================================================================
				//=============================================================================
			}
			else
			{
				int K = 0;
				BYTE m_Slot = -1;
				for(m_Slot = 10; m_Slot < 34; m_Slot++)
				{	
					if(m_UserItem[m_Slot].sSid == 870)
					{
						if(m_UserItem[m_Slot].tIQ > 0)
						{
					      if(m_UserItem[m_Slot].sCount <= 1)
				              ReSetItemSlot(&m_UserItem[m_Slot]);
			              else m_UserItem[m_Slot].sCount -= 1;//×êÊ¯ÑÕÉ«´óÓÚ0µÄÒ²É¾³ý
						  SendSystemMsg("×¢Òâ:·Ç·¨[×êÊ¯],ÒÑÉ¾³ý!ÇëÁ¢¼´¸ü»»Õý³£[×êÊ¯]", SYSTEM_ERROR, TO_ME);
						}
						K = TRUE;
						break;
					}
					else
					{
						K = FALSE;
					}
				}
				if(K == TRUE)
				{
					RobItem(870,1);	//É¾³ý°××êÊ¯
					SendSystemMsg("×êÊ¯±£»¤,Ê×ÊÎ²»ÏûÊ§!", SYSTEM_ERROR, TO_ME);
				}
				else
				{
					ReSetItemSlot(&m_UserItem[sAccessori]);		// Ugrade Fail
                }
			  
			}
			break;
		default:
			SendSystemMsg(IDS_USER_ACCESSORI_RIPEL, SYSTEM_ERROR, TO_ME);	// ¸®ÆçÀÇ Á¶°¢ÀÌ³ª ¹®ÀåÀ» °¡Á® ¿À·¡µÎ.
			return;		
		}

		if(bUseCrest == FALSE && iSuccess == 1)
		{
			m_UserItem[sAccessori].tMagic[5]++;
			if(iUpgradeCount == 0) m_UserItem[sAccessori].tMagic[1] = (BYTE)sMagicSid;
			if(iUpgradeCount == 1) m_UserItem[sAccessori].tMagic[2] = (BYTE)sMagicSid;
			if(iUpgradeCount == 2) m_UserItem[sAccessori].tMagic[3] = (BYTE)sMagicSid;
			m_UserItem[sAccessori].tIQ = RARE_ITEM;
		}

		if(iSuccess == 0)
		{
			iWeight = g_arItemTable[sSid[0]]->m_byWeight + g_arItemTable[sSid[1]]->m_byWeight;
		}
		else if(iSuccess == 1)
		{
			iWeight = g_arItemTable[sSid[1]]->m_byWeight;
		}

		if(m_UserItem[sRipel].sCount <= 1) ReSetItemSlot(&m_UserItem[sRipel]);
		else							   m_UserItem[sRipel].sCount -= 1;
		
		if(m_dwDN > ACCESSORI_UPGRADE_COST) m_dwDN -= ACCESSORI_UPGRADE_COST;
		else m_dwDN = 0;

		arMaterial.Add((BYTE)sAccessori);
		arMaterial.Add((BYTE)sRipel);

		break;
	case 3:
		if(g_arItemTable[sSid[0]]->m_byWear < 6 || g_arItemTable[sSid[0]]->m_byWear > 8) return;	// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ ¾×¼¼¼­¸®°¡ ¾Æ´Ï¸é ¸®ÅÏ
		if(g_arItemTable[sSid[1]]->m_byWear < 6 || g_arItemTable[sSid[1]]->m_byWear > 8) return;	// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ ¾×¼¼¼­¸®°¡ ¾Æ´Ï¸é ¸®ÅÏ
		if(g_arItemTable[sSid[2]]->m_byWear < 6 || g_arItemTable[sSid[2]]->m_byWear > 8) return;	// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ ¾×¼¼¼­¸®°¡ ¾Æ´Ï¸é ¸®ÅÏ

		if(m_UserItem[sMaterialSlot[0]].tMagic[5] > 4) return;	

		if(m_UserItem[sMaterialSlot[0]].tMagic[5] != m_UserItem[sMaterialSlot[1]].tMagic[5] || 
		   m_UserItem[sMaterialSlot[0]].tMagic[5] != m_UserItem[sMaterialSlot[2]].tMagic[5] ||
		   m_UserItem[sMaterialSlot[1]].tMagic[5] != m_UserItem[sMaterialSlot[2]].tMagic[5] ) return;	// °°Àº ¾÷±×·¹ÀÌµå ¼ö°¡ ¾Æ´Ï¸é ¸®ÅÏ

		if(m_UserItem[sMaterialSlot[0]].tMagic[0] != m_UserItem[sMaterialSlot[1]].tMagic[0] || 
		   m_UserItem[sMaterialSlot[0]].tMagic[0] != m_UserItem[sMaterialSlot[2]].tMagic[0] ||
		   m_UserItem[sMaterialSlot[1]].tMagic[0] != m_UserItem[sMaterialSlot[2]].tMagic[0] ) return;	// °°Àº ´É·ÂÄ¡ÀÇ ¾ÆÀÌÅÛÀÌ ¾Æ´Ï¸é ¸®ÅÏ


		iWeight += (g_arItemTable[sSid[0]]->m_byWeight + g_arItemTable[sSid[1]]->m_byWeight);



		sMagicSid = m_UserItem[sMaterialSlot[0]].tMagic[0];

		sAid = g_arMagicItemTable[sMagicSid]->m_sAid;

		if(sAid + 1 >= g_arAccessoriUpTable.GetSize()) return;

		m_UserItem[sMaterialSlot[0]].tMagic[0] = g_arAccessoriUpTable[sAid + 1]->m_sSid;

		ReSetItemSlot(&m_UserItem[sMaterialSlot[1]]);
		ReSetItemSlot(&m_UserItem[sMaterialSlot[2]]);

		if(m_UserItem[sMaterialSlot[0]].tMagic[5] == 0) m_UserItem[sMaterialSlot[0]].tMagic[5] = 2;
		else m_UserItem[sMaterialSlot[0]].tMagic[5]++;

		if(m_dwDN > ACCESSORI_UPGRADE_COST) m_dwDN -= ACCESSORI_UPGRADE_COST;
		else m_dwDN = 0;

		arMaterial.Add((BYTE)sMaterialSlot[0]);
		arMaterial.Add((BYTE)sMaterialSlot[1]);
		arMaterial.Add((BYTE)sMaterialSlot[2]);

		iSuccess = 1;

		break;
	default:
		return ;
	}

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...
	
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

	CBufferEx TempBuf;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	if(iSuccess == 1)	TempBuf.Add(SUCCESS);
	else				TempBuf.Add(FAIL);
	TempBuf.Add((BYTE)arMaterial.GetSize());

	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		bySlot = (BYTE)arMaterial[i];
		
		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}

	Send(TempBuf, TempBuf.GetLength());

	arMaterial.RemoveAll();
}
//////////////////////////////////////////
//»Æ½ðÁé  ½ðÊ¯
void USER::UpgradeHJItemReq(TCHAR *pBuf)
{
	if(!m_MItemLock && o_yehuoini[0]->mimabaohu == 1)
	{
        SendSystemMsg( "ÇëÏÈ½â³ýÃÜÂë±£»¤ºóÔÚ²Ù×÷", SYSTEM_ERROR, TO_ME);
		return;
	}
	int iSid = -1;
	int iIQ = -1;
	int iCount = 0, iThings = 0;
	int i, j, index = 0;
	int iWeight = 0;
	short sMaterialSlot;
	int isMagic = 0;

	int iSuccess = 0;

	BYTE tWear = 0;
	BYTE tIQ = 0, bySlot = 0;

	CBufferEx TempBuf;

	ItemList	MyItem[TOTAL_ITEM_NUM];

	CByteArray arMaterial;
	arMaterial.RemoveAll();
	sMaterialSlot = GetShort(pBuf, index);					//»Æ½ðÊ¯Í·
	short sSourceSlot = GetShort(pBuf, index);				// ×°±¸


	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;

	if(m_dwDN < 100000)
	{
		SendSystemMsg( "¾öÕ½±Ò²»×ã!Ê¹ÓÃ»Æ½ðÊ¯Í·Éý¼¶Ðè10Íò", SYSTEM_ERROR, TO_ME);
		return ;		 
	}
    iSid = m_UserItem[sSourceSlot].sSid;
	if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return;
	if( iSid == 669 || iSid == 670 )						
	{
		SendSystemMsg( IDS_USER_CANT_UPGRADE_ITEM, SYSTEM_ERROR, TO_ME);
		return;
	}	
	if(g_arItemTable[iSid]->m_byWear >= 6 && (g_arItemTable[iSid]->m_byWear!=122) && (g_arItemTable[iSid]->m_byWear!=123) 
		&& (g_arItemTable[iSid]->m_byWear!=124) && (g_arItemTable[iSid]->m_byWear!=125))
		return;
	if ( m_UserItem[sSourceSlot].tMagic[5] != 6  &&  g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_byRLevel < 100 )
	{
		SendSystemMsg( "Ö»ÄÜ¸Ä6¸ÄµÀ¾ß", SYSTEM_ERROR, TO_ME);
		return;
	}
	iIQ = m_UserItem[sSourceSlot].tIQ;
	
	
	for(i = 0; i < TOTAL_ITEM_NUM; i++)			// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

									
	

	if(sMaterialSlot >= EQUIP_ITEM_NUM && sMaterialSlot < TOTAL_INVEN_MAX)
	{
		iSid = MyItem[sMaterialSlot].sSid;
		/////////////////////»Æ½ðÎäÆ÷BUG
		if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return; //·ÀÖ¹ÎÞÀµ´òÎÒÖ÷³ÌÐò
		tWear = g_arItemTable[iSid]->m_byWear;
		int sSourcebyWear =  g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_byWear;
		if(tWear != BLESSING_WEAPONLESS_WEAR && tWear != BLESSING_ARMORLESS_WEAR) return;

		if((tWear == BLESSING_WEAPONLESS_WEAR) && (sSourcebyWear !=1)) return;
		if((tWear == BLESSING_ARMORLESS_WEAR) && (sSourcebyWear ==1)) return;
           ///////////////////////////////////////////////////////////////


		if(MyItem[sMaterialSlot].sCount <= 0) return;

		iWeight += g_arItemTable[iSid]->m_byWeight;

		MyItem[sMaterialSlot].sCount -= 1;
		arMaterial.Add((BYTE)sMaterialSlot);
	}
	else return;
	if( m_dwDN <= 100000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 100000;
	UpdateUserItemDN();						
	SendMoneyChanged();


	int random = myrand(1,10000);
	if(random <= 10000 && random >=9500)			//+4¸Ä
	{
		m_UserItem[sSourceSlot].tMagic[5] +=4;
		if (m_UserItem[sSourceSlot].tMagic[5] > 10)
			m_UserItem[sSourceSlot].tMagic[5] = 10;
		iSuccess = 1;
	}
	else if (random < 9500 && random >=8500)
	{
		m_UserItem[sSourceSlot].tMagic[5] +=3;
		if (m_UserItem[sSourceSlot].tMagic[5] > 10)
			m_UserItem[sSourceSlot].tMagic[5] = 10;
		iSuccess = 1;
	}
	else if (random < 8500 && random >=6000)
	{
		m_UserItem[sSourceSlot].tMagic[5] +=2;
		if (m_UserItem[sSourceSlot].tMagic[5] > 10)
			m_UserItem[sSourceSlot].tMagic[5] = 10;
		iSuccess = 1;
	}
	else if (random < 6000 && random >=0)
	{
		m_UserItem[sSourceSlot].tMagic[5] +=1;
		if (m_UserItem[sSourceSlot].tMagic[5] > 10)
			m_UserItem[sSourceSlot].tMagic[5] = 10;
		iSuccess = 1;
	}
	else 
	{
		iSuccess = 0;
	//	SendSystemMsg( "DEBUGÇ¿»¯Ê§°Ü!", SYSTEM_ERROR, TO_ME);
	}
    
	
    TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = 1 + arMaterial.GetSize();

	if(!iSuccess)	TempBuf.Add((BYTE)0x00); //½ÇÆÐ
	else			TempBuf.Add((BYTE)0x01);
	int iUp = m_UserItem[sSourceSlot].tMagic[5];
	//if( iSuccess = 1 && iUp >=8 )
	//	{
	//		CString sysMsg;                                               //  m_UserItem[sSourceSlot].tMagic
 //           sysMsg.Format("Íæ¼Ò %s ½«ÎïÆ· [%s]Ç¿»¯Îª %d ¼¶ ! ",this->m_strUserID,g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_strName ,iUp );
 //           SendSystemMsg(sysMsg.GetBuffer(sysMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
	//   }
	//================================================================================================×°±¸±äÍâ¹Û
	if(iUp >=1)
	{
		switch(m_UserItem[sSourceSlot].sSid)
		{
		case 337://ÁúÖ®Òí
			m_UserItem[sSourceSlot].sSid = 1581;//±Ó»¤Ö®Òí
			break;
		case 510://Ç¿»¯ÁúÖ®Òí
		case 511://Ç¿»¯ÁúÖ®Òí
		case 512://Ç¿»¯ÁúÖ®Òí
			m_UserItem[sSourceSlot].sSid = 1582;//Ç¿»¯±Ó»¤Ö®Òí
			break;
		case 513://ÁúÖ®Òís
		case 514://ÁúÖ®Òís
			m_UserItem[sSourceSlot].sSid = 1583;//±Ó»¤Ö®Òís
			break;

			
		case 330://ÁúÖ®Å­
			m_UserItem[sSourceSlot].sSid = 1578; //ÁéèÑ·¨ÕÈ
			break;
		case 475://Ç¿»¯ÁúÖ®Å­
		case 476://Ç¿»¯ÁúÖ®Å­
		case 477://Ç¿»¯ÁúÖ®Å­
			m_UserItem[sSourceSlot].sSid = 1579; //Ç¿»¯ÁéèÑ·¨ÕÈ
			break;
		case 478://ÁúÉñÖ®Å­¡ªS
		case 479://ÁúÉñÖ®Å­¡ªS
			m_UserItem[sSourceSlot].sSid = 1580;//ÁéèÑ·¨ÕÈs
			break;



		case 323://·´I
			m_UserItem[sSourceSlot].sSid = 1572;//·´1
			break;
		case 440://·´II
		case 441://·´II
		case 442://·´II
			m_UserItem[sSourceSlot].sSid = 1573;//·´2
			break;
		case 443://·´III
		case 444://·´III
			m_UserItem[sSourceSlot].sSid = 1574;//·´3
			break;



		case 316://ÁúÉñÅÚg2
			m_UserItem[sSourceSlot].sSid = 1575;
			break;
		case 405://ÁúÉñÅÚg4
		case 406://ÁúÉñÅÚg4
		case 407://ÁúÉñÅÚg4
			m_UserItem[sSourceSlot].sSid = 1576;//·´1
			break;
		
		case 408://ÁúÉñÅÚg6
		case 409://ÁúÉñÅÚg6
		   m_UserItem[sSourceSlot].sSid = 1577;
		   break;
		}
	}
	if( iSuccess = 1 && iUp >= 1  )
	{
		if ( g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_byWear == 1 )
		{
			CString sysMsg;                                             
            sysMsg.Format(" %s Ê¹ÓÃ»Æ½ðÁéÊ¯½« [%s]Ç¿»¯Îª %d ¼¶ ! ",this->m_strUserID,g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_strName ,iUp );
            SendSystemMsg(sysMsg.GetBuffer(sysMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
		}else{
			CString sysMsg;                                              
            sysMsg.Format(" %s Ê¹ÓÃ»Æ½ð¾§Ê¯½« [%s]Ç¿»¯Îª %d ¼¶ ! ",this->m_strUserID,g_arItemTable[m_UserItem[sSourceSlot].sSid]->m_strName ,iUp );
            SendSystemMsg(sysMsg.GetBuffer(sysMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
		}
	}

	TempBuf.Add((BYTE)index);

	TempBuf.Add((BYTE)sSourceSlot);					// ÁÖ ¾ÆÀÌÅÛ¸¦ ¸ÕÀú 	
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 

	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		bySlot = (BYTE)arMaterial[i];

		MakeItemLog( &m_UserItem[bySlot], ITEMLOG_BLESS_USE );
		FlushItemLog( TRUE );

		if(m_UserItem[bySlot].sCount <= 1) ReSetItemSlot(&m_UserItem[bySlot]);// ¼Òºñ¼º ÀÌ¹Ç·Î ¸ÕÀú ÃÊ±âÈ­ÇÏ°í 
		else							   m_UserItem[bySlot].sCount -= 1;

		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

	Send(TempBuf, TempBuf.GetLength());

	arMaterial.RemoveAll();			

			
}
//»úÐµ²ÄÁÏ
void USER::EbodyMatrial(int sSourceSlot)								
{
	//ÅÐ¶ÏÎ»ÖÃ
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX)
		return;
	short sSid = m_UserItem[sSourceSlot].sSid;
	if(sSid <0||sSid>g_arItemTable.GetSize())
		return;
	if(!IsEbodyItem(sSid))
		return;	
	if( m_UserItem[sSourceSlot].tMagic[5]<7)
	{
		return;
	}
	if(m_UserItem[sSourceSlot].tIQ!=2)
		return ;

	if(m_dwDN < 200000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}

	if( m_dwDN <= 200000 ) 
		m_dwDN = 0;
	else 
		m_dwDN = m_dwDN - 200000;

	m_UserItem[sSourceSlot].tMagic[MAGIC_100_ADD_POS]=1;

	//m_UserItem[sSourceSlot].tIQ = SUPER_EBODY_ITEM;
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)9);
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)sSourceSlot);
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) 
		TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 
	Send(TempBuf, TempBuf.GetLength());
}

//»úÐµÈ¡Ïû²ÄÁÏ»¯
void USER::EbodyCancelMetral(int sSourceSlot)								
{
	//ÅÐ¶ÏÎ»ÖÃ
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX)
		return;
	short sSid = m_UserItem[sSourceSlot].sSid;
	if(sSid <0||sSid>g_arItemTable.GetSize())
		return;
	if(!IsEbodyItem(sSid))
		return;	
	if( m_UserItem[sSourceSlot].tMagic[5]<7)
	{
		return;
	}
	if(m_UserItem[sSourceSlot].tIQ!=2)
		return ;
	if(m_UserItem[sSourceSlot].tMagic[6]!=1)
		return ;

	if(m_dwDN < 200000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		// °ø°Ý¿ë ¾÷±×·¹ÀÌµå ºñ¿ëº¸´Ù ÀÛÀ¸¸é 
	}

	if( m_dwDN <= 200000 ) 
		m_dwDN = 0;
	else 
		m_dwDN = m_dwDN - 200000;

	m_UserItem[sSourceSlot].tMagic[MAGIC_100_ADD_POS]=0;

	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

	CBufferEx TempBuf;
	int j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	TempBuf.Add((BYTE)10);
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)sSourceSlot);
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);

	for(j =0; j < MAGIC_NUM; j++) 
		TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 
	Send(TempBuf, TempBuf.GetLength());
}
////////////////////////////////////////////////////////////////////////////
void USER::ItemExchange(TCHAR *pBuf) //E UPGRADE_OPEN 24 37 
{
	int index=0,sSid;
	short Slot = GetShort(pBuf, index);//
	short Slot1 = GetShort(pBuf, index);//
	short Slot2 = GetShort(pBuf, index);//
	short Slot3 = GetShort(pBuf, index);//
	short Slot4 = GetShort(pBuf, index);//
	short newSlot= GetEmptySlot(INVENTORY_SLOT);
	CUIntArray arMaterial;

	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;
	if((Slot1!=-1) && (Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX))return;
	if((Slot2!=-1) && (Slot2 < EQUIP_ITEM_NUM || Slot2 >= TOTAL_INVEN_MAX))return;
	if((Slot3!=-1) && (Slot3 < EQUIP_ITEM_NUM || Slot3 >= TOTAL_INVEN_MAX))return;
	if((Slot4!=-1) && (Slot4 < EQUIP_ITEM_NUM || Slot4 >= TOTAL_INVEN_MAX))return;
	if(m_UserItem[Slot].sSid==-1) return;

	if((Slot != -1) && (m_UserItem[Slot].sSid < 0 || m_UserItem[Slot].sSid >= g_arItemTable.GetSize())) return;
	if((Slot1 != -1) && (m_UserItem[Slot1].sSid < 0 || m_UserItem[Slot1].sSid >= g_arItemTable.GetSize())) return;

	//5¾§ÁéÊ¯ºÏ³ÉÒ»¸ö³¬¾§Áé  ·ÑÓÃ10W
	if(m_UserItem[Slot].sSid==847 || m_UserItem[Slot].sSid==848){
		if(m_UserItem[Slot].sCount<5) return ;
		if(m_UserItem[Slot].sCount==5) newSlot=Slot;
		if(newSlot==-1) {SendSystemMsg( "Ã»ÓÐ×ã¹»Î»ÖÃ´æ·ÅÐÂÆ·", SYSTEM_NORMAL, TO_ME); return ;};

		if(m_dwDN < 100000)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
			return ;		
		}
		if( m_dwDN <= 100000 ) m_dwDN = 0;
		else m_dwDN = m_dwDN - 100000;
		SendMoneyChanged();

		sSid=m_UserItem[Slot].sSid-2;
		m_UserItem[Slot].sCount=m_UserItem[Slot].sCount-5;

		if(m_UserItem[Slot].sCount==0){
			ReSetItemSlot(&m_UserItem[Slot]);
		}
		ReSetItemSlot(&m_UserItem[newSlot]);
		if (sSid < 0 || sSid >= g_arItemTable.GetSize()) return;


		m_UserItem[newSlot].sLevel = g_arItemTable[sSid]->m_byRLevel;
		m_UserItem[newSlot].sSid = sSid;
		m_UserItem[newSlot].sCount = 1;
		m_UserItem[newSlot].sDuration = g_arItemTable[sSid]->m_sDuration;
		m_UserItem[newSlot].sBullNum = 0;
		m_UserItem[newSlot].tIQ = 0;
		m_UserItem[newSlot].iItemSerial = 0;

		arMaterial.Add(Slot);
		if(Slot!=newSlot) arMaterial.Add(newSlot);
	}else if(g_arItemTable[m_UserItem[Slot].sSid]->m_byWear>=122 && g_arItemTable[m_UserItem[Slot].sSid]->m_byWear<=125 ){
		if(Slot1==-1) return ;
		if(g_arItemTable[m_UserItem[Slot1].sSid]->m_byWear<122 || g_arItemTable[m_UserItem[Slot1].sSid]->m_byWear>125)
			return ;
		if(m_dwDN < 2000000)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
			return ;		
		}
		if( m_dwDN <= 2000000 ) m_dwDN = 0;
		else m_dwDN = m_dwDN - 2000000;
		SendMoneyChanged();
		ReSetItemSlot(&m_UserItem[Slot]);
		ReSetItemSlot(&m_UserItem[Slot1]);
		newSlot=Slot;

		int tEBodySid,i;
		int iRandom = myrand(1, 1000);             
		for(i = 0; i < g_arEBodyTable.GetSize(); i++)
		{
			if(iRandom <= g_arEBodyTable[i]->m_sRandom) 
			{
				tEBodySid = g_arEBodyTable[i]->m_tSid;
				break;
			}	
		}
		m_UserItem[newSlot].sLevel = g_arItemTable[907]->m_byRLevel;
		m_UserItem[newSlot].sSid = 907;
		m_UserItem[newSlot].sCount = 1;
		m_UserItem[newSlot].sDuration = g_arItemTable[907]->m_sDuration;
		m_UserItem[newSlot].sBullNum = 0;
		m_UserItem[newSlot].tMagic[0]=tEBodySid;
		
		m_UserItem[newSlot].tIQ = 2;
		m_UserItem[newSlot].iItemSerial = 0;

		arMaterial.Add(Slot);
		arMaterial.Add(Slot1);
		

	}else if(g_arItemTable[m_UserItem[Slot].sSid]->m_byWear==126){
		//2ï¯Ê¯ºÏ³ÉÒ»¸öÑ©»ê·ÑÓÃ100W
		if(Slot1==-1) return;
		if(g_arItemTable[m_UserItem[Slot1].sSid]->m_byWear!=126) return ;
		if(m_dwDN < 500000)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
			return ;		
		}
		if( m_dwDN <= 500000 ) m_dwDN = 0;
		else m_dwDN = m_dwDN - 500000;
		SendMoneyChanged();
		ReSetItemSlot(&m_UserItem[Slot]);
		ReSetItemSlot(&m_UserItem[Slot1]);
		newSlot=Slot;

		m_UserItem[newSlot].sLevel = g_arItemTable[908]->m_byRLevel;
		m_UserItem[newSlot].sSid = 908;
		m_UserItem[newSlot].sCount = 1;
		m_UserItem[newSlot].sDuration = g_arItemTable[908]->m_sDuration;
		m_UserItem[newSlot].sBullNum = 0;
		m_UserItem[newSlot].tIQ = 0;
		m_UserItem[newSlot].iItemSerial = 0;
		arMaterial.Add(Slot);
		arMaterial.Add(Slot1);

	}else{
		return ;
	}
	//·¢ËÍ½á¹û

	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)8);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
}
/// -->ÊôÐÔ±ä¸ü
////////////////////////////////////////////////////////////////////////////
void USER::UpgradeItemAttrReq(short sSourceSlot,short sMaterialSlot)
{
	
	
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;
	int iSid = m_UserItem[sSourceSlot].sSid;
	if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return;
	
	if(g_arItemTable[iSid]->m_byWear >= 6 && (g_arItemTable[iSid]->m_byWear!=122) && (g_arItemTable[iSid]->m_byWear!=123) 
		 && (g_arItemTable[iSid]->m_byWear!=124) && (g_arItemTable[iSid]->m_byWear!=125))
		 return;

	if(m_UserItem[sMaterialSlot].sSid == 1286 && g_arItemTable[iSid]->m_byWear != 1)
	{
		SendSystemMsg("·ÅÈëµÄµÀ¾ß²»ÊÇÎäÆ÷!",SYSTEM_ERROR,TO_ME);
		return ;
	}
	if(m_UserItem[sMaterialSlot].sSid == 1287 && g_arItemTable[iSid]->m_byWear == 1)
	{
		SendSystemMsg("·ÅÈëµÄµÀ¾ß²»ÊÇ·À¾ß!",SYSTEM_ERROR,TO_ME);
		return ;
	}
	if(m_UserItem[sSourceSlot].tMagic[5] < 10)
	{
		SendSystemMsg("±ØÐëÊÇ+10(°üº¬+10)ÒÔÉÏµÀ¾ß²Å¿É±ä¸üÊôÐÔ!",SYSTEM_ERROR,TO_ME);
		return;
	}
	int iFindAttrId = 0;
	switch(m_UserItem[sMaterialSlot].tMagic[0])
	{
	case 162: //Á¦Á¿15
		iFindAttrId = 161;//10Á¦Á¿
		break;
	case 158: //Ãô½Ý15
		iFindAttrId = 157;//10Ãô½Ý
		break;
	case 156: //ÌåÖÊ15
		iFindAttrId = 155;//10ÌåÖÊ
		break;
	case 164: //ÖÇ»Û15
		iFindAttrId = 163;//10ÖÇ»Û
		break;
	case 166: //ÖÇÁ¦15
		iFindAttrId = 165;//10ÖÇÁ¦
		break;
	case 193://150Ñª
		iFindAttrId = 159;//100Ñª
		break;
	case 190://50¿¹
		iFindAttrId = 135;//25¿¹
		break;
    case 195://¾­Ñé30%Ôö¼Ó
		iFindAttrId = 154;//15%»Ø±Ü
		break;
	case 194://50·À
		iFindAttrId = 130;//10·ÀÓù
		break;
	case 161://10Á¦Á¿
		iFindAttrId = 107;//5Á¦Á¿
		break;
	case 157://10Ãô½Ý
		iFindAttrId = 109;//5Ãô½Ý
		break;
	case 163://10ÖÇ»Û
		iFindAttrId = 110;//5ÖÇ»Û
		break;
	default:
		return ;
	}
	int FindAttrSlot = -1;

	for(int i = 0; i<5;i++)
	{
		if(m_UserItem[sSourceSlot].tMagic[i] == iFindAttrId)
		{
			FindAttrSlot = i;
			break;
		}
	}
	if(FindAttrSlot == -1)
	{
		SendSystemMsg("Ã»ÓÐÕÒµ½Æ¥ÅäµÄÊôÐÔ,ÊôÐÔ±ä¸üÊ§°Ü!",SYSTEM_ERROR,TO_ME);
		return;
	}
	//¼õÈ¥Ç®
	if( m_dwDN <= 5000000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 5000000;
	UpdateUserItemDN();						
	SendMoneyChanged();	

	int iRandom = myrand(1, 10000);

	CBufferEx TempBuf;
	TempBuf.Add(UPGRADE_ITEM_RESULT);

	if(iRandom >(10000*0.6f))   //Ê§°ÜÂÊ ÊýÖµÔ½Ð¡ ³É¹¦ÂÊÔ½µÍ
	{ //Ê§°Ü
		TempBuf.Add((BYTE)0x00);
		m_UserItem[sSourceSlot].tMagic[5]--;
	}
	else
	{
		TempBuf.Add((BYTE)0x01);
		m_UserItem[sSourceSlot].tMagic[FindAttrSlot] = m_UserItem[sMaterialSlot].tMagic[0];
	}
	ReSetItemSlot(&m_UserItem[sMaterialSlot]);

	TempBuf.Add((BYTE)2);

	TempBuf.Add((BYTE)sSourceSlot);					
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);
	for(int j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 

	TempBuf.Add((BYTE)sMaterialSlot);
	TempBuf.Add(m_UserItem[sMaterialSlot].sLevel);
	TempBuf.Add(m_UserItem[sMaterialSlot].sSid);
	TempBuf.Add(m_UserItem[sMaterialSlot].sDuration);
	TempBuf.Add(m_UserItem[sMaterialSlot].sBullNum);
	TempBuf.Add(m_UserItem[sMaterialSlot].sCount);
	for(int j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sMaterialSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sMaterialSlot].tIQ); 

	GetRecoverySpeed();							

	Send(TempBuf, TempBuf.GetLength());
}
void USER::UpgradeBlessingItemReq(TCHAR *pBuf, int type)
{
	if(!m_MItemLock && o_yehuoini[0]->mimabaohu == 1)
	{
        SendSystemMsg( "ÇëÏÈ½â³ýÃÜÂë±£»¤ºóÔÚ²Ù×÷", SYSTEM_ERROR, TO_ME);
		return;
	}
	int iSid = -1,iMaterialSid = -1;
	int iIQ = -1;
	int sSourcebyWear = -1;
    int iCount = 0, iThings = 0;
	int i, j, index = 0;
	int iWeight = 0;
	short sMaterialSlot;

	int iSuccess = 0;

	BYTE tWear = 0;
	BYTE tIQ = 0, bySlot = 0;

	CBufferEx TempBuf;

	ItemList	MyItem[TOTAL_ITEM_NUM];

	CByteArray arMaterial;
	arMaterial.RemoveAll();

	short sSourceSlot = GetShort(pBuf, index);				// ¼±ÅÃÇÑ ¾ÆÀÌÅÛ ½½·Ô¹øÈ£

	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;

	iSid = m_UserItem[sSourceSlot].sSid;
	if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return;
	if( iSid == 669 || iSid == 670 )						// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ ±Û·¯±×Á¾·ù¶ó¸é
	{
		SendSystemMsg( IDS_USER_CANT_UPGRADE_ITEM, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(g_arItemTable[iSid]->m_byWear >= 6 && (g_arItemTable[iSid]->m_byWear!=122) && (g_arItemTable[iSid]->m_byWear!=123) 
		 && (g_arItemTable[iSid]->m_byWear!=124) && (g_arItemTable[iSid]->m_byWear!=125))
		 return;
    sSourcebyWear = g_arItemTable[iSid]->m_byWear;
    iIQ = m_UserItem[sSourceSlot].tIQ;
	switch(iIQ)
	{
	case NORMAL_ITEM:
		break;
	case MAGIC_ITEM:
		iCount = 1;
		iThings = MATERIAL_MAGIC_UP_ITEM;
		break;
	case RARE_ITEM:
		iCount = 1;
		iThings = MATERIAL_RARE_UP_ITEM;
		break;
	case REMODEL_ITEM:
	case REMODEL_MAGIC_ITEM:
		iCount = 2;
		iThings = MATERIAL_REMODEL_UP_ITEM;
		break;
	case 12: //ÆÕÍ¨°Ù¼¶
		iCount = 1;
		iThings = MATERIAL_RARE_UP_ITEM;
		break;
	case 15://³¬¼¶»úÐµ
		iCount = 4;
		iThings = MATERIAL_EBODY_UP_ITEM;
		break;
	case 18: //130Ì×
		iCount = 1;
		iThings = MATERIAL_RARE_UP_ITEM;
		break;
	default:
		return;
	}
	
    if( (g_arItemTable[iSid]->m_byWear==122) || (g_arItemTable[iSid]->m_byWear==123) 
		|| (g_arItemTable[iSid]->m_byWear==124) || (g_arItemTable[iSid]->m_byWear==125))
	{
			iCount = 2;
			iThings = MATERIAL_EBODY_UP_ITEM;
		if(IsSuperEbodyItem(iSid))
			iCount = 4;
//»úÐµÉíÌå15¸ÄÊÇÉÏÏÞ
		BYTE t = m_UserItem[sSourceSlot].tMagic[5];
		if(t >= 10) 
			return ;	
	}

		
	for(i = 0; i < TOTAL_ITEM_NUM; i++)			// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

	sMaterialSlot = -1;									
	sMaterialSlot = GetShort(pBuf, index);
	//¹ú·þ´Ë´¦Ôö¼ÓÁËÒ»¸ö¿Õ×Ö½Ú00
	BYTE bNull = GetByte(pBuf,index);
	if(sMaterialSlot >= EQUIP_ITEM_NUM && sMaterialSlot < TOTAL_INVEN_MAX)
	{
		iSid = MyItem[sMaterialSlot].sSid;

        if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return;
		//=================================================================Ìí¼ÓÊôÐÔ
		if(g_arItemTable[iSid]->m_sSid == 1188)
		{
			AddShuxing3PaiReq(sSourceSlot , sMaterialSlot);
			return;
		}
       //===============================================================

	    if(type == 2)
		{   
		//	if(iIQ==18)
		//	{
          //       SendSystemMsg("130¼¶×°±¸ÎäÆ÷Ö»ÄÜÓÃÍõÕß¾§Ê¯/ÍõÕßÁéÊ¯Ç¿»¯.", SYSTEM_ERROR, TO_ME);
			//     return; 
		    //}
			if(iSid != 845 && iSid != 846) return;
			tWear = g_arItemTable[iSid]->m_byWear;
			if(tWear != BLESSING_WEAPONLESS_WEAR && tWear != BLESSING_ARMORLESS_WEAR ) return;
			if((tWear == BLESSING_WEAPONLESS_WEAR) && (sSourcebyWear !=1)) return;
			if((tWear == BLESSING_ARMORLESS_WEAR) && (sSourcebyWear ==1)) return;
			if(m_dwDN < 100000)
		    {
			     SendSystemMsg( "¾öÕ½±Ò²»×ã!Ê¹ÓÃÉý¼¶µÀ¾ßÐèÒª10Íò!", SYSTEM_ERROR, TO_ME);
			     return;		
		    }

		     if( m_dwDN <= 100000 ) m_dwDN = 0;
		     else m_dwDN = m_dwDN - 100000;	
			 UpdateUserItemDN();						
	         SendMoneyChanged();
		}

		
		else if(type == 3)
		{
			if(iIQ==18)
			{
                 SendSystemMsg("130¼¶×°±¸ÎäÆ÷Ö»ÄÜÓÃÍõÕß¾§Ê¯/ÍõÕßÁéÊ¯Ç¿»¯.", SYSTEM_ERROR, TO_ME);
			     return; 
		    }
			if(iIQ==12) //°Ù¼¶²»ÄÜÓÃ¾§Ê¯ÁéÊ¯Éý¼¶
				return;
			if(iSid != 847 && iSid != 848) return;
			tWear = g_arItemTable[iSid]->m_byWear;
			if(tWear != NORMAL_WEAPONLESS_WEAR && tWear != NORMAL_ARMORLESS_WEAR) return;
			if((tWear == NORMAL_WEAPONLESS_WEAR || tWear == BLESSING_WEAPONLESS_WEAR) && (sSourcebyWear !=1)) return;
			if((tWear == NORMAL_ARMORLESS_WEAR || tWear == BLESSING_ARMORLESS_WEAR) && (sSourcebyWear ==1)) return;
			
			if(m_dwDN < 100000)
		    {
			     SendSystemMsg( "¾öÕ½±Ò²»×ã!Ê¹ÓÃ¾§Ê¯,ÁéÊ¯ÐèÒª10Íò!", SYSTEM_ERROR, TO_ME);
			     return;		
		    }

		     if( m_dwDN <= 100000 ) m_dwDN = 0;
		     else m_dwDN = m_dwDN - 100000;	
			 UpdateUserItemDN();						
	         SendMoneyChanged();
		}


		else if(type == 12)
		{
			tWear = g_arItemTable[iSid]->m_byWear;
			if(tWear != BLESSING_WEAPONLESS_WEAR && tWear != BLESSING_ARMORLESS_WEAR) return;
			if(g_arItemTable[iSid]->m_byRLevel>60)
				return;
		}else if(type==9)
		{
			if(iSid != 983 && iSid != 1669) return;
			tWear = g_arItemTable[iSid]->m_byWear;
			if(tWear != BLESSING_WEAPONLESS_WEAR && tWear != BLESSING_ARMORLESS_WEAR && tWear!=28) return;
			if((tWear == BLESSING_ARMORLESS_WEAR) && (sSourcebyWear ==1)) return;
			if(m_dwDN < 100000)
		    {
			     SendSystemMsg( "¾öÕ½±Ò²»×ã!Ê¹ÓÃ×£¸£±¦Ê¯ÐèÒª10Íò!", SYSTEM_ERROR, TO_ME);
			     return;		
		    }

		     if( m_dwDN <= 100000 ) m_dwDN = 0;
		     else m_dwDN = m_dwDN - 100000;	
			 UpdateUserItemDN();						
	         SendMoneyChanged();
		

		}else if(type==49)
		{
			if(iSid == 1287 || iSid == 1286)
			{
			  if(m_dwDN > 10000000)
		      {
				UpgradeItemAttrReq(sSourceSlot,sMaterialSlot);
				return;
			  }
			  else
			  {
                SendSystemMsg("Äú¾öÕ½±Ò²»×ã,±ä¸üÊôÐÔÐè1000Íò¾öÕ½±Ò!", SYSTEM_ERROR, TO_ME);
				return;
		      }
			}
			if(iSid != 1438 && iSid != 1437) return;
			tWear = g_arItemTable[iSid]->m_byWear;
			if(tWear != 182 && tWear!=183) return;
			if(m_dwDN < 200000)
		    {
			      SendSystemMsg( "¾öÕ½±Ò²»×ã!Ê¹ÓÃÍõÕßÊ¯Í·ÐèÒª20Íò!", SYSTEM_ERROR, TO_ME);
			     return;		
		    }

		     if( m_dwDN <= 200000 ) m_dwDN = 0;
		     else m_dwDN = m_dwDN - 200000;	
			 UpdateUserItemDN();						
	         SendMoneyChanged();
		}
		else return;

		if(MyItem[sMaterialSlot].sCount <= 0) return;

		iWeight += g_arItemTable[iSid]->m_byWeight;

		MyItem[sMaterialSlot].sCount -= 1;
		arMaterial.Add((BYTE)sMaterialSlot);
	}
	else return;
	if(type != 12){//12ÊÇÐäÕäÊ¯Í·¡£¡£²»ÐèÒªÉñÊ¯µÈ²ÄÁÏ¡£
		for(i = 0; i < iCount; i++)
		{
			sMaterialSlot = -1;
			sMaterialSlot = GetShort(pBuf, index);
			if(sMaterialSlot >= EQUIP_ITEM_NUM && sMaterialSlot < TOTAL_INVEN_MAX)
			{											
				iSid = MyItem[sMaterialSlot].sSid;
				if(iSid < 0 || iSid >= g_arItemTable.GetSize()) return;
				if(iSid != iThings) return;			
				if(MyItem[sMaterialSlot].sCount <= 0) return;

				iWeight += g_arItemTable[iSid]->m_byWeight;

				MyItem[sMaterialSlot].sCount -= 1;
				arMaterial.Add((BYTE)sMaterialSlot);
			}
			else
			{
				SendSystemMsg(IDS_USER_SHENGSHI, SYSTEM_ERROR, TO_ME);
				return;
			}
		}
	}
	iSuccess = SetBlessingUpgradeItem(sSourceSlot, type);	
	if(MyItem[sSourceSlot].tMagic[5] == 0 && iSuccess == 0) iWeight += g_arItemTable[iSid]->m_byWeight;			// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.

	if(iSuccess == -1) return;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = 1 + arMaterial.GetSize();

	if(!iSuccess)	TempBuf.Add((BYTE)0x00); //½ÇÆÐ
	else			TempBuf.Add((BYTE)0x01);
	
	TempBuf.Add((BYTE)index);

	TempBuf.Add((BYTE)sSourceSlot);					// ÁÖ ¾ÆÀÌÅÛ¸¦ ¸ÕÀú 	
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ); 

	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		bySlot = (BYTE)arMaterial[i];
	
		MakeItemLog( &m_UserItem[bySlot], ITEMLOG_BLESS_USE );
		FlushItemLog( TRUE );
	
		if(m_UserItem[bySlot].sCount <= 1) ReSetItemSlot(&m_UserItem[bySlot]);// ¼Òºñ¼º ÀÌ¹Ç·Î ¸ÕÀú ÃÊ±âÈ­ÇÏ°í 
		else							   m_UserItem[bySlot].sCount -= 1;

		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

	Send(TempBuf, TempBuf.GetLength());

	arMaterial.RemoveAll();
}

///////////////////////////////////////////////////////////////////////////////////////////////
//	¿þÇÇ, ¾Æ¸Ó, ¼öÆÛ¿þÇÇ, ¼öÆÛ¾Æ¸Ó·Î ¾÷±×·¹ÀÌµå ÇÒ¶§
//
int USER::SetBlessingUpgradeItem(short sSlot, int type)
{
	BYTE tCount = 0;

	int iSuccess = 0;

	int i = 0;
	int last = 0;
	int iRandom = 0;

	int iValue = 0;

	if(m_UserItem[sSlot].sSid < 0 || m_UserItem[sSlot].sSid >= g_arItemTable.GetSize()) return -1;
	if(g_arItemTable[m_UserItem[sSlot].sSid]->m_sDuration <= 0) return -1;
	
	tCount = m_UserItem[sSlot].tMagic[5];
	if(tCount >= MAX_ITEM_UPGRADE_COUNT) return -1;		

	if(g_arItemTable[m_UserItem[sSlot].sSid]->m_byWear == ATTACK_ITEM)//ÎäÆ÷Éý¼¶
	{
		if(type==9)//×£¸£±¦Ê¯¡£²»ÄÜÉý¼¶ÎäÆ÷
			return -1;
		iRandom = myrand(1, 10000);
		if(type==49)
			iRandom=(int)(iRandom - iRandom*0.10);  //ÍõÕßÁéÊ¯ Ìá¸ß10³É¹¦¡£¡£¡£					
		
		if( FindItem( 1043) >= 1)//12ÔÂ22ÈÕ
		{
			RobItem( 1043, 1 );
		    SendSystemMsg("±¾´ÎÊ¹ÓÃÐÒÔËÐÇ[100%³É¹¦ÂÊ]", SYSTEM_ERROR, TO_ME);
			iSuccess = 1;
		}
		if(g_arItemTable[m_UserItem[sSlot].sSid]->m_byClass == STAFF_ITEM)	iValue = ATTACK_UPGRADE_PSI_BAND;	
		else																iValue = ATTACK_UPGRADE_BAND;						

		if(iRandom <= g_ItemAttUpgrade[tCount])
		{	
			if(type == 2 || type == 49)
			{
				iRandom = myrand(1, 10000);				// Ãà¾ÆÀÌÅÛÀÏ°æ¿ì +3¾÷±îÁö º¸³Ê½º·Î µµÀüÇÒ¼ö ÀÖ´Ù
				for(int i = 0; i < 3; i++)
				{
					last += ATTACK_UPGRADE_BAND;		// ÇØ´ç ¼º°ø·ü ¸¸Å­ ¾÷±Û ÇØÁØ´Ù.
					iSuccess += 1;						// Ãà ¾ÆÀÌÅÛ¿¡ÀÇÇØ ¸î¹ø ¾÷±ÛÇß´ÂÁö ¾Ë·Á ÁØ´Ù.

					if(iRandom <= g_ItemBlessingUpgrade[i]) break;
					if((tCount + iSuccess) >= MAX_ITEM_UPGRADE_COUNT) break;
				}
			}
		    else if(type == 12)
			{
				if(g_arItemTable[m_UserItem[sSlot].sSid]->m_byRLevel > 50) return - 1;
				last = ATTACK_UPGRADE_BAND;
				iSuccess = 1;							// 1¾÷¸¸ Àû¿ëµÇ¸é
			}
			else 
			{
				last = ATTACK_UPGRADE_BAND;
				iSuccess = 1;							// 1¾÷¸¸ Àû¿ëµÇ¸é
			}
		}
	}
	//=========================================================================================================================================×°±¸Éý¼¶
	else
	{
		iRandom = myrand(1, 10000);
		if(type == 49)
			iRandom=(int)(iRandom - iRandom*0.10);  //ÍõÕß¾§Ê¯ Ìá¸ß10³É¹¦¡£¡£¡£
		iValue = DEFENSE_UPGRADE_BAND;
		if( FindItem( 1043) >= 1)//12ÔÂ22ÈÕ
		{
			RobItem( 1043, 1 );
			SendSystemMsg("±¾´ÎÊ¹ÓÃÐÒÔËÐÇ[100%³É¹¦ÂÊ]", SYSTEM_ERROR, TO_ME);
			iSuccess = 1;
		}
        if(iRandom <= g_ItemDefUpgrade[tCount])
		{
			if(type == 2 || type==9 || type==49)
			{
				iRandom = myrand(1, 10000);				// Ãà¾ÆÀÌÅÛÀÏ°æ¿ì +3¾÷±îÁö º¸³Ê½º·Î µµÀüÇÒ¼ö ÀÖ´Ù
				for(i = 0; i < 3; i++)
				{	
					last += DEFENSE_UPGRADE_BAND;		// ÇØ´ç ¼º°ø·ü ¸¸Å­ ¾÷±Û ÇØÁØ´Ù.
					iSuccess += 1;						// Ãà ¾ÆÀÌÅÛ¿¡ÀÇÇØ ¸î¹ø ¾÷±ÛÇß´ÂÁö ¾Ë·Á ÁØ´Ù.

					if(iRandom <= g_ItemBlessingUpgrade[i]) break;
					if((tCount + iSuccess) >= MAX_ITEM_UPGRADE_COUNT) break;
				}
			}
			else if(type == 12)
			{
				if(g_arItemTable[m_UserItem[sSlot].sSid]->m_byRLevel > 50) return - 1;
				iRandom = myrand(1, 10000);				// Ãà¾ÆÀÌÅÛÀÏ°æ¿ì +3¾÷±îÁö º¸³Ê½º·Î µµÀüÇÒ¼ö ÀÖ´Ù
				for(i = 0; i < 3; i++)
				{	
					last += DEFENSE_UPGRADE_BAND;		// ÇØ´ç ¼º°ø·ü ¸¸Å­ ¾÷±Û ÇØÁØ´Ù.
					iSuccess += 1;						// Ãà ¾ÆÀÌÅÛ¿¡ÀÇÇØ ¸î¹ø ¾÷±ÛÇß´ÂÁö ¾Ë·Á ÁØ´Ù.

					if(iRandom <= g_ItemBlessingUpgrade[i]) break;
					if((tCount + iSuccess) >= MAX_ITEM_UPGRADE_COUNT) break;
				}
			}
			else
			{
				last = DEFENSE_UPGRADE_BAND;
				iSuccess = 1;							// 1¾÷¸¸ Àû¿ëµÇ¸é
			}
		}
	}

	if(iSuccess >= 1)									// ÇØ´ç ¹øÂ°ÀÇ ¼º°ø·üº¸´Ù ÀÛÀ¸¸é
	{	
		m_UserItem[sSlot].tMagic[5] = tCount + iSuccess;
//======================================================================================================================================×°±¸±äÍâ¹Û
		if ((tCount + iSuccess) >= 10)
		{
			switch(m_UserItem[sSlot].sSid)
			{
			case 337://ÁúÖ®Òí
				m_UserItem[sSlot].sSid = 1581;//±Ó»¤Ö®Òí
				break;
			case 510://Ç¿»¯ÁúÖ®Òí
			case 511://Ç¿»¯ÁúÖ®Òí
			case 512://Ç¿»¯ÁúÖ®Òí
				m_UserItem[sSlot].sSid = 1582;//Ç¿»¯±Ó»¤Ö®Òí
				break;
			case 513://ÁúÖ®Òís
			case 514://ÁúÖ®Òís
				m_UserItem[sSlot].sSid = 1583;//±Ó»¤Ö®Òís
				break;
			case 330://ÁúÖ®Å­
				m_UserItem[sSlot].sSid = 1578; //ÁéèÑ·¨ÕÈ
				break;
			case 475://Ç¿»¯ÁúÖ®Å­
			case 476://Ç¿»¯ÁúÖ®Å­
			case 477://Ç¿»¯ÁúÖ®Å­
				m_UserItem[sSlot].sSid = 1579; //Ç¿»¯ÁéèÑ·¨ÕÈ
				break;
			case 478://ÁúÉñÖ®Å­¡ªS
			case 479://ÁúÉñÖ®Å­¡ªS
				m_UserItem[sSlot].sSid = 1580;//ÁéèÑ·¨ÕÈs
				break;
			case 323://·´I
				m_UserItem[sSlot].sSid = 1572;//·´1
				break;
			case 440://·´II
			case 441://·´II
			case 442://·´II
				m_UserItem[sSlot].sSid = 1573;//·´2
				break;
			case 443://·´III
			case 444://·´III
				m_UserItem[sSlot].sSid = 1574;//·´3
				break;
			case 316://ÁúÉñÅÚg2
				m_UserItem[sSlot].sSid = 1575;
				break;
			case 405://ÁúÉñÅÚg4
			case 406://ÁúÉñÅÚg4
			case 407://ÁúÉñÅÚg4
				m_UserItem[sSlot].sSid = 1576;//·´1
				break;
			case 408://ÁúÉñÅÚg6
			case 409://ÁúÉñÅÚg6
			   m_UserItem[sSlot].sSid = 1577;
			   break;
//=======================================================================================================ÎäÆ÷Íê
			case 1053://ÁúÑÀÃ±
	        case 1054://Ç¿»¯ÁúÑÀÃ±
	        case 1055://ÌØÊâÁúÑÀ¿ø
	        case 1056://ÁúÑÀ¿øSÐÍ
				{ 
					int s = 1587;
					switch(m_byClass)
					{
					case 0:
						break;
					case 1:
						s = 1591;
			           	break;
			        case 2:
				        s = 1595;
				        break;
			        case 3:
				        s = 1599;
			        	break;
					}
					m_UserItem[sSlot].sSid = s;
					break;
				}
			case 1057://ÁÒÑæÕ½¼×
				m_UserItem[sSlot].sSid = 1607;
				break;
			case 1058://Ç¿»¯ÁÒÑæÕ½¼×
				m_UserItem[sSlot].sSid = 1608;
				break;
			case 1059://ÁÒÑæÕ½¼×GÐÍ
				m_UserItem[sSlot].sSid = 1609;
				break;
			case 1060://ÁÒÑæÕ½¼×SÐÍ
				m_UserItem[sSlot].sSid = 1610;
				break;
			case 1061://ÁÒÑæ»¤ÍÈ
				m_UserItem[sSlot].sSid = 1611;
				break;
			case 1062://Ç¿»¯ÁÒÑæ»¤ÍÈ
				m_UserItem[sSlot].sSid = 1612;
				break;
			case 1063://ÁÒÑæ»¤ÍÈGÐÍ
				m_UserItem[sSlot].sSid = 1613;
				break;
			case 1064://ÁÒÑæ»¤ÍÈSÐÍ
				m_UserItem[sSlot].sSid = 1614;
				break;
			case 1065://²ÔÔÂÖ®îø
				m_UserItem[sSlot].sSid = 1615;
				break;
			case 1066://Ç¿»¯²ÔÔÂÖ®îø
				m_UserItem[sSlot].sSid = 1616;
				break;
			case 1067://²ÔÔÂÖ®îøIIÐÍ
				m_UserItem[sSlot].sSid = 1617;
				break;
			case 1068://²ÔÔÂÖ®îøMÐÍ
				m_UserItem[sSlot].sSid = 1618;
				break;
			case 1069://²ÔÔÂ»¤ÍÈ
				m_UserItem[sSlot].sSid = 1619;
				break;
			case 1070://Ç¿»¯²ÔÔÂ»¤ÍÈ
				m_UserItem[sSlot].sSid = 1620;
				break;
			case 1071://²ÔÔÂ»¤ÍÈIIÐÍ
				m_UserItem[sSlot].sSid = 1621;
				break;
			case 1072://²ÔÔÂ»¤ÍÈMÐÍ
				m_UserItem[sSlot].sSid = 1622;
				break;
			case 1073://º®±ùÖ®îø
				m_UserItem[sSlot].sSid = 1623;
				break;
			case 1074://Ç¿»¯º®±ùÖ®îø
				m_UserItem[sSlot].sSid = 1624;
				break;
			case 1075://º®±ùÖ®îøGÐÍ
				m_UserItem[sSlot].sSid = 1625;
				break;
			case 1076://º®±ùÖ®îøSÐÍ
				m_UserItem[sSlot].sSid = 1626;
				break;
			case 1077://º®±ù»¤ÍÈ
				m_UserItem[sSlot].sSid = 1627;
				break;
			case 1078://Ç¿»¯º®±ù»¤ÍÈ
				m_UserItem[sSlot].sSid = 1628;
				break;
			case 1079://º®±ù»¤ÍÈGÐÍ
				m_UserItem[sSlot].sSid = 1629;
				break;
			case 1080://º®±ù»¤ÍÈSÐÍ
				m_UserItem[sSlot].sSid = 1630;
				break;
			case 1081://¼²·çÕ½¼×
				m_UserItem[sSlot].sSid = 1631;
				break;
			case 1082://Ç¿»¯¼²·çÕ½¼×
				m_UserItem[sSlot].sSid = 1632;
				break;
			case 1083://¼²·çÕ½¼×IIÐÍ
				m_UserItem[sSlot].sSid = 1633;
				break;
			case 1084://¼²·çÕ½¼×MÐÍ
				m_UserItem[sSlot].sSid = 1634;
				break;
			case 1085://¼²·ç»¤ÍÈ
				m_UserItem[sSlot].sSid = 1635;
				break;
			case 1086://Ç¿»¯¼²·ç»¤ÍÈ
				m_UserItem[sSlot].sSid = 1636;
				break;
			case 1087://¼²·ç»¤ÍÈIIÐÍ
				m_UserItem[sSlot].sSid = 1637;
				break;
			case 1088://¼²·ç»¤ÍÈMÐÍ
				m_UserItem[sSlot].sSid = 1638;
				break;
//============================================================================================================ÒÂ·þ¿ã×ÓÍê
			case 1089://Áú¹ÇÑ¥
			case 1090://Ç¿»¯Áú¹ÇÑ¥
			case 1091://ÌØÊâÁú¹ÇÑ¥
			case 1092://Áú¹ÇÑ¥SÐÍ
				{
					//È­Ð¬1650,·¨Ð¬1654,µ¶Ð¬1658,Ç¹Ð¬1662,ÖÙ²Ã1666
					int s = 1650;
					switch(m_byClass)
					{
					case 0:
						break;
					case 1:
						s = 1654;
						break;
					case 2:
						s = 1658;
						break;
					case 3:
						s = 1662;
						break;
					}
					m_UserItem[sSlot].sSid = s;
					break;
				}
			default:
				return FALSE;
				break;
				}
		}
				

//=======================================================================================================================================		
		if((tCount + iSuccess) >=10 )//´óÓÚ»òµÈÓÚ8¸ÄÌáÊ¾
		{
			if(type==3) //ÁéÊ¯ ¾§Ê¯ ´°¿Ú
			{
				if( g_arItemTable[m_UserItem[sSlot].sSid]->m_byWear == 1 )
				{
					CString sysMsg;
                    sysMsg.Format(" %s Ê¹ÓÃÁéÊ¯½« [%s]Ç¿»¯Îª %d ¼¶",this->m_strUserID,g_arItemTable[m_UserItem[sSlot].sSid]->m_strName ,tCount + iSuccess);
                    SendSystemMsg(sysMsg.GetBuffer(sysMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
				}else{
					CString sysMsg;
                    sysMsg.Format(" %s Ê¹ÓÃ¾§Ê¯½« [%s]Ç¿»¯Îª %d ¼¶",this->m_strUserID,g_arItemTable[m_UserItem[sSlot].sSid]->m_strName ,tCount + iSuccess);
                    SendSystemMsg(sysMsg.GetBuffer(sysMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
				}
			}
			else if (type==2) //³¬Áé ³¬¾§ ´°¿Ú
			{
				if( g_arItemTable[m_UserItem[sSlot].sSid]->m_byWear == 1 )
				{
					CString sysMsg;
                    sysMsg.Format(" %s Ê¹ÓÃ³¬¼¶ÁéÊ¯½« [%s]Ç¿»¯Îª %d ¼¶",this->m_strUserID,g_arItemTable[m_UserItem[sSlot].sSid]->m_strName ,tCount + iSuccess);
                    SendSystemMsg(sysMsg.GetBuffer(sysMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
				}else{
					CString sysMsg;
                    sysMsg.Format(" %s Ê¹ÓÃ³¬¼¶¾§Ê¯½« [%s]Ç¿»¯Îª %d ¼¶",this->m_strUserID,g_arItemTable[m_UserItem[sSlot].sSid]->m_strName ,tCount + iSuccess);
                    SendSystemMsg(sysMsg.GetBuffer(sysMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
				}
			}
		}
		MakeItemLog( &m_UserItem[sSlot], ITEMLOG_BLESS_UPGRADE_SUCCESS );
	}
	else												// ½ÇÆÐÇÒ°æ¿ì Ãà°ú ÀÏ¹ÝÀ¸·Î ³ª´©¾î¼­ Àû¿ë¹Þ´Â´Ù.		
	{
		BOOL bRemove = FALSE;
		int iUp = m_UserItem[sSlot].tMagic[5];
		int iCur = m_UserItem[sSlot].tMagic[4];

		if(type == 3)									// ÀÏ¹Ý
		{
			iRandom = myrand(1, 10000);
		
			if(iRandom <= g_ItemNormalDownUpgrade[0]) 
			{
				iUp -= 1;
				iCur -= iValue;
			}
		}
		else if(type == 12)							// Ãà ¾ÆÀÌÅÛÀº ¹«Á¶°Ç 1¾÷±Û °¨¼Ò	
		{
			iUp -= 1;
			iCur -= iValue;
		}
		else											// Ãà ¾ÆÀÌÅÛÀº ¹«Á¶°Ç 1¾÷±Û °¨¼Ò	
		{
			iUp -= 1;
			iCur -= iValue;
		}

		if(iCur < 0) iCur = 0;
		if(iUp < 0) { iUp = 0; bRemove = TRUE; }

		//m_UserItem[sSlot].tMagic[4] = iCur;
		m_UserItem[sSlot].tMagic[5] = iUp;				

		if(bRemove)			// ÈæÈæ...ÇÑ¹øµµ ¾ÈÇÑ ¾ÆÅÛÀº ³¯¸°´Ù.
		{
			MakeItemLog( &m_UserItem[sSlot], ITEMLOG_BLESS_UPGRADE_FAIL );
			ReSetItemSlot(&m_UserItem[sSlot]);	iSuccess = 0; 
		}
		else MakeItemLog( &m_UserItem[sSlot], ITEMLOG_BLESS_UPGRADE_FAIL );
	}	

	FlushItemLog( TRUE );
	return iSuccess;
}

void USER::ChangeUpgradeAcc()
{
	int i = 0;
	int k = 0;
	int j = 0;

	int sid = -1;
	int count = 0;
	int emptyslot = -1;

	BOOL bExistResult = FALSE;

	CItemTable* pTable = NULL;
	ItemList changeItem;

	ItemList UserItemBackup[TOTAL_ITEM_NUM];

	CWordArray arPlusSlot;	arPlusSlot.RemoveAll();
	CWordArray arMinusSlot;	arMinusSlot.RemoveAll();

	for( i = 0; i < TOTAL_ITEM_NUM; i++ )
	{
		UserItemBackup[i] = m_UserItem[i];
	}

	for( i = EQUIP_ITEM_NUM; i < TOTAL_INVEN_MAX; i++ )
	{
		sid = m_UserItem[i].sSid;

		if( sid >= 0 && sid < g_arItemTable.GetSize() )
		{
			pTable = g_arItemTable[sid];
		}
		else
		{
			pTable = NULL;
		}

		if( !pTable ) continue;

		if( pTable->m_byWear != 6 && pTable->m_byWear != 7 && pTable->m_byWear != 8 )	// ¾×¼¼¼­¸®°¡ ¾Æ´Ï¶ó¸é
		{
			continue;
		}

		if( m_UserItem[i].sDuration != 0 )	// ¾÷±×·¹ÀÌµå °¡´ÉÇÑ ½Å ¾ÆÀÌÅÛÀÌ¶ó¸é
		{
			continue;
		}

		count = m_UserItem[i].sCount;

		if( count <= 0 )	// ¹Ù²Ü ¾ÆÀÌÅÛÀÇ Ä«¿îÆ®°¡ 0ÀÌÇÏ¶ó¸é - Àß¸øµÈ ¾ÆÀÌÅÛÀÌ´Ù. ¿©±â¼± ÇØ´çµÇÁö ¾Ê´Â ¾ÆÀÌÅÛÀ¸·Î Ã³¸®ÇÏ°í ±×³É ³Ñ¾î°£´Ù.
		{
			continue;
		}

		ReSetItemSlot( &changeItem );

		// ±âÁ¸ ¾×¼¼¼­¸®¸¦ ±³Ã¼ÇÒ ¾ÆÀÌÅÛ µ¥ÀÌÅÍ¸¦ ¸¸µç´Ù.
		changeItem.sLevel		= m_UserItem[i].sLevel;
		changeItem.sSid			= sid;
		changeItem.sCount		= 1;
		changeItem.sDuration	= pTable->m_sDuration;
		changeItem.sBullNum		= m_UserItem[i].sBullNum;
		for( k =0; k < MAGIC_NUM; k++ ) changeItem.tMagic[k] = m_UserItem[i].tMagic[k];
		changeItem.tIQ			= m_UserItem[i].tIQ;

		if( count == 1 )
		{
			m_UserItem[i].sLevel		= changeItem.sLevel;
			m_UserItem[i].sSid			= changeItem.sSid;
			m_UserItem[i].sCount		= changeItem.sCount;
			m_UserItem[i].sDuration		= changeItem.sDuration;
			m_UserItem[i].sBullNum		= changeItem.sBullNum;
			for( k =0; k < MAGIC_NUM; k++ ) m_UserItem[i].tMagic[k] = changeItem.tMagic[k];
			m_UserItem[i].tIQ			= changeItem.tIQ;

			arPlusSlot.Add( i );
		}
		else
		{
			for( j = 0; j < count; j++ )	// ÆîÃ³Áú °³¼ö¸¸Å­ µ·´Ù.
			{
				emptyslot = -1;

				for( k = EQUIP_ITEM_NUM; k < TOTAL_INVEN_MAX; k++ )	// ºó½½·ÔÀ» Ã£´Â´Ù.
				{
					if( m_UserItem[k].sSid == -1 )
					{
						emptyslot = k;
						break;
					}
				}

				if( emptyslot == -1 )	// ºóÀÚ¸®°¡ ¾øÀ¸¸é
				{
					// ·çÇÁ¸¦ ºüÁ®³ª°£´Ù.
					break;
				}

				m_UserItem[emptyslot].sLevel		= changeItem.sLevel;
				m_UserItem[emptyslot].sSid			= changeItem.sSid;
				m_UserItem[emptyslot].sCount		= changeItem.sCount;
				m_UserItem[emptyslot].sDuration		= changeItem.sDuration;
				m_UserItem[emptyslot].sBullNum		= changeItem.sBullNum;
				for( k =0; k < MAGIC_NUM; k++ ) m_UserItem[emptyslot].tMagic[k] = changeItem.tMagic[k];
				m_UserItem[emptyslot].tIQ			= changeItem.tIQ;

				arPlusSlot.Add( emptyslot );
			}

			if( j <= 0 )	// ÆîÃ³Áø °³¼ö°¡ ÇÏ³ªµµ ¾ø´Ù¸é
			{
				// ¾Æ¹«°Íµµ º¯ÇÑ°Ô ¾ø´Ù.
				break;
			}
			else
			{
				m_UserItem[i].sCount -= j;		// ÆîÃ³ÁØ °³¼ö¸¸Å­ ±âÁ¸ ¾×¼¼¼­¸® °³¼ö¿¡¼­ »©ÁØ´Ù.

				if( m_UserItem[i].sCount <= 0 )
				{
					ReSetItemSlot( &m_UserItem[i] );
				}

				arMinusSlot.Add( i );
			}
		}
	}

	if( arPlusSlot.GetSize() || arMinusSlot.GetSize() )
	{
		if( UpdateUserItemDN() == FALSE )
		{
			for( i = 0; i < TOTAL_ITEM_NUM; i++ )		// ¾ÆÀÌÅÛ Á¤º¸ È¯¿ø
			{
				m_UserItem[i] = UserItemBackup[i];
			}

			return;
		}

		if( arPlusSlot.GetSize() )
		{
			UpdateInvenSlot( &arPlusSlot, NULL, 3 );
			arPlusSlot.RemoveAll();
		}

		if( arMinusSlot.GetSize() )
		{
			UpdateInvenSlot( &arMinusSlot, NULL, 4 );
			arMinusSlot.RemoveAll();
		}

		SendSystemMsg( IDS_USER_CHANGE_UPGRADE_ACC_SUCCESS, SYSTEM_NORMAL, TO_ME);
	}
	else
	{
		SendSystemMsg( IDS_USER_CHANGE_UPGRADE_ACC_FAIL, SYSTEM_NORMAL, TO_ME);
	}
}

////////////////////////////////////////////////////////////////////////////////////////
//	¾ÆÀÌÅÛ °³ÃÊÃ³¸®¸¦ ÇÑ´Ù.
//
void USER::RemodelingItemReq(TCHAR *pBuf)
{
	if(m_dwDN < ITEM_REMODELING_COST) 
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}

	short sSourceSid = -1;
	int i, j, index = 0;
	int iWeight = 0;
	short sMaterialSlot[4]	= {-1, -1, -1, -1};
	short sMaterialSid[4]	= {-1, -1, -1, -1};
	int iSuccess = 0, iMaterialCount = 0;
	BYTE bySlot = 0;
	short sPlanzing = 0;

	BOOL bDeleteSource = FALSE, bRemodelSuccess = FALSE;

	CByteArray arMaterial;
	arMaterial.RemoveAll();

	// Source Item
	short sSourceSlot = GetShort(pBuf, index);			// ¼±ÅÃÇÑ ¾ÆÀÌÅÛ ½½·Ô¹øÈ£
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;

	sSourceSid = m_UserItem[sSourceSlot].sSid;
	if(sSourceSid < 0 || sSourceSid >= g_arItemTable.GetSize()) return;
	if( sSourceSid == 669 || sSourceSid == 670 )		// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ ±Û·¯±×Á¾·ù¶ó¸é
	{
		SendSystemMsg( IDS_CANT_REMODELING, SYSTEM_ERROR, TO_ME);
		return;
	}

	if(g_arItemTable[sSourceSid]->m_byWear < 1 && g_arItemTable[sSourceSid]->m_byWear > 5) // ¹«±â, ¹æ¾î±¸°¡ ¾Æ´Ï¸é °³Á¶ÇÒ ¼ö ¾ø´Ù.
	{
		SendSystemMsg( IDS_CANT_REMODELING, SYSTEM_ERROR, TO_ME);
		return;
	}

	if(m_UserItem[sSourceSlot].tMagic[5] >= 1)			// ¾÷±×·¹ÀÌµåµÈ ¾ÆÀÌÅÛÀº °³Á¶ÇÒ ¼ö ¾ø´Ù.
	{
		SendSystemMsg( IDS_CANT_REMODELING, SYSTEM_ERROR, TO_ME);
		return;
	}

	switch(m_UserItem[sSourceSlot].tIQ)
	{
	case RARE_ITEM:				// °³Á¶ ÇÒ ¼ö ¾ø´Â ¾ÆÀÌÅÛ
	case UNIQUE_ITEM:
	case SET_ITEM:
	case REMODEL_MAGIC_ITEM:
		SendSystemMsg( IDS_CANT_REMODELING, SYSTEM_ERROR, TO_ME);
		return;

	case REMODEL_ITEM:			// ÀÌ¹Ì 3´Ü °³Á¶±îÁö ÇÑ ¾ÆÀÌÅÛ
		if(m_UserItem[sSourceSlot].tMagic[0] >= 1 && m_UserItem[sSourceSlot].tMagic[1] >= 1 && m_UserItem[sSourceSlot].tMagic[2] >= 1)
		{
			SendSystemMsg( IDS_CANT_REMODELING, SYSTEM_ERROR, TO_ME);
			return;
		}
		break;
	}

	for(i = 0; i < 4; i++)
	{
		sMaterialSlot[i] = GetShort(pBuf, index);
		if(sMaterialSlot[i] == -1) break;
		if(sMaterialSlot[i] < EQUIP_ITEM_NUM || sMaterialSlot[i] >= TOTAL_INVEN_MAX) return;

		sMaterialSid[i] = m_UserItem[sMaterialSlot[i]].sSid;
		if(sMaterialSid[i] < 0 || sMaterialSid[i] >= g_arItemTable.GetSize()) return;

		iMaterialCount++;
	}

	// Remodeling Start ...
	iSuccess = 0;
	if(g_arItemTable[sSourceSid]->m_byWear == ATTACK_ITEM)	// Weapon
	{
		switch(m_UserItem[sSourceSlot].tIQ)
		{
		case NORMAL_ITEM:									// 1 ´Ü °³Á¶ ½Ãµµ
			for(i = 0; i < iMaterialCount; i++)
			{
				if(sMaterialSid[i] == 678) iSuccess++;			// Æ¿±¸·»
				else if(sMaterialSid[i] == 858) iSuccess++;		// Å»±×·ý
				else if(sMaterialSid[i] == 682 || sMaterialSid[i] == 679 || sMaterialSid[i] == 680 || sMaterialSid[i] == 681 || sMaterialSid[i] == 683) sPlanzing = sMaterialSid[i];
				else return;
			}
			if(iSuccess != 2) return;

			bRemodelSuccess = RemodelingItem(1, &m_UserItem[sSourceSlot], sPlanzing);
			if(bRemodelSuccess) 
			{
				arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
			}

			break;

		case REMODEL_ITEM:
			if(m_UserItem[sSourceSlot].tMagic[0] > 0 && m_UserItem[sSourceSlot].tMagic[1] <= 0)		// 2 ´Ü °³Á¶ ½Ãµµ
			{
				for(i = 0; i < iMaterialCount; i++)
				{
					if(sMaterialSid[i] == 677) iSuccess++;			// º§±¸±×·»
					else if(sMaterialSid[i] == 858) iSuccess++;		// Å»±×·ý
					else if(sMaterialSid[i] == 682 || sMaterialSid[i] == 679 || sMaterialSid[i] == 680 || sMaterialSid[i] == 681 || sMaterialSid[i] == 683) sPlanzing = sMaterialSid[i];
					else return;
				}
				if(iSuccess != 2) return;
				
				bRemodelSuccess = RemodelingItem(2, &m_UserItem[sSourceSlot], sPlanzing);
				if(bRemodelSuccess) 
				{
					arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
				}
			}
			else if(m_UserItem[sSourceSlot].tMagic[1] > 0 && m_UserItem[sSourceSlot].tMagic[2] <= 0)	// 3 ´Ü °³Á¶ ½Ãµµ
			{
				for(i = 0; i < iMaterialCount; i++)
				{
					if(sMaterialSid[i] == 860) iSuccess++;			// ÇÁ·ÎÅ©·Ò
					else if(sMaterialSid[i] == 858) iSuccess++;		// Å»±×·ý
					else if(sMaterialSid[i] == 685)					// D ÇÃ·£Â¡
					{
						sPlanzing = sMaterialSid[i];
						iSuccess++;		
					}
					else return;
				}
				if(iSuccess != 3) return;

				bRemodelSuccess = RemodelingItem(3, &m_UserItem[sSourceSlot], sPlanzing);

				arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
				if(bRemodelSuccess == FALSE) 
				{
					bDeleteSource = TRUE;
				}
			}
			else return;
			
			break;
			
		case MAGIC_ITEM:
			for(i = 0; i < iMaterialCount; i++)
			{
				if(sMaterialSid[i] == 860) iSuccess++;			// ÇÁ·ÎÅ©·Ò
				else if(sMaterialSid[i] == 858) iSuccess++;		// Å»±×·ý
				else if(sMaterialSid[i] == 685)					// D ÇÃ·£Â¡
				{
					sPlanzing = sMaterialSid[i];
					iSuccess++;		
				}
				else return;
			}
			if(iSuccess != 3) return;

			bRemodelSuccess = RemodelingItem(3, &m_UserItem[sSourceSlot], sPlanzing);
			
			arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
			if(bRemodelSuccess == FALSE) 
			{
				bDeleteSource = TRUE;
			}
			break;
		}
	}
	else if(g_arItemTable[sSourceSid]->m_byWear >= 2 && g_arItemTable[sSourceSid]->m_byWear <= 5)	// Armor
	{
		switch(m_UserItem[sSourceSlot].tIQ)
		{
		case NORMAL_ITEM:
			for(i = 0; i < iMaterialCount; i++)
			{
				if(sMaterialSid[i] == 678) iSuccess++;			// Æ¿±¸·»
				else if(sMaterialSid[i] == 859) iSuccess++;		// Å¬¸®´Ñ
				else if(sMaterialSid[i] == 682 || sMaterialSid[i] == 679 || sMaterialSid[i] == 680 || sMaterialSid[i] == 681 || sMaterialSid[i] == 683) sPlanzing = sMaterialSid[i];
				else return;
			}
			if(iSuccess != 2) return;

			bRemodelSuccess = RemodelingItem(1, &m_UserItem[sSourceSlot], sPlanzing);
			if(bRemodelSuccess) 
			{
				arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
			}

			break;

		case REMODEL_ITEM:
			if(m_UserItem[sSourceSlot].tMagic[0] > 0 && m_UserItem[sSourceSlot].tMagic[1] <= 0)		// 2 ´Ü °³Á¶ ½Ãµµ
			{
				for(i = 0; i < iMaterialCount; i++)
				{
					if(sMaterialSid[i] == 677) iSuccess++;			// º§±¸±×·»
					else if(sMaterialSid[i] == 859) iSuccess++;		// Å¬¸®´Ñ
					else if(sMaterialSid[i] == 682 || sMaterialSid[i] == 679 || sMaterialSid[i] == 680 || sMaterialSid[i] == 681 || sMaterialSid[i] == 683) sPlanzing = sMaterialSid[i];
					else return;
				}
				if(iSuccess != 2) return;

				bRemodelSuccess = RemodelingItem(2, &m_UserItem[sSourceSlot], sPlanzing);
				if(bRemodelSuccess) 
				{
					arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
				}
			}
			else if(m_UserItem[sSourceSlot].tMagic[1] > 0 && m_UserItem[sSourceSlot].tMagic[2] <= 0)	// 3 ´Ü °³Á¶ ½Ãµµ
			{
				for(i = 0; i < iMaterialCount; i++)
				{
					if(sMaterialSid[i] == 860) iSuccess++;			// ÇÁ·ÎÅ©·Ò
					else if(sMaterialSid[i] == 859) iSuccess++;		// Å¬¸®´Ñ
					else if(sMaterialSid[i] == 684) iSuccess++;		// W ÇÃ·£Â¡
					else return;
				}
				if(iSuccess != 3) return;
				
				bRemodelSuccess = RemodelingItem(3, &m_UserItem[sSourceSlot], sPlanzing);
				
				arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
				if(bRemodelSuccess == FALSE) 
				{
					bDeleteSource = TRUE;
				}
			}
			else return;

			break;
			
		case MAGIC_ITEM:
			for(i = 0; i < iMaterialCount; i++)
			{
				if(sMaterialSid[i] == 860) iSuccess++;			// ÇÁ·ÎÅ©·Ò
				else if(sMaterialSid[i] == 859) iSuccess++;		// Å¬¸®´Ñ
				else if(sMaterialSid[i] == 684) iSuccess++;		// W ÇÃ·£Â¡
				else return;
			}
			if(iSuccess != 3) return;

			bRemodelSuccess = RemodelingItem(3, &m_UserItem[sSourceSlot], sPlanzing);
			arMaterial.Add((BYTE)sSourceSlot);	// º¯È­µÈ ½½·Ô Ãß°¡
			if(bRemodelSuccess == FALSE) 
			{
				bDeleteSource = TRUE;
			}
			break;
		}
	}
	else return;

	if(m_dwDN <= ITEM_REMODELING_COST) m_dwDN = 0;				// °³Á¶ ºñ¿ë
	else m_dwDN = m_dwDN - ITEM_REMODELING_COST;				// °³Á¶ ºñ¿ë
//	if(m_dwDN < 0) m_dwDN = 0;

	if(bDeleteSource)	// °³Á¶°¡ ½ÇÆÐÇØ¼­ ¿øº» ¾ÆÀÌÅÛÀÌ ³¯¶ó°£ °æ¿ì
	{
		iWeight += g_arItemTable[sSourceSid]->m_byWeight;		
		ReSetItemSlot(&m_UserItem[sSourceSlot]);
		
	}

	// Item Log File Generation
	if(bRemodelSuccess)	MakeItemLog(&m_UserItem[sSourceSlot], ITEMLOG_REMODEL_SUCCESS);
	else MakeItemLog(&m_UserItem[sSourceSlot], ITEMLOG_REMODEL_FAIL);
	FlushItemLog(TRUE);

	for(i = 0; i < iMaterialCount; i++)	
	{
		if(m_UserItem[sMaterialSlot[i]].sCount <= 1)	ReSetItemSlot(&m_UserItem[sMaterialSlot[i]]);
		else											m_UserItem[sMaterialSlot[i]].sCount--;
		
		iWeight += g_arItemTable[sMaterialSid[i]]->m_byWeight;	// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.

		arMaterial.Add((BYTE)sMaterialSlot[i]);	// º¯È­µÈ ½½·Ô Ãß°¡
	}

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...
	
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

	CBufferEx TempBuf;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	if(bRemodelSuccess)	TempBuf.Add(SUCCESS);
	else				TempBuf.Add(FAIL);
	TempBuf.Add((BYTE)arMaterial.GetSize());

	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		bySlot = (BYTE)arMaterial[i];
		
		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}

	Send(TempBuf, TempBuf.GetLength());

	arMaterial.RemoveAll();
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//	¾ÆÀÌÅÛ °³Á¶¸¦ ¼öÇàÇÑ´Ù.
//
BOOL USER::RemodelingItem(int iStage, ItemList* pItem, short sPlanzing)
{
	int i, j, k;
	int iStart, iEnd;
	BYTE tRandom1, tRandom2;
	UINT uRandomSum, uRandomSumOld;
	
	RemodelingTableArray*	pTable;
	CWordArray*				pRandomIndex;
	int						iArmorIndex;

	short sReplace = 0;

	int iAdd = 0, iDel = 0;
	int iMagicIndex = 0;

	switch(iStage)
	{
	case 1:
		pTable = &g_arRemodelingTable1;
		pRandomIndex = &g_arRemodelingRandomIndex1;
		iArmorIndex = g_iRemodelingArmorIndex1;
		iMagicIndex = 0;
		break;
	case 2:
		pTable = &g_arRemodelingTable2;
		pRandomIndex = &g_arRemodelingRandomIndex2;
		iArmorIndex = g_iRemodelingArmorIndex2;
		iMagicIndex = 1;
		break;
	case 3:
		pTable = &g_arRemodelingTable3;
		pRandomIndex = &g_arRemodelingRandomIndex3;
		iArmorIndex = g_iRemodelingArmorIndex3;
		iMagicIndex = 2;
		break;
	default:
		return FALSE;
	}
 
	if(pItem->sSid < 0 || pItem->sSid >= g_arItemTable.GetSize()) return FALSE;
	if(g_arItemTable[pItem->sSid]->m_byWear == ATTACK_ITEM)
	{
		iStart = 0;
		iEnd = iArmorIndex + 1;
		if(iStage == 1 || iStage == 2) 
		{
			iAdd = 25;
			iDel = 1;
		}
	}
	else
	{
		iStart = iArmorIndex + 1;
		iEnd = pRandomIndex->GetSize();
		if(iStage == 1 || iStage == 2) 
		{
			iAdd = 25;
			iDel = 1;
		}
	}

	tRandom1 = myrand(1, 100);
	tRandom2 = myrand(1, 100);
	uRandomSum = uRandomSumOld = 0;
	for(i = iStart; i < iEnd; i++)	// °³Á¶ ¼Ó¼º °áÁ¤
	{
		j = pRandomIndex->GetAt(i);
		uRandomSum = uRandomSum + pTable->GetAt(j)->m_tRandom1 - iDel;
		if(iStage != 0 && sPlanzing != 0 && pTable->GetAt(j)->m_sPlan == sPlanzing) uRandomSum += iAdd;
		
		if(tRandom1 >= uRandomSumOld && tRandom1 <= uRandomSum)	// °³Á¶µÉ ¼Ó¼º °áÁ¤µÊ
		{
			uRandomSumOld = uRandomSum = 0;
			k = 0;
			
			while(1)		// °³Á¶µÉ ¼Ó¼ºÁß¿¡ ¾î¶²°ªÀÌ Ãß°¡µÉ°ÇÁö °áÁ¤				
			{
				uRandomSum += pTable->GetAt(j + k)->m_tRandom2;
				if(tRandom2 >= uRandomSumOld && tRandom2 <= uRandomSum)
				{
					// ¾ÆÀÌÅÛ Å¬·¡½º¿Í °³Á¶¼Ó¼º Å¬·¡½º°¡ ÀÏÄ¡ÇÏ´ÂÁö °Ë»ç 
					if(CheckClassItem(g_arItemTable[pItem->sSid]->m_byClass, pTable->GetAt(j + k)->m_tNeedClass))	// ÀÏÄ¡ÇÏ¸é
					{
						pItem->tMagic[iMagicIndex] = (BYTE)pTable->GetAt(j + k)->m_sSid;
						if(pItem->tIQ == NORMAL_ITEM) pItem->tIQ = REMODEL_ITEM;
						else if(pItem->tIQ == MAGIC_ITEM) pItem->tIQ = REMODEL_MAGIC_ITEM;
						
						return TRUE;
					}
					else	// ÀÏÄ¡ÇÏÁö ¾ÊÀ¸¸é ´ëÃ¼ ¼Ó¼º ºÎ¿©
					{
						sReplace = pTable->GetAt(j + k)->m_tReplace;
						if(pTable->GetAt(sReplace - 1)->m_sRid == sReplace)
						{
							pItem->tMagic[iMagicIndex] = (BYTE)pTable->GetAt(sReplace - 1)->m_sSid;
							if(pItem->tIQ == NORMAL_ITEM) pItem->tIQ = REMODEL_ITEM;
							else if(pItem->tIQ == MAGIC_ITEM) pItem->tIQ = REMODEL_MAGIC_ITEM;
							
							return TRUE;
						}
					}
				}
				uRandomSumOld = uRandomSum + 1;
				if(uRandomSum >= 100) break;	// Safe Code
				k++;
			}
		}
		uRandomSumOld = uRandomSum + 1;
	}

	return FALSE;
}

BOOL USER::CheckOverGuildUserCount(int count)
{
	CString strMsg;

	CGuild *pGuild = NULL;

	pGuild = GetGuild( m_dwGuild );

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...

		strMsg.Format( "±æµå¸¦ Ã£À» ¼ö ¾ø½À´Ï´Ù" );
		SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME );
		return FALSE;
	}

	int i = 0;
	int j = 0;
	CGuildUser pGUser;

	for(i = 0; i < MAX_GUILD_USER; i++)
	{
		pGUser = pGuild->m_arUser[i];
		if(pGUser.m_lUsed != 0) j++;
	}

	ReleaseGuild();

	if( j < count ) 
	{
//		SendSystemMsg( IDS_USER_APPLY_CONDITION_GMEMBER, SYSTEM_NORMAL, TO_ME);
		strMsg.Format( "ÃÖ¼Ò %d¸í ÀÌ»óÀÎ ±æµå¿¡¼­¸¸ ½ÅÃ»ÇÒ ¼ö ÀÖ½À´Ï´Ù.", count );
		SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME );
		return FALSE;
	}

	return TRUE;
}

void USER::ApplyGuildRun()
{
	CString			str;

	if( !CheckApplyGuildRun() )
	{
		SendSystemMsg( "ÀÌ¹Ì ½ÅÃ»µÇ¾î ÀÖ½À´Ï´Ù.", SYSTEM_NORMAL, TO_ME);
		return;
	}

	char strGuildName[128];
	char strTitle[128];
	char strContent[1024];
	
	sprintf( strGuildName, "%s", m_strGuildName );
	sprintf( strTitle, "GUILD_RUN" );
	sprintf( strContent, "MasterID : %s, MasterAccount : %s", m_strUserID, m_strAccount );

	SDWORD sTitleLen	= _tcslen(strTitle);
	SDWORD sContentLen	= _tcslen(strContent);
	SDWORD sIDLen		= _tcslen(strGuildName);

	SQLHSTMT	hstmt = NULL;
	SQLRETURN	retcode;
	TCHAR		szSQL[8000];	::ZeroMemory(szSQL, sizeof(szSQL));

	int bbsnum = 2;		// ÀÌº¥Æ®¿ë °Ô½ÃÆÇ

	_sntprintf(szSQL, sizeof(szSQL), TEXT( "{call BBS_WRITE ( %d, ?, ?, ? )}" ), bbsnum );

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
//		TRACE("Fail To Write BBS (BBS:%d,Writer:%s,Title:%d) !!\n", bbsnum, m_strUserID, strTitle);

//		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return;
	}

	int i = 1;
	SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, 20,		0, (TCHAR*)strGuildName,0, &sIDLen );
	SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, 50,		0, (TCHAR*)strTitle,	0, &sTitleLen );
	SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, 5000,	0, (TCHAR*)strContent,	0, &sContentLen );

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));
	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
	}
	else if (retcode == SQL_ERROR)
	{
		DisplayErrorMsg(hstmt);
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DBNew[m_iModSid].ReleaseDB(db_index);

		return;
	}
	
	SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);

	SendSystemMsg( "±æµå ´Þ¸®±â ÀÌº¥Æ® ½ÅÃ»ÀÌ ¿Ï·áµÇ¾ú½À´Ï´Ù.", SYSTEM_NORMAL, TO_ME);

	return;
}

BOOL USER::CheckApplyGuildRun()
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode;
	TCHAR			szSQL[8000];
	BOOL			bExist = FALSE;

	::ZeroMemory(szSQL, sizeof(szSQL));
	_sntprintf(szSQL, sizeof(szSQL), TEXT("select * from bbs_2 where strWriter = \'%s\'"), m_strGuildName);

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );

	if( retcode != SQL_SUCCESS )
	{
		return FALSE;
	}

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, SQL_NTS);

	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		retcode = SQLFetch( hstmt );

		if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
		{
			bExist = TRUE;
		}
		else if( retcode == SQL_NO_DATA )
		{
		}
		else
		{
		}
	}
	else
	{
		DisplayErrorMsg(hstmt);
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);

	if( bExist ) return FALSE;

	return TRUE;
}

//////////////////////////////////////////////////////////////////////////
//	ÀÜÅº·®(·¹Æ¼´½ÆÑ·®)¸¦ ¼ÂÆÃÇÏ°í º¯°æÀÌ »ý±â¸é º¯°æÁ¤º¸¸¦ Å¬¶óÀÌ¾ðÆ®·Î º¸³½´Ù.
//
void USER::SetDecBullNum(BYTE tSlot, short sDec)
{
	if(tSlot < 0 || tSlot >= TOTAL_ITEM_NUM) return;

	short sOldBullNum = m_UserItem[tSlot].sBullNum;
	
	m_UserItem[tSlot].sBullNum -= sDec;
	if(m_UserItem[tSlot].sBullNum < 0) m_UserItem[tSlot].sBullNum = 0;

	if(sOldBullNum != m_UserItem[tSlot].sBullNum) SendBullNum(tSlot);
}
//////////////////////////////////////////////////////////////////////////123321
//¾è¿î  Ã¿¸öÍæ¼Ò¸Ä±äÍ¼±í
void USER::SetXingfen()
{
	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	AddAbnormalInfo(ABNORMAL_HIEXP);
	if(m_isDoubleExp > 0 || g_sanJingYan== TRUE ) AddStateInfo(STATE_21);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);					
	Send(TempBuf, TempBuf.GetLength());

}

//////////////////////////////////////////////////////////////////////////123321
//¾è¿î  Ã¿¸öÍæ¼Ò¸Ä±äÍ¼±í
void USER::SetXingYun()
{
	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	AddAbnormalInfo(ABNORMAL_MAGICFIND);
	if(m_isDoubleBAOLV > 0 || g_sanBaoLv == TRUE ) AddStateInfo(STATE_22);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);					
	Send(TempBuf, TempBuf.GetLength());

}
void USER::DelXingfen()
{
	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	DeleteStateInfo(STATE_21);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);					
	Send(TempBuf, TempBuf.GetLength());

}
void USER::DelXingYun()
{
	
	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	DeleteStateInfo(STATE_22);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);					
	Send(TempBuf, TempBuf.GetLength());

}
///////////////////////////////////////////////////////////////////////////
//	³Ã±â µ¥¹ÌÁö¸¦ ¼ÂÆÃÇÑ´Ù.
//
void USER::SetColdDamage()
{
	if(m_tAbnormalKind != ABNORMAL_BYTE_NONE) return;		// ÀÌ¹Ì »óÅÂÀÌ»óÀÌ °É·ÁÀÖ´Â »óÅÂÀÌ¸é ¸®ÅÏ
	
	int iRandom = (int)(myrand(1, 1000) / 10);			
	if(iRandom > 53 || iRandom < 50) return;			// ³Ã±â µ¥¹ÌÁö°¡ °É¸± È®À²Àº 3%

	ClearAbnormalTime(ABNORMAL_TIME);

	m_tAbnormalKind = ABNORMAL_BYTE_COLD;
	m_dwAbnormalTime = COLD_TIME;
	m_dwLastAbnormalTime = GetTickCount();

	if(g_bDebug) SendSystemMsg( IDS_USER_COLD_DAMAGED, SYSTEM_NORMAL, TO_ME);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
//	TempBuf.Add(ABNORMAL_STATUS);
//	TempBuf.Add(ABNORMAL_COLD);
	AddAbnormalInfo(ABNORMAL_COLD);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());
}

//////////////////////////////////////////////////////////////////////////
//	È­¿°µ¥¹ÌÁö¸¦ ¼ÂÆÃÇÑ´Ù.
//
void USER::SetFireDamage()
{
	if(m_tAbnormalKind != ABNORMAL_BYTE_NONE) return;		// ÀÌ¹Ì »óÅÂÀÌ»óÀÌ °É·ÁÀÖ´Â »óÅÂÀÌ¸é ¸®ÅÏ

	int iRandom = (int)(myrand(1, 1000) / 10);			
	if(iRandom > 53 || iRandom < 50) return;			// È­¿° µ¥¹ÌÁö°¡ °É¸± È®À²Àº 3%

	ClearAbnormalTime(ABNORMAL_TIME);

	m_tAbnormalKind = ABNORMAL_BYTE_FIRE;
	m_dwAbnormalTime = FIRE_TIME;
	m_dwLastAbnormalTime = GetTickCount();

	if(g_bDebug) SendSystemMsg( IDS_USER_FIRE_DAMAGED, SYSTEM_NORMAL, TO_ME);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
//	TempBuf.Add(ABNORMAL_STATUS);
//	TempBuf.Add(ABNORMAL_FIRE);
	AddAbnormalInfo(ABNORMAL_FIRE);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());
}

///////////////////////////////////////////////////////////////////////////
//	À¯Àú°¡ º¸°üÇÑ ¾ÆÀÌÅÛ, µ·... º¸³½´Ù.
//
void USER::BankOpenReq()
{
	int i, j;
	CBufferEx TempBuf;

	CByteArray arItemSlotList;

	m_dwBankDN = 0;
	InitUserBankItem();								// º¯¼ö¸¦ ±ú²ýÀÌ ¼¼Å¹ÇÑ´Ù.

	if(!LoadMemUserBank())
	{
		if(!LoadUserBank()) return;						// À¯Àú°¡ º¸°üÇÑ ÀºÇà ¾ÆÀÌÅÛÀ» Ã³À½ Á¢¼ÓÇÒ¶§ °¡Áö°í ¿Â´Ù.
	}

	for(i = 0; i < TOTAL_BANK_ITEM_NUM; i++)
	{												// ÇöÀç º¸°üµÈ ¾ÆÀÌÅÛ¸¸ º¸¿©ÁÖ±âÀ§ÇØ Á¤·ÄÇÑ´Ù. 
		if(m_UserBankItem[i].sSid >= 0)
		{
			arItemSlotList.Add(i);
		}
	}

//	if(m_sLevel < ) return;							// ÀÌ¿ëÇÒ¼öÀÖ´Â ·¹º§À» Á¦ÇÑÇÑ´Ù.
	TempBuf.Add(BANK_OPEN);
	TempBuf.Add((BYTE)0x00);//¹ú·þ´Ë´¦Ôö¼ÓÁËÒ»¸ö¿Õ×Ö½Ú
	TempBuf.Add((DWORD)m_dwBankDN);
	TempBuf.Add((BYTE)arItemSlotList.GetSize());

	for(i = 0; i < arItemSlotList.GetSize(); i++)
	{
		BYTE tempSlot = 0;
		tempSlot = arItemSlotList[i];
		TempBuf.Add(tempSlot);
		TempBuf.Add((short)m_UserBankItem[tempSlot].sLevel);
		TempBuf.Add((short)m_UserBankItem[tempSlot].sSid);
		TempBuf.Add((short)m_UserBankItem[tempSlot].sDuration);
		TempBuf.Add((short)m_UserBankItem[tempSlot].sBullNum);
		TempBuf.Add((short)m_UserBankItem[tempSlot].sCount);

		for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add((BYTE)m_UserBankItem[tempSlot].tMagic[j]);

		TempBuf.Add((BYTE)m_UserBankItem[tempSlot].tIQ);
	}

	Send(TempBuf, TempBuf.GetLength());
	CheckBadItem();

}


///////////////////////////////////////////////////////////////////////////
//	À¯Àú°¡ º¸°üÇÑ ¾ÆÀÌÅÛ, µ·À» DB¿¡¼­ °¡Áö°í ¿Â´Ù.
//
BOOL USER::LoadUserBank()
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode;
	TCHAR			szSQL[1024];

	::ZeroMemory(szSQL, sizeof(szSQL));
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call LOAD_USER_BANK (\'%s\')}"), m_strUserID);

	SQLUINTEGER iDN;
	SQLCHAR		strItem[_BANK_DB];
	
	SQLINTEGER	sInd;

	iDN = 0;
	::ZeroMemory(strItem, sizeof(strItem));

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );

	if( retcode != SQL_SUCCESS )
	{
//		TRACE("Fail To Load User Bank Data !!\n");

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, SQL_NTS);

	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		retcode = SQLFetch( hstmt );

		if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
		{
			int i = 1;
			SQLGetData( hstmt, i++, SQL_C_ULONG,	&iDN,		sizeof(iDN),		&sInd );
			SQLGetData( hstmt, i++, SQL_C_BINARY,	strItem,	sizeof(strItem),	&sInd );
		}
		else if( retcode == SQL_NO_DATA )
		{
			g_DB[m_iModSid].ReleaseDB(db_index);	// µ¥ÀÌÅÍ°¡ ¾øÀ¸¹Ç·Î
			return FALSE;
		}
		else
		{
			g_DB[m_iModSid].ReleaseDB(db_index);	// µ¥ÀÌÅÍ°¡ ¾øÀ¸¹Ç·Î
			return FALSE;
		}
	}
	else
	{
		DisplayErrorMsg(hstmt);
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	StrToUserBankItem((LPTSTR)strItem);

	m_dwBankDN = iDN;

	SetMemUserBank((LPCTSTR)strItem);

	return TRUE;
}

BOOL USER::LoadAccountBank()
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode;
	TCHAR			szSQL[1024];

	::ZeroMemory(szSQL, sizeof(szSQL));
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call LOAD_ACCOUNT_BANK (\'%s\')}")/*, m_iMyServer*/, m_strAccount);

	SQLUINTEGER iDN;
	SQLCHAR		strItem[_ACCOUNT_BANK_DB];
	
	SQLINTEGER	sInd;

	iDN = 0;
	::ZeroMemory(strItem, sizeof(strItem));

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );

	if( retcode != SQL_SUCCESS )
	{
		return FALSE;
	}

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, SQL_NTS);

	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		retcode = SQLFetch( hstmt );

		if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
		{
			int i = 1;
			SQLGetData( hstmt, i++, SQL_C_ULONG,	&iDN,		sizeof(iDN),		&sInd );
			SQLGetData( hstmt, i++, SQL_C_BINARY,	strItem,	sizeof(strItem),	&sInd );
		}
		else if( retcode == SQL_NO_DATA )
		{
			g_DB[m_iModSid].ReleaseDB(db_index);	// µ¥ÀÌÅÍ°¡ ¾øÀ¸¹Ç·Î
			return TRUE;
		}
		else
		{
			g_DB[m_iModSid].ReleaseDB(db_index);	// µ¥ÀÌÅÍ°¡ ¾øÀ¸¹Ç·Î
			return FALSE;
		}
	}
	else
	{
		DisplayErrorMsg(hstmt);
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	StrToAccountBankItem((LPTSTR)strItem);

	m_dwAccountBankDN = iDN;

	SetMemAccountBank((LPCTSTR)strItem);

	return TRUE;
}


///////////////////////////////////////////////////////////////////////////////
//	UserBankItem ¿¡ BufferÀÇ ³»¿ëÀ» Copy ÇÑ´Ù.
//
void USER::StrToUserBankItem(TCHAR *pBuf)
{
	int index = 0;
	int i, j;
	MYINT64 itemserial;

	for(i = 0; i < TOTAL_BANK_ITEM_NUM; i++)
	{
		m_UserBankItem[i].sLevel	= GetShort(pBuf, index);
		m_UserBankItem[i].sSid		= GetShort(pBuf, index);
		m_UserBankItem[i].sDuration = GetShort(pBuf, index);
		m_UserBankItem[i].sBullNum	= GetShort(pBuf, index);
		m_UserBankItem[i].sCount	= GetShort(pBuf, index);

		if(m_UserBankItem[i].sCount <= 0) m_UserBankItem[i].sSid = -1;
		for(j = 0; j < MAGIC_NUM; j++) m_UserBankItem[i].tMagic[j] = GetByte(pBuf, index);
		
		m_UserBankItem[i].tIQ = GetByte(pBuf, index);

		for( j = 0; j < 8; j++ )
		{
			itemserial.b[j] = GetByte( pBuf, index );
		}
		m_UserBankItem[i].iItemSerial = itemserial.i;

		for( j = 0; j < ITEM_USER_RIGHT_NUM; j++ )
		{
			m_UserBankItem[i].uid[j] = -1;
			m_UserBankItem[i].SuccessRate[j] = 0;
		}

		if( m_UserBankItem[i].sSid == g_RR.m_iItemSid )				// ÀÌ ¾ÆÀÌÅÛÀÌ ·Î¾â·³ºí »óÇ°ÀÌ°í
		{
			if( g_strARKRRWinner.CompareNoCase( m_strUserID ) )	// ÇöÀç ½ÂÀÚ°¡ ¾Æ´Ò °æ¿ì
			{
				ReSetItemSlot( &(m_UserBankItem[i]) );					// »°´Â´Ù.
			}
		}

		m_UserBankItem[i].dwTime = 0;
	}	
}

///////////////////////////////////////////////////////////////////////////////
//	AccountBankItem ¿¡ BufferÀÇ ³»¿ëÀ» Copy ÇÑ´Ù.
//
void USER::StrToAccountBankItem(TCHAR *pBuf)
{
	int index = 0;
	int i, j;
	MYINT64 itemserial;

	for(i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++)
	{
		m_AccountBankItem[i].sLevel		= GetShort(pBuf, index);
		m_AccountBankItem[i].sSid		= GetShort(pBuf, index);
		m_AccountBankItem[i].sDuration	= GetShort(pBuf, index);
		m_AccountBankItem[i].sBullNum	= GetShort(pBuf, index);
		m_AccountBankItem[i].sCount		= GetShort(pBuf, index);

		if(m_AccountBankItem[i].sCount <= 0) m_AccountBankItem[i].sSid = -1;
		for(j = 0; j < MAGIC_NUM; j++) m_AccountBankItem[i].tMagic[j] = GetByte(pBuf, index);
		
		m_AccountBankItem[i].tIQ = GetByte(pBuf, index);

		for( j = 0; j < 8; j++ )
		{
			itemserial.b[j] = GetByte( pBuf, index );
		}
		m_AccountBankItem[i].iItemSerial = itemserial.i;

		for( j = 0; j < ITEM_USER_RIGHT_NUM; j++ )
		{
			m_AccountBankItem[i].uid[j] = -1;
			m_AccountBankItem[i].SuccessRate[j] = 0;
		}

		m_AccountBankItem[i].dwTime = 0;
	}	
}

///////////////////////////////////////////////////////////////////////////////
//	Buffer ¿¡ UserBankItem Á¤º¸¸¦ Copy ÇÑ´Ù.
//
void USER::UserBankItemToStr(TCHAR *pBuf)
{
	int index = 0;
	int i, j;
	MYINT64 itemserial;

	for(i = 0; i < TOTAL_BANK_ITEM_NUM; i++)
	{
		SetShort(pBuf, m_UserBankItem[i].sLevel,	index);
		SetShort(pBuf, m_UserBankItem[i].sSid,		index);
		SetShort(pBuf, m_UserBankItem[i].sDuration,	index);
		SetShort(pBuf, m_UserBankItem[i].sBullNum,	index);
		SetShort(pBuf, m_UserBankItem[i].sCount,	index);

		for(j = 0; j < MAGIC_NUM; j++) SetByte(pBuf, m_UserBankItem[i].tMagic[j], index);

		SetByte(pBuf, m_UserBankItem[i].tIQ, index);

		itemserial.i = m_UserBankItem[i].iItemSerial;

		for( j = 0; j < 8; j++ )
		{
			SetByte( pBuf, itemserial.b[j], index );
		}
	}
}

void USER::UserAccountBankItemToStr(TCHAR *pBuf)
{
	int index = 0;
	int i, j;
	MYINT64 itemserial;

	for(i = 0; i < TOTAL_ACCOUNT_BANK_ITEM_NUM; i++)
	{
		SetShort(pBuf, m_AccountBankItem[i].sLevel,		index);
		SetShort(pBuf, m_AccountBankItem[i].sSid,		index);
		SetShort(pBuf, m_AccountBankItem[i].sDuration,	index);
		SetShort(pBuf, m_AccountBankItem[i].sBullNum,	index);
		SetShort(pBuf, m_AccountBankItem[i].sCount,		index);

		for(j = 0; j < MAGIC_NUM; j++) SetByte(pBuf, m_AccountBankItem[i].tMagic[j], index);

		SetByte(pBuf, m_AccountBankItem[i].tIQ, index);

		itemserial.i = m_AccountBankItem[i].iItemSerial;

		for( j = 0; j < 8; j++ )
		{
			SetByte( pBuf, itemserial.b[j], index );
		}
	}
}

///////////////////////////////////////////////////////////////////////////
//	º¸°üµÈ ¾ÆÀÌÅÛ, µ·À» DB¿¡¼­ Á¤º¸¸¦ °»½ÅÇÑ´Ù.
//
BOOL USER::UpdateUserBank()
{
// fors test_account_bank offical	 if(UpdateMemUserBank()) return TRUE;
    UpdateMemUserBank();
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strFace[10], strSkill[_SKILL_DB], strItem[_ITEM_DB], strPsi[_PSI_DB], strBankItem[_BANK_DB], strAccountBankItem[_ACCOUNT_BANK_DB];
	TCHAR			strQuickItem[_QUICKITEM_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strBankItem, sizeof(strBankItem));
	::ZeroMemory(strFace, sizeof(strFace));
	::ZeroMemory(strSkill, sizeof(strSkill));
	::ZeroMemory(strItem, sizeof(strItem));
	::ZeroMemory(strPsi, sizeof(strPsi));
	::ZeroMemory(strAccountBankItem, sizeof(strAccountBankItem));

	::ZeroMemory(strQuickItem, sizeof(strQuickItem));
	
    ::CopyMemory(strFace, m_strFace, sizeof(m_strFace));

	UserBankItemToStr(strBankItem);
	UserSkillToDBStr(strSkill);
	UserItemToStr(strItem);
	UserPsiToStr(strPsi);
	UserAccountBankItemToStr(strAccountBankItem);	


	SDWORD sBankItemLen	= sizeof(strBankItem);
	SDWORD sFaceLen		= sizeof(strFace);
	SDWORD sSkillLen	= sizeof(strSkill);
	SDWORD sItemLen		= sizeof(strItem);
	SDWORD sPsiLen		= sizeof(strPsi);
	SDWORD sQuickLen	= sizeof(strQuickItem);
	SDWORD sAccountBankItemLen = sizeof(strAccountBankItem);
	
    m_tPsiOneKind = m_tPsiTwoKind = m_tPsiThreeKind = 0;
	m_dwPsiOneTime = m_dwPsiTwoTime = m_dwPsiThreeTime = 0;

	// Psionic One
	if(m_dwHasteTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_HASTE;
		m_dwPsiOneTime = m_dwHasteTime;
	}
	if(m_dwShieldTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_SHIELD;
		m_dwPsiOneTime = m_dwShieldTime;
	}
	if(m_dwDexUpTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_DEXUP;
		m_dwPsiOneTime = m_dwDexUpTime;
	}
	if(m_dwMaxHPUpTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_HPUP;
		m_dwPsiOneTime = m_dwMaxHPUpTime;
	}
	if(m_dwFastRunTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_FAST_RUN;
		m_dwPsiOneTime = m_dwFastRunTime;
	}
	if(m_dwMindShockTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_MIND_SHOCK;
		m_dwPsiOneTime = m_dwMindShockTime;
	}
	if(m_dwPsiShieldTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_PSI_SHIELD;
		m_dwPsiOneTime = m_dwPsiShieldTime;
	}
	if(m_dwBigShieldTime != 0) 
	{
		m_tPsiOneKind = 30;
		m_dwPsiOneTime = m_dwBigShieldTime;
	}
	if(m_dwPiercingShieldTime != 0) 
	{
		m_tPsiOneKind = PSIONIC_PIERCING_SHIELD;
		m_dwPsiOneTime = m_dwPiercingShieldTime;
	}

	// Psionic Two
	if(m_dwAdamantineTime != 0) 
	{
		m_tPsiTwoKind = PSIONIC_ADAMANTINE;
		m_dwPsiTwoTime = m_dwAdamantineTime;
	}
	if(m_dwMightyWeaponTime != 0) 
	{
		m_tPsiTwoKind = PSIONIC_MIGHTYWEAPON;
		m_dwPsiTwoTime = m_dwMightyWeaponTime;
	}
	if(m_dwBerserkerTime != 0) 
	{
		m_tPsiTwoKind = PSIONIC_BERSERKER;
		m_dwPsiTwoTime = m_dwBerserkerTime;
	}

	// Psionic Three
	if(m_dwMindGuardTime != 0) 
	{
		m_tPsiThreeKind = PSIONIC_MIND_GUARD;
		m_dwPsiThreeTime = m_dwMindGuardTime; //¼Ó×Ö¶Î
	}
	
    _sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_BANK_DATA (\'%s\',\'%s\',%d,%d,%d,%d,%d, %d,%d,%d, ?, \
		%d,%d,%d, %d,%d, %d, %d,%d,  %d,\
		%d,  %d, %d,%d,%d,%d, %d,%d,%d,%d, \
		?,?,?,?, %d, %d, \
		%d, %d, ?, ?, \
		%d, \
		%d, \
		%d, %d, %d, %d, %d, %d, %d, %d, %d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,\
		\'%s\', \
		%d,%d,		%d,%d,		%d,%d)}")/*, 
		m_iMyServer*/, m_strAccount, m_strUserID,	m_sSTR,	m_sCON,	m_sDEX,	m_sVOL,	m_sWIS,	m_iSkin, m_iHair, m_sGender,  
		m_curz,	m_curx,	m_cury,		m_dwBuddy, m_dwGuild,		m_dwExp,		m_sPA, m_sSkillPoint,  	m_dwXP,
		m_sMaxHP, m_sHP, m_sMaxPP, m_sPP, m_sMaxSP,	m_sSP,		m_dwDN,	m_sCityRank, m_sLevel,	m_byClass, 
		m_tAbnormalKind, m_dwAbnormalTime, 

		m_dwBankDN, m_dwAccountBankDN,

		m_bLive,
		m_dwSaintTime, 
		m_dwHiExpTime, m_dwHtExpTime, m_dwMagicFindTime, m_dwMagicFtTime, m_dwNoChatTime,m_dwZF,m_dwXL, m_dwCloseTime, m_dwAutoMoney,m_dwPD,m_dwLingQu,m_dwShaGuai, m_dwGuarDianTianShi, m_dwShopPingDN, m_dwVIPTime,m_dwZaiXianTime,m_dwBFindTime,m_dwHXTime,m_dwSGTime,m_dwXYTime,m_dwZFTime,
		m_strLoveName,	//yskang 0.1 m_strLoveName Ãß°¡
		m_tPsiOneKind, m_dwPsiOneTime,		m_tPsiTwoKind, m_dwPsiTwoTime,		m_tPsiThreeKind, m_dwPsiThreeTime);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
//		TRACE("Fail To Update User Bank Data !!\n");

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strFace),	0, (TCHAR*)strFace,		0, &sFaceLen );

		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strSkill),	0, (TCHAR*)strSkill,	0, &sSkillLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strPsi),		0, (TCHAR*)strPsi,		0, &sPsiLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strQuickItem),	0, (TCHAR*)strQuickItem,	0, &sQuickLen );

		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strBankItem),	0, (TCHAR*)strBankItem,		0, &sBankItemLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strAccountBankItem),	0, (TCHAR*)strAccountBankItem,		0, &sAccountBankItemLen );
        
        retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DB[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

///////////////////////////////////////////////////////////////////////////
//	½Ã¾ß¹üÀ§¿¡ ÀÖ´Â À¯Àú¿¡°Ô Å¸¿îÆ÷Å»¸¦ ÀüÇÑ´Ù.
//
void USER::SendMyTownPotal(BYTE towho, BYTE type)
{
	CBufferEx	TempBuf;
	int i;

	CPoint pos = ConvertToClient( m_curx, m_cury );
	if( pos.x == -1 || pos.y == -1 ) { pos.x = 1; pos.y = 1; }	// ÀÌºÎºÐÀº ³ªÁß¿¡ ¹Ù²ÙÀÚ

	TempBuf.Add(USER_INFO);
	TempBuf.Add(type);
	TempBuf.Add(m_uid + USER_BAND);

	TempBuf.AddString(m_strUserID);
		
	TempBuf.Add((short)pos.x);
	TempBuf.Add((short)pos.y);
		
	TempBuf.Add(m_iSkin);
	TempBuf.Add(m_iHair);
	TempBuf.Add((BYTE)m_sGender);
	TempBuf.AddData(m_strFace, 10);
		
	for( i = 0; i < EQUIP_ITEM_NUM; i++) TempBuf.Add(m_UserItem[i].sSid);

	TempBuf.Add(m_sHP);
	TempBuf.Add(m_sMagicMaxHP);

	TempBuf.Add(m_tDir);

//	TempBuf.Add((BYTE)m_strAbnormal[0]);			// Abnormal Info
//	TempBuf.Add(m_tPsiAbnormal);					

	TempBuf.Add(m_dwAbnormalInfo);				// »óÅÂÀÌ»ó Á¤º¸
	TempBuf.Add(m_dwAbnormalInfo_);
	TempBuf.Add((DWORD)0);
	TempBuf.Add((DWORD)0);
	//¹ú·þ´Ë´¦¶à16 byte 0
	for(int zero = 0;zero<16;zero++)
		TempBuf.Add((BYTE)0x00);
	TempBuf.Add(m_sCityRank);

	TempBuf.Add((int)m_dwGuild);					//&&&&&&&&&&&& Test Code
	TempBuf.AddString(m_strGuildName);			// ±æµå ÀÌ¸§À» Ãß°¡
	TempBuf.Add(m_sGuildVersion);
	
	TempBuf.Add(m_byClass);
	m_bPkStatus=0x01;
	TempBuf.Add((BYTE)m_bPkStatus);

	TempBuf.AddString(m_strLoveName);//yskang 0.1

	for( i = TOTAL_INVEN_MAX; i < TOTAL_ITEM_NUM-2; i++) 
			TempBuf.Add(m_UserItem[i].sSid);	// EBody

	if(m_UserItem[TOTAL_ITEM_NUM-2].sSid!=-1&&m_UserItem[TOTAL_ITEM_NUM-2].sDuration!=0){
			TempBuf.Add((BYTE)(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]));
			TempBuf.Add((BYTE)0x00);
	}else{
			TempBuf.Add(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]);
			TempBuf.Add((BYTE)0xff);
	}
		
	TempBuf.AddString(m_PersonalShopName);
	//¹ú·þ´Ë´¦¶à5byte 0x0a 0x00 0x00 0x00 0x00
	TempBuf.Add((BYTE)0x01);
	TempBuf.Add((BYTE)0x00);
	TempBuf.Add((BYTE)0x00);
	TempBuf.Add((BYTE)0x00);
	TempBuf.Add((BYTE)m_tBabyCall);
	if(m_tBabyCall)
	{
		TempBuf.Add(g_szBabyName[m_sBabyID%2],strlen(g_szBabyName[m_sBabyID%2]));
		TempBuf.Add(m_sBabyID);
	}
	switch(towho)
	{
/*	case TO_ALL:
		SendAll(TempBuf, TempBuf.GetLength());
		break;
*/
	case TO_ME:
		Send(TempBuf, TempBuf.GetLength());
		break;
/*
	case TO_ZONE:
		SendZone(TempBuf, TempBuf.GetLength());
		break;
*/
	case TO_INSIGHT:
	default:
		SendInsight(TempBuf, TempBuf.GetLength());
		break;
	}
	SendHuFaInfo(this,towho);

}

///////////////////////////////////////////////////////////////////////////
//	¼¿¿¡¼­ È£ÃâÇÏ´Â Å¸¿îÆ÷Å»ÀÓ
//
void USER::SendUserTownPotal(USER *pUser, BYTE tMode)
{
	if( !pUser ) return;

	CBufferEx	TempBuf;

	CPoint pos = ConvertToClient( pUser->m_curx, pUser->m_cury );
	if( pos.x == -1 || pos.y == -1 ) { pos.x = 1; pos.y = 1; }	// ÀÌºÎºÐÀº ³ªÁß¿¡ ¹Ù²ÙÀÚ

	TempBuf.Add(USER_INFO);
	TempBuf.Add(tMode);
	
	TempBuf.Add(pUser->m_uid + USER_BAND);

	if(tMode == INFO_TOWNPOTAL_DELETE) { Send(TempBuf, TempBuf.GetLength()); return; }

	TempBuf.AddString(pUser->m_strUserID);

	TempBuf.Add((short)pos.x);
	TempBuf.Add((short)pos.y);

	TempBuf.Add(pUser->m_iSkin);
	TempBuf.Add(pUser->m_iHair);
	TempBuf.Add((BYTE)pUser->m_sGender);
	TempBuf.AddData(pUser->m_strFace, 10);
int i;
	for(i = 0; i < EQUIP_ITEM_NUM; i++) TempBuf.Add(pUser->m_UserItem[i].sSid);

//	TempBuf.Add(pUser->m_sHP);
//	TempBuf.Add(pUser->m_sMaxHP);
	TempBuf.Add(pUser->m_sHP);
	TempBuf.Add(pUser->m_sMagicMaxHP);

	TempBuf.Add(pUser->m_tDir);

//	TempBuf.Add((BYTE)pUser->m_strAbnormal[0]);			// Abnormal Info
//	TempBuf.Add(pUser->m_tPsiAbnormal);						//&&&&&&&&&&&& Test Code	

	TempBuf.Add(pUser->m_dwAbnormalInfo);				// »óÅÂÀÌ»ó Á¤º¸
	TempBuf.Add(pUser->m_dwAbnormalInfo_);
	TempBuf.Add((DWORD)0);
	TempBuf.Add((DWORD)0);
	//¹ú·þ´Ë´¦¶à16 byte 0
	for(int zero = 0;zero<16;zero++)
		TempBuf.Add((BYTE)0x00);
	TempBuf.Add(pUser->m_sCityRank);

	TempBuf.Add((int)pUser->m_dwGuild);					//&&&&&&&&&&&& Test Code
	TempBuf.AddString(pUser->m_strGuildName);			// ±æµå ÀÌ¸§À» Ãß°¡
	TempBuf.Add(pUser->m_sGuildVersion);

	TempBuf.Add(pUser->m_byClass);
	TempBuf.Add((BYTE)pUser->m_bPkStatus);

	TempBuf.AddString(pUser->m_strLoveName);//yskang 0.1

	for( i = TOTAL_INVEN_MAX; i < TOTAL_ITEM_NUM-2; i++) TempBuf.Add(pUser->m_UserItem[i].sSid);	// EBody
	if(m_UserItem[TOTAL_ITEM_NUM-2].sSid!=-1&&m_UserItem[TOTAL_ITEM_NUM-2].sDuration!=0){
		TempBuf.Add((BYTE)(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]));
		TempBuf.Add((BYTE)0x00);
	}else{
		TempBuf.Add(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]);
		TempBuf.Add((BYTE)0xff);
	}
	TempBuf.AddString(pUser->m_PersonalShopName);
	//¹ú·þ´Ë´¦¶à5byte 0x0a 0x00 0x00 0x00 0x00
//	TempBuf.Add((BYTE)0x01);
	TempBuf.Add((BYTE)0x00);
	TempBuf.Add((BYTE)0x00);
	TempBuf.Add((BYTE)0x00);
	TempBuf.Add((BYTE)pUser->m_tBabyCall);
	if(pUser->m_tBabyCall)
	{
		TempBuf.Add(g_szBabyName[pUser->m_sBabyID%2],strlen(g_szBabyName[pUser->m_sBabyID%2]));
		TempBuf.Add(pUser->m_sBabyID);
	}
	Send(TempBuf, TempBuf.GetLength());
	SendHuFaInfo(pUser,TO_ME);

}


///////////////////////////////////////////////////////////////////////////
//	ÀºÇà¿¡¼­ ÀÔÃâ±Ý, ÀÔÃâÀÔ ¾ÆÀÌÅÛÀ» ´ã´çÇÑ´Ù.
//
void USER::BankItemMoveReq(TCHAR *pBuf)
{
#ifdef _ACTIVE_USER
//	if(m_iDisplayType == 6 && m_sLevel > 25) return; //yskang 0.5
	if(m_iDisplayType == 6) return; //yskang 0.5
#endif

	int index = 0;
	BYTE type = GetByte(pBuf, index);
/////////////////////////////////////////////½­ºþ
	BOOL bSuccess = FALSE;
	if(!LoadCharData(m_strAccount))
	{
		return;
	}
	for (int i =0; i < 3 ; i++)	//bug ·ÀÖ¹µÁºÅË¢×°±¸
	{
		if (m_strChar[i][0] == 0)
			continue;
		if (strcmp(m_strChar[i],m_strUserID) == 0)
			bSuccess = TRUE;
	}

	if (bSuccess == FALSE)	//BUG  
		return;
	if (m_bNowTrading == TRUE || m_bPShopOpen == TRUE) 
	   {
            CString strDate ="";
			SYSTEMTIME st;
			GetLocalTime(&st);
			strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
			TCHAR m_Log[500];
			sprintf_s(m_Log,"[ %s ]%s %d,%d ÎïÆ·ÒÆ¶¯´æÔÚ·Ç·¨2 \r\n",strDate,m_strUserID,m_bNowTrading,m_bPShopOpen);
		    WriteUserShopLog(m_Log);
			SendItemMoveFail();
		    return;
	 }           
	///////////////////////////////////////////////////////½­ºþ

	switch(type)
	{
	case BANK_ITEM_INPUT:
		BankInPut(pBuf + index);
		break;
	case BANK_ITEM_OUTPUT:
		BankOutPut(pBuf + index);
		break;
	case BANK_DN_INPUT:
		BankInPutDN(pBuf + index);
		break;
	case BANK_DN_OUTPUT:
		BankOutPutDN(pBuf + index);
		break;
	}
}

///////////////////////////////////////////////////////////////////////////
//	ÀºÇà¿¡ ¾ÆÀÌÅÛÀ» º¸°üÇÑ´Ù.
//
void USER::BankInPut(TCHAR *pBuf) //¸öÈË²Ö¿â ´æÈë
{	
	int i;
	int tDestSlot;
	int index = 0;
	int iOver = 0;
	short sSid = -1;
	short sHaveCount = 0;

	BYTE result = SUCCESS;

	CBufferEx TempBuf;

	ItemList MyItem[TOTAL_ITEM_NUM], BackItem;

	BYTE tSourceSlot = GetByte(pBuf, index);	// »ç¿ëÀÚ ¾ÆÀÌÅÛÀÌ ÀÖ´ø ½½·Ô À§Ä¡
	short sCount = GetShort(pBuf, index);		// ¾ó¸¶¸¸Å­ º¸°ü
												// ¿À·ÎÁö ÀÎº¥¸¸ °¡´ÉÇÏ´Ù.			
	if(tSourceSlot < EQUIP_ITEM_NUM || tSourceSlot >= TOTAL_INVEN_MAX) { result = FAIL; goto go_result; }

	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE) { result = FAIL; goto go_result; } //Î´ÖªBUG

	sSid = m_UserItem[tSourceSlot].sSid;
	sHaveCount = m_UserItem[tSourceSlot].sCount;
												
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) { result = FAIL; goto go_result; }	// Àß¸øµÈ sSid

	if(sCount > BANK_MAX_ITEM) 
	{
		SendSystemMsg( IDS_USER_ONCE_MOVE_MAX, SYSTEM_ERROR, TO_ME);
		result = FAIL; goto go_result;
	}
												// ¼ÒÁöÇÑ ¾ÆÀÌÅÛ ¼öº¸´Ù ¸¹À» °æ¿ì			
	if(sCount <= 0 || sCount > sHaveCount) { result = FAIL; goto go_result; }
			
	if(g_arItemTable[sSid]->m_sDuration > 0 && sCount > 1) { result = FAIL; goto go_result; }
	
	for(i = 0; i < TOTAL_ITEM_NUM; i++)	// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

	ReSetItemSlot(&BackItem);					// DB½ÇÆÐ¿¡ ´ëºñÇÑ ¹é¾÷¿ë ÃÊ±âÈ­
												
	tDestSlot = GetSameItem(m_UserItem[tSourceSlot], BANK_SLOT);	// ÀÏ´Ü °ãÄ¥¼ö ÀÖ´ÂÁö, °ãÄ¡¸é °°Àº ¾ÆÀÌÅÛÀÌ ÀÖ´ÂÁö Ã£¾Æº»´Ù.
	
	/***************************ÀºÇà ¾÷¹« Ã³¸®********************************************/
	if(tDestSlot >= 0)							// Ç×»ó »õ·ÎÀÌ Ãß°¡ µÇ´Â°ÍÀ» ±âÁØÀ¸·Î Ã³¸®
	{											
		BackItem = m_UserBankItem[tDestSlot];

		if(m_UserBankItem[tDestSlot].sCount >= BANK_MAX_ITEM)
		{
			SendSystemMsg( IDS_USER_SAVE_MAX_COUNT, SYSTEM_ERROR, TO_ME);
			result = FAIL; goto go_result;
		}

		if((m_UserBankItem[tDestSlot].sCount + sCount) > BANK_MAX_ITEM)
		{										
			iOver = m_UserBankItem[tDestSlot].sCount + sCount - BANK_MAX_ITEM;
			if(iOver <= 0) { result = FAIL; goto go_result; }

			m_UserBankItem[tDestSlot].sCount = BANK_MAX_ITEM;
			sCount = sCount - iOver;
		}
		else m_UserBankItem[tDestSlot].sCount += sCount;
	}
	else
	{											//	Ãß°¡
		tDestSlot = GetEmptySlot(BANK_SLOT);

		if(tDestSlot == -1) 
		{
			result = FAIL; goto go_result; 
		}

		m_UserBankItem[tDestSlot].sLevel = m_UserItem[tSourceSlot].sLevel;
		m_UserBankItem[tDestSlot].sSid = m_UserItem[tSourceSlot].sSid;
		m_UserBankItem[tDestSlot].sDuration = m_UserItem[tSourceSlot].sDuration;
		m_UserBankItem[tDestSlot].sBullNum = m_UserItem[tSourceSlot].sBullNum;
		m_UserBankItem[tDestSlot].sCount = sCount;
		for(i = 0; i < MAGIC_NUM; i++) m_UserBankItem[tDestSlot].tMagic[i] = m_UserItem[tSourceSlot].tMagic[i];
		m_UserBankItem[tDestSlot].tIQ = m_UserItem[tSourceSlot].tIQ;
		m_UserBankItem[tDestSlot].iItemSerial = m_UserItem[tSourceSlot].iItemSerial;
	}

	index = 0;
	index = g_arItemTable[m_UserItem[tSourceSlot].sSid]->m_byWeight * sCount;
	/**************************À¯Àú ÀÎº¥ Ã³¸®*********************************************/
	if(sCount >= sHaveCount && iOver == 0) ReSetItemSlot(&m_UserItem[tSourceSlot]);	
	else m_UserItem[tSourceSlot].sCount -= sCount;
	
	/**************************DB Update Ã³¸®*********************************************/
	if(UpdateUserBank() == FALSE)
	{
		for(i = 0; i < TOTAL_ITEM_NUM; i++)// ¾ÆÀÌÅÛ Á¤º¸ º¹¿ø
		{
			m_UserItem[i] = MyItem[i];
		}
		m_UserBankItem[tDestSlot] = BackItem;
	}

go_result:
	TempBuf.Add(BANK_ITEM_MOVE_RESULT);

	if(result == FAIL)
	{
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	result = (BYTE)0x01;
	TempBuf.Add(result);

	TempBuf.Add((BYTE)tDestSlot);				// ÀºÇà¾÷¹«	
	TempBuf.Add(m_UserBankItem[tDestSlot].sLevel);
	TempBuf.Add(m_UserBankItem[tDestSlot].sSid);
	TempBuf.Add(m_UserBankItem[tDestSlot].sDuration);
	TempBuf.Add(m_UserBankItem[tDestSlot].sBullNum);
	TempBuf.Add(m_UserBankItem[tDestSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserBankItem[tDestSlot].tMagic[i]);
	TempBuf.Add(m_UserBankItem[tDestSlot].tIQ);

	TempBuf.Add((BYTE)tSourceSlot);				// À¯Àú ÀÎº¥
	TempBuf.Add(m_UserItem[tSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[tSourceSlot].sSid);
	TempBuf.Add(m_UserItem[tSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[tSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[tSourceSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tSourceSlot].tMagic[i]);
	TempBuf.Add(m_UserItem[tSourceSlot].tIQ);

	Send(TempBuf, TempBuf.GetLength());

	m_iCurWeight -= index;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

//	SendQuickChange();							// Äü¾ÆÀÌÅÛ µî·ÏÇÑ°Ô Ãë¼ÒµÇ´ÂÁö ¾Ë¾Æº»´Ù. 
//	SendItemWeightChange();				// ÇöÀç ¾ÆÀÌÅÛ ¹«°Ô¸¦ º¸³½´Ù.
}

///////////////////////////////////////////////////////////////////////////
//	ÀºÇà¿¡ ¾ÆÀÌÅÛÀ» µÇ Ã£´Â´Ù.
//
void USER::BankOutPut(TCHAR *pBuf)  //¸öÈË²Ö¿â È¡³ö
{
	int i, iWeight = 0;
	int tDestSlot;
	int index = 0;
	int iOver = 0;
	short sSid = -1;
	short sHaveCount = 0;

	BYTE result = SUCCESS;

	CBufferEx TempBuf;

	ItemList MyItem[TOTAL_ITEM_NUM], BackItem;

	BYTE tSourceSlot = GetByte(pBuf, index);	// »ç¿ëÀÚ ¾ÆÀÌÅÛÀÌ ÀÖ´ø ½½·Ô À§Ä¡
	short sCount = GetShort(pBuf, index);
												// ¿À·ÎÁö ÀÎº¥¸¸ °¡´ÉÇÏ´Ù.		
	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE) { result = FAIL; goto go_result; } //Î´ÖªBUG
	if(tSourceSlot >= TOTAL_BANK_ITEM_NUM) { result = FAIL; goto go_result; }

	sSid = m_UserBankItem[tSourceSlot].sSid;
	sHaveCount = m_UserBankItem[tSourceSlot].sCount;

	//===================================================================ÏÞÖÆ¸öÈË²Ö¿âÈ¡³öÊýÁ¿

	if ( sSid == 724) //ºÇºÇ
	{
		if (sCount + FindItem( 724) > 32000)
		{

			 SendEventMsg("³¬¹ý¿ÉÐ¯´øµÄ×î´óÊýÁ¿");
			result = FAIL; 
			goto go_result;
           
		}
	}
//==========================================================================

	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) { result = FAIL; goto go_result; }

	if(sCount <= 0 || sCount > sHaveCount/* || sCount > BANK_MAX_ITEM*/) { result = FAIL; goto go_result; }

	//if(g_arItemTable[sSid]->m_byWear <= 5 && sCount > 1) { result = FAIL; goto go_result; }
	if(g_arItemTable[sSid]->m_sDuration > 0 && sCount > 1) { result = FAIL; goto go_result; }

	iWeight = g_arItemTable[sSid]->m_byWeight * sCount;
	if(m_iMaxWeight < m_iCurWeight + iWeight)
	{
		SendSystemMsg( IDS_USER_OVER_WEIGHT1, SYSTEM_ERROR, TO_ME);
		result = FAIL; 
		goto go_result;
	}

	for(i = 0; i < TOTAL_ITEM_NUM; i++)	// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

	ReSetItemSlot(&BackItem);					// DB½ÇÆÐ¿¡ ´ëºñÇÑ ¹é¾÷¿ë ÃÊ±âÈ­
	BackItem = m_UserBankItem[tSourceSlot];
												// ÀÏ´Ü °ãÄ¥¼ö ÀÖ´ÂÁö, °ãÄ¡¸é °°Àº ¾ÆÀÌÅÛÀÌ ÀÖ´ÂÁö Ã£¾Æº»´Ù.
	tDestSlot = GetSameItem(m_UserBankItem[tSourceSlot], INVENTORY_SLOT);
	
	/***************************ÀºÇà ¾÷¹« Ã³¸®********************************************/
	if(tDestSlot >= 0)							// Ç×»ó »õ·ÎÀÌ Ãß°¡ µÇ´Â°ÍÀ» ±âÁØÀ¸·Î Ã³¸®
	{		
		m_UserItem[tDestSlot].sCount += sCount;
	}
	else
	{											//	Ãß°¡
		tDestSlot = GetEmptySlot(INVENTORY_SLOT);

		if(tDestSlot == -1) 
		{
			result = FAIL; goto go_result; 
		}

		m_UserItem[tDestSlot].sLevel = m_UserBankItem[tSourceSlot].sLevel;
		m_UserItem[tDestSlot].sSid = m_UserBankItem[tSourceSlot].sSid;
		m_UserItem[tDestSlot].sDuration = m_UserBankItem[tSourceSlot].sDuration;
		m_UserItem[tDestSlot].sBullNum = m_UserBankItem[tSourceSlot].sBullNum;
		m_UserItem[tDestSlot].sCount = sCount;
		for(i = 0; i < MAGIC_NUM; i++) m_UserItem[tDestSlot].tMagic[i] = m_UserBankItem[tSourceSlot].tMagic[i];
		m_UserItem[tDestSlot].tIQ = m_UserBankItem[tSourceSlot].tIQ;
		m_UserItem[tDestSlot].iItemSerial = m_UserBankItem[tSourceSlot].iItemSerial;
	}
	
	/**************************À¯Àú ÀºÇà ÀÎº¥ Ã³¸®*********************************************/
	if(sCount >= sHaveCount) ReSetItemSlot(&m_UserBankItem[tSourceSlot]);	
	else m_UserBankItem[tSourceSlot].sCount -= sCount;
	
	/**************************DB Update Ã³¸®*********************************************/
	if(UpdateUserBank() == FALSE)
	{
		for(i = 0; i < TOTAL_ITEM_NUM; i++)// ¾ÆÀÌÅÛ Á¤º¸ º¹¿ø
		{
			m_UserItem[i] = MyItem[i];
		}
		m_UserBankItem[tSourceSlot] = BackItem;

		result = FAIL;
	}

go_result:
	TempBuf.Add(BANK_ITEM_MOVE_RESULT);

	if(result == FAIL)
	{
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	result = (BYTE)0x02;
	TempBuf.Add(result);
	TempBuf.Add((BYTE)tSourceSlot);
	TempBuf.Add(m_UserBankItem[tSourceSlot].sLevel);
	TempBuf.Add(m_UserBankItem[tSourceSlot].sSid);
	TempBuf.Add(m_UserBankItem[tSourceSlot].sDuration);
	TempBuf.Add(m_UserBankItem[tSourceSlot].sBullNum);
	TempBuf.Add(m_UserBankItem[tSourceSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserBankItem[tSourceSlot].tMagic[i]);
	TempBuf.Add(m_UserBankItem[tSourceSlot].tIQ);
	TempBuf.Add((BYTE)tDestSlot);
	TempBuf.Add(m_UserItem[tDestSlot].sLevel);
	TempBuf.Add(m_UserItem[tDestSlot].sSid);
	TempBuf.Add(m_UserItem[tDestSlot].sDuration);
	TempBuf.Add(m_UserItem[tDestSlot].sBullNum);
	TempBuf.Add(m_UserItem[tDestSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tDestSlot].tMagic[i]);
	TempBuf.Add(m_UserItem[tDestSlot].tIQ);
	Send(TempBuf, TempBuf.GetLength());

	m_iCurWeight += iWeight;
	GetRecoverySpeed();
}


///////////////////////////////////////////////////////////////////////////
//	ÀºÇà¿¡ ÀÔ±ÝÇÑ´Ù.
///////////////////////////////////////////////////////////////////////////
void USER::BankInPutDN(TCHAR *pBuf) //¸öÈË²Ö¿â ´æÈë½ðÇ®
{
	CBufferEx TempBuf;

	BYTE result; 
	int index = 0;
	DWORD BackBankDN = 0, BackMyDN = 0;

	DWORD InputDN = GetDWORD(pBuf, index);

	TempBuf.Add(BANK_ITEM_MOVE_RESULT);

	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE)//Î´ÖªBUG
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
	if(InputDN <= 0 || InputDN > m_dwDN) 
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
	
	BackMyDN = m_dwDN;
	BackBankDN = m_dwBankDN;
										// ÀºÇà¿¡ ÀÔ±Ý
	if(!CheckMaxValueReturn(m_dwBankDN, InputDN))
	{									// ´Ü, MAX°ªÀÌ¸é Â÷¾×Àº...
		CheckMaxValue(m_dwBankDN, InputDN);
		if(m_dwBankDN < InputDN) InputDN = 0;
		else InputDN = m_dwBankDN - InputDN;
	}
	else m_dwBankDN += InputDN;
										// °¡Áö°í ÀÖ´Â ¼ÒÁö±Ý¿¡¼­ »«´Ù.
	if(InputDN >= m_dwDN) m_dwDN = 0;
	else m_dwDN -= InputDN;
//	if(InputDN == m_dwDN) m_dwDN = 0;
//	else m_dwDN -= InputDN;

	if(UpdateUserBank() == FALSE)		// DB UpDate
	{
		m_dwDN = BackMyDN;
		m_dwBankDN = BackBankDN;

		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	result = (BYTE)0x03;				// 3 : DN ÀÔ±Ý
	TempBuf.Add(result);

	TempBuf.Add(m_dwBankDN);			// ÀºÇà³» ÀÔ±ÝÇÑ ÃÑ±Ý¾×
	TempBuf.Add(m_dwDN);				// ¼ÒÁöÇÑ ÃÑ±Ý¾×

	Send(TempBuf, TempBuf.GetLength());
}

///////////////////////////////////////////////////////////////////////////
//	ÀºÇà¿¡ Ãâ±ÝÇÑ´Ù.
///////////////////////////////////////////////////////////////////////////
void USER::BankOutPutDN(TCHAR *pBuf)  //¸öÈË²Ö¿â È¡³ö½ðÇ®
{
	CBufferEx TempBuf;

	BYTE result; 
	int index = 0;
	DWORD BackBankDN = 0, BackMyDN = 0;

	DWORD OutputDN = GetDWORD(pBuf, index);

	TempBuf.Add(BANK_ITEM_MOVE_RESULT);

	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE)//Î´ÖªBUG
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
	if(OutputDN <= 0 || OutputDN > m_dwBankDN)			// ³Ê¹« Å©¸é
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	BackMyDN = m_dwDN;					// ¹é¾÷
	BackBankDN = m_dwBankDN;
										// »ç¿ëÀÚ ¼ÒÁö±Ý¿¡ ÇÕ»êÇÑ´Ù.
	if(!CheckMaxValueReturn(m_dwDN, OutputDN))
	{									// ´Ü, MAX°ªÀÌ¸é Â÷¾×Àº...
		CheckMaxValue(m_dwDN, OutputDN);
		if(m_dwDN < OutputDN) OutputDN = 0;
		else OutputDN = m_dwDN - OutputDN;
	}
	else m_dwDN += OutputDN;
										// ÀºÇà¿¡¼­ »«´Ù.
	if(OutputDN >= m_dwBankDN) m_dwBankDN = 0;
	else m_dwBankDN -= OutputDN;

	if(UpdateUserBank() == FALSE)		// DB UpDate
	{
		m_dwDN = BackMyDN;
		m_dwBankDN = BackBankDN;

		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	result = (BYTE)0x04;				// 4 : DN Ãâ±Ý
	TempBuf.Add(result);

	TempBuf.Add(m_dwBankDN);			// ÀºÇà³» ÀÔ±ÝÇÑ ÃÑ±Ý¾×
	TempBuf.Add(m_dwDN);				// ¼ÒÁöÇÑ ÃÑ±Ý¾×

	Send(TempBuf, TempBuf.GetLength());
}

///////////////////////////////////////////////////////////////////////////
//	¸®½ºÅ¸Æ®ÇÏ¸é °ÔÀÓ»ó¿¡¼­ ¿¬°áÀÌ ²ö¾îÁø´Ù.
//
void USER::RestartReq(TCHAR *pBuf)
{
	if( m_bLogOut == TRUE ) return;
	if( m_state != STATE_GAMESTARTED ) return;

	if(m_UserItem[39].sSid == 1184)
	{
		if(m_dwTransTime != 0 && m_iSkin == 170){
			if(m_UserItem[39].tMagic[5] == 1)	m_iSkin = 8;
			else if(m_UserItem[39].tMagic[5] == 2) m_iSkin = 8;
			else m_iSkin = 8;
		}else if(m_dwTransTime != 0 && m_iHair == 10015){
			if(m_UserItem[39].tMagic[5] == 1)	m_iHair = 10001;
			else if(m_UserItem[39].tMagic[5] == 2) m_iHair = 10002;
			else m_iHair = 0;
		}		
	}	

	g_pMainDlg->BridgeServerUserRestart(m_uid, m_strUserID);
	return;





	if(m_tGuildWar == GUILD_WARRING && m_dwFieldWar > 0)		
	{									// ÇÊµåÀü ÁßÀÌ¸é ¾Ë·ÁÁØ´Ù.
		if(m_bGuildMaster) 
		{
			CString strMsg = _T("");
			strMsg.Format( IDS_USER_GUILD_DEFEAT, m_strGuildName);
			SendGuildWarFieldEnd((LPTSTR)(LPCTSTR)strMsg);// Ç×º¹
		}
	}

	if(m_bNowBuddy == TRUE)				// ¹öµðÁßÀÌ¸é Åëº¸ÇÑ´Ù.
	{
		for(int i = 0; i < MAX_BUDDY_USER_NUM; i++)
		{
			if(strcmp(m_MyBuddy[i].m_strUserID, m_strUserID) == 0) SendBuddyUserLeave(i);
		}
	}

	if(m_bNowTrading == TRUE) 
	{
		BYTE result = 0x00;
		USER *pTradeUser = NULL;
		if(m_iTradeUid != -1)	pTradeUser = GetUser(m_iTradeUid - USER_BAND);

		if(pTradeUser != NULL)	pTradeUser->SendExchangeFail(result, (BYTE)0x05);
	}

	if(m_tGuildHouseWar == GUILD_WARRING) CheckGuildUserListInGuildHouseWar(); // ´Ù¸¥ À¯ÀúµéÀº ¹»ÇÏ³ª Ã¼Å©..

	if(m_bLive == USER_DEAD) m_sHP = m_sMaxHP;

	if(!UpdateMemBankDataOnly()) return;
	if(!UpdateMemAccountBankDataOnly()) return;
	if(!UpdateUserData(TRUE)) return;
	ReInitMemoryDB();

	// alisia
//	if(SendRestartLoginResult() == FALSE) return;
	int		index = 0;
	m_state = STATE_LOGOUT;

	index = 0;
	SetByte(m_TempBuf, RESTART_RESULT, index );
	SetByte(m_TempBuf, SUCCESS, index );
	Send(m_TempBuf, index);
	// alisia


	m_nHavePsiNum = 0;
	m_tIsOP = 0;
	MAP *pMap = NULL;

	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) goto go_result;

	pMap = g_zone[m_ZoneIndex];
	if( m_curx < 0 || m_curx >= pMap->m_sizeMap.cx ) goto go_result;
	if( m_cury < 0 || m_cury >= pMap->m_sizeMap.cy ) goto go_result;

	if( g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser == USER_BAND + m_uid ) // ¸Ê¿¡¼­ »ç¶óÁø´Ù.
		::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);

go_result:
	::ZeroMemory(m_strUserID, sizeof(m_strUserID));

	SendMyInfo(TO_INSIGHT, INFO_DELETE);

//	m_state = STATE_GAMERESTART;		// Á¢¼Ó »óÅÂ¸¦ ¹Ù²Û´Ù.
}

void USER::RestartReqWithThread(TCHAR *pBuf)
{
	LOGINOUTTHREADDATA *pLIOTD;
	pLIOTD = new LOGINOUTTHREADDATA;
	pLIOTD->CODE = RESTART_REQ;
	pLIOTD->UID = m_uid;
	pLIOTD->ID[0] = '\0';

	EnterCriticalSection( &m_CS_LoginData );
	RecvLoginData.AddTail(pLIOTD);
	nLoginDataCount = RecvLoginData.GetCount();
	LeaveCriticalSection( &m_CS_LoginData );
}

///////////////////////////////////////////////////////////////////////////
//	¸®½ºÅ¸Æ®ÇÏ¸é °ÔÀÓ»ó¿¡¼­ ACCOUNT LOGIN»óÅÂ·Î µÇµ¹¾Æ °£´Ù.
//
BOOL USER::SendRestartLoginResult()
{
	int		index = 0;
	BYTE	result = FAIL, error_code = 0;
	int		old_index = 0;
	TCHAR	szTemp[8096];

	if(!LoadCharData(m_strAccount))
	{
		// Load Character Data Fail...
		error_code = UNKNOWN_ERR;
		goto result_send;
	}
	else
	{
		m_state = STATE_CONNECTED;
		result = SUCCESS;
	}

result_send:

	index = 0;
	SetByte(m_TempBuf, RESTART_RESULT, index );
	SetByte(m_TempBuf, result, index );

	old_index = index;
	::CopyMemory(szTemp, m_TempBuf, old_index);

	if(result == SUCCESS)
	{
		SetByte(m_TempBuf, (BYTE)m_nCharNum, index);
	}
	else
	{
		SetByte(m_TempBuf, error_code, index);
		Send(m_TempBuf, index);
		return FALSE;
	}

	if(m_nCharNum != 0 && result == SUCCESS)
	{
		for(int i = 0; i < 3; i++)
		{
			if(m_strChar[i][0])	
			{
				SetByte(m_TempBuf, (BYTE)i, index);
				if(!SendCharInfo(m_strChar[i], m_TempBuf, index))
				{
					error_code = UNKNOWN_ERR;
					SetByte(szTemp, error_code, old_index);
					Send(szTemp, old_index);
					return FALSE;
				}
			}
		}
	}
	Send(m_TempBuf, index);
	return TRUE;
}


BOOL USER::IsPKZone(USER *pUser)
{
	BOOL mePK = FALSE;
	BOOL youPK = FALSE;

	int index = 0;

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return FALSE;

	if(m_tGuildWar == GUILD_WARRING && m_dwFieldWar > 0) 
	{
		if(pUser->m_dwGuild == m_dwGuild) return FALSE;			// ÇÊµåÀüÀÏ¶§ °°Àº ±æµå¿øÀº PKÇÒ¼ö ¾ø´Ù.
	}
	if(m_curz == 409) return TRUE;
	if(m_ZoneIndex < 0 || m_ZoneIndex >= g_TownPotal.GetSize()) return FALSE;

//	if(!g_TownPotal[m_ZoneIndex]->iPkMode) return FALSE;		// PK ÇÒ¼öÀÖ´Â ¾ø´Â Áö¿ª(»óÁ¡¾È)ÀÌ´Ù
	ZONEINFO* pZoneInfo = GetZoneInfo( m_curz );
	if( !pZoneInfo ) return FALSE;
	if( !pZoneInfo->iPkMode ) return FALSE;
//21 guildhouse war
	if(m_curz == 12) return TRUE;		// ^^ ÀÓ½ÃÄÚµå....

	int metype = CheckInvalidMapType();
	if(metype == 1 || metype == 4 ) return FALSE;    //Å£Å£·âÉ³Ä®½ûÖ¹PKÐÞ¸ÄºóµÄ

	int type = pUser->CheckInvalidMapType();
	if(type == 1|| type == 4) return FALSE; //Å£Å£·âÉ³Ä®½ûÖ¹PKÐÞ¸ÄºóµÄ


	// ·Î¿­·³ºí Ã¼Å©
#ifndef _EVENT_RR		// Áö¿ª ÃÖ°­ ÀÌº¥Æ®°¡ ¾øÀ¸¸é
	if( m_curz == g_RR.m_iZoneNum )
	{
		if( g_RR.m_bRRStatus != RR_START ) return FALSE;
	}
#endif

	if(!CheckInvalidZoneState(type))
	{
		if(m_dwGuild > 0 && pUser->m_dwGuild == m_dwGuild) return FALSE;

		return TRUE;
	}
	else
	{
//		if(type < 0 || type >= g_arMapTable.GetSize()) return TRUE;
//		if(metype < 0 || metype >= g_arMapTable.GetSize()) return TRUE;

		int mapindex = GetGuildMapIndex(metype);
		if(mapindex <= -1 || mapindex >= g_arMapTable.GetSize()) return TRUE;
		mePK = (BOOL)g_arMapTable[mapindex]->m_tPkMode;

		if( pUser->m_ZoneIndex < 0 || pUser->m_ZoneIndex >= g_zone.GetSize() ) return FALSE;
		if( pUser->m_curx >= g_zone[pUser->m_ZoneIndex]->m_sizeMap.cx || pUser->m_curx < 0 ) return FALSE;
		if( pUser->m_cury >= g_zone[pUser->m_ZoneIndex]->m_sizeMap.cy || pUser->m_cury < 0 ) return FALSE;
		type = ((g_zone[pUser->m_ZoneIndex]->m_pMap[pUser->m_curx][pUser->m_cury].m_dwType & 0xFF00 ) >> 8);
		mapindex = GetGuildMapIndex(type);
		// if(mapindex <= -1) return TRUE;
		if(mapindex < 0 || mapindex >= g_arMapTable.GetSize()) return FALSE;
		youPK = (BOOL)g_arMapTable[mapindex]->m_tPkMode;

//		mePK = (BOOL)g_arMapTable[metype]->m_tPkMode;
//		type = ((g_zone[pUser->m_ZoneIndex]->m_pMap[pUser->m_curx][pUser->m_cury].m_dwType & 0xFF00 ) >> 8);
//		youPK = (BOOL)g_arMapTable[type]->m_tPkMode;

		if(mePK != youPK) return FALSE;
		else return mePK;
	}

	return TRUE;				
}

BOOL USER::IsCity()
{
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return FALSE;
	if(m_curx >= g_zone[m_ZoneIndex]->m_sizeMap.cx || m_curx < 0) return FALSE;
	if(m_cury >= g_zone[m_ZoneIndex]->m_sizeMap.cy || m_cury < 0) return FALSE;

	int type = ((g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_dwType & 0xFF00 ) >> 8);

	if(type == 1) return TRUE;
	if(type == 12) return TRUE;		// ´ë·ÃÀåµµ µµ½Ã¾È¿¡ ÀÖÀ¸¹Ç·Î

	return FALSE;				
}

BOOL USER::IsInPKC()
{
	if(m_curz == 45 || m_curz == 40 || m_curz == 43 || m_curz == 44 || m_curz == 58)
		return TRUE;
	return FALSE;
}
///////////////////////////////////////////////////////////////////////////
//	À¯ÀúÀÇ ±âº» ¼öÄ¡¸¦ ¸ÅÁ÷¼Ó¼º¿¡ º¯È­µÈ µ¥ÀÌÅÍ·Î ´õÇØ¼­ Àû¿ëÇÑ´Ù.  
//
void USER::SetUserToMagicUser(int iMaxHPUp)
{
	int iTempHP = 0, iTempPP = 0;

	m_sMagicSTR = m_sSTR + m_DynamicUserData[MAGIC_STR_UP];
	m_sMagicCON = m_sCON + m_DynamicUserData[MAGIC_CON_UP];
	m_sMagicDEX = m_sDEX + m_DynamicUserData[MAGIC_DEX_UP];
	m_sMagicVOL = m_sVOL + m_DynamicUserData[MAGIC_VOL_UP];
	m_sMagicWIS = m_sWIS + m_DynamicUserData[MAGIC_WIS_UP];

	m_sMagicMaxHP = g_sHPConst[m_byClass] * m_sMagicCON + g_sHPLV[m_byClass] * (m_sLevel - 1) + g_sHPAdd[m_byClass];
	m_sMagicMaxPP = g_sPPConst[m_byClass] * m_sMagicWIS + g_sPPLV[m_byClass] * (m_sLevel - 1) + g_sPPAdd[m_byClass];
	m_sMagicMaxSP = g_sSPConst[m_byClass] * m_sMagicCON + g_sSPLV[m_byClass] * (m_sLevel - 1) + g_sSPAdd[m_byClass];

	iTempHP = (int)((double)m_DynamicEBodyData[EBODY_CON_TO_HP] / 100 * (double)m_sMagicCON);
	iTempPP = (int)((double)m_DynamicEBodyData[EBODY_WIS_TO_PP] / 100 * (double)m_sMagicWIS);

	m_sMagicMaxHP += m_DynamicUserData[MAGIC_MAX_HP_UP] + (int)((double)m_DynamicEBodyData[EBODY_CON_TO_HP] / 100 * (double)m_sMagicCON);	// ÀÏ´ÜÀ§¿¡¼­ ±âº»ÀûÀÎ°ÍÀ» °è»ê + ¿©±â¼­ ¸ÅÁ÷¼Ó¼º	
	m_sMagicMaxPP += m_DynamicUserData[MAGIC_MAX_PP_UP] + (int)((double)m_DynamicEBodyData[EBODY_WIS_TO_PP] / 100 * (double)m_sMagicWIS);
	m_sMagicMaxSP += m_DynamicUserData[MAGIC_MAX_SP_UP];
	
	//×°±¸Ôö¼ÓÑªÁ¿°Ù·Ö±È
	if(m_nHPPoint)
	{
		iTempHP = m_sMagicMaxHP*m_nHPPoint/100;
		m_sMagicMaxHP +=iTempHP;
	}	
	//if(m_DynamicUserData[MAGIC_HP_RATING_UP])
	//{
	//	iTempHP = m_sMagicMaxHP*m_DynamicUserData[MAGIC_HP_RATING_UP]/100;
	//	m_sMagicMaxHP +=iTempHP;
	//}	


	m_iMaxWeight = (m_sMagicCON + m_sMagicSTR) * 10 + g_ClassWeight[m_byClass] + m_sLevel * 6;// ÇöÀç µé¼öÀÖ´Â ÃÖ´ë ¹«°ÔÀ» ±¸ÇÑ´Ù.
	m_iMaxWeight += (int)((double)m_DynamicEBodyData[EBODY_STR_TO_WEIGHT] / 100 * (double)m_sMagicSTR);

	// °í·¹º§ÀÇ À¯Àú¿¡°Ô Æ¯º°ÇÑ ´É·ÂÀ»...
	if(m_sLevel >= ADD_USER_LEVEL) 
	{
		m_sMagicMaxHP += g_arUserLevel[m_sLevel - ADD_USER_LEVEL]->m_sHP;
		m_sMagicMaxPP += g_arUserLevel[m_sLevel - ADD_USER_LEVEL]->m_sPP;
		m_iMaxWeight += g_arUserLevel[m_sLevel - ADD_USER_LEVEL]->m_sWeight;
	}
    m_iMaxWeight = m_iMaxWeight * 3;//300%¸ºÖØÂú
    m_iMaxWeight += (int)((double)m_DynamicEBodyData[EBODY_WEIGHT_UP] / 100 * (double)m_iMaxWeight);

	// ÃÖ´ë HP ¹ö±×¼öÁ¤ jjs
	switch(iMaxHPUp)
	{
	case -1 :
	case 0:
		break;
	case 1:
		m_sMagicMaxHP = (int)(m_sMagicMaxHP * 1.2 + 0.5);
		break;
	}

	if(m_sHP > m_sMagicMaxHP) m_sHP = m_sMagicMaxHP;	// ÃÖ´ë HP Á¦ÇÑ
	
}

///////////////////////////////////////////////////////////////////////////
//	À¯Àú°¡ ÇöÀç °¡Áö°í ÀÖ´Â ½ºÅ³Áß sSid¿Í ÀÏÄ¡ÇÏ´Â ½ºÅ³ÀÇ ·¹º§À» ±¸ÇÑ´Ù.
//
short USER::GetSkillLevel(BYTE tWeaponClass, short sSid)
{
	if(tWeaponClass < BRAWL || tWeaponClass > FIREARMS) return 0;

	int iStart = tWeaponClass * SKILL_NUM; 
	short sLevel = 0;
	for(int i = iStart; i < iStart + SKILL_NUM; i++)
	{
		if(m_UserSkill[i].sSid == sSid)
		{
			sLevel = m_UserSkill[i].tLevel;
			if(sLevel < 0) sLevel = 0;
			break;
		}
	}

	return sLevel;
}

///////////////////////////////////////////////////////////////////////////
//	À¯Àú¸¦ ÁöÁ¤½Ã°£µ¿¾È Hast »óÅÂ·Î ¸¸µç´Ù.
//
void USER::SetHaste(int iTime)
{
	if(m_tIsOP == 1) return;					// ¿î¿µÀÚ ÀÏ¶§´Â »çÀÌ¿À´Ð»óÅÂ°¡ º¯ÇÏ¸é ¾ÈµÈ´Ù. (Åõ¸íÀÌ Ç®·Á¼­...)

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}

	ClearAbnormalTime(PSI_ONE_TIME);

	m_dwHasteTime = iTime * 1000;		// jjs07 2001.11.23
	m_dwLastHasteTime = GetTickCount();

	if(g_bDebug) SendSystemMsg(_T("Haste Start"), SYSTEM_NORMAL, TO_ME);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	AddAbnormalInfo(ABNORMAL_HASTE);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	
	Send(TempBuf, TempBuf.GetLength());
}

///////////////////////////////////////////////////////////////////////////
//
void USER::SetShield(int iTime)
{
	if(m_tIsOP == 1) return;					

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}

	BOOL bExistShield = CheckAbnormalInfo(ABNORMAL_SHIELD);

	ClearAbnormalTime(PSI_ONE_TIME);
	AddAbnormalInfo(ABNORMAL_SHIELD);

	m_dwShieldTime = iTime * 1000;		// jjs07 2001.11.23
	//m_dwShieldTime = DEFAULT_PSI_DELAY + (DWORD)((double)(iVol*1000)/3.0 + 0.5);	// old
	m_dwLastShieldTime = GetTickCount();

	if(g_bDebug) SendSystemMsg(_T("Shield Start"), SYSTEM_NORMAL, TO_ME);

	if(bExistShield == FALSE)
	{
		CBufferEx TempBuf;
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		SendInsight(TempBuf, TempBuf.GetLength());
		//SendExactScreen(TempBuf, TempBuf.GetLength());
	}
}
void USER::SetBigShield(int iTime)
{
	if(m_tIsOP == 1) return;					// ¿î¿µÀÚ ÀÏ¶§´Â »çÀÌ¿À´Ð»óÅÂ°¡ º¯ÇÏ¸é ¾ÈµÈ´Ù. (Åõ¸íÀÌ Ç®·Á¼­...)

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}

	BOOL bExistShield = CheckAbnormalInfo(ABNORMAL_SHIELD) || CheckAbnormalInfo(ABNORMAL_BIGSHIELD);

	ClearAbnormalTime(PSI_ONE_TIME);
	AddAbnormalInfo(ABNORMAL_BIGSHIELD);

	m_dwBigShieldTime = iTime * 1000;		// jjs07 2001.11.23
	//m_dwShieldTime = DEFAULT_PSI_DELAY + (DWORD)((double)(iVol*1000)/3.0 + 0.5);	// old
	m_dwLastBigShieldTime = GetTickCount();

	if(g_bDebug) SendSystemMsg(_T("Big Shield Start"), SYSTEM_NORMAL, TO_ME);

	if(bExistShield == FALSE)
	{
		CBufferEx TempBuf;
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		SendInsight(TempBuf, TempBuf.GetLength());
		//SendExactScreen(TempBuf, TempBuf.GetLength());
	}
}

///////////////////////////////////////////////////////////////////////////
//	ÁöÁ¤µÈ ½Ã°£µ¿¾È À¯ÀúÀÇ DEX °ªÀ» 10 Áõ°¡ ½ÃÅ²´Ù.
//
void USER::SetDexUp(int iTime)
{
	if(m_tIsOP == 1) return;					// ¿î¿µÀÚ ÀÏ¶§´Â »çÀÌ¿À´Ð»óÅÂ°¡ º¯ÇÏ¸é ¾ÈµÈ´Ù. (Åõ¸íÀÌ Ç®·Á¼­...)

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		m_dwMaxHPUpTime = 0;

		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}

	ClearAbnormalTime(PSI_ONE_TIME);

	m_dwDexUpTime = iTime * 1000;
	m_dwLastDexUpTime = GetTickCount();

	if(g_bDebug) SendSystemMsg(_T("Dex Up Start"), SYSTEM_NORMAL, TO_ME);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
//	TempBuf.Add(ABNORMAL_PSI);
//	TempBuf.Add(ABNORMAL_DEX_UP);
	AddAbnormalInfo(ABNORMAL_DEX_UP);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());
}

///////////////////////////////////////////////////////////////////////////
//	ÁöÁ¤µÈ ½Ã°£µ¿¾È À¯ÀúÀÇ Max HP °ªÀ» 20% Áõ°¡ ½ÃÅ²´Ù.
//
void USER::SetMaxHPUp(int iTime)
{
	if(m_tIsOP == 1) return;					// ¿î¿µÀÚ ÀÏ¶§´Â »çÀÌ¿À´Ð»óÅÂ°¡ º¯ÇÏ¸é ¾ÈµÈ´Ù. (Åõ¸íÀÌ Ç®·Á¼­...)

	ClearAbnormalTime(PSI_ONE_TIME);

	m_dwMaxHPUpTime = iTime * 1000;
	m_dwLastMaxHPUpTime = GetTickCount();

	if(g_bDebug) SendSystemMsg(_T("Max HP Up Start"), SYSTEM_NORMAL, TO_ME);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
//	TempBuf.Add(ABNORMAL_PSI);
//	TempBuf.Add(ABNORMAL_MAX_HP_UP);
	AddAbnormalInfo(ABNORMAL_MAX_HP_UP);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());
	SetUserToMagicUser(1);
	//-----------------------------------------
	//yskang 0.7 MAX HP UP ¶Ù´Â µµÁß¿¡ Ç®¸®¸é ¸Õ°¡ °É¸° °Í Ã³·³ Àá±ñ ¸ØÃã Çö»ó ¹ö°Å ¼öÁ¤
	CBufferEx	TempBuf2;
	TempBuf2.Add(MAX_HP_EXIT);
	TempBuf2.Add(m_sHP);
	TempBuf2.Add(m_sMagicMaxHP);
	Send(TempBuf2,TempBuf2.GetLength());
	//SendMyInfo(TO_ME, INFO_MODIFY); //ÀüÃ¼ µ¥ÀÌÅ¸´Â º¸³»Áö ¾Ê´Â´Ù.
	//--------------------------------------
	if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
}

void USER::SetAdamantine(int iTime)
{
	if( m_tIsOP == 1 ) return;

	ClearAbnormalTime(PSI_TWO_TIME);
	m_dwAdamantineTime = iTime * 1000;
	m_dwLastAdamantineTime = GetTickCount();

	if( g_bDebug ) SendSystemMsg( _T("Adamantine Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;
	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
//	TempBuf.Add( ABNORMAL_PSI );
//	TempBuf.Add( ABNORMAL_ADAMANTINE );
	AddAbnormalInfo(ABNORMAL_ADAMANTINE);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send( TempBuf, TempBuf.GetLength() );
}

void USER::SetMightyWeapon(int iTime)
{
	if( m_tIsOP == 1 ) return;

	ClearAbnormalTime(PSI_TWO_TIME);
	m_dwMightyWeaponTime = iTime * 1000;
	m_dwLastMightyWeaponTime = GetTickCount();

	if( g_bDebug ) SendSystemMsg( _T("MightyWeapon Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;
	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
//	TempBuf.Add( ABNORMAL_PSI );
//	TempBuf.Add( ABNORMAL_MIGHTYWEAPON );
	AddAbnormalInfo(ABNORMAL_MIGHTYWEAPON);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);

	Send( TempBuf, TempBuf.GetLength() );
}

void USER::SetBerserker(int iTime)
{
	if( m_tIsOP == 1 ) return;

	ClearAbnormalTime(PSI_TWO_TIME);
	m_dwBerserkerTime = iTime * 1000;
	m_dwLastBerserkerTime = GetTickCount();

	if( g_bDebug ) SendSystemMsg( _T("Berserker Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;
	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
	AddAbnormalInfo(ABNORMAL_BERSERKER);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	SendInsight( TempBuf, TempBuf.GetLength() );
//	SendExactScreen(TempBuf, TempBuf.GetLength());
}
///////////////////////////////////////////////////////////////////////////////
//	ÀÌµ¿ ¼Óµµ¸¦ 20% ºü¸£°Ô ÇØÁØ´Ù.
//
void USER::SetFastRun(int iTime)
{
	if( m_tIsOP == 1 ) return;

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		m_dwMaxHPUpTime = 0;

		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}

	ClearAbnormalTime(PSI_ONE_TIME);
	m_dwFastRunTime = iTime * 1000;
	m_dwLastFastRunTime = GetTickCount();

	if( g_bDebug ) SendSystemMsg( _T("FastRun Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;
	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
	AddAbnormalInfo(ABNORMAL_FASTRUN);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	SendInsight( TempBuf, TempBuf.GetLength() );
//	SendExactScreen(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////
//	ÁöÁ¤µÈ ½Ã°£µ¿¾È º¸Á¶ »çÀÌ¿À´ÐÀ» ¾²Áö ¸øÇÏ°Ô ÇÑ´Ù.
//
BOOL USER::SetMindShock(int iTime)
{
	if( m_tIsOP == 1 ) return FALSE;

	int iRandom = myrand(1, 100);
	if(iRandom > SUCCESS_RATE_MIND_SHOCK) return FALSE;	// ¸¶ÀÎµå ¼îÅ©´Â ¼º°ø È®À²ÀÌ ÀÖ´Ù.

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		m_dwMaxHPUpTime = 0;

		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}
    if ( m_dwBigShieldTime != 0 )
	{
	CBufferEx TempttBuf;
            DeleteAbnormalInfo(ABNORMAL_BIGSHIELD);
			TempttBuf.Add(SET_USER_STATE);
			TempttBuf.Add(m_uid + USER_BAND);
			TempttBuf.Add(m_dwAbnormalInfo);
			TempttBuf.Add(m_dwAbnormalInfo_);		
		    SendInsight(TempttBuf, TempttBuf.GetLength());
	}
	ClearAbnormalTime(PSI_ONE_TIME);
	m_dwMindShockTime = (iTime * 1000 )+ 5000;	// 15ÃÊ·Î º¯°æ 2002.11.14
	m_dwLastMindShockTime = GetTickCount();

	if( g_bDebug ) SendSystemMsg( _T("Mind Shock Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;
	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
	AddAbnormalInfo(ABNORMAL_MINDSHOCK);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
//	SendInsight( TempBuf, TempBuf.GetLength() );
	SendExactScreen(TempBuf, TempBuf.GetLength());

	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////
//	Mind Shock ·Î ºÎÅÍ º¸È£ÇÑ´Ù.
//
void USER::SetMindGuard(int iTime)
{
	if( m_tIsOP == 1 ) return;

	m_dwMindShockTime = 0;
	m_dwLastMindShockTime = GetTickCount();
	DeleteAbnormalInfo(ABNORMAL_MINDSHOCK);

	m_dwMindGuardTime = iTime * 1000;
	m_dwLastMindGuardTime = GetTickCount();
	AddAbnormalInfo(ABNORMAL_MINDGUARD);

	if( g_bDebug ) SendSystemMsg( _T("Mind Guard Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;
	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
//	SendInsight( TempBuf, TempBuf.GetLength() );
	SendExactScreen(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////
//	ÀÚ½ÅÀÇ ¸¶¹ý¹æ¾î·ÂÀ» ³ôÀÎ´Ù.
//
void USER::SetPsiShield(int iTime)
{
	if( m_tIsOP == 1 ) return;

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		m_dwMaxHPUpTime = 0;

		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}

	ClearAbnormalTime(PSI_ONE_TIME);
	m_dwPsiShieldTime = iTime * 1000;
	m_dwLastPsiShieldTime = GetTickCount();

	if( g_bDebug ) SendSystemMsg( _T("Psionic Shield Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;

	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
	AddAbnormalInfo(ABNORMAL_PSISHIELD);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	SendInsight( TempBuf, TempBuf.GetLength() );
//	SendExactScreen(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////
//	½¯µå¸¦ ¹«½ÃÇÏ°í µ¥¹ÌÁö¸¦ ÁÖ¸ç 20%ÀÇ È®À²·Î ½¯µå¸¦ ÆÄ±«ÇÑ´Ù.
//
void USER::SetPiercingShield(int iTime)
{
	if( m_tIsOP == 1 ) return;

	if(CheckAbnormalInfo(ABNORMAL_MAX_HP_UP))
	{
		m_dwMaxHPUpTime = 0;

		SetUserToMagicUser(-1);
		SendMyInfo(TO_ME, INFO_MODIFY);
		if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	}

	ClearAbnormalTime(PSI_ONE_TIME);
	m_dwPiercingShieldTime = iTime * 1000;
	m_dwLastPiercingShieldTime = GetTickCount();

	if( g_bDebug ) SendSystemMsg( _T("Piercing Shield Start"), SYSTEM_NORMAL, TO_ME );

	CBufferEx TempBuf;
	TempBuf.Add( SET_USER_STATE );
	TempBuf.Add( m_uid + USER_BAND );
	AddAbnormalInfo(ABNORMAL_PIERCING_SHIELD);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
//	SendInsight( TempBuf, TempBuf.GetLength() );
	SendExactScreen(TempBuf, TempBuf.GetLength());
}

///////////////////////////////////////////////////////////////////////////
//	ÁöÁ¤µÈ ½Ã°£µ¿¾È ¾îµÒ¼ÓÀÇ ÀûÀ» Ã£´Â´Ù.
//
void USER::SetHide(int iTime)
{
/*
	if(m_tIsOP == 1) return;					// ¿î¿µÀÚ ÀÏ¶§´Â »çÀÌ¿À´Ð»óÅÂ°¡ º¯ÇÏ¸é ¾ÈµÈ´Ù. (Åõ¸íÀÌ Ç®·Á¼­...)

	m_tPsiAbnormal = ABNORMAL_HIDE;
	m_dwHideTime = iTime * 1000;		// jjs07 2001.11.23
	//m_dwHideTime = 10000;	// old
	m_dwLastHideTime = GetTickCount();

	if(g_bDebug) SendSystemMsg(_T("Hide Start"), SYSTEM_NORMAL, TO_ME);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(ABNORAML_PSI);
	TempBuf.Add(ABNORMAL_HIDE);
	TempBuf.Add((BYTE)0);
	TempBuf.Add((BYTE)0);
	TempBuf.Add((BYTE)0);
	TempBuf.Add((BYTE)0);
	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());	// ½¯µå ¶Ç´Â ÇÏÀÌµå°¡ ÀÌ»ó
*/
}

/////////////////////////////////////////////////////////////////////////////////////////
//	¼ø°£È¸ÇÇ, ÅÚ·¹Æ÷Æ®Ã³¸®
//
BOOL USER::Teleport(int xpos, int ypos)
{
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return FALSE;

	BYTE result = FAIL;
	int will_x, will_y;
	int index = 0;
	int	nCurMapType, nTellMapType;

	CPoint ptTeleport;

	CPoint startPt;

	will_x = xpos;	// ¿òÁ÷ÀÌ·Á´Â Á¡
	will_y = ypos;

	if(will_x <= 0) will_x = m_curx;
	if(will_y <= 0) will_y = m_cury;

	if(will_x >= g_zone[m_ZoneIndex]->m_sizeMap.cx) will_x = g_zone[m_ZoneIndex]->m_sizeMap.cx - 1;
	if(will_y >= g_zone[m_ZoneIndex]->m_sizeMap.cy) will_y = g_zone[m_ZoneIndex]->m_sizeMap.cy - 1;

	startPt.x = m_curx;
	startPt.y = m_cury;

	CPoint pt = FindNearAvailablePoint_S(will_x, will_y);
	if(pt.x != -1 && pt.y != -1) 
	{
		// ³»°¡ ·Î¿­·³ºí °æ±âÀå¿¡ ÀÖ°í
#ifndef _EVENT_RR 
		if( m_curz == g_RR.m_iZoneNum )
		{
			// ÇöÀç Á¡°ú °¡°íÀÚ ÇÏ´Â Á¡ÀÇ ¼Ó¼ºÀÌ ´Ù¸£´Ù¸é
			if( CheckInvalidMapType() != ((g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_dwType & 0xFF00 ) >> 8) )
			{
				return FALSE;
			}
		}
#else
		if( m_curz == g_RR.m_iZoneNum || m_curz == 61 ||  m_curz == 62 ||  m_curz == 63 )
		{
			// ÇöÀç Á¡°ú °¡°íÀÚ ÇÏ´Â Á¡ÀÇ ¼Ó¼ºÀÌ ´Ù¸£´Ù¸é
			if( CheckInvalidMapType() != ((g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_dwType & 0xFF00 ) >> 8) )
			{
				return FALSE;
			}
		}
#endif

		nCurMapType = CheckInvalidMapType();
		nTellMapType = ((g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_dwType & 0xFF00 ) >> 8);

		// ¸¸¾à ³»°¡ ¼­ÀÖ´Â °÷ÀÌ °ø¼ºÁö¿ªÀÌ ¾Æ´Ï°í ÅÚÇÏ´Â ÁÂÇ¥°¡ °ø¼ºÁö¿ªÀÌ¶ó¸é ¸®ÅÏ
		if( (nCurMapType != 8 && nCurMapType != 10 && nCurMapType != 15)
			&& (nTellMapType == 8 || nTellMapType == 10 || nTellMapType == 15) )
			return FALSE;

		ptTeleport = ConvertToClient(pt.x, pt.y);		
		if (m_curx < 0 || m_cury < 0)	//bug ×ø±ê±¨´í
			return FALSE;


		if(InterlockedCompareExchange((LONG*)&g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_lUser, 
			(long)g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, (long)0) == (long)0)
		{
			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);
		}
		else return FALSE;

		m_curx = pt.x;
		m_cury = pt.y;

		result = SUCCESS;
	}
	else return FALSE;
	
	m_tDir = GetDirection(startPt, pt);		// ÇöÀç ¹æÇâÀ» Ç¥½ÃÇÑ´Ù.;

	index = 0;
	SetByte(m_TempBuf, PSI_TOWN_POTAL, index);
	SetByte(m_TempBuf, result, index);

	SetByte(m_TempBuf, 0, index);				// Ç×»ó °°ÀºÁ¸  // ³ªÁß¿¡ ¾ø¾Ù°Í

	SetInt(m_TempBuf, m_uid + USER_BAND, index);

	SetShort(m_TempBuf, ptTeleport.x, index);
	SetShort(m_TempBuf, ptTeleport.y, index);
	SetShort(m_TempBuf, m_curz, index);
	
	Send(m_TempBuf, index);

//	SendMyTownPotal(TO_INSIGHT, INFO_TOWNPOTAL);
	SendMyInfo(TO_INSIGHT, INFO_TOWNPOTAL);
	SightRecalc();

	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////////////////
//	Á×Àº À¯Àú³Ä?
//
void USER::IsDeadUser()
{
	if(m_bLive == USER_LIVE || m_tIsOP == TRUE ) return;
	//if(m_sHP > 0) return;

	int i;
	int iPotalZone = -1;

	int rand = 0;

	int x = 0;		// Å¸¿îÆ÷Å»¿¡ ÀúÀåµÈ DBÁÂÇ¥¸¦ ±âÁØÀ¸·Î µµ½Ã¿¡¼­ »ì¾Æ³²	
	int y = 0;

	CPoint ptPotal, pt;

	ptPotal.x = 1; ptPotal.y = 1;
/*
	for(i = 0; i < g_TownPotal.GetSize(); i++)
	{
		if(g_TownPotal[i]->iZone == m_curz) { iPotalIndex = i; break; }
	}

	if(iPotalIndex <0) return;
*/
//	pt = GetTownPotal(iPotalZone);
//	x = pt.x;
//	y = pt.y;

//	if(iPotalZone <0) return;
//	x = g_TownPotal[iPotalIndex]->iPotalX;
//	y = g_TownPotal[iPotalIndex]->iPotalY;
/*
	if(g_TownPotal[iPotalIndex]->iPotalZone != m_curz)
	{
		SetZoneIndex(g_TownPotal[iPotalIndex]->iPotalZone);		// Á¸ ÀÎµ¦½º¼ÂÆÃ
		m_curz = g_TownPotal[iPotalIndex]->iPotalZone;			// Á¸ º¯È¯(Á×¾úÀ»¶§ °¡±î¿î ¸¶À»·Î ÀÌµ¿ÇØ¾ßÇÏ¹Ç·Î Á¸À» ¹Ù²Û´Ù.)
	}
*/
	for(i = 0; i < g_TownPotal.GetSize(); i++)					// ¾Æ´Ï¸é °¡±î¿î µµ½Ã·Î ÀÌµ¿ÇÑ´Ù.
	{
		if(g_TownPotal[i]->iZone == m_curz) { iPotalZone = i; break; }
	}

	if(iPotalZone < 0) return;

	CPoint temp = ConvertToClient(m_curx, m_cury);

	if(g_TownPotal[iPotalZone]->iPotalX <= 0) { x = g_TownPotal[iPotalZone]->iPotalX1; y = g_TownPotal[iPotalZone]->iPotalY1; }
	else if(g_TownPotal[iPotalZone]->iPotalX1 <= 0) { x = g_TownPotal[iPotalZone]->iPotalX; y = g_TownPotal[iPotalZone]->iPotalY; }
	else
	{
		int dx1 = abs(g_TownPotal[iPotalZone]->iPotalX - temp.x);
		int dy1 = abs(g_TownPotal[iPotalZone]->iPotalY - temp.y);

		int dx2 = abs(g_TownPotal[iPotalZone]->iPotalX1 - temp.x);
		int dy2 = abs(g_TownPotal[iPotalZone]->iPotalY1 - temp.y);

		if( (dx1 + dy1) < (dx2 + dy2) ) { x = g_TownPotal[iPotalZone]->iPotalX; y = g_TownPotal[iPotalZone]->iPotalY; }
		else							{ x = g_TownPotal[iPotalZone]->iPotalX1; y = g_TownPotal[iPotalZone]->iPotalY1; }
	}

	// alisia
	/*
	if(g_TownPotal[iPotalZone]->iPotalZone != m_curz)
	{
		SetZoneIndex(g_TownPotal[iPotalZone]->iPotalZone);		// Á¸ ÀÎµ¦½º¼ÂÆÃ
		m_curz = g_TownPotal[iPotalZone]->iPotalZone;			// Á¸ º¯È¯(Á×¾úÀ»¶§ °¡±î¿î ¸¶À»·Î ÀÌµ¿ÇØ¾ßÇÏ¹Ç·Î Á¸À» ¹Ù²Û´Ù.)
	}

	ptPotal = ConvertToServer(x, y);			// °°Àº Á¸Àº µû·Î ÁÂÇ¥º¯È­¸¦ ...

	i = SEARCH_TOWN_POTAL_COUNT;				// ÁÂÇ¥¸¦ Ã£±âÀ§ÇÑ È½¼ö
	
	if(IsMovable_S(ptPotal.x, ptPotal.y) == FALSE)
	{
		while(TRUE)								// Å¸¿îÆ÷Å» ·¥´ý ÁÂÇ¥¸¦ ¾ò´Â´Ù.
		{
			rand = myrand(-TOWN_POTAL_SIZE, TOWN_POTAL_SIZE);
			ptPotal.x += rand; ptPotal.y += rand;
			
			if(IsMovable_S(ptPotal.x, ptPotal.y) == TRUE) break;
			i--;
			if(i <= 0) 
			{
				ptPotal = ConvertToServer(x, y);
				break;
			}
		}
	}

	m_curx = ptPotal.x;
	m_cury = ptPotal.y;
	*/
	ZoneMoveReq( g_TownPotal[iPotalZone]->iPotalZone, x, y );
}

/////////////////////////////////////////////////////////////////////////////////////////
//¹¥»÷¼ÆËã
//
int USER::GetFinalDamage(USER *pUser, int nInitDamage, BYTE tMyWeapon,BOOL &bIsCritical,int max)//yskang 0.3
{
	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return 0;

	int iFinalDamage = 0, iFinalTemp;

	int iBasic = (int)((double)pUser->m_sMagicCON/3 + 0.5);
	if(iBasic < 0) iBasic = 0;

	BYTE tWeaponClass = 255;
	BOOL bCanUseSkill = pUser->IsCanUseWeaponSkill(tWeaponClass);

	int		iDefense = 1;
	double	dIron = 0;
	double	dShield = 0;
	double	dGuard = 0;
	double	dVital = 0;
	double	dCAttack = 0;
	double	dABDefense = 0;
	double	dDefenseUP = 0;
	double	dAdamantine = 0;
	double	dBerserker = 0;

	int		iSkillSid = 0;
	int		iIronLevel = 0;
	int		iGuardLevel = 0;
	int		iCounterAttackLevel = 0;
	int		iVitalLevel = 0;
	int		iABDefenseLevel = 0;
	int		iDefenseUPLevel = 0;

	int		iGS = 0;
	int		iVS = 0;
	int		iCA = 0;

	int i = 0;
	int iRandom = 0;
	int tClass = tWeaponClass * SKILL_NUM;
	int	tMyClass = tMyWeapon * SKILL_NUM;

	int iRandomProtect = (int)((double)XdY(1, 1000) / 10 + 0.5);



	iDefense = pUser->GetDefense();						// ¹æ¾î±¸

	if(tWeaponClass != 255)
	{
		for(i = tClass; i < tClass + SKILL_NUM; i++)	// IronSkill
		{
			iSkillSid = pUser->m_UserSkill[i].sSid;

			if(iSkillSid == SKILL_IRON)					// 0 index
			{
				iIronLevel = pUser->m_UserSkill[i].tLevel;
				if(iIronLevel < 0) iIronLevel = 0;
				
				// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
				if(iIronLevel >= 1) 
				{
					iIronLevel += pUser->m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ pUser->m_DynamicUserData[MAGIC_ALL_SKILL_UP];
				}
				
				if(iIronLevel >= SKILL_LEVEL) iIronLevel = SKILL_LEVEL - 1;
				if(iSkillSid >= g_arSkillTable.GetSize()) continue;
				
				iBasic = (int)((double)iBasic * (1 + (double)g_arSkillTable[iSkillSid]->m_arInc.GetAt(iIronLevel) / 100));
			}

			if(iSkillSid == SKILL_CRITICAL_GUARD)					// Critical Guard 11 index
			{
				iGuardLevel = pUser->m_UserSkill[i].tLevel;		
				if(iGuardLevel < 0) iGuardLevel = 0;
				
				// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
				if(iGuardLevel >= 1) iGuardLevel += pUser->m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ pUser->m_DynamicUserData[MAGIC_ALL_SKILL_UP];
				
				if(iGuardLevel >= SKILL_LEVEL) iGuardLevel = SKILL_LEVEL - 1;
				if(iSkillSid >= g_arSkillTable.GetSize()) continue;
				
				iRandom = (int)((double)XdY(1, 1000) / 10 + 0.5);
				if(max==0  ) {//Èç¹ûÊÇ±ØÉ±¡£¡£¾ÍÎÞÊÓÉÁ±Ü¼¼ÄÜ¡£
					if(iRandom < g_arSkillTable[iSkillSid]->m_arSuccess.GetAt(iGuardLevel))
					{
						if ( m_byClass == 3)
						{
							dGuard = (double)(nInitDamage * (double)(g_arSkillTable[iSkillSid]->m_arInc.GetAt(iGuardLevel) - 40 )/100.0 );
						}else  if ( m_byClass == 0)
						{
							dGuard = (double)(nInitDamage * (double)(g_arSkillTable[iSkillSid]->m_arInc.GetAt(iGuardLevel) - 10 )/100.0 );
						}else{
						
							dGuard = (double)(nInitDamage * (double)g_arSkillTable[iSkillSid]->m_arInc.GetAt(iGuardLevel)/100.0);
					}
				}
			}
		}  
	        if(iSkillSid == SKILL_BACK_ATTACK)					// CounterAttack 2 index
			{
				if (pUser->m_dwFANTAnTime  == 0 )	/////³¬¼¶·´µ¯
				{
					if(m_byClass == FIREARMS || m_byClass == STAFF|| m_byClass == JUDGE ) 
					{
						if(tMyWeapon != 255) continue;	
					}
				}

				iCounterAttackLevel = pUser->m_UserSkill[i].tLevel;		
				if(iCounterAttackLevel < 0) iCounterAttackLevel = 0;
				
				// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
				if(iCounterAttackLevel >= 1) iCounterAttackLevel += pUser->m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ pUser->m_DynamicUserData[MAGIC_ALL_SKILL_UP];
				
				if(iCounterAttackLevel >= SKILL_LEVEL) iCounterAttackLevel = SKILL_LEVEL - 1;
				if(iSkillSid >= g_arSkillTable.GetSize()) continue;
				
				if(GetDistance(pUser->m_curx, pUser->m_cury, 1) == FALSE && pUser->m_dwFANTAnTime == 0 ) iCA = 0;	

				else
				{
					iRandom = (int)((double)XdY(1, 1000) / 10 + 0.5);
					if(iRandom < g_arSkillTable[iSkillSid]->m_arSuccess.GetAt(iCounterAttackLevel)) iCA = 1;
				}				
				
				if(m_dwFANTAnTime != 0)	//·´»÷ÊØ»¤
				dCAttack = (double)(nInitDamage * iCA * (double)((g_arSkillTable[iSkillSid]->m_arInc.GetAt(iCounterAttackLevel) +30) / 100.0) ); 
		     else 
				dCAttack = (double)(nInitDamage * iCA * (double)((g_arSkillTable[iSkillSid]->m_arInc.GetAt(iCounterAttackLevel) +20) / 100.0) ); 


			}

			if(iSkillSid == SKILL_ABSOLUTE_DEFENSE)					// Absolute Defense
			{
				iABDefenseLevel = pUser->m_UserSkill[i].tLevel;		
				if(iABDefenseLevel < 0) iABDefenseLevel = 0;
				
				// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
				if(iABDefenseLevel >= 1) iABDefenseLevel += pUser->m_DynamicUserData[MAGIC_ALL_SKILL_UP];
				
				if(iABDefenseLevel >= SKILL_LEVEL) iABDefenseLevel = SKILL_LEVEL - 1;
				if(iSkillSid >= g_arSkillTable.GetSize()) continue;
				
				iRandom = (int)((double)XdY(1, 1000) / 10 + 0.5);
				if(iRandom < g_arSkillTable[iSkillSid]->m_arSuccess.GetAt(iABDefenseLevel))
				{
					dABDefense = (double)(iDefense * (double)g_arSkillTable[iSkillSid]->m_arInc.GetAt(iABDefenseLevel)/100.0);
				}
			}
			if(iSkillSid == SKILL_DEFENSE_UP)					
			{
				iDefenseUPLevel = pUser->m_UserSkill[i].tLevel;		
				if(iDefenseUPLevel < 0) iDefenseUPLevel = 0;
				
				// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
				if(iDefenseUPLevel >= 1) iDefenseUPLevel += pUser->m_DynamicUserData[MAGIC_ALL_SKILL_UP];
				
				if(iDefenseUPLevel >= SKILL_LEVEL) iDefenseUPLevel = SKILL_LEVEL - 1;
				if(iSkillSid >= g_arSkillTable.GetSize()) continue;
				
				iRandom = (int)((double)XdY(1, 1000) / 10 + 0.5);
				if(iRandom < g_arSkillTable[iSkillSid]->m_arSuccess.GetAt(iDefenseUPLevel))
				{
					dDefenseUP = (double)(iDefense * (double)g_arSkillTable[iSkillSid]->m_arInc.GetAt(iDefenseUPLevel)/100.0);
				}
			}
		}
	}

	// ½¯µå °è»ê
	if(pUser->m_bNecklaceOfShield && pUser->m_dwShieldTime != 0)		
	{
		if(m_dwPiercingShieldTime != 0)	dShield = (double)(nInitDamage * 0.01);
		else							dShield = (double)(nInitDamage * 0.10);
	}
	if(pUser->m_bNecklaceOfShield && pUser->m_dwBigShieldTime != 0)		
	{
		if(m_dwPiercingShieldTime != 0)	dShield = (double)(nInitDamage * 0.01);
		else							dShield = (double)(nInitDamage * 0.10);
	}
	else if(pUser->m_bNecklaceOfShield || pUser->m_dwShieldTime != 0 )	
	{
		if(m_dwPiercingShieldTime != 0)	dShield = 0;
		else dShield = (double)(nInitDamage * 0.10);
	}
	else if( pUser->m_dwBigShieldTime !=0 && !pUser->m_bNecklaceOfShield)
	{
		if(m_dwPiercingShieldTime != 0)	dShield = 0;
		else dShield = (double)(nInitDamage * 0.10);
	}
	if(m_dwPiercingShieldTime != 0)	
	{
        
		iRandom = (int)((double)myrand(1, 1000) / 10 + 0.5);
		if(iRandom < SUCCESS_RATE_PIERCING_SHIELD)	// ÇÇ¾î½Ì ½¯µå´Â 10% È®À²·Î ½¯µå¸¦ ±ü´Ù.
		{
		  if ( pUser->m_dwShieldTime !=0 ) 
		  {
			pUser->m_dwShieldTime = 0;
			pUser->m_dwLastShieldTime = GetTickCount();
         	CBufferEx TempBuf;
			pUser->DeleteAbnormalInfo(ABNORMAL_SHIELD);
			TempBuf.Add(SET_USER_STATE);
			TempBuf.Add((int)(pUser->m_uid + USER_BAND));
			TempBuf.Add(pUser->m_dwAbnormalInfo);
			TempBuf.Add(pUser->m_dwAbnormalInfo_);			
			pUser->SendInsight(TempBuf, TempBuf.GetLength());
		  }
		  if ( pUser->m_dwBigShieldTime !=0 )
		  {
			pUser->m_dwBigShieldTime = 0;
			pUser->m_dwLastBigShieldTime = GetTickCount();
	        CBufferEx TempqqBuf;
			pUser->DeleteAbnormalInfo(ABNORMAL_BIGSHIELD);
			TempqqBuf.Add(SET_USER_STATE);
			TempqqBuf.Add((int)(pUser->m_uid + USER_BAND));
			TempqqBuf.Add(pUser->m_dwAbnormalInfo);
			TempqqBuf.Add(pUser->m_dwAbnormalInfo_);		
			pUser->SendInsight(TempqqBuf, TempqqBuf.GetLength());
		  }

		}
	}
	
	if(pUser->m_bNecklaceOfShield) pUser->SendAccessoriDuration(SID_NECKLACE_OF_SHIELD);

	/*if( pUser->m_dwAdamantineTime != 0 ) //ÕâÀï²»ÔÚ¼ÆËã 101Ä§·¨ 105Ä§·¨    ¼ÓÄ§·¨Ö±½ÓÏÔÊ¾ÊôÐÔ
	{
		dAdamantine = (double)( (double)iDefense * 0.1 );
	}*/
	/*if( pUser->m_dwBerserkerTime != 0 )
	{
		dBerserker = (double)( (double)iDefense * 0.15 );
	}*/
	//ÐÜ±äÔö¼Ó 15%·À
	//if(pUser->m_iSkin==2){
	//	dBerserker =dBerserker+ (double)( (double)iDefense * 0.15 );
	//}
	

	iDefense = (int)( iDefense + dABDefense + dDefenseUP + dAdamantine + dBerserker );

	if(tMyWeapon != 255)
	{
		for(i = tMyClass; i < tMyClass + SKILL_NUM; i++)	// Vital Critical
		{
			iSkillSid = m_UserSkill[i].sSid;

			if(iSkillSid == SKILL_VITAL_CRITICAL)			// 12 index
			{
				iVitalLevel = m_UserSkill[i].tLevel;		
				if(iVitalLevel < 0) iVitalLevel = 0;
				
				// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
				if(iVitalLevel >= 1) iVitalLevel += m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ m_DynamicUserData[MAGIC_ALL_SKILL_UP];
				
				if(iVitalLevel >= SKILL_LEVEL) iVitalLevel = SKILL_LEVEL - 1;		//ÃÖ´ë 41ÀÌ¹Ç·Î ¸Þ¸ð¸®´Â 40À¸·Î Á¦ÇÑ
				if(iSkillSid >= g_arSkillTable.GetSize()) continue;
				
				iRandom = (int)((double)XdY(1, 1000) / 10 + 0.5);
				if(iRandom < g_arSkillTable[iSkillSid]->m_arSuccess.GetAt(iVitalLevel))//´©´Ì³É¹¦
				{
					dVital = (double)(g_arSkillTable[iSkillSid]->m_arInc.GetAt(iVitalLevel)/100.0);
					if(iRandomProtect <= RANDOM_PROTECT && pUser->m_bEarringOfProtect)	// ¼­Æ÷Æ® ±Í°ÉÀÌ
					{
						dVital = 0;
						pUser->SendAccessoriDuration(SID_EARRING_OF_PROTECT);
					}
				}
			}
		}
	}

	if(dVital > 0)//´©´Ì
	{
		bIsCritical = TRUE; //yskang 0.3
		//ÖÇÁ¦±ä³ÉÔ¶³ÌÉËº¦Á¦
		int v4 = 0;
		if(m_byClass == JUDGE||m_byClass==FIREARMS)
		{
			v4=(int)((double)pUser->m_DynamicEBodyData[EBODY_WIS_TO_DAMAGE] *0.01 * pUser->m_sMagicWIS);
		}
		iFinalDamage = (int)(nInitDamage - (iDefense * dVital * (double)pUser->m_DynamicEBodyData[EBODY_VITAL_RESIST]/100 + \
			                 (int)((double)pUser->m_DynamicEBodyData[EBODY_CON_TO_VITAL_RESIST] / 100 * pUser->m_sMagicCON) + \
							 (int)((double)pUser->m_DynamicEBodyData[EBODY_DEX_TO_VITAL_RESIST] / 100 * pUser->m_sMagicDEX) + \
							 iBasic + dShield + dGuard)); 
	}
	else
	{
		iFinalDamage = (int)(nInitDamage - (iDefense + iBasic + dShield + dGuard)); 
	}

	if(iFinalDamage < 0) iFinalDamage = 0;
	if(iFinalDamage <= 15)
	{
		iFinalTemp = iFinalDamage;
		iFinalDamage += (int)((double)nInitDamage * 0.2 + 1.5);	// ÃÖ¼Ò´ë¹ÌÁö¸¦ ÃÖ´ë 15À¸·Î ÇÑ´Ù.
		if(iFinalDamage > 15) iFinalDamage = 15;
		iFinalDamage = max(iFinalDamage, iFinalTemp);
	}
		
	if(dCAttack > 0)	//	·´»÷  ·´»÷ÊØ»¤
	{
		iDefense = (int)((double)m_sMagicCON/3 + 0.5);		// ¹æ¾î±¸
		iCA = (int)dCAttack - iDefense;						// ÃÖÁ¾ ¹Ý°Ý µ¥¹ÌÁö

		iCA = iCA * (1 - (int)((double)pUser->m_DynamicEBodyData[EBODY_BACK_RESIST]/100));
		iCA -= ((int)((double)pUser->m_DynamicEBodyData[EBODY_CON_TO_BACK_RESIST] / 100 * pUser->m_sMagicCON) + \
			   (int)((double)pUser->m_DynamicEBodyData[EBODY_DEX_TO_BACK_RESIST] / 100 * pUser->m_sMagicDEX)  );

		if(iCA > 0)	SetDamage(iCA);							// µ¥¹ÌÁö °è»êÀ» ÇÑ´Ù.
	    pUser->SendDamageNum(0,m_uid+USER_BAND,iCA);//È­·´»÷¼¼ÄÜ´òÈËÏÔÊ¾Êý×Ö
		if(m_lDeadUsed == 1)  //   ·´»÷ËÀ
			GetLevelDownExp(USER_PK, -1, FALSE,m_strUserID);
	}

	return iFinalDamage;
}

////////////////////////////////////////////////////////////////////////////////////
//	¿¹¾àµÈ ¾ÆÀÌµðÀÎÁö °Ë»çÇÑ´Ù.
//
BOOL USER::IsReservedID(char *szName)
{
	int nSize = sizeof(g_pszReservedID)/sizeof(char*);
	CString szCheck = szName;
	CString szCheck2;

	szCheck.MakeLower();

	for (int i=0; i< nSize; i++) 
	{
		szCheck2 = g_pszReservedID[i];
		szCheck2.MakeLower();

		if(szCheck.Find(szCheck2) != -1) return TRUE;

	}

	return FALSE;
}

BOOL USER::IsReservedLoveName(char *szName)
{
	int nSize = sizeof(g_pszReservedLoveName)/sizeof(char*);
	CString szCheck3 = szName;
	CString szCheck4;

	szCheck3.MakeLower();

	for (int i=0; i< nSize; i++) 
	{
		szCheck4 = g_pszReservedLoveName[i];
		szCheck4.MakeLower();

		if(szCheck3.Find(szCheck4) != -1) return TRUE;

	}

	return FALSE;
}

CPoint USER::FindNearAvailablePoint_S(int x, int y)
{
	if(x <= -1 || y <= -1) return CPoint(-1,-1);
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return CPoint(-1,-1);
	if(x >= g_zone[m_ZoneIndex]->m_sizeMap.cx || y >= g_zone[m_ZoneIndex]->m_sizeMap.cy) return CPoint(-1,-1);

	if(IsMovable_S( x, y ))
	{
		return CPoint(x,y);
	}

	CPoint t;
	int tempX = x, tempY = y;
	int i;

	int dir[25][2];

//	X					Y
	dir[0][0]  =  0;		dir[0][1] =  0;		// 
	dir[1][0]  = -1;		dir[1][1] =  0;		// 
	dir[2][0]  = -1;		dir[2][1] =  1;		// 
	dir[3][0]  =  0;		dir[3][1] =  1;		// 
	dir[4][0]  =  1;		dir[4][1] =  1;		// 

	dir[5][0]  =  1;		dir[5][1] =  0;		// 
	dir[6][0]  =  1;		dir[6][1] = -1;		// 
	dir[7][0]  =  0;		dir[7][1] = -1;		// 
	dir[8][0]  = -1;		dir[8][1] = -1;		// 
	dir[9][0]  = -2;		dir[9][1] = -1;		// 

	dir[10][0] = -2;		dir[10][1] =  0;	// 
	dir[11][0] = -2;		dir[11][1] =  1;	// 
	dir[12][0] = -2;		dir[12][1] =  2;	// 
	dir[13][0] = -1;		dir[13][1] =  2;	// 
	dir[14][0] =  0;		dir[14][1] =  2;	// 

	dir[15][0] =  1;		dir[15][1] =  2;	// 
	dir[16][0] =  2;		dir[16][1] =  2;	// 
	dir[17][0] =  2;		dir[17][1] =  1;	// 
	dir[18][0] =  2;		dir[18][1] =  0;	// 
	dir[19][0] =  2;		dir[19][1] = -1;	// 

	dir[20][0] =  2;		dir[20][1] = -2;	// 
	dir[21][0] =  1;		dir[21][1] = -2;	// 
	dir[22][0] =  0;		dir[22][1] = -2;	// 
	dir[23][0] = -1;		dir[23][1] = -2;	// 
	dir[24][0] = -2;		dir[24][1] = -2;	// 

	for( i = 0; i < 25; i++)
	{
		if( IsMovable_S( tempX + dir[i][0], tempY + dir[i][1] ) )
		{
			return CPoint( tempX + dir[i][0], tempY + dir[i][1] );
		}
	}

	return CPoint(-1,-1);
}

CPoint USER::FindNearAvailablePoint_S(int zone,int x, int y)
{
	int ZoneIndex = -1;
	for(int j = 0; j < g_zone.GetSize(); j++)
	{
		if( g_zone[j]->m_Zone == zone )
		{
			ZoneIndex = j;
			break;
		}
	}
	if(x <= -1 || y <= -1) return CPoint(-1,-1);
	if( ZoneIndex < 0 || ZoneIndex >= g_zone.GetSize() ) return CPoint(-1,-1);
	if(x >= g_zone[ZoneIndex]->m_sizeMap.cx || y >= g_zone[ZoneIndex]->m_sizeMap.cy) return CPoint(-1,-1);

	if(IsMovable_S(zone, x, y ))
	{
		return CPoint(x,y);
	}

	CPoint t;
	int tempX = x, tempY = y;
	int i;

	int dir[25][2];

//	X					Y
	dir[0][0]  =  0;		dir[0][1] =  0;		// 
	dir[1][0]  = -1;		dir[1][1] =  0;		// 
	dir[2][0]  = -1;		dir[2][1] =  1;		// 
	dir[3][0]  =  0;		dir[3][1] =  1;		// 
	dir[4][0]  =  1;		dir[4][1] =  1;		// 

	dir[5][0]  =  1;		dir[5][1] =  0;		// 
	dir[6][0]  =  1;		dir[6][1] = -1;		// 
	dir[7][0]  =  0;		dir[7][1] = -1;		// 
	dir[8][0]  = -1;		dir[8][1] = -1;		// 
	dir[9][0]  = -2;		dir[9][1] = -1;		// 

	dir[10][0] = -2;		dir[10][1] =  0;	// 
	dir[11][0] = -2;		dir[11][1] =  1;	// 
	dir[12][0] = -2;		dir[12][1] =  2;	// 
	dir[13][0] = -1;		dir[13][1] =  2;	// 
	dir[14][0] =  0;		dir[14][1] =  2;	// 

	dir[15][0] =  1;		dir[15][1] =  2;	// 
	dir[16][0] =  2;		dir[16][1] =  2;	// 
	dir[17][0] =  2;		dir[17][1] =  1;	// 
	dir[18][0] =  2;		dir[18][1] =  0;	// 
	dir[19][0] =  2;		dir[19][1] = -1;	// 

	dir[20][0] =  2;		dir[20][1] = -2;	// 
	dir[21][0] =  1;		dir[21][1] = -2;	// 
	dir[22][0] =  0;		dir[22][1] = -2;	// 
	dir[23][0] = -1;		dir[23][1] = -2;	// 
	dir[24][0] = -2;		dir[24][1] = -2;	// 

	for( i = 0; i < 25; i++)
	{
		if( IsMovable_S(zone, tempX + dir[i][0], tempY + dir[i][1] ) )
		{
			return CPoint( tempX + dir[i][0], tempY + dir[i][1] );
		}
	}

	return CPoint(-1,-1);
}

//////////////////////////////////////////////////////////////////////////////////
//	Å¬¶óÀÌ¾ðÆ®ÁÂÇ¥ ±âÁØÀ¸·Î ÇöÀçÁÂÇ¥¿Í ÁÖº¯ 25ÁÂÇ¥ Áß¿¡ ¿òÁ÷ÀÏ ¼ö ÀÖ´Â Á¡ÀÌ ÀÖ´ÂÁö ÆÇ´Ü.
//
CPoint USER::FindNearAvailablePoint_C(int x, int y)
{
	if( IsMovable_C( x, y ) )
	{
		return CPoint(x,y);
	}

	CPoint t = ConvertToServer( x, y );

	if( t.x == -1 || t.y == -1 )
	{
		return CPoint(-1,-1);
	}

	int tempX = t.x, tempY = t.y;
	int i;

	int dir[25][2];

//	X					Y
	dir[0][0]  =  0;		dir[0][1] =  0;		// 
	dir[1][0]  = -1;		dir[1][1] =  0;		// 
	dir[2][0]  = -1;		dir[2][1] =  1;		// 
	dir[3][0]  =  0;		dir[3][1] =  1;		// 
	dir[4][0]  =  1;		dir[4][1] =  1;		// 

	dir[5][0]  =  1;		dir[5][1] =  0;		// 
	dir[6][0]  =  1;		dir[6][1] = -1;		// 
	dir[7][0]  =  0;		dir[7][1] = -1;		// 
	dir[8][0]  = -1;		dir[8][1] = -1;		// 
	dir[9][0]  = -2;		dir[9][1] = -1;		// 

	dir[10][0] = -2;		dir[10][1] =  0;	// 
	dir[11][0] = -2;		dir[11][1] =  1;	// 
	dir[12][0] = -2;		dir[12][1] =  2;	// 
	dir[13][0] = -1;		dir[13][1] =  2;	// 
	dir[14][0] =  0;		dir[14][1] =  2;	// 

	dir[15][0] =  1;		dir[15][1] =  2;	// 
	dir[16][0] =  2;		dir[16][1] =  2;	// 
	dir[17][0] =  2;		dir[17][1] =  1;	// 
	dir[18][0] =  2;		dir[18][1] =  0;	// 
	dir[19][0] =  2;		dir[19][1] = -1;	// 

	dir[20][0] =  2;		dir[20][1] = -2;	// 
	dir[21][0] =  1;		dir[21][1] = -2;	// 
	dir[22][0] =  0;		dir[22][1] = -2;	// 
	dir[23][0] = -1;		dir[23][1] = -2;	// 
	dir[24][0] = -2;		dir[24][1] = -2;	// 

	for( i = 0; i < 25; i++)
	{
		if( IsMovable_S( tempX + dir[i][0], tempY + dir[i][1] ) )
		{
			return ConvertToClient( tempX + dir[i][0], tempY + dir[i][1] );			
		}
	}

	return CPoint(-1,-1);
}

///////////////////////////////////////////////////////////////////////////////////////
//	Å¬¶óÀÌ¾ðÆ® ÁÂÇ¥¸¦ ±âÁØÀ¸·Î x, y °¡ ÀÌµ¿ÇÒ ¼ö ÀÖ´Â Á¡ÀÎÁö ÆÇ´Ü
//
BOOL USER::IsMovable_C(int x, int y)
{
	CPoint t = ConvertToServer( x, y );

	if( t.x == -1 || t.y == -1 ) return FALSE;

	return IsMovable_S(t.x, t.y);
}

///////////////////////////////////////////////////////////////////////////////////////
//	¼­¹öÁÂÇ¥¸¦ Å¬¶óÀÌ¾ðÆ® ÁÂÇ¥·Î ¹Ù²Û´Ù.
//
CPoint USER::ConvertToClient(int x, int y)
{
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return CPoint(-1,-1);
	if(!g_zone[m_ZoneIndex]) return CPoint(-1, -1);

	int tempx, tempy;
	int temph = g_zone[m_ZoneIndex]->m_vMoveCell.m_vDim.cy / 2 - 1;

	if(x <= -1 || y <= -1) return CPoint(-1,-1); 
	if( y >= g_zone[m_ZoneIndex]->m_sizeMap.cy || x >= g_zone[m_ZoneIndex]->m_sizeMap.cx ) return CPoint(-1,-1);

	tempx = x - temph + y;
	tempy = y - x + temph;

	return CPoint( tempx, tempy );
}

///////////////////////////////////////////////////////////////////////////////////////
//	À¯ÀúÁ¤º¸¸¦ ¹öÆÛ¿¡ ÀúÀåÇÑ´Ù.
//
void USER::FillUserInfo(char *pBuf, int &index, BYTE flag)
{
	int nLen = 0, i;

	if( m_state != STATE_GAMESTARTED && flag == INFO_MODIFY ) return;

	SetByte(pBuf, USER_INFO, index);
	SetByte(pBuf, flag, index);
	SetInt(pBuf, m_uid + USER_BAND, index);

	if(flag == INFO_MODIFY || flag == INFO_TOWNPOTAL)
	{
		SetVarString(pBuf, m_strUserID, _tcslen(m_strUserID), index);

		CPoint t = ConvertToClient( m_curx, m_cury );
		if( t.x == -1 || t.y == -1 ) { t.x = 1; t.y = 1; }
		
		SetShort(pBuf, t.x, index);
		SetShort(pBuf, t.y, index);

		SetDWORD(pBuf, m_iSkin, index);
		SetDWORD(pBuf, m_iHair, index);
		SetByte(pBuf, (BYTE)m_sGender, index);
		SetString(pBuf, m_strFace, 10, index);

		for(i = 0; i < EQUIP_ITEM_NUM; i++) SetShort(pBuf, m_UserItem[i].sSid, index);

		SetShort(pBuf, m_sHP, index);
		SetShort(pBuf, m_sMagicMaxHP, index);

		SetByte(pBuf, m_tDir, index);

		SetDWORD(pBuf, m_dwAbnormalInfo, index);		
		SetDWORD(pBuf, m_dwAbnormalInfo_, index);
		SetDWORD( pBuf, 0, index);
		SetDWORD( pBuf, 0, index);
		//¹ú·þ´Ë´¦¶à16 byte 0
		for(int zero = 0;zero<16;zero++)
			SetByte(pBuf, (BYTE)0x00, index);
		SetShort(pBuf, m_sCityRank, index);

		SetInt( pBuf, m_dwGuild, index );

		nLen = strlen(m_strGuildName);
		if(nLen <= 0) nLen = 1;

		SetByte( pBuf, (BYTE)nLen, index );
		SetString( pBuf, m_strGuildName, nLen, index );		// Add Guild Name
		SetShort( pBuf, m_sGuildVersion, index );
		
		SetByte(pBuf, m_byClass, index);
		SetByte(pBuf, m_bPkStatus, index);
		//-- yskang 0.1 Ãß°¡µÇ´Â ÆÐÅ¶.... È£Äª[¾ÖÄª]
	
		nLen = strlen(m_strLoveName);
		if(nLen < 1) nLen =1;
		SetByte(pBuf, (BYTE)nLen, index);//±æÀÌÁöÁ¤
		SetString(pBuf,m_strLoveName,nLen,index);//µ¥ÀÌÅÍ ³Ö±â

		for( i = TOTAL_INVEN_MAX; i < TOTAL_ITEM_NUM-2; i++) SetShort(pBuf, m_UserItem[i].sSid, index);	// EBody

		if(m_UserItem[TOTAL_ITEM_NUM-2].sSid!=-1&&m_UserItem[TOTAL_ITEM_NUM-2].sDuration!=0){
			SetByte(pBuf,(BYTE)(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]),index);
			SetByte( pBuf, 0x00, index );
		}else{
			SetByte(pBuf,(BYTE)(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]),index);
			SetByte( pBuf, 0xff, index );
		}
		SetByte(pBuf, strlen(m_PersonalShopName), index);
		SetString(pBuf, m_PersonalShopName, strlen(m_PersonalShopName), index);
		//¹ú·þ´Ë´¦¶à5byte 0x0a 0x00 0x00 0x00 0x00
		SetByte(pBuf,(BYTE)0x01,index);
		SetByte(pBuf,(BYTE)0x00,index);
		SetByte(pBuf,(BYTE)0x00,index);
		SetByte(pBuf,(BYTE)0x00,index);
		SetByte(pBuf,(BYTE)m_tBabyCall,index);
		if(m_tBabyCall)
		{
			int tmp = strlen(g_szBabyName[m_sBabyID%2]);
			SetByte(pBuf, tmp, index);
			SetString(pBuf, g_szBabyName[m_sBabyID%2],tmp, index);
			SetShort(pBuf,m_sBabyID,index);
		}
	}
	SendHuFaInfo(this,TO_ME);
}
/*
void USER::SendRangeInfoToMe(int min_x, int min_y, int max_x, int max_y, BYTE flag)
{
	int i, j, tuid;
	int throwindex;

	CPoint t;

	USER *pUser = NULL;
	CNpc *pNpc = NULL;
	ItemList* pThrowItem = NULL;
	MAP* pMap = g_zone[m_ZoneIndex];
	if(!pMap) return; 

	for( i = min_y; i < max_y; i++)
	{
		if( i >= pMap->m_sizeMap.cy || i < 0 ) continue;

		for( j = min_x; j < max_x; j++)
		{
			if( j >= pMap->m_sizeMap.cx || j < 0 ) continue;

			tuid = GetUid( j, i );

			if( tuid != 0 )
			{
				if( tuid != m_uid + USER_BAND )
				{
					if( tuid >= USER_BAND && tuid < NPC_BAND )
					{
						pUser = GetUser( tuid - USER_BAND );

						if(pUser->m_state != STATE_GAMESTARTED) continue;

						if( j != pUser->m_curx || i != pUser->m_cury )
						{
							SetUid(j, i, 0);
						}
						else
						{
							SendUserInfo( pUser, flag );
						}
					}
					else if( tuid >= NPC_BAND && tuid < INVALID_BAND)
					{
						pNpc = GetNpc( tuid - NPC_BAND );
						
						if( pNpc )
						{
							if( j != pNpc->m_sCurX || i != pNpc->m_sCurY )
							{
								SetUid( j, i, 0 );
							}
							else
							{
								SendNpcInfo( pNpc, flag );
							}
						}
					}
				}
			}

			throwindex = pMap->m_pMap[j][i].iIndex;

			if( throwindex != -1 && throwindex < MAX_THROW_ITEM )
			{
				pThrowItem = m_pCom->m_ThrowItemArray[throwindex]->m_pItem;

				if( pThrowItem )
				{
					t = ConvertToClient( j, i );

					if( t.x != -1 && t.y != -1 )
					{
						AddItemFieldInfoToMe( pThrowItem, flag, t.x, t.y );
					}
				}
			}
		}
	}
}
*/
void USER::SendRangeInfoToMe(int min_x, int min_y, int max_x, int max_y, BYTE flag)
{
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return;

	int i, j, tuid;
	int throwindex;

	CPoint t;

	USER *pUser = NULL;
	CNpc *pNpc = NULL;
	ItemList* pThrowItem = NULL;
	MAP* pMap = g_zone[m_ZoneIndex];
	if(!pMap) return;

	int index = 0;
	int index_comp = 0;
	int count = 0;

	for( i = min_y; i < max_y; i++)
	{
		if( i >= pMap->m_sizeMap.cy || i < 0 )
		{
			continue;
		}

		for( j = min_x; j < max_x; j++)
		{
			if( j >= pMap->m_sizeMap.cx || j < 0 )
			{
				continue;
			}

			tuid = pMap->m_pMap[j][i].m_lUser;
//			tuid = GetUid( j, i );

			if( tuid != 0 )
			{
				if( tuid != m_uid + USER_BAND )
				{
					if( tuid >= USER_BAND && tuid < NPC_BAND )
					{
						pUser = GetUser( tuid - USER_BAND );
						if ( pUser == NULL ) continue;

						if(pUser->m_state != STATE_GAMESTARTED)
						{
							continue;
						}

						if( j != pUser->m_curx || i != pUser->m_cury )
						{
							SetUid(j, i, 0);
						}
						else
						{
//							SendUserInfo( pUser, flag );
							AddRangeInfoToMe( pUser, flag );
						}
					}
					else if( tuid >= NPC_BAND && tuid < INVALID_BAND)
					{
						pNpc = GetNpc( tuid - NPC_BAND );
						
						if( pNpc )
						{
							if( j != pNpc->m_sCurX || i != pNpc->m_sCurY )
							{
								if(pNpc->m_sDimension > 0) continue;

								SetUid( j, i, 0 );
							}
							else
							{
//								SendNpcInfo( pNpc, flag );
								AddRangeInfoToMe( pNpc, flag );
							}
						}
					}
				}
			}

			throwindex = pMap->m_pMap[j][i].iIndex;

			if( throwindex >= 0 && throwindex < MAX_THROW_ITEM )
			{
				// IKING 2001.1.
				if ( m_pCom->m_ThrowItemArray[throwindex] == NULL )
				{
					return;
				}
				//
				// IKING 2001.1.
				EnterCriticalSection( &m_pCom->m_critThrowItem );

				pThrowItem = m_pCom->m_ThrowItemArray[throwindex]->m_pItem;

				if( pThrowItem )
				{
					t = ConvertToClient( j, i );

					if( t.x != -1 && t.y != -1 )
					{
						if (flag > 4 || flag < 0)  //bug  ×ø±êÒýÆðµÄ±¨´í
							return;
						if(t.x >= 10000 || t.y >= 10000)
							return;		//bug  ×ø±êÒýÆðµÄ±¨´í

						AddItemFieldInfoToMe( pThrowItem, flag, t.x, t.y );
					}
				}

				LeaveCriticalSection( &m_pCom->m_critThrowItem );
			}
		}
	}
}

//////////////////////////////////////////////////////////////////////////////////////////
//	ÀÏÁ¤ ¿µ¿ªÀÇ À¯Àú¿¡°Ô µ¥ÀÌÅÍ¸¦ º¸³½´Ù.
//
void USER::SendToRange(char *pBuf, int index, int min_x, int min_y, int max_x, int max_y)
{
	if( index <= 0 || index >= SEND_BUF_SIZE ) return;

	SEND_DATA* pNewData = NULL;
	pNewData = new SEND_DATA;

	if( !pNewData ) return;

	pNewData->flag = SEND_RANGE;
	pNewData->len = index;

	::CopyMemory( pNewData->pBuf, pBuf, index );

	pNewData->uid = 0;
	pNewData->z = m_curz;
	pNewData->rect.left		= min_x;
	pNewData->rect.right	= max_x;
	pNewData->rect.top		= min_y;
	pNewData->rect.bottom	= max_y;
	pNewData->zone_index = m_ZoneIndex;

	// IKING 2001.1.
	//EnterCriticalSection( &(m_pCom->m_critSendData) );
	//m_pCom->m_arSendData.Add( pNewData );
	//LeaveCriticalSection( &(m_pCom->m_critSendData) );
	//PostQueuedCompletionStatus( m_pCom->m_hSendIOCP, 0, 0, NULL );
	m_pCom->Send(pNewData);
	delete pNewData;
	//
}

////////////////////////////////////////////////////////////////////////////////////
//	Client ÁÂÇ¥¸¦ ¼­¹öÁÂÇ¥·Î º¯È¯ÇÑ´Ù
//
CPoint USER::ConvertToServer(int x, int y)
{
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return CPoint(-1,-1);

	int tempx, tempy;
	int temph = g_zone[m_ZoneIndex]->m_vMoveCell.m_vDim.cy / 2 - 1;

	if(x <= -1 || y <= -1) return CPoint(-1,-1); 
	
	if( y >= g_zone[m_ZoneIndex]->m_vMoveCell.m_vDim.cy || x >= g_zone[m_ZoneIndex]->m_vMoveCell.m_vDim.cx ) return CPoint(-1,-1);

	if( (x+y)%2 == 0 )
	{
		tempx = temph - ( y / 2 ) + ( x / 2 );

		if( x % 2 ) tempy = ( y / 2 ) + ( ( x / 2 ) + 1 );
		else        tempy = ( y / 2 ) + ( x / 2 );

		return CPoint( tempx, tempy );
	}
	else return CPoint(-1,-1);
}

CPoint USER::ConvertToServerByZone(int z, int x, int y)
{
	int i;
	int cx = -1, cy = -1;

	for( i = 0; i < g_zonesize.GetSize(); i++ )
	{
		if( g_zonesize[i] )
		{
			if( g_zonesize[i]->m_Zone == z )
			{
				cx = g_zonesize[i]->m_vMoveCell.m_vDim.cx;
				cy = g_zonesize[i]->m_vMoveCell.m_vDim.cy;

				break;
			}
		}
	}

	if( cx < 0 || cy < 0 ) return CPoint( -1, -1 );

	int tempx, tempy;
	int temph = cy / 2 - 1;

	if(x <= -1 || y <= -1) return CPoint(-1,-1); 
	if( y >= cy || x >= cx ) return CPoint(-1,-1);

	if( (x+y)%2 == 0 )
	{
		tempx = temph - ( y / 2 ) + ( x / 2 );

		if( x % 2 ) tempy = ( y / 2 ) + ( ( x / 2 ) + 1 );
		else        tempy = ( y / 2 ) + ( x / 2 );

		return CPoint( tempx, tempy );
	}
	else return CPoint(-1,-1);
}

////////////////////////////////////////////////////////////////////////////////////
//	À¯Àú ¿µ¿ª¾È¿¡ ¼ÓÇÑ ¸ÊÀÇ ÃÑ ¾ÆÀÌÅÛÀ» ¹öÆÛ¿¡ ÀúÀåÇÑ´Ù.  
//
void USER::AddItemFieldInfoToMe(ItemList *pItem, BYTE type, int x, int y)
{
/*
	if( !pItem && type == ITEM_INFO_MODIFY)
	{
		return;
	}

	if( m_ItemFieldInfoIndex >= 8000 )
	{
		SendItemFieldInfoToMe();
	}

	SetByte( m_ItemFieldInfoBuf, type, m_ItemFieldInfoIndex );

	SetShort( m_ItemFieldInfoBuf, x, m_ItemFieldInfoIndex );
	SetShort( m_ItemFieldInfoBuf, y, m_ItemFieldInfoIndex );

//	if(type == ITEM_INFO_MODIFY)
//	{
		if(pItem->tType == TYPE_ITEM)
		{
			SetShort( m_ItemFieldInfoBuf, pItem->sSid, m_ItemFieldInfoIndex );
			SetDWORD( m_ItemFieldInfoBuf, pItem->sCount, m_ItemFieldInfoIndex );
			SetByte( m_ItemFieldInfoBuf, pItem->tIQ, m_ItemFieldInfoIndex ); 
		}
		else
		{
			SetShort( m_ItemFieldInfoBuf, TYPE_MONEY_SID, m_ItemFieldInfoIndex );
			SetDWORD( m_ItemFieldInfoBuf, pItem->dwMoney, m_ItemFieldInfoIndex );
			SetByte( m_ItemFieldInfoBuf, 0, m_ItemFieldInfoIndex ); 
		}
//	}

	m_ItemFieldInfoCount++;
*/

	int index = 0;
	TCHAR pData[1024];

	SetByte( pData, FIELD_ITEM_INFO, index );
	SetShort( pData, (short)1, index );
	SetByte( pData, type, index );

	SetShort( pData, x, index );
	SetShort( pData, y, index );

	if(pItem->tType == TYPE_ITEM)
	{
		SetShort( pData, pItem->sSid, index );
		SetDWORD( pData, pItem->sCount, index );
		SetByte( pData, pItem->tIQ, index ); 
	}
	else
	{
		SetShort( pData, TYPE_MONEY_SID, index );
		SetDWORD( pData, pItem->dwMoney, index );
		SetByte( pData, 0, index ); 
	}

	if( index )
	{
		m_CompCount++;

		SetShort( m_CompBuf, index, m_iCompIndex );				// ¸¸µé¾îÁø À¯Àú Á¤º¸ÀÇ ±æÀÌ
		::CopyMemory( m_CompBuf+m_iCompIndex, pData, index );	// ¸¸µé¾îÁø Á¤º¸¸¦ ¾ÐÃàÇÒ ¹öÆÛ¿¡ º¹»ç
		m_iCompIndex += index;

		if( m_iCompIndex >= 8000 )
		{
			SendCompressedRangeInfoToMe();
		}
	}
}

////////////////////////////////////////////////////////////////////////////////////
//	¹öÆÛ¿¡ ÀÖ´Â ¾ÆÀÌÅÛ Á¤º¸¸¦ º¸³½´Ù.  
//
void USER::SendItemFieldInfoToMe()
{
	int index = 0;

	CBufferEx TempBuf;

	if( m_ItemFieldInfoCount <= 0 )
	{
		return;
	}

	if( m_ItemFieldInfoIndex <= 0 )
	{
		return;
	}

	TempBuf.Add(FIELD_ITEM_INFO);
	TempBuf.Add((short)m_ItemFieldInfoCount);
	TempBuf.AddData(m_ItemFieldInfoBuf, m_ItemFieldInfoIndex);

	Send(TempBuf, TempBuf.GetLength());

	m_ItemFieldInfoCount = 0;
	memset( m_ItemFieldInfoBuf, NULL, 8192 );
	m_ItemFieldInfoIndex = 0;
}

////////////////////////////////////////////////////////////////////////////////////
//	ÃÖ´ë ´ë¹ÌÁö¸¦ ±¸ÇÑ´Ù.
//  ¼ÆËã×î´ó¹¥»÷µ½ÊôÐÔÀ¸
int USER::GetMaxDamage(BYTE tWeaponClass)
{
	int nFinalDamage = 0;	// ÃÖÁ¾µ¥¹ÌÁö
	int xyz = 0;			// ¹«±âµ¥¹ÌÁö	

	int tClass = tWeaponClass * SKILL_NUM;

	double iBasic = 0;			// ±âº»µ¥¹ÌÁö

	int iSkillSid = 0;

	//if(tWeaponClass == FIREARMS){
	//	 iBasic = (int)((double)m_sMagicDEX/2 + 0.5);	
	//}else{
	//	iBasic = (int)((double)m_sMagicSTR/2 + 0.5);		
	//}
	//Ç¹(Ãô½Ý+10)/2+»úÐµÃô½Ý×ªÉËº¦
	//(Á¦Á¿+10)/2+»úÐµÁ¦Á¿×ªÉËº¦
	switch(tWeaponClass)
	{
		//Ç¹
	case FIREARMS:
		iBasic = (int)((double)(m_sMagicDEX + 10  ) / 2 + 0.5 + (int)((double)m_DynamicEBodyData[EBODY_DEX_TO_DAMAGE] / 100 * m_sMagicDEX));
		break;
	case JUDGE://ÖÇÁ¦×ªÉËº¦
		iBasic = (int)((double)(m_sMagicWIS)/2 + 0.5+(int)((double)m_DynamicEBodyData[EBODY_WIS_TO_DAMAGE] / 100 * m_sMagicWIS) );
		//iBasic+=(int)((double)(m_sMagicWIS)/2 + 0.5);
		break;
	default:
		iBasic = (int)((double)(m_sMagicSTR)/2 + 0.5+(int)((double)m_DynamicEBodyData[EBODY_STR_TO_DAMAGE] / 100 * m_sMagicSTR) );	
		break;
	}
      /////»úÐµÊôÐÔ¼ÆËã
	//iBasic += (int)((double)m_DynamicEBodyData[EBODY_STR_TO_DAMAGE] * m_sMagicSTR * 0.03);
	//iBasic += (int)((double)m_DynamicEBodyData[EBODY_DEX_TO_DAMAGE] * m_sMagicDEX * 0.01);
    

	//ÖÇÁ¦±ä³ÉÔ¶³Ì¹¥»÷
	//if(m_byClass == JUDGE||m_byClass == FIREARMS)
	//{
		//iBasic+= (int)((double)m_DynamicEBodyData[EBODY_WIS_TO_DAMAGE] / 100 * m_sMagicWIS);
	//	iBasic=iBasic+(int)((double)(m_DynamicEBodyData[EBODY_WIS_TO_DAMAGE]* m_sMagicWIS) *(0.01) +0.5);
	//}
	
	if (m_byClass == 0 || m_byClass == 2 || m_byClass == 3 || m_byClass == 4)  //È­/½£/Ç¹/ÖÙ²Ã135¼¶Ä§·¨Ôö¼Ó300Îï¹¥¼ÆËãµ½ÊôÐÔÀ¸
	{
		//if(m_dwFANTAnTime != 0) iBasic += 300;
		if(m_dwFENGLiTime != 0) iBasic += 150;
		if(m_dwDUOCHONgTime != 0) iBasic += 150;
		
	}
//	if ( m_byClass != 1) iBasic += m_sLevel* 2;   ///ÀÇ±ä¼Ó¹¥»÷ ÏÔÊ¾³öÀ´

	 

    if(iBasic < 0) iBasic = 0;

	if(tWeaponClass == 255) return (int)iBasic;

	xyz = GetWeaponDamage(m_UserItem[RIGHT_HAND].sSid, TRUE);

	nFinalDamage = (int)(iBasic + xyz);
	if (m_byClass == 1)
	{
		if(m_UserItem[RIGHT_HAND].sSid >= 0 && m_UserItem[RIGHT_HAND].sSid < g_arItemTable.GetSize())
		{
			int up_count = m_UserItem[4].tMagic[5];
			if(m_dwHtExpTime > 0) 
			{
				if(m_byClass == 1) up_count += 1;	
			}
			if(up_count > 0 && up_count <= MAX_ITEM_UPGRADE_COUNT + 1)
			{
				if(up_count<=9)
				{
					nFinalDamage+=(up_count*4);
				}else
				{
					nFinalDamage += ((up_count - 9) * 10) + 4*9;
				}
			}
		}
	}

	if(m_sLevel >= ADD_USER_LEVEL )//20160302
	{
		if (m_byClass != 1)
		{
			nFinalDamage += g_arUserLevel[m_sLevel - ADD_USER_LEVEL]->m_sDamage;
		}
	}



	if (m_byClass == 0 || m_byClass == 2 || m_byClass == 3)
	{
	  if( m_dwBerserkerTime != 0 ) //ÕâÀïÏÔÊ¾³öÀ´¿ñ±© ÎäÆ÷Ç¿»¯µ½ÊôÐÔÀ¸  ¼ÓÄ§·¨Ö±½ÓÏÔÊ¾ÊôÐÔ
	 {
		 nFinalDamage += (int)((double)nFinalDamage * 0.15);
	   }else if (m_dwMightyWeaponTime !=0)
	   {
          nFinalDamage += (int)((double)nFinalDamage * 0.1);
	   }
	}
	//====================================================================================================ÉñÊ¥×£¸£

	if (m_dwZFTime !=0)
	{
		if  ( m_dwZF == 11)
		{
			if( m_byClass != 1)
			{
				nFinalDamage += (int)((double)nFinalDamage * 0.05);                   //ÎïÀíÉËº¦ÌáÉý5%    ÏÔÊ¾¹©¸ø¼ÆËã
			}
		}
	}
	
	return nFinalDamage;
}

////////////////////////////////////////////////////////////////////////////////////
//	¸÷ °ø°Ý¿¡ ´ëÇÑ À¯ÀúÀÇ ¹Ý°Ý ´ë¹ÌÁö¸¦ °è»êÇÑ´Ù.
//
void USER::SetCounterAttack(int uid, int damage)
{
	for(int i = 0; i < COUNTERATTACK_MAX_NUM; i++)
	{
		if(InterlockedCompareExchange((LONG*)&m_CounterAttackList[i].lSid, (long)1, (long)0) == (long)0)
		{
			m_CounterAttackList[i].iNpcUid = uid;
			m_CounterAttackList[i].iDamage = damage;
			m_CounterAttackList[i].dwLastAttackTime = GetTickCount();
			break;
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////
//	°È±â µ¿ÀÛ½ÃÀÇ SPEED HACK »ç¿ëÀ¯¹«¸¦ Ã¼Å©ÇÑ´Ù.
//  ·þÎñÆ÷±äËÙÏà¹Ø
BOOL USER::CheckMoveSpeedHack(DWORD checkTick)
{
////////////////////////////////Ô­À´±äËÙ¼ì²â´úÂë////////////////////////////////////////////
/*	DWORD curTick = GetTickCount();
    DWORD tmpS = 0;
	if( m_iTickCount == 0 )
	{
		m_dLastCheckTick = checkTick;
		m_dCheckTick = curTick;
		m_dTotCheckTick = 0;
		
		m_iTickCount += 1;
	}
	else if( m_iTickCount == 5 )
	{
/////////////////////////////Release±àÒëÐÞ¸Ä´¦¿ªÊ¼//////////////////////////////////
		DWORD client = abs((int)checkTick - (int)m_dLastCheckTick );
		DWORD server = abs((int)curTick - (int)m_dCheckTick );
/////////////////////////////Release±àÒëÐÞ¸Ä´¦½áÊø//////////////////////////////////

/////////////////////////////Debug±àÒëÐÞ¸Ä´¦¿ªÊ¼//////////////////////////////////
//		DWORD client = abs( checkTick - m_dLastCheckTick );
//		DWORD server = abs( curTick - m_dCheckTick );
/////////////////////////////Debug±àÒëÐÞ¸Ä´¦½áÊø//////////////////////////////////
		double gap = (double)client / (double)server;

		m_dTotCheckTick -= m_dTotCheckTick / 20;
		if( ( gap < 0.75 || gap > 1.25 ) && ( server < m_dTotCheckTick ) )
		{
			SYSTEMTIME time;
			GetLocalTime(&time);

			CString str;
			str.Format( IDS_USER_SYSTEM_MSG01,
				time.wMonth, time.wDay, time.wHour, time.wMinute, m_strUserID, server, client, m_dTotCheckTick );
			g_fpSpeedHack.Write( str, str.GetLength() );
			tmpS = server * 2;
			if ( m_dTotCheckTick >= tmpS) 
			{
            USER* pUser = GetUser(m_strUserID);
            if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return TRUE;
			pUser->SoftClose();//ÉÏÏßÓÐÒÆ¶¯ËÙ¶È¾ÍÒª×¢ÊÍµôÕâ¾ä,×÷ÓÃ:½â¾öÒÆ¶¯ËÙ¶È¹ý¿ìµôÏßµÄÃ«²¡.
			m_iTickCount = 0;
			return TRUE;
			}
			else
			  m_iTickCount += 1;
		}
		m_iTickCount = 0;
	}
	else
	{
		m_dTotCheckTick += CLIENT_WALK_TICK;
		m_iTickCount += 1;
	}
	
	return FALSE;*/
////////////////////////////////Ô­À´±äËÙ¼ì²â´úÂë////////////////////////////////////////////
//
////////////////////////////////ÏÖÔÚ·â±äËÙ¼ì²â´úÂë////////////////////////////////////////////
	if((m_UserItem[1].sSid == 1489) || (m_UserItem[1].sSid == 1488) || (m_UserItem[1].sSid == 1479) || (m_UserItem[1].sSid == 1356) || (m_UserItem[1].sSid == 1787) || (m_UserItem[1].sSid == 1788)) return FALSE;//´ú²½¹¤¾ß²»¼ì²âËÙ¶È
    if (m_bSpeedHackEnble && (GetTickCount() - m_dLastCheckTick) < 200 )
	{
		//SendSystemMsg("Çë¹Ø±Õ[±äËÙÆ÷],·ñÔòµ¼ÖÂÄúÎÞ·¨ÒÆ¶¯!", SYSTEM_SPECIAL, TO_ME);
		SendSystemMsg("ÄúÊ¹ÓÃ[±äËÙÆ÷]»ò[ÍøÂçºÜ¿¨],µ¼ÖÂÎÞ·¨ÒÆ¶¯!", SYSTEM_NPC, TO_ME);
		return TRUE;
	}
	if( m_iTickCount == 0 )
	{
		m_dCheckTick = GetTickCount();
	}

	m_iTickCount += 1;

	if( m_iTickCount == 3 )
	{
		unsigned int server = GetTickCount() - m_dCheckTick;
		
		TRACE("move : %d\r\n",server);
		m_iTickCount = 0;

		if (server < checkTick)
		{
			int lastTime = GetTickCount() - m_dwServerTick;
			m_dwServerTick = GetTickCount();

			if (lastTime <= 1800 )
			{
				 m_dLastCheckTick = GetTickCount();
				m_bSpeedHackEnble = TRUE;
				return TRUE;
			}
		}
	} ///·â¼ÓËÙ
	return FALSE;
////////////////////////////////ÏÖÔÚ·â±äËÙ¼ì²â´úÂë////////////////////////////////////////////
}

///////////////////////////////////////////////////////////////////////////////////////
//	¶Û¶§ SPEED HACK »ç¿ëÀ¯¹«¸¦ Ã¼Å©ÇÑ´Ù.
//¼ì²éÒÆ¶¯ËÙ¶È
BOOL USER::CheckRunSpeedHack(DWORD checkTick, BOOL bTwo)
{
////////////////////////////////Ô­À´ÒÆ¶¯ËÙ¶È¼ì²â´úÂë////////////////////////////////////////////
/*	DWORD curTick = GetTickCount();
    DWORD tmpS = 0;
	if( m_iTickCount == 0 )
	{
		m_dLastCheckTick = checkTick;
		m_dCheckTick = curTick;
		m_dTotCheckTick = 0;
		
		m_iTickCount += 1;
	}
	else if( m_iTickCount == 5 )
	{
/////////////////////////////Release±àÒëÐÞ¸Ä´¦¿ªÊ¼//////////////////////////////////
		DWORD client = abs((int)checkTick - (int)m_dLastCheckTick );
		DWORD server = abs((int) curTick - (int)m_dCheckTick );
/////////////////////////////Release±àÒëÐÞ¸Ä´¦½áÊø//////////////////////////////////

/////////////////////////////Debug±àÒëÐÞ¸Ä´¦¿ªÊ¼//////////////////////////////////
//		DWORD client = abs( checkTick - m_dLastCheckTick );
//		DWORD server = abs( curTick - m_dCheckTick );
/////////////////////////////Debug±àÒëÐÞ¸Ä´¦½áÊø//////////////////////////////////
		double gap = (double)client / (double)server;

		m_dTotCheckTick -= m_dTotCheckTick / 20;
		if( ( gap < 0.75 || gap > 1.25 ) && ( server < m_dTotCheckTick ) )
		{
			SYSTEMTIME time;
			GetLocalTime(&time);

			CString str;
			str.Format( IDS_USER_SYSTEM_MSG01,
				time.wMonth, time.wDay, time.wHour, time.wMinute, m_strUserID, server, client, m_dTotCheckTick );
			g_fpSpeedHack.Write( str, str.GetLength() );
			tmpS=server*2;
            if (m_dTotCheckTick >= tmpS )  
			{
            USER* pUser = GetUser(m_strUserID);
            if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return TRUE;
			pUser->SoftClose();
			m_iTickCount = 0;
			return TRUE;
			}
			else
            	m_iTickCount += 1;
		}
		m_iTickCount = 0;
	}
	else
	{
		m_dTotCheckTick += CLIENT_RUN_TICK;
		if(bTwo) m_dTotCheckTick += CLIENT_RUN_TICK;
		m_iTickCount += 1;
	}

	return FALSE;*/
////////////////////////////////Ô­À´ÒÆ¶¯ËÙ¶È¼ì²â´úÂë////////////////////////////////////////////

////////////////////////////////ÏÖÔÚ·â±äËÙ¼ÓÒÆ¶¯ËÙ¶È¼ì²â´úÂë////////////////////////////////////////////
	return CheckMoveSpeedHack(680);
////////////////////////////////ÏÖÔÚ·â±äËÙ¼ÓÒÆ¶¯ËÙ¶È¼ì²â´úÂë////////////////////////////////////////////

}

///////////////////////////////////////////////////////////////////////////////////////
//	»ó´ë¹æ¿¡°Ô Å¸°ÝÀ»ÁÙ¶§ Á¤´ç¹æÀ§¿©ºÎ¸¦ ÆÇ´Ü.
//
void USER::IsLegalDefence(USER *pUser)
{
	CBufferEx TempBuf;

	int rank = CAIN_RANK - CITY_RANK_INTERVAL;			// -1 ºÎÅÍ´Â Á¤´ç¹æÀ§¼º¸³
	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
	if(pUser->m_sCityRank <= rank || pUser->m_bPkStatus) return;
	if(pUser->m_curz == 67 || pUser->m_curz == 66 || pUser->m_curz == 45 || pUser->m_curz == 40 || pUser->m_curz == 43 || pUser->m_curz == 44 || pUser->m_curz == 58) return;		//PK¾ºÈü//PKC²»ºìÃû

	if(CheckInvalidZoneInGuildWar(pUser)) return;
	if(CheckInvalidZoneInFreeFight(pUser)) return;

	m_bPkStatus = TRUE;				// Áö±Ý Ä«¿À»óÅÂ´Ù.
	m_dwPkStatusTime = GetTickCount();
	
	TempBuf.Add(SET_USER_PK_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add((BYTE)0x02);
	TempBuf.Add((BYTE)m_bPkStatus);

	SendInsight(TempBuf, TempBuf.GetLength());
//	SendExactScreen(TempBuf, TempBuf.GetLength());
}

//yskang 0.7 ±æµåÀü½Ã »ó´ë ±æµå¿ø Á×ÀÌ¸é Ä«¿À´ï
BOOL USER::IsLegalDefence_isdead(USER *pUser)
{
	CBufferEx TempBuf;

	int rank = CAIN_RANK - CITY_RANK_INTERVAL;			// -1 ºÎÅÍ´Â Á¤´ç¹æÀ§¼º¸³
	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return FALSE;
	if(pUser->m_sCityRank <= rank || pUser->m_bPkStatus) return FALSE;
	if(pUser->m_curz == 67 || pUser->m_curz == 66 || pUser->m_curz == 45 || pUser->m_curz == 40 || pUser->m_curz == 43 || pUser->m_curz == 44 || pUser->m_curz == 58) return FALSE;		//PK¾ºÈü//PKC²»ºìÃû

	if(CheckInvalidZoneInGuildWar(pUser)) return TRUE;
	if(CheckInvalidZoneInFreeFight(pUser)) return TRUE;

	int type = 0;
	type = CheckInvalidMapType();
	if(m_tFortressWar == GUILD_WARRING || m_tGuildWar == GUILD_WARRING) //Ö»ÓÐÉóÇë¾üÍÅ²Å²»ºìÃû,±ðµÄ¸úÆ½Ê±Ò»Ñù.
	if(type == 8 || type == 10 || type == 15 || type == 9 || type == 11 || type == 16) return FALSE;  m_bPkStatus = FALSE; 	
	m_bPkStatus = TRUE;				// ¾ö¶¨PKºìÃû
	m_dwPkStatusTime = GetTickCount();
	
	TempBuf.Add(SET_USER_PK_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add((BYTE)0x02);
	TempBuf.Add((BYTE)m_bPkStatus);

	SendInsight(TempBuf, TempBuf.GetLength());
	return FALSE;
}
///////////////////////////////////////////////////////////////////////////////////////
//	Áö±Ý ³ª³ª »ó´ë À¯Àú°¡ ±æµåÀü ÁßÀÌ¸é ¼ºÇâ¿¡ ¿µÇâÀ» ¹ÞÁö ¾Êµµ·ÏÇÑ´Ù 
//
BOOL USER::CheckInvalidZoneInGuildWar(USER *pUser)
{	
	int me, you, type;

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return FALSE;

	type = CheckInvalidMapType();

	int mapindex = GetGuildMapIndex(type);
	if(mapindex <= -1 || mapindex >= g_arMapTable.GetSize()) return FALSE;

	if(!CheckInvalidZoneState(type)) // °ø¼ºÀü ¶Ç´Â ÇÊµå »óÁ¡ÀüÀÏ¶§´Â ±¸¿ªÀ¸·Î ¹«Á¶°Ç...
	{
		if(g_arMapTable[mapindex] == NULL) return FALSE;
		me = g_arMapTable[mapindex]->m_sStoreID;

		type = pUser->CheckInvalidMapType();
		mapindex = GetGuildMapIndex(type);
		if(mapindex <= -1 || mapindex >= g_arMapTable.GetSize()) return FALSE;

		you = g_arMapTable[mapindex]->m_sStoreID;

		if(me == you) return TRUE;				// °°Àº »óÁ¡ ÀÎµ¦½º¸é ¸ðµÎ º¸¶óµ¹ÀÌ°¡ ¾Æ´Ô...
	}

	if(m_tGuildWar == GUILD_WARRING) //|| m_tFortressWar == GUILD_WARRING)					// ³»°¡ ±æµåÀü ÁßÀÌ°í
	{
		if(m_dwFieldWar > 0) 
		{												// ÇÊµåÀüÁßÀÌ¸é Á¤´ç¹æÀ§		
			if(pUser->m_dwGuild == m_dwFieldWar) 
			{
				CString strMsg = _T("");				// »ó´ë ±æ¸¶°¡ Á×À¸¸é °ÔÀÓ ³¡..
				if(pUser->m_bLive == USER_DEAD && pUser->m_bGuildMaster)
				{
					strMsg.Format( IDS_USER_GUILD_WAR_WINNER, m_strGuildName);
					SendGuildWarFieldEnd((LPTSTR)(LPCTSTR)strMsg);
				}
				return TRUE;
			}
		}
	}
	return FALSE;
}

///////////////////////////////////////////////////////////////////////////////////////
//	ÇöÀç ÀÖ´Â °÷ÀÌ ´ë·ÃÀåÀÌ¸é ¼ºÇâ¿¡ ¿µÇâ¾øÀ½
//	TRUE - ÇöÀç ÀÖ´Â °÷ÀÌ ´ë·ÃÀå ¾Æ´Ô, FALSE - ´ë·ÃÀåÀÌ°Å³ª ¿À·ù
BOOL USER::CheckInvalidZoneInFreeFight(USER *pUser)
{
	int me, you;

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return FALSE;

	me = CheckInvalidMapType();
	you = CheckInvalidMapType();

	if( me == 12 && you == me ) return TRUE;

	return FALSE;
}

///////////////////////////////////////////////////////////////////////////////////////
//	½Ã¹Îµî±ÞÀ» Á¶ÀýÇÑ´Ù.
//
void USER::IsChangeCityRank(int iMyCityRank, USER *pUser)
{
	// PK·Î Á×¾úÀ»¶§Ã³¸®
	CBufferEx TempBuf;

	int step = 0;
	int rank = 0;

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
	if(pUser->m_bLive != USER_DEAD || pUser->m_sHP > 0) return;	// È¤ Á×Áöµµ ¾Ê¾Ò´Âµ¥ ¿À¸é ¹ö±×...
	if (pUser->m_curz == 67 || pUser->m_curz == 66)	return;
											// ÃÖ¿ì¼±ÀûÀ¸·Î ÀüÀïÀ» °Ë»ç	
	if(CheckInvalidZoneInGuildWar(pUser)) return;
	if(CheckInvalidMapType() == 12 ) return;	// ´ë·ÃÀå °Ë»ç

	
	if(pUser->m_bPkStatus || pUser->m_sCityRank < 0)
	{
		pUser->SendCityRank(iMyCityRank);
		return;
	}

	pUser->SendCityRank(iMyCityRank);
	
	if(m_sCityRank >= 0)					 // ¾ÆÁ÷±îÁö ¼±ÇÒ¶§
	{
		m_iCityValue = 0;					

		if(pUser->m_sLevel > m_sLevel)  step = 0;		// ±ï´Â ¼öÄ¡´Â »ó´ë¹æ ·¹º§¿¡µû¶ó... 
		else if(pUser->m_sLevel < m_sLevel) step = 2;
		else  step = 1;

		rank = 4;	

		m_iCityValue -= g_CityRank[rank][step];
		SendUserStatusSkill();

	}
	else												// ¾ÇÀÏ¶§
	{
		if(pUser->m_sLevel > m_sLevel)  step = 0;
		else if(pUser->m_sLevel < m_sLevel) step = 2;
		else  step = 1;

		rank = m_sCityRank + CITY_RANK_INTERVAL;	// ´õÇÏ´Â ÀÌÀ¯´Â ¹è¿­ÀÌ 0ºÎÅÍ ½ÃÀÛÇÏ±â¶§¹®
		
		m_iCityValue = -1 * m_iCityValue;			// ÀÌ°Ç °ªÀ» ´õÇÏ±âÀ§ÇØ ÀÏ½ÃÀûÀ¸·Î ÇÔ(//&&&&&&&&&³ªÁß¿¡ °íÄ¡ÀÚ ^^)
		CheckMaxValue((int &)m_iCityValue, (int &)g_CityRank[rank][step]);
		m_iCityValue = -1 * m_iCityValue;			// ¿ä±â¼­ ¹Ù²ÙÂ¡...
		if(m_iCityValue < -2000000000) m_iCityValue = -2000000000;  // ÀÌ·¸°Ô º¯ÇßÀ¸´Ï±ñ À­ÁÙµµ ¹Ù²ã¾ßÇÑ´Ù...^^
		SendUserStatusSkill();///É±ÈËºó¼õÈ¥ÊÐÃñµÈ¼¶

	}

	CheckMaxValue(m_sKillCount, 1);					// ´©Àû°ªÀÌ °è¼Ó Áõ°¡ÇÑ´Ù.
	SendUserStatusSkill();
													// ÃÖ¾Çµî±ÞÀÏ¶§
	int oldRank = m_sCityRank;			
	for(int i = 0; i < 13; i++)
	{
		if(m_iCityValue < g_CityRankValue[i])// ´©ÀûÄ¡°ªÀÌ ±âÁØ ¼³Á¤°ªº¸´Ù ÀÛÀºÁö ÆÇ´ÜÇÑ´Ù.
		{
			m_sCityRank = i - CITY_RANK_INTERVAL;
			break;
		}
	}

	if(oldRank != m_sCityRank) 
	{
		CheckGuildUserInFortress();			// ½Ã¹Î µî±ÞÀÌ º¯ÇÒ¶§ ´Ù½Ã ¼ÂÆÃ(Æ÷Æ®¸®½º¸¦À§ÇØ)

		TempBuf.Add(SET_USER_PK_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add((BYTE)0x01);
		TempBuf.Add(m_sCityRank);

		SendInsight(TempBuf, TempBuf.GetLength());
//		SendExactScreen(TempBuf, TempBuf.GetLength());	
	}

	rank = m_sCityRank + CITY_RANK_INTERVAL;
	if( rank != ANGEL_RANK )		// ¾îÂî º¯Çßµç ¼¼ÀÎÆ®°¡ ¾Æ´Ï¶ó¸é
	{
		m_dwSaintTime = 0;
	}
}	

///////////////////////////////////////////////////////////////////////////////////////
//	¿©±ä ¸÷À» Á×¿´À»¶§ ½Ã¹Îµî±Þ Çâ»ó¸¦ Á¶ÀýÇÑ´Ù.
//
void USER::GetCityRank()
{
	CBufferEx TempBuf;

	int		i;
	BOOL	bRank = FALSE;
	int		iCityRank = m_sCityRank;

	for(i = 0; i < 13; i++)
	{
		if(m_iCityValue < g_CityRankValue[i])// ´©ÀûÄ¡°ªÀÌ ±âÁØ ¼³Á¤°ªº¸´Ù ÀÛÀºÁö ÆÇ´ÜÇÑ´Ù.
		{
			if(i < 6) { m_sCityRank = i - CITY_RANK_INTERVAL; }
			else { m_sCityRank = i -1 - CITY_RANK_INTERVAL; }
			break;
		}
	}

	if(m_iCityValue >= g_CityRankValue[12]) m_sCityRank = 7;

	if(iCityRank != m_sCityRank)
	{
		CheckGuildUserInFortress();			// ½Ã¹Î µî±ÞÀÌ º¯ÇÒ¶§ ´Ù½Ã ¼ÂÆÃ(Æ÷Æ®¸®½º¸¦À§ÇØ)

		TempBuf.Add(SET_USER_PK_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add((BYTE)0x01);
		TempBuf.Add(m_sCityRank);

		SendInsight(TempBuf, TempBuf.GetLength());
//		SendExactScreen(TempBuf, TempBuf.GetLength());
	}
}

///////////////////////////////////////////////////////////////////////////////////////
//	°¢ ½Ã¹Îµî±Þº°·Î ¹°°Ç°ªÀ» µû·Î ¼³Á¤ÇÑ´Ù.
//
DWORD USER::GetItemCostByCityRank(int sid, int nRate)
{
	if(sid <0 || sid >= g_arItemTable.GetSize()) return 10000000; 
		
	int iCost = g_arItemTable[sid]->m_iDN;
	int rank = m_sCityRank + CITY_RANK_INTERVAL;

	iCost = iCost + (int)( iCost * ((double)nRate/100) );
	switch(rank)
	{
	case CHAONISE_RANK:
		iCost += (int)( iCost * ((double)25/100) );
		break;
	case DEATH_RANK:
		iCost += (int)( iCost * ((double)20/100) );
		break;
	case EVIL_RANK:
		iCost += (int)( iCost * ((double)15/100) );
		break;
	case VILLAIN_RANK:
		iCost += (int)( iCost * ((double)10/100) );
		break;
	case WARRIOR_RANK:
		iCost -= (int)( iCost * ((double)3/100) );
		break;
	case HERO_RANK:
		iCost -= (int)( iCost * ((double)6/100) );
		break;
	case SAINT_RANK:
		iCost -= (int)( iCost * ((double)10/100) );
		break;
	case GUARDANT_RANT:
		iCost -= (int)( iCost * ((double)12/100) );
		break;
	case ANGEL_RANK:
		iCost -= (int)( iCost * ((double)15/100) );
		break;
	}

	if(iCost < 0) iCost = 1;

	return (DWORD)iCost;
}

///////////////////////////////////////////////////////////////////////////////////////
//	¾ÆÀÌÅÛ°ú µ·¿¡°üÇÑ DB Update
//
BOOL USER::UpdateUserItemDN()
{
	if(UpdateMemUserAll()) return TRUE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strItem[_ITEM_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strItem, sizeof(strItem));
	
	UserItemToStr(strItem);

	SDWORD sItemLen		= sizeof(strItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_ITEM_DATA (\'%s\',%d, ?)}"), m_strUserID, m_dwDN ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return FALSE;

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}
BOOL USER::UpdateUserItemShopPingDN()
{
	if(UpdateMemUserAll()) return TRUE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strItem[_ITEM_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strItem, sizeof(strItem));
	
	UserItemToStr(strItem);

	SDWORD sItemLen		= sizeof(strItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_ITEM_DATA (\'%s\',%d, ?)}"), m_strUserID, m_dwShopPingDN ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return FALSE;

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}
BOOL USER::UpdateUserItemShopPattern()//±£´æºÍ´æ´¢×ª»»ÉÌµêÄ£Ê½Êý¾Ý
{
	if(UpdateMemUserAll()) return TRUE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strItem[_ITEM_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strItem, sizeof(strItem));
	
	UserItemToStr(strItem);

	SDWORD sItemLen		= sizeof(strItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_ITEM_DATA (\'%s\',%d, ?)}"), m_strUserID, m_dwNoChatTime); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return FALSE;

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}
BOOL USER::UpdateUserItemZaiXianTime()//±£´æÔÚÏßÊ±¼äÊý¾Ý
{
	if(UpdateMemUserAll()) return TRUE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strItem[_ITEM_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strItem, sizeof(strItem));
	
	UserItemToStr(strItem);

	SDWORD sItemLen		= sizeof(strItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_ITEM_DATA (\'%s\',%d, ?)}"), m_strUserID, m_dwZaiXianTime ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return FALSE;

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

BOOL USER::UpdateUserItemHiExpTime()
{
	if(UpdateMemUserAll()) return TRUE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strItem[_ITEM_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strItem, sizeof(strItem));
	
	UserItemToStr(strItem);

	SDWORD sItemLen		= sizeof(strItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_ITEM_DATA (\'%s\',%d, ?)}"), m_strUserID, m_dwHiExpTime ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return FALSE;

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}
BOOL USER::UpdateUserItemMagicFindTime()
{
	if(UpdateMemUserAll()) return TRUE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strItem[_ITEM_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strItem, sizeof(strItem));
	
	UserItemToStr(strItem);

	SDWORD sItemLen		= sizeof(strItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_ITEM_DATA (\'%s\',%d, ?)}"), m_strUserID, m_dwMagicFindTime ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return FALSE;

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}
////////////////////////////////////////////////////////////////////////////////
//	È¡µÃ·¨Ê¦¾«ÐÞÉËº¦
//
int USER::GetPsiAttackUp()
{
	int iLevel = 0;
	int iSkillSid = 0;

	int iAttackUp = 0;
	int tClass = 0;

	BYTE tWeaponClass = 0;

	IsCanUseWeaponSkill(tWeaponClass);
	tClass = tWeaponClass * SKILL_NUM;

	for(int i = tClass; i < tClass + SKILL_NUM; i++)
	{
		iSkillSid  = m_UserSkill[i].sSid;
		if(iSkillSid == SKILL_PSI_SUCCESS_UP) // ¼º°ø·ü Áõ°¡		7 index
		{
			// ¼ø¼ö ½ºÅ³ ·¹º§ 
			iLevel = m_UserSkill[i].tLevel;		
			if(iLevel < 0) iLevel = 0;
			
			// ¾ÆÀÌÅÛ¿¡ ÀÇÇÑ ½ºÅ³ º¯µ¿ ·¹º§
			if(iLevel >= 1) iLevel += m_DynamicUserData[g_DynamicSkillInfo[iSkillSid]]+ m_DynamicUserData[MAGIC_ALL_SKILL_UP];
			
			if(iLevel >= SKILL_LEVEL) iLevel = SKILL_LEVEL - 1;		// µðºñ¿¡ ÀÖ´Â ·¹º§º¸´Ù´Â ÀÛ¾Æ¾ßÇÑ´Ù
			if(iSkillSid >= g_arSkillTable.GetSize()) return 0;
			iAttackUp = g_arSkillTable[iSkillSid]->m_arSuccess.GetAt(iLevel);
		}
	}

	return iAttackUp;	
}

////////////////////////////////////////////////////////////////////////////////
//	»çÀÌ¿À´Ð ¹üÀ§ °ø°Ý¿¡ ´ëÇÑ µ¥¹ÌÁö¸¦ °è»êÇÑ´Ù.
//
void USER::GetWideRangeAttack(int x, int y, int damage)	// Áö±ÝÀº °ø°Ý¸¸ Ã³¸®...
{
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return;

	int dir[9][2];
	int ix, iy;
	int nTarget = 0;
	int nDamage = 0;

	USER* pUser = NULL;
	CNpc* pNpc = NULL;
	MAP* pMap = g_zone[m_ZoneIndex];
	if(!pMap) return;

	dir[0][0]  =  0;		dir[0][1] =  0;		// 
	dir[1][0]  = -1;		dir[1][1] =  0;		// 
	dir[2][0]  = -1;		dir[2][1] =  1;		// 
	dir[3][0]  =  0;		dir[3][1] =  1;		// 
	dir[4][0]  =  1;		dir[4][1] =  1;		// 

	dir[5][0]  =  1;		dir[5][1] =  0;		// 
	dir[6][0]  =  1;		dir[6][1] = -1;		// 
	dir[7][0]  =  0;		dir[7][1] = -1;		// 
	dir[8][0]  = -1;		dir[8][1] = -1;		// 

	for(int i = 1; i < 9; i++)
	{
		ix = x + dir[i][0];
		iy = y + dir[i][1];

		if(ix < 0) ix = 0;
		if(iy < 0) iy = 0;
		if(ix >= pMap->m_sizeMap.cx) ix = pMap->m_sizeMap.cx - 1;
		if(iy >= pMap->m_sizeMap.cy) iy = pMap->m_sizeMap.cy - 1;

		nTarget = pMap->m_pMap[ix][iy].m_lUser;

		if(nTarget >= USER_BAND && nTarget < NPC_BAND)	// USER
		{
			pUser = GetUser(nTarget - USER_BAND);			// User Pointer ¸¦ ¾ò´Â´Ù.
			if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;	
			if(pUser->m_bLive == USER_DEAD || pUser->m_uid == m_uid)	continue;		// Target User °¡ ÀÌ¹Ì Á×¾îÀÖÀ¸¸é ¸®ÅÏ
			if(!pUser->m_bPkStatus) continue;				// ÀÏ½ÃÀû Ä«¿À°¡ ¾Æ´Ï¸é °ø°ÝÀÌ ¾ÈµÈ´Ù.

			if(m_dwGuild > 0)
			{
				if(m_tGuildWar == GUILD_WARRING && pUser->m_tGuildWar == GUILD_WARRING)
				{												
					if(pUser->m_dwGuild == m_dwGuild)  return;
				}

				if(m_tFortressWar == GUILD_WARRING && pUser->m_tFortressWar == GUILD_WARRING)
				{												// ±æµåÀüÀÏ¶§ ÀÏ½ÃÀû Ä«¿À´Â °°Àº±æµå¿ø¿¡°Ô´Â ¹«½Ã
					if(pUser->m_dwGuild == m_dwGuild)  return;
				}																			
			}

			nDamage = (int)((double)damage *  ((double)m_sMagicVOL / (m_sMagicVOL + pUser->m_sMagicVOL + pUser->m_DynamicUserData[MAGIC_PSI_RESIST_UP] + \
				                               (int)((double)pUser->m_DynamicEBodyData[EBODY_PSI_RESIST_UP] / 100) \
											  )));
			//×îÖÕÉËº¦Í³¼Æ
			nDamage -= pUser->m_DynamicUserData[MAGIC_PSI_ATTACK_DOWN];
			nDamage -= pUser->m_DynamicUserData[MAGIC_FINALLY_ATTACK_DOWN];
			nDamage = (int)((double)nDamage/2 + 0.5);	// µ¥¹ÌÁöÀÇ 50%¸¸ µé¾î°£´Ù.
			
			pUser->SetDamage(nDamage);
			if(pUser->m_sHP > 0)		// »ìÀº °æ¿ì Àü±âµ¥¹ÌÁö Ãß°¡
			{
//				pUser->SetColdDamage();
			}
			else if(pUser->m_lDeadUsed == 1)
			{
				int tempRank = m_sCityRank + CITY_RANK_INTERVAL;
				IsChangeCityRank(m_sCityRank, pUser);
				pUser->GetLevelDownExp(USER_PK, tempRank, FALSE,m_strUserID);			// °æÇèÄ¡¿Í ±×¿Ü º¯È­·®¸¦ ¹Ý¿µÇÑ´Ù.
			}
		}
		else if(nTarget >= NPC_BAND)				// NPC
		{
			pNpc = GetNpc(nTarget - NPC_BAND);				// NPC Point ¸¦ ¾ò´Â´Ù.
			if(pNpc == NULL) continue;					// Àß¸øµÈ NPC ÀÌ¸é ¸®ÅÏ
			if(pNpc->m_NpcState == NPC_DEAD || pNpc->m_tNpcType != NPCTYPE_MONSTER) continue;	// NPC °¡ ÀÌ¹Ì Á×¾î ÀÖÀ¸¸é ¸®ÅÏ
			if(pNpc->m_sHP <= 0) continue;
			if(pNpc->m_byAX == 0 && pNpc->m_byAZ == 0 && pNpc->m_tNpcType == 0) continue;			// °ø°Ý´É·ÂÀÌ ¾ø´Â ¸ó½ºÅÍ(ÇöÀç ¿ø¼®)Àº ÀÏ¹Ý °ø°ÝÀÌ µÇÁö ¾Ê´Â´Ù.

			nDamage = (int)(damage *  ((double)m_sMagicVOL / (m_sMagicVOL + pNpc->m_sVOL)));
			nDamage = (int)((double)nDamage/2 + 0.5);	// µ¥¹ÌÁöÀÇ 50%¸¸ µé¾î°£´Ù.

//			if(pNpc->SetDamage(nDamage, m_strUserID, m_uid + USER_BAND, m_pCom) == FALSE)
			if(pNpc->SetDamage(nDamage, m_uid + USER_BAND, m_pCom) == FALSE)
			{
				if(m_tGuildHouseWar == GUILD_WARRING && pNpc->m_NpcVirtualState == NPC_WAIT)
				{
					CheckGuildHouseWarEnd();
				}

				pNpc->SendExpToUserList(m_pCom); // °æÇèÄ¡ ºÐ¹è!!
				int diffLevel = abs(m_sLevel - pNpc->m_byClassLevel);
				if(diffLevel <= o_yehuoini[0]->djxz || pNpc->m_sEvent != 0 )
				{
					if (m_isDoubleBAOLV  > 0 || g_sanBaoLv == TRUE || m_dwGuarDianTianShi > 0)
						pNpc->SendDead(m_pCom,1,TRUE);
					else
						pNpc->SendDead(m_pCom);
				}
				else
				{
					pNpc->SendDead(m_pCom,0);
					SendSystemMsg("ÄúºÍµ±Ç°¹ÖÎïµÈ¼¶Ïà²î20,Ã»ÓÐÈÎºÎËùµÃ", SYSTEM_ERROR,TO_ME);
				}
			/*if (m_dwShaGuai >= 3000 ) 
			{
	            SendSystemMsg("Äú½ñÈÕÉ±¹ÖÊýÁ¿ÒÑÂú,´ò¹ÖÎÞ·¨»ñµÃÈÎºÎ¾­ÑéÖµ", SYSTEM_ERROR,TO_ME);
			}  */
			 //if(diffLevel <= o_yehuoini[0]->djxz  &&  pNpc->m_tNpcType == 0 )
			 //  {
				//   CString strMsg;
				//   if (m_dwShaGuai == 1000)
				//   {
				//	   SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 5 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	   m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 2000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 10 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	  m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 3000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	    
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 15 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 4000)
				//   {
				//	   SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	    
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 20 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 5000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 30 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }
			 //  }

			
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
				
				if(diffLevel < 40)
				{
					m_iCityValue=m_iCityValue+250;
					m_dwShaGuai=m_dwShaGuai+1;
					GetCityRank();
					CheckMaxValue(m_dwXP, 1);		// ¸÷ÀÌ Á×À»¶§¸¸ 1 Áõ°¡!	
					SendXP();
					SendUserStatusSkill();
				}
			}
			else									// »ìÀº °æ¿ì Àü±âµ¥¹ÌÁö Ãß°¡
			{
//				pNpc->SetColdDamage();
			}
		    SendDamageNum(1,nTarget,nDamage);
			SendNpcHP(nTarget,pNpc->m_sHP);		
		}
	}
}

////////////////////////////////////////////////////////////////////////////////
//	¼ÒÈ¯ÇÒ ¸÷ÀÇ µ¥ÀÌÅ¸°ªÀ» ¼ÂÆÃÇÑ´Ù.
//
void USER::GetNpcData(CNpc *pNpc, int x, int y)
{
	int  iCount = 0,i;
	CPoint pt;

	if(m_tIsOP != 1) return;
	if(pNpc == NULL) return;

	CNpc* pEventNpc	= GetEventNpc();

	if(pEventNpc == NULL)
	{
		SendSystemMsg( IDS_USER_CALL_MONSTER_COUNT_MAX, SYSTEM_NORMAL, TO_ME);
		return;
	}

	MYSHORT sAI;
	BYTE upTemp = 0;			// »óÀ§ 8ºñÆ®
	BYTE dwTemp = 0;			// ÇÏÀ§ 8ºñÆ®

	CString strMsg = _T(""); 

	pEventNpc->m_sSid			= pNpc->m_sSid;		// MONSTER(NPC) Serial ID

	pEventNpc->m_sPid			= pNpc->m_sPid;		// MONSTER(NPC) Picture ID
	_tcscpy(pEventNpc->m_strName, pNpc->m_strName);		// MONSTER(NPC) Name
	
	pEventNpc->m_sSTR			= pNpc->m_sSTR;		// Èû
	pEventNpc->m_sDEX			= pNpc->m_sDEX;		// ¹ÎÃ¸
	pEventNpc->m_sVOL			= pNpc->m_sVOL;		// ÀÇÁö
	pEventNpc->m_sWIS			= pNpc->m_sWIS;		// ÁöÇý
	
	pEventNpc->m_sHP			= pNpc->m_sMaxHP;		// ÃÖ´ë HP
	pEventNpc->m_sMaxHP			= pNpc->m_sMaxHP;		// ÇöÀç HP
	pEventNpc->m_sPP			= pNpc->m_sMaxPP;		// ÃÖ´ë PP
	pEventNpc->m_sMaxPP			= pNpc->m_sMaxPP;		// ÇöÀç PP
	
	pEventNpc->m_byClass		= pNpc->m_byClass;		// ¹«±â°è¿­
	pEventNpc->m_byClassLevel	= pNpc->m_byClassLevel;// ¹«±â°è¿­ ·¹º§
	pEventNpc->m_sExp			= pNpc->m_sExp;		
	
	pEventNpc->m_byAX			= pNpc->m_byAX;		// °ø°Ý°ª X
	pEventNpc->m_byAY			= pNpc->m_byAY;		// °ø°Ý°ª Y
	pEventNpc->m_byAZ			= pNpc->m_byAZ;		// °ø°Ý°ª Z

	pEventNpc->m_iDefense		= pNpc->m_iDefense;	// ¹æ¾î°ª
	pEventNpc->m_byRange		= pNpc->m_byRange;		// »çÁ¤°Å¸®
	pEventNpc->m_sAI			= pNpc->m_sAI;		// ÀÎ°øÁö´É ÀÎµ¦½º
	pEventNpc->m_sAttackDelay	= pNpc->m_sAttackDelay;// °ø°Ýµô·¹ÀÌ
	pEventNpc->m_byVitalC		= pNpc->m_byVitalC;	// ½ÅÃ¼µ¥¹ÌÁö Å©¸®Æ¼ÄÃ
	pEventNpc->m_byWildShot		= pNpc->m_byWildShot;	// ³­»ç ·¹º§
	pEventNpc->m_byExcitedRate	= pNpc->m_byExcitedRate;			// ÈïºÐ ·¹º§
	pEventNpc->m_byIronSkin		= pNpc->m_byIronSkin;
	pEventNpc->m_byReAttack		= pNpc->m_byReAttack;
	pEventNpc->m_bySubAttack	= pNpc->m_bySubAttack;	// »óÅÂÀÌ»ó ¹ß»ý(ºÎ°¡°ø°Ý)
	pEventNpc->m_byState		= pNpc->m_byState;		// ¸ó½ºÅÍ (NPC) »óÅÂÀÌ»ó
	pEventNpc->m_byPsi			= pNpc->m_byPsi;		// »çÀÌ¿À´Ð Àû¿ë
	pEventNpc->m_byPsiLevel		= pNpc->m_byPsiLevel;	// »çÀÌ¿À´Ð·¹º§

	pEventNpc->m_bySearchRange	= pNpc->m_bySearchRange;			// Àû Å½Áö ¹üÀ§
	pEventNpc->m_sSpeed			= pNpc->m_sSpeed;		// ÀÌµ¿¼Óµµ	
	
	pEventNpc->m_sInclination	= pNpc->m_sInclination;
	pEventNpc->m_byColor		= pNpc->m_byColor;
	pEventNpc->m_sStandTime		= pNpc->m_sStandTime;

	//////// MONSTER POS ////////////////////////////////////////
	pEventNpc->m_sCurZ			= pEventNpc->m_sOrgZ = m_curz;
	pEventNpc->m_sCurX			= pEventNpc->m_sOrgX = m_curx;
	pEventNpc->m_sCurY			= pEventNpc->m_sOrgY = m_cury;
	
	pEventNpc->m_sMinX			= pNpc->m_sMinX;
	pEventNpc->m_sMinY			= pNpc->m_sMinY;
	pEventNpc->m_sMaxX			= pNpc->m_sMaxX;
	pEventNpc->m_sMaxY			= pNpc->m_sMaxY;
	
	pEventNpc->m_sRegenTime		= pNpc->m_sRegenTime;

	pEventNpc->m_sEvent			= pNpc->m_sEvent;		// ÀÌº¥Æ® ¹øÈ£
	pEventNpc->m_sEZone			= pNpc->m_sEZone;
	pEventNpc->m_byType			= pNpc->m_byType;
	pEventNpc->m_sDimension		= pNpc->m_sDimension;	// ÇöÀç ¸î¼¿¸¦ Â÷ÁöÇÏ´ÂÁö ÆÇ´Ü

	pEventNpc->m_tNpcType		= pNpc->m_tNpcType;	// NPC Type

	pEventNpc->m_sFamilyType	= pNpc->m_sFamilyType;	// NPC Type
	pEventNpc->m_tItemPer		= pNpc->m_tItemPer;	// NPC Type
	pEventNpc->m_tDnPer			= pNpc->m_tDnPer;	// NPC Type
	pEventNpc->m_sHaveItem		= pNpc->m_sHaveItem;

	pEventNpc->m_ZoneIndex		= -1;

	pEventNpc->m_sClientSpeed	= pNpc->m_sClientSpeed;
	pEventNpc->m_dwStepDelay	= GetTickCount();

	sAI.i = (short)pNpc->m_sAI;						// NPC AI¸¦ ¼ÂÆÃ
	upTemp = sAI.b[0];
	dwTemp = sAI.b[1];

	pEventNpc->m_tNpcAttType = upTemp >> 7;			// ³ªÁß¿¡ Ãß°¡ÇØ¾ßÇÑ´Ù.
	upTemp = upTemp << 1;
	pEventNpc->m_tNpcLongType = upTemp >> 7;
	upTemp = upTemp << 1;
	pEventNpc->m_tNpcGroupType = upTemp >> 7;

	if(pEventNpc->m_sClientSpeed <= 20) pEventNpc->m_sClientSpeed = 20;	// ¹æ¾î ÄÚµå;

	for(i = 0; i < g_zone.GetSize(); i++)
	{
		if(g_zone[i]->m_Zone == pEventNpc->m_sCurZ) 
		{
			pEventNpc->m_ZoneIndex = i;
			break;
		}
	}

	BOOL bSuccess = FALSE;
	pEventNpc->EventNpcInit(x, y);
	
	for(i = 0; i < NPC_NUM; i++ ) 
	{
		if(InterlockedCompareExchange((LONG*)&g_arEventNpcThread[0]->m_ThreadInfo.m_lNpcUsed[i], (long)1, (long)0) == (long)0)
		{
			bSuccess = TRUE;
			g_arEventNpcThread[0]->m_ThreadInfo.pNpc[i] = pEventNpc;
			break;
		}
	}

	if(!bSuccess)
	{
		InterlockedExchange(&pEventNpc->m_lEventNpc, (LONG)0);
		SendSystemMsg( IDS_USER_CALL_FAIL, SYSTEM_NORMAL, TO_ME);
		return;
	}

	strMsg.Format( IDS_USER_CALL_WHAT, pNpc->m_strName);
	SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
}

////////////////////////////////////////////////////////////////////////////////
//	Ãß°¡ÇÒ ¼ÒÈ¯¸÷ÀÇ ¸Þ¸ð¸®¸¦ ÂüÁ¶ÇÏ±âÀ§ÇØ ÇÃ·¡±×°¡ 0ÀÎ »óÅÂ°Í¸¸ ³Ñ±ä´Ù.
//
CNpc* USER::GetEventNpc()
{
	for(int i = g_TotalNPC; i < g_arNpc.GetSize(); i++)
	{
		if( g_arNpc[i] )
		{
			if(InterlockedCompareExchange((LONG*)&g_arNpc[i]->m_lEventNpc, (long)1, (long)0) == (long)0)
			{
				return g_arNpc[i];				
			}
		}
	}
	return NULL;
}

////////////////////////////////////////////////////////////////////////////////
//	ÃÑ±â°è¿­ÀÇ Àº½Å ÇØÁ¦OFF
//
void USER::SendHideOff()
{
/*	CBufferEx TempBuf;

	m_tPsiAbnormal = 0;
	m_dwHideTime = 0;
	m_dwLastHideTime = GetTickCount();
		
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(ABNORAML_PSI);
	TempBuf.Add(ABNORMAL_NONE);
	TempBuf.Add((BYTE)0);
	TempBuf.Add((BYTE)0);
	TempBuf.Add((BYTE)0);
	TempBuf.Add((BYTE)0);	
	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
*/
}

////////////////////////////////////////////////////////////////////////////////
//	À¯Àú°¡ ¼ÒÁöÇÑ ¾ÆÀÌÅÛÀÇ ¹«°Ô º¯È­¸¦ ¾Ë¸°´Ù.
//
void USER::SendItemWeightChange()
{
/*	CBufferEx TempBuf;

	TempBuf.Add(ITEM_WEIGHT_CHANGE);
	TempBuf.Add((short)m_iMaxWeight);
	TempBuf.Add((short)m_iCurWeight);

	Send(TempBuf, TempBuf.GetLength());
*/
}

////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç ±æµåÀÎµ¦½º ÀÇ Æ÷ÀÎÅÍ¸¦ ¹ÝÈ¯
//
CGuild* USER::GetGuild(int num)
{
	EnterCriticalSection( &(m_pCom->m_critGuild) );

	if( num <= 0 ) return NULL;			// ±æµå ÀÎµ¦½º´Â 1ºÎÅÍ ½ÃÀÛÇÑ´Ù.
	if( num >= g_arGuildData.GetSize() ) return NULL; 

	CGuild* pGuild = NULL;

	if(g_arGuildData[num])
	{
		pGuild = g_arGuildData[num];
		if( pGuild->m_lSid == num )
		{
			return pGuild;
		}
	}

	return NULL;
}

////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç ±æµåÀÌ¸§À¸·Î Æ÷ÀÎÅÍ¹ÝÈ¯
//
CGuild* USER::GetGuildByName(TCHAR *guildname)
{
	EnterCriticalSection( &(m_pCom->m_critGuild) );

	int i, j = 0;
	CGuild* pGuild = NULL;

	CString tempName;

	tempName.Format( "%s", guildname );

	for(i = 0; i < g_arGuildData.GetSize(); i++)
	{
		if( g_arGuildData[i] )
		{
			pGuild = g_arGuildData[i];

			if( !tempName.CompareNoCase( pGuild->m_strGuildName ) )
			{
				return pGuild;
			}

			j = 0;
		}
//		else j++;

//		if(j >= 100) break;	// ÃÖ´ë 100°³ ±îÁö ´õ °Ë»öÇØº¸°í Áß´Ü
	}

	return NULL;
}

////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç ±æµåÀÎµ¦½º·Î ±æµåÀÌ¸§ ¹ÝÈ¯
//
BOOL USER::GetGuildName(int guildnum, TCHAR *guildname)
{
	if( guildnum < 0 || guildnum >= MAX_GUILD )
	{
		return FALSE;
	}

	EnterCriticalSection( &(m_pCom->m_critGuild) );

	CGuild* pGuild = NULL;

	if( !g_arGuildData[guildnum] )
	{
		LeaveCriticalSection( &(m_pCom->m_critGuild) );
		return FALSE;
	}

	pGuild = g_arGuildData[guildnum];

	if( pGuild->m_lSid != guildnum )
	{
		LeaveCriticalSection( &(m_pCom->m_critGuild) );
		return FALSE;
	}

	strcpy( guildname, pGuild->m_strGuildName );
	
	LeaveCriticalSection( &(m_pCom->m_critGuild) );

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////
//	ºó ±æµå ÀÎµ¦½º¸¦ ¹ÝÈ¯
//
int USER::GetEmptyGuildNum()
{
/*	EnterCriticalSection( &(m_pCom->m_critGuild) );

	int nCount = 1;

	InterlockedIncrement(&g_CurrentGuildCount);

	for(int i = 0; i < g_arGuildData.GetSize(); i++)
	{
		if(!g_arGuildData[i]) continue;

		int temp = g_arGuildData[i]->m_lSid;
		if(g_arGuildData[i]->m_lSid >= nCount) nCount = g_arGuildData[i]->m_lSid + 1;
	}

	if(nCount >= MAX_GUILD) nCount = -1;			// ÀÌ·²¶© DBÁ¤¸® ¾÷µ¥ÀÌÆ®ÇØ¾ßÇÑ´Ù...

	return nCount;
*/
	EnterCriticalSection( &(m_pCom->m_critGuild) );

	for( int i = 1; i < g_arGuildData.GetSize(); i++)
	{
		if( g_arGuildData[i]->m_lSid <= 0 )
		{
			return i;
		}
	}

	return -1;

}

////////////////////////////////////////////////////////////////////////////////
//	
//
void USER::ReleaseGuild()
{
	LeaveCriticalSection( &(m_pCom->m_critGuild) );
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå ¼³¸³ Á¶°ÇÀÌ µÇ´ÂÁö ÆÇ´Ü
//
void USER::GuildOpen()
{
#ifdef _ACTIVE_USER
//	if(m_iDisplayType == 6 && m_sLevel > 25) return; //yskang 0.5
	if(m_iDisplayType == 6) return; //yskang 0.5
#endif

	CBufferEx TempBuf;

	CString strTemp = _T("");
	CString strMsg = _T("");

	strTemp.Format("%s", m_strGuildName);

	if(!strTemp.IsEmpty()) 
	{
		strMsg.Format( IDS_USER_ALREADY_GUILD_IN, m_strGuildName);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);	
		return;
	}

	if(m_sGuildVersion >= 0)
	{
		strMsg.Format( IDS_USER_ALREADY_OTHER_GUILD_IN );
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);	
		return;
	}

	if(m_sLevel < GUILD_MAKE_LEVEL)  // ·¹º§ Á¦ÇÑ¿¡..
	{
		strMsg.Format( IDS_USER_GUILD_MAKE_LEVEL, GUILD_MAKE_LEVEL);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);	
		return;
	}

	if(m_dwDN < GUILD_MAKE_DN)  // Ã¢¸³ ÀÚ±Ý¿¡...
	{
		strMsg.Format( IDS_USER_GUILD_MAKE_DINA, GUILD_MAKE_DN);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}

	int rank = m_sCityRank + CITY_RANK_INTERVAL;

	if(rank < HERO_RANK)
	{
		strMsg.Format( IDS_USER_GUILD_MAKE_CITY_RANK, "Hero");
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return;
	}

	TempBuf.Add(GUILD_DIALOG);
	Send(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////
//	»õ·Î¿î ±æµå¸¦ ¸¸µç´Ù.	
//
void USER::NewGuild(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	BYTE error_code = 0;
	BOOL bRes = TRUE;
	
	int i;
	int index = 0;
	int nLength = 0;
	int iGuildId = 0;
	TCHAR szGuildName[255];

	CString szTemp;
	CBufferEx	TempBuf;

	WORD *pwMark = NULL;
	CGuild *pGuild = NULL;
//	CGuildUser *pGuildUser = NULL;

	if(m_dwGuild > 0) { error_code = ERR_5; goto go_result; }  // ´Ù¸¥ ±æµå¿øÀÎ »óÅÂ

	nLength = GetVarString(sizeof(szGuildName), szGuildName, pBuf, index);
	if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) { error_code = ERR_1; goto go_result; } // ±æµå ¸íÄª Á¦ÇÑ¿¡ °É¸²

	szTemp = szGuildName;

	if(!UNI_CHAR::CheckString(szTemp))
	{
		error_code = 255; 
		goto go_result;
	}

	if(szTemp.Find(' ') != -1 || szTemp.Find('\'') != -1 || szTemp.Find('"') != -1 || szTemp.Find('/') != -1)
	{
		error_code = 255; 
		goto go_result;
	}

	if(IsReservedID(szGuildName))
	{
		error_code = 04; 
		goto go_result;
	}

	if(m_sLevel < GUILD_MAKE_LEVEL) { error_code = ERR_1; goto go_result; } // ·¹º§ Á¦ÇÑ¿¡..

	if(m_dwDN < GUILD_MAKE_DN) { error_code = ERR_1; goto go_result; } // Ã¢¸³ ÀÚ±Ý¿¡...

	pGuild = GetGuildByName(szGuildName);

	ReleaseGuild();

	if(pGuild) { error_code = ERR_4; goto go_result; }  // ÀÌ¹Ì µî·ÏÇÑ ±æµå ÀÌ¸§ÀÏ¶§...

	iGuildId = GetEmptyGuildNum();

	if(iGuildId <= 0)
	{
		ReleaseGuild();
		//InterlockedDecrement(&g_CurrentGuildCount);
		return;
	}

//	pGuild = new CGuild;
	pGuild = g_arGuildData[iGuildId];
	if(pGuild == NULL) return;
/*
	if(strlen(pGuild->m_strGuildName) > 0)
	{
		ReleaseGuild();
		return;
	}
*/
	if(pGuild->m_lSid > 0) 
	{
		ReleaseGuild();
		return;
	}
/*
	pGuildUser = new CGuildUser;		// ¸Þ¸ð¸®ÇÒ´ç¿¡ ½ÇÆÐÇÏ¸é...
	if(!pGuildUser)
	{
		ReleaseGuild();
		return;
	}
*/

	// alisia - ºê¸´Áö ¼­¹ö·Î ±æµå »õ·Î ¸¸µç´Ù´Â ½ÅÈ£¸¦ º¸³»°í ¸®ÅÏÇÑ´Ù. ÈÄ¿¡ °á°ú¸¦ ¹Þ¾Æ¼­ ±æµå¸¦ ¿Ï¼ºÇÑ´Ù.
	g_pMainDlg->BridgeServerGuildNewReq( m_uid, m_strUserID, iGuildId, szGuildName );
	ReleaseGuild();
	return;





	pGuild->m_lSid = iGuildId;

	strcpy(pGuild->m_strGuildName, szGuildName);
	strcpy(pGuild->m_strMasterName, m_strUserID);

	pGuild->m_dwGuildDN = 0;
	pGuild->m_sVersion = -1;

	
	pwMark = (WORD*)(&pGuild->m_strMark[0]);
	for (i=0; i<GUILD_MARK_SIZE/sizeof(WORD); i++) {
		pwMark[i] = (0x1f<<11 | 0x1f);	// Client¿¡¼­ »ç¿ëÇÏ´Â Åõ¸í»öÀ¸·Î ÃÊ±âÈ­ÇÑ´Ù.
	}

	if(!InsertGuild(pGuild))
	{
//		delete pGuild;
//		if(pGuildUser) delete pGuildUser;

//		InterlockedDecrement(&g_CurrentGuildCount);
		ReleaseGuild();
		return;
	}

//	::ZeroMemory(pGuildUser->m_strUserId, sizeof(pGuildUser->m_strUserId));

//	nLength = 0;
//	nLength = strlen(m_strUserID);

//	pGuildUser->m_lSid = iGuildId;
//	strncpy(pGuildUser->m_strUserId, m_strUserID, nLength);

//	pGuild->m_arUser.Add(pGuildUser);
	pGuild->AddUser(m_strUserID, iGuildId);

	g_arGuildData[iGuildId] = pGuild;

	ReleaseGuild();

	if( m_dwDN <= GUILD_MAKE_DN ) m_dwDN = 0;
	else m_dwDN -= GUILD_MAKE_DN;		// ±æµå ¼³¸³ ÀÚ±Ý¸¦ »«´Ù.

	m_bGuildMaster = TRUE;
	m_dwGuild = iGuildId;

	nLength = 0;
	nLength = strlen(szGuildName);
	if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return; 
	strncpy(m_strGuildName, szGuildName, nLength);
	bRes = FALSE;

go_result:
	//////////////////////////////PACKET///////////////////////////////////////
	TempBuf.Add(GUILD_OPEN_RESULT);

	if(bRes)
	{
		TempBuf.Add((BYTE)0x00);		// ½ÇÆÐ
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	TempBuf.Add((BYTE)0x01);		// ¼º°ø
	TempBuf.Add((int)iGuildId);
	TempBuf.AddString(m_strGuildName);

	Send(TempBuf, TempBuf.GetLength());

	SendMoneyChanged();
	SendMyGuildInfo();//(TO_INSIGHT, INFO_MODIFY);
}

void USER::NewGuildWithThread(TCHAR *pBuf)
{
	int index = 0;
	int nLength = 0;
	TCHAR szGuildName[255];

	nLength = GetVarString(sizeof(szGuildName), szGuildName, pBuf, index);
	if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return; 

	int Datalength;
	BYTE *pData;
	SQLDATAPACKET *pSDP;
	pSDP = new SQLDATAPACKET;
	pSDP->code = GUILD_OPEN_REQ;
	Datalength = index;
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pData = new BYTE[Datalength+1];
	memset(pData, 0, Datalength+1);
	memcpy(pData, pBuf, Datalength);
	pSDP->pData = pData;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );
}

////////////////////////////////////////////////////////////////////////////////
//	»õ·Î¿î ±æµå¸¦ ¸¸µç´Ù.	
//
BOOL USER::InsertGuild(CGuild *pGuild)
{
	if(pGuild == NULL) return FALSE;
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		

	::ZeroMemory(szSQL, sizeof(szSQL));

	int index = 0;

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call INSERT_GUILD (%d, \'%s\', \'%s\')}"), pGuild->m_lSid, pGuild->m_strGuildName, m_strUserID); 

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return FALSE;

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}
	
	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////
//	Å×ÀÌºí¿¡ ±æµå °¡ÀÔÀ» ¼ÂÆÃÇÑ´Ù.	
//
BOOL USER::InsertGuildUser(int guildID, TCHAR *strUserID)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[2000];		

	::ZeroMemory(szSQL, sizeof(szSQL));

	int index = 0;

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call INSERT_GUILD_USER (%d, \'%s\')}"), guildID, strUserID); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}
	else
	{
		//if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
//		BREAKPOINT();

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå¿¡ µî·ÏµÈ ¹®¾çÀ» ¾÷µ¥ÀÌÆ®ÇÑ´Ù.
//
BOOL USER::UpdateGuildMark(TCHAR *pMark, CGuild *pGuild)
{
	if(pGuild == NULL) return FALSE;
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strMark[450];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strMark, sizeof(strMark));

	int index = 0;

	SDWORD sMarkLen		= sizeof(strMark);

	::CopyMemory(strMark, pMark, GUILD_MARK_SIZE);

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_GUILD_MARK (\'%s\',%d, ?)}"), pGuild->m_strGuildName, pGuild->m_sVersion ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strMark), 0, (TCHAR*)strMark, 0, &sMarkLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}
	else
	{
		//if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
//		BREAKPOINT();

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////
//	±æµåÀ¯ÀúÅ×ÀÌºí¿¡¼­ ÇØ´ç À¯Àú µ¥ÀÌÅÍ¸¦ »èÁ¦ÇÑ´Ù.
//
BOOL USER::DeleteGuildUser(TCHAR *strUserID)
{
	if ( strUserID == NULL ) return FALSE;
//½â¾öt_strUserID ´íÎó
	if(strlen(strUserID)<=0)
		return FALSE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
//	char			t_strUserID[20];//ÀÏ´úÂëÉèÖÃ
	char			t_strUserID[CHAR_NAME_LENGTH+1];

	::ZeroMemory(szSQL, sizeof(szSQL));

	strcpy( t_strUserID, strUserID );

	int index = 0;

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call DELETE_GUILD_USER (\'%s\')}"), t_strUserID ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}
	else
	{
		//if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
//		BREAKPOINT();
//		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

BOOL USER::DeleteGuildUserWithThread(TCHAR *strUserID)
{
	if ( strUserID == NULL ) return FALSE;

	int nLen = strlen(strUserID);
	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return FALSE;

	int Datalength;
	BYTE *pData;
	SQLDATAPACKET *pSDP;
	pSDP = new SQLDATAPACKET;
	pSDP->code = DEL_GUILD_CHAR_REQ;
	Datalength = strlen(strUserID);
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pData = new BYTE[Datalength+1];
	memset(pData, 0, Datalength+1);
	memcpy(pData, strUserID, Datalength);
	pSDP->pData = pData;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå ¸¶Å©¸¦ °»½ÅÇÑ´Ù.
//
void USER::GuildMarkAddReq(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	CBufferEx TempBuf;
	TCHAR GuildMark[GUILD_MARK_SIZE+1];

	BOOL bRes = TRUE;
	BYTE error_code = 0;

	CGuild *pGuild = NULL;

	if(!m_bGuildMaster) return; // { error_code = ERR_1; goto go_result; }// ±æµåÂ¯ÀÌ ¾Æ´Ï¸é ³ª°¨

	::ZeroMemory(GuildMark, sizeof(GuildMark));

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) { error_code = ERR_2; goto go_result; }		// ÇØ´ç ±æµå°¡ ¾øÀ¸¸é ³ª°¨..

	if(strcmp(pGuild->m_strMasterName, m_strUserID) != 0) { error_code = ERR_1; goto go_result; }// ±æµåÂ¯ÀÌ Æ²¸®¸é ³ª°¨...

	::CopyMemory(GuildMark, pBuf, GUILD_MARK_SIZE);
	
	// alisia
	g_pMainDlg->BridgeServerGuildMarkReq( m_uid, m_strUserID, (int)m_dwGuild, GuildMark );
	ReleaseGuild();
	return;




	if(pGuild->m_sVersion >= 0) CheckMaxValue((short &)pGuild->m_sVersion, (short)1);
	else pGuild->m_sVersion = 0;

	if(!UpdateGuildMark(GuildMark, pGuild))	// DB¿¡ ¾²±â ½ÇÆÐ¸é ³ª°¨..
	{
		pGuild->m_sVersion = -1;
		error_code = 255;
		goto go_result; 
	}
	
//	pGuild->m_sVersion += 1;
	m_sGuildVersion = pGuild->m_sVersion;	// ±æµå ¹®¾ç ¹öÁ¯

	::CopyMemory(pGuild->m_strMark, GuildMark, GUILD_MARK_SIZE);

	bRes = FALSE;

go_result:
	ReleaseGuild();				// ÇØÁ¦...

	TempBuf.Add(GUILD_MARK_ADD_RESULT);

	if(bRes)
	{
		TempBuf.Add((BYTE)0x00);
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
	
	TempBuf.Add((BYTE)0x01);				// »õ·Î¿î ¹®¾çÀÌ µî·ÏµÇ¾úÀ¸¸é Áö±Ý µî·ÏÇÑ ±æµå À¯Àú ¸ðµÎ¿¡°Ô º¸³»¾ß ÇÏ³ª
	TempBuf.Add(pGuild->m_sVersion);		// ¾Æ´Ô ¹öÁ¯¸¸ °¡¸£ÃÄÁà¼­ Æ²¸®¸é °è¼Ó º¸³»¾ß ÇÏ³ª...
											// Áö±ÝÀº ¹öÁ¯¸¸ º¸³»¼­...			
	Send(TempBuf, TempBuf.GetLength());

	SendMyGuildInfo();
											// ÇØ´ç ±æµåÇÏ¿ì½º ¹®¾çÀ» º¯°æÇÑ´Ù.		
	for(int i = 0; i < g_arGuildHouse.GetSize(); i++)
	{
		if(pGuild->m_lSid == g_arGuildHouse[i]->iGuild)
		{
			int modify_index = 0;
			char modify_send[2048];	

			CNpc *pNpc = NULL;
			pNpc = GetNpc(g_arGuildHouse[i]->iMarkNpc);
			if(!pNpc) return;

			modify_index = 0;
			pNpc->m_sMaxHP = m_sGuildVersion;
			::ZeroMemory(modify_send, sizeof(modify_send));
			pNpc->FillNpcInfo(modify_send, modify_index, INFO_MODIFY);
			pNpc->SendInsight(m_pCom, modify_send, modify_index);
		
			break;
		}
	}

//	SendMyInfo(TO_INSIGHT, INFO_MODIFY);
}

void USER::GuildMarkAddReqWithThread(TCHAR *pBuf)
{
	int Datalength;
	BYTE *pData;
	SQLDATAPACKET *pSDP;
	pSDP = new SQLDATAPACKET;
	pSDP->code = GUILD_MARK_ADD_REQ;
	Datalength = GUILD_MARK_SIZE;
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pData = new BYTE[Datalength+1];
	memset(pData, 0, Datalength+1);
	memcpy(pData, pBuf, Datalength);
	pSDP->pData = pData;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );
}

////////////////////////////////////////////////////////////////////////////////
//	Å¬¶óÀÌ¾ðÆ®¿¡ »õ·Î¿î ±æµå°¡ Ãß°¡µÇ¾ú°Å³ª °»½Å»çÇ×ÀÌ ÀÖ´ÂÁö ¾Ë·ÁÁØ´Ù. 
//
void USER::GuildAddReq(TCHAR *pBuf)
{	
	CBufferEx TempBuf; 

	int index = 0;
	BOOL bRes = TRUE;
	BYTE error_code = 0;

	int iGuildID = GetInt(pBuf, index);

	CGuild *pGuild = NULL;

	if(iGuildID < 0) return;
	TempBuf.Add(GUILD_ADD_RESULT);

	pGuild = GetGuild(iGuildID);

	if(!pGuild) { error_code = ERR_1; goto go_result; }		// ÇØ´ç ±æµå°¡ ¾øÀ¸¸é ³ª°¨..

	if(!pGuild->m_strMark) { error_code = 255; goto go_result; }

	TempBuf.Add((BYTE)0x01);
	TempBuf.Add((int)pGuild->m_lSid);
	TempBuf.AddString(pGuild->m_strGuildName);
	TempBuf.Add(pGuild->m_sVersion);
	TempBuf.AddData((TCHAR*)pGuild->m_strMark, GUILD_MARK_SIZE);
	bRes = FALSE;

go_result:
	ReleaseGuild();				// ÇØÁ¦...

	if(bRes)
	{
		TempBuf.Add((BYTE)0x00);
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	Send(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////
//	Memory DB ¸¦ ÃÊ±âÈ­ ÇÑ´Ù.
//
BOOL USER::InitMemoryDB(int uid)
{

	m_pSharedMemory = g_arSharedMemory[uid];
	m_pMD = (CMemUser*) m_pSharedMemory->m_lpData;

	m_pMD->m_uid = uid;
	m_pMD->m_UB.m_uid = uid;
	m_pMD->m_AB.m_uid = uid;
	m_pMD->m_iMyServer = m_iMyServer;

	::ZeroMemory(m_pMD->m_strAccount, sizeof(m_pMD->m_strAccount));
	strncpy(m_pMD->m_strAccount, m_strAccount, strlen(m_strAccount));

	::ZeroMemory(m_pMD->m_strUserID, sizeof(m_pMD->m_strUserID));
	strncpy(m_pMD->m_strUserID, m_strUserID, strlen(m_strUserID));

	::ZeroMemory(m_pMD->m_UB.m_strUserID, sizeof(m_pMD->m_UB.m_strUserID));
	strncpy(m_pMD->m_UB.m_strUserID, m_strUserID, strlen(m_strUserID));

	::ZeroMemory(m_pMD->m_AB.m_strAccount, sizeof(m_pMD->m_AB.m_strAccount));
	strncpy(m_pMD->m_AB.m_strAccount, m_strAccount, strlen(m_strAccount));

	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////////////////////
//	¸Þ¸ð¸® DBÀÇ ³»¿ëÀ» DB·Î ¿Å±ä´Ù.
//
void USER::UpdateMem2DB(CMemUser *pMD)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strFace[10], strSkill[_SKILL_DB], strItem[_ITEM_DB], strPsi[_PSI_DB], strTel[_TEL_DB];
	TCHAR			strQuickItem[_QUICKITEM_DB];
	TCHAR			strHaveEvent[_EVENT_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));

	::ZeroMemory(strFace, sizeof(strFace));
	::ZeroMemory(strSkill, sizeof(strSkill));
	::ZeroMemory(strItem, sizeof(strItem));
	::ZeroMemory(strPsi, sizeof(strPsi));
	::ZeroMemory(strTel, sizeof(strTel));
	::ZeroMemory(strHaveEvent, sizeof(strHaveEvent));
	
    ::ZeroMemory(strQuickItem, sizeof(strQuickItem));

	::CopyMemory(strFace, pMD->m_strFace, sizeof(strFace));
	::CopyMemory(strSkill, pMD->m_strSkill, sizeof(strSkill));
	::CopyMemory(strItem, pMD->m_strItem, sizeof(strItem));
	::CopyMemory(strPsi, pMD->m_strPsi, sizeof(strPsi));
	::CopyMemory(strTel, pMD->m_strTel, sizeof(strTel));
	::CopyMemory(strHaveEvent, pMD->m_strHaveEvent, sizeof(strHaveEvent));

	::CopyMemory(strQuickItem, pMD->m_strQuickItem, sizeof(strQuickItem));
	

	SDWORD sFaceLen		= sizeof(strFace);
	SDWORD sSkillLen	= sizeof(strSkill);
	SDWORD sItemLen		= sizeof(strItem);
	SDWORD sPsiLen		= sizeof(strPsi);
	SDWORD sQuickLen	= sizeof(strQuickItem);
	SDWORD sEventLen	= sizeof(strHaveEvent);
	SDWORD sTelLen		= sizeof(strTel);
	
         /////////////////////¼Ó×Ö¶Î
    _sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_DATA (\'%s\',%d,%d,%d,%d,%d,%d,%d,%d,\
		?, %d,%d,%d, %d, %d,%d,  %d,%d,  %d, \
		%d,%d,%d,%d,%d,%d, %d,%d,%d,%d, \
		?,?,?,?, %d,%d,\
		%d, %d, ?, %d, %d,\
		?, %d,\
		%d, %d, %d, %d, %d, %d,%d, %d, %d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,\
		\'%s\', \
		%d,%d,		%d,%d,		%d,%d)}"), 
		pMD->m_strUserID, pMD->m_sSTR, pMD->m_sCON,	pMD->m_sDEX, pMD->m_sVOL, pMD->m_sWIS, pMD->m_iSkin, pMD->m_iHair, pMD->m_sGender,	
		pMD->m_curz, pMD->m_curx, pMD->m_cury, pMD->m_dwBuddy, pMD->m_dwGuild, pMD->m_dwExp, pMD->m_sPA, pMD->m_sSkillPoint, pMD->m_dwXP,
		pMD->m_sMaxHP, pMD->m_sHP, pMD->m_sMaxPP, pMD->m_sPP, pMD->m_sMaxSP, pMD->m_sSP, pMD->m_dwDN, pMD->m_sCityRank, pMD->m_sLevel, pMD->m_byClass,

		pMD->m_tAbnormalKind, pMD->m_dwAbnormalTime, 

		pMD->m_bLive, pMD->m_iCityValue, pMD->m_sKillCount, pMD->m_dwSaveTime,
		pMD->m_dwSaintTime, 
		pMD->m_dwHiExpTime, pMD->m_dwHtExpTime, pMD->m_dwMagicFindTime, pMD->m_dwMagicFtTime, pMD->m_dwNoChatTime,pMD->m_dwZF,pMD->m_dwXL, pMD->m_dwCloseTime, pMD->m_dwAutoMoney,pMD->m_dwPD,pMD->m_dwLingQu,pMD->m_dwShaGuai, pMD->m_dwGuarDianTianShi, pMD->m_dwShopPingDN,pMD->m_dwVIPTime,pMD->m_dwZaiXianTime,pMD->m_dwBFindTime,pMD->m_dwHXTime,pMD->m_dwSGTime,pMD->m_dwXYTime,pMD->m_dwZFTime,
		pMD->m_strLoveName, //--yskang 0.1 
		pMD->m_tPsiOneKind, pMD->m_dwPsiOneTime,		pMD->m_tPsiTwoKind, pMD->m_dwPsiTwoTime,		pMD->m_tPsiThreeKind, pMD->m_dwPsiThreeTime); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strFace),	0, (TCHAR*)strFace,		0, &sFaceLen );

		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strSkill),	0, (TCHAR*)strSkill,	0, &sSkillLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strPsi),		0, (TCHAR*)strPsi,		0, &sPsiLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strQuickItem),	0, (TCHAR*)strQuickItem,	0, &sQuickLen );

		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strHaveEvent),	0, (TCHAR*)strHaveEvent,	0, &sEventLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strTel),	0, (TCHAR*)strTel,	0, &sTelLen );
		
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}
	else
	{
		//if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
//		BREAKPOINT();

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
}

void USER::UpdateBankMem2DB(CMemUser *pMD)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strBankItem[_BANK_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strBankItem, sizeof(strBankItem));
	
	::CopyMemory(strBankItem, pMD->m_UB.m_UserBankItem, sizeof(strBankItem));
	
	SDWORD sBankItemLen	= sizeof(strBankItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_BANK_DATA_ONLY (\'%s\',%d, ?)}"), pMD->m_UB.m_strUserID, pMD->m_UB.m_dwBankDN);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
//		TRACE("Fail To Update User Bank Data Only!!\n");

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return;
	}

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter(hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strBankItem), 0, (TCHAR*)strBankItem, 0, &sBankItemLen);

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DB[m_iModSid].ReleaseDB(db_index);
			return;
		}
	}	

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return;

	return;
}

void USER::UpdateAccountBankMem2DB(CMemUser *pMD)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];
	TCHAR			strBankItem[_ACCOUNT_BANK_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strBankItem, sizeof(strBankItem));
	
	::CopyMemory(strBankItem, pMD->m_AB.m_AccountBankItem, sizeof(strBankItem));
	
	SDWORD sBankItemLen	= sizeof(strBankItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_ACCOUNT_BANK_DATA_ONLY (\'%s\',%d, ?)}")/*, pMD->m_iMyServer*/, pMD->m_AB.m_strAccount, pMD->m_AB.m_dwBankDN);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		return;
	}

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter(hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strBankItem), 0, (TCHAR*)strBankItem, 0, &sBankItemLen);

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DB[m_iModSid].ReleaseDB(db_index);
			return;
		}
	}	

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return;

	return;
}

////////////////////////////////////////////////////////////////////////////////
//	Memory DB¿¡ ÇöÀç ¸ðµç À¯Àú Data ¸¦ ¾´´Ù.
//
BOOL USER::UpdateMemUserAll(BOOL bBank)
{
	TCHAR strBankItem[_BANK_DB];
	TCHAR strAccountBankItem[_ACCOUNT_BANK_DB];

	if(m_pSharedMemory == NULL) return FALSE;
	if(m_pSharedMemory->m_hMapping == NULL) return FALSE;
	if(m_pMD == NULL) return FALSE;
	if(m_pMD->m_uid == -1) return FALSE;

	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return FALSE;

	DWORD curTime = ConvertCurTimeToSaveTime();
	if(m_pMD->m_dwSaveTime > curTime) return FALSE;

	if(bBank)
	{
		if(m_pMD->m_uid != m_pMD->m_UB.m_uid) return FALSE;
		if(_stricmp(m_strUserID, m_pMD->m_UB.m_strUserID) != 0) return FALSE;
		if(_stricmp(m_strAccount, m_pMD->m_AB.m_strAccount) != 0) return FALSE;

		m_pMD->m_UB.m_dwBankDN = 0;
		::ZeroMemory(strBankItem, sizeof(strBankItem));
		UserBankItemToStr(strBankItem);
		memcpy(m_pMD->m_UB.m_UserBankItem, strBankItem, sizeof(strBankItem));
		m_pMD->m_UB.m_dwBankDN = m_dwBankDN;

		m_pMD->m_AB.m_dwBankDN = 0;
		::ZeroMemory(strAccountBankItem, sizeof(strAccountBankItem));
		UserAccountBankItemToStr( strAccountBankItem );
		memcpy(m_pMD->m_AB.m_AccountBankItem, strAccountBankItem, sizeof(strAccountBankItem));
		m_pMD->m_AB.m_dwBankDN = m_dwAccountBankDN;
	}

	m_pMD->m_dwSaveTime = curTime;			// ÇöÀç ¹öÁ¯

	m_pMD->m_sSTR = m_sSTR;					// Èû
	m_pMD->m_sCON = m_sCON;					// °Ç°­
	m_pMD->m_sDEX = m_sDEX;					// ¹ÎÃ¸¼º
	m_pMD->m_sVOL = m_sVOL;					// ÀÇÁö
	m_pMD->m_sWIS = m_sWIS;					// ÁöÇý
	
	m_pMD->m_iSkin = m_iSkin;				// ÇÇºÎ»ö
	m_pMD->m_iHair = m_iHair;				// ¸Ó¸®»ö
	m_pMD->m_sGender = m_sGender;			// ¼ºº°
//	_tcscpy(m_pMD->m_strFace, m_strFace);	// ¾ó±¼¸ð¾ç
	memcpy(m_pMD->m_strFace, m_strFace, sizeof(m_strFace));	// ¾ó±¼¸ð¾ç

	m_pMD->m_curx = m_curx;					// ÇöÀç X ÁÂÇ¥
	m_pMD->m_cury = m_cury;					// ÇöÀç Y ÁÂÇ¥
	m_pMD->m_curz = m_curz;					// ÇöÀç Á¸

	m_pMD->m_dwBuddy = m_dwBuddy;			// ¹öµð¹øÈ£
	m_pMD->m_dwGuild = m_dwGuild;			// ±æµå¹øÈ£

	m_pMD->m_dwExp = m_dwExp;				// ·¹º§°æÇèÄ¡

	m_pMD->m_sPA = m_sPA;					// PA Point
	m_pMD->m_sSkillPoint = m_sSkillPoint;	// Skill Point
	
	m_pMD->m_dwXP = m_dwXP;					// X Point

	m_pMD->m_sMaxHP	= m_sMaxHP;				// ÃÖ´ë HP
	m_pMD->m_sHP	= m_sHP;				// ÇöÀç HP
	m_pMD->m_sMaxPP = m_sMaxPP;				// ÃÖ´ë PP
	m_pMD->m_sPP	= m_sPP;				// ÇöÀç PP
	m_pMD->m_sMaxSP = m_sMaxSP;				// ÃÖ´ë SP
	m_pMD->m_sSP	= m_sSP;				// ÇöÀç SP

	m_pMD->m_dwDN = m_dwDN;					// ¼ÒÁö±Ý

	m_pMD->m_sCityRank = m_sCityRank;		// ½Ã¹Î µî±Þ
	m_pMD->m_sKillCount = m_sKillCount;		// ÇöÀç PKÇÑ È½¼ö

	m_pMD->m_sLevel = m_sLevel;				// °è¿­·¹º§
	m_pMD->m_byClass = m_byClass;			// Å¬·¡½º
	m_pMD->m_dwZaiXianTime = m_dwZaiXianTime;	


	TCHAR strSkill[_SKILL_DB], strItem[_ITEM_DB], strPsi[_PSI_DB], strHaveEvent[_EVENT_DB], strTel[_TEL_DB];

	::ZeroMemory(strSkill, sizeof(strSkill));
	::ZeroMemory(strItem, sizeof(strItem));
	::ZeroMemory(strPsi, sizeof(strPsi));
	::ZeroMemory(strTel, sizeof(strTel));
	::ZeroMemory(strHaveEvent, sizeof(strHaveEvent));

	UserSkillToDBStr(strSkill);
	UserItemToStr(strItem);
	UserPsiToStr(strPsi);
	UserTelToStr(strTel);
	UserHaveEventDataToStr(strHaveEvent);
/*
	strcpy(m_pMD->m_strSkill, strSkill);	// User Skill DB
	strcpy(m_pMD->m_strItem, strItem);		// User Item DB
	strcpy(m_pMD->m_strPsi, strPsi);		// User Psionic DB
	strcpy(m_pMD->m_strHaveEvent, strHaveEvent);// User Event DB
*/
	memcpy(m_pMD->m_strSkill, strSkill, sizeof(strSkill));
	memcpy(m_pMD->m_strItem, strItem, sizeof(strItem));
	memcpy(m_pMD->m_strPsi, strPsi, sizeof(strPsi));
	memcpy(m_pMD->m_strTel, strTel, sizeof(strTel));
	memcpy(m_pMD->m_strHaveEvent, strHaveEvent, sizeof(strHaveEvent));

	::CopyMemory(m_pMD->m_sChangeClass, m_sChangeClass, sizeof(m_sChangeClass));	// ÀüÁ÷½Ã Å¬·¡½º·¹º§ ÀúÀå
	
	// »óÅÂÀÌ»ó Á¤º¸ ÀúÀå
	m_pMD->m_tAbnormalKind = m_tAbnormalKind;
	m_pMD->m_dwAbnormalTime = m_dwAbnormalTime;

	m_pMD->m_tIsOP = m_tIsOP;				// ¿î¿µÀÚÀÎÁö ÆÇ´Ü
											// 0: Normal User
											// 1: Game Operator
											// 2: Server Operator

	m_pMD->m_bLive = m_bLive;				// Á×¾ú´Ï? »ì¾Ò´Ï?

	m_pMD->m_sTempSTR = m_sTempSTR;			// Èû
	m_pMD->m_sTempCON = m_sTempCON;			// °Ç°­
	m_pMD->m_sTempDEX = m_sTempDEX;			// ¹ÎÃ¸¼º
	m_pMD->m_sTempVOL = m_sTempVOL;			// ÀÇÁö
	m_pMD->m_sTempWIS = m_sTempWIS;			// ÁöÇý

	m_pMD->m_iCityValue = m_iCityValue;		// ÇöÀç ´©Àû ¼ºÇâ°ª

	m_pMD->m_dwSaintTime		= m_dwSaintTime;
	
	m_pMD->m_dwHiExpTime		= m_dwHiExpTime;
	m_pMD->m_dwHtExpTime		= m_dwHtExpTime;
	m_pMD->m_dwMagicFindTime	= m_dwMagicFindTime;
	m_pMD->m_dwMagicFtTime		= m_dwMagicFtTime;
	m_pMD->m_dwNoChatTime		= m_dwNoChatTime;
	m_pMD->m_dwZF		= m_dwZF;
	m_pMD->m_dwXL		= m_dwXL;
    m_pMD->m_dwCloseTime		= m_dwCloseTime;
	m_pMD->m_dwAutoMoney		= m_dwAutoMoney;
	m_pMD->m_dwPD		        = m_dwPD;
	m_pMD->m_dwLingQu   		= m_dwLingQu;
	m_pMD->m_dwShaGuai   		= m_dwShaGuai;
	m_pMD->m_dwGuarDianTianShi	= m_dwGuarDianTianShi;
	m_pMD->m_dwShopPingDN		= m_dwShopPingDN;
	m_pMD->m_dwVIPTime			= m_dwVIPTime;//vipÓÃ»§
	m_pMD->m_dwZaiXianTime		= m_dwZaiXianTime;
	m_pMD->m_dwBFindTime		= m_dwBFindTime;
	m_pMD->m_dwHXTime		    = m_dwHXTime;
	m_pMD->m_dwSGTime		    = m_dwSGTime;
	m_pMD->m_dwXYTime		    = m_dwXYTime;
	m_pMD->m_dwZFTime		    = m_dwZFTime;
	
	m_pMD->m_tPsiOneKind = m_pMD->m_tPsiTwoKind = m_pMD->m_tPsiThreeKind = 0;
	m_pMD->m_dwPsiOneTime = m_pMD->m_dwPsiTwoTime = m_pMD->m_dwPsiThreeTime = 0;

	// Psionic One
	if(m_dwHasteTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_HASTE;
		m_pMD->m_dwPsiOneTime = m_dwHasteTime;
	}
	if(m_dwShieldTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_SHIELD;
		m_pMD->m_dwPsiOneTime = m_dwShieldTime;
	}
	if(m_dwDexUpTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_DEXUP;
		m_pMD->m_dwPsiOneTime = m_dwDexUpTime;
	}
	if(m_dwMaxHPUpTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_HPUP;
		m_pMD->m_dwPsiOneTime = m_dwMaxHPUpTime;
	}
	if(m_dwFastRunTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_FAST_RUN;
		m_pMD->m_dwPsiOneTime = m_dwFastRunTime;
	}
	if(m_dwMindShockTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_MIND_SHOCK;
		m_pMD->m_dwPsiOneTime = m_dwMindShockTime;
	}
	if(m_dwPsiShieldTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_PSI_SHIELD;
		m_pMD->m_dwPsiOneTime = m_dwPsiShieldTime;
	}
	if(m_dwBigShieldTime != 0) 
	{
		m_pMD->m_tPsiOneKind = 30;
		m_pMD->m_dwPsiOneTime = m_dwBigShieldTime;
	}
	if(m_dwPiercingShieldTime != 0) 
	{
		m_pMD->m_tPsiOneKind = PSIONIC_PIERCING_SHIELD;
		m_pMD->m_dwPsiOneTime = m_dwPiercingShieldTime;
	}

	// Psionic Two
	if(m_dwAdamantineTime != 0) 
	{
		m_pMD->m_tPsiTwoKind = PSIONIC_ADAMANTINE;
		m_pMD->m_dwPsiTwoTime = m_dwAdamantineTime;
	}
	if(m_dwMightyWeaponTime != 0) 
	{
		m_pMD->m_tPsiTwoKind = PSIONIC_MIGHTYWEAPON;
		m_pMD->m_dwPsiTwoTime = m_dwMightyWeaponTime;
	}
	if(m_dwBerserkerTime != 0) 
	{
		m_pMD->m_tPsiTwoKind = PSIONIC_BERSERKER;
		m_pMD->m_dwPsiTwoTime = m_dwBerserkerTime;
	}

	// Psionic Three
	if(m_dwMindGuardTime != 0) 
	{
		m_pMD->m_tPsiThreeKind = PSIONIC_MIND_GUARD;
		m_pMD->m_dwPsiThreeTime = m_dwMindGuardTime;
	}
	//m_pMD->m_dwBSTime=m_dwBSTime;
	m_pMD->m_dwDNMoney = m_dwDNMoney;
	m_pMD->m_dwShTsTime = m_dwShTsTime;
	m_pMD->m_isDoubleExp = m_isDoubleExp;
	m_pMD->m_isDoubleBAOLV = m_isDoubleBAOLV;
	return TRUE;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
// DB¿¡ ÀºÇàµ¥ÀÌÅÍ, Memory DB¿¡ À¯Àú µ¥ÀÌÅ¸¸¦ ÀúÀåÇÑ´Ù
//
BOOL USER::UpdateMemUserBank()
{
//	if(!UpdateBankDataOnly()) return FALSE;
	return UpdateMemUserAll(TRUE);
}

////////////////////////////////////////////////////////////////////////////////////////////////////
//	DB¿¡ ÀºÇà¿¡ °ü·ÃµÈ µ¥ÀÌÅÍ¸¦ ÀúÀåÇÑ´Ù.
//
BOOL USER::UpdateBankDataOnly()
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strBankItem[_BANK_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strBankItem, sizeof(strBankItem));
	
	UserBankItemToStr(strBankItem);
	
	SDWORD sBankItemLen	= sizeof(strBankItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_BANK_DATA_ONLY (\'%s\',%d, ?)}"), m_strUserID, m_dwBankDN);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
//		TRACE("Fail To Update User Bank Data Only!!\n");

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter(hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strBankItem), 0, (TCHAR*)strBankItem, 0, &sBankItemLen);

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DB[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

///////////////////////////////////////////////////////////////////////////////////////////////////
//	Restart µîÀ» ÇÒ ¶§ ´Ù½Ã ¸Þ¸ð¸® µðºñ¸¦ ÃÊ±âÈ­ ÇÑ´Ù.
//
void USER::ReInitMemoryDB()
{
	if(m_pMD != NULL) 
	{
		m_pMD->m_uid = -1;
		m_pMD->m_sSTR = 0;
		m_pMD->m_UB.m_uid = -1;
		m_pMD->m_AB.m_uid = -1;
		m_pMD->m_dwSaveTime = 0;

		::ZeroMemory(m_pMD->m_strUserID, sizeof(m_pMD->m_strUserID));
		::ZeroMemory(m_pMD->m_strAccount, sizeof(m_pMD->m_strUserID));
	}
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå Â¯°ú ¼­·Î ¸¶ÁÖ º»»óÅÂ¿¡¼­ °¡ÀÔÇÑ´Ù. 
//
void USER::GuildInvite(int uid)
{	
//	if ( pBuf == NULL ) return;

	int index = 0;
	BYTE error_code = 0;

	int nLen = 0;

//	int uid = 0;
	int iCount = 0;
	USER* pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildUser *pGuildUser = NULL;

	BOOL bRes = TRUE;

	if(!m_bGuildMaster && !m_bRepresentationGuild) { error_code = ERR_10; goto go_result; }	// ±æµå ±ÇÇÑÀÌ ¾ø´Ù.

//	uid = GetInt(pBuf, index);

	pUser = GetUser(uid - USER_BAND);

	if(!pUser) { error_code = ERR_3; goto go_result; }				// À¯Àú°¡ ¾ø´Ù.

	if(IsThereUser(pUser) == FALSE || strcmp(m_strUserID, pUser->m_strUserID) == 0)
	{
		SendSystemMsg( IDS_USER_SEE_EACH_OTHER, SYSTEM_NORMAL, TO_ME);
		return;
	}

	nLen = strlen(pUser->m_strUserID);
	if(nLen <= 0) return;

	if(pUser->m_dwGuild > 0)  { error_code = ERR_9; goto go_result; }// ÀÌ¹Ì ´Ù¸¥ ±æµå¿¡ °¡ÀÔÇÑ À¯Àú 
	
	if(CheckInGuildWarring()) return;								// ±æÀüÁß¿¡´Â Çã¶ôÁA¼ö¾ø´Ù.

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_7;			// ÇØ´ç ±æµå°¡ ¾ø´Ù.
		goto go_result;				
	}
									// ¿À·ù...
//	if(strcmp(pGuild->m_strMasterName, m_strUserID) != 0) 
	if( !pGuild->IsMasterPower(m_strUserID) )
	{
		ReleaseGuild();				// ÇØÁ¦...

		m_bGuildMaster = FALSE;
		m_bRepresentationGuild = FALSE;
		error_code = ERR_10;		// 
		goto go_result;
	}

	index = -1;
	index = pGuild->GetUser(pUser->m_strUserID);
	if(index >= 0) 
	{ 
		ReleaseGuild();				// ÇØÁ¦...

		pUser->m_dwGuild = m_dwGuild;			// ±æµå ¹øÈ£¸¦ ´Ù½Ã ¼ÂÆÃÇÑ´Ù.
		SendGuildInfo(pUser);

		error_code = ERR_9; 
		goto go_result; 
	}// ÀÌ¹Ì ´Ù¸¥ ±æµå¿¡ °¡ÀÔÇÑ À¯Àú	
/*
	iCount = pGuild->m_arUser.GetSize();
	if(iCount <= 0 || iCount >= MAX_GUILD_USER) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_11;			// 
		goto go_result;
	}

	pGuildUser = new CGuildUser;	// ¸Þ¸ð¸® ÇÒ´ç ½ÇÆÐ¸é..
	if(!pGuildUser)
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = 255;			// 
		goto go_result;
	}
*/

	// alisia
	g_pMainDlg->BridgeServerGuildInviteReq( m_uid, pUser->m_uid, m_strUserID, pUser->m_strUserID, (int)m_dwGuild );
	ReleaseGuild();
	return;
	//




	if(!pGuild->AddUser(pUser->m_strUserID, pGuild->m_lSid)) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_11;			// 
		goto go_result;
	}

	if(!InsertGuildUser(pGuild->m_lSid, pUser->m_strUserID)) // ÇØ´ç ±æµå¿¡ °¡ÀÔÀ» ¼ÂÆÃ
	{
		pGuild->RemoveUser(pUser->m_strUserID);
		
		ReleaseGuild();				// ÇØÁ¦...
		error_code = 255;			// 
		goto go_result;
	}

	pUser->m_dwGuild = pGuild->m_lSid;
	pUser->m_bGuildMaster = FALSE;
	pUser->m_sGuildVersion = pGuild->m_sVersion;
	pUser->m_bRepresentationGuild = FALSE;
	strcpy(pUser->m_strGuildName, pGuild->m_strGuildName);
	bRes = FALSE;

go_result:
	if(bRes)
	{
		CBufferEx TempBuf;
		TempBuf.Add(CHAT_RESULT);
		TempBuf.Add((BYTE)0x00);		//½ÇÆÐ
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

//	pGuildUser = new CGuildUser;	
//	pGuildUser->m_lSid = 0;
//	::ZeroMemory(pGuildUser->m_strUserId, sizeof(pGuildUser->m_strUserId));

//	pGuildUser->m_lSid = m_dwGuild;	
//	strncpy(pGuildUser->m_strUserId, pUser->m_strUserID, nLen);

//	pGuild->m_arUser.Add(pGuildUser);

	ReleaseGuild();

	UpdateUserData();

	AddGuildUserInFortress(pUser);

	SendGuildInviteUser(pUser);			// ±æµå ¸®½ºÆ®¸¦ ÁÖ°í ¹Þ±â
	SendGuildInfo(pUser);				// ½Ã¾ß ¹üÀ§¿¡ ±æµå¿¡ °¡ÀÔÇÑ »ç¶÷ÀÌ ÀÖÀ¸´Ï±ñ ¹®¾çÀ» º¸ÀÌ¶ó°í ÇÑ´Ù...

//	SendSystemMsg( IDS_USER_ENTER_SUCCESS, SYSTEM_NORMAL, TO_ME);
//	pUser->SendSystemMsg( IDS_USER_ENTER_SUCCESS, SYSTEM_NORMAL, TO_ME);
}

void USER::GuildInviteWithThread(TCHAR *pBuf)
{	
//	uid = GetInt(pBuf, index);
	int Datalength;
	BYTE *pData;
	SQLDATAPACKET *pSDP;
	pSDP = new SQLDATAPACKET;
	pSDP->code = GUILD_INVITE_USER_REQ;			// »õ·Î¸¸µç´Ù.
	Datalength = sizeof(int);
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pData = new BYTE[Datalength+1];
	memset(pData, 0, Datalength+1);
	memcpy(pData, pBuf, Datalength);
	pSDP->pData = pData;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );
}

////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç ±æµå¿øµé¿¡°Ô »õ·ÎÀÌ ±æµå¿øÀÌµÈ À¯Àú¸¦ ¾Ë¸°´Ù.
//
void USER::SendGuildInviteUser(USER *pUser)
{
	int i;
	int nLen = 0;	
	int nCount = -1;

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
	if(m_dwGuild <= 0) return;

	USER *pGUser = NULL;

	CBufferEx TempBuf;

	CString strMsg = _T("");
	strMsg.Format( IDS_USER_NEW_MEMBER, pUser->m_strUserID);

	for(i = 0; i< MAX_USER; i++)
	{
		pGUser = m_pCom->GetUserUid(i);

		if(pGUser == NULL || pGUser->m_state != STATE_GAMESTARTED) continue;		

		if(m_dwGuild == pGUser->m_dwGuild)
		{
			pGUser->SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
	}
/*
//	SetGuildUserIndex(pUser);										// ±æ¸¶°¡ ¸ÕÀú Àû¿ë...

	for(i = 0; i < MAX_GUILD_USER; i++)								// ÀÌ·¸°Ô µû·Î ¸®½ºÆ®¸¦ °ü¸®ÇÏ´Â°Ç...
	{																	
		pUser->m_MyGuildUser[i].uid = -1;
		pUser->m_MyGuildUser[i].lUsed = 0;							// ÇØ´ç À¯Àú ¸®½ºÆ®¸¦ ÃÊ±âÈ­ÇÑ´Ù.
		::ZeroMemory(pUser->m_MyGuildUser[i].GuildUser, sizeof(pUser->m_MyGuildUser[i].GuildUser));

		nLen = strlen(m_MyGuildUser[i].GuildUser);
																	// °¡ÀÔÇÑ À¯Àú¿¡°Ô ±æµå ¸®½ºÆ®¸¦ copyÇØ ÁØ´Ù	
		if(nLen > 0 && nLen <= CHAR_NAME_LENGTH) strncpy(pUser->m_MyGuildUser[i].GuildUser, m_MyGuildUser[i].GuildUser, nLen);
		else continue;

		pGUser = GetUser(m_MyGuildUser[i].uid);

		if(!pGUser)													// ÀÌÀü uid·Î Ã£À»¼ö ¾ø´Ù¸é ´Ù½Ã ¾ÆÀÌµð·Î °Ë»ö	
		{
			pGUser = GetUser(m_MyGuildUser[i].GuildUser);
			if(!pGUser) 
			{ 
				pUser->m_MyGuildUser[i].uid = -1;
				m_MyGuildUser[i].uid = -1; 
				continue; 
			}
		}
		else if(strcmp(m_MyGuildUser[i].GuildUser, pGUser->m_strUserID) != 0)
		{															// uid°¡ ¼­·Î ´Ù¸£¸é ´Ù½Ã °Ë»öÇØ¼­ uid¸¦ ¼ÂÆÃ	
			pGUser = GetUser(m_MyGuildUser[i].GuildUser);			// ÀÌ·¸°Ô ÇÑÀÌÀ¯´Â strUserID·Î Ã£´Â°ÍÀ» ÇÇÇÏ±âÀ§ÇØ
			if(!pGUser) 
			{
				pUser->m_MyGuildUser[i].uid = -1;
				m_MyGuildUser[i].uid = -1; 
				continue; 
			}
		}

		nCount = pGUser->SetGuildUserIndex(pUser);					// °¢ ±æµå¿ø¿¡°Ô »õ·Î °¡ÀÔÇÑ À¯ÀúÁ¤º¸¸¦ º¸³¿

		pUser->m_MyGuildUser[i].uid = pGUser->m_uid;				// Áö±Ý °×¼Ó¿¡ ÀÖÀ¸¸é ¸®½ºÆ®»ó¿¡¼­ uid¸¦ ¼ÂÆÃ

		pGUser->SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_NORMAL, TO_ME);
	}	
*/
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå¸¦ Å»ÅðÇÑ´Ù.
//
void USER::GuildOff(TCHAR *pBuf)
{
	int index = 0;
	BYTE error_code = 0;

	USER *pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildUser *pGuildUser = NULL;

	BOOL bRes = TRUE;

	if(m_dwGuild <= 0) { error_code = ERR_8; goto go_result; }
	
	if(m_bGuildMaster) { error_code = ERR_8; goto go_result; }

	if(m_tGuildHouseWar == GUILD_WARRING || m_tGuildWar == GUILD_WARRING || m_tFortressWar == GUILD_WARRING) 
	{ 
		SendSystemMsg( IDS_USER_NO_OUT_IN_WAR, SYSTEM_ERROR, TO_ME);
		return; 
	}

	if(CheckInGuildWarring()) return;								// ±æÀüÁß¿¡´Â Çã¶ôÁA¼ö¾ø´Ù.

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_7;
		goto go_result;
	}

	index = -1;
	index = pGuild->GetUser(m_strUserID);

	if(index < 0)					// ÇØ´ç ±æµå¿¡¼­ À¯Àú°¡ ¾øÀ¸¸é...
	{
		m_dwGuild = -1;							// ÃÊ±âÈ­ÇÑ´Ù.
		m_sGuildVersion = -1;					// ±æµå ¹®¾ç ¹öÁ¯
		::ZeroMemory(m_strGuildName, sizeof(m_strGuildName));	
		m_bGuildMaster = FALSE;					// ±æµå ¸¶½ºÅÍ
		m_bRepresentationGuild = FALSE;			// ±ÇÇÑ ´ëÇà ¿©ºÎ	 	

		ReleaseGuild();				
		error_code = ERR_8;
		goto go_result;
	}
												// ±æµå ¸¶½ºÅÍ°¡ Å»ÅðÀÇ»ç¸¦ ¹àÈ÷¸é ¿¡·¯...^^			
	if(strcmp(pGuild->m_strMasterName, m_strUserID) == 0)
	{
		ReleaseGuild();				
		error_code = ERR_8;
		goto go_result;
	}

	// alisia
	g_pMainDlg->BridgeServerGuildOffReq( m_uid, m_strUserID, m_strUserID, (int)m_dwGuild );
	ReleaseGuild();
	return;




	if(!pGuild->RemoveUser(m_strUserID))
	{
		ReleaseGuild();				
		error_code = ERR_8;
		goto go_result;
	}

	if(!DeleteGuildUser(m_strUserID))		// Å×ÀÌºí¿¡¼­ Áö¿î´Ù.
	{
		pGuild->AddUser(m_strUserID, m_dwGuild);

		ReleaseGuild();				
		error_code = 255;
		goto go_result;
	}

	//if(!DeleteGuildUserWithThread(m_strUserID))		// Å×ÀÌºí¿¡¼­ Áö¿î´Ù.
	//{
	//	ReleaseGuild();				
	//	error_code = 255;
	//	goto go_result;
	//}

//	pGuild->RemoveUser(m_strUserID);		// ¸Þ¸ð¸®¿¡¼­ Áö¿î´Ù.
	ReleaseGuild();
	bRes = FALSE;

go_result:
	if(bRes)
	{
		CBufferEx TempBuf;
		TempBuf.Add(CHAT_RESULT);
		TempBuf.Add((BYTE)0x00);
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	pUser = GetUser(m_uid);

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;

	SendGuildOffUser(pUser);				// ´Ù¸¥ ±æµå¿ø¿¡°Ô ³»°¡ Å»ÅðÇÑ »ç½ÇÀ» ¾Ë¸°´Ù.

	DelGuildUserInFortress(m_strUserID, m_dwGuild);

	m_dwGuild = -1;							// ÃÊ±âÈ­ÇÑ´Ù.
	m_sGuildVersion = -1;					// ±æµå ¹®¾ç ¹öÁ¯
	::ZeroMemory(m_strGuildName, sizeof(m_strGuildName));	
	m_bGuildMaster = FALSE;					// ±æµå ¸¶½ºÅÍ
	m_bRepresentationGuild = FALSE;			// ±ÇÇÑ ´ëÇà ¿©ºÎ	 	

	SendMyGuildInfo();						// ±æµå Å»Åð¸¦ ¾Ë¸°´Ù.

	UpdateUserData();
//	SendSystemMsg( IDS_USER_OUT_GUILD, SYSTEM_NORMAL, TO_ME);
}

void USER::GuildOffWithThread(TCHAR *pBuf)
{
	int index = 0;
	BYTE error_code = 0;
	USER *pUser = NULL;
	BOOL bRes = TRUE;

	if(m_dwGuild <= 0) { error_code = ERR_8; goto go_result; }
	
	if(m_bGuildMaster) { error_code = ERR_8; goto go_result; }

	if(m_tGuildHouseWar == GUILD_WARRING || m_tGuildWar == GUILD_WARRING || m_tFortressWar == GUILD_WARRING) 
	{ 
		SendSystemMsg( IDS_USER_NO_OUT_IN_WAR, SYSTEM_ERROR, TO_ME);
		return; 
	}

	int Datalength;
	SQLDATAPACKET *pSDP;

	pSDP = new SQLDATAPACKET;
	pSDP->code = GUILD_OFF_WITH_THREAD;
	Datalength = 0;
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pSDP->pData = NULL;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );
	return;	

go_result:
	if(bRes)
	{
		CBufferEx TempBuf;
		TempBuf.Add(CHAT_RESULT);
		TempBuf.Add((BYTE)0x00);
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	pUser = GetUser(m_uid);
	SendGuildOffUser(pUser);				// ´Ù¸¥ ±æµå¿ø¿¡°Ô ³»°¡ Å»ÅðÇÑ »ç½ÇÀ» ¾Ë¸°´Ù.

	m_dwGuild = -1;							// ÃÊ±âÈ­ÇÑ´Ù.
	m_sGuildVersion = -1;					// ±æµå ¹®¾ç ¹öÁ¯
	::ZeroMemory(m_strGuildName, sizeof(m_strGuildName));	
	m_bGuildMaster = FALSE;					// ±æµå ¸¶½ºÅÍ
	m_bRepresentationGuild = FALSE;			// ±ÇÇÑ ´ëÇà ¿©ºÎ	 	

	SendMyGuildInfo();						// ±æµå Å»Åð¸¦ ¾Ë¸°´Ù.


//	SendSystemMsg( IDS_USER_OUT_GUILD, SYSTEM_NORMAL, TO_ME);
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå¸¦ Å»ÅðÇÑ À¯Àú¸¦ ´Ù¸¥ ±æµå¿ø¿¡°Ô ¾Ë¸°´Ù.
//
void USER::SendGuildOffUser(USER *pUser)
{
	int i;
	int nLen = 0;	
	int nCount = -1;

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
	if(m_dwGuild <= 0) return;

	USER *pGUser = NULL;

	CBufferEx TempBuf;

	CString strMsg = _T("");
	strMsg.Format( IDS_USER_OUT_MEMBER, pUser->m_strUserID);

	for(i = 0; i< MAX_USER; i++)
	{
		pGUser = m_pCom->GetUserUid(i);

		if(pGUser == NULL || pGUser->m_state != STATE_GAMESTARTED) continue;		

		if(m_dwGuild == pGUser->m_dwGuild) pGUser->SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
	}


}

////////////////////////////////////////////////////////////////////////////////
//	±æ¸¶°¡ ÀÚ±â ±æµå¸¦ ÇØ»ê ½ÃÅ²´Ù.
//
void USER::GuildDisperse(TCHAR *pBuf)
{
#ifdef _ACTIVE_USER
//	if(m_iDisplayType == 6 && m_sLevel > 25) return; //yskang 0.5
	if(m_iDisplayType == 6) return; //yskang 0.5
#endif

	int i;//, j;
	int index = 0, nLen = 0;
	BYTE error_code = 0;

	USER *pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildUser *pGuildUser = NULL;

	CStore *pStore = NULL;
	CGuildFortress *pFort = NULL;

	if( m_curz == 56 || m_curz == 57 || m_curz == 58 || m_curz == 59 )	// ARK¿¡¼­´Â ±æµå ÇØ»ê ÇÒ ¼ö ¾ø´Ù.
	{
		SendSystemMsg( _T("A.R.K.¿¡¼­´Â ±æµå¸¦ ÇØ»ê ÇÒ ¼ö ¾ø½À´Ï´Ù."), SYSTEM_ERROR, TO_ME);
		return;
	}

	if(!m_bGuildMaster) 
	{
		SendSystemMsg( IDS_USER_NO_PERMISSION_USE, SYSTEM_ERROR, TO_ME);		
		return;
	}

	if(m_dwGuild <= 0 || m_dwGuild >= g_arGuildData.GetSize()) return;

	if(CheckInGuildWarring()) return;								// ±æÀüÁß¿¡´Â Çã¶ôÁA¼ö¾ø´Ù.

	// Field WarÀÏ¶§
	if(m_tGuildWar == GUILD_WARRING && m_dwFieldWar > 0)
	{
		SendSystemMsg( IDS_USER_CANT_DISMISS_IN_WAR, SYSTEM_ERROR, TO_ME);
		return;
	}

	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		if(!g_arGuildFortress[i]) continue;

		pFort = g_arGuildFortress[i];

		if(pFort->m_iGuildSid == m_dwGuild)
		{
			SendSystemMsg( IDS_USER_CANT_DISMISS_FORTRESS, SYSTEM_ERROR, TO_ME);
			return;
		}
	}

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		return;
	}

	nLen = strlen(m_strUserID);
	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH)
	{
		ReleaseGuild();				
		return;
	}

	if(strcmp(pGuild->m_strMasterName, m_strUserID) != 0)
	{
		ReleaseGuild();				
		return;
	}

	// alisia - ±æµå Ã¢°í¸¦ »ç¿ëÁßÀÌ ¾Æ´Ï¸é »ç¿ëÁßÀ¸·Î ¸¸µé°í ±æµå ÇØ»êÀ» ½ÅÃ»ÇÑÈÄ ¸®ÅÏÇÑ´Ù.
	if(InterlockedCompareExchange((LONG*)&g_arGuildData[m_dwGuild]->m_lUsed, (long)1, (long)0) == (long)0)
	{
		g_pMainDlg->BridgeServerGuildDisperseReq( m_uid, m_strUserID, (int)m_dwGuild );
	}
	else
	{
		SendSystemMsg( IDS_USER_CANT_DISMISS_IN_BANK, SYSTEM_ERROR, TO_ME);
	}
	ReleaseGuild();
	return;





	// ÇØ´ç ±æµå Ã¢°í°¡ »ç¿ëÁßÀÌ ¾Æ´Ï¸é ½ÃÀÛ...
	if(InterlockedCompareExchange((LONG*)&g_arGuildData[m_dwGuild]->m_lUsed, (long)1, (long)0) == (long)0)
	{
		if(!DeleteGuildDB()) 				// DB »èÁ¦
		{
			ReleaseGuild();
			::InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, 0);
			return;
		}
											// »óÁ¡À» ¼ÒÀ¯ Çß´Ù¸é ÃÊ±âÈ­	
/*		for(i = 0; i < g_arStore.GetSize(); i++)
		{
			pStore = g_arStore[i];
			if(!pStore) continue;

			if(pStore->m_iGuildSid == m_dwGuild)
			{
				::ZeroMemory(pStore->m_strGuildName, CHAR_NAME_LENGTH + 1);
				::ZeroMemory(pStore->m_strMasterName, CHAR_NAME_LENGTH + 1);

				pStore->InitStoreInfo(-1);
				SetGuildStoreTex(pStore->m_sStoreID, 0);	// Tax Rate Init
				InitMemStore(pStore);
				break;
			}
		}
*/
		index = m_dwGuild;

		// ±æµåÇÏ¿ì½º°¡ ÀÖ´Ù¸é ÀÌ¿ëºÒ°¡·Î ¸¸µé¾î ÁØ´Ù. 
		for(i = 0; i < g_arGuildHouse.GetSize(); i++)
		{
			if(m_dwGuild == g_arGuildHouse[i]->iGuild)
			{
				CNpc *pNpc = NULL;				// ¹®ÆÐµµ...
				pNpc = GetNpc(g_arGuildHouse[i]->iMarkNpc);
				if(pNpc)
				{
					pNpc->m_sPid = 0;
					pNpc->m_sMaxHP = 1;
					::ZeroMemory(pNpc->m_strName, sizeof(pNpc->m_strName));
				}

				g_arGuildHouse[i]->iGuild = 0;
				break;
			}
		}

		// ¿ä»õ°¡ ÀÖ´Ù¸é ÀÌ¿ëºÒ°¡·Î ¸¸µé¾î ÁØ´Ù. 
		for(i = 0; i < g_arGuildFortress.GetSize(); i++)
		{
			if(!g_arGuildFortress[i]) continue;

			pFort = g_arGuildFortress[i];

			if(pFort->m_iGuildSid == m_dwGuild)
			{
				if(pFort->m_lViolenceUsed == 1) 
				{
					pFort->m_wMopPartyTime.wYear = 2030;		// ±æµå°¡ ÇØ»êµÇ¸é¼­ ³ª¸ÓÁö´Â ¸ðµÎ ÃÊ±âÈ­¸¦
					pFort->SetNpcToFortressViolenceEnd(m_pCom);
					pFort->GetOutof(m_pCom);
				}

				pFort->SetInitFortress();
				pFort->InitMemFortress(GUILD_WAR_DECISION);
				break;
			}
		}


		g_arGuildData[m_dwGuild]->InitGuild();

		ReleaseGuild();

		for(i = 0; i < MAX_USER; i++)		// ±æµå¿øµé ¼ÂÆÃ
		{
			pUser = m_pCom->GetUserUid(i);

			if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;
			if(pUser->m_dwGuild <= 0) continue;

			if(pUser->m_dwGuild == index)
			{
				pUser->SendSystemMsg( IDS_USER_DISMISS_COMPLETED, SYSTEM_NORMAL, TO_ME);

				pUser->m_dwGuild = -1;							// ÃÊ±âÈ­ÇÑ´Ù.
				pUser->m_sGuildVersion = -1;					// ±æµå ¹®¾ç ¹öÁ¯
				::ZeroMemory(pUser->m_strGuildName, sizeof(pUser->m_strGuildName));	
				pUser->m_bGuildMaster = FALSE;					// ±æµå ¸¶½ºÅÍ
				pUser->m_bRepresentationGuild = FALSE;			// ±ÇÇÑ ´ëÇà ¿©ºÎ	 	

				pUser->m_bFieldWarApply = FALSE;
				pUser->m_tGuildWar = GUILD_WAR_AFFTER;
				pUser->m_tGuildHouseWar = GUILD_WAR_AFFTER;
				pUser->m_tFortressWar = GUILD_WAR_AFFTER;

				pUser->SendMyGuildInfo();				
			}
		}
		// DB¿¡¼­ »èÁ¦..
		// Á¢¼ÓÇÑ À¯Àú¿¡¼­ »èÁ¦...
		// ¿ì¼± ¸Þ¸ð¸®¿¡¼­ »èÁ¦... (Guild, Guild_House_Rank, 
	}
	else 
	{
		ReleaseGuild();
		SendSystemMsg( IDS_USER_CANT_DISMISS_IN_BANK, SYSTEM_ERROR, TO_ME);
	}

	UpdateUserData();
//	ReleaseGuild();
}

void USER::GuildDisperseWithThread(TCHAR *pBuf)
{
	int i, j;
	int index = 0, nLen = 0;
	BYTE error_code = 0;

	USER *pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildUser *pGuildUser = NULL;

	CStore *pStore = NULL;
	CGuildFortress *pFort = NULL;

	if(!m_bGuildMaster) return;
	if(m_dwGuild <= 0 || m_dwGuild >= g_arGuildData.GetSize()) return;

	// °ø¼ºÀüÀÏ¶§...
	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		pFort = g_arGuildFortress[i];
		if(!pFort) continue;

		if(g_arGuildFortress[i]->m_lUsed == 1)
		{
			if(pFort->m_iGuildSid == m_dwGuild)	// ¹æ¾îÃøÀÎÁö
			{
				SendSystemMsg( IDS_USER_CANT_DISMISS_IN_WAR, SYSTEM_ERROR, TO_ME);
				return;
			}

			for(j =0; j < GUILD_ATTACK_MAX_NUM; j++)// °ø°ÝÃøÀÎÁö..
			{
				if(pFort->m_arAttackGuild[j].lGuild == m_dwGuild)
				{
					SendSystemMsg( IDS_USER_CANT_DISMISS_IN_WAR, SYSTEM_ERROR, TO_ME);
					return;
				}
			}
		}
	}
	// ±æµå»óÁ¡...
/*	for(i = 0; i < g_arStore.GetSize(); i++)
	{
		pStore = g_arStore[i];
		if(!pStore) continue;

		if(g_arStore[i]->m_lUsed == 1)
		{
			if(pStore->m_iGuildSid == m_dwGuild)	// ¹æ¾îÃøÀÎÁö
			{
				SendSystemMsg( IDS_USER_CANT_DISMISS_IN_WAR, SYSTEM_ERROR, TO_ME);
				return;
			}

			for(j =0; j < GUILD_ATTACK_MAX_NUM; j++)// °ø°ÝÃøÀÎÁö..
			{
				if(pStore->m_arAttackGuild[j] == m_dwGuild)
				{
					SendSystemMsg( IDS_USER_CANT_DISMISS_IN_WAR, SYSTEM_ERROR, TO_ME);
					return;
				}
			}
		}
	}
*/
	// Virtual Room¿¡ ÀÖÀ»¶§
	for(i = 0; i < g_arGuildHouseWar.GetSize(); i++)
	{
		if(!g_arGuildHouseWar[i]) continue;

		if(g_arGuildHouseWar[i]->m_CurrentGuild.lUsed == 1)
		{
			if(g_arGuildHouseWar[i]->m_CurrentGuild.lGuild == m_dwGuild)
			{
				SendSystemMsg( IDS_USER_CANT_DISMISS_IN_WAR, SYSTEM_ERROR, TO_ME);
				return;
			}
		}
	}

	// Field WarÀÏ¶§
	if(m_tGuildWar == GUILD_WARRING && m_dwFieldWar > 0)
	{
		SendSystemMsg( IDS_USER_CANT_DISMISS_IN_WAR, SYSTEM_ERROR, TO_ME);
		return;
	}

	int Datalength;
	SQLDATAPACKET *pSDP;

	pSDP = new SQLDATAPACKET;
	pSDP->code = GUILD_DISPERSE;
	Datalength = 0;
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pSDP->pData = NULL;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );

}

////////////////////////////////////////////////////////////////////////////////
//	±æ¸¶°¡ ±æµå¿øÀ» ÅðÃâ½ÃÅ²´Ù. ^^
//
void USER::GuildKickOut(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	int index = 0;
	BYTE error_code = 0;

	USER *pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildUser *pGuildUser = NULL;

	BOOL bRes = TRUE;

	CString strTemp = _T("");

	TCHAR szUserName[255];
	::ZeroMemory(szUserName, sizeof(szUserName));

	if(!m_bGuildMaster && !m_bRepresentationGuild) return;

	int nLength = GetVarString(sizeof(szUserName), szUserName, pBuf, index);
	if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) // Àß¸øµÈ À¯Àú¾ÆÀÌµð
	{
		error_code = ERR_6;
		goto go_result;
	}

	if(m_dwGuild <= 0) { error_code = ERR_8; goto go_result; }

	if(CheckInGuildWarring()) return;			// ±æÀüÁß¿¡´Â Çã¶ôÁA¼ö¾ø´Ù.
	
	pGuild = GetGuild(m_dwGuild);

	if(!pGuild)									// ±æµå°¡ ¾øÀ¸¸é
	{
		ReleaseGuild();		
		error_code = ERR_7;
		goto go_result;
	}
												// ±æµå ¸¶½ºÅÍ°¡ Å»ÅðÀÇ»ç¸¦ ¹àÈ÷¸é ¿¡·¯...^^			
//	if(strcmp(pGuild->m_strMasterName, szUserName) == 0)
	if( !pGuild->IsMasterPower(m_strUserID) )
	{
		ReleaseGuild();				

		m_bGuildMaster = FALSE;
		m_bRepresentationGuild = FALSE;
		error_code = ERR_10;
		goto go_result;
	}

	if( pGuild->IsMasterPower(szUserName) )
	{
		ReleaseGuild();				
		error_code = ERR_8;
		goto go_result;
	}
	
	index = -1;
	index = pGuild->GetUser(szUserName);			// ÇØ´ç ÀÌ¸§ÀÇ ±æµå¿øÀÌ ÀÖ´ÂÁö..

	if(index < 0)
	{
		ReleaseGuild();		
		error_code = ERR_8;
		goto go_result;
	}
														// ÇöÀç ±æµåÃ¢°í ÀÌ¿ëÁßÀÌ¸é Ãß¹æÀÌ ½ÇÆÐ...
	if(strcmp(pGuild->m_strUsedUser, szUserName) == 0)
	{
		ReleaseGuild();	
		error_code = 255;
		goto go_result;
	}

	// alisia
//	g_pMainDlg->BridgeServerGuildOffReq( m_uid, m_strUserID, szUserName, (int)m_dwGuild );
//	ReleaseGuild();
//	return;



	if(!DeleteGuildUser(szUserName))		// Å×ÀÌºí¿¡¼­ »èÁ¦
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = 255;
		goto go_result;
	}



	pGuild->RemoveUser(szUserName);		// ¸Þ¸ð¸®»ó¿¡¼­ »èÁ¦
	ReleaseGuild();
	bRes = FALSE;

go_result:
	if(bRes)
	{
		CBufferEx TempBuf;
		TempBuf.Add(CHAT_RESULT);
		TempBuf.Add((BYTE)0x00);
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	DelGuildUserInFortress(szUserName, m_dwGuild);		// ÃÊ±âÈ­¸¦ ÇØ¾ßÇÑ´Ù.

	pUser = GetUser(szUserName);			// ÇöÀç Á¢¼ÓÁßÀÎ À¯Àú¸é...
	if(pUser)
	{
		pUser->m_dwGuild = -1;
		pUser->m_sGuildVersion = -1;		// ±æµå ¹®¾ç ¹öÁ¯
		::ZeroMemory(pUser->m_strGuildName, sizeof(pUser->m_strGuildName));	
		pUser->m_bGuildMaster = FALSE;			// ±æµå ¸¶½ºÅÍ
		pUser->m_bRepresentationGuild = FALSE;	// ±ÇÇÑ ´ëÇà ¿©ºÎ	 	
		pUser->SendMyGuildInfo();
		pUser->SendSystemMsg( IDS_USER_KICKOUT_GUILD, SYSTEM_NORMAL, TO_ME);

		SendGuildOffUser(pUser);
	}

	UpdateUserData();

	strTemp.Format( IDS_USER_KICKOUT_MEMBER, szUserName);
	SendSystemMsg((LPTSTR)(LPCTSTR)strTemp, SYSTEM_NORMAL, TO_ME);
}

void USER::GuildKickOutWithThread(TCHAR *pBuf)
{
	int index = 0;
	BYTE error_code = 0;

	USER *pUser = NULL;
	BOOL bRes = TRUE;

	CString strTemp = _T("");

	TCHAR szUserName[255];
	::ZeroMemory(szUserName, sizeof(szUserName));

	if(!m_bGuildMaster) return;

	int nLength = GetVarString(sizeof(szUserName), szUserName, pBuf, index);
	if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) // Àß¸øµÈ À¯Àú¾ÆÀÌµð
	{
		error_code = ERR_6;
		goto go_result;
	}

	if(m_dwGuild <= 0) { error_code = ERR_8; goto go_result; }

	int Datalength;
	SQLDATAPACKET *pSDP;
	BYTE *pData;

	pSDP = new SQLDATAPACKET;
	pSDP->code = GUILD_KICK_OUT;
	Datalength = nLength;
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pData = new BYTE[Datalength+1];
	memset(pData, NULL, Datalength+1);
	memcpy(	pData, pBuf, Datalength );
	pSDP->pData = pData;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );

	return;	

go_result:
	if(bRes)
	{
		CBufferEx TempBuf;
		TempBuf.Add(CHAT_RESULT);
		TempBuf.Add((BYTE)0x00);
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	pUser = GetUser(szUserName);			// ÇöÀç Á¢¼ÓÁßÀÎ À¯Àú¸é...
	if(pUser)
	{
		pUser->m_dwGuild = -1;
		pUser->m_sGuildVersion = -1;		// ±æµå ¹®¾ç ¹öÁ¯
		::ZeroMemory(pUser->m_strGuildName, sizeof(pUser->m_strGuildName));	
		pUser->m_bGuildMaster = FALSE;			// ±æµå ¸¶½ºÅÍ
		pUser->m_bRepresentationGuild = FALSE;	// ±ÇÇÑ ´ëÇà ¿©ºÎ	 	
		pUser->SendMyGuildInfo();
		pUser->SendSystemMsg( IDS_USER_KICKOUT_GUILD, SYSTEM_NORMAL, TO_ME);

		SendGuildOffUser(pUser);
	}

	strTemp.Format( IDS_USER_KICKOUT_MEMBER, szUserName);
	SendSystemMsg((LPTSTR)(LPCTSTR)strTemp, SYSTEM_NORMAL, TO_ME);
}

////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç À¯Àú ±æµå Á¤º¸¸¦ º¸³½´Ù.
//
void USER::SendGuildInfo(USER *pUser)
{
	CBufferEx TempBuf;

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;

	TempBuf.Add(GUILD_INFO);
	TempBuf.Add(pUser->m_uid + USER_BAND);
	TempBuf.Add((int)pUser->m_dwGuild);
	TempBuf.AddString(pUser->m_strGuildName);
	TempBuf.Add((short)pUser->m_sGuildVersion);

	pUser->Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////
//	³» ±æµå Á¤º¸¸¦ º¸³½´Ù.
//
void USER::SendMyGuildInfo()
{
	CBufferEx TempBuf;

	TempBuf.Add(GUILD_INFO);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add((int)m_dwGuild);
	TempBuf.AddString(m_strGuildName);
	TempBuf.Add((short)m_sGuildVersion);

	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í ¾ÆÀÌÅÛÀ» °¡Áö°í ¿Â´Ù.
//
void USER::GuildWharehouseOpenReq()
{
	int i, j;
	int nLen = 0;
	
	CBufferEx TempBuf;

	CByteArray arItemSlotList;

	USER *pUser = NULL;

	CString guild = _T("");
	guild.Format("%s", m_strGuildName);
	if(guild.IsEmpty()) return;
	if(m_dwGuild <= 0) return;

	CGuild *pGuild = GetGuild(m_dwGuild);

	ReleaseGuild();

	if(!pGuild)
	{
		m_dwGuild = -1;
		return;
	}

	if(InterlockedCompareExchange((LONG*)&g_arGuildData[m_dwGuild]->m_lUsed, (long)1, (long)0) == (long)0)
	{
		m_dwGuildDN = 0;
		InitGuildItem();								// º¯¼ö¸¦ ±ú²ýÀÌ ¼¼Å¹ÇÑ´Ù.

		nLen = strlen(m_strUserID);
		if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) 
		{ 
			InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0); 
			return; 
		}

		if(!LoadGuildWarehouse())						// ±æµå ¾ÆÀÌÅÛÀ» Ã³À½ Á¢¼ÓÇÒ¶§ °¡Áö°í ¿Â´Ù.
		{ 
			InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0); 
			return; 
		}
		
		g_arGuildData[m_dwGuild]->m_iUsedUser = m_uid;
		strncpy(g_arGuildData[m_dwGuild]->m_strUsedUser, m_strUserID, nLen);

		for(i = 0; i < TOTAL_BANK_ITEM_NUM; i++)
		{												// ÇöÀç º¸°üµÈ ¾ÆÀÌÅÛ¸¸ º¸¿©ÁÖ±âÀ§ÇØ Á¤·ÄÇÑ´Ù. 
			if(m_GuildItem[i].sSid >= 0)
			{
				arItemSlotList.Add(i);
			}
		}

		TempBuf.Add(GUILD_WAREHOUSE_OPEN);
		TempBuf.Add((DWORD)m_dwGuildDN);
		TempBuf.Add((BYTE)arItemSlotList.GetSize());

		for(i = 0; i < arItemSlotList.GetSize(); i++)
		{
			BYTE tempSlot = 0;
			tempSlot = arItemSlotList[i];
			TempBuf.Add(tempSlot);
			TempBuf.Add((short)m_GuildItem[tempSlot].sLevel);
			TempBuf.Add((short)m_GuildItem[tempSlot].sSid);
			TempBuf.Add((short)m_GuildItem[tempSlot].sDuration);
			TempBuf.Add((short)m_GuildItem[tempSlot].sBullNum);
			TempBuf.Add((short)m_GuildItem[tempSlot].sCount);

			for(j = 0; j < MAGIC_NUM; j++) TempBuf.Add((BYTE)m_GuildItem[tempSlot].tMagic[j]);

			TempBuf.Add((BYTE)m_GuildItem[tempSlot].tIQ);
		}

		Send(TempBuf, TempBuf.GetLength());
	}
	else 
	{
		CString strMsg = _T("");
		nLen = strlen(g_arGuildData[m_dwGuild]->m_strUsedUser);
		if(nLen <= 0) 
		{
			InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0);
			return;
		}

		if(strcmp(g_arGuildData[m_dwGuild]->m_strUsedUser, _ID(IDS_USER_OPERATOR)) == 0)
		{
			strMsg.Format( IDS_USER_CANT_USE_GUILD_BANK_NOW, g_arGuildData[m_dwGuild]->m_strUsedUser);
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
			return;
		}

		strMsg.Format( IDS_USER_GUILD_BANK_IN_USE, g_arGuildData[m_dwGuild]->m_strUsedUser);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

		if(nLen > 0)										// ±æµå Ã¢°í¸¦ ÀÌ¿ëÁß ºñÁ¤»ó Á¾·áµÇ´Â À¯Àú¸¦ È®ÀÎÇÏ´Â ÀýÂ÷. 
		{
			pUser = GetUser(g_arGuildData[m_dwGuild]->m_iUsedUser);
			//(g_arGuildData[m_dwGuild]->m_strUsedUser);			// ÀÌ¿ëÁß ºñÁ¤»ó Á¾·áµÇ¸é Ç®¾îÁØ´Ù.	
			if(!pUser || strcmp(pUser->m_strUserID, g_arGuildData[m_dwGuild]->m_strUsedUser) != 0)
			{
				g_arGuildData[m_dwGuild]->m_iUsedUser = -1;
				::ZeroMemory(g_arGuildData[m_dwGuild]->m_strUsedUser, sizeof(g_arGuildData[m_dwGuild]->m_strUsedUser));
				InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0); 
			}
		}
	}
}

void USER::GuildWharehouseOpenReqWithThread()
{
	int Datalength;
	SQLDATAPACKET *pSDP;

	pSDP = new SQLDATAPACKET;
	pSDP->code = DB_GUILD_WHEREHOUSE_EVENT_REQ;
	Datalength = 0;
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pSDP->pData = NULL;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í¸¦ ´Ý´Â´Ù. 
//
void USER::GuildWharehouseCloseReq()
{
	int nLen = 0;
	CString guild = _T("");
	guild.Format("%s", m_strGuildName);
	if(guild.IsEmpty()) return;
	if(m_dwGuild <= 0 || m_dwGuild >= g_arGuildData.GetSize()) return;
	if(!g_arGuildData[m_dwGuild]) return;

	nLen = strlen(m_strUserID);
	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return;
	if(strcmp(g_arGuildData[m_dwGuild]->m_strUsedUser, m_strUserID) != 0) return;

	g_arGuildData[m_dwGuild]->m_iUsedUser = -1;
	::ZeroMemory(g_arGuildData[m_dwGuild]->m_strUsedUser, sizeof(g_arGuildData[m_dwGuild]->m_strUsedUser));
	InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0);
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í ¾ÆÀÌÅÛÀ» ÀÐ¾î¿Â´Ù.
//
BOOL USER::LoadGuildWarehouse()
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode;
	TCHAR			szSQL[1024];

	::ZeroMemory(szSQL, sizeof(szSQL));
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call LOAD_GUILD_WAREHOUSE (\'%s\')}"), m_strGuildName);

	SQLUINTEGER iDN;
	SQLCHAR		strItem[_BANK_DB];
	
	SQLINTEGER	sInd;

	iDN = 0;
	::ZeroMemory(strItem, sizeof(strItem));

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );

	if( retcode != SQL_SUCCESS )
	{
//		TRACE("Fail To Load Guild Warehouse Data !!\n");

//		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, SQL_NTS);

	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		retcode = SQLFetch( hstmt );

		if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
		{
			int i = 1;
			SQLGetData( hstmt, i++, SQL_C_ULONG,	&iDN,		sizeof(iDN),		&sInd );
			SQLGetData( hstmt, i++, SQL_C_BINARY,	strItem,	sizeof(strItem),	&sInd );
		}
		else 
		{
			retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			g_DB[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);

	StrToGuildItem((LPTSTR)strItem);
	m_dwGuildDN = iDN;

	return TRUE;
}

///////////////////////////////////////////////////////////////////////////////
//	m_GuildItem ¿¡ BufferÀÇ ³»¿ëÀ» Copy ÇÑ´Ù.
//
void USER::StrToGuildItem(TCHAR *pBuf)
{
	int index = 0;
	int i, j;
	MYINT64 serial;

	for(i = 0; i < TOTAL_BANK_ITEM_NUM; i++)
	{
		m_GuildItem[i].sLevel	= GetShort(pBuf, index);
		m_GuildItem[i].sSid		= GetShort(pBuf, index);
		m_GuildItem[i].sDuration = GetShort(pBuf, index);
		m_GuildItem[i].sBullNum	= GetShort(pBuf, index);
		m_GuildItem[i].sCount	= GetShort(pBuf, index);

		if(m_GuildItem[i].sCount <= 0) m_GuildItem[i].sSid = -1;
		for(j = 0; j < MAGIC_NUM; j++) m_GuildItem[i].tMagic[j] = GetByte(pBuf, index);
		
		m_GuildItem[i].tIQ = GetByte(pBuf, index);

		for( j = 0; j < 8; j++ ) serial.b[j] = GetByte( pBuf, index );

		m_GuildItem[i].iItemSerial = serial.i;
	}	
}

////////////////////////////////////////////////////////////////////////////////
//	Buffer¿¡ m_GuildItemÀÇ ³»¿ëÀ» Copy ÇÑ´Ù.
//
void USER::GuildItemToStr(TCHAR *pBuf)
{
	int index = 0;
	int i, j;
	MYINT64 serial;

	for(i = 0; i < TOTAL_BANK_ITEM_NUM; i++)
	{
		SetShort(pBuf, m_GuildItem[i].sLevel,	index);
		SetShort(pBuf, m_GuildItem[i].sSid,		index);
		SetShort(pBuf, m_GuildItem[i].sDuration,index);
		SetShort(pBuf, m_GuildItem[i].sBullNum,	index);
		SetShort(pBuf, m_GuildItem[i].sCount,	index);

		for(j = 0; j < MAGIC_NUM; j++) SetByte(pBuf, m_GuildItem[i].tMagic[j], index);

		SetByte(pBuf, m_GuildItem[i].tIQ, index);

		serial.i = m_GuildItem[i].iItemSerial;

		for(j = 0; j < 8; j++ ) SetByte( pBuf, serial.b[j], index );
	}
}

///////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í¿¡¼­ ÀÔÃâ±Ý, ÀÔÃâÀÔ ¾ÆÀÌÅÛÀ» ´ã´çÇÑ´Ù.
//
void USER::GuildItemMoveReq(TCHAR *pBuf)
{
#ifdef _ACTIVE_USER
//	if(m_iDisplayType == 6 && m_sLevel > 25) return; //yskang 0.5
	if(m_iDisplayType == 6) return; //yskang 0.5
#endif

	int index = 0;
	BYTE type = GetByte(pBuf, index);

	if(m_dwGuild < 0 || m_dwGuild >= g_arGuildData.GetSize()) return;
	if(!g_arGuildData[m_dwGuild]) return;

	int nLen = strlen(g_arGuildData[m_dwGuild]->m_strUsedUser);

	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return;

	if(strcmp(m_strUserID, g_arGuildData[m_dwGuild]->m_strUsedUser) == 0)
	{
		if(g_arGuildData[m_dwGuild]->m_lUsed == 1)
		{
			switch(type)
			{
			case GUILD_ITEM_INPUT:
				GuildInPut(pBuf + index);
				break;
			case GUILD_ITEM_OUTPUT:
				GuildOutPut(pBuf + index);
				break;
			case GUILD_DN_INPUT:
				GuildInPutDN(pBuf + index);
				break;
			case GUILD_DN_OUTPUT:
				GuildOutPutDN(pBuf + index);
				break;
			}
		}
		else 
		{
			g_arGuildData[m_dwGuild]->m_iUsedUser = -1;
			::ZeroMemory(g_arGuildData[m_dwGuild]->m_strUsedUser, sizeof(g_arGuildData[m_dwGuild]->m_strUsedUser));
		}
	}
}

void USER::GuildItemMoveReqWithThread(TCHAR *pBuf)
{
	int index = 0;
	BYTE type = GetByte(pBuf, index);

	if(m_dwGuild < 0) return;
	if(!g_arGuildData[m_dwGuild]) return;

	int nLen = strlen(g_arGuildData[m_dwGuild]->m_strUsedUser);

	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return;

	if(strcmp(m_strUserID, g_arGuildData[m_dwGuild]->m_strUsedUser) == 0)
	{
		if(g_arGuildData[m_dwGuild]->m_lUsed == 1)
		{
			int Datalength;
			BYTE *pData;
			SQLDATAPACKET *pSDP;
			pSDP = new SQLDATAPACKET;
			pSDP->code = DB_GUILD_ITEM_MOVE_REQ;

			if ( type == GUILD_ITEM_INPUT || type == GUILD_ITEM_OUTPUT)
				Datalength = sizeof(BYTE)+sizeof(BYTE)+sizeof(short);
			else
				Datalength = sizeof(BYTE)+sizeof(DWORD);

			pSDP->dcount = Datalength;
			pSDP->UID = m_uid;
			pData = new BYTE[Datalength+1];
			memset(pData, 0, Datalength+1);
			memcpy(pData, pBuf, Datalength);
			pSDP->pData = pData;

			EnterCriticalSection( &m_CS_SqlData );
			RecvSqlData.AddTail(pSDP);
			nSqlDataCount = RecvSqlData.GetCount();
			LeaveCriticalSection( &m_CS_SqlData );		
		}
		else 
		{
			g_arGuildData[m_dwGuild]->m_iUsedUser = -1;
			::ZeroMemory(g_arGuildData[m_dwGuild]->m_strUsedUser, sizeof(g_arGuildData[m_dwGuild]->m_strUsedUser));
		}
	}
}
////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í¿¡ ¾ÆÀÌÅÛÀ» ³Ö´Â´Ù.
//
void USER::GuildInPut(TCHAR *pBuf)//¾üÍÅ²Ö¿â ´æÈë
{
	int i;
	int tDestSlot;
	int index = 0;
	int iOver = 0;
	short sSid = -1;
	short sHaveCount = 0;

	BYTE result = SUCCESS;

	CBufferEx TempBuf;

	ItemList MyItem[TOTAL_ITEM_NUM], BackItem;

	BYTE tSourceSlot = GetByte(pBuf, index);	// »ç¿ëÀÚ ¾ÆÀÌÅÛÀÌ ÀÖ´ø ½½·Ô À§Ä¡
	short sCount = GetShort(pBuf, index);		// ¾ó¸¶¸¸Å­ º¸°ü
												// ¿À·ÎÁö ÀÎº¥¸¸ °¡´ÉÇÏ´Ù.			
	if(tSourceSlot < EQUIP_ITEM_NUM || tSourceSlot >= TOTAL_INVEN_MAX) { result = FAIL; goto go_result; }

	if(!m_MItemLock && o_yehuoini[0]->mimabaohu == 1 )
	{
        SendSystemMsg( "ÇëÏÈ½â³ýÃÜÂë±£»¤ºóÔÚ²Ù×÷", SYSTEM_ERROR, TO_ME);
		result = FAIL;
		goto go_result;
	}
	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE) { result = FAIL; goto go_result; }//Î´ÖªBUG

	sSid = m_UserItem[tSourceSlot].sSid;
	sHaveCount = m_UserItem[tSourceSlot].sCount;
												// Àß¸øµÈ sSid		
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) { result = FAIL; goto go_result; }

	if(g_arItemTable[sSid]->m_sEvent >= EVENT_UNIQUE_ITEM_BAND)
	{
		SendSystemMsg( IDS_USER_CANT_SHARE_EVENT_ITEM, SYSTEM_ERROR, TO_ME);
		result = FAIL; goto go_result; 
	}

	if(sCount >= BANK_MAX_ITEM) 
	{
		SendSystemMsg( IDS_USER_ONCE_MOVE_MAX, SYSTEM_ERROR, TO_ME);
		result = FAIL; goto go_result;
	}
												
	if(sCount <= 0 || sCount > sHaveCount) { result = FAIL; goto go_result; }	// ¼ÒÁöÇÑ ¾ÆÀÌÅÛ ¼öº¸´Ù ¸¹À» °æ¿ì			
	if(g_arItemTable[sSid]->m_sDuration > 0 && sCount > 1) { result = FAIL; goto go_result; }
	
	for(i = 0; i < TOTAL_ITEM_NUM; i++)	// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

	ReSetItemSlot(&BackItem);					// DB½ÇÆÐ¿¡ ´ëºñÇÑ ¹é¾÷¿ë ÃÊ±âÈ­
												// ÀÏ´Ü °ãÄ¥¼ö ÀÖ´ÂÁö, °ãÄ¡¸é °°Àº ¾ÆÀÌÅÛÀÌ ÀÖ´ÂÁö Ã£¾Æº»´Ù.
	tDestSlot = GetSameItem(m_UserItem[tSourceSlot], GUILD_SLOT);
	
	/***************************±æµå Ã¢°í ¾÷¹« Ã³¸®********************************************/
	if(tDestSlot >= 0)							// Ç×»ó »õ·ÎÀÌ Ãß°¡ µÇ´Â°ÍÀ» ±âÁØÀ¸·Î Ã³¸®
	{											
		BackItem = m_GuildItem[tDestSlot];

		if(m_GuildItem[tDestSlot].sCount >= BANK_MAX_ITEM)
		{
			SendSystemMsg( IDS_USER_SAVE_MAX_COUNT, SYSTEM_ERROR, TO_ME);
			result = FAIL; goto go_result;
		}

		if((m_GuildItem[tDestSlot].sCount + sCount) > BANK_MAX_ITEM)
		{										// MAX°ªÀ» ³ÑÀ¸¸é ²ËÃ¤¿ì°í ³ª¸ÓÁö Ã³¸®			
			iOver =m_GuildItem[tDestSlot].sCount + sCount - BANK_MAX_ITEM;
			if(iOver <= 0) { result = FAIL; goto go_result; }

			m_GuildItem[tDestSlot].sCount = BANK_MAX_ITEM;
			sCount = sCount - iOver;
		}
		else m_GuildItem[tDestSlot].sCount += sCount;
	}
	else
	{											//	Ãß°¡
		tDestSlot = GetEmptySlot(GUILD_SLOT);

		if(tDestSlot == -1) 
		{
			result = FAIL; goto go_result; 
		}

		m_GuildItem[tDestSlot].sLevel = m_UserItem[tSourceSlot].sLevel;
		m_GuildItem[tDestSlot].sSid = m_UserItem[tSourceSlot].sSid;
		m_GuildItem[tDestSlot].sDuration = m_UserItem[tSourceSlot].sDuration;
		m_GuildItem[tDestSlot].sBullNum = m_UserItem[tSourceSlot].sBullNum;
		m_GuildItem[tDestSlot].sCount = sCount;
		for(i = 0; i < MAGIC_NUM; i++) m_GuildItem[tDestSlot].tMagic[i] = m_UserItem[tSourceSlot].tMagic[i];
		m_GuildItem[tDestSlot].tIQ = m_UserItem[tSourceSlot].tIQ;
		m_GuildItem[tDestSlot].iItemSerial = m_UserItem[tSourceSlot].iItemSerial;
	}

	index = 0;
	index = g_arItemTable[m_UserItem[tSourceSlot].sSid]->m_byWeight * sCount;
	/**************************À¯Àú ÀÎº¥ Ã³¸®*********************************************/
	if(sCount >= sHaveCount && iOver == 0)
	{
		MakeItemLog( &m_GuildItem[tDestSlot], ITEMLOG_GUILD_BANKIN );
		ReSetItemSlot(&m_UserItem[tSourceSlot]);	
	}
	else m_UserItem[tSourceSlot].sCount -= sCount;
	
	/**************************DB Update Ã³¸®*********************************************/
	if(UpdateGuildWarehouse() == FALSE)
	{
		for(i = 0; i < TOTAL_ITEM_NUM; i++)// ¾ÆÀÌÅÛ Á¤º¸ º¹¿ø
		{
			m_UserItem[i] = MyItem[i];
		}
		m_GuildItem[tDestSlot] = BackItem;

		result = FAIL;

		FlushItemLog( FALSE );

		goto go_result;
	}

	FlushItemLog( TRUE );

	UpdateUserData();

go_result:
	TempBuf.Add(GUILD_ITEM_MOVE_RESULT);

	if(result == FAIL)
	{
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	m_iCurWeight -= index;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	result = (BYTE)0x01;
	TempBuf.Add(result);

	TempBuf.Add((BYTE)tDestSlot);				// ±æµå	
	TempBuf.Add(m_GuildItem[tDestSlot].sLevel);
	TempBuf.Add(m_GuildItem[tDestSlot].sSid);
	TempBuf.Add(m_GuildItem[tDestSlot].sDuration);
	TempBuf.Add(m_GuildItem[tDestSlot].sBullNum);
	TempBuf.Add(m_GuildItem[tDestSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_GuildItem[tDestSlot].tMagic[i]);
	TempBuf.Add(m_GuildItem[tDestSlot].tIQ);

	TempBuf.Add((BYTE)tSourceSlot);				// À¯Àú ÀÎº¥
	TempBuf.Add(m_UserItem[tSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[tSourceSlot].sSid);
	TempBuf.Add(m_UserItem[tSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[tSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[tSourceSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tSourceSlot].tMagic[i]);
	TempBuf.Add(m_UserItem[tSourceSlot].tIQ);

	Send(TempBuf, TempBuf.GetLength());

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

//	SendQuickChange();							// Äü¾ÆÀÌÅÛ µî·ÏÇÑ°Ô Ãë¼ÒµÇ´ÂÁö ¾Ë¾Æº»´Ù. 
//	SendItemWeightChange();				// ÇöÀç ¾ÆÀÌÅÛ ¹«°Ô¸¦ º¸³½´Ù.
}


////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í¿¡¼­ ¾ÆÀÌÅÛÀ» °¡Á®¿Â´Ù.
//
void USER::GuildOutPut(TCHAR *pBuf) //¾üÍÅ²Ö¿â È¡³ö
{
	int i, iWeight = 0;
	int tDestSlot;
	int index = 0;
	int iOver = 0;
	short sSid = -1;
	short sHaveCount = 0;

	BYTE result = SUCCESS;

	CBufferEx TempBuf;

	ItemList MyItem[TOTAL_ITEM_NUM], BackItem;

	if(!m_bGuildMaster) 
	{
		SendSystemMsg( IDS_USER_NO_PERMISSION_USE, SYSTEM_NORMAL, TO_ME);
		return;
	}
	BYTE tSourceSlot = GetByte(pBuf, index);	// »ç¿ëÀÚ ¾ÆÀÌÅÛÀÌ ÀÖ´ø ½½·Ô À§Ä¡
	short sCount = GetShort(pBuf, index);
												// ¿À·ÎÁö ÀÎº¥¸¸ °¡´ÉÇÏ´Ù.			
	if(tSourceSlot >= TOTAL_BANK_ITEM_NUM) { result = FAIL; goto go_result; }

	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE) { result = FAIL; goto go_result; }//Î´ÖªBUG

	sSid = m_GuildItem[tSourceSlot].sSid;
	sHaveCount = m_GuildItem[tSourceSlot].sCount;
    
    if(sSid == 724)
	{
		if ( FindItem(724) +  sCount >32000)
		{
			SendEventMsg("³¬¹ý×î´óÐ¯´øÁ¿!");
		    result = FAIL;
		    goto go_result;
		}
	}

    if(sSid < 0 || sSid >= g_arItemTable.GetSize()) { result = FAIL; goto go_result; }

	if(sCount < 0 || sCount > sHaveCount/* || sCount > BANK_MAX_ITEM*/) { result = FAIL; goto go_result; }

//	if(g_arItemTable[sSid]->m_byWear <= 5 && sCount > 1) { result = FAIL; goto go_result; }
	if(g_arItemTable[sSid]->m_sDuration > 0 && sCount > 1) { result = FAIL; goto go_result; }

	iWeight = g_arItemTable[sSid]->m_byWeight * sCount;
	if(m_iMaxWeight < m_iCurWeight + iWeight)
	{
		SendSystemMsg( IDS_USER_OVER_WEIGHT1, SYSTEM_ERROR, TO_ME);
		result = FAIL; 
		goto go_result;
	}

	for(i = 0; i < TOTAL_ITEM_NUM; i++)	// ¾ÆÀÌÅÛ Á¤º¸ ¹é¾÷
	{
		MyItem[i] = m_UserItem[i];
	}

	ReSetItemSlot(&BackItem);					// DB½ÇÆÐ¿¡ ´ëºñÇÑ ¹é¾÷¿ë ÃÊ±âÈ­
	BackItem = m_GuildItem[tSourceSlot];

												
	tDestSlot = GetSameItem(m_GuildItem[tSourceSlot], INVENTORY_SLOT);
	
	/***************************±æµåÃ¢°í ¾÷¹« Ã³¸®********************************************/
	if(tDestSlot >= 0)							// Ç×»ó »õ·ÎÀÌ Ãß°¡ µÇ´Â°ÍÀ» ±âÁØÀ¸·Î Ã³¸®
	{		
		m_UserItem[tDestSlot].sCount += sCount;
	}
	else
	{											//	Ãß°¡
		tDestSlot = GetEmptySlot(INVENTORY_SLOT);

		if(tDestSlot == -1) 
		{
			result = FAIL; goto go_result; 
		}

		m_UserItem[tDestSlot].sLevel = m_GuildItem[tSourceSlot].sLevel;
		m_UserItem[tDestSlot].sSid = m_GuildItem[tSourceSlot].sSid;
		m_UserItem[tDestSlot].sDuration = m_GuildItem[tSourceSlot].sDuration;
		m_UserItem[tDestSlot].sBullNum = m_GuildItem[tSourceSlot].sBullNum;
		m_UserItem[tDestSlot].sCount = sCount;
		for(i = 0; i < MAGIC_NUM; i++) m_UserItem[tDestSlot].tMagic[i] = m_GuildItem[tSourceSlot].tMagic[i];
		m_UserItem[tDestSlot].tIQ = m_GuildItem[tSourceSlot].tIQ;
		m_UserItem[tDestSlot].iItemSerial = m_GuildItem[tSourceSlot].iItemSerial;

		MakeItemLog( &m_UserItem[tDestSlot], ITEMLOG_GUILD_BANKOUT );
	}

	/**************************±æµå  Ã³¸®*********************************************/
	if(sCount >= sHaveCount) ReSetItemSlot(&m_GuildItem[tSourceSlot]);	
	else m_GuildItem[tSourceSlot].sCount -= sCount;
	
	/**************************DB Update Ã³¸®*********************************************/
	if(UpdateGuildWarehouse() == FALSE)
	{
		for(i = 0; i < TOTAL_ITEM_NUM; i++)// ¾ÆÀÌÅÛ Á¤º¸ º¹¿ø
		{
			m_UserItem[i] = MyItem[i];
		}
		m_GuildItem[tSourceSlot] = BackItem;

		result = FAIL;

		FlushItemLog( FALSE );

		goto go_result;
	}

	FlushItemLog( TRUE );

	UpdateUserData();

go_result:
	TempBuf.Add(GUILD_ITEM_MOVE_RESULT);

	if(result == FAIL)
	{
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	result = (BYTE)0x02;
	TempBuf.Add(result);

	TempBuf.Add((BYTE)tSourceSlot);
	TempBuf.Add(m_GuildItem[tSourceSlot].sLevel);
	TempBuf.Add(m_GuildItem[tSourceSlot].sSid);
	TempBuf.Add(m_GuildItem[tSourceSlot].sDuration);
	TempBuf.Add(m_GuildItem[tSourceSlot].sBullNum);
	TempBuf.Add(m_GuildItem[tSourceSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_GuildItem[tSourceSlot].tMagic[i]);
	TempBuf.Add(m_GuildItem[tSourceSlot].tIQ);

	TempBuf.Add((BYTE)tDestSlot);
	TempBuf.Add(m_UserItem[tDestSlot].sLevel);
	TempBuf.Add(m_UserItem[tDestSlot].sSid);
	TempBuf.Add(m_UserItem[tDestSlot].sDuration);
	TempBuf.Add(m_UserItem[tDestSlot].sBullNum);
	TempBuf.Add(m_UserItem[tDestSlot].sCount);
	for(i = 0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tDestSlot].tMagic[i]);
	TempBuf.Add(m_UserItem[tDestSlot].tIQ);

	Send(TempBuf, TempBuf.GetLength());

	if(m_UserItem[tDestSlot].sSid < 0 || m_UserItem[tDestSlot].sSid >= g_arItemTable.GetSize()) return;

	m_iCurWeight += (g_arItemTable[m_UserItem[tDestSlot].sSid]->m_byWeight * sCount);
	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...
//	SendItemWeightChange();				// ÇöÀç ¾ÆÀÌÅÛ ¹«°Ô¸¦ º¸³½´Ù.
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í¿¡ µ·À» ³Ö´Â´Ù.
//
void USER::GuildInPutDN(TCHAR *pBuf)  //¾üÍÅ²Ö¿â ´æÈë½ðÇ®
{
	CBufferEx TempBuf;

	BYTE result; 
	int index = 0;
	DWORD BackGuildDN = 0, BackMyDN = 0;

	DWORD InputDN = GetDWORD(pBuf, index);

	TempBuf.Add(GUILD_ITEM_MOVE_RESULT);

	if(InputDN > m_dwDN) 
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE)
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return; //Î´ÖªBUG
	}
	
	BackMyDN = m_dwDN;
	BackGuildDN = m_dwGuildDN;
										// ÀºÇà¿¡ ÀÔ±Ý
	if(!CheckMaxValueReturn(m_dwGuildDN, InputDN))
	{									// ´Ü, MAX°ªÀÌ¸é Â÷¾×Àº...
		CheckMaxValue(m_dwGuildDN, InputDN);
		if(m_dwGuildDN < InputDN) InputDN = 0;
		else InputDN = m_dwGuildDN - InputDN;
	}
	else m_dwGuildDN += InputDN;
										// °¡Áö°í ÀÖ´Â ¼ÒÁö±Ý¿¡¼­ »«´Ù.
	if(m_dwDN <= InputDN) m_dwDN = 0;
	else m_dwDN -= InputDN;

	MakeMoneyLog( InputDN, ITEMLOG_GUILD_BANKIN_MONEY, NULL, m_dwGuildDN );

	if(UpdateGuildWarehouse() == FALSE)		// DB UpDate
	{
		m_dwDN = BackMyDN;
		m_dwGuildDN = BackGuildDN;

		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		FlushItemLog( FALSE );
		return;
	}

	FlushItemLog( TRUE );

	UpdateUserData();

	result = (BYTE)0x03;				// 3 : DN ÀÔ±Ý
	TempBuf.Add(result);

	TempBuf.Add(m_dwGuildDN);			// ÀºÇà³» ÀÔ±ÝÇÑ ÃÑ±Ý¾×
	TempBuf.Add(m_dwDN);				// ¼ÒÁöÇÑ ÃÑ±Ý¾×

	Send(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í¿¡¼­ µ·À» °¡Á®¿Â´Ù.
//
void USER::GuildOutPutDN(TCHAR *pBuf) //¾üÍÅ²Ö¿â È¡³ö½ðÇ®
{
	CBufferEx TempBuf;

	BYTE result; 
	int index = 0;

	if(!m_bGuildMaster) 
	{
		SendSystemMsg( IDS_USER_NO_PERMISSION_USE, SYSTEM_NORMAL, TO_ME);
		return;
	}
	if ( m_bPShopOpen == TRUE || m_bNowTrading == TRUE) return; //Î´ÖªBUG

	DWORD BackGuildDN = 0, BackMyDN = 0;

	DWORD OutputDN = GetDWORD(pBuf, index);

	TempBuf.Add(GUILD_ITEM_MOVE_RESULT);

	if(OutputDN > m_dwGuildDN)			// ³Ê¹« Å©¸é
	{
		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	BackMyDN = m_dwDN;					// ¹é¾÷
	BackGuildDN = m_dwGuildDN;
										
	if(!CheckMaxValueReturn(m_dwDN, OutputDN))
	{									// ´Ü, MAX°ªÀÌ¸é Â÷¾×Àº...
		CheckMaxValue(m_dwDN, OutputDN);
		if(m_dwDN < OutputDN) OutputDN = 0;
		else OutputDN = m_dwDN - OutputDN;
	}
	else m_dwDN += OutputDN;
										// ±æµå¿¡¼­ »«´Ù.
	if(OutputDN == m_dwGuildDN) m_dwGuildDN = 0;
	else m_dwGuildDN -= OutputDN;

	MakeMoneyLog( OutputDN, ITEMLOG_GUILD_BANKOUT_MONEY, NULL, m_dwGuildDN );

	if(UpdateGuildWarehouse() == FALSE)		// DB UpDate
	{
		m_dwDN = BackMyDN;
		m_dwGuildDN = BackGuildDN;

		result = FAIL;
		TempBuf.Add(result);
		Send(TempBuf, TempBuf.GetLength());

		FlushItemLog( FALSE );
		return;
	}

	FlushItemLog( TRUE );

	UpdateUserData();

	result = (BYTE)0x04;				// 4 : DN Ãâ±Ý
	TempBuf.Add(result);

	TempBuf.Add(m_dwGuildDN);			// ±æµå³» ÀÔ±ÝÇÑ ÃÑ±Ý¾×
	TempBuf.Add(m_dwDN);				// ¼ÒÁöÇÑ ÃÑ±Ý¾×

	Send(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////
//	±æµå Ã¢°í º¯È­¸¦ °»½ÅÇÑ´Ù.
//
BOOL USER::UpdateGuildWarehouse()
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strItem[_ITEM_DB], strGuildItem[_BANK_DB], strQuickItem[_QUICKITEM_DB];
	int				i;

	SQLSMALLINT	sRet = 0;
	SQLINTEGER sRetInd;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strGuildItem, sizeof(strGuildItem));
	::ZeroMemory(strItem, sizeof(strItem));
	::ZeroMemory(strQuickItem, sizeof(strQuickItem));

	GuildItemToStr(strGuildItem);
	UserItemToStr(strItem);

	SDWORD sGuildItemLen= sizeof(strGuildItem);
	SDWORD sItemLen		= sizeof(strItem);
	SDWORD sQuickLen	= sizeof(strQuickItem);

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_GUILD_WAREHOUSE_DATA (\'%s\', \'%s\', %d, ?, ?, %d, ?, ?)}"), m_strUserID, m_strGuildName, m_dwDN, m_dwGuildDN);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild Warehouse Data !!\n");

		//g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}
	
	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strItem),	0, (TCHAR*)strItem,		0, &sItemLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strQuickItem),	0, (TCHAR*)strQuickItem,	0, &sQuickLen );
		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strGuildItem),	0, (TCHAR*)strGuildItem,0, &sGuildItemLen );
		SQLBindParameter( hstmt, i++ ,SQL_PARAM_OUTPUT,SQL_C_SSHORT, SQL_SMALLINT, 0, 0, &sRet, 0, &sRetInd);

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DB[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if(sRet == 255) return FALSE;

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////
//	E_Body »óÁ¡À» ¿¬´Ù.
//
void USER::SendEBodyOpen(int nStore)
{
/*
	CBufferEx TempBuf;
	int i = 0;
	short sid = 0;
	short sCount = 0;
	DWORD dwCost = 0, dwXP = 0;

	CStore* pStore = NULL;

	pStore = GetEbodyStore(nStore);
	if(pStore == NULL) return;

	sCount = pStore->m_arItems.GetSize();
	TempBuf.Add(EBODY_OPEN);
	TempBuf.Add((short)nStore);
	TempBuf.Add(sCount);

	for(i = 0; i < pStore->m_arItems.GetSize(); i++)
	{
		sid = (short)pStore->m_arItems[i];

		dwCost = g_arEBodyTable[sid]->m_iDN;
		dwXP = g_arEBodyTable[sid]->m_iXP;

		TempBuf.Add(sid);
		TempBuf.Add(dwXP);
		TempBuf.Add(dwCost);
	}

	Send(TempBuf, TempBuf.GetLength());
*/
}

////////////////////////////////////////////////////////////////////////////////
//	E_Body ±¸ÀÔÀ» ÇÑ´Ù.
//
void USER::EBodyBuyReq(TCHAR *pBuf)
{
/*
	return;			//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

	int index = 0;
	short sSid = 0;
	short sStoreID = 0;			// »óÁ¡ ¾ÆÀÌµð

	BOOL bSell = FALSE;	

	CBufferEx TempBuf;

	BYTE tNeedClass;
	BYTE tMyClass;
	BYTE tTemp = 1;	
	BYTE tFire = 0;
	BYTE tEdge = 0;
	BYTE tStaff = 0;
	BYTE tBrawl = 0;

	CStore* pStore = NULL;

	sStoreID = GetShort(pBuf, index);

	pStore = GetEbodyStore(sStoreID);
	if(pStore == NULL) return;//{ tResult = FAIL; goto go_result; }

	sSid = GetShort(pBuf, index);

	if(sSid < 0 || sSid >= g_arEBodyTable.GetSize()) return;

	for(int i = 0; i < pStore->m_arItems.GetSize(); i++)
	{
		if(pStore->m_arItems[i] == sSid) { bSell = TRUE; break; }
	}

	if(!bSell) return;

	tNeedClass = g_arEBodyTable[sSid]->m_tClass;
	tMyClass = m_byClass;

	tFire	 = tTemp & tNeedClass; tTemp = 2; 
	tEdge	 = tTemp & tNeedClass; tTemp = 4;
	tStaff	 = tTemp & tNeedClass; tTemp = 8;
	tBrawl	 = tTemp & tNeedClass;

	tFire = tFire & tMyClass;
	tEdge = tEdge & tMyClass;
	tStaff = tStaff & tMyClass;
	tBrawl = tBrawl & tMyClass;

	tTemp = tFire^tEdge^tStaff^tBrawl;
	if(!tTemp) return;

	if(m_dwXP < g_arEBodyTable[sSid]->m_iXP) return;

	if(m_dwDN < g_arEBodyTable[sSid]->m_iDN) return;

	if(m_sSTR + g_arEBodyTable[sSid]->m_sAddBasic[0] < m_sTempSTR) return;
	if(m_sCON + g_arEBodyTable[sSid]->m_sAddBasic[1] < m_sTempCON) return;
	if(m_sDEX + g_arEBodyTable[sSid]->m_sAddBasic[2] < m_sTempDEX) return;
	if(m_sVOL + g_arEBodyTable[sSid]->m_sAddBasic[3] < m_sTempVOL) return;
	if(m_sWIS + g_arEBodyTable[sSid]->m_sAddBasic[4] < m_sTempWIS) return;

	if(g_arEBodyTable[sSid]->m_sAddBasic[0] != 0)
	{
		m_sSTR = m_sSTR + g_arEBodyTable[sSid]->m_sAddBasic[0];
	}

	if(g_arEBodyTable[sSid]->m_sAddBasic[1] != 0)
	{
		m_sCON = m_sCON + g_arEBodyTable[sSid]->m_sAddBasic[1];
	}

	if(g_arEBodyTable[sSid]->m_sAddBasic[2] != 0)
	{
		m_sDEX = m_sDEX + g_arEBodyTable[sSid]->m_sAddBasic[2];
	}

	if(g_arEBodyTable[sSid]->m_sAddBasic[3] != 0)
	{
		m_sVOL = m_sVOL + g_arEBodyTable[sSid]->m_sAddBasic[3];
	}

	if(g_arEBodyTable[sSid]->m_sAddBasic[4] != 0)
	{
		m_sWIS = m_sWIS + g_arEBodyTable[sSid]->m_sAddBasic[4];
	}

	SetUserToMagicUser();
	SendUserStatusSkill();

	TempBuf.Add(EBODY_BUY_RESULT);
	TempBuf.Add((BYTE)0x01);
	TempBuf.Add(sSid);

	Send(TempBuf, TempBuf.GetLength());
*/
}


////////////////////////////////////////////////////////////////////////////////
//	ÇöÀç Á¢¼ÓÁßÀÎ ±æµå¿ø Á¤º¸¸¦ º¸³½´Ù.
//
void USER::GuildUserInfoReq(TCHAR *pBuf)
{
	int i;
	int nCount = 0; 
	int nLength = 0;
	USER *pUser = NULL;
	CGuild *pGuild = NULL;
//	CGuildUser *pGuildUser = NULL;

	TCHAR GuildMaster[CHAR_NAME_LENGTH + 1];						// ±æ¸¶ ÀÌ¸§

	CBufferEx TempBuf, TempBufData; 
//	CWordArray	arLevel;

	if(m_dwGuild <= 0) return;										// ±æµå¹øÈ£°¡ ¾øÀ¸¸é ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	
	pGuild = GetGuild(m_dwGuild);

	if(!pGuild)														// ÇØ´ç ±æµå°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = -1;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

	nCount = -1;
	nCount = pGuild->GetUser(m_strUserID);
	if(nCount < 0)													// ±æµå¿øÀÌ ¾Æ´Ï¸é	
	{
		m_dwGuild = -1;												// ÀÏ´Ü ±æµå ÀÎµ¦½º¸¦ ÃÊ±âÈ­
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
/*
	nCount = pGuild->m_arUser.GetSize();

	if(nCount <= 0 || nCount > MAX_GUILD_USER)						// ±æµåÀÎ¿ø¼ö°¡ ÃÖ´ëÄ¡¸¦ ³Ñ¾ú´Ù.
	{
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
*/
	nLength = strlen(pGuild->m_strMasterName);
	::ZeroMemory(GuildMaster, sizeof(GuildMaster));
	if(nLength > 0 && nLength <= CHAR_NAME_LENGTH) strncpy(GuildMaster, pGuild->m_strMasterName, nLength);
	else															// ÇØ´ç ±æµå¿¡ ±æ¸¶°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = -1;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

	ReleaseGuild();													// ÇØÁ¦...

	nCount = 0;
	for(i = 0; i< MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;

		if(m_dwGuild == pUser->m_dwGuild)
		{
			TempBufData.AddString(pUser->m_strUserID);
			TempBufData.Add(pUser->m_sLevel);
			nCount++;
		}
	}

	TempBuf.Add(GUILD_USER_INFO_RESULT);
	//TempBuf.Add((BYTE)0x00);										// ÀÏ¹Ý ±æµå À¯Àú°¡ ¿ä±¸
	TempBuf.Add(m_nGuildUserInfoType);								//yskang 0.2
	TempBuf.AddString(GuildMaster);									// ±æµå ¸¶½ºÅÍ ÀÌ¸§À» ¸ÕÀú
	TempBuf.Add((BYTE)nCount);										// ÇöÀç ±æµå¿ø À¯Àú¼ö
	TempBuf.AddData(TempBufData, TempBufData.GetLength());
	m_nGuildUserInfoType = 0x00;
	Send(TempBuf, TempBuf.GetLength());
}

//	±æµåÂ¯ÀÌ ÀüÃ¼ ±æµå¿ø Á¤º¸¸¦ ¿ä±¸.
//
//=======================================================================================¾üÍÅÕÙ»½
void USER::GuildUserInfoReqzh()
{
	int i;
	int nCount = 0; 
	int nLength = 0;
	USER *pUser = NULL;
	CGuild *pGuild = NULL;
//	CGuildUser *pGuildUser = NULL;

	TCHAR GuildMaster[CHAR_NAME_LENGTH + 1];						// ±æ¸¶ ÀÌ¸§

	CBufferEx TempBuf, TempBufData; 
//	CWordArray	arLevel;

	if(m_dwGuild <= 0) return;										// ±æµå¹øÈ£°¡ ¾øÀ¸¸é ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	if ( m_curz == 416)
	{
		SendEventMsg("´ËµØÖ·²»ÔÊÐíÊ¹ÓÃÕÙ»½!");
		return;
	}
	
	pGuild = GetGuild(m_dwGuild);

	if(!pGuild)														// ÇØ´ç ±æµå°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = -1;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

	nCount = -1;
	nCount = pGuild->GetUser(m_strUserID);
	if(nCount < 0)													// ±æµå¿øÀÌ ¾Æ´Ï¸é	
	{
		m_dwGuild = -1;												// ÀÏ´Ü ±æµå ÀÎµ¦½º¸¦ ÃÊ±âÈ­
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
/*
	nCount = pGuild->m_arUser.GetSize();

	if(nCount <= 0 || nCount > MAX_GUILD_USER)						// ±æµåÀÎ¿ø¼ö°¡ ÃÖ´ëÄ¡¸¦ ³Ñ¾ú´Ù.
	{
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
*/
	nLength = strlen(pGuild->m_strMasterName);
	::ZeroMemory(GuildMaster, sizeof(GuildMaster));
	if(nLength > 0 && nLength <= CHAR_NAME_LENGTH) strncpy(GuildMaster, pGuild->m_strMasterName, nLength);
	else															// ÇØ´ç ±æµå¿¡ ±æ¸¶°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = -1;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

	ReleaseGuild();													// ÇØÁ¦...

	nCount = 0;
	for(i = 0; i< MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED|| pUser->m_bPShopOpen == TRUE || pUser->m_bNowTrading == TRUE  || pUser->m_bSessionOnline == TRUE || pUser->m_TuoJi==1 ) continue;

		if(m_dwGuild == pUser->m_dwGuild)
		{
			TempBufData.AddString(pUser->m_strUserID);
			TempBufData.Add(pUser->m_sLevel);
			nCount++;
		}
	}

	TempBuf.Add(GUILD_USER_INFO_RESULT);
	//TempBuf.Add((BYTE)0x00);										// ÀÏ¹Ý ±æµå À¯Àú°¡ ¿ä±¸
	TempBuf.Add(m_nGuildUserInfoType);								//yskang 0.2
	TempBuf.AddString(GuildMaster);									// ±æµå ¸¶½ºÅÍ ÀÌ¸§À» ¸ÕÀú
	TempBuf.Add((BYTE)nCount);										// ÇöÀç ±æµå¿ø À¯Àú¼ö
	TempBuf.AddData(TempBufData, TempBufData.GetLength());
	m_nGuildUserInfoType = 0x00;
	Send(TempBuf, TempBuf.GetLength());
}
void USER::GuildUserAllInforChat()
{
	int i;
	int nCount = 0; 
	int nLength = 0;
	USER *pUser = NULL;
	CGuild *pGuild = NULL;
//	CGuildUser *pGuildUser = NULL;

	CBufferEx TempBuf, TempBufData; 
//	CWordArray	arLevel;

	if(m_dwGuild <= 0) return;										// ±æµå¹øÈ£°¡ ¾øÀ¸¸é ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	if(!m_bGuildMaster) return;										// ±æµå¹øÈ£°¡ ¾øÀ¸¸é ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	
	pGuild = GetGuild(m_dwGuild);

	if(!pGuild)														// ÇØ´ç ±æµå°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = 0;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
/*	
	nCount = pGuild->m_arUser.GetSize();

	if(nCount <= 0 || nCount > MAX_GUILD_USER)						// ±æµåÀÎ¿ø¼ö°¡ ÃÖ´ëÄ¡¸¦ ³Ñ¾ú´Ù.
	{
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
*/
	for(i = 0; i < MAX_GUILD_USER; i++)
	{
		if(pGuild->m_arUser[i].m_lUsed != 0)
		{
			TempBufData.AddString(pGuild->m_arUser[i].m_strUserId);
			TempBufData.Add((short)0x00);
			nCount++;
		}
	}

	ReleaseGuild();	// ÇØÁ¦...
/*
	nCount = 0;
	for(i = 0; i< MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;

		if(m_dwGuild == pUser->m_dwGuild)
		{
			TempBufData.AddString(pUser->m_strUserID);
			TempBufData.Add(pUser->m_sLevel);
			nCount++;
		}
	}
*/
	TempBuf.Add(GUILD_USER_INFO_RESULT);
	TempBuf.Add((BYTE)0x00);										// ÀÏ¹Ý ±æµå À¯Àú°¡ ¿ä±¸
	TempBuf.AddString(m_strUserID);									// ±æµå ¸¶½ºÅÍ ÀÌ¸§À» ¸ÕÀú
	TempBuf.Add((BYTE)nCount);										// ÇöÀç ±æµå¿ø À¯Àú¼ö
	TempBuf.AddData(TempBufData, TempBufData.GetLength());
	
	Send(TempBuf, TempBuf.GetLength());
}
/*
////////////////////////////////////////////////////////////////////////////////
//	±æµåÂ¯ÀÌ ÀüÃ¼ ±æµå¿ø Á¤º¸¸¦ ¿ä±¸.
//
void USER::GuildUserAllInforChat()
{
	int i;
	int nCount = 0; 
	int nLength = 0;
	USER *pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildUser *pGuildUser = NULL;

	CBufferEx TempBuf, TempBufData; 
	CWordArray	arLevel;

	if(m_dwGuild <= 0) return;										// ±æµå¹øÈ£°¡ ¾øÀ¸¸é ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	if(!m_bGuildMaster) return;										// ±æµå¹øÈ£°¡ ¾øÀ¸¸é ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	
	pGuild = GetGuild(m_dwGuild);

	if(!pGuild)														// ÇØ´ç ±æµå°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = 0;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
	
	nCount = pGuild->m_arUser.GetSize();

	if(nCount <= 0 || nCount > MAX_GUILD_USER)						// ±æµåÀÎ¿ø¼ö°¡ ÃÖ´ëÄ¡¸¦ ³Ñ¾ú´Ù.
	{
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

	ReleaseGuild();	// ÇØÁ¦...

	nCount = 0;

	for(i = 0; i< MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;

		if(m_dwGuild == pUser->m_dwGuild)
		{
			TempBufData.AddString(pUser->m_strUserID);
			TempBufData.Add(pUser->m_sLevel);
			nCount++;
		}
	}

	TempBuf.Add(GUILD_USER_INFO_RESULT);
	TempBuf.Add((BYTE)0x00);										// ÀÏ¹Ý ±æµå À¯Àú°¡ ¿ä±¸
	TempBuf.AddString(m_strUserID);									// ±æµå ¸¶½ºÅÍ ÀÌ¸§À» ¸ÕÀú
	TempBuf.Add((BYTE)nCount);										// ÇöÀç ±æµå¿ø À¯Àú¼ö
	TempBuf.AddData(TempBufData, TempBufData.GetLength());
	
	Send(TempBuf, TempBuf.GetLength());
}
*/
////////////////////////////////////////////////////////////////////////////////
//	±æµå ÇÏ¿ì½ººÐ¾ç¿¡ Âü°¡ÇÏ±âÀ§ÇØ ÇöÀç °°Àº Á¸ÀÇ ±æµå¿ø Á¤º¸¸¦ º¸³½´Ù.
//
void USER::SendGuildUserInfo(int zone)
{
	int i, index = -1;
	int nCount = 0; 
	int nLength = 0;

	BOOL bSame = FALSE;

	USER *pUser = NULL;
	CGuild *pGuild = NULL;
//	CGuildUser *pGuildUser = NULL;
	CGuildUser *pGuildUser = NULL;
	CGuildFortress *pFort = NULL;

	TCHAR GuildMaster[CHAR_NAME_LENGTH + 1];						// ±æ¸¶ ÀÌ¸§

	CBufferEx TempBuf, TempBufData; 
//	CDWordArray	arUid;
	
//	arUid.RemoveAll();

	if(m_dwGuild <= 0) return;										// ±æµå¹øÈ£°¡ ¾øÀ¸¸é ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	if(!m_bGuildMaster) return;										// ¿À·ÎÁö ±æ¸¶¸¸ÀÌ ½ÅÃ»ÇÒ¼ö ÀÖ´Ù.	

	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		if(!g_arGuildFortress[i]) continue;

		pFort = g_arGuildFortress[i];

		if(pFort->m_iGuildSid == m_dwGuild) 
		{
			SendSystemMsg( IDS_USER_CANT_APPLY_HAVE_FORTRESS, SYSTEM_NORMAL, TO_ME);
			return;
		}
	}

	i = GetCityNumForVirtualRoom(zone);
	if(i < 0 || i >= g_arGuildHouseWar.GetSize()) return;

	if(g_arGuildHouseWar[i]->m_CurrentGuild.lUsed == 1) 
	{		
		SendSystemMsg( IDS_USER_ALREADY_OTHER_GUILD_USE, SYSTEM_ERROR, TO_ME);
		return;
	}

	for(i = 0; i < g_arGuildHouseWar.GetSize(); i++)
	{
		if(g_arGuildHouseWar[i]->m_CurrentGuild.iWarZone == m_curz) { bSame = TRUE; break; }
	}

	if(bSame) return;

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild)														// ÇØ´ç ±æµå°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = -1;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

	index = pGuild->GetUser(m_strUserID);

	if(index < 0)														// ±æµå¿øÀÌ ¾Æ´Ï¸é	
	{
		m_dwGuild = -1;												// ÀÏ´Ü ±æµå ÀÎµ¦½º¸¦ ÃÊ±âÈ­
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

/*	nCount = pGuild->m_arUser.GetSize();

	if(nCount <= 0 || nCount > MAX_GUILD_USER)						
	{
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}
*/
	nLength = strlen(pGuild->m_strMasterName);
	::ZeroMemory(GuildMaster, sizeof(GuildMaster));
	if(nLength > 0 && nLength <= CHAR_NAME_LENGTH) strncpy(GuildMaster, pGuild->m_strMasterName, nLength);
	else															// ÇØ´ç ±æµå¿¡ ±æ¸¶°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.	
	{
		m_dwGuild = -1;
		ReleaseGuild();												// ÇØÁ¦...
		return;
	}

	ReleaseGuild();													// ÇØÁ¦...

	nCount = 0;
	for(i = 0; i< MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;

		if(m_dwGuild == pUser->m_dwGuild)
		{
			TempBufData.AddString(pUser->m_strUserID);
			TempBufData.Add(pUser->m_sLevel);
			TempBufData.Add(pUser->m_uid + USER_BAND);
			nCount++;
		}
	}

	TempBuf.Add(GUILD_USER_INFO_RESULT);
	TempBuf.Add((BYTE)0x01);										// ÀÏ¹Ý ±æµå À¯Àú°¡ ¿ä±¸
	TempBuf.AddString(m_strUserID);									// ±æµå ¸¶½ºÅÍ ÀÌ¸§À» ¸ÕÀú
	TempBuf.Add((BYTE)nCount);										// ÇöÀç ±æµå¿ø À¯Àú¼ö
	TempBuf.AddData(TempBufData, TempBufData.GetLength());
	TempBuf.Add((short)zone);
	
	Send(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////////////
// ÀºÇàÁ¤º¸¸¦ ¸Þ¸ð¸® DB¿¡ ÀúÀåÇÑ´Ù (ÇöÀç´Â LoadUserBank¿¡¼­¸¸ ºÎ¸¥´Ù.)
//
void USER::SetMemUserBank(LPCTSTR strItem)
{
	if(m_pSharedMemory->m_hMapping == NULL) return;
	if(m_pMD == NULL) return;
	if(m_pMD->m_uid == -1) return;

	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return;

	m_pMD->m_UB.m_uid = m_uid;
	strcpy(m_pMD->m_UB.m_strUserID, m_strUserID);
	//strncpy(m_pMD->m_UB.m_UserBankItem, strItem, _BANK_DB);
	memcpy(m_pMD->m_UB.m_UserBankItem, strItem, _BANK_DB);
	m_pMD->m_UB.m_dwBankDN = m_dwBankDN;
}

void USER::SetMemAccountBank(LPCTSTR strItem)
{
	if(m_pSharedMemory->m_hMapping == NULL) return;
	if(m_pMD == NULL) return;
	if(m_pMD->m_uid == -1) return;

	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return;

	m_pMD->m_AB.m_uid = m_uid;
	strcpy(m_pMD->m_AB.m_strAccount, m_strAccount);
	memcpy(m_pMD->m_AB.m_AccountBankItem, strItem, _ACCOUNT_BANK_DB);
	m_pMD->m_AB.m_dwBankDN = m_dwAccountBankDN;
}

////////////////////////////////////////////////////////////////////////////////////////
//	¸Þ¸ð¸®µðºñ¿¡ À¯ÀúÀºÇàÁ¤º¸°¡ ÀÖÀ¸¸é °¡Á®¿Â´Ù.
//
BOOL USER::LoadMemUserBank()
{
	if(m_pSharedMemory->m_hMapping == NULL) return FALSE;
	if(m_pMD == NULL) return FALSE;
	if(m_pMD->m_uid == -1) return FALSE;
	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return FALSE;
	if(m_pMD->m_UB.m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_UB.m_strUserID) != 0) return FALSE;

	StrToUserBankItem((LPTSTR)m_pMD->m_UB.m_UserBankItem);
	m_dwBankDN = m_pMD->m_UB.m_dwBankDN;

	return TRUE;
}

BOOL USER::LoadMemAccountBank()
{
	if(m_pSharedMemory->m_hMapping == NULL) return FALSE;
	if(m_pMD == NULL) return FALSE;
	if(m_pMD->m_uid == -1) return FALSE;
	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return FALSE;

	if(m_pMD->m_AB.m_uid != m_uid || _stricmp(m_strAccount, m_pMD->m_AB.m_strAccount) != 0) return FALSE;

	StrToAccountBankItem((LPTSTR)m_pMD->m_AB.m_AccountBankItem);
	m_dwAccountBankDN = m_pMD->m_AB.m_dwBankDN;

	return TRUE;
}

BOOL USER::UpdateMemBankDataOnly()
{
	if(m_pSharedMemory->m_hMapping == NULL) return FALSE;
	if(m_pMD == NULL) return FALSE;
	if(m_pMD->m_uid == -1) return FALSE;
	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return FALSE;
	if(m_pMD->m_UB.m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_UB.m_strUserID) != 0) return FALSE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strBankItem[_BANK_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strBankItem, sizeof(strBankItem));
	
	::CopyMemory(strBankItem, m_pMD->m_UB.m_UserBankItem, _BANK_DB);
	
	SDWORD sBankItemLen	= sizeof(strBankItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_BANK_DATA_ONLY (\'%s\',%d, ?)}"), m_strUserID, m_pMD->m_UB.m_dwBankDN);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Mem User Bank Data Only!!\n");

		//g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter(hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strBankItem), 0, (TCHAR*)strBankItem, 0, &sBankItemLen);

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

			g_DB[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	m_pMD->m_UB.m_uid = -1;

	return TRUE;
}

BOOL USER::UpdateMemAccountBankDataOnly()
{
	if(m_pSharedMemory->m_hMapping == NULL) return FALSE;
	if(m_pMD == NULL) return FALSE;
	if(m_pMD->m_uid == -1) return FALSE;
	if(m_pMD->m_uid != m_uid || _stricmp(m_strUserID, m_pMD->m_strUserID) != 0) return FALSE;

	if(m_pMD->m_AB.m_uid != m_uid || _stricmp(m_strAccount, m_pMD->m_AB.m_strAccount) != 0) return FALSE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strBankItem[_ACCOUNT_BANK_DB];
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strBankItem, sizeof(strBankItem));
	
	::CopyMemory(strBankItem, m_pMD->m_AB.m_AccountBankItem, _ACCOUNT_BANK_DB);
	
	SDWORD sBankItemLen	= sizeof(strBankItem);
	
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_ACCOUNT_BANK_DATA_ONLY (\'%s\',%d, ?)}")/*, m_pMD->m_iMyServer*/, m_pMD->m_strAccount, m_pMD->m_AB.m_dwBankDN);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );

	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Mem User Bank Data Only!!\n");

		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter(hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strBankItem), 0, (TCHAR*)strBankItem, 0, &sBankItemLen);

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

			g_DB[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	m_pMD->m_AB.m_uid = -1;

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////////////
//	±æµå¿ø³¢¸® Ã¤ÆÃ
//
void USER::GuildChat(TCHAR *pBuf)
{
	int i;

	USER *pUser = NULL;

	CBufferEx TempBuf;

	if(m_dwGuild <= 0) return;

	// alisia
	g_pMainDlg->BridgeServerUserGuildChatReq( m_uid, (int)m_dwGuild, m_strUserID, pBuf+1 );
	return;
	//

	TempBuf.Add(CHAT_RESULT);
	TempBuf.Add(SUCCESS);
	TempBuf.Add(GUILD_CHAT);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.AddString(m_strUserID);
	TempBuf.AddString(pBuf + 1);

	for(i = 0; i< MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;

		if(m_dwGuild == pUser->m_dwGuild) pUser->Send(TempBuf, TempBuf.GetLength());
	}
}


void USER::SendStoreTax(int nStore)
{
	CBufferEx TempBuf;

	int nLen = 0;
	short sTax = 0;

	CStore* pStore = NULL;
	CGuildFortress* pFort = NULL;

	if(!m_bGuildMaster) 
	{
		SendSystemMsg( IDS_USER_ONLY_USE_GUILD_MASTER, SYSTEM_ERROR, TO_ME);
		return;
	}

	if(nStore >= FORTRESS_BAND)						// ¿ä»õ¿¡ ¼ÓÇÑ »óÁ¡ÀÌ¸é...
	{
		pFort = GetFortress(nStore);
		if(pFort == NULL) return;

		if(pFort->m_iGuildSid != m_dwGuild) return;

		SYSTEMTIME st;
		SYSTEMTIME guildTime;

		GetLocalTime(&guildTime);
		st = pFort->m_wLastWarTime;
		COleDateTime LastTime(st.wYear, st.wMonth, st.wDay, st.wHour, 0, 0);
		COleDateTime CurrTime = COleDateTime(guildTime);

		if(CurrTime.m_status == COleDateTime::valid && LastTime.m_status == COleDateTime::valid)
		{
/*			CTime curr(CurrTime.GetYear(), CurrTime.GetMonth(), CurrTime.GetDay(), CurrTime.GetHour(), 0, 0);
			CTime last(LastTime.GetYear(), LastTime.GetMonth(), LastTime.GetDay(), LastTime.GetHour(), 0, 0);
			CTimeSpan DiffTime = curr - last;	
			
			int nTime = DiffTime.GetHours();
		
			if(nTime < UPDATE_GUILD_INVEN_TIME)
			{
				SendSystemMsg( IDS_USER_TEXT_CONTROL, SYSTEM_ERROR, TO_ME);
				return;
			}
*/
			sTax = pFort->m_tTaxRate;
		}
	}
	else
	{
		pStore = GetStore(nStore);
		if(pStore == NULL) return;

		sTax = pStore->m_sRate;
	}

	TempBuf.Add(GUILD_TAX_OPEN);
	TempBuf.Add((short)nStore);
	TempBuf.Add((short)sTax);
	Send(TempBuf, TempBuf.GetLength());
}

void USER::SendGuildWarScheme(int nStore)
{
	int nChatNum = -1;

	CBufferEx TempBuf;

	CStore* pStore = NULL;
	CGuildFortress* pFort = NULL;	

	if(nStore >= FORTRESS_BAND)						// ¿ä»õ¿¡ ¼ÓÇÑ »óÁ¡ÀÌ¸é...
	{
		pFort = GetFortress(nStore);
		if(pFort == NULL) return;
		
		if(pFort->m_tWarType == GUILD_WAR_DECISION)
		{
			if(pFort->m_sFortressID == 1000) nChatNum = 144;
			else if(pFort->m_sFortressID == 1001) nChatNum = 164;
			else if(pFort->m_sFortressID == 1002) nChatNum = 317;

			EditHyperFortressText(pFort, nChatNum);
			return;
		}		
	}
	else
	{
		pStore = GetStore(nStore);
		if(pStore == NULL) return;

		if(pStore->m_tWarType == GUILD_WAR_DECISION) 
		{
			if(pStore->m_sStoreID == 4) nChatNum = 34;		// ÀÌ¹Ì ÀÏÁ¤ÀÌ ÀâÇô ÀÖÀ¸¸é client¿¡ º¸³»Áö¾Ê´Â´Ù.
			else if(pStore->m_sStoreID == 5) nChatNum = 44;
			else if(pStore->m_sStoreID == 6) nChatNum = 54;

			EditHyperText(pStore, nChatNum);
			return;
		}
	}

	if(!m_bGuildMaster)
	{
		SendSystemMsg( IDS_USER_ONLY_USE_GUILD_MASTER, SYSTEM_ERROR, TO_ME);
		return;
	}

	SYSTEMTIME temp;
	GetLocalTime(&temp);

	TempBuf.Add(GUILD_WAR_OPEN);
	TempBuf.Add((short)nStore);

	TempBuf.Add((short)temp.wYear);
	TempBuf.Add((BYTE)temp.wMonth);
	TempBuf.Add((BYTE)temp.wDay);

	Send(TempBuf, TempBuf.GetLength());
}

////////////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç ±æ¸¶°¡ »óÁ¡ÀÇ ¼¼±ÝÀ» Á¶Á¤ÇÑ´Ù.
//
void USER::GetStoreTax(TCHAR *pBuf)
{
	int index = 0;
	CStore* pStore = NULL;

	short nStore = GetShort(pBuf, index);
	short nTax = GetShort(pBuf, index);

	if(nTax < 0 || nTax > GUILD_MAX_TAX) return;		// ÃÖ´ë 200 % ±îÁö

	SetGuildStoreTex(nStore, nTax);
}

////////////////////////////////////////////////////////////////////////////////////////
//	µ÷ÕûË°ÂÊ
void USER::SetGuildStoreTex(int iSid, int iRate)
{
	int nChatNum = -1;

	CBufferEx TempBuf;

	CStore* pStore = NULL;
	CGuildFortress* pFort = NULL;

	if(m_dwGuild <= 0 || !m_bGuildMaster)
	{
		SendSystemMsg( IDS_USER_ONLY_USE_GUILD_MASTER, SYSTEM_ERROR, TO_ME);//"Ö»ÓÐ¾üÍÅ³¤²ÅÄÜÊ¹ÓÃ."
		return;
	}

	if(iSid >= FORTRESS_BAND)						// ¿ä»õ¿¡ ¼ÓÇÑ »óÁ¡ÀÌ¸é...
	{
		pFort = GetFortress(iSid);
		if(pFort == NULL) return;

		if(pFort->m_lUsed == 1)
		{
			SendSystemMsg( IDS_USER_CANT_USE_IN_DEFENCE, SYSTEM_ERROR, TO_ME);//"±£ÎÀÕ½½øÐÐÖÐÎÞ·¨Ê¹ÓÃ."
			return;
		}
        if(pFort->m_iGuildSid == m_dwGuild)
		{
			if(iRate > GUILD_MAX_TAX)  //Ìí¼ÓË°ÊÕ
			{
				SendSystemMsg( IDS_USER_TEX_MAX, SYSTEM_ERROR, TO_ME);
				return;
			}
			pFort->m_tTaxRate = iRate;
			pFort->ApplyTaxToStore();				// °¢ »óÁ¡¿¡ ¼¼±ÝÀ» ¼ÂÆÃ.
			UpdateMemStoreTax(iSid, iRate);

			UpdateTaxToDB(pFort,iRate);
			CString str;
			str.Format("ÒªÈû³ÇÖ÷[ %s ]½«Ë°ÂÊµ÷ÕûÎª%d%%",m_strUserID,iRate);//·¢ËÍË°ÂÊµ÷ÕûÏûÏ¢
			SendSystemMsg(str.GetBuffer(0), SYSTEM_ANNOUNCE, TO_ALL);
			return;
		}
	}
/*	else
	{
		pStore = GetStore(iSid);
		if(pStore == NULL) return;

		if(pStore->m_sStoreID == (short)iSid)
		{
			pStore->m_sRate = iRate;

			UpdateMemStoreTax(iSid, iRate);
			return;
		}
	}
*/
}

////////////Î²°Í

void USER::GetGuildWarScheme(TCHAR *pBuf)
{
	int index = 0;

	short nStore = GetShort(pBuf, index);

	if(nStore < 0) return;

	if(nStore >= FORTRESS_BAND)
	{
		SetFortressGuildWarScheme(pBuf + index, nStore);
	}
/*	else 
	{
		SetStoreGuildWarScheme(pBuf + index, nStore);
	}
*/
}

////////////////////////////////////////////////////////////////////////////////////////
//	ÇÊµå »óÁ¡ÀÇ ÀüÀï ³¯Â¥¸¦ °áÁ¤ÇÑ´Ù.
//
void USER::SetStoreGuildWarScheme(TCHAR *pBuf, int nStore)
{
	int index = 0;
	int nCount = 0;
	CStore* pStore = NULL;

	int iMon[] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};

	short sYear = GetShort(pBuf, index);
	BYTE tMon = GetByte(pBuf, index);
	BYTE tDay = GetByte(pBuf, index);
	BYTE tTime = GetByte(pBuf, index);

	if(sYear >= 2500) 
	{
		SendSystemMsg( IDS_USER_INVALID_YEAR, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tMon >= 13)
	{
		SendSystemMsg( IDS_USER_INVALID_MONTH, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tDay >= 32)
	{
		SendSystemMsg( IDS_USER_INVALID_DAY, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tTime < 20 && tTime > 23)
	{
		SendSystemMsg( IDS_USER_INVALID_HOUR, SYSTEM_ERROR, TO_ME);
		return;
	}

	pStore = GetStore(nStore);
	if(pStore == NULL) return;

	if(pStore->m_tWarType == GUILD_WAR_DECISION)
	{
		SendSystemMsg( IDS_USER_ALREADY_EXIST_SCHEDULE, SYSTEM_ERROR, TO_ME);
		return;// ÀÌ¹Ì ±æµåÀü ÀÏÁ¤ÀÌ ÀâÇô ÀÖÀ¸¸é ¸ø¹Ù²Û´Ù.
	}

	int totalDay = DayCalculation((int)sYear, (int)tMon, (int)tDay); 
	int defDay = DayCalculation(pStore->m_wLastWarTime.wYear, pStore->m_wLastWarTime.wMonth, pStore->m_wLastWarTime.wDay); 

	nCount = abs(totalDay - defDay);
	if(nCount > 3)
	{
		SendSystemMsg( IDS_USER_GUILD_WAR_DELAY, SYSTEM_ERROR, TO_ME);
		return;
	}

	SYSTEMTIME temp;
	GetLocalTime(&temp);

	if(tMon == temp.wMonth && tDay <= temp.wDay)
	{
		SendSystemMsg( IDS_USER_PASS_MIN_DAY, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tDay == temp.wDay && tTime < temp.wHour) 
	{
		SendSystemMsg( IDS_USER_INVALID_TIME, SYSTEM_ERROR, TO_ME);
		return;
	}

	CTime CurrTime = CTime::GetCurrentTime();

	CTime LastTime(pStore->m_wLastWarTime);
	CTimeSpan DiffTime = CurrTime - LastTime;
	if(DiffTime.GetTotalHours() >= 12)
	{
		SendSystemMsg( IDS_USER_SCHEDULE_FIX, SYSTEM_ERROR, TO_ME);
		return;
	}
	
	CString strMsg;
	pStore->m_wPlanWarTime.wYear = sYear;
	pStore->m_wPlanWarTime.wMonth = tMon;
	pStore->m_wPlanWarTime.wDay = tDay;
	pStore->m_wPlanWarTime.wHour = tTime;

	if(!UpdateGuildStoreWarTime(pStore)) 
	{
		SendSystemMsg( IDS_USER_EDIT_SCHEDULE_FAIL, SYSTEM_ERROR, TO_ME);
		return;
	}

	pStore->m_tWarType = GUILD_WAR_DECISION;

	strMsg.Format( IDS_USER_SCHEDULE_FIXED, sYear, tMon, tDay, tTime); 
	SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

	UpdateMemStoreWarType(pStore);
}

////////////////////////////////////////////////////////////////////////////////////////
//	°ø¼ºÀüÀÇ ÀüÀï ³¯Â¥¸¦ °áÁ¤ÇÑ´Ù.
//
void USER::SetFortressGuildWarScheme(TCHAR *pBuf, int nStore)
{
	int index = 0;
	int nCount = 0;
	CGuildFortress* pFort = NULL;

	int iMon[] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};

	short sYear = GetShort(pBuf, index);
	BYTE tMon = GetByte(pBuf, index);
	BYTE tDay = GetByte(pBuf, index);
	BYTE tTime = GetByte(pBuf, index);

	if(sYear >= 2500) 
	{
		SendSystemMsg( IDS_USER_INVALID_YEAR, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tMon >= 13)
	{
		SendSystemMsg( IDS_USER_INVALID_MONTH, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tDay >= 32)
	{
		SendSystemMsg( IDS_USER_INVALID_DAY, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tTime != 21)
	{
		SendSystemMsg( IDS_USER_INVALID_HOUR, SYSTEM_ERROR, TO_ME);
		return;
	}

	pFort = GetFortress(nStore);
	if(pFort == NULL) return;

	if(pFort->m_lUsed == 1)
	{
		SendSystemMsg( IDS_USER_CANT_USE_IN_DEFENCE, SYSTEM_ERROR, TO_ME);
		return;
	}

	if(pFort->m_tWarType == GUILD_WAR_DECISION)
	{
		SendSystemMsg( IDS_USER_ALREADY_EXIST_SCHEDULE, SYSTEM_ERROR, TO_ME);
		return;// ÀÌ¹Ì ±æµåÀü ÀÏÁ¤ÀÌ ÀâÇô ÀÖÀ¸¸é ¸ø¹Ù²Û´Ù.
	}

	int totalDay = DayCalculation((int)sYear, (int)tMon, (int)tDay); 
	int defDay = DayCalculation(pFort->m_wLastWarTime.wYear, pFort->m_wLastWarTime.wMonth, pFort->m_wLastWarTime.wDay); 

	nCount = abs(totalDay - defDay);
	if(nCount > 7)
	{
		SendSystemMsg( IDS_USER_GUILD_WAR_DELAY1, SYSTEM_ERROR, TO_ME);
		return;
	}

/*	nCount = abs(totalDay - defDay);
	if(nCount > 2)
	{
		SendSystemMsg( IDS_USER_GUILD_WAR_DELAY2, SYSTEM_ERROR, TO_ME);
		return;
	}
*/
	SYSTEMTIME temp;
	GetLocalTime(&temp);

	if(tMon == temp.wMonth && tDay <= temp.wDay)
	{
		SendSystemMsg( IDS_USER_PASS_MIN_DAY, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(tDay == temp.wDay && tTime < temp.wHour) 
	{
		SendSystemMsg( IDS_USER_INVALID_TIME, SYSTEM_ERROR, TO_ME);
		return;
	}

	CTime CurrTime = CTime::GetCurrentTime();

	CTime LastTime(pFort->m_wLastWarTime);
	CTimeSpan DiffTime = CurrTime - LastTime;
	if(DiffTime.GetTotalHours() >= 12)
	{
		SendSystemMsg( IDS_USER_SCHEDULE_FIX, SYSTEM_ERROR, TO_ME);
		return;
	}
	
	CString strMsg;
	pFort->m_wPlanWarTime.wYear = sYear;
	pFort->m_wPlanWarTime.wMonth = tMon;
	pFort->m_wPlanWarTime.wDay = tDay;
	pFort->m_wPlanWarTime.wHour = tTime;

	if(!UpdateGuildFortressWarTime(pFort)) 
	{
		SendSystemMsg( IDS_USER_EDIT_SCHEDULE_FAIL, SYSTEM_ERROR, TO_ME);
		return;
	}

	pFort->m_tWarType = GUILD_WAR_DECISION;

	strMsg.Format( IDS_USER_FORTRESS_SCHEDULE_FIXED, sYear, tMon, tDay, tTime); 
	SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

	UpdateMemFortressWarType(pFort);
}

int USER::DayCalculation(int iYear, int iMon, int iDay)
{
	int iTotalDays = 0;
	int ilastyear = iYear - 1;
	int iMonth[] = {31, 28, 31, 30, 31, 30, 31, 31, 30 , 31, 30, 31};
	if((iYear % 4 == 0 && iYear % 100 != 0) || iYear % 400 == 0){
		iMonth[1] = 29;
	}
	
	iTotalDays = ilastyear * 365 + ilastyear / 4 + ilastyear / 400 - ilastyear / 100;
	for(int i=0;i<iMon - 1;i++)
	{
		iTotalDays += iMonth[i];	
	}

	iTotalDays += iDay;
	return iTotalDays;
}

////////////////////////////////////////////////////////////////////////////////////////
//	±æµåÀüÀÌ ³¡³µ°í ¸ðµç »óÈ²ÀÌ Á¾·áµÇ¾ú´Ù°í ¾Ë¸°´Ù.
//
BOOL USER::StoppingTheGuildWar(CStore *pStore)
{
	if(m_dwGuild <= 0) return FALSE;

	if(pStore == NULL) return FALSE;

	int nLen = CHAR_NAME_LENGTH;

//	USER *pUser = NULL;
	CGuild *pGuild = NULL;
	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) { ReleaseGuild(); return FALSE; }
	
	if(UpdateGuildStore(pStore->m_sStoreID, pGuild->m_strMasterName) == FALSE) { ReleaseGuild(); return FALSE; }
										// »óÁ¡À» ÃÊ±âÈ­ÇÑ´Ù.(¿ï ±æµå·Î...^^)
	::ZeroMemory(pStore->m_strGuildName, CHAR_NAME_LENGTH + 1);
	::ZeroMemory(pStore->m_strMasterName, CHAR_NAME_LENGTH + 1);
	strncpy(pStore->m_strGuildName, m_strGuildName, nLen);
	strncpy(pStore->m_strMasterName, pGuild->m_strMasterName, nLen);

	ReleaseGuild();						// ÇØÁ¦...

	SendGuildMsgForAnnounceGuildWarEnd(pStore);
	pStore->InitStoreInfo(m_dwGuild);

	SetGuildStoreTex(pStore->m_sStoreID, 0);	// Tax Rate Init

	InitMemStore(pStore);

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////////////
//	DB¿¡ ¼ÂÆÃÇÑ´Ù.
//
BOOL USER::UpdateGuildStore(int nSid, TCHAR *strGuildMasterName)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		

	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call INSERT_GUILD_STORE(%d,%d,\'%s\',\'%s\')}"), nSid, m_dwGuild, m_strGuildName, strGuildMasterName);

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild_Store Data Only!!\n");

		//g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DBNew[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

void USER::BeginGuildWar()
{
	m_tGuildWar = GUILD_WARRING;
//	SendSystemMsg( IDS_USER_START_GUILD_WAR, SYSTEM_NORMAL, TO_ME);
}

void USER::EndGuildWar(BYTE tWarType)
{
	CBufferEx TempBuf;

	m_tGuildWar = GUILD_WAR_AFFTER;

	m_FieldWarGMUid = 0;
	m_dwFieldWar = 0;

	TempBuf.Add(GUILD_WAR);
	TempBuf.Add((BYTE)0x02);							// ±æµåÀü Á¾·á...
	TempBuf.Add(tWarType);

	if(tWarType == GUILD_FIELD_WARRING) TempBuf.Add((short)0x00); // ÇÊµåÀüÀÏ¶§´Â 0À¸·Î 

	Send(TempBuf, TempBuf.GetLength());
//	SendSystemMsg( IDS_USER_END_GUILD_WAR, SYSTEM_NORMAL, TO_ME);
}

void USER::BeginFortressWar()
{
	m_tFortressWar = GUILD_WARRING;
}
/*
void USER::EndFortressWar()
{
	CBufferEx TempBuf;

	m_tFortressWar = GUILD_WAR_AFFTER;

	TempBuf.Add(GUILD_WAR);
	TempBuf.Add((BYTE)0x02);							// ±æµåÀü Á¾·á...
	TempBuf.Add((BYTE)GUILD_FOTRESS_WARRING);

	Send(TempBuf, TempBuf.GetLength());
}
*/

//////////////////////////////////////////////////////////////////////////////////////////
//	±æµåÀüÀÌ ³¡³µÀ½À» ¾Ë¸°´Ù.
//
void USER::SendGuildMsgForAnnounceGuildWarEnd(CStore *pStore)
{
	int i, j;
	CString strMsg;
	CBufferEx TempBuf;

	USER* pUser = NULL;

	if(!pStore) return;

	strMsg.Format( IDS_USER_THIS_AREA_GUILD_HAVE, m_strGuildName);

	for(i = 0; i < MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;
		
		if(pStore->m_iGuildSid == pUser->m_dwGuild) pUser->EndGuildWar(GUILD_STORE_WARRING);
		else
		{
			for(j =0; j < GUILD_ATTACK_MAX_NUM; j++)
			{
				if(pStore->m_arAttackGuild[j] == pUser->m_dwGuild)
				{
					pUser->EndGuildWar(GUILD_STORE_WARRING);			// ±æµå ÀüÀÌ ³¡³²
//					pUser->SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_NORMAL, TO_ME);
					break;
				}
			}
		}

		pUser->SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
	}
}

//////////////////////////////////////////////////////////////////////////////////////////
//	°ø¼ºÀüÀÌ ³¡³µÀ½À» ¾Ë¸°´Ù.
//
/*
void USER::SendGuildMsgForAnnounceFortressWarEnd(CGuildFortress *pFort)
{
	int i, j;
	CString strMsg;
	CBufferEx TempBuf;

	USER* pUser = NULL;

	if(!pFort) return;

	strMsg.Format( IDS_USER_THIS_AREA_GUILD_HAVE, m_strGuildName);

	for(i = 0; i < MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;
		
		if(pFort->m_iGuildSid == pUser->m_dwGuild) pUser->EndFortressWar();
		else
		{
			for(j =0; j < GUILDFORTRESS_ATTACK_MAX_NUM; j++)
			{
				if(pFort->m_arAttackGuild[j].lGuild == pUser->m_dwGuild)
				{
					pUser->EndFortressWar();			// ±æµå ÀüÀÌ ³¡³²
					break;
				}
			}
		}

		pUser->SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_NORMAL, TO_ME);
	}
}
*/

//////////////////////////////////////////////////////////////////////////////////////////
//	ÁÖ¹Îµî·Ï¹øÈ£°¡ ÀÏÄ¡ÇÏ´ÂÁö °Ë»ç
//
BOOL USER::CheckJuminNumber(LPCTSTR szAccount, LPCTSTR szJumin)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode;
	TCHAR			szSQL[1024];

	CString			szTemp = szJumin;
	szTemp.Insert(6, '-');

	BOOL bQuerySuccess = TRUE;
	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call GET_JUMIN_NO (\'%s\')}"), szAccount); 
	
	SQLCHAR		strJuminSQL[20];
	SQLINTEGER	strInd = SQL_NTS;

	::ZeroMemory(strJuminSQL, sizeof(strJuminSQL));

	int db_index = 0;
	CDatabase* pDB = g_DBSession[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle((SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt);
	if( retcode != SQL_SUCCESS )
	{
		//g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, SQL_NTS );
	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		retcode = SQLFetch( hstmt );

		if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
		{
			SQLGetData(hstmt, 1, SQL_C_CHAR, strJuminSQL, sizeof(strJuminSQL), &strInd);
		}
	}
	else
	{
		//DisplayErrorMsg(hstmt);
		bQuerySuccess = FALSE;

		if (hstmt!=NULL) SQLFreeHandle((SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		//g_DBSession[m_iModSid].ReleaseDB(db_index);
		TRACE("*** ÁÖ¹Îµî·Ï ¹øÈ£ DB[%d/%d] ¿À·ù... ***\n", m_iModSid, db_index );
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle((SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBSession[m_iModSid].ReleaseDB(db_index);
	
	if(bQuerySuccess && szTemp.Compare((LPTSTR)strJuminSQL) == 0) return TRUE;
	
	return FALSE;
}

/////////////////////////////////////////////////////////////////////////////////////////
//	»óÁ¡¿¡¼­ ÆÇ ¹°°Ç¿¡ ´ëÇÑ ¼¼±ÝÀ» ±æµå Ã¢°í(¸Þ¸ð¸® DB)¿¡ Àû¸³ÇÑ´Ù.
//
void USER::UpdateMemStoreDN(int iStoreID, DWORD dwDN)
{
	/*
	int nSize = g_arStoreSharedMemory.GetSize();
	CSharedMemory* pShared = NULL;
	CMemStore* pData = NULL;

	for(int i = 0; i < nSize; i++)
	{
		pShared = g_arStoreSharedMemory[i];

		if(pShared == NULL) continue;
		if(pShared->m_hMapping == NULL) continue;

		pData = (CMemStore*) pShared->m_lpData;

		if(pData == NULL) continue;
		if(pData->m_sStoreID == -1) continue;
		if(pData->m_iGuildSid <= 0) continue;

		if(iStoreID == pData->m_sStoreID)
		{
			pData->m_dwStoreDN = dwDN;
			return;
		}
	}
	*/
	int nSize, i;
	int iID = 0;

	if(iStoreID >= FORTRESS_BAND)
	{
		nSize = g_arFortressSharedMemory.GetSize();
		CSharedMemory* pShared = NULL;
		CMemFortress* pData = NULL;

		for(i = 0; i < nSize; i++)
		{
			pShared = g_arFortressSharedMemory[i];
			if(pShared == NULL) return;
			if(pShared->m_hMapping == NULL) return;

			pData = (CMemFortress*) pShared->m_lpData;
			
			if(pData == NULL) return;
			if(pData->m_sFortressID < 1000) return;
			if(pData->m_iGuildSid <= 0) return;

			iID = pData->m_sFortressID;
			if(iID == iStoreID)
			{
				pData->m_dwStoreDN = dwDN;
				break;
			}
		}
	}
/*	else
	{
		nSize = g_arStoreSharedMemory.GetSize();
		CSharedMemory* pShared = NULL;
		CMemStore* pData = NULL;

		if(iStoreID >= nSize) return;
		if((int)dwDN < 0) return;

		pShared = g_arStoreSharedMemory[iStoreID];
		
		if(pShared == NULL) return;
		if(pShared->m_hMapping == NULL) return;
		
		pData = (CMemStore*) pShared->m_lpData;
		
		if(pData == NULL) return;
		if(pData->m_sStoreID == -1) return;
		if(pData->m_iGuildSid <= 0) return;
		
		pData->m_dwStoreDN = dwDN;
	}
*/
}

/////////////////////////////////////////////////////////////////////////////////////////
//	ÇÊµå »óÁ¡¿¡ ´ëÇÑ ¸Þ¸ð¸® DBÀÇ ³»¿ëÀ» ÃÊ±âÈ­ ÇÑ´Ù.
//
void USER::InitMemStore(CStore *pStore)
{
/*	if(pStore == NULL) return;

	int nSize = g_arStoreSharedMemory.GetSize();
	CSharedMemory* pShared = NULL;
	CMemStore* pData = NULL;

	if(pStore->m_sStoreID >= nSize) return;

	pShared = g_arStoreSharedMemory[pStore->m_sStoreID];
	
	if(pShared == NULL) return;
	if(pShared->m_hMapping == NULL) return;
	
	pData = (CMemStore*) pShared->m_lpData;
	
	if(pData == NULL) return;
	
	pData->m_sStoreID = pStore->m_sStoreID;
	pData->m_iGuildSid = pStore->m_iGuildSid;
	pData->m_sTaxRate = 0;
	pData->m_dwStoreDN = 0;
	pData->m_tWarType = GUILD_WAR_PREPARE;

	pStore->GuildListToStr(pData->m_AttackList);
*/
}

/////////////////////////////////////////////////////////////////////////////
//	ÇÊµå»óÁ¡¿¡ ´ëÇÑ ¼¼±ÝÀ» ¸Þ¸ð¸® DB¿¡ ¼ÂÆÃÇÑ´Ù.
//
void USER::UpdateMemStoreTax(int iSid, int iRate)
{
	int nSize, i;

	if(iSid >= FORTRESS_BAND)
	{
		nSize = g_arFortressSharedMemory.GetSize();
		CSharedMemory* pShared = NULL;
		CMemFortress* pData = NULL;

		if(iRate < 0 || iRate > GUILD_MAX_TAX) return;		// ÃÖ´ë 200 % ±îÁö
		for(i = 0; i < nSize; i++)
		{
			pData = NULL;
			pShared = NULL;
			pShared = g_arFortressSharedMemory[i];
			
			if(pShared == NULL) continue;
			if(pShared->m_hMapping == NULL) continue;
			
			pData = (CMemFortress*) pShared->m_lpData;
			
			if(pData == NULL) continue;
			if(pData->m_sFortressID != iSid) continue;;
			if(pData->m_iGuildSid != m_dwGuild) continue;
			
			pData->m_sTaxRate = iRate;
			break;
		}
	}
/*	else
	{
		nSize = g_arStoreSharedMemory.GetSize();
		CSharedMemory* pShared = NULL;
		CMemStore* pData = NULL;

		if(iSid >= nSize) return;
		if(iRate < 0 || iRate > GUILD_MAX_TAX) return;		// ÃÖ´ë 200 % ±îÁö

		pShared = g_arStoreSharedMemory[iSid];
		
		if(pShared == NULL) return;
		if(pShared->m_hMapping == NULL) return;
		
		pData = (CMemStore*) pShared->m_lpData;
		
		if(pData == NULL) return;
		if(pData->m_sStoreID == -1) return;
		if(pData->m_iGuildSid <= 0) return;
		
		pData->m_sTaxRate = iRate;
	}
*/
}

////////////////////////////////////////////////////////////////////////////
//	ÇÊµå»óÁ¡¿¡ ´ëÇÑ WarType À» ¸Þ¸ð¸® DB¿¡ ¼ÂÆÃÇÑ´Ù.
//
void USER::UpdateMemStoreWarType(CStore *pStore)
{
/*	if(pStore == NULL) return;

	int nSize = g_arStoreSharedMemory.GetSize();
	CSharedMemory* pShared = NULL;
	CMemStore* pData = NULL;

	if(pStore->m_sStoreID >= nSize) return;

	pShared = g_arStoreSharedMemory[pStore->m_sStoreID];
	
	if(pShared == NULL) return;
	if(pShared->m_hMapping == NULL) return;
	
	pData = (CMemStore*) pShared->m_lpData;
	
	if(pData == NULL) return;
	
	pData->m_tWarType = pStore->m_tWarType;
*/
}

////////////////////////////////////////////////////////////////////////////
//	°ø¼ºÀü¿¡ ´ëÇÑ WarType À» ¸Þ¸ð¸® DB¿¡ ¼ÂÆÃÇÑ´Ù.
//
void USER::UpdateMemFortressWarType(CGuildFortress *pFort)
{
	if(pFort == NULL) return;

	int nSize = g_arFortressSharedMemory.GetSize();
	CSharedMemory* pShared = NULL;
	CMemFortress* pData = NULL;

	for(int i = 0; i < nSize; i++)
	{
		pShared = g_arFortressSharedMemory[i];
		
		if(pShared == NULL) return;
		if(pShared->m_hMapping == NULL) return;
		
		pData = (CMemFortress*) pShared->m_lpData;
		
		if(pData == NULL) return;
		
		if(pData->m_iGuildSid == pFort->m_iGuildSid)
		{
			pData->m_tWarType = pFort->m_tWarType;
			break;
		}
	}
}

void USER::UpdateMemStoreGuildList(CStore *pStore)
{
/*	if(pStore == NULL) return;

	int nSize = g_arStoreSharedMemory.GetSize();
	CSharedMemory* pShared = NULL;
	CMemStore* pData = NULL;

	if(pStore->m_sStoreID >= nSize) return;

	pShared = g_arStoreSharedMemory[pStore->m_sStoreID];
	
	if(pShared == NULL) return;
	if(pShared->m_hMapping == NULL) return;
	
	pData = (CMemStore*) pShared->m_lpData;
	
	if(pData == NULL) return;
	
	pStore->GuildListToStr(pData->m_AttackList);
*/
}

/////////////////////////////////////////////////////////////////////////////
//	ÇöÀç À¯Àú°¡ ¼­ÀÖ´Â ÁÂÇ¥°¡ ¸Ê¿¡¼­ ÀÐÀ»¼ö ÀÖ´Â°÷ÀÎÁö,  ¸Ê»ó¿¡ ÀÐÀº¼Ó¼º°ªÀ» ÂüÁ¶ÇÏ±âÀ§ÇÑ ÀÎµ¦½º¸¦ ³Ñ±ä´Ù. 
//
int USER::CheckInvalidMapType()
{
	int nRet = -1;

	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return nRet;
	if(m_curx >= g_zone[m_ZoneIndex]->m_sizeMap.cx || m_curx < 0) return nRet;
	if(m_cury >= g_zone[m_ZoneIndex]->m_sizeMap.cy || m_cury < 0) return nRet;

	nRet = ((g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_dwType & 0xFF00 ) >> 8);

	return nRet;
}

/////////////////////////////////////////////////////////////////////////////
//	ÇöÀç À¯Àú°¡ ¼­ÀÖ´Â ÁÂÇ¥°¡ ±æµåÀü ÁßÀÎ Áö¿ªÀÌ¸é FALSE°ªÀ» ³Ñ±ä´Ù.
//
BOOL USER::CheckInvalidZoneState(int type)
{
	int index = 0;

//	if(type < 2 || type >= 17) return TRUE;
//	index = g_arMapTable[type]->m_sStoreID;
	int mapindex = GetGuildMapIndex(type);
	if(mapindex <= -1 || mapindex >= g_arMapTable.GetSize()) return TRUE;
    if(g_arMapTable[mapindex] == NULL) return FALSE;
	index = g_arMapTable[mapindex]->m_sStoreID;

	if(index >= FORTRESS_BAND) 
	{
		CGuildFortress* pFort = NULL;
		pFort = GetFortress(index);

		if(pFort) 
		{
			if(pFort->m_lUsed == 1)	return FALSE;
//			if(g_arMapTable[type]->m_sStoreZone) return FALSE;
		}
	}	
/*	else
	{
		CStore *pStore = NULL;

		index = g_arMapTable[mapindex]->m_sStoreIndex;

		pStore = GetStore(index);

		if(pStore)
		{
			if(pStore->m_lUsed == 1) return FALSE;
		}
//		if(index < 0 || index >= g_arStore.GetSize()) return TRUE;
//		if(g_arStore[index]->m_lUsed == 1)	return FALSE;  // ÇØ´ç ¼Ó¼º ¸ÊÀÌ ±æµåÀü »óÅÂ	
	}
*/
	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////
//	Á¸Ã¼ÀÎÁö¸¦ ¿äÃ»ÇÒ¶§ ÇØ´ç Áö¿ªÀÌ ±æÀüÁßÀÌ¸é °ÅºÎÇÑ´Ù.
//
BOOL USER::CheckInvakidZoneChangeState(int type)
{
	int index = 0;

//	if(type < 2 || type >= 17) return TRUE;
	int mapindex = GetGuildMapIndex(type);
	if(mapindex <= -1 || mapindex >= g_arMapTable.GetSize()) return TRUE;
    if(g_arMapTable[mapindex] == NULL) return FALSE;
	index = g_arMapTable[mapindex]->m_sStoreID;

	if(index >= FORTRESS_BAND) 
	{
		CGuildFortress* pFort = NULL;
		pFort = GetFortress(index);

		if(pFort) 
		{
			if(m_dwGuild > 0 && pFort->m_iGuildSid == m_dwGuild) return TRUE;
			if(pFort->m_iZone == m_curz || g_arMapTable[mapindex]->m_sStoreZone) return FALSE;
			if(pFort->m_lUsed == 1)	return FALSE;
		}
	}
/*	else
	{
		CStore *pStore = NULL;

		index = g_arMapTable[mapindex]->m_sStoreIndex;

		pStore = GetStore(index);

		if(pStore)
		{
			if(pStore->m_lUsed == 1) return FALSE;
		}
	}
*/
	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////
//	Å¬¶óÀÌ¾ðÆ®¿¡¼­ ¿äÃ»ÇÒ¶§ ¼­¹ö Æ½À» º¸³»¼­ ½º.ÇÙÀ» ¹æÁöÇÑ´Ù.
//
void USER::SendServerTick()
{
/*	DWORD dwTick;

	CBufferEx TempBuf;

	dwTick = GetTickCount();

	TempBuf.Add(SERVER_TICK_RESULT);
	TempBuf.Add(dwTick);
	Send(TempBuf, TempBuf.GetLength());
*/
}

/////////////////////////////////////////////////////////////////////////////
//	±æµåÀü ½Ã°£À» ¼ÂÆÃÇÑ´Ù.
//
BOOL USER::UpdateGuildStoreWarTime(CStore *pStore)
{
	CString			strTime;
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strWarTime[30];

	if(pStore == NULL) return FALSE;
	if(pStore->m_iGuildSid <= 0) return FALSE;

	strTime = _T("");
	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strWarTime, sizeof(strWarTime));
	
	strTime.Format("%d-%d-%d %d:00:00", pStore->m_wPlanWarTime.wYear, pStore->m_wPlanWarTime.wMonth, pStore->m_wPlanWarTime.wDay, pStore->m_wPlanWarTime.wHour);
	::CopyMemory(strWarTime, strTime.GetBuffer(strTime.GetLength()), strTime.GetLength());
	strTime.ReleaseBuffer();
	
	SDWORD sLen	= sizeof(strWarTime);

	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_GUILD_STORE_WARTIME(%d,%d,\'%s\')}"), pStore->m_sStoreID, pStore->m_iGuildSid, strWarTime);

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild_Store Data Only!!\n");

		//g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DBNew[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////
//	±æµåÀü ½Ã°£À» ¼ÂÆÃÇÑ´Ù.
//
BOOL USER::UpdateGuildFortressWarTime(CGuildFortress *pFort)
{
	CString			strTime;
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		
	TCHAR			strWarTime[30];

	if(pFort == NULL) return FALSE;
	if(pFort->m_iGuildSid <= 0) return FALSE;

	strTime = _T("");
	::ZeroMemory(szSQL, sizeof(szSQL));
	::ZeroMemory(strWarTime, sizeof(strWarTime));
	
	strTime.Format("%d-%d-%d 21:00:00", pFort->m_wPlanWarTime.wYear, pFort->m_wPlanWarTime.wMonth, pFort->m_wPlanWarTime.wDay);
	::CopyMemory(strWarTime, strTime.GetBuffer(strTime.GetLength()), strTime.GetLength());
	strTime.ReleaseBuffer();
	
	SDWORD sLen	= sizeof(strWarTime);

	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_GUILD_FORTRESS_WARTIME(%d,%d,\'%s\')}"), pFort->m_sFortressID, pFort->m_iGuildSid, strWarTime);

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild_Store Data Only!!\n");

		//g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DBNew[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////
//	ÇÊµå ±æµåÀüÀ» Ã¤ÆÃÀ¸·Î ½ÅÃ» ---> »ó´ë¹æ ±æ¸¶¿¡°Ô º¸³½´Ù.
//
void USER::SendGuildWarFieldApply(TCHAR *pBuf)
{
	int index = 0;
	int nLength = 0;

	BYTE error_code = 0;

	CGuild *pGuild = NULL;
	USER *pUser = NULL;

	CBufferEx TempBuf;

	TCHAR szGuildName[255];

	if(m_dwGuild <= 0) { error_code = ERR_10; goto go_result; };			// º»ÀÎÀÌ ±æµå¿øÀÌ ¾Æ´Ï¸é..
	if(!m_bGuildMaster) { error_code = ERR_10; goto go_result; };			// º»ÀÎÀÌ ±æ¸¶°¡ ¾Æ´Ï¸é...

	if(m_tGuildWar == GUILD_WARRING) { error_code = ERR_12; goto go_result; };

	::ZeroMemory(szGuildName, sizeof(szGuildName));

	nLength = GetVarString(sizeof(szGuildName), szGuildName, pBuf, index);
	if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) { error_code = 255; goto go_result; } 

	pGuild = GetGuildByName(szGuildName);

	if(!pGuild) 
	{ 
		ReleaseGuild();
		error_code = ERR_7; 
		goto go_result; 
	} // ÇØ´ç ±æµå°¡ Á¸ÀçÇÏÁö ¾Ê´Â´Ù.
	
	pUser = GetUser(pGuild->m_strMasterName);
	ReleaseGuild();

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)  
	{ 
		error_code = ERR_3;							// ´ë»ó ±æ¸¶°¡ ÇöÀç °ÔÀÓ¿¡ ¾ø´Ù.
		goto go_result; 
	} 

	if(pUser->m_tGuildWar == GUILD_WARRING) { error_code = ERR_12; goto go_result; };
	if(pUser->m_dwGuild <= 0 || !pUser->m_bGuildMaster) { error_code = ERR_3; goto go_result; } // ¼­¹ö ¿¡·¯...

	if(!GetDistance(pUser->m_curx, pUser->m_cury, 12)) 
	{
		SendSystemMsg( IDS_USER_IN_ONE_SCREEN, SYSTEM_NORMAL, TO_ME);
		return;
	}
	
	m_bFieldWarApply = TRUE;
	m_FieldWarGMUid = pUser->m_uid;					// »ó´ë¹æ uid¸¦ ±â¾ï
	m_dwFieldWar = pUser->m_dwGuild;				// ÇÊµåÀü ½ÃÀÛÀÌ¸é »ó´ëÆí ±æµå ¹øÈ£°¡ µé¾î¿Â´Ù.

	pUser->m_FieldWarGMUid = m_uid;					//
	pUser->m_dwFieldWar = m_dwGuild;				//

	TempBuf.Add(GUILD_FIELD_WAR_REQ);
	TempBuf.Add((int)m_dwGuild);
	TempBuf.AddString(m_strGuildName);
	
	Send(TempBuf, TempBuf.GetLength());				// º¸³½ »ç¶÷¿¡°Ô ¿äÃ»ÁßÀÌ¶ó´Â Ã¢ÀÌ Ç¥½ÃµÇµµ·ÏÇÑ´Ù..	
	pUser->Send(TempBuf, TempBuf.GetLength());		// »ó´ë¹æ¿¡°Ô´Â ´©°¡ ¿äÃ»Çß´Ù´Â 
	return;

go_result:
	m_FieldWarGMUid = -1;
	m_dwFieldWar = 0;

	TempBuf.Add(CHAT_RESULT);
	TempBuf.Add((BYTE)0x00);						// ½ÇÆÐ
	TempBuf.Add(error_code);
	Send(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////
//	ÇÊµåÀü¿¡ ´ëÇÑ ½Â³«¿©ºÎ¿Í ±æµåÀüÀ» ¼±Æ÷ÇÑ´Ù.
//
void USER::SendGuildWarFieldApplyResult(TCHAR *pBuf)
{
	int index = 0;
	int nLength = 0;
	int iGuildID = 0;

	BYTE type = 0;
	BYTE result = FAIL;

	CGuild *pGuild = NULL;
	USER *pUser = NULL;

	CBufferEx TempBuf;

	TCHAR szGuildName[255];

	if(m_dwGuild <= 0) return;
	if(!m_bGuildMaster) return;	
	if(m_FieldWarGMUid < 0 || m_dwFieldWar <= 0) return;
	if(m_tGuildWar == GUILD_WARRING) return;

	TempBuf.Add(GUILD_FIELD_WAR_RESULT);

	pUser = GetUser(m_FieldWarGMUid);
	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) 
	{
		TempBuf.Add((BYTE)0x02);											// °ÅÀý
		Send(TempBuf, TempBuf.GetLength());									
		return;
	}

	if(pUser->m_dwGuild <= 0 || !pUser->m_bGuildMaster) goto go_result;		// »ó´ë¹æÀÌ ±æµå¿Í »ó°ü ¾øÀ¸¸é...

	type = GetByte(pBuf, index);											// °ÅÀýÀÌ¸é...

	if(type != 1) goto go_result;											// ½Â³«ÀÌ ¾Æ´Ï¸é...
	
	if(m_bFieldWarApply) return;											// ÇÊµåÀüÀ» ½ÅÃ»ÇÑÂÊÀº °á°ú¸¦ º¸³½µµ ¹«½ÃÇÑ´Ù. 
	if(pUser->m_tGuildWar == GUILD_WARRING) goto go_result;

	iGuildID = GetInt(pBuf, index);
	pGuild = GetGuild(iGuildID);											// ±æµå¸¦ Ã£°í
	
	if(!pGuild)																// ±æµå°¡ ¾øÀ¸¸é	
	{
		ReleaseGuild();
		goto go_result;
	}

	::ZeroMemory(szGuildName, sizeof(szGuildName));

	nLength = GetVarString(sizeof(szGuildName), szGuildName, pBuf, index);
	if(nLength <= 0 || nLength > CHAR_NAME_LENGTH)							// ±æµåÀÌ¸§ÀÌ Àß¸ø µÇ¾úÀ¸¸é..
	{
		ReleaseGuild();
		goto go_result;
	}

	if(strcmp(pGuild->m_strGuildName, szGuildName) != 0)					// ±æµåÀÌ¸§ÀÌ Æ²¸®¸é...
	{
		ReleaseGuild();
		goto go_result;
	}

	ReleaseGuild();
	result = SUCCESS;

	SendGuildFieldWarBegin();												// ±æµåÀü ½ÃÀÛÀ» ¾Ë¸°´Ù.

go_result:
	if(result == FAIL)
	{
		m_FieldWarGMUid = -1;
		m_dwFieldWar = 0;	
		pUser->m_FieldWarGMUid = -1;
		pUser->m_dwFieldWar = 0;
	}

	m_bFieldWarApply = FALSE;												// ÃÊ±âÈ­ÇÑ´Ù.(ÇÑÂÊ¿¡¼­ ½ÅÃ»ÇÏ°í ½Â³«ÇÏ´Â°ÍÀ» ¹æÁöÇÏ±âÀ§ÇØ))	
	pUser->m_bFieldWarApply = FALSE;

	TempBuf.Add(result);											
	Send(TempBuf, TempBuf.GetLength());									
	pUser->Send(TempBuf, TempBuf.GetLength());
	return;

}

/////////////////////////////////////////////////////////////////////////////
//	ÇÊµåÀü¿¡ ´ëÇÑ ½Â³«ÀÌ¾ú´Ù¸é ±æµåÀüÀ» ¼±Æ÷ÇÑ´Ù.
//
void USER::SendGuildFieldWarBegin()
{
	int i;
	CBufferEx TempBuf;

	USER* pUser = NULL;

	if(m_dwGuild <= 0 || m_dwFieldWar <= 0) return;

	TempBuf.Add(GUILD_WAR);
	TempBuf.Add((BYTE)0x01);							// ±æµåÀü ½ÃÀÛ...
	TempBuf.Add((BYTE)GUILD_FIELD_WARRING);				// ...

	TempBuf.Add((short)0x00);							// ÇÊµå Ç¥½Ã
	TempBuf.Add((BYTE)0x01);							// Âü°¡ ±æµå¿ø Áõ¸í

	TempBuf.Add((short)0x02);							// ÃÑ ±æµå¼ö
	TempBuf.Add((int)m_dwGuild);
	TempBuf.Add((int)m_dwFieldWar);

	for(i = 0; i < MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;
		if(pUser->m_dwGuild <= 0) continue;

		if(pUser->m_dwGuild == m_dwGuild) pUser->m_dwFieldWar = m_dwFieldWar;
		else if(pUser->m_dwGuild == m_dwFieldWar) pUser->m_dwFieldWar = m_dwGuild;
		else continue;

		pUser->BeginGuildWar();			// 
		pUser->Send(TempBuf, TempBuf.GetLength());
	}
}

/////////////////////////////////////////////////////////////////////////////
//	ÇÊµåÀü¿¡¼­ Ç×º¹ÇÏ´Â ÂÊ ±æ¸¶°¡ È£ÃâÇÑ´Ù.
//
void USER::SendGuildWarFieldEnd(TCHAR *pBuf)
{
	int i;
	CBufferEx TempBuf;

	USER* pUser = NULL;
													// ±æÀüµµ ¾Æ´Ï¸é ¿À·ù				
	if(m_dwGuild <= 0 || m_dwFieldWar <= 0) return;
	
	CString strMsg;

	pUser = GetUser(m_FieldWarGMUid);
	if(!pUser) return;

	if(!pUser->m_bGuildMaster) return;				// »ó´ë¹æÀÌ ±æ¸¶°¡ ¾Æ´Ô ¿À·ù

	int iFieldGuild = m_dwFieldWar;

	for(i = 0; i < MAX_USER; i++)
	{
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;

		if(pUser->m_dwGuild == m_dwGuild || pUser->m_dwGuild == iFieldGuild)
		{
			pUser->EndGuildWar(GUILD_FIELD_WARRING);			// ±æµå ÀüÀÌ ³¡³²
			pUser->SendSystemMsg(pBuf, SYSTEM_NORMAL, TO_ME);
		}
	}
}

//////////////////////////////////////////////////////////////////////
//
//	¼­¹öÀÌ»óÀ¯¹«¸¦ ¾Ë·ÁÁØ´Ù.
//
void USER::CheckServerTest()
{
	CString strTemp, strIP;

	strTemp.Format("%u", (unsigned int)((unsigned char*)m_Addr.sin_addr.S_un.S_un_b.s_b1));
	strIP += strTemp; strTemp = _T("");
	strIP += ".";
	strTemp.Format("%u", (unsigned int)((unsigned char*)m_Addr.sin_addr.S_un.S_un_b.s_b2));
	strIP += strTemp; strTemp = _T("");
	strIP += ".";
	strTemp.Format("%u", (unsigned int)((unsigned char*)m_Addr.sin_addr.S_un.S_un_b.s_b3));
	strIP += strTemp; strTemp = _T("");
	strIP += ".";

	CBufferEx TempBuf;

	TempBuf.Add(CHECK_ALIVE_RESULT);

	if(strIP.Left(12).CompareNoCase(_T("192.203.141.")) == 0)
	{
		int nCount = 0;
		USER *pUser = NULL;
		nCount = 0;
		for (int i = 0; i < MAX_USER; i++ )
		{
			pUser = m_pCom->GetUserUid(i);
			if(pUser && pUser->m_state == STATE_GAMESTARTED ) nCount++;
		}

		TempBuf.Add((short)nCount);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	TempBuf.Add((short)0);
	Send(TempBuf, TempBuf.GetLength());
}


//////////////////////////////////////////////////////////////////////
//
//	°­Á¦ ¼­¹ö°øÁö.
//
void USER::AnnounceNotice(TCHAR *pBuf)
{
	CString strTemp, strIP;

	strTemp.Format("%u", (unsigned int)((unsigned char*)m_Addr.sin_addr.S_un.S_un_b.s_b1));
	strIP += strTemp; strTemp = _T("");
	strIP += ".";
	strTemp.Format("%u", (unsigned int)((unsigned char*)m_Addr.sin_addr.S_un.S_un_b.s_b2));
	strIP += strTemp; strTemp = _T("");
	strIP += ".";
	strTemp.Format("%u", (unsigned int)((unsigned char*)m_Addr.sin_addr.S_un.S_un_b.s_b3));
	strIP += strTemp; strTemp = _T("");
	strIP += ".";

	if(strIP.Left(12).CompareNoCase(_T("192.203.141.")) == 0)
	{
		int index = 0;
		SendAllChat(pBuf + index);
	}
}


//////////////////////////////////////////////////////////////////////
//
//	PK´©Àû°ªÀÌ 0À¸·Î, (ÇÏÀ§·¹º§ ¼ºÇâ¼ÂÆÃ)
//
void USER::SendCityRank(int iCityRank)
{
	CBufferEx TempPKBuf;

	if(iCityRank >= 0) m_sKillCount -= 1;	    // Ä«¿À¿¡°Ô Á×¾î¼­´Â PK Ä«¿îÆ®°¡ °¨¼ÒµÇÁö ¾Ê´Â´Ù.

	if(m_sKillCount < 0)
	{
		m_sKillCount = 0;
		if(m_sLevel <= 10 && m_iCityValue < 0)
		{
			m_sCityRank = 0;
			m_iCityValue = 0;

			CheckGuildUserInFortress();			// ½Ã¹Î µî±ÞÀÌ º¯ÇÒ¶§ ´Ù½Ã ¼ÂÆÃ(Æ÷Æ®¸®½º¸¦À§ÇØ)
			
			TempPKBuf.Add(SET_USER_PK_STATE);
			TempPKBuf.Add(m_uid + USER_BAND);
			TempPKBuf.Add((BYTE)0x01);
			TempPKBuf.Add(m_sCityRank);

			SendInsight(TempPKBuf, TempPKBuf.GetLength());
//			SendExactScreen(TempPKBuf, TempPKBuf.GetLength());
		}
	}
}

//////////////////////////////////////////////////////////////////////
//	Agent °¢ À¯Àú DB¿¡ ½Ã°£ ¹öÁ¯À» ±â·Ï
//
DWORD USER::ConvertCurTimeToSaveTime()
{
	DWORD dwCurTime = 0;

	SYSTEMTIME SaveTime;
	GetLocalTime(&SaveTime);
	
	WORD wTemp = 0;
	DWORD dwYear = 0;
	DWORD dwMon = 0;
	DWORD dwDay = 0;
	DWORD dwHour = 0;
	DWORD dwMin = 0;
	DWORD dwSecond = 0;
										// 2 Byte ¹ö¸®°í
	wTemp = SaveTime.wYear << 12;		// »óÀ§ 4 Byte
	wTemp = wTemp >> 12;
	dwYear = (DWORD)wTemp; 
	dwYear = dwYear << 26;

	wTemp = SaveTime.wMonth << 12;		// 4 Byte
	wTemp = wTemp >> 12;
	dwMon = (DWORD)wTemp; 
	dwMon = dwMon << 22;

	wTemp = SaveTime.wDay << 11;		// 5 Byte
	wTemp = wTemp >> 11;
	dwDay = (DWORD)wTemp;
	dwDay = dwDay << 17;

	wTemp = SaveTime.wHour << 11;		// 5 Byte
	wTemp = wTemp >> 11;
	dwHour = (DWORD)wTemp;
	dwHour = dwHour << 12;

	wTemp = SaveTime.wMinute << 10;		// 6 Byte
	wTemp = wTemp >> 10;
	dwMin = (DWORD)wTemp;
	dwMin = dwMin << 6;

	wTemp = SaveTime.wSecond << 10;		// 6 Byte
	wTemp = wTemp >> 10;
	dwSecond = (DWORD)wTemp;

	dwCurTime = dwYear^dwMon^dwDay^dwHour^dwMin^dwSecond;

	return dwCurTime;
}



void USER::MassZoneMove(TCHAR *pBuf)
{
	int i, uid = 0;
	int index = 0, nLen = 0;
	int cityNum = -1, virtualNum = -1;
	int iTotalLevel = 0;

	USER *pUser = NULL;
	CNpc *pNpc = NULL;

	int userCount = 0;
	UserList tempUser[MAX_GUILD_HOUSE_USER];
//	CDWordArray	arUid;
//	arUid.RemoveAll();

	SYSTEMTIME guildTime;
	GetLocalTime(&guildTime);

	if( guildTime.wDay < GUILD_VIRTUAL_WAR_START && guildTime.wDay > GUILD_VIRTUAL_WAR_END ) return;

	short sCount = GetShort(pBuf, index);							// À¯Àú¼ö

	if(sCount <= 0 || sCount > MAX_GUILD_HOUSE_USER) return;		// ÃÖ´ë 20¸í±îÁö
	
	if(m_dwGuild <= 0 || m_dwGuild >= g_arGuildData.GetSize()) return;
	if(!m_bGuildMaster) return;										// ±æµå¿¡ ¼ÓÇÏÁö ¾Ê¾ÒÀ¸¸é...
	if(!g_arGuildData[m_dwGuild]) return;

	for(i = 0; i < MAX_GUILD_HOUSE_USER; i++)
	{
		tempUser[i].uid = 0;
		::ZeroMemory(tempUser[i].strUserName, sizeof(tempUser[i].strUserName));
	}

	for(i = 0; i < sCount; i++)
	{
		uid = GetInt(pBuf, index);

		if(uid >= USER_BAND && uid < NPC_BAND)
		{
			pUser = GetUser(uid - USER_BAND);
			if(!pUser || pUser->m_state != STATE_GAMESTARTED) continue;
			if(pUser->m_dwGuild != m_dwGuild) continue;
			if(pUser->m_curz != m_curz) continue;

			nLen = strlen(pUser->m_strUserID);
			if(nLen <= 0) continue;

			iTotalLevel += pUser->m_sLevel;

			userCount++;
			tempUser[i].uid = pUser->m_uid;
			strncpy(tempUser[i].strUserName, pUser->m_strUserID, nLen);
		}
	}

	if(sCount != userCount)									// ±×µ¿¾È º¯µ¿ÀÌ ÀÖÀ¸¸é ¹«È¿	
	{
		SendSystemMsg( IDS_USER_INVALID_MEMBER_COUNT, SYSTEM_ERROR, TO_ME);
		return;
	}

	short sGuildHouseZone = GetShort(pBuf, index);					// °¡»ó ¸Ê ¹øÈ£
	if( !IsZoneInThisServer(sGuildHouseZone) )	return;				// DB¿¡ ¼ÂÆÃ°ª°ú °°À¸³Ä?
	if(sGuildHouseZone==409) return;

	cityNum = GetCityNumForVirtualRoom(sGuildHouseZone);
	if(cityNum < 0 || cityNum >= g_arGuildHouseWar.GetSize()) return;
	if(!g_arGuildHouseWar[cityNum]) return;

	virtualNum = GetVirtualRoomNum(sGuildHouseZone);				// °¡»ó °ø°£À» ‘¢Ã£°Ú´Ù.--> ¿¡·¯.
	if(virtualNum < 0) return;

	if(InterlockedCompareExchange((LONG*)&g_arGuildHouseWar[cityNum]->m_CurrentGuild.lUsed, (long)1, (long)0) == (long)0)
	{
		for(i = 0; i < MAX_GUILD_HOUSE_USER; i++)
		{
			g_arGuildHouseWar[cityNum]->m_CurrentGuild.arUserList[i].uid = 0;
			::ZeroMemory(g_arGuildHouseWar[cityNum]->m_CurrentGuild.arUserList[i].strUserName, sizeof(g_arGuildHouseWar[cityNum]->m_CurrentGuild.arUserList[i].strUserName));
		}

		g_arGuildHouseWar[cityNum]->m_CurrentGuild.dwIntervalTick = 0;
		g_arGuildHouseWar[cityNum]->m_CurrentGuild.iGuildNum = userCount;
		g_arGuildHouseWar[cityNum]->m_CurrentGuild.dwTimer = GetTickCount();
		g_arGuildHouseWar[cityNum]->m_CurrentGuild.lGuild = m_dwGuild;
		g_arGuildHouseWar[cityNum]->m_CurrentGuild.iCurValue = 0;		
		g_arGuildHouseWar[cityNum]->m_CurrentGuild.iGuildLevel = iTotalLevel;

		for(i = 0; i < g_arGuildHouseWar[cityNum]->m_CurrentGuild.arNpcList.GetSize(); i++)
		{
			uid = g_arGuildHouseWar[cityNum]->m_CurrentGuild.arNpcList[i];
			pNpc = GetNpc(uid);
			if(!pNpc) continue;

			if(pNpc->m_NpcState == NPC_LIVE) pNpc->Dead();
//			pNpc->m_tNpcAttType = 1;
			pNpc->m_NpcVirtualState = NPC_MOVING;
			pNpc->m_NpcState = NPC_LIVE;
			pNpc->NpcTypeParser();
//			if(pNpc->m_NpcState == NPC_LIVE) pNpc->m_NpcState = NPC_DEAD;
//			pNpc->SetLive(m_pCom);
//			TRACE("%s MOP\n", pNpc->m_strName);
		}

		for(i = 0; i < userCount; i++)
		{
			pUser = GetUser(tempUser[i].uid);
			if(!pUser) continue;

			g_arGuildHouseWar[cityNum]->m_CurrentGuild.arUserList[i].uid = tempUser[i].uid;
			nLen = strlen(tempUser[i].strUserName);
			if(nLen <= 0) continue;
			strncpy(g_arGuildHouseWar[cityNum]->m_CurrentGuild.arUserList[i].strUserName, tempUser[i].strUserName, nLen);
			
			pUser->ZoneMoveReq(sGuildHouseZone, g_arVirtualRoom[virtualNum]->m_Move[i].x, g_arVirtualRoom[virtualNum]->m_Move[i].y);
			pUser->SendSystemMsg( IDS_USER_QUEST_TIME, SYSTEM_NORMAL, TO_ME);
			pUser->m_tGuildHouseWar = GUILD_WARRING;
		}
	}
}

int USER::GetCityNumForVirtualRoom(int zone)		// Áö±ÝÀº µµ½Ã¹øÈ£Áö¸¸ ³ªÁß¿¡ VirtualRoomÀÌ °è¼Ó Ãß°¡µÇ¸é..
{													// ¹Ù²Ù¾î¾ß µÈ´Ù. (int zone, int &curGuild)
	int nRet = -1;

	switch(zone)									// Ãß°¡ÇÒ ¿¹Á¤ÀÓ...
	{
	case 1005:										// SANAD
		nRet = SANAD;								// curGuild = ;
		break;

	default:
		break;
	}

	return nRet;
}

int USER::GetVirtualRoomNum(int zone)
{														// ÇÑ µµ½Ã¾È¿¡ ¿©·¯°³ÀÇ °¡»ó°ø°£ÀÌ ÀÖÀ»¼ö ÀÖÀ¸¹Ç·Î 
	for(int i = 0; i < g_arVirtualRoom.GetSize(); i++)	// ±×Áß ¸ÊÀÌ °°Àº ¹øÈ£ÀÎ°ÍÀ» Ã£´Â´Ù.
	{
		if(g_arVirtualRoom[i]->m_sZone == zone) return i;
	}

	return -1;
}

//////////////////////////////////////////////////////////////////////
//
//	ºÐ¾ç±â°£Áß ±æµå ¼øÀ§¸¦ º¸¿©ÁØ´Ù.
//
void USER::SendGuildHouseRank(int nNum, int iCity)
{
	int i, j, index = 0;
	int nLen = 0, nTime = 0;
	int talknum = -1;

	BYTE tCount = 0;
//	TCHAR strTemp[1000];
	CHyper hyperText;

	CBufferEx TempBuf, TempSayBuf;

	CString temp;
	
	if(nNum < 0) return;
	if(iCity < 0 || iCity >= g_arGuildHouseWar.GetSize()) return;
	if(!g_arGuildHouseWar[iCity]) return;

	for(i = 0; i < g_arNpcChat.GetSize(); i++)
	{
		if(g_arNpcChat[i]->m_sCid == nNum)
		{
			talknum = i;
			break;
		}
	}

	if( talknum == -1 ) return;

//	::ZeroMemory(strTemp, sizeof(strTemp));
	hyperText.GetHyperText(g_arNpcChat[talknum]->m_strTalk, g_arNpcChat[talknum]->m_sSize);
	hyperText.load();

	for(i = 0; i < hyperText.m_nCountLine; i++)
	{
		for(j = 0; j < hyperText.m_HyperText[i].m_strText.GetLength()-7; j++){

			temp = hyperText.m_HyperText[i].m_strText.Mid(j, 2);
			if(temp == "%S")
			{
				CGuildHouseWar *tete = g_arGuildHouseWar[iCity];
				if("GN" == hyperText.m_HyperText[i].m_strText.Mid(j+2, 2))	// ±æµå ÀÌ¸§À» ³Ö´Â´Ù.
				{
//					hyperText.m_HyperText[i].m_strText.Replace("%SGN%", g_arGuildHouseWar[iCity]->m_TopList[index].strGuildName);
					TempSayBuf.AddString(g_arGuildHouseWar[iCity]->m_TopList[index].strGuildName);
					index++;
					tCount++;
				}
				else if("STM" == hyperText.m_HyperText[i].m_strText.Mid(j+2, 2))	// 
				{					
					tCount++;
					nTime = (int)g_arGuildHouseWar[iCity]->m_CurrentGuild.dwTimer/1000;
					temp.Format("%d", nTime);
					TempSayBuf.AddString( (LPTSTR)(LPCTSTR)temp );
//					hyperText.m_HyperText[i].m_strText.Replace("%STM%", temp);
				}
			}		
		}
		
	}

//	nLen = hyperText.save(strTemp);


	TempBuf.Add(CLIENT_EVENT_SAY);
	TempBuf.Add((BYTE)SUCCESS);
	TempBuf.Add((short)nNum);
	TempBuf.Add(tCount);
	TempBuf.AddData(TempSayBuf, TempSayBuf.GetLength());

//	TempBuf.AddLongString(strTemp, nLen);

	Send(TempBuf, TempBuf.GetLength());
}

//////////////////////////////////////////////////////////////////////
//
//	
//
void USER::CheckQuestEventZoneWarEnd()
{
	g_QuestEventZone.CheckSingleEventZoneWarEnd(m_curz);
}

//////////////////////////////////////////////////////////////////////
//
//	ºÐ¾ç±â°£Áß ±æµå ¼øÀ§¸¦ Agent¿¡ ÀúÀåÇÏ°í ¸Ê¿¡¼­ ºüÁ®³ª¿Â´Ù.
//
void USER::CheckGuildHouseWarEnd()
{
	int index = -1;
	index = GetCityNumForVirtualRoom(m_curz);

//	USER *pUser = NULL;

	if(index >= 0 && index < g_arGuildHouseWar.GetSize())
	{
		if(!g_arGuildHouseWar[index]) return;

		CheckMaxValue(g_arGuildHouseWar[index]->m_CurrentGuild.iCurValue, 1);	// ÀÌ°Ç ¸÷ÀÌ Á×À»¶§¸¶´Ù È£ÃâµÇ±â¶§¹®¿¡

		if(g_arGuildHouseWar[index]->CheckGuildMopEnd())						// ¸÷ÀÌ ´Ù Á×¾ú´Ù. 
		{			
			g_arGuildHouseWar[index]->SendTownPotalMsg(m_pCom);
			g_arGuildHouseWar[index]->CheckGuildHouseRank();					// Agent¿¡ ÀúÀåÇÑ´Ù.
																				// »ç¿ëÁßÀÎ Ç¥½Ã¸¦ Ç®¾îÁØ´Ù.			
			g_arGuildHouseWar[index]->SetNpcListToWarEnd();


							
/*
			::InterlockedExchange(&g_arGuildHouseWar[index]->m_CurrentGuild.lUsed, 0); 
*/		}
	}
}

//////////////////////////////////////////////////////////////////////
//
//	À¯Àú°¡ Á×°Å³ª, °ÔÀÓ¼­¹ö¸¦ ºüÁ® ³ª°¥¶§¸¶´Ù Ã¼Å©...
//
void USER::CheckGuildUserListInGuildHouseWar()
{
	int i, uid = 0;

	int nCount = 0, nLen = 0;
	USER *pUser = NULL;

	int index = GetCityNumForVirtualRoom(m_curz);

	m_tGuildHouseWar = GUILD_WAR_AFFTER;
	
	if( index < 0 || index >= g_arGuildHouseWar.GetSize() )
	{
		return;
	}

	if(!g_arGuildHouseWar[index]) return;

//	if(m_curz == g_arGuildHouseWar[index]->m_CurrentGuild.iWarZone) TownPotal();

	for(i = 0; i < g_arGuildHouseWar[index]->m_CurrentGuild.iGuildNum; i++)
	{
		uid = g_arGuildHouseWar[index]->m_CurrentGuild.arUserList[i].uid;

		if( uid < 0 || uid >= MAX_USER ) continue;

		pUser = m_pCom->GetUserUid(uid);
		if(!pUser) continue;
		
		nLen = strlen(g_arGuildHouseWar[index]->m_CurrentGuild.arUserList[i].strUserName);
		if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) continue;

		if(strcmp(pUser->m_strUserID, g_arGuildHouseWar[index]->m_CurrentGuild.arUserList[i].strUserName) != 0)
		{
			pUser = GetUser(g_arGuildHouseWar[index]->m_CurrentGuild.arUserList[i].strUserName);
		}

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;

		if(pUser->m_tGuildHouseWar == GUILD_WARRING) nCount++;
	}

	if(nCount <= 0)
	{
		g_arGuildHouseWar[index]->CheckGuildHouseRank();					// Agent¿¡ ÀúÀåÇÑ´Ù.
																			// »ç¿ëÁßÀÎ Ç¥½Ã¸¦ Ç®¾îÁØ´Ù.			
		g_arGuildHouseWar[index]->SetNpcListToWarEnd();
		g_arGuildHouseWar[index]->SetUserListToWarEnd(m_pCom);				// ¼ÂÆÃ¸¦ Ç®¾îÁØ´Ù.

		g_arGuildHouseWar[index]->InitGuild();								// µ¥ÀÌÅÍ¸¦ ³¯¸°´Ù.

		g_arGuildHouseWar[index]->m_CurrentGuild.dwIntervalTick = 0;
		::InterlockedExchange(&g_arGuildHouseWar[index]->m_CurrentGuild.lUsed, 0); 
	}
}

//////////////////////////////////////////////////////////////////////
//
//	ÇØ´ç Á¸¿¡ »ý¼º¶Ç´Â ÀÏ½ÃÀû Á¦ÇÑÀÌ °É¸° Á¸ÀÎÁö Ã¼Å©
//
void USER::CheckInvalidGuildZone()
{
	int mapindex = 0;
	int i, index = 0;
	int type = CheckInvalidMapType();
	mapindex = GetGuildMapIndex(type);
	if(mapindex >= 0 && mapindex < g_arMapTable.GetSize())
	{
		if(g_arMapTable[mapindex] == NULL ) return;
		index = g_arMapTable[mapindex]->m_sStoreID;

		if(index >= FORTRESS_BAND)
		{
			CGuildFortress* pFort = NULL;
			pFort = GetFortress(index);

			if(pFort) 
			{
				if(g_arMapTable[mapindex]->m_sStoreZone)
				{
					m_bLive = USER_DEAD;
					SetZoneIndex(m_curz);
					IsDeadUser();		
					m_sHP = m_sMaxHP;												//@@@@@@@@@@@ ÀÓ½ÃÄÚµå
					m_bLive = USER_LIVE;
					return;
				}

				if(pFort->m_lUsed == 1)
				{
					m_bLive = USER_DEAD;
	//				m_sHP = 0;
					SetZoneIndex(m_curz);
					IsDeadUser();		
					m_sHP = m_sMaxHP;												//@@@@@@@@@@@ ÀÓ½ÃÄÚµå
					m_bLive = USER_LIVE;
					SendSystemMsg( IDS_USER_CANT_REVIVE_IN_WAR, SYSTEM_NORMAL, TO_ME);
				}
			}
		}
/*		else 
		{
			CStore *pStore = NULL;

			index = g_arMapTable[mapindex]->m_sStoreIndex;

			pStore = GetStore(index);

			if(pStore)
			{
				if(pStore->m_lUsed == 1)								// ÇØ´ç ¼Ó¼º ¸ÊÀÌ ±æµåÀü »óÅÂ	
				{
	//				int temp = m_sHP;
					m_bLive = USER_DEAD;
	//				m_sHP = 0;
					SetZoneIndex(m_curz);
					IsDeadUser();		
					m_sHP = m_sMaxHP;												//@@@@@@@@@@@ ÀÓ½ÃÄÚµå
					m_bLive = USER_LIVE;
					return;
				}
			}
		}
*/	}

	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{		
		if(!g_arGuildFortress[i]) continue;

		if(m_curz == g_arGuildFortress[i]->m_iZone)
		{
			m_bLive = USER_DEAD;
			IsDeadUser();		
			m_sHP = m_sMaxHP;												//@@@@@@@@@@@ ÀÓ½ÃÄÚµå
			m_bLive = USER_LIVE;
			return;
		}
	}

	for(i = 0; i < g_arGuildHouseWar.GetSize(); i++)
	{
		if(!g_arGuildHouseWar[i]) continue;

		if(m_curz == g_arGuildHouseWar[i]->m_CurrentGuild.iWarZone)
		{
//			int temp = m_sHP;
			m_bLive = USER_DEAD;
//			m_sHP = 0;
			SetZoneIndex(m_curz);
			IsDeadUser();		
			m_sHP = m_sMaxHP;												//@@@@@@@@@@@ ÀÓ½ÃÄÚµå
			m_bLive = USER_LIVE;
			return;
		}
	}

	for(i = 0; i < g_arGuildHouse.GetSize(); i++)						// ±æµåÇÏ¿ì½º ¾ÈÀÎµ¥.. ¼ÒÀ¯±æµå°¡ ¾Æ´Ï¸é..
	{
		if(m_curz == g_arGuildHouse[i]->iZone)
		{
//			int temp = m_sHP;
			m_bLive = USER_DEAD;
//			m_sHP = 0;
			SetZoneIndex(m_curz);
			IsDeadUser();		
			m_sHP = m_sMaxHP;												//@@@@@@@@@@@ ÀÓ½ÃÄÚµå
			m_bLive = USER_LIVE;
			return;
		}
	}

	for(i = 0; i < g_QuestEventZone.m_arEventZone.GetSize(); i++)
	{
		if(m_curz == g_QuestEventZone.m_arEventZone[i])
		{
			m_bLive = USER_DEAD;
			IsDeadUser();		
			m_sHP = m_sMaxHP;												//@@@@@@@@@@@ ÀÓ½ÃÄÚµå
			m_bLive = USER_LIVE;
			return;
		}
	}
}
/*
void USER::CheckMemoryDB(char* strAccount, char *strUserId)
{
	CSharedMemory*	pSharedMemory;
	CMemUser*		pMD;
	int				mem_index = -1;
	int				nLen1, nLen2;
	CString			str;

	SYSTEMTIME time;
	GetLocalTime(&time);

	for( int i = 0; i < MAX_USER; i++ )
	{
		pSharedMemory = NULL;
		pSharedMemory = g_arSharedMemory[i];

		if(!pSharedMemory) continue;

		pMD = (CMemUser*)pSharedMemory->m_lpData;

		nLen = strlen( pMD->m_strUserID );
		if( nLen <= 0 || nLen > CHAR_NAME_LENGTH ) continue;

		if( strcmp( pMD->m_strUserID, strUserId ) == 0 )
		{
			// ÆÄÀÏ¿¡ ¾´´Ù
			if ( g_ChatEnable[m_iModSid] == TRUE )
			{
				str.Format( "(%dM %dD %dH %dMIN)\tuid-%d str-%d uduid-%d savetime-%d id-%s\r\n",
					time.wMonth, time.wDay, time.wHour, time.wMinute, pMD->m_uid, pMD->m_sSTR, pMD->m_UB.m_uid, pMD->m_dwSaveTime, pMD->m_strUserID );
				
				// IKING 2002.1.
				//TRACE("*** bfile write log started:%s ***\n", strUserId);
				EnterCriticalSection( &m_CS_FileWrite );
				g_fpBackServer.Write( str, str.GetLength() );
				LeaveCriticalSection( &m_CS_FileWrite );
			}

			//TRACE("*** bfile write logged end:%s ***\n", strUserId);
			//

//			if(pMD->m_uid == -1) continue;		// Á¤¸®°¡ µÈ À¯Àú´Â ´Ù½Ã ÀúÀåÇÏÁö ¾Ê´Â´Ù.
//			if(pMD->m_sSTR == 0) continue;		// ¸¶Âù°¡Áö

			UpdateMem2DB(pMD);
			UpdateBankMem2DB(pMD);
			UpdateAccountBankMem2DB(pMD);

			pMD->m_uid = -1;
			pMD->m_sSTR = 0;			
			pMD->m_UB.m_uid = -1;
			pMD->m_AB.m_uid = -1;
			pMD->m_dwSaveTime = 0;
			::ZeroMemory(pMD->m_strUserID, sizeof(pMD->m_strUserID));
		}
	}
}
*/
int USER::CheckMemoryDB(char *strUserId)
{
	CSharedMemory*	pSharedMemory;
	CMemUser*		pMD;
	int				mem_index = -1;
	int				nLen;
	int				user_count = 0;
	int				account_count = 0;
	int				ret_val = 0;
	CString			str;

	SYSTEMTIME time;
	GetLocalTime(&time);

	for( int i = 0; i < MAX_USER; i++ )
	{
		pSharedMemory = NULL;
		pMD = NULL;

		pSharedMemory = g_arSharedMemory[i];
		if(!pSharedMemory) continue;

		pMD = (CMemUser*)pSharedMemory->m_lpData;
		if(!pMD) continue;

		if(pMD->m_uid == -1 || pMD->m_sSTR == 0) continue;		// Á¤¸®°¡ µÈ À¯Àú´Â ´Ù½Ã ÀúÀåÇÏÁö ¾Ê´Â´Ù.
		if(pMD->m_strUserID[0] == 0) continue;

		nLen = strlen( strUserId );
		if( nLen <= 0 || nLen > CHAR_NAME_LENGTH ) continue;

		
		if( _stricmp( pMD->m_strUserID, strUserId ) == 0 && _stricmp( pMD->m_strAccount, m_strAccount ) == 0 )
		{
			user_count++;
			// ÆÄÀÏ¿¡ ¾´´Ù
			if(user_count > 1)
			{
				GetLocalTime(&time);
				str.Format("(%04d-%02d-%02d %02d:%02d:%02d)\tuid-%d str-%d ubuid-%d count-%d id-%s\r\n",
					time.wYear, time.wMonth, time.wDay, time.wHour, time.wMinute, time.wSecond,
					pMD->m_uid, pMD->m_sSTR, pMD->m_UB.m_uid, user_count, pMD->m_strUserID );
				
				// IKING 2002.1.
				EnterCriticalSection( &m_CS_FileWrite );
				g_fpBackServer.Write( str, str.GetLength() );
				LeaveCriticalSection( &m_CS_FileWrite );
			}

//			if( !Mem2Game(pMD) )			// Shared Memory -> Game º¯¼ö·Î
//			{
//				user_count--;
//			}

			UpdateMem2DB(pMD);		// ¾ÈÀüÀ» À§ÇØ¼­ DB¿¡µµ ÀúÀåÀ»
			UpdateBankMem2DB(pMD);
			UpdateAccountBankMem2DB(pMD);

			pMD->m_uid = -1;
			pMD->m_sSTR = 0;			
			pMD->m_UB.m_uid = -1;
			pMD->m_AB.m_uid = -1;
			pMD->m_dwSaveTime = 0;
			::ZeroMemory(pMD->m_strUserID, sizeof(pMD->m_strUserID));
			::ZeroMemory(pMD->m_strAccount, sizeof(pMD->m_strAccount));
		}
		// °èÁ¤Àº °°Àºµ¥ ¾ÆÀÌµð°¡ ´Ù¸£´Ù.
		else if( _stricmp( pMD->m_strAccount, m_strAccount ) == 0 && _stricmp( pMD->m_strUserID, strUserId ) != 0 )
		{
			account_count++;

			if(account_count > 1)
			{
				GetLocalTime(&time);
				str.Format("(%04d-%02d-%02d %02d:%02d:%02d)\tuid-%d str-%d ubuid-%d count-%d id-%s (AccountBank)\r\n",
					time.wYear, time.wMonth, time.wDay, time.wHour, time.wMinute, time.wSecond,
					pMD->m_uid, pMD->m_sSTR, pMD->m_AB.m_uid, account_count, pMD->m_strAccount );
				
				// IKING 2002.1.
				EnterCriticalSection( &m_CS_FileWrite );
				g_fpBackServer.Write( str, str.GetLength() );
				LeaveCriticalSection( &m_CS_FileWrite );
			}

//			if( !Mem2GameAccountBank(pMD) )
//			{
//				account_count++;
//			}

			UpdateMem2DB(pMD);		// ¾ÈÀüÀ» À§ÇØ¼­ DB¿¡µµ ÀúÀåÀ»
			UpdateBankMem2DB(pMD);
			UpdateAccountBankMem2DB(pMD);

			pMD->m_uid = -1;
			pMD->m_sSTR = 0;			
			pMD->m_UB.m_uid = -1;
			pMD->m_AB.m_uid = -1;
			pMD->m_dwSaveTime = 0;
			::ZeroMemory(pMD->m_strUserID, sizeof(pMD->m_strUserID));
			::ZeroMemory(pMD->m_strAccount, sizeof(pMD->m_strAccount));
		}
	}

//	if( user_count == 0 && account_count == 0 ) return 0;		
																// ¾ÆµÚ,ÀºÇà,ÅëÃ¢ ¸ðµÎ DB¿¡¼­ °¡Á®¿Í¾ß ÇÑ´Ù.
//	if( user_count != 0 && account_count == 0 ) return 1;		// ¾ÆµÚ¶û °èÁ¤ÀÌ °°Àº °ÍÀº ÀÖ¾ú°í, °èÁ¤¸¸ °°°í ¾ÆµÚ°¡ ´Ù¸¥°ÍÀº ¾ø¾ú´Ù.
																// ¾ÆµÚ,ÀºÇà,ÅëÃ¢ ¸ðµÎ MemoryDB¿¡¼­ °¡Á®¿Ô´Ù. DB¿¡¼­ °¡Á®¿ÀÁö ¾Ê´Â´Ù.
//	if( user_count != 0 && account_count != 0 ) return 1;		// ¾ÆµÚ¶û °èÁ¤ÀÌ °°Àº °ÍÀÌ ÀÖ¾ú°í, °èÁ¤¸¸ °°°í ¾ÆµÚ°¡ ´Ù¸¥°Íµµ ÀÖ¾ú´Ù.
																// ¾ÆµÚ,ÀºÇà,ÅëÃ¢ ¸ðµÎ MemoryDB¿¡¼­ °¡Á®¿Ô´Ù. DB¿¡¼­ °¡Á®¿ÀÁö ¾Ê´Â´Ù.
//	if( user_count == 0 && account_count != 0 ) return 2;		// ¾ÆµÚ¶û °èÁ¤ÀÌ °°Àº °ÍÀº ¾ø¾ú°í, °èÁ¤¸¸ °°Àº °ÍÀÌ ÀÖ¾ú´Ù.
																// ¾ÆµÚ,ÀºÇà,ÅëÃ¢ ¸ðµÎ DB¿¡¼­ °¡Á®¿Í¾ß ÇÑ´Ù. (³ªÁß¿¡ ÅëÃ¢¸¸ MemoryDB¿¡¼­ °¡Á®¿À´Â ·çÆ¾À» ³ÖÀ»°ÍÀÌ´Ù.)

	return 0;
}

//////////////////////////////////////////////////////////////////////
//
//	°¡Àå °¡±î¿î µµ½Ã·Î Å¸¿îÆ÷Å» ÁÂÇ¥¸¦ ±¸ÇÑ´Ù.
//
CPoint USER::GetTownPotal(int &potal)
{
	if(m_curz == 66)		//É±ÈË¿ñ´óÈüËÀºóÔ­µØ¸½½ü¸´»î
	{
		
			int			i;
			BYTE		error;
			ItemList	ReverseItem;
			CBufferEx	TempBuf, TempYourBuf;
			CPoint		ptRevival, ptClientRevival;
			if(m_bLive == USER_LIVE) return NULL;
			ptRevival = FindNearAvailablePoint_S( m_curx, m_cury );

			if( ptRevival.x == -1 || ptRevival.y == -1 )
				TownPotal();

			if( LiveCity( ptRevival.x, ptRevival.y ) == FALSE )
			{
				error = 3;								// ºÎÈ°ÇÒ Àå¼Ò¸¦ ¸øÃ£À½: ¾Ë¼ö¾ø´Â ¿¡·¯
				TempBuf.Add( REVIVAL_RESULT );
				TempBuf.Add( error );
				Send( TempBuf, TempBuf.GetLength() );
				return NULL;
			}
			m_bLive = USER_LIVE;
			InterlockedExchange(&m_lDeadUsed, (LONG)0);
			ptClientRevival = ConvertToClient( m_curx, m_cury );
			if(m_sMagicMaxHP > m_sMaxHP) m_sHP = m_sMagicMaxHP;
			else m_sHP = m_sMaxHP;
			error = 0;
			TempBuf.Add( REVIVAL_RESULT );
			TempBuf.Add( error );
			TempBuf.Add(m_uid + USER_BAND);
			TempBuf.AddString(m_strUserID);

			TempBuf.Add((short)ptClientRevival.x);
			TempBuf.Add((short)ptClientRevival.y);

			TempBuf.Add(m_iSkin);
			TempBuf.Add(m_iHair);
			TempBuf.Add((BYTE)m_sGender);
			TempBuf.AddData(m_strFace, 10);

			for( i = 0; i < EQUIP_ITEM_NUM; i++ ) TempBuf.Add(m_UserItem[i].sSid);

			TempBuf.Add(m_sHP);
			TempBuf.Add(m_sMagicMaxHP);

			TempBuf.Add(m_tDir);

			TempBuf.Add(m_dwAbnormalInfo);				// »óÅÂÀÌ»ó Á¤º¸
			TempBuf.Add(m_dwAbnormalInfo_);
			TempBuf.Add((DWORD)0);
			TempBuf.Add((DWORD)0);
			/*TempBuf.Add((BYTE)0x00);
			TempBuf.Add((BYTE)0x00);
			TempBuf.Add((BYTE)0x00);
			TempBuf.Add((BYTE)0x00);
			TempBuf.Add((BYTE)0x00);
			TempBuf.Add((BYTE)0x00);
			TempBuf.Add((BYTE)0x00);
			TempBuf.Add((BYTE)0x00);
			*/
			TempBuf.Add(m_sCityRank);

			TempBuf.Add((int)m_dwGuild);				//&&&&&&&&&&&& Test Code
			TempBuf.AddString(m_strGuildName);			// ±æµå ÀÌ¸§À» Ãß°¡
			TempBuf.Add(m_sGuildVersion);
			TempBuf.Add(m_byClass);
			TempBuf.Add((BYTE)m_bPkStatus);

			TempBuf.AddString(m_strLoveName);			//yskang 0.1

			for( i = TOTAL_INVEN_MAX; i < TOTAL_ITEM_NUM-2; i++) TempBuf.Add(m_UserItem[i].sSid);	// EBody
			if(m_UserItem[TOTAL_ITEM_NUM-2].sSid!=-1&&m_UserItem[TOTAL_ITEM_NUM-2].sDuration!=0){
				TempBuf.Add((BYTE)(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]));
				TempBuf.Add((BYTE)0x00);
			}else{
				TempBuf.Add(m_UserItem[TOTAL_ITEM_NUM-2].tMagic[0]);
				TempBuf.Add((BYTE)0xff);
			}
			TempBuf.AddString(m_PersonalShopName);

			SendInsight(TempBuf, TempBuf.GetLength());

			if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
			potal = m_curz;


				int x; int y; int random;
				random = myrand( 1,10);
				switch(random)
				{
				case	1:
					x =14,y=36;
					break;
				case	2:
					x =4,y=48;
					break;
				case	3:
					x =10,y=62;
					break;
				case	4:
					x =34,y=58;
					break;
				case	5:
					x =46,y=42;
					break;
				case	6:
					x =34,y=28;
					break;
				case	7:
					x =26,y=40;
					break;
				case	8:
					x =19,y=51;
					break;
				case	9:
					x =13,y=57;
					break;
				case	10:
					x =29,y=51;
					break;
				}
			
			ptClientRevival.x=x;
			ptClientRevival.y=y;
			return CPoint(ptClientRevival.x, ptClientRevival.y);
		
	}
	else
	{
	int i, num = -1;
	int dx1 = 0, dy1 = 0;
	int dx2 = 0, dy2 = 0;
	int dx3 = 0, dy3 = 0;

	if(CheckInvalidMapType() != 12)				// ´ë·ÃÀåÀÌ ¾Æ´Ò¶§¸¸ ±æµåÇÏ¿ì½º¿Í Æ÷Æ®¸®½º¸¦ Ã¼Å©ÇÑ´Ù
	{
		for(i = 0; i < g_arGuildFortress.GetSize(); i++)			// ¸ÕÀú Fortress¸¦ ¼ÒÀ¯ÇÑ ±æµåÀÎÁö Ã¼Å©ÇÑ´Ù.
		{
			if(!g_arGuildFortress[i]) continue;

			if(CheckGuildHouseUser(g_arGuildFortress[i]->m_sFortressID)) 
			{
				potal = g_arGuildFortress[i]->m_iZone;
				return CPoint(g_arGuildFortress[i]->m_iPotalX, g_arGuildFortress[i]->m_iPotalY);
			}
		}

		for(i = 0; i < g_arGuildHouse.GetSize(); i++)				
		{
			if(CheckGuildHouseUser(i + 1)) 
			{
				potal = g_arGuildHouse[i]->iZone;
				return CPoint(g_arGuildHouse[i]->iPotalX, g_arGuildHouse[i]->iPotalY);
			}
		}
	}

	for(i = 0; i < g_TownPotal.GetSize(); i++)					// ¾Æ´Ï¸é °¡±î¿î µµ½Ã·Î ÀÌµ¿ÇÑ´Ù.
	{
		if(g_TownPotal[i]->iZone == m_curz) { num = i; break; }
	}

	if(num < 0) 
	{
		potal = -1;
		return CPoint(-1, -1);
	}

	potal = g_TownPotal[num]->iPotalZone;

	CPoint temp = ConvertToClient(m_curx, m_cury);

	if(g_TownPotal[num]->iPotalX <= 0) return CPoint(g_TownPotal[num]->iPotalX1, g_TownPotal[num]->iPotalY1);
	else if(g_TownPotal[num]->iPotalX1 <= 0) return CPoint(g_TownPotal[num]->iPotalX, g_TownPotal[num]->iPotalY);
	else
	{
		dx1 = abs(g_TownPotal[num]->iPotalX - temp.x);
		dy1 = abs(g_TownPotal[num]->iPotalY - temp.y);

		dx2 = abs(g_TownPotal[num]->iPotalX1 - temp.x);
		dy2 = abs(g_TownPotal[num]->iPotalY1 - temp.y);

		i = myrand(0, 2);

		if( (dx1 + dy1) < (dx2 + dy2) )
		{
			if(potal == 400)	return CPoint(g_RandomTownPotal[2]->iPotal[i].x, g_RandomTownPotal[2]->iPotal[i].y);
			else				return CPoint(g_RandomTownPotal[0]->iPotal[i].x, g_RandomTownPotal[0]->iPotal[i].y);
			

//			return CPoint(g_TownPotal[num]->iPotalX, g_TownPotal[num]->iPotalY);
		}
		else
		{
			if( m_curz == 1 )	// ·çÀÌ³×Æ®,»ç³ªµå,ÀÚ¸á¸®¾Æ - ÀÌ¹Ì »ç³ªµå°¡ ¼±ÅÃµÈ »óÈ²
			{
				dx3 = abs( 2463 - temp.x );
				dy3 = abs( 705 - temp.y);

				if( (dx3 + dy3) < (dx2 + dy2) )	// ÀÚ¸á¸®¾Æ ÀÔ±¸°¡ ´õ °¡±õ´Ù¸é
				{
					potal = 26;
					return CPoint( 36, 64 );
				}
			}
			if(potal == 400)	return CPoint(g_RandomTownPotal[2]->iPotal[i].x, g_RandomTownPotal[2]->iPotal[i].y);
			else				return CPoint(g_RandomTownPotal[1]->iPotal[i].x, g_RandomTownPotal[1]->iPotal[i].y);

			if(potal == 300) CPoint(g_TownPotal[num]->iPotalX1, g_TownPotal[num]->iPotalY1);
		}
	}
	
	return CPoint(-1, -1);
  }
}
/////////////////////////////////////////////////////////////////////////////////////
//	SpeedHack »ç¿ëÀÚÀÎÁö¸¦ °Ë»çÇÑ´Ù.
//
void USER::CheckSpeedHack()
{
	m_dwServerTick = GetTickCount();

	if(m_iTickCount == 0)
	{
		m_dwClientTick = GetTickCount();
		m_iTickCount++;
		return;
	}

	DWORD dwGap = 0;
	DWORD dwCurr = GetTickCount(); 

	dwGap = dwCurr - m_dwClientTick;
	TRACE("-----id = %s,  dwGap = %d\n", m_strUserID, dwGap);
	if(dwGap < 32000)
	{
		SYSTEMTIME time;
		GetLocalTime(&time);
		
		CString str;
		str.Format( IDS_USER_SYSTEM_MSG02, time.wMonth, time.wDay, time.wHour, time.wMinute, m_strAccount, m_strUserID, dwGap);
		
		EnterCriticalSection( &m_CS_FileWrite );
		g_fpSpeedHack.Write(str, str.GetLength());
		LeaveCriticalSection( &m_CS_FileWrite );
		
		SendSystemMsg( IDS_USER_SPEED_HACK, SYSTEM_SPECIAL, TO_ME);
	}

	m_dwClientTick = GetTickCount();
}

/////////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç ±æµåÀÇ DB¿Í ±æµå¿øµé¸¦ DB¿¡¼­ »èÁ¦ÇÑ´Ù.
//
BOOL USER::DeleteGuildDB()
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		

	if(m_dwGuild <= 0 || m_dwGuild >= g_arGuildData.GetSize()) return FALSE;
	if(!m_bGuildMaster) return FALSE;
	if(!g_arGuildData[m_dwGuild]) return FALSE;

	::ZeroMemory(szSQL, sizeof(szSQL));

	int index = 0;

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call DELETE_GUILD (%d, \'%s\')}"), m_dwGuild, m_strUserID); 

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			bQuerySuccess = FALSE;
		}
	}
	else
	{
		//if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		//BREAKPOINT();

		//g_DB[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);

	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

//void USER::RemoveReceivedData()
//{
//	POSITION pos, pos2;
//	WAIT_RECV_DATA *pWrd;
//
//	return;
//
//	EnterCriticalSection(&m_CS_ReceiveData[m_iSidMod]);
//
//	for ( pos = RecvPtrList[m_iSidMod].GetHeadPosition();  pos != NULL; )
//	{
//		pos2 = pos;
//		pWrd = (WAIT_RECV_DATA *)RecvPtrList[m_iSidMod].GetNext( pos );
//		if ( pWrd )
//		{
//			if ( pWrd->usn == m_Sid )
//			{
//				delete pWrd;
//				pWrd = NULL;
//
//				RecvPtrList[m_iSidMod].RemoveAt(pos2);
//			}
//		}
//	};
//
//	nRecvDataLength[m_iSidMod] = RecvPtrList[m_iSidMod].GetCount();
//
//	LeaveCriticalSection(&m_CS_ReceiveData[m_iSidMod]);
//}

int USER::SockCloseProcess(int nError)
{
	if(m_bSessionOnline) return 0;

	if ( m_UserStatus == 0  ) return 0;

	m_UserStatus = 0;

	if (g_pMainDlg->m_bLogOutExit == TRUE)
	{
		if ( m_state == STATE_GAMESTARTED )
//			LogOutWithDbServer();
			LogOut();

		m_state = STATE_DISCONNECTED;

		CBSocket::SockCloseProcess();  // UserList¿¡¼­ »èÁ¦ 

		// ¼­Ä¡ ±¸Á¶¿¡¼­ Áö¿ì±â...
		g_pMainDlg->UserFree( m_uid );

		m_UserFlag = FALSE;
		return 0;
	}

	if ( m_state == STATE_GAMESTARTED )
		//LogOutWithDbServer();
		LogOut();

	m_state = STATE_DISCONNECTED;

	CBSocket::SockCloseProcess();  // UserList¿¡¼­ »èÁ¦ 

	// ¼­Ä¡ ±¸Á¶¿¡¼­ Áö¿ì±â...
	g_pMainDlg->UserFree( m_uid );

	m_UserFlag = FALSE;

	return 1;
}

void USER::OnClose(int nErrorCode) 
{
	CBSocket::B_OnClose(nErrorCode);
}

void USER::OnSend(int nErrorCode) 
{
	if ( m_SockFlag != 1 || m_UserFlag == FALSE ) return;

	CBSocket::B_OnSend( nErrorCode );

	if ( m_SockFlag == 0 )
	{
		SoftClose();
	}
}

int USER::AcceptProcess()
{
	return 1;
}

void USER::StopAction()
{
}

/////////////////////////////////////////////////////////////////////////////////////
//	±æµåÇÏ¿ì½º¸¦ ¼ÒÀ¯ÇÑ ±æµå¿ø¸¸ ÃâÀÔÇÑ´Ù.
//
BOOL USER::CheckGuildHouseUser(int num)
{
	if(m_dwGuild <= 0) return FALSE;

	if(num >= FORTRESS_BAND)
	{
		CGuildFortress *pFort = NULL;
		pFort = GetFortress(num);

		if(pFort)
		{
			if(pFort->m_iGuildSid == m_dwGuild) return TRUE;
		}
	}
	else
	{
		for(int i = 0; i < g_arGuildHouse.GetSize(); i++)
		{
			if(g_arGuildHouse[i]->iGuild <= 0) continue;

			if(g_arGuildHouse[i]->iSid == num) 
			{			
				if(g_arGuildHouse[i]->iGuild == m_dwGuild) return TRUE;
			}
		}
	}

	return FALSE;
}

/////////////////////////////////////////////////////////////////////////////////////
//	ÇÚµð°ÔÀÌÆ®¸¦ »ç¿ëÇÏ±âÀ§ÇØ ÀüÃ¼ Ç®¸®½ºÆ®¸¦ ³»·ÁÁØ´Ù.
//
void USER::TeleportReq()
{
	int i, iCount = 0;

	if(!CheckHandyGate()) 
	{
		SendSystemMsg( IDS_USER_NO_HANDYGATE, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(m_bSessionOnline == true) return; 
	if(m_bLive == USER_DEAD) return;		 
	if(m_bNowTrading == TRUE) return;		
	if(m_bNoItemMove == TRUE) return;		
	if(m_bViewingAShop == TRUE) return;
	if(m_bPShopOpen == TRUE){ SendSystemMsg("¸öÈËÉÌµê×´Ì¬ÏÂÎÞ·¨Ê¹ÓÃ´«ËÍÃÅ!", SYSTEM_ERROR, TO_ME);return;}

	CBufferEx TempBuf;
	TempBuf.Add(TELEPORT_RESULT);

	for(i = 1; i < TEL_MAX_COUNT; i++)
	{
		if(m_strTeleport[i].iSid != 0) iCount++;
	}

	TempBuf.Add((BYTE)(iCount));

	for(i = 1; i < TEL_MAX_COUNT; i++)
	{
		if(m_strTeleport[i].iSid != 0)
		{
			TempBuf.Add((BYTE)m_strTeleport[i].iSid);
			TempBuf.AddString(m_strTeleport[i].TelName);
			TempBuf.Add((int)m_strTeleport[i].z);//yskang 0.9 handy ¼öÁ¤ ÇÚµð·Î ÀÌµ¿ ºÒ°¡Áö¿ªÀ» È¸»öÀ¸·Î Ç¥½ÃÇÏ±â À§ÇÏ¿©
		}
	}

	Send(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////////////
//	DB¿¡ ÀúÀåµÈ Á¤º¸¸¦ ¹è¿­¿¡ ¼ÂÆÃ
//
void USER::StrToUserTel(TCHAR *pBuf)
{
	int index = 0;
	int temp = 0;
	int nLength = 0;

//	for(int i = 1; i < TEL_MAX_COUNT; i++)
	do
	{
		temp = GetByte(pBuf, index);
		if(temp <= 0 || temp >= TEL_MAX_COUNT) break;

		m_strTeleport[temp].iSid = temp;
		m_strTeleport[temp].x = GetShort(pBuf, index);
		m_strTeleport[temp].y = GetShort(pBuf, index);
		m_strTeleport[temp].z = GetShort(pBuf, index);

		nLength = GetByte(pBuf, index);
		if(nLength < 0 || nLength > TEL_NAME_LENGTH) break;
	
		GetString(m_strTeleport[temp].TelName, pBuf, nLength, index);

		m_strTeleport[temp].TelName[TEL_NAME_LENGTH + 1] = 0;

	} while(TRUE);
}

/////////////////////////////////////////////////////////////////////////////////////
//	µ¥ÀÌÅ¸¸¦ DB¿¡ ÀúÀå 
//
void USER::UserTelToStr(TCHAR *pBuf)
{
	int index = 0;

	for(int i = 1; i < TEL_MAX_COUNT; i++)
	{
		if(m_strTeleport[i].iSid == 0) continue;

		SetByte(pBuf, m_strTeleport[i].iSid, index);
		SetShort(pBuf, m_strTeleport[i].x, index);
		SetShort(pBuf, m_strTeleport[i].y, index);
		SetShort(pBuf, m_strTeleport[i].z, index);
		SetVarString(pBuf, m_strTeleport[i].TelName, strlen( m_strTeleport[i].TelName ), index );
	}
}

/////////////////////////////////////////////////////////////////////////////////////
//	µ¥ÀÌÅ¸¸¦ ÃÊ±âÈ­ÇÑ´Ù.
//
void USER::InitTelList(TeleportList *strTel)
{
	for(int i = 0; i < TEL_MAX_COUNT; i++)
	{
		strTel[i].iSid = 0;
		strTel[i].x = 0;
		strTel[i].y = 0;
		strTel[i].z = 0;
		::ZeroMemory(strTel[i].TelName, sizeof(strTel[i].TelName));		
	}

	m_lCopyUsed = 0;
	m_CopyUid = 0;				// copy chip ¿¡ »ç¿ëµÇ´Â ¾ÆÀÌÅÛ
	m_tIndex = 0;
	::ZeroMemory(m_strCopyUser, sizeof(m_strCopyUser));	
}

/////////////////////////////////////////////////////////////////////////////////////
//	ÅÚ ÁÂÇ¥¸¦ ±â¾ïÇÏ°Å³ª »èÁ¦ÇÑ´Ù.
//
void USER::TelportEdit(TCHAR *pBuf)
{
	int i, mapindex = 0;
	int index = 0;
	BYTE tIndex = 0;
	
	CPoint pt;
	int nLen = 0, type = 0;
	BOOL bSuccess = FALSE;	
	TCHAR szName[TEL_NAME_LENGTH + 1];	
	CBufferEx TempBuf;
	
	if(!CheckHandyGate()) 
	{
		SendSystemMsg( IDS_USER_NO_HANDYGATE, SYSTEM_ERROR, TO_ME);
		return;
	}

	BYTE tType = GetByte(pBuf, index);

	::ZeroMemory(szName, sizeof(szName));

	if(tType == TEL_ADD_EDIT)
	{	
		for(i = 0; i < g_arGuildHouseWar.GetSize(); i++)
		{
			if(!g_arGuildHouseWar[i]) continue;

			if( m_curz == g_arGuildHouseWar[i]->m_CurrentGuild.iWarZone)
			{
				SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
				goto go_result;
			}
		}

		for(i = 0; i < g_arGuildHouse.GetSize(); i++)
		{
			if( m_curz == g_arGuildHouse[i]->iZone)
			{
				SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
				goto go_result;
			}
		}

		for(i = 0; i < g_QuestEventZone.m_arEventZone.GetSize(); i++)
		{
			if(m_curz == g_QuestEventZone.m_arEventZone[i])
			{
				SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
				goto go_result;
			}
		}

		for(i = 0; i < g_arGuildFortress.GetSize(); i++)
		{
			//break;
			if(!g_arGuildFortress[i]) continue;

			if(m_curz == g_arGuildFortress[i]->m_iZone)
			{
				SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);//yskang handy don't save
				goto go_result;
			}

			type = CheckInvalidMapType();
			mapindex = GetGuildMapIndex(type);
			if(mapindex >= 0 && mapindex < g_arMapTable.GetSize())
			{
				if(g_arMapTable[mapindex])
				{
					if(g_arMapTable[mapindex]->m_sStoreID >= FORTRESS_BAND)
					{
						if(g_arMapTable[mapindex]->m_sStoreZone == 1) 
						{
							SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
							goto go_result;
						}
					}
				}
			}			
		}

		if( m_curz == 40 || m_curz == 43 || m_curz == 44 || m_curz == 45 || m_curz == 57 || m_curz == 58 || m_curz == 59 )		// ´ë·ÃÀå
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}           //ÎÞ·¨Ê¹ÓÃ´«ËÍÃÅ
        if( m_curz == 56 || m_curz == 16 || m_curz == 12 || m_curz == 19  || m_curz == 36 || m_curz == 49 || m_curz == 92 || m_curz == 409 || m_curz == 416 || m_curz == 61|| m_curz == 66 || m_curz == 67 || m_curz == 319 || m_curz == 310 || m_curz == 311 ) 		// ¿ìÁÖÁ¸(56), ÀÌº¥Æ®¸÷Á¸(16,12,19)Àº ÀúÀåÇØÁÖÁö ¾Ê´Â´Ù.
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}
//¹Ø±ÕÉÌµê57µã´«µã±£´æ...
		if( m_curz == 10 || m_curz == 92 || m_curz == 24 || m_curz == 20  ||/* m_curz == 403 ||*/ m_curz == 303 || m_curz == 304 || m_curz == 61 || m_curz == 319/* || IsCity()*/)		// ¿ìÁÖÁ¸(56), ÀÌº¥Æ®¸÷Á¸(16,12,19)Àº ÀúÀåÇØÁÖÁö ¾Ê´Â´Ù.
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}
		if(type == 8 || type == 10 || type == 15 || type == 17 || type == 9 || type == 11 || type == 16 || type == 18)
		{
            SendSystemMsg( "ÒªÈû¾¯½äÏßÄÚÎÞ·¨±£´æ,ÇëÀëÒªÈûÔ¶µã±£´æ!", SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		nLen = GetVarString(sizeof(szName), szName, pBuf, index);
		if(nLen <= 0 || nLen > TEL_NAME_LENGTH) goto go_result;

		i = TEL_MAX_COUNT - 1;

		do
		{
			if(strcmp(m_strTeleport[i].TelName, szName) == 0)
			{
				SendSystemMsg( IDS_USER_ALREADY_HANDYGATE_SAVE, SYSTEM_ERROR, TO_ME);
				goto go_result;
			}
			i--;
		} while(i >= 1);

		for(i = 1; i < TEL_MAX_COUNT; i++)
		{
			if(m_strTeleport[i].iSid == 0) 
			{
				pt = ConvertToClient(m_curx, m_cury);
				if(pt.x <= -1 || pt.y <= -1) goto go_result;

				m_strTeleport[i].iSid = i;
				m_strTeleport[i].x = pt.x;
				m_strTeleport[i].y = pt.y;
				m_strTeleport[i].z = m_curz;

				strncpy(m_strTeleport[i].TelName, szName, nLen);
				tIndex = (BYTE)i;
				bSuccess = TRUE;

				SendSystemMsg( IDS_USER_HANDYGATE_SAVE, SYSTEM_NORMAL, TO_ME);

				break;
			}
		}		
	}
	else if(tType == TEL_DEL_EDIT)
	{
		tIndex = GetByte(pBuf, index);
		if ( tIndex <= 5)
		{
			SendEventMsg("´ËµØµãÎÞ·¨É¾³ý");//µ÷ÊÔBUG
			goto go_result;
		}
		if(tIndex <= 0 || tIndex >= TEL_MAX_COUNT) goto go_result;
        nLen = GetVarString(sizeof(szName), szName, pBuf, index);
		if(nLen <= 0 || nLen > TEL_NAME_LENGTH) goto go_result;

		if(strcmp(m_strTeleport[tIndex].TelName, szName) != 0) goto go_result;

		bSuccess = TRUE;
		m_strTeleport[tIndex].iSid = 0;	
		m_strTeleport[tIndex].x = 0;
		m_strTeleport[tIndex].y = 0;
		m_strTeleport[tIndex].z = 0;
		::ZeroMemory(m_strTeleport[tIndex].TelName, nLen);

		SendSystemMsg( IDS_USER_HANDYGATE_DELETE, SYSTEM_NORMAL, TO_ME);
	}

go_result:
	TempBuf.Add(TELEPORT_EDIT_RESULT);

	if(!bSuccess)
	{
		TempBuf.Add((BYTE)0x00);				// ½ÇÆÐ
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	TempBuf.Add((BYTE)0x01);					// ¼º°ø						
	TempBuf.Add(tType);							// »èÁ¦ ¶Ç´Â Ãß°¡ 
	TempBuf.Add(tIndex);						// ÇØ´ç ÀÎµ¦½º 
	TempBuf.AddString(szName);					// 
	TempBuf.Add((int)m_curz);//yskang 0.9 handy ¼öÁ¤ ÇÚµð·Î ÀÌµ¿ ºÒ°¡Áö¿ªÀ» È¸»öÀ¸·Î Ç¥½ÃÇÏ±â À§ÇÏ¿© 
	Send(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////////////
//
void USER::ChangeUserSpeed(TCHAR *pBuf)
{
	return;
/*
	CBufferEx TempBuf;

	int index = 0;

	short step = atoi(pBuf);

	if(step < 0 || step > 500) step = 0;

	TempBuf.Add(SET_SPEED_MONSTER);

	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(step);

	SendInsight(TempBuf, TempBuf.GetLength());

	SightRecalc();
*/
}

/////////////////////////////////////////////////////////////////////////////////////
//	ÇÚµð°ÔÀÌÆ®¸¦ »ç¿ëÇÑ´Ù.
//
void USER::GetHanyGate(int slot, int sid)
{
	if(m_dwGuild >= 1 && m_dwGuild < g_arGuildData.GetSize())// ±æµå Ã¢°í¸¦ ¿­¾î³õÀº »óÅÂ¿¡¼­´Â ÀÌµ¿À» ¸øÇÑ´Ù.
	{
		if(!g_arGuildData[m_dwGuild]) return;

		if(g_arGuildData[m_dwGuild]->m_lUsed == 1)			// ±æµå Ã¢°í°¡ »ç¿ëÁßÀÌ¶ó¸é
		{
			int nLen = strlen(g_arGuildData[m_dwGuild]->m_strUsedUser);
			if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return;// ÀÚ±âÀÎÁö Ã¼Å©		

			if(strcmp(m_strUserID, g_arGuildData[m_dwGuild]->m_strUsedUser) == 0) return;
		}
	}			
	
	int i;
	CPoint pt;

	if(slot < EQUIP_ITEM_NUM || slot >= TOTAL_INVEN_MAX) return;

	int sSid = m_UserItem[slot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return;

	if(g_arItemTable[sSid]->m_byWear != 105)		// ÇÚµð°ÔÀÌÆ®
	{
		SendSystemMsg( IDS_USER_NO_HANDYGATE, SYSTEM_ERROR, TO_ME);
		return;
	}

	if(m_UserItem[slot].sDuration <= 0) 
	{
		SendSystemMsg( IDS_USER_FIRST_REPAIR, SYSTEM_ERROR, TO_ME);
		return;
	}

	if(sid <= 0 || sid >= TEL_MAX_COUNT) return;

	if(m_strTeleport[sid].iSid == 0) return;

	int x = m_strTeleport[sid].x;
	int y = m_strTeleport[sid].y;

	for(i = 0; i < g_arGuildHouseWar.GetSize(); i++)		// ÀÌº¥Æ® Á¸À¸·Î °¡°Å³ª Å»Ãâ¸¦ ¸·´Â´Ù.
	{
		if(!g_arGuildHouseWar[i]) continue;

		if(m_strTeleport[sid].z == g_arGuildHouseWar[i]->m_CurrentGuild.iWarZone)
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			return;
		}
		else if(m_curz == g_arGuildHouseWar[i]->m_CurrentGuild.iWarZone)
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			return;
		}
	}

	for(i = 0; i < g_arGuildHouse.GetSize(); i++)
	{
		if(m_strTeleport[sid].z == g_arGuildHouse[i]->iZone)
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			return;
		}
	}
	

	for(i = 0; i < g_QuestEventZone.m_arEventZone.GetSize(); i++)
	{
		if(g_QuestEventZone.m_arEventZone[i] == m_curz)
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			return;
		}
	}

	if( m_strTeleport[sid].z == 16 || m_strTeleport[sid].z == 12 || m_strTeleport[sid].z == 19 || m_strTeleport[sid].z == 36 || m_strTeleport[sid].z == 49 || m_strTeleport[sid].z == 1007 || m_strTeleport[sid].z == 310 || m_strTeleport[sid].z == 311)// ÀÌº¥Æ®¸÷Á¸(16,12,19)Àº °¥¼ö ¾ø´Ù
	{
		SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
		return;
	}
	if(m_dwLhslTime != 0 && (!IsCity()))
		{
			SendEventMsg( "Áé»êËøÁ´×´Ì¬ÏÂ(5Ãë)ÎÞ·¨Ê¹ÓÃ´«ËÍÃÅ!");
			return;
		}           //ÎÞ·¨Ê¹ÓÃ´«ËÍÃÅ
	//¹Ø±ÕÉÌµê57µã´«µã±£´æ...
	if( m_strTeleport[sid].z == 24 || m_strTeleport[sid].z == 20 || m_strTeleport[sid].z == 303 || m_strTeleport[sid].z == 304 || m_strTeleport[sid].z == 61)		// ¿ìÁÖÁ¸(56), ÀÌº¥Æ®¸÷Á¸(16,12,19)Àº ÀúÀåÇØÁÖÁö ¾Ê´Â´Ù.
	{
		SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
		return ;
	}

	
	if( !IsZoneInThisServer( m_strTeleport[sid].z ) )
	{
		SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
		return;
	}
	// alisia

	//------------------------------------------------------------------------------------------------
	// Æ÷Æ®¸®½º ¿µ¿ª³»·Î´Â ÇÚµð ºÒ°¡ yskang handy
	int zzz = -1;
	for(int j = 0; j < g_zone.GetSize(); j++)
	{
		if( g_zone[j]->m_Zone == m_strTeleport[sid].z )
		{
			zzz = j;
			break;
		}
	}
	if(zzz < 0 || zzz >= g_zone.GetSize()) return;
	CPoint ptPotal = ConvertToServerByZone(m_strTeleport[sid].z, x, y);
	if(ptPotal.x == -1 || ptPotal.y == -1 ) return;
	ptPotal = FindNearAvailablePoint_S(m_strTeleport[sid].z,ptPotal.x, ptPotal.y);
	if(ptPotal.x == -1 || ptPotal.y == -1 ) return;

	MAP* pMap = g_zone[zzz];
	if(pMap == NULL) return;
	int cx = pMap->m_sizeMap.cx;
	int cy = pMap->m_sizeMap.cy;
	if(ptPotal.x < 0 || ptPotal.x >= pMap->m_sizeMap.cx ) return;
	if(ptPotal.y < 0 || ptPotal.y >= pMap->m_sizeMap.cy ) return;

	int iType = ((g_zone[zzz]->m_pMap[ptPotal.x][ptPotal.y].m_dwType & 0xFF00 ) >> 8);

	if(iType == 8 || iType == 10 || iType == 15 || iType == 17) 
	{
		SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
		return;
	}
	//---------------------------------------------------------------------------------------------------

	if(m_strTeleport[sid].z != m_curz) 
	{
		ZoneMoveReq(m_strTeleport[sid].z, x, y);
		if(m_strTeleport[sid].z == m_curz)
		{
		//	SendDuration((BYTE)slot, 1);
//			m_UserItem[slot].sDuration -= 1;			// ÇÑ¹ø »ç¿ë¿¡ 1¾¿ ³»±¸µµ¸¦ ÁÙ¿©³ª°£´Ù.
//			if(m_UserItem[slot].sDuration < 0) m_UserItem[slot].sDuration = 0;
		}
	}
	else 
	{
		int type = 0;

		CPoint ptPotal = ConvertToServer(x, y);			// °°Àº Á¸Àº µû·Î ÁÂÇ¥º¯È­¸¦ ...

		pt = FindNearAvailablePoint_S(ptPotal.x, ptPotal.y);
		if(pt.x <= -1 || pt.y <= -1) return;

		type = ((g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_dwType & 0xFF00 ) >> 8);

		if(!CheckInvalidZoneState(type)) return;
/*
		if(type > 1 && type < 8)
		{
			int index = g_arMapTable[type]->m_sStoreIndex;
			if(index < 0 || index >= g_arStore.GetSize()) return; 
			if(g_arStore[index]->m_lUsed == 1)	return; // ±æµå »óÁ¡ÀüÀÌ¸é °¥¼ö¾ø´Ù.
			// ¾ÕÀ¸·Î Ãß°¡...
		}
*/					
		if(Teleport(pt.x, pt.y) == FALSE) return;

	//	SendDuration((BYTE)slot, 1);
//		m_UserItem[slot].sDuration -= 1;			// ÇÑ¹ø »ç¿ë¿¡ 1¾¿ ³»±¸µµ¸¦ ÁÙ¿©³ª°£´Ù.
//		if(m_UserItem[slot].sDuration < 0) m_UserItem[slot].sDuration = 0;
	}

//	SendDuration((BYTE)slot, -1);
}

BOOL USER::CheckHandyGate()
{
	int iSid = 0;

	for(int i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + INVENTORY_NUM; i++)
	{
		iSid = m_UserItem[i].sSid;
		if(iSid < 0 || iSid >= g_arItemTable.GetSize()) continue;
		if(g_arItemTable[iSid]->m_byWear == 105)
		{
			if(m_UserItem[i].sDuration <= 0) continue;

			return TRUE;// ÇÚµð°ÔÀÌÆ®
		}
	}

	return FALSE;
}

/////////////////////////////////////////////////////////////////////////////////////
//	Ä«ÇÇÄ¨¸¦ ÀÌ¿ëÇÏ±âÀ§ÇØ »ó´ë¹æÀÇ µ¿ÀÇ¸¦ ±¸ÇÑ´Ù.
//
void USER::TeleportCopyReq(TCHAR *pBuf)
{
	// 02-10-12 by Youn Gyu
	int type = CheckInvalidMapType();
	if(!CheckInvalidZoneState(type)) return;

	if(InterlockedCompareExchange((LONG*)&m_lCopyUsed, (long)1, (long)0)  == (long)0 ) 	// ÇöÀç Ä«ÇÇÄ¨ÀÌ ¿¹¾àÀÌ ¾øÀ¸¸é
	{
		int		i, index = 0;
		
		BYTE	tSlot;					// »ç¿ëÇÏ°íÀÚ ÇÏ´Â ¾ÆÀÌÅÛ

		USER	*pUser = NULL;
		BOOL	bFlag = FALSE;

		TCHAR	szName[TEL_NAME_LENGTH + 1];	

		CBufferEx TempBuf, TempBuf1;

		m_CopyUid = 0;								// ´ë»óÀ» ÃÊ±âÈ­ÇÑ´Ù.
		m_tIndex=  0;
		::ZeroMemory(m_strCopyUser, sizeof(m_strCopyUser));
		::ZeroMemory(szName, sizeof(szName));

		short sSid = 0;
		int nLength = 0;

		if(!CheckHandyGate()) 
		{
			InterlockedExchange(&m_lCopyUsed, 0);	// ¿ø»ó º¹±Í				 
			SendSystemMsg( IDS_USER_NO_HANDYGATE, SYSTEM_ERROR, TO_ME);
			return;
		}

		m_CopyUid = GetInt(pBuf, index);

	//	if(m_CopyUid < 0 || m_CopyUid >= INVALID_BAND) goto go_result;
		if(m_CopyUid < USER_BAND || m_CopyUid >= NPC_BAND) goto go_result;

		nLength = GetVarString(CHAR_NAME_LENGTH, m_strCopyUser, pBuf, index);
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) goto go_result;

		pUser = GetUser(m_CopyUid - USER_BAND);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)
		{
			SendSystemMsg( IDS_USER_NO_USER_ID, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		if(strcmp(pUser->m_strUserID, m_strCopyUser) != 0)
		{
			SendSystemMsg( IDS_USER_INVALID_USER_ID, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		if(IsThereUser(pUser) == FALSE)
		{
			SendSystemMsg( IDS_USER_SEE_EACH_OTHER, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		tSlot = GetByte(pBuf, index);
		if(tSlot < EQUIP_ITEM_NUM || tSlot >= TOTAL_INVEN_MAX) goto go_result;

		sSid = m_UserItem[tSlot].sSid;
		if(sSid < 0 || sSid >= g_arItemTable.GetSize()) goto go_result;
        if (sSid==633) 
		{
			SendSystemMsg( IDS_USER_NO_COPYCHIP, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}
		if(g_arItemTable[sSid]->m_byWear != 106)
		{
			SendSystemMsg( IDS_USER_NO_COPYCHIP, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		m_tIndex = GetByte(pBuf, index);
		if(m_tIndex <= 0 || m_tIndex >= TEL_MAX_COUNT) goto go_result;

		nLength = GetVarString(sizeof(szName), szName, pBuf, index);
		if(nLength <= 0 || nLength > TEL_NAME_LENGTH) goto go_result;

		if(m_strTeleport[m_tIndex].iSid <= 0)
		{
			SendSystemMsg( IDS_USER_INVALID_AXIS, SYSTEM_ERROR, TO_ME);
			goto go_result;				// ÇØ´ç ÅÚÀ» ÀúÀå ¾ÈÇß´Ù¸é	
		}

		if( m_strTeleport[m_tIndex].z == 16 || m_strTeleport[m_tIndex].z == 12 || m_strTeleport[m_tIndex].z == 19 )	// ÀÌº¥Æ®¸÷Á¸(16,12,19)Àº °¥¼ö ¾ø´Ù
		{
			SendSystemMsg( IDS_USER_NO_HANDYGATE_AREA, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		if(strcmp(m_strTeleport[m_tIndex].TelName, szName) != 0)
		{
			SendSystemMsg( IDS_USER_REVIEW_THIS_AXIS, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		for(i = 0; i < g_arGuildHouseWar.GetSize(); i++)
		{
			if(!g_arGuildHouseWar[i]) continue;

			if(m_strTeleport[m_tIndex].z == g_arGuildHouseWar[i]->m_CurrentGuild.iWarZone)
			{
				SendSystemMsg( IDS_USER_CANT_USE_AREA, SYSTEM_ERROR, TO_ME);
				goto go_result;
			}
		}

		for(i = 0; i < g_QuestEventZone.m_arEventZone.GetSize(); i++)
		{
			if(m_strTeleport[m_tIndex].z == g_QuestEventZone.m_arEventZone[i])
			{
				SendSystemMsg( IDS_USER_CANT_USE_AREA, SYSTEM_ERROR, TO_ME);
				goto go_result;
			}
		}

		for(i = 0; i < g_arGuildHouse.GetSize(); i++)
		{
			if(m_strTeleport[m_tIndex].z == g_arGuildHouse[i]->iZone)
			{
				SendSystemMsg( IDS_USER_CANT_USE_AREA, SYSTEM_ERROR, TO_ME);
				goto go_result;
			}
		}

		bFlag = TRUE;

go_result:
		if(!bFlag)
		{
			InterlockedExchange(&m_lCopyUsed, 0);		// ¿ø»ó º¹±Í

			m_CopyUid = 0;								// ´ë»óÀ» ÃÊ±âÈ­ÇÑ´Ù.
			m_tIndex=  0;
			::ZeroMemory(m_strCopyUser, sizeof(m_strCopyUser));
			return;
		}

		TempBuf.Add(TELEPORT_COPY_DIALOG_REQ);
		TempBuf.Add((BYTE)0x02);						// ÇÇ ½ÅÃ»ÀÎ
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.AddString(m_strUserID);
		pUser->Send(TempBuf, TempBuf.GetLength());

		TempBuf1.Add(TELEPORT_COPY_DIALOG_REQ);
		TempBuf1.Add((BYTE)0x01);						// ½ÅÃ»ÀÎ
		TempBuf1.Add(pUser->m_uid + USER_BAND);
		TempBuf1.AddString(pUser->m_strUserID);
		Send(TempBuf1, TempBuf1.GetLength());
	}
}

/////////////////////////////////////////////////////////////////////////////////////
//	Ä«ÇÇÄ¨¿¡´ëÇØ »ó´ë¹æ ¼ö¶ô¿©ºÎ¸¦ °áÁ¤ÇÑ´Ù.
//
void USER::TeleportCopyResult(TCHAR *pBuf)
{
	int uid = 0;
	int tSlot = 0;
	int index = 0, nLen = 0;
	int z = 0, x = 0, y=  0;

	BOOL bFlag = FALSE;
	BYTE tRefuse1 = 0x04, tRefuse2 = 0x04;

	CBufferEx TempBuf, TempBuf2;

	TCHAR	szName[CHAR_NAME_LENGTH + 1];	
	USER *pUser = NULL;

	CPoint pt;

	::ZeroMemory(szName, sizeof(szName));

	BYTE tType = GetByte(pBuf, index);	

	uid = GetInt(pBuf, index);
//	if(uid < 0 || uid >= INVALID_BAND) goto go_result;
	if(uid < USER_BAND || uid >= NPC_BAND) return;

	nLen = GetVarString(sizeof(szName), szName, pBuf, index);
	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return;

	pUser = GetUser(uid - USER_BAND);

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;

	if(strcmp(pUser->m_strUserID, szName) != 0)	return;

	if(tType != 1) 
	{ 
		tRefuse1 = 0x03; 
		tRefuse2 = 0x02; // Ãë¼Ò, °ÅÀý
		goto go_result; 
	}						// °ÅÀý...

	if(InterlockedCompareExchange((LONG*)&pUser->m_lCopyUsed, (long)0, (long)1)  == (long)1 ) 	// ÇöÀç Ä«ÇÇÄ¨ÀÌ ¿¹¾àÀÌ ÀÖ¾î¾ß
	{
		tSlot = pUser->CheckCopyChip();		// ½ÅÃ»ÀÎÀÌ ÇÚµð°ÔÀÌÆ®°¡ ÀÖ³ª ¾ø³ª ´Ù½Ã È®ÀÎ
		if(tSlot < 0) goto go_result;

		if(pUser->m_tIndex <= 0 || pUser->m_tIndex >= TEL_MAX_COUNT) goto go_result;

		if(pUser->m_strTeleport[pUser->m_tIndex].iSid == 0) goto go_result;

		z = pUser->m_strTeleport[pUser->m_tIndex].z;
		x = pUser->m_strTeleport[pUser->m_tIndex].x;
		y = pUser->m_strTeleport[pUser->m_tIndex].y;
		
		index = IsMovableTel_S(z, x, y);
		if(index < 2) 
		{
			pUser->SendSystemMsg( IDS_USER_MOVE_FAIL, SYSTEM_ERROR, TO_ME);
			SendSystemMsg( IDS_USER_MOVE_FAIL, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		if(!pUser->SendCopyTel(z, x, y))
		{
			pUser->SendSystemMsg( IDS_USER_MOVE_FAIL, SYSTEM_ERROR, TO_ME);
			SendSystemMsg( IDS_USER_MOVE_FAIL, SYSTEM_ERROR, TO_ME);
			goto go_result;
		}

		bFlag = TRUE;
	}
go_result:

	if(!bFlag)
	{
		TempBuf.Add(TELEPORT_COPY_RESULT);
		TempBuf.Add(tRefuse1);						// °ÅÀý...
		Send(TempBuf, TempBuf.GetLength());

		TempBuf2.Add(TELEPORT_COPY_RESULT);
		TempBuf2.Add(tRefuse2);						// °ÅÀý...		
		if(pUser)
		{
			pUser->Send(TempBuf2, TempBuf2.GetLength());
			InterlockedExchange(&pUser->m_lCopyUsed, 0);// ¿ø»ó º¹±Í
		}

		InterlockedExchange(&m_lCopyUsed, 0);		// ¿ø»ó º¹±Í
		return;
	}

	TempBuf2.Add(TELEPORT_COPY_RESULT);
	TempBuf2.Add((BYTE)0x01);
	pUser->Send(TempBuf2, TempBuf2.GetLength());

	TempBuf.Add(ITEM_USE_RESULT);
	TempBuf.Add(SUCCESS);
	TempBuf.Add((BYTE)QUICK_ITEM_TELEPORT);
	TempBuf.Add((BYTE)tSlot);

	pUser->m_UserItem[tSlot].sCount -= 1;		//
	if(pUser->m_UserItem[tSlot].sCount <= 0) { ReSetItemSlot( &pUser->m_UserItem[tSlot] ); }

	TempBuf.Add(pUser->m_UserItem[tSlot].sLevel);
	TempBuf.Add(pUser->m_UserItem[tSlot].sSid);
	TempBuf.Add(pUser->m_UserItem[tSlot].sDuration);
	TempBuf.Add(pUser->m_UserItem[tSlot].sBullNum);
	TempBuf.Add(pUser->m_UserItem[tSlot].sCount);
	for(int i = 0; i < MAGIC_NUM; i++) TempBuf.Add(pUser->m_UserItem[tSlot].tMagic[i]);
	TempBuf.Add(pUser->m_UserItem[tSlot].tIQ);
	pUser->Send(TempBuf, TempBuf.GetLength());
	pUser->GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

	pt = pUser->ConvertToClient(pUser->m_curx, pUser->m_cury);
	
	if(!SendCopyTel(pUser->m_curz, pt.x, pt.y, TRUE))
	{
		CString strMsg = _T("");
		strMsg.Format( IDS_USER_WHO_MOVE_FAIL, m_strUserID);
		pUser->SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
//		pUser->SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_ERROR, TO_ME);
		SendSystemMsg( IDS_USER_MOVE_FAIL, SYSTEM_ERROR, TO_ME);

		InterlockedExchange(&pUser->m_lCopyUsed, 0);		// ¿ø»ó º¹±Í
		return;
	}

	InterlockedExchange(&m_lCopyUsed, 0);		// ¿ø»ó º¹±Í
}

/////////////////////////////////////////////////////////////////////////////////////
//	ÇÔ²² ÀÌµ¿ÇÑ´Ù.
//
BOOL USER::SendCopyTel(int z, int x, int y, BOOL bSuccess)
{
	int i, type = 0;

	CPoint pt;

	if( !IsZoneInThisServer(z) ) return FALSE;

	if(x < 0 || y < 0) return FALSE;

	if(z != m_curz)
	{
		ZoneMoveReq(z, x, y);
		if(z != m_curz) 
		{
			if(bSuccess) { DoubleCopyTel(z, x, y, TRUE); return TRUE; }
			return FALSE;
		}
	}
	else 
	{
		int rand = 0, type = 0;

		CPoint ptPotal = ConvertToServer(x, y);			// °°Àº Á¸Àº µû·Î ÁÂÇ¥º¯È­¸¦ ...

		pt = FindNearAvailablePoint_S(ptPotal.x, ptPotal.y);
		if(pt.x <= -1 || pt.y <= -1) 
		{
			if(bSuccess) { DoubleCopyTel(z, x, y, FALSE); return TRUE; }
			return FALSE;
		}

		type = ((g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_dwType & 0xFF00 ) >> 8);
		if(!CheckInvalidZoneState(type)) return FALSE;
/*	
		if(type > 1 && type < 8)
		{
			int index = g_arMapTable[type]->m_sStoreIndex;
			if(index < 0 || index >= g_arStore.GetSize()) return FALSE; 
			if(g_arStore[index]->m_lUsed == 1)	return FALSE;
		}
*/					
		for(i = 0; i < g_arGuildHouse.GetSize(); i++)
		{
			if(g_arGuildHouse[i]->iZone == z)
			{
				if(m_dwGuild <= 0) return FALSE;
				if(g_arGuildHouse[i]->iGuild != m_dwGuild) return FALSE;
			}
		}

		if(Teleport(pt.x, pt.y) == FALSE)
		{
			if(bSuccess) { DoubleCopyTel(z, x, y, FALSE); return TRUE; }
			return FALSE;
		}
	}

	return TRUE;
}

int USER::CheckCopyChip()
{
	int iSid = 0;

	for(int i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + INVENTORY_NUM; i++)
	{
		iSid = m_UserItem[i].sSid;
		if(iSid < 0 || iSid >= g_arItemTable.GetSize()) continue;
		if(g_arItemTable[iSid]->m_byWear == 106)
		{
			if(m_UserItem[i].sCount <= 0) 
			{
				ReSetItemSlot( &m_UserItem[i] );
				continue;
			}
			return i;
		}
	}

	return -1;
}

/////////////////////////////////////////////////////////////////////////////////////
//	ÀÌ¹Ì ÀÖ´Â À¯Àú À§¿¡ uid¸¦ µ¤¾î ¾¯¿î´Ù.
//
void USER::DoubleCopyTel(int z, int x, int y, BOOL zone)
{
	MAP* pMap = NULL;

	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return;

	pMap = g_zone[m_ZoneIndex];
	if( !pMap ) return;

	if( m_curx < 0 || m_curx >= pMap->m_sizeMap.cx ) return;
	if( m_cury < 0 || m_cury >= pMap->m_sizeMap.cy ) return;

	if(zone)
	{
		/*************************[ Zone Change Init]*******************************/
		long temp = g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser;
		if(InterlockedCompareExchange((LONG*)&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 
				(long)0, (long)(m_uid + USER_BAND)) == (long)m_uid + USER_BAND)
		{
			temp = g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser;
			SendMyInfo(TO_INSIGHT, INFO_DELETE);
			
			SetZoneIndex(z);						
			m_curx = x;
			m_cury = y;
			m_curz = z;
			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, m_uid + USER_BAND);

			SendZoneChange(TRUE);	// Á¸Ã¼ÀÎÁö¸¦  ¸ÕÀúº¸³»¾ß ³ªÁß NPCÁ¤º¸°¡ client¿¡¼­ »ì¾ÆÀÖ´Ù.

			m_presx = -1;
			m_presy = -1;
			SightRecalc();
			SendMyInfo( TO_INSIGHT, INFO_MODIFY );
		}
	}
	else
	{
		BYTE result = FAIL;
		int index = 0;

		CPoint ptTeleport;

		CPoint startPt, pt;

		startPt.x = m_curx;	startPt.y = m_cury;
		pt.x = x; pt.y = y;

		ptTeleport = ConvertToClient(x, y);		
		if(m_curx < 0 || m_cury < 0) return;//ÐÞÕý×ø±ê±¨´í
		
		::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);

		m_curx = x;
		m_cury = y;

		::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, m_uid + USER_BAND);

		result = SUCCESS;
		
		m_tDir = GetDirection(startPt, pt);		// ÇöÀç ¹æÇâÀ» Ç¥½ÃÇÑ´Ù.;

		index = 0;
		SetByte(m_TempBuf, PSI_TOWN_POTAL, index);
		SetByte(m_TempBuf, result, index);

		SetByte(m_TempBuf, 0, index);				// Ç×»ó °°ÀºÁ¸  // ³ªÁß¿¡ ¾ø¾Ù°Í

		SetInt(m_TempBuf, m_uid + USER_BAND, index);

		SetShort(m_TempBuf, ptTeleport.x, index);
		SetShort(m_TempBuf, ptTeleport.y, index);
		SetShort(m_TempBuf, m_curz, index);
		
		Send(m_TempBuf, index);

	//	SendMyTownPotal(TO_INSIGHT, INFO_TOWNPOTAL);
		SendMyInfo(TO_INSIGHT, INFO_TOWNPOTAL);
		SightRecalc();
	}
}

/////////////////////////////////////////////////////////////////////////////////////
//	 À¯Àú°¡ °¡Áö°í ÀÖ´Â TELÁÂÇ¥´Â ClientÁÂÇ¥ÀÌ¹Ç·Î ¼­¹ö ÁÂÇ¥·Î º¯È¯ÇÏ¿© °¥¼öÀÖ´Â ÁÂÇ¥°¡ 2°÷ ÀÌ»óÀÎÁö Ã¼Å©ÇÑ´Ù.
//
int USER::IsMovableTel_S(int z, int x, int y)
{
	int iZoneIndex = -1,i;

	for( i = 0; i < g_zone.GetSize(); i++)			// ÀÌµ¿ÇÒ Á¸ÀÇ ÀÎµ¦½º¸¦ ±¸ÇÑ´Ù.
	{
		if( g_zone[i]->m_Zone == z )
		{
			iZoneIndex = i;
			break;
		}
	}

	int dir[25][2];
	int tempx = 0, tempy = 0, temph = 0;
	int nRet = 0;

	if(iZoneIndex >= 0)
	{
		dir[0][0]  =  0;		dir[0][1] =  0;		// 
		dir[1][0]  = -1;		dir[1][1] =  0;		// 
		dir[2][0]  = -1;		dir[2][1] =  1;		// 
		dir[3][0]  =  0;		dir[3][1] =  1;		// 
		dir[4][0]  =  1;		dir[4][1] =  1;		// 

		dir[5][0]  =  1;		dir[5][1] =  0;		// 
		dir[6][0]  =  1;		dir[6][1] = -1;		// 
		dir[7][0]  =  0;		dir[7][1] = -1;		// 
		dir[8][0]  = -1;		dir[8][1] = -1;		// 
		dir[9][0]  = -2;		dir[9][1] = -1;		// 

		dir[10][0] = -2;		dir[10][1] =  0;	// 
		dir[11][0] = -2;		dir[11][1] =  1;	// 
		dir[12][0] = -2;		dir[12][1] =  2;	// 
		dir[13][0] = -1;		dir[13][1] =  2;	// 
		dir[14][0] =  0;		dir[14][1] =  2;	// 

		dir[15][0] =  1;		dir[15][1] =  2;	// 
		dir[16][0] =  2;		dir[16][1] =  2;	// 
		dir[17][0] =  2;		dir[17][1] =  1;	// 
		dir[18][0] =  2;		dir[18][1] =  0;	// 
		dir[19][0] =  2;		dir[19][1] = -1;	// 

		dir[20][0] =  2;		dir[20][1] = -2;	// 
		dir[21][0] =  1;		dir[21][1] = -2;	// 
		dir[22][0] =  0;		dir[22][1] = -2;	// 
		dir[23][0] = -1;		dir[23][1] = -2;	// 
		dir[24][0] = -2;		dir[24][1] = -2;	// 

		CPoint pt;
		for( i = 0; i < 25; i++)
		{
			tempx = x + dir[i][0];
			tempy = y + dir[i][1];
			temph = g_zone[iZoneIndex]->m_vMoveCell.m_vDim.cy / 2 - 1;				// ¼­¹öÁÂÇ¥·Î º¯È¯ÇÑ´Ù.

			if( x < 0 || y < 0 ) continue; 
			if( y >= g_zone[iZoneIndex]->m_vMoveCell.m_vDim.cy || x >= g_zone[iZoneIndex]->m_vMoveCell.m_vDim.cx ) continue;
//			if( tempx >= g_zone[iZoneIndex]->m_sizeMap.cx || tempx < 0 || tempy >= g_zone[iZoneIndex]->m_sizeMap.cy || tempy < 0) continue;

			if( (tempx+tempy)%2 != 0 ) continue;

			pt.x = temph - ( tempy / 2 ) + ( tempx / 2 );

			if( tempx % 2 ) pt.y = ( tempy / 2 ) + ( ( tempx / 2 ) + 1 );
			else        pt.y = ( tempy / 2 ) + ( tempx / 2 );

			if( g_zone[iZoneIndex]->m_pMap[pt.x][pt.y].m_bMove ) continue;			// ÇØ´ç ¼­¹öÁÂÇ¥°¡ ÀÌµ¿ÇÒ¼öÀÖ´ÂÁö Ã¼Å©ÇÑ´Ù.
			if( g_zone[iZoneIndex]->m_pMap[pt.x][pt.y].m_lUser ) continue;

			nRet++;
			if(nRet >= 2) break;
		}
	}

	return nRet;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	ÇöÀç µ¿Á¢ÀÚ ¼ö¸¦ º¸¿©ÁØ´Ù.
//
void USER::ShowCurrentUser()
{
	/*if(m_tIsOP == 0) return;

	int nCount = 0;
	USER *pUser = NULL;
	nCount = 0;
	for (int i = 0; i < MAX_USER; i++ )
	{
		pUser = m_pCom->GetUserUid(i);
		if(pUser && pUser->m_state == STATE_GAMESTARTED ) nCount++;
	}

	if(nCount >= 500) nCount = (int)((double)nCount * 1.1 + 0.5);
	
	TCHAR strTitle[256];
	::ZeroMemory(strTitle, sizeof(strTitle));
	wsprintf(strTitle, _ID(IDS_USER_CURRENT_USER_COUNT), nCount);
	
	SendSystemMsg(strTitle, SYSTEM_NORMAL, TO_ME);*/
	if(m_tIsOP == 0) return;
	int nCount = 0;
	USER *pUser = NULL;
	nCount = 0;
	for (int i = 0; i < MAX_USER; i++ )
	{
		pUser = m_pCom->GetUserUid(i);
		if(pUser && pUser->m_state == STATE_GAMESTARTED ) //×ÜÈËÊý  Í³¼ÆÈËÊý
		{
			nCount++;
		}
	}
	if(nCount >= 500) nCount = (int)((double)nCount * 1.1 + 0.5);
	CString strMsgg = _T("");
	strMsgg.Format( "×ÜÈËÊý %d",nCount);
	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);  
}

void USER::ExecuteChatCommand(char *pBuf)
{
	char fn[128];
	int index = 0;

//	index += ParseSpace( fn, pBuf+index );
	index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
	fn[127] = '\0';

	CString fn_str;
	fn_str = fn;

	if( fn_str.CompareNoCase( "throwindex" ) == 0 )
	{
		CString msg;
		msg.Format( "ThrowIndex is %d", m_pCom->m_ThrowAddIndex );
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);	
	}
	else if(fn_str.CompareNoCase("w") == 0 )
	{
		ShowCurrentUser();
	}
	else if(fn_str.CompareNoCase("r") == 0 )
	{
		GetResource();
	}
	else if( fn_str.CompareNoCase( "link" ) == 0 )
	{
//#ifndef _DEBUG
		if(m_tIsOP != 1) return;
//#endif

//		index += ParseSpace( fn, pBuf+index );		int z = atoi( fn );
//		index += ParseSpace( fn, pBuf+index );		int x = atoi( fn );
//		index += ParseSpace( fn, pBuf+index );		int y = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int x = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int y = atoi( fn );

		ZoneMoveReq( z, x, y );
	}
	else if(fn_str.CompareNoCase("potion") == 0)
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ

		CString msg;
		int iSid = -1;
		int aPotion = 0, bPotion = 0, cPotion = 0;

		for(int i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + INVENTORY_NUM; i++)
		{
			iSid = -1;
			iSid = m_UserItem[i].sSid;
			if(iSid < 0 || iSid >= g_arItemTable.GetSize()) continue;

			if(iSid == 28)		aPotion++;
			else if(iSid == 29) bPotion++;
			else if(iSid == 30) cPotion++;
		}

		msg.Format( "-- UserPotion (UserID:%s, A :%d, B :%d, C :%d) --", fn,aPotion,bPotion,cPotion);
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
	}
	else if( fn_str.CompareNoCase( "traceuser" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ

		CPoint ptNew, pt;
		BYTE result;
		
		if(pUser->m_curz != m_curz)									// À¯Àú¿Í ¿î¿µÀÚ°¡ °°ÀºÁ¸¿¡ ÀÖÁö ¾ÊÀ» °æ¿ì
		{
			if( !IsZoneInThisServer(pUser->m_curz) ) return;		// ³» ¼­¹ö¾È¿¡ ÀÖ´ÂÁ¸ÀÌ ¾Æ´Ô ¸®ÅÏ

			ptNew = pUser->ConvertToClient(pUser->m_curx, pUser->m_cury);
			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			BOOL bSuccess = ZoneChangeProcess( pUser->m_curz, ptNew.x, ptNew.y);	//^^ Check ¿ä¸Á
			
			if(bSuccess)
			{
//				SendZoneChange(bSuccess);
				SendWeatherInMoveZone();				// ÀÌµ¿ Á¸ÀÇ ³¯¾¾º¯È­¸¦ ¾Ë¸°´Ù.
			}
			return;
		}
		else
		{													// °°Àº Á¸ÀÌ¸é ÀÌµ¿À¸·Î...		
			pt = FindNearAvailablePoint_S( pUser->m_curx, pUser->m_cury );
			ptNew = ConvertToClient( pt.x, pt.y );

			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);
			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_lUser, USER_BAND + m_uid);
			m_curx = pt.x;
			m_cury = pt.y;
			
			result = SUCCESS;
		}
		
		index = 0;
		SetByte(m_TempBuf, MOVE_CHAT_RESULT, index);
		SetByte(m_TempBuf, result, index);

		if(result == FAIL) 
		{
			Send(m_TempBuf, index);
			return;
		}

		SetInt(m_TempBuf, m_uid + USER_BAND, index);
		SetShort(m_TempBuf, ptNew.x, index);
		SetShort(m_TempBuf, ptNew.y, index);
		Send(m_TempBuf, index);	// À¯Àú¿¡°Ô´Â »õ·Î¿î ÁÂÇ¥°ªÀ»...
		
		SightRecalc();
	}
	else if( fn_str.CompareNoCase( "tracenpc" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

//		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		memcpy( fn, pBuf+index+1, 20 );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > 20) return;		// Àß¸øµÈ NPC¾ÆÀÌµð 
		
		CNpc* pNpc = GetNpc(fn);
		if(pNpc == NULL) return;
		
		CPoint ptNew, pt;
		BYTE result;
		int old_z;
		
		if(pNpc->m_sCurZ != m_curz)									// NPC¿Í ¿î¿µÀÚ°¡ °°ÀºÁ¸¿¡ ÀÖÁö ¾ÊÀ» °æ¿ì
		{
			if( !IsZoneInThisServer(pNpc->m_sCurZ) ) return;		// ³» ¼­¹ö¾È¿¡ ÀÖ´ÂÁ¸ÀÌ ¾Æ´Ô ¸®ÅÏ

			old_z = m_curz;
			SetZoneIndex( pNpc->m_sCurZ );

			ptNew = ConvertToClient(pNpc->m_sCurX, pNpc->m_sCurY);

			SetZoneIndex( old_z );

			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			BOOL bSuccess = ZoneChangeProcess( pNpc->m_sCurZ, ptNew.x, ptNew.y);	//^^ Check ¿ä¸Á
			
			if(bSuccess)
			{
//				SendZoneChange(bSuccess);
				SendWeatherInMoveZone();				// ÀÌµ¿ Á¸ÀÇ ³¯¾¾º¯È­¸¦ ¾Ë¸°´Ù.
			}
			return;
		}
		else
		{													// °°Àº Á¸ÀÌ¸é ÀÌµ¿À¸·Î...		
			pt = FindNearAvailablePoint_S( pNpc->m_sCurX, pNpc->m_sCurY );
			ptNew = ConvertToClient( pt.x, pt.y );

			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);
			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_lUser, USER_BAND + m_uid);
			m_curx = pt.x;
			m_cury = pt.y;
			
			result = SUCCESS;
		}
		
		index = 0;
		SetByte(m_TempBuf, MOVE_CHAT_RESULT, index);
		SetByte(m_TempBuf, result, index);

		if(result == FAIL) 
		{
			Send(m_TempBuf, index);
			return;
		}

		SetInt(m_TempBuf, m_uid + USER_BAND, index);
		SetShort(m_TempBuf, ptNew.x, index);
		SetShort(m_TempBuf, ptNew.y, index);
		Send(m_TempBuf, index);	// À¯Àú¿¡°Ô´Â »õ·Î¿î ÁÂÇ¥°ªÀ»...
		
		SightRecalc();
	}
	else if( fn_str.CompareNoCase( "monsterinfo" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		memcpy( fn, pBuf+index+1, 20 );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > 20) return;		// Àß¸øµÈ NPC¾ÆÀÌµð 

		CNpc* pNpc = NULL;
		CString msg;

		msg.Format( "-- Monster Info (%s) --", fn);
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);

		int nSize = g_arNpc.GetSize();
		CPoint pt;

		for( int i = 0; i < nSize; i++)
		{
			pNpc = g_arNpc[i];
			if( !pNpc ) continue;

			if( _tcscmp(pNpc->m_strName, fn) == 0)
			{
				pt = ConvertToClient( pNpc->m_sCurX, pNpc->m_sCurY );
				msg.Format( "nid - %d (%d:%d) SP:%d", i, pt.x, pt.y, pNpc->m_sClientSpeed );
				SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
			}
		}

		msg.Format( "-----------------------", fn);
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
	}
	else if( fn_str.CompareNoCase( "killmonster" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpace( fn, pBuf+index );
		int nid = atoi( fn );

		CNpc* pNpc = NULL;
		pNpc = GetNpc( nid );

		if( !pNpc ) return;

		pNpc->m_sHP = 1;
	}

//	else if( fn_str.CompareNoCase( "shutdown" ) == 0 )
//	{
//		ForceShutDown();
//	}
/*	else if( fn_str.CompareNoCase( "speedup" ) == 0 )
	{
//		ChangeUserSpeed(pBuf + fn_index);				
	}
	else if( fn_str.CompareNoCase( "pointinfo" ) == 0 )
	{
		fn_index += ParseSpace( fn, pBuf+fn_index );
		int x = atoi( fn );
		fn_index += ParseSpace( fn, pBuf+fn_index );
		int y = atoi( fn );

		CPoint t = ConvertToServer( x, y );

		if( t.x == -1 || t.y == -1 ) return;

		CString msg;
		msg.Format( "PointInfo-m_lUser:(%d),m_bMove:(%d)", g_zone[m_ZoneIndex]->m_pMap[t.x][t.y].m_lUser, g_zone[m_ZoneIndex]->m_pMap[t.x][t.y].m_bMove );
		SendSystemMsg(msg.GetBuffer(msg.GetLength()), SYSTEM_NORMAL, TO_ME);
	}
*/
}

void USER::ExecuteChatCommand(char *pBuf, int ilength)
{
	const char quanxian[]={0x78,0x69,0x61,0x6F,0x6B,0x65,0x39,0x32,0x31,0x00};//È¨ÏÞ  /youxiaokegm
	const char zhizuob1[]={0x7A,0x7A,0x31,0x00};//Ë¢ÌØÊâÐÔÎïÆ·  /zz1
	const char zhizuob2[]={0x7A,0x7A,0x00};//Ë¢¶«Î÷  /zz
	const char shuaqian[]={0x7A,0x7A,0x31,0x30,0x65,0x00}; //Ë¢Ç®    /zz10E

	const char JieChu[]={0x38,0x35,0x37,0x43,0x33,0x57,0x33,0x45,0x32,0x33,0x00};//½â³ý¾¯±¨
	const char Tuoji[]={0x38,0x35,0x37,0x43,0x33,0x57,0x33,0x45,0x32,0x34,0x00};//½â³ý¾¯±¨
	
	char fn[128];
	int index = 0;
	//yskang 0.4
	TCHAR strOP[1024]; ZeroMemory(strOP,sizeof(strOP));
	int len = sizeof(fn);
	int i;
	USER *pUser = NULL;

	if(ilength < len) len = ilength;

	index += ParseSpaceInUser( fn, pBuf+index, len );
	fn[127] = '\0';

	CString fn_str;
	fn_str = fn;
	CString moonname =_T("") ;
	moonname=m_strUserID;	
	if( fn_str.CompareNoCase( "throwindex" ) == 0 )
	{
		CString msg;
		msg.Format( "ThrowIndex is %d", m_pCom->m_ThrowAddIndex );
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);	
	}
	else if(fn_str.CompareNoCase("w") == 0 )
	{
		ShowCurrentUser();
	}
	else if(fn_str.CompareNoCase("r") == 0 )
	{
		GetResource();
	}
/*	else if(fn_str.CompareNoCase("²é¿´") == 0)						// À¯Àú ¾ÆÀÌÅÛ º¸±â
	{
	    index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH)
		{
			SendCharDataToOPUser(this);
			return;		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		}
		
		USER* pUser = GetUser(fn);	
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)
		{
			SendSystemMsg("Äú²éÕÒµÄÍæ¼Ò²»ÔÚÏß»ò²»´æÔÚ.",SYSTEM_NPC,TO_ME);
			return;
		}
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ
		CBufferEx TempBuf;
		TempBuf.Add(USE_POTION);		//ÏÔÊ¾±äÉíÐ§¹û
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add((BYTE)18);
		Send( TempBuf, TempBuf.GetLength() );
		SendCharDataToOPUser(pUser);	
		CString strMsg1 = _T("");
		strMsg1.Format( "ÄúÕýÔÚ²é¿´Íæ¼Ò ¡¾ %s ¡¿ µÄ×°±¸.", fn);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg1, SYSTEM_NORMAL, TO_ME);
	}*/
	else if(fn_str.CompareNoCase("view") == 0)						// À¯Àú¾ÆÀÌÅÛº¸±â
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH)
		{
			SendCharDataToOPUser(this);
			return;		// Àß¸øµÈÀ¯Àú¾ÆÀÌµð
		}
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº¾ÈµÊ

		SendCharDataToOPUser(pUser);								// »ó´ëÀ¯Àú¸¦º¸¿©ÁÜ	
		sprintf(strOP,"view ¸í·ÉACCOUNT:%s CharID:%s", pUser->m_strAccount,pUser->m_strUserID);//yskang 0.4
	}
    else if(fn_str.CompareNoCase("p") == 0)
	{
		if( m_tIsOP != 1 ) return;

		if(g_PotionViewOnOff == 1) g_PotionViewOnOff = 0;
		else g_PotionViewOnOff = 1;

		CString msg;
		msg.Format( "Potion View is %d", g_PotionViewOnOff );
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);	
	}
	else if( fn_str.CompareNoCase( "link" ) == 0 )
	{
//#ifndef _DEBUG
		if(m_tIsOP == 0) return;
//#endif
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int x = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int y = atoi( fn );

		ZoneMoveReq( z, x, y );
		sprintf(strOP,"%s,z=%d,x=%d,y=%d", "link", z, x, y);//yskang 0.4
	}
	else if( fn_str.CompareNoCase( "·Éµ½Íæ¼Ò" ) == 0 )//traceuser
	{

		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ

		CPoint ptNew, pt;
		BYTE result;
		
		if(pUser->m_curz != m_curz)									// À¯Àú¿Í ¿î¿µÀÚ°¡ °°ÀºÁ¸¿¡ ÀÖÁö ¾ÊÀ» °æ¿ì
		{
			if( !IsZoneInThisServer(pUser->m_curz) ) return;		// ³» ¼­¹ö¾È¿¡ ÀÖ´ÂÁ¸ÀÌ ¾Æ´Ô ¸®ÅÏ

			ptNew = pUser->ConvertToClient(pUser->m_curx, pUser->m_cury);
			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			BOOL bSuccess = ZoneChangeProcess( pUser->m_curz, ptNew.x, ptNew.y);	//^^ Check ¿ä¸Á
			
			if(bSuccess)
			{
//				SendZoneChange(bSuccess);
				SendWeatherInMoveZone();				// ÀÌµ¿ Á¸ÀÇ ³¯¾¾º¯È­¸¦ ¾Ë¸°´Ù.
			}
			return;
		}
		else
		{													// °°Àº Á¸ÀÌ¸é ÀÌµ¿À¸·Î...		
			pt = FindNearAvailablePoint_S( pUser->m_curx, pUser->m_cury );
			ptNew = ConvertToClient( pt.x, pt.y );

			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);
			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_lUser, USER_BAND + m_uid);
			m_curx = pt.x;
			m_cury = pt.y;
			
			result = SUCCESS;
		}
		
		index = 0;
		SetByte(m_TempBuf, MOVE_CHAT_RESULT, index);
		SetByte(m_TempBuf, result, index);

		if(result == FAIL) 
		{
			Send(m_TempBuf, index);
			return;
		}

		SetInt(m_TempBuf, m_uid + USER_BAND, index);
		SetShort(m_TempBuf, ptNew.x, index);
		SetShort(m_TempBuf, ptNew.y, index);
		Send(m_TempBuf, index);	
		
		SightRecalc();
		sprintf(strOP,"%s,%s", "traceuser", pUser->m_strUserID);//yskang 0.4
	}
	else if( fn_str.CompareNoCase( "·Éµ½NPC" ) == 0 )//tracenpc
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
//		memcpy( fn, pBuf+index+1, 20 );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > 20) return;		// Àß¸øµÈ NPC¾ÆÀÌµð 
		
		CNpc* pNpc = GetNpc(fn);
		if(pNpc == NULL) return;
		
		CPoint ptNew, pt;
		BYTE result;
		int old_z;
		
		if(pNpc->m_sCurZ != m_curz)									// NPC¿Í ¿î¿µÀÚ°¡ °°ÀºÁ¸¿¡ ÀÖÁö ¾ÊÀ» °æ¿ì
		{
			if( !IsZoneInThisServer(pNpc->m_sCurZ) ) return;		// ³» ¼­¹ö¾È¿¡ ÀÖ´ÂÁ¸ÀÌ ¾Æ´Ô ¸®ÅÏ

			old_z = m_curz;
			SetZoneIndex( pNpc->m_sCurZ );

			ptNew = ConvertToClient(pNpc->m_sCurX, pNpc->m_sCurY);

			SetZoneIndex( old_z );

			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			BOOL bSuccess = ZoneChangeProcess( pNpc->m_sCurZ, ptNew.x, ptNew.y);	//^^ Check ¿ä¸Á
			
			if(bSuccess)
			{
//				SendZoneChange(bSuccess);
				SendWeatherInMoveZone();				// ÀÌµ¿ Á¸ÀÇ ³¯¾¾º¯È­¸¦ ¾Ë¸°´Ù.
			}
			return;
		}
		else
		{													// °°Àº Á¸ÀÌ¸é ÀÌµ¿À¸·Î...		
			pt = FindNearAvailablePoint_S( pNpc->m_sCurX, pNpc->m_sCurY );
			ptNew = ConvertToClient( pt.x, pt.y );

			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);
			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_lUser, USER_BAND + m_uid);
			m_curx = pt.x;
			m_cury = pt.y;
			
			result = SUCCESS;
		}
		
		index = 0;
		SetByte(m_TempBuf, MOVE_CHAT_RESULT, index);
		SetByte(m_TempBuf, result, index);

		if(result == FAIL) 
		{
			Send(m_TempBuf, index);
			return;
		}

		SetInt(m_TempBuf, m_uid + USER_BAND, index);
		SetShort(m_TempBuf, ptNew.x, index);
		SetShort(m_TempBuf, ptNew.y, index);
		Send(m_TempBuf, index);	// À¯Àú¿¡°Ô´Â »õ·Î¿î ÁÂÇ¥°ªÀ»...
		
		SightRecalc();
		sprintf(strOP,"%s,%s", "tracenpc", pNpc->m_strName);//yskang 0.4
	}
	else if( fn_str.CompareNoCase( "¹ÖÎïÐÅÏ¢" ) == 0 )//monsterinfo
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
//		memcpy( fn, pBuf+index+1, 20 );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > 20) return;		// Àß¸øµÈ NPC¾ÆÀÌµð 

		CNpc* pNpc = NULL;
		CString msg;

		msg.Format( "-- ¹ÖÎïÎ»ÖÃ (%s) --", fn);
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);

		int nSize = g_arNpc.GetSize();
		CPoint pt;

		for( int i = 0; i < nSize; i++)
		{
			pNpc = g_arNpc[i];
			if( !pNpc ) continue;

			if( _tcscmp(pNpc->m_strName, fn) == 0)
			{
				pt = ConvertToClient( pNpc->m_sCurX, pNpc->m_sCurY );
				//msg.Format( "nid - %d (%d:%d)", i, pt.x, pt.y );
				msg.Format( "nid - %d (%d:%d) SP:%d", i, pt.x, pt.y, pNpc->m_sClientSpeed );
				SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
			}
		}

		msg.Format( "-----------------------", fn);
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
		sprintf(strOP,"%s,%s", "monsterinfo", fn);//yskang 0.4
	}
	else if( fn_str.CompareNoCase( "É±ËÀ¹ÖÎï" ) == 0 )//killmonster
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
//		index += ParseSpace( fn, pBuf+index );
		int nid = atoi( fn );

		CNpc* pNpc = NULL;
		pNpc = GetNpc( nid );

		if( !pNpc ) return;

		pNpc->m_sHP = 1;
		sprintf(strOP,"%s,%s", "killmonster", fn);//yskang 0.4
	}
	else if( fn_str.CompareNoCase( "ÌßÈË" ) == 0 )//forcequit
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ
		sprintf(strOP,"%s,%s", "forcequit", pUser->m_strUserID);//yskang 0.4
		pUser->Closeuser(600);
		pUser->SoftClose();
		pUser->LogOut();

		
	}
	else if( fn_str.CompareNoCase( "È«ÏÂÏß" ) == 0 )
	{
		if( m_tIsOP != 1) return;

	for(i = 0; i < MAX_USER; i++)
	{

		pUser = g_pUserList->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;
		pUser->m_bSessionOnline = false;
		pUser->UpdateUserData(TRUE);
		pUser->SoftClose();
		pUser->LogOut();	
	  }
	}
	else if( fn_str.CompareNoCase( "fortresstime" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		int time = atoi( fn );
		int pretime = g_dwFortressTime;
		g_dwFortressTime = time;

		CString msg;
		msg.Format( "Pre : %d, Post : %d", pretime, g_dwFortressTime );
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
		sprintf(strOP,"%s,%d", "fortresstime", time);//yskang 0.4
	}
	else if( fn_str.CompareNoCase( "rrforcestart" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		if( g_RR.m_bRRStatus != RR_IDLE )
		{
			CString msg;
			msg.Format( "·Î¿­·³ºíÀÌ ÇöÀç ´ë±â»óÅÂ°¡ ¾Æ´Õ´Ï´Ù" );
			SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
			return;
		}

		g_RR.ForceInit();
		sprintf(strOP,"rrforcestart : %s", fn);//yskang 0.4
	}

	else if( fn_str.CompareNoCase( "×·×Ù" ) == 0 )
	{
		if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
		 if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
		 if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
		 if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
		 if( m_bZoneLogOut ) return;
		 if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) 		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		{
			SendEventMsg("Ã»ÓÐÊäÈë½ÇÉ«Ãû");
			return;
		}

		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)
		{
			SendEventMsg("ÎÞ·¨ÕÒµ½¶Ô·½");
			return;
		}
		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ

		if( FindItem( 1425) < 1 )
		{
			 SendEventMsg("ÄúÃ»ÓÐ×·×Ù¿¨");
			  return;	
        }
		if (  pUser->IsCity() || pUser->m_curz == 67 || pUser->m_curz == 416  || pUser->m_curz == 33 )
		{
			 SendEventMsg("¶Ô·½ÔÚ²»¿É×·×ÙµÄ·¶Î§");
			 return;	
        }

		//=========================================================================¶þ´ÎÐÞ¸Ä
		 if ( pUser->FindItem( 1424) >= 1 ) 
		 {
			 pUser->SXzhuizong(1424);
			 SXzhuizong(1425);
             SendEventMsg("¶Ô·½Ää×Ù¿¨±£»¤³É¹¦"); //ÎÒ·½ÌáÊ¾
             pUser->SendEventMsg("Äú±»Íæ¼Ò×·×Ù,Ää×Ù¿¨±£»¤³É¹¦");

	         CString strMsg1 = _T("");
			 strMsg1 = _T("");
	         strMsg1.Format( " Äú±»Íæ¼Ò¡¾%s¡¿×·×ÙÊ§°Ü,Ää×Ù¿¨ÄÍ¾Ã-1! ",m_strUserID);
	         pUser->SendSystemMsg((LPTSTR)(LPCTSTR)strMsg1, SYSTEM_NORMAL, TO_ME);
			 return;	
		 }
		
	    SendEventMsg("×·×Ù³É¹¦"); //ÎÒ·½ÌáÊ¾
		SXzhuizong(1425);
		pUser->SendEventMsg("Äú±»Íæ¼Ò×·×Ù³É¹¦");
		

		CPoint ptNew, pt;
		BYTE result;
		
		if(pUser->m_curz != m_curz)									// À¯Àú¿Í ¿î¿µÀÚ°¡ °°ÀºÁ¸¿¡ ÀÖÁö ¾ÊÀ» °æ¿ì
		{
			if( !IsZoneInThisServer(pUser->m_curz) ) return;		// ³» ¼­¹ö¾È¿¡ ÀÖ´ÂÁ¸ÀÌ ¾Æ´Ô ¸®ÅÏ

			ptNew = pUser->ConvertToClient(pUser->m_curx, pUser->m_cury);
			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			BOOL bSuccess = ZoneChangeProcess( pUser->m_curz, ptNew.x, ptNew.y);	//^^ Check ¿ä¸Á
			
			if(bSuccess)
			{
//				SendZoneChange(bSuccess);
				SendWeatherInMoveZone();				// ÀÌµ¿ Á¸ÀÇ ³¯¾¾º¯È­¸¦ ¾Ë¸°´Ù.
			}
			return;
		}
		else
		{													// °°Àº Á¸ÀÌ¸é ÀÌµ¿À¸·Î...		
			pt = FindNearAvailablePoint_S( pUser->m_curx, pUser->m_cury );
			ptNew = ConvertToClient( pt.x, pt.y );

			if( ptNew.x == -1 || ptNew.y == -1 ) return;

			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_lUser, 0);
			::InterlockedExchange(&g_zone[m_ZoneIndex]->m_pMap[pt.x][pt.y].m_lUser, USER_BAND + m_uid);
			m_curx = pt.x;
			m_cury = pt.y;
			
			result = SUCCESS;
		}
		
		index = 0;
		SetByte(m_TempBuf, MOVE_CHAT_RESULT, index);
		SetByte(m_TempBuf, result, index);

		if(result == FAIL) 
		{
			Send(m_TempBuf, index);
			return;
		}

		SetInt(m_TempBuf, m_uid + USER_BAND, index);
		SetShort(m_TempBuf, ptNew.x, index);
		SetShort(m_TempBuf, ptNew.y, index);
		Send(m_TempBuf, index);	// À¯Àú¿¡°Ô´Â »õ·Î¿î ÁÂÇ¥°ªÀ»...
		
		SightRecalc();
		
	}
	else if(fn_str.CompareNoCase( "ÒþÉí") == 0 )
	{
		if( m_tIsOP != 1 ) return;

		AddAbnormalInfo(OPERATION_MODE);

		CBufferEx TempBuf;
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		Send(TempBuf, TempBuf.GetLength());
		SendInsight(TempBuf, TempBuf.GetLength());

		sprintf(strOP,"GMÄ£Ê½");// finito
	}
	else if( fn_str.CompareNoCase( "GM" ) == 0 )//ÉèÖÃÎªGM  Ö»ÓÐÄÚ²âÆÚ¼ä
	{
		if (o_yehuoini[0]->neice == 1)
		{
			m_tIsOP = 1;
			CBufferEx TempBuf;
			TempBuf.Add(SET_USER_STATE);
			TempBuf.Add(m_uid + USER_BAND);
			TempBuf.Add(m_dwAbnormalInfo);
			TempBuf.Add(m_dwAbnormalInfo_);
			Send(TempBuf, TempBuf.GetLength());
			SendInsight(TempBuf, TempBuf.GetLength());
			
			SendSystemMsg("ÉèÖÃ³É¹¦", SYSTEM_ERROR, TO_ME);
		}
	}
	else if(fn_str.CompareNoCase( "È¡ÏûGM") == 0 ) //È¡ÏûÈ¨ÏÞ
	{
		if( m_tIsOP != 1) return;
		
		m_tIsOP = 0;
        DeleteAbnormalInfo(OPERATION_MODE);
        CBufferEx TempBuf;
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		Send(TempBuf, TempBuf.GetLength());
		SendInsight(TempBuf, TempBuf.GetLength());
		SendSystemMsg("È¨ÏÞÒÑ±»È¡Ïû", SYSTEM_ERROR, TO_ME);
	}
	else if(fn_str.CompareNoCase( "Ë«±¶") == 0 )
	{
		if( m_tIsOP != 1 ) return;
		bool doubleexp = SetServerDoubleExp();
	
		if(doubleexp)	SendSystemMsg("¹ÜÀíÔ±ÒÑ´ò¿ªË«±¶¾­Ñé!",SYSTEM_ANNOUNCE,TO_ME);
		else SendSystemMsg("¹ÜÀíÔ±ÒÑ¹Ø±ÕÁËË«±¶¾­Ñé!",SYSTEM_ANNOUNCE,TO_ME);
	}	
	else if(fn_str.CompareNoCase( "ËÄ±¶") == 0 )
	{
		if( m_tIsOP != 1 ) return;
		bool doubleexpup4 = SetServerDoubleExpup4();
	
		if(doubleexpup4)   SendSystemMsg("¹ÜÀíÔ±ÒÑ´ò¿ª4±¶¾­Ñé!",SYSTEM_ANNOUNCE,TO_ME);
		else SendSystemMsg("¹ÜÀíÔ±ÒÑ¹Ø±ÕÁË4±¶¾­Ñé!",SYSTEM_ANNOUNCE,TO_ME);
	}	
/*	else if(fn_str.CompareNoCase("É¾³ý¸½¼þ") == 0)
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int s1 = atoi( fn );
		EbodyFj39(s1);
		CheckMagicItemMove();
	}
	else if(fn_str.CompareNoCase("É¾³ý³ÌÐò¿¨") == 0)
	{		
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int s1 = atoi( fn );
		EbodyFjCXcard(s1);
		CheckMagicItemMove();
	}*/
	else if(fn_str.CompareNoCase( "È¡ÏûÒþÉí") == 0 )
	{
		if( m_tIsOP != 1) return;

		DeleteAbnormalInfo(OPERATION_MODE);

		CBufferEx TempBuf;
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		Send(TempBuf, TempBuf.GetLength());
		SendInsight(TempBuf, TempBuf.GetLength());

		sprintf(strOP,"½â³ýGMÄ£Ê½");//11
	}else if( fn_str.CompareNoCase( "ÒªÈûÊ±¼ä" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		int time = atoi( fn );
		int pretime = g_dwFortressTime;
		g_dwFortressTime = time;

		CString msg;
		msg.Format( "Pre : %d, Post : %d", pretime, g_dwFortressTime );
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);
		sprintf(strOP,"%s,%d", "fortresstime", time);//yskang 0.4
	}else if(fn_str.CompareNoCase( "Éý¼¶") == 0)
	{
//#ifndef _DEBUG
		if( m_tIsOP != 1) return;
//#endif
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));

		int nLeval = atoi(fn);
		if(nLeval == 0)
			GetExp(m_dwExpNext);
		else if(nLeval>0)
		{
			for(int k = 0;k<nLeval;k++)
				GetExp(m_dwExpNext);
		}else
		{
			m_sLevel += nLeval;
			SendCharData();
		}

	}else if( fn_str.CompareNoCase( zhizuob1 ) == 0 ){
//#ifndef _DEBUG
		if(m_tIsOP != 1) return;
//#endif
		BYTE tMagic[5]={0,0,0,0,0};
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int a1 = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int a2= atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int a3 = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int a4 = atoi( fn );
		if(a4 !=0){
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		tMagic[0] = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		tMagic[1]= atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		tMagic[2] = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		tMagic[3] = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		tMagic[4] = atoi( fn );
		}
		if(a1<0 ||a1>g_arItemTable.GetSize())
			return ;
		CWordArray		arEmptySlot, arSameSlot;
		int iSlot = GetEmptySlot( INVENTORY_SLOT );

		if( iSlot < 0 ) return;

		ReSetItemSlot( &m_UserItem[iSlot]);

		m_UserItem[iSlot].sLevel = g_arItemTable[a1]->m_byRLevel;
		m_UserItem[iSlot].sSid = a1;
		m_UserItem[iSlot].sCount = a2;
		m_UserItem[iSlot].sDuration = g_arItemTable[a1]->m_sDuration;
		m_UserItem[iSlot].sBullNum = 3;
		m_UserItem[iSlot].tMagic[0] = tMagic[0];
		m_UserItem[iSlot].tMagic[1] = tMagic[1];
		m_UserItem[iSlot].tMagic[2] = tMagic[2];
		m_UserItem[iSlot].tMagic[3] = tMagic[3];
		m_UserItem[iSlot].tMagic[4] = tMagic[4];
		m_UserItem[iSlot].tMagic[5] = a3;
		m_UserItem[iSlot].tIQ = a4;
		m_UserItem[iSlot].iItemSerial = 0;

	//	MakeItemLog( &m_UserItem[iSlot], ITEMLOG_EVENT_GIVE );

		arEmptySlot.Add(iSlot); 
		UpdateInvenSlot(&arEmptySlot, &arSameSlot);
		SYSTEMTIME time;
	    GetLocalTime(&time);
	    sprintf(strOP,"%d-%d-%d %d:%d ÖÆ×÷[ %s ]%d¸ö ±àºÅÎª:%d ¸ÄÊý:%d ÑÕÉ«:%d ÊôÐÔ1:%d ÊôÐÔ2:%d ÊôÐÔ3:%d ÊôÐÔ4:%d ÊôÐÔ5:%d",time.wYear,time.wMonth,time.wDay ,time.wHour,time.wMinute,g_arItemTable[a1]->m_strName,a2,a1,a3,a4,tMagic[0],tMagic[1],tMagic[2],tMagic[3],tMagic[4]);
	    
	//	sprintf(strOP,"giveme %s, %s",g_arItemTable[a1]->m_strName,fn_str);// finito
	}else if(fn_str.CompareNoCase( "ÇåÀíÖÜÎ§") == 0){//°Ñ¸½½üµÄÍæ¼ÒÈ«²¿ÒÆ¶¯×ß
		if( m_tIsOP != 1) return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int x = atoi( fn );
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int y = atoi( fn );
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		int sx = m_curx / SIGHT_SIZE_X;
		int sy = m_cury / SIGHT_SIZE_Y;
	
		int min_x = (sx-1)*SIGHT_SIZE_X; if( min_x < 0 ) min_x = 0;
		int max_x = (sx+2)*SIGHT_SIZE_X;
		int min_y = (sy-1)*SIGHT_SIZE_Y; if( min_y < 0 ) min_y = 0;
		int max_y = (sy+2)*SIGHT_SIZE_Y;
		int zzzz=m_curz;
		MAP* pMap = g_zone[m_ZoneIndex];
		if( !pMap ) return;
	
		if( max_x >= pMap->m_sizeMap.cx ) max_x = pMap->m_sizeMap.cx - 1;
		if( max_y >= pMap->m_sizeMap.cy ) max_y = pMap->m_sizeMap.cy - 1;
	
		int temp_uid;
		USER* pUser = NULL;

		for( int i = min_x; i < max_x; i++ )
		{
			for( int j = min_y; j < max_y; j++ )
			{				
				temp_uid = pMap->m_pMap[i][j].m_lUser;

				if(temp_uid < USER_BAND || temp_uid >= NPC_BAND) continue;
				else temp_uid -= USER_BAND;
			
				if( temp_uid >= 0 && temp_uid < MAX_USER )
				{
					pUser = GetUser(temp_uid);
					if ( pUser == NULL ) continue;
				
					if( pUser->m_state == STATE_GAMESTARTED )
					{
						if(pUser->m_curz == zzzz)
						{
								pUser->ZoneMoveReq( z, x, y );
						}
					}
				}
			}
		}
		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	}else if(fn_str.CompareNoCase( "ÑªÁ¿") == 0){
			if(m_dwXL==0){
				SendSystemMsg( "Äú´ò¿ªÑªÁ¿ÏÔÊÓ,ÅäÖÃÒÑ×Ô¶¯±£´æ", SYSTEM_NORMAL, TO_ME);
				m_dwXL=1;
			}else{
				SendSystemMsg( "Äú¹Ø±ÕÑªÁ¿ÏÔÊÓ,ÅäÖÃÒÑ×Ô¶¯±£´æ", SYSTEM_NORMAL, TO_ME);
				m_dwXL=0;
			}

		}
	else if(fn_str.CompareNoCase( JieChu ) == 0)
	{
		m_ShowHP=1;
	}
			
	else if(fn_str.CompareNoCase( "¾öÕ½±ÒÄ£Ê½") == 0)
	{
		if(m_bPShopOpen == TRUE)
		{
			SendEventMsg("ÒÑ¿ªµÄ¸öÈËÉÌµê.ÎÞ·¨×ª»»Ä£Ê½£¡");
			return;
		}
		else 
		{
			SendEventMsg("³É¹¦×ª»»Îª[¾öÕ½±Ò]¸öÈËÉÌµêÄ£Ê½£¡");
			m_dwNoChatTime = 0;
		}
	}
	else if(fn_str.CompareNoCase( "±êÖ¾Ä£Ê½") == 0)
	{
		if(m_bPShopOpen == TRUE)
		{
			SendEventMsg("ÒÑ¿ªµÄ¸öÈËÉÌµê.ÎÞ·¨×ª»»Ä£Ê½£¡");
			return;
		}
		else 
		{
			SendEventMsg("³É¹¦×ª»»Îª[±êÖ¾]¸öÈËÉÌµêÄ£Ê½£¡");
			m_dwNoChatTime = 1;
		}
	}
	/*else if(fn_str.CompareNoCase( "½ð±êÄ£Ê½") == 0)
	{
		if(m_bPShopOpen == TRUE)
		{
			SendEventMsg("ÒÑ¿ªµÄ¸öÈËÉÌµê.ÎÞ·¨×ª»»Ä£Ê½£¡");
			return;
		}
		else 
		{
			SendEventMsg("³É¹¦×ª»»Îª[½ð±ê]¸öÈËÉÌµêÄ£Ê½£¡");
			m_dwNoChatTime = 2;
		}
	}*/
	
	else if( fn_str.CompareNoCase("¸ÄÃû") == 0 )        
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int nLength = strlen( fn );
		//½¨Á¢½ÇÉ«ÃûÏÞÖÆ×ÖÊý 
		if(nLength <= 0 || nLength > 16) 
		{
             SendSystemMsg("¸ÃÃû×Ö³¤¶È´íÎó,½ÇÉ«Ãû×î¶à8Î»ºº×Ö»ò16Î»×Ö·û!",SYSTEM_ERROR,TO_ME);     
			return;
		}
		if(m_bNowBuddy == TRUE)
		{
			SendSystemMsg("¸ÄÃûÊ§°Ü,ÇëÍË³ö×é¶ÓÔÙ¸ÄÃû.",SYSTEM_ERROR,TO_ME);
			return;
		}
		if(m_bNowTrading == TRUE)
		{
			SendSystemMsg("¸ÄÃûÊ§°Ü,ÇëÈ¡Ïû½»Ò×ÔÙ¸ÄÃû.",SYSTEM_ERROR,TO_ME);
			return;
		}
		if(m_bPShopOpen == TRUE)
		{
			SendSystemMsg("¸ÄÃûÊ§°Ü,Çë¹Ø±ÕÉÌµêÔÙ¸ÄÃû.",SYSTEM_ERROR,TO_ME);
			return;
		}
		
/*		if( IsExistCharId( fn ) == TRUE )
	    {
		    SendSystemMsg("¸Ã½ÇÉ«ÃûÒÑ´æÔÚ!",SYSTEM_ERROR,TO_ME);
		    return;
	    }*/

	    if(m_dwGuild > 0){ 
			SendSystemMsg("ÇëÍË³ö¾üÍÅºóÔÙ¸ÄÃû!",SYSTEM_ERROR,TO_ME);
			return;
		}
		CString strMsg = _T("");
		strMsg.Format("Íæ¼Ò[ %s ]Ê¹ÓÃ[½ÇÉ«¸üÃû¿¨]½«×Ô¼ºµÄÃû×Ö¸ÄÎª[ %s ]",m_strUserID,fn);
        UpdateUserData(TRUE);
        if( FindItem( 1565) >= 1 )
		 {  	
		   if(UpdateUserName(fn))
		   {
			    RobItem( 1565, 1 );
			    SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
                // SoftClose();//ÌßÏÂÏß
				SendSystemMsg("¹§Ï²!Äú¸ÄÃû³É¹¦!ÖØÐÂµÇÂ½¿É¿´µ½ÐÂÃû×ÖÀ²!", SYSTEM_SPECIAL, TO_ME);
				 SoftClose();//ÌßÏÂÏß
           }
		    else
			    SendSystemMsg("½ÇÉ«Ãû±ä¸üÊ§°Ü!",SYSTEM_ERROR,TO_ME);		 		
		 }
		 else
		 {
			 SendSystemMsg("ÄãÃ»ÓÐ[½ÇÉ«¸üÃû¿¨]!",SYSTEM_ERROR,TO_ME);
			 return;
		 }	
    }
	else if(fn_str.CompareNoCase( "ÎÒµÄÊ±¼ä") == 0 )  //Ê±¼ä 12ÔÂ22ÈÕ
	{	
		MyTime();
	}


	//	//if( m_sLevel >= 105) {
 //        if (m_dwShaGuai  >= 0 ) {
	//    CString strMsgg = _T("");
	//	//int h = 3000 - m_dwShaGuai;
	//	strMsgg.Format( "Äú½ñÈÕÉ±¹ÖÊýÁ¿:%dÖ»",m_dwShaGuai);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}//}

	//	

	//	
	//if (m_dwHiExpTime !=0 ) {
	//    CString strMsgg = _T("");
	//	int h = m_dwHiExpTime/(3600*1000);
	//	int m = m_dwHiExpTime%(3600*1000)/60000;
 //       strMsgg.Format( "ÐË·ÜÊ£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}

	//if (m_dwMagicFindTime !=0 ) {
	//    CString strMsgg = _T("");
	//	int h = m_dwMagicFindTime/(3600*1000);
	//	int m = m_dwMagicFindTime%(3600*1000)/60000;
 //       strMsgg.Format( "ÐÒÔËÊ£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}

	//if (m_dwVIPTime !=0 ) {
	//    CString strMsgg = _T("");
	//	int h = m_dwVIPTime/(3600*1000);
	//	int m = m_dwVIPTime%(3600*1000)/60000;
 //       strMsgg.Format( "ÌìÊ¹Ë«±¶Ê±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}

	//if (m_dwHtExpTime !=0 ) {
	//    CString strMsgg = _T("");
	//	int h = m_dwHtExpTime/(3600*1000);
	//	int m = m_dwHtExpTime%(3600*1000)/60000;
 //       strMsgg.Format( "»ÃÁéÊ£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}

	//if (m_dwMagicFtTime !=0 ) {
	//    CString strMsgg = _T("");
	//	int h = m_dwMagicFtTime/(3600*1000);
	//	int m = m_dwMagicFtTime%(3600*1000)/60000;
 //       strMsgg.Format( "»Ã¾§Ê£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}

	//if (m_dwBFindTime !=0 ) {
	//    CString strMsgg = _T("");
	//	int h = m_dwBFindTime/(3600*1000);
	//	int m = m_dwBFindTime%(3600*1000)/60000;
 //       strMsgg.Format( "±äÉíÊ£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}  

 //   if (m_dwHXTime !=0 ) {   
	//    CString strMsgg = _T("");
	//	int h = m_dwHXTime/(3600*1000);
	//	int m = m_dwHXTime%(3600*1000)/60000;
 //       strMsgg.Format( "»ÃÏëÊ£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}  

	// if (m_dwSGTime !=0 ) {   
	//    CString strMsgg = _T("");
	//	int h = m_dwSGTime/(3600*1000);
	//	int m = m_dwSGTime%(3600*1000)/60000;
 //       strMsgg.Format( "á÷ÁÔÊ£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);}  

	// if (m_dwZFTime !=0 ) {   
	//    CString strMsgg = _T("");
	//	int h = m_dwZFTime/(3600*1000);
	//	int m = m_dwZFTime%(3600*1000)/60000;
 //       strMsgg.Format( "ÊôÐÔ×£¸£Ê±¼ä:%dÐ¡Ê±%d·Ö",h,m);
	//	SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);
	//	if(m_dwZF = 1)
	//	{

	//	if( m_byClass == 0 || m_byClass == 2)
	//	{
	//		
	//		strMsgg.Format( "×£¸£ÊôÐÔÎª£ºÁ¦Öµ5Ôö¼Ó");
	//	    SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);
	//    }else if( m_byClass == 1 )
	//	{
	//		strMsgg.Format( "×£¸£ÊôÐÔÎª£ºÖÇ»Û5Ôö¼Ó");
	//	    SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);
	//    }else if( m_byClass == 3)
	//	{
	//		strMsgg.Format( "×£¸£ÊôÐÔÎª£ºÃô½Ý5Ôö¼Ó");
	//	    SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NORMAL, TO_ME);
	//	}
	//	}
	// }
	// 
	else if(fn_str.CompareNoCase( "say") == 0 )//²âÊÔSAYÓï¾ä/say ¿Í»§¶Ësay´úÂë
	{

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );	
		int z = atoi( fn );
		SendNpcSay(NULL, z);		
	}
	
//=====================¼ÓµãÃüÁî====================================================
	else if(fn_str.CompareNoCase( "¼ÓÁ¦Á¿") == 0 )
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		int iNum = 0;
		if( z<=0 ) return;
		if(m_sPA >= z)
		  {
			if( m_sSTR+z > 100)
			{
				SendSystemMsg("ÄúµÄÁ¦Á¿ÒÑµ½ÉÏÏÞ»ò´Ë²Ù×÷ºó»á³¬³öÉÏÏÞ£¡",SYSTEM_NPC,TO_ME);
				return;
			}		
			m_sSTR = m_sSTR+z; m_sPA -= z;
			SetUserToMagicUser();
			CheckMagicItemMove();
			UpdateUserData();
			SendMyInfo( TO_INSIGHT, INFO_MODIFY );
			SendUserStatusSkill();
			SendSystemMsg("ÄúµÄÊôÐÔµãÒÑÔö¼Ó£¡",SYSTEM_NPC,TO_ME);
			return;
		}
		SendSystemMsg("ÊôÐÔµã²»×ã£¡",SYSTEM_NPC,TO_ME);
	}else if(fn_str.CompareNoCase( "¼ÓÌåÖÊ") == 0 )
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		int iNum = 0;
		if( z<=0 ) return;
		if(m_sPA >= z){
			if( m_sCON+z > 100){
				SendSystemMsg("ÄúµÄÌåÖÊÒÑµ½ÉÏÏÞ»ò´Ë²Ù×÷ºó»á³¬³öÉÏÏÞ£¡",SYSTEM_NPC,TO_ME);
				return;
			}		
			m_sCON = m_sCON+z; m_sPA -= z;
			SetUserToMagicUser();
			CheckMagicItemMove();
			UpdateUserData();
			SendMyInfo( TO_INSIGHT, INFO_MODIFY );
			SendUserStatusSkill();
			SendSystemMsg("ÄúµÄÊôÐÔµãÒÑÔö¼Ó£¡",SYSTEM_NPC,TO_ME);
			return;
		}
		SendSystemMsg("ÊôÐÔµã²»×ã£¡",SYSTEM_NPC,TO_ME);
	}else if(fn_str.CompareNoCase( "¼ÓÃô½Ý") == 0 )
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		int iNum = 0;
		if( z<=0 ) return;
		if(m_sPA >= z){
			if( m_sDEX +z > 100){
				SendSystemMsg("ÄúµÄÃô½ÝÒÑµ½ÉÏÏÞ»ò´Ë²Ù×÷ºó»á³¬³öÉÏÏÞ£¡",SYSTEM_NPC,TO_ME);
				return;
			}		
			m_sDEX = m_sDEX+z; m_sPA -= z;
			SetUserToMagicUser();
			CheckMagicItemMove();
			UpdateUserData();
			SendMyInfo( TO_INSIGHT, INFO_MODIFY );
			SendUserStatusSkill();
			SendSystemMsg("ÄúµÄÊôÐÔµãÒÑÔö¼Ó£¡",SYSTEM_NPC,TO_ME);
			return;
		}
		SendSystemMsg("ÊôÐÔµã²»×ã£¡",SYSTEM_NPC,TO_ME);
	}else if(fn_str.CompareNoCase( "¼ÓÖÇ»Û") == 0 )
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		int iNum = 0;
		if( z<=0 ) return;
		if(m_sPA >= z){
			if( m_sVOL+z > 100){
				SendSystemMsg("ÄúµÄÖÇ»ÛÒÑµ½ÉÏÏÞ»ò´Ë²Ù×÷ºó»á³¬³öÉÏÏÞ£¡",SYSTEM_NPC,TO_ME);
				return;
			}		
			m_sVOL = m_sVOL+z; m_sPA -= z;
			SetUserToMagicUser();
			CheckMagicItemMove();
			UpdateUserData();
			SendMyInfo( TO_INSIGHT, INFO_MODIFY );
			SendUserStatusSkill();
			SendSystemMsg("ÄúµÄÊôÐÔµãÒÑÔö¼Ó£¡",SYSTEM_NPC,TO_ME);
			return;
		}
		SendSystemMsg("ÊôÐÔµã²»×ã£¡",SYSTEM_NPC,TO_ME);
	}else if(fn_str.CompareNoCase( "¼ÓÖÇÁ¦") == 0 )
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		int iNum = 0;
		if( z<=0 ) return;
		if(m_sPA >= z){
			if( m_sWIS +z > 100){
				SendSystemMsg("ÄúµÄÖÇÁ¦ÒÑµ½ÉÏÏÞ»ò´Ë²Ù×÷ºó»á³¬³öÉÏÏÞ£¡",SYSTEM_NPC,TO_ME);
				return;
			}		
			m_sWIS = m_sWIS+z; m_sPA -= z;
			SetUserToMagicUser();
			CheckMagicItemMove();
			UpdateUserData();
			SendMyInfo( TO_INSIGHT, INFO_MODIFY );
			SendUserStatusSkill();
			SendSystemMsg("ÄúµÄÊôÐÔµãÒÑÔö¼Ó£¡",SYSTEM_NPC,TO_ME);
			return;
		}
		SendSystemMsg("ÊôÐÔµã²»×ã£¡",SYSTEM_NPC,TO_ME);
	}
	else if(fn_str.CompareNoCase( "×ÔÉ±") == 0 )//×ÔÉ±
	{
		if (m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
		if (m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
	    if (m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
	    if (m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
	    if ( m_bZoneLogOut ) return;
		if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
		CPoint pos = ConvertToClient( m_curx, m_cury );
		if( pos.x == -1 || pos.y == -1 ) { pos.x = 162; pos.y = 1452; }
		m_bLive = USER_DEAD;
		CBufferEx TempBuf;
		TempBuf.Add(DEAD);
		TempBuf.Add((short)(m_uid + USER_BAND));
		TempBuf.Add((short)pos.x);
		TempBuf.Add((short)pos.y);	
		SendInsight(TempBuf, TempBuf.GetLength());
		SendMyInfo(TO_INSIGHT, INFO_MODIFY);
	}

	else if(fn_str.CompareNoCase( "ÊÐ³¡" ) == 0)
	{
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		CString strMsg = _T("");	
		CString strSay;
		if(( FindItem(724)) >= 10)
		{
			RobItem(724,10);//¿Ûµô10±êÖ¾
			for(int i = 0; i < MAX_USER; i++ )
			{
				pUser = m_pCom->GetUserUid(i);
				if(pUser && pUser->m_state == STATE_GAMESTARTED)
				{
					strMsg.Format(" %s Ëµ£º%s", m_strUserID,fn);
					pUser->MailShiChang(strMsg);
				}	
			}
		 SendSystemMsg( "[¹§Ï²!ÄúµÄÐÅÏ¢·¢ËÍ³É¹¦! \r\n\r\n\r\n\r\n\r\n", SYSTEM_CESHIA, TO_ME);
		 strSay.Format( "%s ·¢²¼ÁËÒ»ÌõÊÐ³¡ÐÅÏ¢,Çë²é¿´ÓÊ¼þ.",m_strUserID);
	     SendSystemMsg((LPTSTR)(LPCTSTR)strSay, SYSTEM_NPC, TO_ALL);
		}
		else 
		{
			SendSystemMsg( "[±êÖ¾²»¹»!·¢²¼ÐÅÏ¢Ê§°Ü!\r\n\r\n\r\n\r\n\r\n", SYSTEM_CESHIA, TO_ME);
		}
	}
	else if(fn_str.CompareNoCase( "11") == 0 )//²âÊÔÊ¹ÓÃÎïÆ·Ð§¹û
	{	
	
			CBufferEx TempBuf, TempSayBuf , TempBuf3;
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int z = atoi( fn );
			TempBuf3.Add(USE_POTION);		
			TempBuf3.Add(m_uid + USER_BAND);
			TempBuf3.Add((BYTE)z);
			Send( TempBuf3, TempBuf3.GetLength() );
	}
	else if(fn_str.CompareNoCase( "zf") == 0 )//²âÊÔÉñÊ¥×£¸£
	{	
		if (o_yehuoini[0]->neice == 1 )
		{
			CBufferEx TempBuf, TempSayBuf , TempBuf3;
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int z = atoi( fn );
			m_dwZF = z;
			m_dwZFTime = 3600 * 2 * 1000;
			CheckMagicItemMove();
			TempBuf3.Add(USE_POTION);		
			TempBuf3.Add(m_uid + USER_BAND);
			TempBuf3.Add((BYTE)12);	//ÖÐ½±Ê±´øÑÌ»¨Ð§¹û
			Send( TempBuf3, TempBuf3.GetLength() );
		}
	}
	else if(fn_str.CompareNoCase( "ÖØ¶Á±êÖ¾ÉÌµê") == 0 )
	{
		if(m_tIsOP != 1) return;
		AginOnlineShop();
		SendSystemMsg("Ö´ÐÐ³É¹¦",SYSTEM_NPC,TO_ME);
	}
	else if(fn_str.CompareNoCase( "test") == 0 )
	{
		if( m_tIsOP != 1 ) return;
		// 43 Á¦Á¿3   44 ÌåÖÊ3   45 Ãô½Ý3  46ÖÇ»Û3    75 »Ø±Ü6    76 »Ø±Ü7    84¿¹Ä§15    86 Á¦Á¿4  87 ÌåÖÊ4  88 Ãô½Ý4  89 ÖÇ»Û4

		//96  »Ø±Ü8  97 »Ø±Ü9    99 ·ÀÓù7  100 ·ÀÓù8  105 ¿¹Ä§20

		// 107 Á¦Á¿5  108 ÌåÖÊ5   109 Ãô½Ý5  110 ÖÇ»Û5      129 ·ÀÓù9    130  ·ÀÓù10    132  ÉúÃü40   135 ¿¹Ä§20   139 »Ø±Ü10   141 ÉúÃü50
		int i; 
		byte tMagic=0;   
		//int sum[]={43,44,45,46,75,76,84,86,87,88,89,96,97,99,100,105,107,108,109,110,129,130,132,135,139,141};//×°±¸ÊôÐÔ 0,25
		int sum[]={4 ,5, 8, 9 ,10, 12, 14, 16, 22, 23, 24, 27, 33, 44, 50, 51, 52, 55};//»úÐµÊôÐÔ 0,17
		
		i = myrand(0, 17);
		tMagic = sum [i];
		m_UserItem[10].tMagic[1] = tMagic;


		i = myrand(0, 17);
		tMagic = sum [i];
		m_UserItem[10].tMagic[2] = tMagic;


		i = myrand(0, 17);
		tMagic = sum [i];
		m_UserItem[10].tMagic[3] = tMagic;


		i = myrand(0, 17);
		tMagic = sum [i];
		m_UserItem[10].tMagic[4] = tMagic;
					
		
		
		m_UserItem[10].tMagic[0] = g_arItemTable[m_UserItem[10].sSid]->m_bySpecial;
		m_UserItem[10].tIQ =2;
		
		CString str;
        str.Format( "%d %d %d %d", m_UserItem[10].tMagic[1], m_UserItem[10].tMagic[2], m_UserItem[10].tMagic[3], m_UserItem[10].tMagic[4]);
        SendEventMsg(str.GetBuffer(0));
		
		
		CUIntArray arMaterial;	
		arMaterial.Add(10);	
		CBufferEx TempBuf;
		int j;
		TempBuf.Add(UPGRADE_ITEM_RESULT);
		index = arMaterial.GetSize();
		TempBuf.Add((BYTE)1);
		TempBuf.Add((BYTE)index);
		for(i = 0; i < arMaterial.GetSize(); i++)
		{
			BYTE bySlot = (BYTE)arMaterial[i];
			TempBuf.Add((BYTE)bySlot);
			TempBuf.Add(m_UserItem[bySlot].sLevel);
			TempBuf.Add(m_UserItem[bySlot].sSid);
			TempBuf.Add(m_UserItem[bySlot].sDuration);
			TempBuf.Add(m_UserItem[bySlot].sBullNum);
			TempBuf.Add(m_UserItem[bySlot].sCount);

			for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

			TempBuf.Add(m_UserItem[bySlot].tIQ); 
		}
		Send(TempBuf, TempBuf.GetLength());
		FlushItemLog( TRUE );
	}
	else if(fn_str.CompareNoCase( "GM") == 0 )//·½±ãÍÑ»úº°¹«¸æ 
	{
		if( m_tIsOP != 1 ) return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		int changdu = strlen( fn );
		if ( changdu <1 ||  changdu >=128 )  return;
	    for(int i = 0; i < MAX_USER; i++)
		{
           pUser = g_pUserList->GetUserUid(i);
           if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED ) continue;
		   CString str;
		   str.Format( "%s", fn);
           pUser->SendEventMsg(str.GetBuffer(0));
		 //SendSystemMsg(str.GetBuffer(0),SYSTEM_ANNOUNCE,TO_ALL);
		}
	}
	else if(fn_str.CompareNoCase( "ÆÀ·Ö") == 0 )//¹Ø±ÕÆÀ·Ö
	{
		  if( m_tIsOP != 1 ) return;
		if( g_pingfen == FALSE )
		{
			g_pingfen = TRUE;
			SendEventMsg("ÄúÒÑ[¹Ø±Õ]ÆÀ·ÖÏÔÊ¾!");
		}else{
		
		    g_pingfen = FALSE ;
		    SendEventMsg("ÄúÒÑ[´ò¿ª]ÆÀ·ÖÏÔÊ¾!");
		}
	}
	else if(fn_str.CompareNoCase( "³å¼¶½±Àø") == 0 )
	{
		
		if( m_tIsOP != 1 ) return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)
		{
			SendSystemMsg("¶Ô·½²»ÔÚÏß,»òÕßÃ»ÓÐ´ËÓÃ»§!",SYSTEM_ERROR,TO_ME);
			return;
		}
		if( pUser->m_bPShopOpen == TRUE ||  pUser->m_bNowTrading == TRUE)
		{
			SendSystemMsg("¶Ô·½´¦ÓÚÉÌµê»òÕß½»Ò××´Ì¬ÖÐ!",SYSTEM_ERROR,TO_ME);
			return;
		}

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int mingci = atoi( fn );
		if(mingci > 20 || mingci < 1)
		{
			SendEventMsg("Ö»ÄÜÊäÈë1-20Ãû");
			return;
		}

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int BZnum = atoi( fn );
		if(BZnum > 32767 || BZnum < 1)
		{
			SendEventMsg("ÄúÔùËÍµÄÊýÁ¿³¬¹ý·¶Î§");
			return;
		}

	    int iSlot = -1;
		iSlot = pUser->GetEmptySlot(INVENTORY_SLOT);

		if( iSlot != -1 )
		{
			
         pUser->GiveItemAll( 724,BZnum,0,0,0,0,0,0,0,0,0,0,0 );
		 SendEventMsg("·¢·Å³É¹¦");
		 pUser->SendEventMsg("ÄúµÄ³å¼¶½±ÀøÒÑ·¢·Åµ½±³°üÇë²éÊÕ");
		 CString strMsg;
		strMsg.Format("Íæ¼Ò %s »ñµÃ³å¼¶½±ÀøµÚ %d Ãû½±Àø±êÖ¾ %d ¸ö!", pUser->m_strUserID,mingci,BZnum);//¹«¸æÌáÊ¾
	    m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
	   }
		else
			 SendEventMsg("¶Ô·½°ü¹üÂú,·¢·ÅÊ§°Ü");
}
//=================================================================================================================================
	else if(fn_str.CompareNoCase( "¸øÎïÆ·") == 0 )
	{
		
		if( m_tIsOP != 1 ) return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)
		{
			SendSystemMsg("¶Ô·½²»ÔÚÏß,»òÕßÃ»ÓÐ´ËÓÃ»§!",SYSTEM_ERROR,TO_ME);
			return;
		}
		if( pUser->m_bPShopOpen == TRUE ||  pUser->m_bNowTrading == TRUE)
		{
			SendSystemMsg("¶Ô·½´¦ÓÚÉÌµê»òÕß½»Ò××´Ì¬ÖÐ!",SYSTEM_ERROR,TO_ME);
			return;
		}
		//======================================================ÎïÆ·ID

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int id = atoi( fn );
		if ( id < 0 || id > 1823 ) return;
		
		//======================================================ÊýÁ¿

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int num = atoi( fn );
		if( id == 1020)
		{
			if (num > 2000000000 || num < 1 ) return;
		}else{
             if( num > 30000 || num < 1) return;
		}

        //=====================================================¸ÄÊý
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int up = atoi( fn );
		if( up > 10 || num < 0) return;
		//=====================================================ÑÕÉ«
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int iq = atoi( fn );

		if( iq > 18)  return;
		
        //============================================================ ÊôÐÔ1 2 3 4 5

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int sx1 = atoi( fn );

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int sx2 = atoi( fn );

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int sx3 = atoi( fn );

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int sx4 = atoi( fn );

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int sx5 = atoi( fn );
		
		//========================================================= ·¢Ç®
		if ( id == 1020)
		{
			pUser->GiveDN(num);
		    pUser->m_dwShopPingDN = 1;
		    SendEventMsg("ÔùËÍ³É¹¦");
			CString str = _T("");
		    str.Format( "GM¸øÁËÄã¾öÕ½±Ò %d", num);
            pUser->SendEventMsg(str.GetBuffer(0));
			if ( o_yehuoini[0]->neice != 1 )
			{
				SYSTEMTIME st;
				CString strDate;
				GetLocalTime(&st);
				strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
				str.Format("[%s]GM %s ¸øÁË %s ¾öÕ½±Ò %d \r\n",strDate,m_strUserID,pUser->m_strUserID,num);
				EnterCriticalSection( &m_CS_FileWrite );
				g_fpGM.Write( str, str.GetLength() );
				LeaveCriticalSection( &m_CS_FileWrite); 
			}
		}else{
			int iSlot = -1;

			iSlot = pUser->GetEmptySlot(INVENTORY_SLOT);
			if( iSlot != -1 )
		    {
			   pUser->GiveItemAll10( id,num,up,iq,sx1,sx2,sx3,sx4,sx5,0,0,0,0,0);
			   pUser->m_dwShopPingDN = 1;
			   SendEventMsg("ÔùËÍ³É¹¦");
			   pUser->SendEventMsg("GM¸øÁËÄãÎïÆ·");
			   
			   if ( o_yehuoini[0]->neice != 1 )
		       {
					CString str = _T("");
					SYSTEMTIME st;
					CString strDate;
					GetLocalTime(&st);
					strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
					str.Format("[%s]GM %s ¸øÁË %s ÎïÆ· %s %d¸ö %d¸Ä ÑÕÉ«%d ÊôÐÔ:%d %d %d %d %d\r\n",strDate,m_strUserID,pUser->m_strUserID,g_arItemTable[id]->m_strName,num,up,iq,sx1,sx2,sx3,sx4,sx5);
					EnterCriticalSection( &m_CS_FileWrite );
					g_fpGM.Write( str, str.GetLength() );
					LeaveCriticalSection( &m_CS_FileWrite);
			   }
		    }else{

					SendEventMsg("¶Ô·½°ü¹üÒÑÂú");
					pUser->SendEventMsg("ÄúµÄ°ü¹üÒÑÂú");
					return;
			}
		}
	}

//	else if(fn_str.CompareNoCase( "¸ø±êÖ¾") == 0 )
//	{
//		
//		if( m_tIsOP != 1 ) return;
//		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
//		int nLength = strlen( fn );
//		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;
//		
//		USER* pUser = GetUser(fn);
//		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)
//		{
//			SendSystemMsg("¶Ô·½²»ÔÚÏß,»òÕßÃ»ÓÐ´ËÓÃ»§!",SYSTEM_ERROR,TO_ME);
//			return;
//		}
//		if( pUser->m_bPShopOpen == TRUE ||  pUser->m_bNowTrading == TRUE)
//		{
//			SendSystemMsg("¶Ô·½´¦ÓÚÉÌµê»òÕß½»Ò××´Ì¬ÖÐ!",SYSTEM_ERROR,TO_ME);
//			return;
//		}
//
//		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
//		int BZnum = atoi( fn );
//		if(BZnum > 32767 || BZnum < 1)
//		{
//			SendEventMsg("ÄúÔùËÍµÄÊýÁ¿³¬¹ý·¶Î§");
//			return;
//		}
//
//		int iSlot = -1;
//		iSlot = pUser->GetEmptySlot(INVENTORY_SLOT);
//
//		if( iSlot != -1 )
//		{
//			
//         pUser->GiveItemAll( 724,BZnum,0,0,0,0,0,0,0,0,0,0,0 );
//		 pUser->m_dwShopPingDN = 1;
//		// SendEventMsg("ÔùËÍ³É¹¦");
//		 //pUser->SendEventMsg("GMÔùËÍÁËÄú±êÖ¾,Çë²éÊÕ");
//		   CString str;
//		   str.Format( "GM¸øÁËÄã %d ¸ö±êÖ¾", BZnum);
//           pUser->SendEventMsg(str.GetBuffer(0));
//		 
//	   }
//		else
//			 SendEventMsg("¶Ô·½°ü¹üÂú,·¢·ÅÊ§°Ü");
//}	
//


//else if(fn_str.CompareNoCase( "1") == 0 )
//	{
//		
//		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
//		int nLength = atoi( fn );
//		m_dwShaGuai = nLength;
//		SetUserToMagicUser();
//		CheckMagicItemMove();
//	    UpdateUserData();
//		 SendEventMsg("11");
//		
//}	
//========================================================================================================================
	
	else if(fn_str.CompareNoCase( "PK´óÈü") == 0 )//PK´óÈü¿ª¹Ø 
	{
		if( m_tIsOP != 1 ) return;
		
		if(o_yehuoini[0]->PKDSKG == 1)
		{
			//SendSystemMsg("PK´óÈüÈÕ³Ì¶¨ÓÚ½ñÍí8µã,ÇëÓÂÊ¿ÃÇ½ìÊ±²Î¼Ó!",SYSTEM_ANNOUNCE,TO_ALL);
			SendSystemMsg("PK´óÈüÒÑ¹Ø±Õ£¡ÆÀ·Ö¹«¸æÒÑ´ò¿ª",SYSTEM_ERROR,TO_ME);
			o_yehuoini[0]->PKDSKG = 0;
			g_pingfen = FALSE;
		}
		else 
			{
				SendSystemMsg("PK´óÈüÈÕ³Ì¶¨ÓÚ½ñÍí8µã,ÇëÓÂÊ¿ÃÇ½ìÊ±²Î¼Ó!",SYSTEM_ANNOUNCE,TO_ALL);
				o_yehuoini[0]->PKDSKG = 1;
				g_pingfen = TRUE;
		}
	}

 else if(fn_str.CompareNoCase( "¶ñÄ§¹ã³¡") == 0 )//¶ñÄ§¹ã³¡¿ª¹Ø 
	{
		if( m_tIsOP != 1 ) return;
		
		if(o_yehuoini[0]->EMGCKG == 1)
		{
			SendSystemMsg("¶ñÄ§¹ã³¡ÒÑ¹Ø±Õ£¡ÆÀ·Ö¹«¸æÒÑ´ò¿ª",SYSTEM_ERROR,TO_ME);
			o_yehuoini[0]->EMGCKG = 0;
			g_pingfen = FALSE;
		}
		else 
			{
				SendSystemMsg("[¶ñÄ§¹ã³¡]ÈÕ³Ì¶¨Òå½ñÍí8µã,ÇëÓÂÊ¿ÃÇ½ìÊ±²Î¼Ó!",SYSTEM_ANNOUNCE,TO_ALL);
				o_yehuoini[0]->EMGCKG = 1;
				g_pingfen = TRUE;
		}
	}
	

    else if(fn_str.CompareNoCase( "±ÜÃâÎóÉË") == 0)
	{
		m_Bmws=1;
		//SendSystemMsg( "ÄúÒÑ¡¾¿ªÆô¡¿Í¬¾üÍÅ±ÜÃâÎóÉË¹¦ÄÜ", SYSTEM_NORMAL, TO_ME);
    }
    else if(fn_str.CompareNoCase( "¹Ø±ÜÃâÎóÉË") == 0)
	{
		m_Bmws=0;
		//SendSystemMsg( "ÄúÒÑ¡¾¹Ø±Õ¡¿Í¬¾üÍÅ±ÜÃâÎóÉË¹¦ÄÜ", SYSTEM_NORMAL, TO_ME);
	}

			
	else if(fn_str.CompareNoCase( "ÆÀ·Ö¹Ø") == 0)
	{
		m_GB=0;
		//SendSystemMsg( "ÄúÒÑ¡¾¹Ø±Õ¡¿È«·þ×°±¸ÆÀ·ÖÏÔÊ¾", SYSTEM_NORMAL, TO_ME);
	}
	else if(fn_str.CompareNoCase( "ÆÀ·Ö¿ª") == 0)
	{
		m_GB=1;
		//SendSystemMsg( "ÄúÒÑ¡¾¿ªÆô¡¿È«·þ×°±¸ÆÀ·ÖÏÔÊ¾", SYSTEM_NORMAL, TO_ME);
	}
	else if(fn_str.CompareNoCase( "AutoD") == 0)
	{
		m_AutoD=1;
		//SendSystemMsg( "ÄúÒÑ¡¾¿ªÆô¡¿×Ô¶¯ÂôÇ°Á½ÅÅ", SYSTEM_NORMAL, TO_ME);
	}else if(fn_str.CompareNoCase( "GAutoD") == 0)
	{
		m_AutoD=0;
		//SendSystemMsg( "ÄúÒÑ¡¾¹Ø±Õ¡¿×Ô¶¯ÂôÇ°Á½ÅÅ", SYSTEM_NORMAL, TO_ME);
	}
				
	
	else if(fn_str.CompareNoCase( Tuoji) == 0)//¼ì²âÍÑ»ú
	{
			m_TuoJi=1;
	}
	/*else if( fn_str.CompareNoCase("Í¨¼©") == 0 )         //¸øÔª±¦
	{
		//if( m_tIsOP != 1 ) return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED)
		{
			SendSystemMsg("¶Ô·½²»ÔÚÏß,»òÕßÃ»ÓÐ´ËÓÃ»§!",SYSTEM_ERROR,TO_ME);
			return;
		}
		if( pUser->m_dwShopPingDN != 0)
		{ 
			SendSystemMsg("¶Ô·½ÒÑ¾­±»Í¨¼©ÖÐ!",SYSTEM_ERROR,TO_ME);
			return;
		}

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		
		 CString strMsg;
		    int dwTemp = FindItem(SPECIAL_BIAOZHI);
            
             if(  dwTemp < 100 )
			 {
				 SendSystemMsg("ÄúÃ»ÓÐ100±êÖ¾ÎÞ·¨·¢²¼Í¨¼©Áî!",SYSTEM_ERROR,TO_ME);
			      return;
		     }

            else if(  dwTemp >= 100 )
			{
			RobItem( 724, 100 );
            pUser->m_dwShopPingDN = 1;
            strMsg.Format("Íæ¼Ò:¡º %s ¡»·¢²¼¶Ô¡º %s ¡»µÄÍ¨¼©", this->m_strUserID,pUser->m_strUserID);//¹«¸æÌáÊ¾
            m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
		   }
			
		}*/
			

		
     ////////////////////////////////////////////////////////////////////////////////////////////////////
	else if(fn_str.CompareNoCase("ÄãÄÜ²Âµ½Âð") == 0 ) //ÎïÆ·±£»¤
	{	
		CString strMsg;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );		int z = atoi( fn );
		
        if (m_bPShopOpen == TRUE ||  m_bNowTrading == TRUE )
		{	
			strMsg.Format("ÇëÏÈ¹Ø±Õµ±Ç°×´Ì¬!");
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ERROR, TO_ME);
			return;
		 }
		if( m_isUser && o_yehuoini[0]->mimabaohu == 1 &&  m_TuoJi== 0)
		{	
			strMsg.Format("ÇëÏÈ¹Ø±ÕPKºóÔÚ²Ù×÷!");
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ERROR, TO_ME);
			return;
		 }
     
        if(z == NULL && o_yehuoini[0]->mimabaohu == 1)
		{
			strMsg.Format("Ã»ÓÐÊäÈëÃÜÂë»òÕßÃÜÂë¸ñÊ½²»¶Ô,ÇëÐÞ¸ÄÐÂÃÜ±£!");
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ERROR, TO_ME);
			return;
		}
		
		if(!strcmp(fn,JiaoXiMiMa))
		{
			m_MItemLock = !m_MItemLock;
			if(m_MItemLock)
				SendSystemMsg("ÎïÆ·±£»¤ÒÑ½â³ý!¹ÜÀíÔ±ÌáÐÑÄú½÷É÷½»Ò×!",SYSTEM_ERROR,TO_ME);
			else
				SendSystemMsg("ÎïÆ·±£»¤ÒÑ¿ªÆô!½»Ò×±£»¤ÖÐ!",SYSTEM_ERROR,TO_ME);
			return;
		}
		else
		{
			strMsg.Format("ÄúÊäÈëµÄÃÜÂë²»ÕýÈ·!"); 
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ERROR, TO_ME);
			return;
		}
	}

	else if(fn_str.CompareNoCase("ssdzf") == 0 ) //
	{	
		if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
		 if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
		 if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
		 if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
		 if( m_bZoneLogOut ) return;
		 if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
		 Shenshengzhufu();
	}
//=====================¼ÓµãÃüÁî½áÊø====================================================
	/*else if(fn_str.CompareNoCase( "¾è¿î¾­Ñé") == 0 )
	{	
		SetServerDoubleExp3();
	}
	else if(fn_str.CompareNoCase( "¾è¿îµô±¦") == 0 )
	{	
		SetServerDoubleBaoLv();
	}*/
//=====================µ÷ÊÔÃüÁî====================================================
	else if(fn_str.CompareNoCase( "ÈËÄ£ÐÍ") == 0){
	
			if(m_tIsOP != 1) 
			return;
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int z = atoi( fn );
				m_iSkin=z;	
			SendMyInfo(TO_INSIGHT, INFO_MODIFY);
			
		}
	else if(fn_str.CompareNoCase( "¹ÖÄ£ÐÍ") == 0){
	
			if(m_tIsOP != 1) 
			return;
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int z = atoi( fn );
				m_iHair=z;	
			SendMyInfo(TO_INSIGHT, INFO_MODIFY);
			
		}
//²âÊÔË¢10ÊôÐÔÎïÆ·ÃüÁî--------------------------------------------------------------------------------------
	else if( fn_str.CompareNoCase( o_yehuoini[0]->MAKE ) == 0 )
	{	
		if( m_tIsOP == 1 ) 
		{
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU1 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU2 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU3 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU4 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU5 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU6 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU7 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU8 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU9 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU10 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU11 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU12 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU13 = atoi( fn );
			index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
			int ML_SHU14 = atoi( fn );
			if( ML_SHU1 < 0 ||  ML_SHU1 >= g_arItemTable.GetSize()) return;
			GiveItemAll10(ML_SHU1, ML_SHU2, ML_SHU3, ML_SHU4, ML_SHU5, ML_SHU6, ML_SHU7,ML_SHU8, ML_SHU9, ML_SHU10, ML_SHU11, ML_SHU12, ML_SHU13, ML_SHU14);
			SendSystemMsg("ÄúËùÖÆ×÷µÄ×°±¸ÒÑÉú³É.",SYSTEM_NPC,TO_ME);
			//sprintf(strOP,"ÖÆÔìÎïÆ·");// Ð´GMÈÕÔÓ
			//========================================================================
			if ( o_yehuoini[0]->neice != 1 )
			{
				CString str = _T("");
				SYSTEMTIME st;
				CString strDate;
				GetLocalTime(&st);
				strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
				str.Format("[%s]Íæ¼Ò %s ÖÆ×÷ %s %d¸ö %d¸Ä ÑÕÉ«%d ÊôÐÔ:%d %d %d %d %d %d %d %d %d %d  \r\n",strDate,m_strUserID,g_arItemTable[ML_SHU1]->m_strName,ML_SHU2,ML_SHU3,ML_SHU4,ML_SHU5,ML_SHU6,ML_SHU7,ML_SHU8,ML_SHU9,ML_SHU10,ML_SHU11,ML_SHU12,ML_SHU13,ML_SHU14);
				EnterCriticalSection( &m_CS_FileWrite );
				g_fpGM.Write( str, str.GetLength() );
				LeaveCriticalSection( &m_CS_FileWrite);
			}
		   //=========================================================================
		}
	}
	else if(fn_str.CompareNoCase( "xiuli") == 0)
	{
		int iSuccess = 0;
		if (m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
		if (m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
	    if (m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
	    if (m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
	    if ( m_bZoneLogOut ) return;
		if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
		for(i = 0; i < EQUIP_ITEM_NUM; i++)	
		{
			if(m_UserItem[i].sSid < 0 || m_UserItem[i].sSid >= g_arItemTable.GetSize()) continue;	
			if (m_UserItem[i].sDuration != g_arItemTable[m_UserItem[i].sSid]->m_sDuration)
			{
				iSuccess = 1;
			}
		}if(iSuccess == 1)
		{
			RepairItemOpenReq(15);
		}else {
			SendEventMsg("Î´¼ì²âµ½¿ÉÐÞÀíµÄ×°±¸");
			return;
		}
	}



	//{
	//	int iSuccess = 0;
	//	if (m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
	//	if (m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
	//    if (m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
	//    if (m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
	//    if ( m_bZoneLogOut ) return;
	//	if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
	//	
	//	if(m_dwDN < 100000)
	//	{
	//		SendEventMsg("Ô¶³ÌÐÞÀíÐèÒª10Íò¾öÕ½±Ò!");
	//	    return ;
	//	}
	//	for(i = 0; i < EQUIP_ITEM_NUM; i++)	
	//	{
	//		if(m_UserItem[i].sSid < 0 || m_UserItem[i].sSid >= g_arItemTable.GetSize()) continue;	
	//		if (i == 2 ||i == 3 ||i == 5 || i == 6 || i == 7 )  continue;
	//		if (m_UserItem[i].sDuration != g_arItemTable[m_UserItem[i].sSid]->m_sDuration)
	//		{
	//			m_UserItem[i].sDuration = g_arItemTable[m_UserItem[i].sSid]->m_sDuration;
	//			iSuccess = 1;
	//		}
	//	}
	//	if(iSuccess == 1)
	//	{
	//		if( m_dwDN <= 100000 ) m_dwDN = 0;
	//		else m_dwDN = m_dwDN - 100000;
	//		UpdateUserItemDN();	
	//		SendMoneyChanged();
	//		SendUserStatusSkill();
	//		SendCharData();
	//		SendEventMsg("Ô¶³ÌÐÞÀí³É¹¦£¨10W£©");
	//	}else{
	//		SendEventMsg("Î´¼ì²âµ½¿ÉÐÞÀíµÄ×°±¸");
	//		return;
	//	}
	//}
	else if(fn_str.CompareNoCase( "gerenbank") == 0)
			{
				if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
				 if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
				 if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
				 if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
				 if( m_bZoneLogOut ) return;
				if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
			/*if ( m_dwZaiXianTime ==0 )
			{
				SendEventMsg("Ö»ÓÐ»áÔ±ÓÃ»§²Å¿ÉÒÔÊ¹ÓÃ´Ë¹¦ÄÜ!");
				return;
			}*/
				BankOpenReq();
	}

		else if(fn_str.CompareNoCase( "zonghebank") == 0)
		{
			if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
		     if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
			 if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
			 if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
			 if( m_bZoneLogOut ) return;
			if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
			if( m_sLevel < 10) return;
			/*if ( m_dwZaiXianTime ==0 )
			{
				SendEventMsg("Ö»ÓÐ»áÔ±ÓÃ»§²Å¿ÉÒÔÊ¹ÓÃ´Ë¹¦ÄÜ!");
				return;
			}*/
			
			AccountBankOpenReq(18);
		}
	    
		else if(fn_str.CompareNoCase( "emgc") == 0)
		{
			if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
		     if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
			 if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
			 if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
			 if( m_bZoneLogOut ) return;
			if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
			CheckDevilTime();
		}
		else if(fn_str.CompareNoCase( "pkds") == 0)
		{
			 if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
			 if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
			 if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
			 if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
			 if( m_bZoneLogOut ) return;
			if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
			CheckPKTime();
		}
//===============================================================================================================================
		 else if(fn_str.CompareNoCase( "maiyaoba") == 0)
		 {
			 if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
		     if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
			 if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
			 if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
			 if( m_bZoneLogOut ) return;
			 if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
			 
			 int iWeight = 0;
             int sid = -1;
             const int num = 1000;
			 
			 struct {
				 int id;
				 DWORD price;  
				 const char* name;
			} const potions[] = {
				{28, 50, "ºìA"},
				{29, 200, "ºìB"},
				{30, 500, "ºìC"},
				{994, 3000, "ºìD"}
			};
			int foundIndex = -1;
            bool hasMultiple = false;
			
			for(int i = 0; i < 4; i++) {
				
				if(FindItem(potions[i].id) > 0) 
				{
					if(foundIndex != -1)
					{
						hasMultiple = true;
						break;
					}
					foundIndex = i;
				}
			}
			if(foundIndex == -1 || hasMultiple)
			{
				SendEventMsg("Î´¼ì²âµ½°ü¹üºìÒ©,»òºìÒ©ÖÖÀàÌ«¶à!");
				return;
			}
			sid = potions[foundIndex].id;
			const DWORD totalPrice = static_cast<DWORD>(num) * potions[foundIndex].price;

			// ¼ì²é½ðÇ®
			if(m_dwDN < totalPrice) {
				SendEventMsg("Ã»ÓÐ×ã¹»µÄ½ðÇ®¹ºÂò");
				return;
			}

			iWeight = g_arItemTable[sid]->m_byWeight * num;
			if(m_iMaxWeight < m_iCurWeight + iWeight) {
				SendEventMsg("Ã»ÓÐ×ã¹»µÄ¸ºÖØ¹ºÂò");
				return;
			}

			// ¿Û³ý½ðÇ®
			m_dwDN = m_dwDN - totalPrice;
			UpdateUserItemDN();
			SendMoneyChanged();
			GiveItem(sid, num);
			
			char msg[100];
			sprintf(msg, "¹ºÂò%dÆ¿%s,»¨·Ñ%u½ð±Ò", 
            num, potions[foundIndex].name, totalPrice);
            SendEventMsg(msg);

		}
			
//================================================================================================================================
	
	else if( fn_str.CompareNoCase( "·âºÅ" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int nLength = strlen( fn );
		
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		USER* pUser = GetUser(fn);
		
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ
		
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)));
		int fenghaotime = atoi( fn );
		
		pUser->Closeuser(fenghaotime);
		sprintf(strOP,"%s,name=%s,time=%d","·âºÅ",m_strUserID,fenghaotime);
	}
	else if( fn_str.CompareNoCase( "ÊÍ·Å" ) == 0 )
	{
		if( m_tIsOP != 1 ) return;

		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );

		int nLength = strlen( fn );
		if(nLength <= 0 || nLength > CHAR_NAME_LENGTH) return;		// Àß¸øµÈ À¯Àú¾ÆÀÌµð 
		
		USER* pUser = GetUser(fn);
		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
		
		if(strcmp(pUser->m_strUserID, m_strUserID) == 0) return;	// ÀÚ±âÀÚ½ÅÀº ¾ÈµÊ
		pUser->Fchuuser();
		sprintf(strOP,"%s,name=%s","ÊÍ·Å",m_strUserID);
	}
	
	else if(fn_str.CompareNoCase( "ÂôÁË°É") == 0 )//D
	{	
		YJmzb();
				
	}
	else if(fn_str.CompareNoCase( "×é¶Ó°É") == 0)
	{
		USER *pUser = NULL;
		CBufferEx TempBuf;
		for(int i = 0; i < MAX_USER; i++ )
		{
			pUser = m_pCom->GetUserUid(i);
			if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;	
			if (pUser->m_bNowTrading == TRUE  ||  pUser->m_bPShopOpen == TRUE /*|| pUser->m_TuoJi==1*/) continue;
			if (pUser->m_bSessionOnline == TRUE) continue;
		//	int nLength = strlen( pUser->m_strUserID );
		//	if(nLength <= 0 || nLength > 20) continue;
			//if(m_curz != pUser->m_curz && !GetDistance( pUser->m_curx, pUser->m_cury, (SCREEN_X + SCREEN_Y) )) continue;//²»Í¬µØÍ¼²»¿É×é¶Ó
			int diffLevel = abs(m_sLevel - pUser->m_sLevel);
			if(diffLevel > 30) continue;
			if(m_curz ==1005 || m_curz == 92 || m_curz == 67 || m_curz == 61)continue;

			if(pUser->m_bMakeBuddy == TRUE)//¼ÓÈë×é¶Ó
			{ 
				SendSystemMsg( "ÕýÔÚÎªÄúÑ°ÕÒºÏÊÊµÄ¶ÓÎé.", SYSTEM_ERROR, TO_ME);
				for(int j = 0; j < MAX_BUDDY_USER_NUM; j++)	
				{	
					if(pUser->m_MyBuddy[j].uid == -1)
					{	
						TempBuf.AddString(m_strUserID);
						pUser->BuddyUserChange(TempBuf,BUDDY_INVITE);	
						return;
					}
				}
			}
			else if(pUser->m_bNowBuddy == FALSE)//´´½¨ÐÂ×é¶Ó	
			{
				//SendSystemMsg( "´´½¨¶ÓÎé³É¹¦!", SYSTEM_ERROR, TO_ME);
				TempBuf.AddString(pUser->m_strUserID);
				BuddyUserChange(TempBuf,BUDDY_INVITE);
				return;
			}
		}
	}
	
	else if(fn_str.CompareNoCase( "¾öÕ½±Ò") == 0){
		CString strTemp;
		strTemp.Format("ÄãÏÖÔÚ¾öÕ½±ÒÊýÁ¿Îª %d", m_dwDN);
		SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);

	}else if(fn_str.CompareNoCase( o_yehuoini[0]->MONEY ) == 0 )
	{	
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		int num = atoi( fn );

		if( m_tIsOP != 1 ) return; 

		if ( num <= 0 || num >2100000000 )
		{
			SendEventMsg("ÇëÕýÈ·ÊäÈë½ðÇ®ÊýÁ¿");
			return;
		}
		GiveDN(num);
		CString str;
		str.Format( "ÄãË¢³ö¾öÕ½±Ò %d", num);
        SendEventMsg(str.GetBuffer(0));
	}
		
	else if(fn_str.CompareNoCase("¿ª±©ÂÊ") == 0 )
	{
		if( m_tIsOP != 1 ) return;
		g_sanBaoLv = TRUE;
		USER *pUser = NULL;
		for (int i = 0; i < MAX_USER; i++ )
		{
			pUser = m_pCom->GetUserUid(i);
			if(pUser && pUser->m_state == STATE_GAMESTARTED )
			{
				pUser->SetXingYun();
			}
		}
		SendSystemMsg("ÏÖÔÚÈ«·þ¿ªÆôÈý±¶±©ÂÊ»î¶¯»Æ½ðÊ±¶Î,ÓÉÔ­À´±©2¼þÌáÉýµ½±©3¼þÎïÆ·.×£´ó¼ÒÓÎÏ·Óä¿ì!",SYSTEM_ANNOUNCE,TO_ALL);
	}
	else if(fn_str.CompareNoCase( "¹Ø±©ÂÊ") == 0 )
	{
		if( m_tIsOP != 1 ) return;
		g_sanBaoLv = FALSE;
		USER *pUser = NULL;
		for (int i = 0; i < MAX_USER; i++ )
		{
			pUser = m_pCom->GetUserUid(i);
			if(pUser && pUser->m_state == STATE_GAMESTARTED )
			{
				pUser->DelXingYun();
			}
		}
	}
	else if(fn_str.CompareNoCase("¿ªÈý±¶") == 0 )
	{
		if( m_tIsOP != 1 ) return;
		g_sanJingYan = TRUE;
		USER *pUser = NULL;
		for (int i = 0; i < MAX_USER; i++ )
		{
			pUser = m_pCom->GetUserUid(i);
			if(pUser && pUser->m_state == STATE_GAMESTARTED )
			{
				pUser->SetXingfen();
			}
		}
		SendSystemMsg("ÏÖÔÚÈ«·þ¿ªÆôÈý±¶¾­Ñé»î¶¯Ê±¶Î,È«·þ´ò¹Ö¾­ÑéÌáÉý3±¶.×£´ó¼ÒÓÎÏ·Óä¿ì!",SYSTEM_ANNOUNCE,TO_ALL);
	}
	else if(fn_str.CompareNoCase( "¹ØÈý±¶") == 0 )
	{
		if( m_tIsOP != 1 ) return;
		g_sanJingYan = FALSE;
		USER *pUser = NULL;
		for (int i = 0; i < MAX_USER; i++ )
		{
			pUser = m_pCom->GetUserUid(i);
			if(pUser && pUser->m_state == STATE_GAMESTARTED )
			{
				pUser->DelXingfen();
			}
		}
	}
	else if(fn_str.CompareNoCase( "×ªÖ°") == 0 )
	{
		if(m_tIsOP != 1) 
			return;
		ChangeJob(4,1000);
	}
	else if(fn_str.CompareNoCase( "×Ô¾È") == 0 )//ÇåÀíÄ§·¨
	{	

		if(m_tIsOP != 1) return;

		m_nHavePsiNum = 0;

	   for(i = 0; i < TOTAL_PSI_NUM; i++)					
	   {
		m_UserPsi[i].sSid = -1;
		m_UserPsi[i].tOnOff = FALSE;
	    }
	    SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// || 
        SendCharData();
	}else if(fn_str.CompareNoCase( "´óÕÖ") == 0 )//¸ø¸ö´óÕÖ
	{	

		if(m_tIsOP != 1) return;
        StudyNewJobPsi(30);
	} 
	else if(fn_str.CompareNoCase( "1") == 0 )//²âÊÔÄ§·¨
	{	
		if(m_tIsOP != 1) 
			return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );	
		int z = atoi( fn );
		SendPsiAttackResult(SUCCESS, m_uid + USER_BAND, z);
	}	
	else if(fn_str.CompareNoCase( "upopen") == 0 )
	{	
		if(m_tIsOP != 1) 
			return;
        index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		int z = atoi( fn );
		UpgradeItemOpen(z);
	}

    else if(fn_str.CompareNoCase( "say") == 0 )//·½±ãÍÑ»úº°¹«¸æ
	{
		if(m_tIsOP != 1) 
			return;
		index += ParseSpaceInUser( fn, pBuf+index, min(sizeof(fn), strlen(pBuf+index)) );
		CString str;
	    str.Format( "%s", fn);
	    SendSystemMsg(str.GetBuffer(0),SYSTEM_ANNOUNCE,TO_ALL);
	}
	if( m_tIsOP == 1 )
    {
    WriteOpratorLog(strOP,CHAT_LOG);//yskang 0.4
	}
}
bool USER::CheckShoppingDN(int needDN)//¿Û±êÖ¾
{
	if( (FindItem( 724) - needDN ) >=0)
	{
		RobItem(724,needDN);	
		return true;
	}
	else
	{ 
		return false;	
	}
	return false;
}
void USER::BuyOnlineShopItem(short id,short num)
{
	bool need_DN = false; 
	bool OnlineShopNull = false;

	short price,onNum;		
	bool isNullSlot = false;
	for(int isl = 10; isl < 34;isl++)
	{
		if(m_UserItem[isl].sSid == -1)	
		{
			isNullSlot = true;
			break;
		}
	} 
	if(isNullSlot)
	{
		for(int i = 0; i < g_arOnlineShopTable.GetSize();i++)
		{
			OnlineShopNull = false;
			if(id == g_arOnlineShopTable[i]->m_iSid)
			{
				price = g_arOnlineShopTable[i]->m_price;
				onNum = (g_arOnlineShopTable[i]->m_iNum * num);
				int iCost = (int)(g_arOnlineShopTable[i]->m_price * 0.9);//VIPÔÚÔ­»ù´¡ÉÏX9ÕÛ
				DWORD dwCast= (price-iCost)*num;//ÓÅ»ÝÖµ//(price*num)-(iCost*num);
			  if(m_dwZaiXianTime > 0)//Èç¹ûÊÇVIP¹ºÎï9ÕÛ
			  {
                if(CheckShoppingDN(iCost*num))
				{
					GiveItemAll(g_arOnlineShopTable[i]->m_iSid,onNum,g_arOnlineShopTable[i]->m_upgrade,
					g_arOnlineShopTable[i]->m_sx1,g_arOnlineShopTable[i]->m_sx2,g_arOnlineShopTable[i]->m_sx3,
					g_arOnlineShopTable[i]->m_sx4,g_arOnlineShopTable[i]->m_sx5,g_arOnlineShopTable[i]->m_sx6,
					g_arOnlineShopTable[i]->m_sx7,g_arOnlineShopTable[i]->m_sx8,g_arOnlineShopTable[i]->m_sx9,
					g_arOnlineShopTable[i]->m_sx10);
					SendUserStatusSkill();
					CString strMsg= "";
					strMsg.Format("VIP¹ºÎï9ÕÛ,¹º[%s]¿Û%d±êÖ¾,½ÚÊ¡%d±êÖ¾",g_arOnlineShopTable[i]->m_iSname,iCost*num,dwCast);
					SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg,SYSTEM_ERROR,TO_ME);
					CString strTemp;
					strTemp.Format( "ÄúµÄ±êÖ¾Ê£ÓàÊýÁ¿Îª: %d ¸ö", FindItem(724));
					SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);		

					
					WriteOnlineShop_Log(m_strUserID,g_arOnlineShopTable[i]->m_iSname,price*num,onNum,g_arOnlineShopTable[i]->m_upgrade,
					g_arOnlineShopTable[i]->m_sx1,g_arOnlineShopTable[i]->m_sx2,g_arOnlineShopTable[i]->m_sx3,
					g_arOnlineShopTable[i]->m_sx4,g_arOnlineShopTable[i]->m_sx5,g_arOnlineShopTable[i]->m_sx6,
					g_arOnlineShopTable[i]->m_sx7,g_arOnlineShopTable[i]->m_sx8,g_arOnlineShopTable[i]->m_sx9,
					g_arOnlineShopTable[i]->m_sx10);					
				}
				else need_DN = true;
				break;
			  } 
			  else
			  if(CheckShoppingDN(price*num))
				{
					GiveItemAll(g_arOnlineShopTable[i]->m_iSid,onNum,g_arOnlineShopTable[i]->m_upgrade,
					g_arOnlineShopTable[i]->m_sx1,g_arOnlineShopTable[i]->m_sx2,g_arOnlineShopTable[i]->m_sx3,
					g_arOnlineShopTable[i]->m_sx4,g_arOnlineShopTable[i]->m_sx5,g_arOnlineShopTable[i]->m_sx6,
					g_arOnlineShopTable[i]->m_sx7,g_arOnlineShopTable[i]->m_sx8,g_arOnlineShopTable[i]->m_sx9,
					g_arOnlineShopTable[i]->m_sx10);
					SendUserStatusSkill();
					CString strMsg= "";
					strMsg.Format("¹ºÂò [%s] ¼õÉÙ%d±êÖ¾,½ÚÊ¡0±êÖ¾.",g_arOnlineShopTable[i]->m_iSname,price*num);
					SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg,SYSTEM_ERROR,TO_ME);
					CString strTemp;
					strTemp.Format( "ÄúµÄ±êÖ¾Ê£ÓàÊýÁ¿Îª: %d ¸ö", FindItem(724));
					SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);		

					
					WriteOnlineShop_Log(m_strUserID,g_arOnlineShopTable[i]->m_iSname,price*num,onNum,g_arOnlineShopTable[i]->m_upgrade,
					g_arOnlineShopTable[i]->m_sx1,g_arOnlineShopTable[i]->m_sx2,g_arOnlineShopTable[i]->m_sx3,
					g_arOnlineShopTable[i]->m_sx4,g_arOnlineShopTable[i]->m_sx5,g_arOnlineShopTable[i]->m_sx6,
					g_arOnlineShopTable[i]->m_sx7,g_arOnlineShopTable[i]->m_sx8,g_arOnlineShopTable[i]->m_sx9,
					g_arOnlineShopTable[i]->m_sx10);					
				}
				else need_DN = true;
				break;
			
			}	
			else	OnlineShopNull = true;
		}
	}
	else
	{		
		SendNpcSay(NULL, 512);
	}
	if(OnlineShopNull)
		SendSystemMsg(IDS_NOT_HAVING_ITEM,SYSTEM_ERROR,TO_ME);
	if(need_DN)
		SendSystemMsg(IDS_SHOPDN_ERROR,SYSTEM_ERROR,TO_ME);	
}
int USER::RandChouJiang()
{
/*	if(!CheckShoppingDN(200)) 
	{
		SendSystemMsg("Ôª±¦²»×ã,²Î¼Ó³é½±ÐèÒª200Ôª±¦.",SYSTEM_ERROR,TO_ME);
		return 3;
	}*/
//	if(m_dwRandNum > 0)
//	{
			bool isNullSlot = false;
			for(int isl = 10; isl < 34;isl++)
			{
				if(m_UserItem[isl].sSid == -1)	
				{
					isNullSlot = true;
					break;
				}
			} 
			if(isNullSlot)
			{
				int sum = g_arKaixiangziTable.GetSize();
				int i = myrand(0, sum-1);
				CString RandName = g_arKaixiangziTable[i]->m_iSname;
				short onNum = g_arKaixiangziTable[i]->m_iNum;
				/*char sendMsg[200] = "";
				strcat_s(sendMsg,"´Ó±¦Ïä");
				strcat_s(sendMsg," »ñµÃ:");
				strcat_s(sendMsg,RandName);								
				CBufferEx	TempBuf;
				TempBuf.Add((byte)0x1f);
				TempBuf.Add((byte)1);
				TempBuf.Add((byte)0x25);
				TempBuf.Add((DWORD)0);
		        TempBuf.AddString(m_strUserID);
				TempBuf.AddString(sendMsg);
				SendAll(TempBuf, TempBuf.GetLength());	*/
//////////////////////////ÏÂÃæÁÄÌìÏÔÊ¾ÐÅÏ¢¿ªÊ¼/////////////////////////////////////////////////////////////////////
				
				CString strMsg = _T("");
                strMsg.Format( "%s ´ò¿ª¹§Ï²·¢²Æ»ñµÃ [%s¸ö]", m_strUserID,g_arKaixiangziTable[i]->m_iSname);
				SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE,TO_ALL);
//////////////////////////ÉÏÃæÁÄÌìÏÔÊ¾ÐÅÏ¢½áÊø//////////////////////////////////////////////////////////////////////
///////////////////////////¿Ûµô¿ªÏäËùÐèÇ®Êý///////////////////////////////////////////
			//	if( m_dwDN <= 500000 ) m_dwDN = 0;
		      //  else m_dwDN = m_dwDN - 500000;
		       // UpdateUserItemDN();						
		        //SendMoneyChanged();	
///////////////////////////¿Ûµô¿ªÏäËùÐèÇ®Êý///////////////////////////////////////////
				GiveItemAll(g_arKaixiangziTable[i]->m_iSid,onNum,g_arKaixiangziTable[i]->m_upgrade,
							g_arKaixiangziTable[i]->m_sx1,g_arKaixiangziTable[i]->m_sx2,g_arKaixiangziTable[i]->m_sx3,
							g_arKaixiangziTable[i]->m_sx4,g_arKaixiangziTable[i]->m_sx5,g_arKaixiangziTable[i]->m_sx6,
							g_arKaixiangziTable[i]->m_sx7,g_arKaixiangziTable[i]->m_sx8,g_arKaixiangziTable[i]->m_sx9,
							g_arKaixiangziTable[i]->m_sx10);
			    return 1;
			}
			else
			{
				SendNpcSay(NULL, 512);	
				return 2;
			}
//	}
//	return 0;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	ÀÌº¥Æ® »óÇ°±ÇÀ» È¸¼öÇÑ´Ù.
//
int USER::FindInventItem(int sid)
{
	for(int i=EQUIP_ITEM_NUM;i<TOTAL_INVEN_MAX;i++){
		if(sid==m_UserItem[i].sSid)
			return i;
	}
	return -1;
}
//ÊÇ·ñ»úÐµÉíÌå
BOOL USER::IsEbodyItem(int sSid)
{
	int i,nCount = g_arEBodyIdentifyTable.GetSize();
	for(i = 0;i<nCount;i++)
	{
		if(sSid == g_arEBodyIdentifyTable[i]->m_sSid)
			return TRUE;
	}
	if(sSid == 987)
		return TRUE;
	return FALSE;
}

//ÊÇ·ñÎª³¬¼¶»úÐµÉíÌå
BOOL USER::IsSuperEbodyItem(int sSid)
{
	//1247-1252Í·
	//1253-1267ÒÂ·þ
	//1268-1270ÊÖ±Û
	//1271-1276¿ã×Ó
	//1277 Í·
	short sEbodyID[]={877,878,879,880,881,883,//Í·
		884,885,886,887,888,889,890,891,892,893,890,891,892,893,
		894,895,896,897,898,899,987,
		901,902,903,904,905,906};
	short sConvertEbodyID[]={1247,1248,1249,1250,1251,1252,//Í·
		1253,1254,1255,1256,1257,1258,1259,1260,1261,1262,1263,1264,1265,1266,
		1268,1269,1270,1268,1269,1269,1270,
		1271,1272,1273,1274,1275,1276};
	//short sConvertEbodyID[]={1270,1247,1257,1268,1272,1258,1265,1273,1254,1269,1274,1251,1259,1266,1275,
	//	1250,1260,1267,1276,1253,1264,1249,1255,1256,1248,1261,1262,1277,1252};

	int nECount = sizeof(sConvertEbodyID)/sizeof(sConvertEbodyID[0]);
	int i;
	for(i = 0;i<nECount;i++)
	{
		if(sSid == sConvertEbodyID[i])
		{
			return TRUE;
		}
	}
	return FALSE;
}								
BOOL USER::OpenOnShop()
{
	/*CString strTemp;
	strTemp.Format( "ÄúµÄ¾öÕ½±ÒÊýÁ¿Îª: %d ¸ö", m_dwDN);
	SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);		*/
	
	CBufferEx TempBuf;
	int i = 0;
	DWORD dwCost = 0;

	TempBuf.Add(STORE_OPEN);
	TempBuf.Add((short)50);
	TempBuf.Add((short)0);
	TempBuf.Add((short)(g_arOnlineShopTable.GetSize()));

	for(i = 0; i < g_arOnlineShopTable.GetSize(); i++)
	{
		TempBuf.Add(g_arOnlineShopTable[i]->m_iSid);
		dwCost = (DWORD)g_arOnlineShopTable[i]->m_price;
		TempBuf.Add(dwCost);			
	}

	Send(TempBuf, TempBuf.GetLength());
	return TRUE;
}
//////////////////////////////////////////////////////////////
///////////°Ù¼¶×°±¸»¹Ô­
BOOL USER::HuanYuan100()
{ //»¹Ô­°Ù¼¶
	int sSid= -1;	
	int index=0;
 	sSid = m_UserItem[33].sSid;	
	if(sSid != 1053 && sSid != 1089 && sSid != 1054 && sSid != 1055 && sSid != 1056 && sSid != 1090 && 
	    sSid != 1091 && sSid != 1092 && sSid != 1065 && sSid != 1066 && sSid != 1067 && sSid != 1068 &&
	    sSid != 1057 && sSid != 1058 && sSid != 1059 && sSid != 1060 && sSid != 1069 && sSid != 1070 &&
	    sSid != 1071 && sSid != 1072 && sSid != 1061 && sSid != 1062 && sSid != 1063 && sSid != 1064 &&
	    sSid != 1082 && sSid != 1083 && sSid != 1084 && sSid != 1073 && sSid != 1074 && sSid != 1075 &&
	    sSid != 1076 && sSid != 1085 && sSid != 1086 && sSid != 1087 && sSid != 1088 && sSid != 1077 &&
	    sSid != 1078 && sSid != 1079 && sSid != 1080 && sSid != 1081 && sSid != 1709 && sSid != 1710 &&
		sSid != 1711 && sSid != 1712 && sSid != 1713 && sSid != 1714 && sSid != 1715 && sSid != 1716|| sSid == -1)
	{
    SendSystemMsg( "Çë°ÑÒª»¹Ô­µÄ°Ù¼¶×°±¸·ÅÎïÆ·À¸×îºóÒ»ÐÐ×îºóÒ»¸ñ", SYSTEM_ERROR, TO_ME);
		return FALSE;
	}	
    
	CUIntArray arMaterial;	
	arMaterial.Add(33);	
	{
		ItemList	TempItem;
		TempItem = m_UserItem[33];	
		ReSetItemSlot(&m_UserItem[33]);
		m_UserItem[33] = TempItem;
		switch(sSid)
		{
		case 1053:
			m_UserItem[33].sSid = 343;
			break;
		case 1089:
			m_UserItem[33].sSid = 373;
			break;
		case 1054:
			m_UserItem[33].sSid = 530;
			break;
		case 1055:
			m_UserItem[33].sSid = 531;
			break;
		case 1056:
			m_UserItem[33].sSid = 532;
			break;
		case 1090:
			m_UserItem[33].sSid = 620;
			break;
		case 1091:
			m_UserItem[33].sSid = 621;
			break;
		case 1092:
			m_UserItem[33].sSid = 622;
			break;
		case 1065:
			m_UserItem[33].sSid = 757;
			break;
		case 1066:
			m_UserItem[33].sSid = 758;
			break;
		case 1067:
			m_UserItem[33].sSid = 759;
			break;
		case 1068:
			m_UserItem[33].sSid = 760;
			break;
		case 1057:
			m_UserItem[33].sSid = 761;
			break;
		case 1058:
			m_UserItem[33].sSid = 762;
			break;
		case 1059:
			m_UserItem[33].sSid = 763;
			break;
		case 1060:
			m_UserItem[33].sSid = 764;
			break;
		case 1069:
			m_UserItem[33].sSid = 765;
			break;
		case 1070:
			m_UserItem[33].sSid = 766;
			break;
		case 1071:
			m_UserItem[33].sSid = 767;
			break;
		case 1072:
			m_UserItem[33].sSid = 768;
			break;
		case 1061:
			m_UserItem[33].sSid = 769;
			break;
		case 1062:
			m_UserItem[33].sSid = 770;
			break;
		case 1063:
			m_UserItem[33].sSid = 771;
			break;
		case 1064:
			m_UserItem[33].sSid = 772;
			break;
		case 1082:
			m_UserItem[33].sSid = 775;
			break;
		case 1083:
			m_UserItem[33].sSid = 776;
			break;
		case 1084:
			m_UserItem[33].sSid = 777;
			break;
		case 1073:
			m_UserItem[33].sSid = 778;
			break;
		case 1074:
			m_UserItem[33].sSid = 779;
			break;
		case 1075:
			m_UserItem[33].sSid = 780;
			break;
		case 1076:
			m_UserItem[33].sSid = 781;
			break;
		case 1085:
			m_UserItem[33].sSid = 782;
			break;
		case 1086:
			m_UserItem[33].sSid = 783;
			break;
		case 1087:
			m_UserItem[33].sSid = 784;
			break;
		case 1088:
			m_UserItem[33].sSid = 785;
			break;
		case 1077:
			m_UserItem[33].sSid = 786;
			break;
		case 1078:
			m_UserItem[33].sSid = 787;
			break;
		case 1079:
			m_UserItem[33].sSid = 788;
			break;
		case 1080:
			m_UserItem[33].sSid = 789;
			break;
		case 1081:
			m_UserItem[33].sSid = 797;
			break;
		case 1709:
			m_UserItem[33].sSid = 1701;
			break;
		case 1710:
			m_UserItem[33].sSid = 1702;
			break;
		case 1711:
			m_UserItem[33].sSid = 1703;
			break;
		case 1712:
			m_UserItem[33].sSid = 1704;
			break;
		case 1713:
			m_UserItem[33].sSid = 1705;
			break;
		case 1714:
			m_UserItem[33].sSid = 1706;
			break;
		case 1715:
			m_UserItem[33].sSid = 1707;
			break;
		case 1716:
			m_UserItem[33].sSid = 1708;
			break;
		}
        m_UserItem[33].tMagic[10] = 0;//Í¬Ê±È¥³ý»ÃµÚ5ÅÅ
		m_UserItem[33].tMagic[9] = 0;//Í¬Ê±È¥³ý»ÃµÚ4ÅÅ
		m_UserItem[33].tMagic[8] = 0;//Í¬Ê±È¥³ý»ÃµÚ3ÅÅ
		m_UserItem[33].tMagic[7] = 0;//Í¬Ê±È¥³ý»ÃµÚ2ÅÅ
        m_UserItem[33].tMagic[6] = 0;//Í¬Ê±È¥³ý»ÃµÚ1ÅÅ
		m_UserItem[33].tMagic[5] = 0;//Í¬Ê±È¥³ý¸ÄÊý
		m_UserItem[33].tMagic[4] = 0;//Í¬Ê±È¥³ý¸ÄÊý
		m_UserItem[33].tIQ = 3;
		
	}		

	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	FlushItemLog( TRUE );
	return TRUE;
}
//////////////////////////////////////////////////////////////
///////////130×°±¸»¹Ô­
BOOL USER::HuanYuan130()
{ //»¹Ô­130
	int sSid= -1;	
	int index=0;
 	sSid = m_UserItem[33].sSid;	
	if(  (sSid != 1199 && sSid != 1200 && sSid != 1201 && sSid != 1202 &&
		 sSid != 1203 && sSid != 1204 && sSid != 1205 && sSid != 1206  &&
		 sSid != 1207 && sSid != 1208 && sSid != 1209 && sSid != 1210  &&
		 sSid != 1211 && sSid != 1212 && sSid != 1213 && sSid != 1214 ) || sSid == -1)
	{
    SendSystemMsg( "Çë°ÑÒª»¹Ô­µÄ130¼¶×°±¸·ÅÎïÆ·À¸×îºóÒ»ÐÐ×îºóÒ»¸ñ", SYSTEM_ERROR, TO_ME);
		return FALSE;
	}	
    
	CUIntArray arMaterial;	
	arMaterial.Add(33);	
	{
		ItemList	TempItem;
		TempItem = m_UserItem[33];	
		ReSetItemSlot(&m_UserItem[33]);
		m_UserItem[33] = TempItem;
		switch(sSid)
		{
		case 1199: //Ã±×Ó
	    case 1203:
		case 1207:
	    case 1211:
			m_UserItem[33].sSid = 1056;
			break;
			 
        
		case 1202:   //Ð¬×Ó
		case 1206:
		case 1210:
		case 1214:
	        m_UserItem[33].sSid = 1092;
			break;
	 
		//case 1200:
		//	m_UserItem[33].sSid = 1060;
		//	break;

	    case 1200:  //ÒÂ·þ
		  m_UserItem[33].sSid = 1060;
		  break;

        case 1204:  //ÒÂ·þ
			 m_UserItem[33].sSid = 1068;
			 break;

		case 1208:    //ÒÂ·þ
			 m_UserItem[33].sSid = 1076;
			 break;

		case 1212:   //ÒÂ·þ
			 m_UserItem[33].sSid = 1084;
			 break;


	    case 1201:   //¿ã×Ó
			 m_UserItem[33].sSid = 1064;
			 break;

        case 1205:   //¿ã×Ó
			 m_UserItem[33].sSid = 1072;
			 break;

		case 1209:   //¿ã×Ó
			 m_UserItem[33].sSid = 1080;
			 break;

		case 1213:  //¿ã×Ó
			 m_UserItem[33].sSid = 1088;
			 break;

    }
   //     m_UserItem[33].tMagic[6] = 0;//Í¬Ê±È¥³ýµÚ6ÅÅ
//		m_UserItem[33].tMagic[5] = 0;
		m_UserItem[33].tIQ = 12;
		
	}		

	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	FlushItemLog( TRUE );
	return TRUE;
}
/////////////////////////////////////////////////////////////////////////////
//¼àÀÎ
//
void USER::Closeuser(int ftime)
{
	CString strMsg= "";
	strMsg.Format( "ÄãÊÜµ½·âºÅ%d·ÖÖÓµÄ´¦·£!!!", ftime );
	SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME );
	m_dwCloseTime = (60 * ftime * 1000);
	AddAbnormalInfo(ABNORMAL_JIANYU);
	m_curz = 402;
	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
}
/////////////////////////////////////////////////////////////////////////////
//¼àÀÎ
//
void USER::Fchuuser()
{
	m_dwCloseTime = 0;
	DeleteAbnormalInfo(ABNORMAL_JIANYU);
	SendSystemMsg("´Ó¼àÓüÖÐÊÍ·Å!!",SYSTEM_NORMAL,TO_ME);
	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
}
void USER::FengSiNi()
{
	m_dwCloseTime = 3600*10*1000;
	AddAbnormalInfo(ABNORMAL_JIANYU);
	m_curz = 402;
	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	ÀÌº¥Æ® »óÇ°±ÇÀ» È¸¼öÇÑ´Ù.
//
void USER::EventUpgradeItemReq(TCHAR *pBuf)
{
	short sSid = 0;
	int index = 0, j;
	int event = 0, iWeight = 0;
	int event_index = -1;

	int iIQ = 0, upgrade_num = 0;

	BOOL bSuccess = TRUE;

	CBufferEx TempBuf;

	BYTE tEventSlot = GetByte(pBuf, index);				// ÀÌº¥Æ® »óÇ°±Ç ½½·Ô
	BYTE tItemSlot = GetByte(pBuf, index);				// ¾÷±ÛÇÏ±âÀ§ÇÑ ÇØ´ç ½½·Ô 

	if(tEventSlot < EQUIP_ITEM_NUM || tEventSlot >= TOTAL_INVEN_MAX) goto go_result;
	if(tItemSlot < EQUIP_ITEM_NUM || tItemSlot >= TOTAL_INVEN_MAX) goto go_result;

	sSid = m_UserItem[tEventSlot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) goto go_result;

	sSid = m_UserItem[tItemSlot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) goto go_result;

	if(g_arItemTable[sSid]->m_sDuration <= 0) goto go_result;		// ³»±¸µµ°¡ ¾øÀ¸¸é °ÅºÎ		
	if(m_UserItem[tItemSlot].tIQ != NORMAL_ITEM) goto go_result;	// ÀÏ¹Ý ¾ÆÀÌÅÛ¸¸ ÇÑ´Ù.
	if(m_UserItem[tItemSlot].tMagic[5] > 0) goto go_result;			// ¾÷±×·¹ÀÌµå ¾ÆÀÌÅÛµµ ¾ÈµÈ´Ù.

	iIQ = (int)m_UserItem[tEventSlot].tIQ;

	if(g_arItemTable[sSid]->m_byWear == ATTACK_ITEM)	// °ø°Ý¿ë ¹«±â
	{
		if(m_UserItem[tEventSlot].tIQ < EVENT_ITEM_BAND) goto go_result;
		if(iIQ != 240 && iIQ != 244 && iIQ != 242 && iIQ != 246 && iIQ != 248 &&
		iIQ != 101 && iIQ != 103 && iIQ != 204 && iIQ != 105 && iIQ != 107) goto go_result;

		event = CheckEventItem(event_index, (int)tEventSlot);
		if(event < 0)
		{
			TRACE("CANT FIND CHANGE OF ARMS\n");
//			SendSystemMsg( IDS_USER_NO_CHANGE_THIS, SYSTEM_ERROR, TO_ME);
//			goto go_result;								// ½Ã¸®¾ó ¹øÈ£°¡ Æ²¸®´Ù.
		}

		if(event_index < 0) 
		{
			TRACE("¹«±â ±³È¯±ÇÀ» Ã£À»¼ö°¡ ¾ø´Ù.\n");
//			goto go_result;
		}
																	// È¤½Ã³ª ÂÊ³ª´Â°ÍÀ» ¹æÁöÇÏ±â À§ÇØ
//		if(InterlockedCompareExchange(&g_arEventItemTable[event]->m_lUsed, (LONG)1, (LONG)0) == 0)
//		{
		if(!UpdateEventItem(event))
		{
			TRACE("¹«±â ¾÷µ« ½ÇÆÐ\n");
//			InterlockedExchange(&g_arEventItemTable[event_index]->m_lUsed, 0);
//			InterlockedExchange(&g_arAddEventItemTable[event_index]->m_lUsed, 0);
//			goto go_result;
		}

//		g_arAddEventItemTable[event_index]->m_tGiveItem = 1;				// ¸ñ·Ï¿¡¼­ ¼ÂÆÃ
//		CEventItemTable *pEvent = g_arAddEventItemTable[event_index];
		switch(iIQ)
		{
		case EVENT_ATT7_ITEM:
			upgrade_num = 7;
			break;
		case EVENT_ATT6_ITEM:
			upgrade_num = 6;
			break;
		case EVENT_ATT_ITEM:
			upgrade_num = 5;
			break;
		case EVENT_ATT4_ITEM:
			upgrade_num = 4;
			break;
		case EVENT_ATT3_ITEM:
			upgrade_num = 3;
			break;
		}

		m_UserItem[tItemSlot].tMagic[4] = ATTACK_UPGRADE_BAND * upgrade_num;
		m_UserItem[tItemSlot].tMagic[5] = upgrade_num;	// ¸¶Áö¸· ½½·Ô¿¡ ¼º°øÈ½¼ö¸¦ Áõ°¡ ½ÃÅ²´Ù.

		MakeItemLog( &m_UserItem[tItemSlot], ITEMLOG_UPGRADE_SUCCESS );
					
		bSuccess = FALSE;
		iWeight = g_arItemTable[m_UserItem[tEventSlot].sSid]->m_byWeight;
		ReSetItemSlot(&m_UserItem[tEventSlot]);
//		}
	}
	else
	{
		if(m_UserItem[tEventSlot].tIQ < EVENT_ITEM_BAND) goto go_result;
		if(iIQ != 241 && iIQ != 245 && iIQ != 243 && iIQ != 247 && iIQ != 249 &&
		iIQ != 102 && iIQ != 104 && iIQ != 203 && iIQ != 106 && iIQ != 108) goto go_result;

		event = CheckEventItem(event_index, (int)tEventSlot);
		if(event < 0)
		{
			TRACE("¹æ¾î ±³È¯±ÇÀ» Ã£À»¼ö°¡ ¾ø´Ù.\n");
//			SendSystemMsg( IDS_USER_NO_CHANGE_THIS, SYSTEM_ERROR, TO_ME);
//			goto go_result;								// ½Ã¸®¾ó ¹øÈ£°¡ Æ²¸®´Ù.
		}

		if(event_index < 0) 
		{
			TRACE("¹æ¾î ±³È¯±ÇÀ» Ã£À»¼ö°¡ ¾ø´Ù.\n");
//			goto go_result;
		}
																	// È¤½Ã³ª ÂÊ³ª´Â°ÍÀ» ¹æÁöÇÏ±â À§ÇØ
//		if(InterlockedCompareExchange(&g_arEventItemTable[event]->m_lUsed, (LONG)1, (LONG)0) == 0)
//		{
		if(!UpdateEventItem(event))
		{
			TRACE("¹æ¾î ¾÷µ« ½ÇÆÐ\n");
//			InterlockedExchange(&g_arEventItemTable[event_index]->m_lUsed, 0);
//			InterlockedExchange(&g_arAddEventItemTable[event_index]->m_lUsed, 0);
//			goto go_result;
		}

//		g_arEventItemTable[event_index]->m_tGiveItem = 1;				// ¸ñ·Ï¿¡¼­ ¼ÂÆÃ
//		g_arAddEventItemTable[event_index]->m_tGiveItem = 1;				// ¸ñ·Ï¿¡¼­ ¼ÂÆÃ
		switch(iIQ)
		{
		case EVENT_DEF7_ITEM:
			upgrade_num = 7;
			break;
		case EVENT_DEF6_ITEM:
			upgrade_num = 6;
			break;
		case EVENT_DEF_ITEM:
			upgrade_num = 5;
			break;
		case EVENT_DEF4_ITEM:
			upgrade_num = 4;
			break;
		case EVENT_DEF3_ITEM:
			upgrade_num = 3;
			break;
		}
		m_UserItem[tItemSlot].tMagic[4] = DEFENSE_UPGRADE_BAND * upgrade_num;
		m_UserItem[tItemSlot].tMagic[5] = upgrade_num;	// ¸¶Áö¸· ½½·Ô¿¡ ¼º°øÈ½¼ö¸¦ Áõ°¡ ½ÃÅ²´Ù.

		MakeItemLog( &m_UserItem[tItemSlot], ITEMLOG_UPGRADE_SUCCESS );

		bSuccess = FALSE;
		iWeight = g_arItemTable[m_UserItem[tEventSlot].sSid]->m_byWeight;
		ReSetItemSlot(&m_UserItem[tEventSlot]);
//		}
	}

	FlushItemLog( TRUE );

go_result:
	TempBuf.Add(UPGRADE_ITEM_RESULT);

	if(bSuccess)
	{
		TempBuf.Add((BYTE)0x00); //½ÇÆÐ
	}
	else TempBuf.Add((BYTE)0x01);				// ¼º°ø

	TempBuf.Add((BYTE)0x02);				// ½½·Ô 2°³°¡ º¯µ¿

	TempBuf.Add(tItemSlot);					// ÁÖ ¾ÆÀÌÅÛ¸¦ ¸ÕÀú 	
	TempBuf.Add(m_UserItem[tItemSlot].sLevel);
	TempBuf.Add(m_UserItem[tItemSlot].sSid);
	TempBuf.Add(m_UserItem[tItemSlot].sDuration);
	TempBuf.Add(m_UserItem[tItemSlot].sBullNum);
	TempBuf.Add(m_UserItem[tItemSlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[tItemSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[tItemSlot].tIQ); 

	TempBuf.Add(tEventSlot);
	TempBuf.Add(m_UserItem[tEventSlot].sLevel);
	TempBuf.Add(m_UserItem[tEventSlot].sSid);
	TempBuf.Add(m_UserItem[tEventSlot].sDuration);
	TempBuf.Add(m_UserItem[tEventSlot].sBullNum);
	TempBuf.Add(m_UserItem[tEventSlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[tEventSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[tEventSlot].tIQ); 

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	UpdateUserItemDN();

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

	Send(TempBuf, TempBuf.GetLength());
}

int USER::CheckEventItem(int &index, int iSlot, BOOL bPotion)
{	
	int i, j;
	int nNum = 0;
	CString strTemp;
	CString strSerial = _T("");

	for(j = 0; j < MAGIC_NUM; j++)
	{
		strTemp = _T("");
		strTemp.Format("%d", m_UserItem[iSlot].tMagic[j]);
		if(j < (MAGIC_NUM - 1)) strTemp += "-";

		strSerial += strTemp;
	}

	for(i = 0; i < g_arAddEventItemTable.GetSize(); i++)
	{
		if(g_arAddEventItemTable[i]->m_tType == m_UserItem[iSlot].tIQ)
		{
			if(strSerial.CompareNoCase(g_arAddEventItemTable[i]->m_strSerialNum) == 0)
			{
				if(InterlockedCompareExchange((LONG*)&g_arAddEventItemTable[i]->m_lUsed, (long)1, (long)0) == (long)0) 
				{
					index = i;
					g_arAddEventItemTable[i]->m_tEnd = 1;
					return g_arAddEventItemTable[i]->m_sSid;
				}
			}
		}

		nNum = 0;
	}

	return -1;
}

BOOL USER::UpdateEventItem(int sid)
{
	if(sid < 0) return FALSE;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];
	int				i = 1;

	SQLSMALLINT	sRet = -1;
	SQLINTEGER	iRetInd = SQL_NTS;

	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_GIVE_EVENT_ITEM(%d, ?)}"), sid);

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update EVENT_ITEM Data Only!!\n");
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		i = 1;
		SQLBindParameter( hstmt, i++ ,SQL_PARAM_OUTPUT,SQL_C_SSHORT, SQL_SMALLINT,0,0, &sRet,0, &iRetInd);
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	if(sRet == 100 || sRet < 0)
	{
		return FALSE;
	}

	return TRUE;
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	ÀÌº¥Æ® ¹°¾à »óÇ°±ÇÀ» È¸¼öÇÏ±âÀ§ÇØ ÀÌº¥Æ® ¹øÈ£¿Í tIQ¸¦ È®ÀÎÇÑÈÄ ÇØ´ç ¾ÆÀÌÅÛÀ» °¹¼ö¸¸Å­ ÁØ´Ù..
//
void USER::GiveEventItem(int EventItemIndex, int tIQ, int ItemIndex, int Count)
{
	return;

	int i, j;
	int event = 0;
	int event_index = -1;

	ItemList TempItem;

	ReSetItemSlot(&TempItem);
	if(ItemIndex < 0 || ItemIndex >= g_arItemTable.GetSize()) return;

	for(i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + INVENTORY_NUM; i++)
	{
		if(m_UserItem[i].sSid == EventItemIndex)
		{
			if(m_UserItem[i].tIQ == EVENT_POT_ITEM)
			{
				event = CheckEventItem(event_index, i, TRUE);
				if(event < 0) break;								// ½Ã¸®¾ó ¹øÈ£°¡ Æ²¸®´Ù.
																	// È¤½Ã³ª ÂÊ³ª´Â°ÍÀ» ¹æÁöÇÏ±â À§ÇØ
				if(event_index < 0) break;

				if(InterlockedCompareExchange((LONG*)&g_arEventItemTable[event_index]->m_lUsed, (long)1, (long)0) == (long)0)
				{
					TempItem = m_UserItem[i];

					ReSetItemSlot(&m_UserItem[i]);

					m_UserItem[i].sLevel = g_arItemTable[ItemIndex]->m_byRLevel;
					m_UserItem[i].sSid = ItemIndex;
					m_UserItem[i].sCount = Count;
					m_UserItem[i].sDuration = g_arItemTable[ItemIndex]->m_sDuration;
					m_UserItem[i].sBullNum = g_arItemTable[ItemIndex]->m_sBullNum;
					m_UserItem[i].tIQ = NORMAL_ITEM;

					if(!UpdateEventItem(event))
					{
						ReSetItemSlot(&m_UserItem[i]);
						m_UserItem[i] = TempItem;
						InterlockedExchange(&g_arEventItemTable[event_index]->m_lUsed, 0);
						
						break;
					}

					g_arEventItemTable[event_index]->m_tGiveItem = 1;		// ¸ñ·Ï¿¡¼­ ¼ÂÆÃ

					m_iCurWeight += g_arItemTable[ItemIndex]->m_byWeight * Count;

					UpdateUserItemDN();

					GetRecoverySpeed();								// È¸º¹¼Óµµ Ã¼Å©...

					CBufferEx TempBuf;
					TempBuf.Add(ITEM_USE_RESULT);

					TempBuf.Add((BYTE)0x01);						// ¼º°ø
					TempBuf.Add((BYTE)103);							// ½½·Ô 1°³°¡ º¯µ¿

					TempBuf.Add((BYTE)i);							// ÁÖ ¾ÆÀÌÅÛ¸¦ ¸ÕÀú 	
					TempBuf.Add(m_UserItem[i].sLevel);
					TempBuf.Add(m_UserItem[i].sSid);
					TempBuf.Add(m_UserItem[i].sDuration);
					TempBuf.Add(m_UserItem[i].sBullNum);
					TempBuf.Add(m_UserItem[i].sCount);
					for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[i].tMagic[j]);
					TempBuf.Add(m_UserItem[i].tIQ); 
					Send(TempBuf, TempBuf.GetLength());	

					SendSystemMsg( IDS_USER_CHANGE_COMPLETED, SYSTEM_ERROR, TO_ME);
					return;
				}
			}
		}
	}

	SendSystemMsg( IDS_USER_NO_CHANGE_THIS, SYSTEM_ERROR, TO_ME);
}


BOOL USER::OpenOnWeb()
{
	//´ò¿ªÓÎÏ·ÀïµÄIE
	CBufferEx TempBuf;
	TempBuf.Add((BYTE)243);	
	TempBuf.AddString(o_yehuoini[0]->WEB_URL);
	Send(TempBuf, TempBuf.GetLength());
	return TRUE;
}
void USER::SuitUpgrade(TCHAR *pBuf)
{
	if(m_dwDN < 10000000) 
	{
		SendSystemMsg( "Éý¼¶³¬¼¶»ú¼×ÐèÒª1000Íò!", SYSTEM_ERROR, TO_ME);
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}
	if(m_UserItem[39].sSid != 1184) return;
	int Success = 0;
	int index=0;
	short Slot = GetShort(pBuf, index);//Éè¼ÆÍ¼
	if(Slot < 10 || Slot > 33) return;
	short sSourceSid = m_UserItem[Slot].sSid;//µÃµ½ÎïÆ·ID
	//if(sSourceSid != 1160) return;
	BYTE tCount = m_UserItem[Slot].tMagic[5];
	if(tCount >= 2) return;

	int iRandom = myrand(1, 10000);						// »ú¼×Éý¼¶³É¹¦ÂÊ
	//iRandom = UpgradeSucc(iRandom);
	//if(iRandom <= g_SuitUpgrade[tCount]) 
	{
		Success = 1;
		//SendSystemMsg( "Ì«ÑôÂ¯Éý¼¶³É¹¦", SYSTEM_ERROR, TO_ME);
	}
	//else
	//{
	//	Success = 0;
	//	//SendSystemMsg( "Ì«ÑôÂ¯Éý¼¶Ê§°Ü", SYSTEM_ERROR, TO_ME);
	//}
	if(Success == 1){
		m_UserItem[39].tMagic[5] += 1;
		if(m_UserItem[39].tMagic[5] == 1){
			m_UserItem[39].tMagic[0] = 8;
			m_UserItem[39].tMagic[1] = 9;
			m_UserItem[39].tMagic[2] = 10;
			m_UserItem[39].tMagic[3] = 11;
			m_UserItem[39].tMagic[4] = 12;
		}else if(m_UserItem[39].tMagic[5] == 2){
			m_UserItem[39].tMagic[0] = 14;
			m_UserItem[39].tMagic[1] = 15;
			m_UserItem[39].tMagic[2] = 16;
			m_UserItem[39].tMagic[3] = 17;
			m_UserItem[39].tMagic[4] = 18;
		}
		// 2 3 4 5 6
		//8 9 10 11 12
		// 14 15 16 17 18
	}else{
	   if(m_UserItem[39].tMagic[5] > 0)	m_UserItem[39].tMagic[5] -= 1;		
	   if(m_UserItem[39].tMagic[5] == 255) m_UserItem[39].tMagic[5] = 0;
	   if(m_UserItem[39].tMagic[5] == 0){
			m_UserItem[39].tMagic[0] = 2;
			m_UserItem[39].tMagic[1] = 3;
			m_UserItem[39].tMagic[2] = 4;
			m_UserItem[39].tMagic[3] = 5;
			m_UserItem[39].tMagic[4] = 6;
		}else if(m_UserItem[39].tMagic[5] == 1){
			m_UserItem[39].tMagic[0] = 8;
			m_UserItem[39].tMagic[1] = 9;
			m_UserItem[39].tMagic[2] = 10;
			m_UserItem[39].tMagic[3] = 11;
			m_UserItem[39].tMagic[4] = 12;
		}
	}	
	if(m_UserItem[39].tMagic[5] > 2) m_UserItem[39].tMagic[5] = 2;

	CUIntArray arMaterial;
	arMaterial.Add(Slot);
	ReSetItemSlot(&m_UserItem[Slot]);
	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	if(Success) TempBuf.Add((BYTE)1);
	else  TempBuf.Add((BYTE)0);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());

	RobItem(1304,1);	
	SendCharData();
	if( m_dwDN <= 10000000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 10000000;
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();
}
void USER::ChengXuKa(TCHAR *pBuf)
{
	//³ÌÐò¿¨
	int index=0;
	short Slot = GetShort(pBuf, index);//Éè¼ÆÍ¼
	int TarSlot = -1;
	int sh = m_UserItem[Slot].tMagic[0];
	if(sh <= 0 || sh > 44) return;
    // 1-6
	// 7-12
	// 13-16
	// 17-20	
	if(sh <= 12) TarSlot = 8;
	if(sh >= 13 && sh <= 20) TarSlot = 9;
	if(sh >= 21 && sh <= 44) TarSlot = 10;
	
	m_UserItem[39].tMagic[TarSlot] = (BYTE)m_UserItem[Slot].tMagic[0];
	
	CUIntArray arMaterial;
	arMaterial.Add(Slot);
	ReSetItemSlot(&m_UserItem[Slot]);
	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	SendCharData();
}
void USER::JjPeiJian(TCHAR *pBuf)
{
	if(m_dwDN < 10000000) 
	{
		SendSystemMsg( "Ç®²»×ã!×°ÖÃÅä¼þÐè1000Íò!", SYSTEM_ERROR, TO_ME);
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}
	
	//Åä¼þ
	int index=0;
	short Slot = GetShort(pBuf, index);
	//µ¼µ¯ 5 ¼¤¹â
	if(m_UserItem[Slot].tMagic[0] == 4 || m_UserItem[Slot].tMagic[0] == 5)	m_UserItem[39].tMagic[6] = m_UserItem[Slot].tMagic[0];
	else m_UserItem[39].tMagic[7] = m_UserItem[Slot].tMagic[0];
	//Õ½Éñ×ËÌ¬
    if(m_UserItem[Slot].tMagic[0] == 7)	m_UserItem[39].tMagic[7] = m_UserItem[Slot].tMagic[0];
	
	CUIntArray arMaterial;
	arMaterial.Add(Slot);
	ReSetItemSlot(&m_UserItem[Slot]);
	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	SendCharData();
	if( m_dwDN <= 10000000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 10000000;
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

}
void USER::HeChengJJ(TCHAR *pBuf)
{
	int sSid= -1;
	int iWeight=0;
	int index=0;

	short Slot = GetShort(pBuf, index);//Éè¼ÆÍ¼
	short Slot1 = GetShort(pBuf, index);//Áã¼þ1
	short Slot2 = GetShort(pBuf, index);//Áã¼þ2
	short Slot3 = GetShort(pBuf, index);//Áã¼þ3
	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;
	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;
	if(Slot2 < EQUIP_ITEM_NUM || Slot2 >= TOTAL_INVEN_MAX) return;
	if(Slot3 < EQUIP_ITEM_NUM || Slot3 >= TOTAL_INVEN_MAX) return;
	int sl = m_UserItem[Slot].sSid;
	int sl1 = m_UserItem[Slot1].sSid;
	int sl2 = m_UserItem[Slot2].sSid;
	int sl3 = m_UserItem[Slot3].sSid;

	int sx1 = m_UserItem[Slot1].tMagic[0];
	int sx2 = m_UserItem[Slot2].tMagic[0];
	int sx3 = m_UserItem[Slot3].tMagic[0];
	if(sl !=1161)		return;
	if(sl == 1161) //v0
	{
		if(sl1 == 1157 && sl2 == 1158 && sl3 == 1159)	sSid = 1184;		
	}

	//if(sSid == -1) return;
	if( sSid < 0 || sSid >= g_arItemTable.GetSize() ) return;


	CUIntArray arMaterial;
	arMaterial.Add(Slot);	
	arMaterial.Add(Slot1);	
	arMaterial.Add(Slot2);	
	arMaterial.Add(Slot3);
	ReSetItemSlot(&m_UserItem[Slot]);
	ReSetItemSlot(&m_UserItem[Slot1]);
	ReSetItemSlot(&m_UserItem[Slot2]);
	ReSetItemSlot(&m_UserItem[Slot3]);	

	m_UserItem[Slot].sSid = sSid;
	m_UserItem[Slot].sLevel = g_arItemTable[sSid]->m_byRLevel;	
	m_UserItem[Slot].sCount = 1;
	m_UserItem[Slot].sDuration = g_arItemTable[sSid]->m_sDuration;
	m_UserItem[Slot].sBullNum = g_arItemTable[sSid]->m_sBullNum;	
	m_UserItem[Slot].tMagic[0] = sx1;
	m_UserItem[Slot].tMagic[1] = sx2;
	m_UserItem[Slot].tMagic[2] = sx3;
	m_UserItem[Slot].tMagic[3] = 5;	
	m_UserItem[Slot].tMagic[4] = 6;	
	m_UserItem[Slot].tMagic[5] = 0;
	m_UserItem[Slot].tIQ = 13;
	m_UserItem[Slot].iItemSerial = 0;
	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)14);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	FlushItemLog( TRUE );
}
void USER::EbodyFj39(int num)
{
    if(m_dwDN < 500000) 
	{
	//	SendSystemMsg( "Ç®²»×ã!½â³ýÅä¼þÐè50Íò!", SYSTEM_ERROR, TO_ME);
		SendEventMsg("Ç®²»×ã!½â³ýÅä¼þÐè50Íò!");
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}

	bool isNullSlot = false;
	int sloot = 0;
	for(int isl = 10; isl < 34;isl++)
	{
		if(m_UserItem[isl].sSid == -1)	
		{
			sloot++;
			if(sloot > 1)
			{
				isNullSlot = true;
				break;
			}
		}
	} 
	if(!isNullSlot) 
	{
	//	SendSystemMsg("ÇåÀí×°±¸À¸Áô³ö¿Õ¼ä",SYSTEM_ERROR,TO_ME);	
		SendEventMsg("ÇåÀí×°±¸À¸Áô³ö¿Õ¼ä");
		return;
	}
	int fjslot = -1;
	int itemid = -1;
	BYTE jjsx = -1;
	switch(num)
	{
	case 1:
		fjslot = 6;
		break;
	case 2:
		fjslot = 7;
		break;
	default:
		break;
	}
	if(fjslot == -1) return;
	if(m_UserItem[39].sSid != 0 && m_UserItem[39].tMagic[fjslot] != 0) jjsx = m_UserItem[39].tMagic[fjslot];
	if(jjsx == -1) return;
	switch(jjsx)
	{
		case 1:
			itemid = 1174;
			break;
		case 2:
			itemid = 1175;			
			break;
		case 3:
			itemid = 1176;			
			break;
		case 4:
			itemid = 1177;			
			break;
		case 5:
			itemid = 1178;			
			break;
		case 6:	
			itemid = 1179;
			break;
	}
	if(itemid == -1) return;
	m_UserItem[39].tMagic[fjslot] = 0;
	GiveAllItem(itemid,1,0,2,jjsx,0,0,0,0);
	SendCharData();
	CheckMagicItemMove();
	if( m_dwDN <= 500000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 500000;
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();
}
//É¾³ýcxk 1 2 3
void USER::EbodyFjCXcard(int num)
{
	if(m_dwDN < 600000) 
	{
		//SendSystemMsg( "Ç®²»×ã!½â³ý³ÌÐò¿¨Ðè60Íò!", SYSTEM_ERROR, TO_ME);
        SendEventMsg("Ç®²»×ã!½â³ý³ÌÐò¿¨Ðè60Íò!");
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}

    bool isNullSlot = false;
	int sloot = 0;
	for(int isl = 10; isl < 34;isl++)
	{
		if(m_UserItem[isl].sSid == -1)	
		{
			sloot++;
			if(sloot > 1)
			{
				isNullSlot = true;
				break;
			}
		}
	} 
	if(!isNullSlot) 
	{
	//	SendSystemMsg("ÇåÀí×°±¸À¸Áô³ö¿Õ¼ä",SYSTEM_ERROR,TO_ME);	
		SendEventMsg("ÇåÀí×°±¸À¸Áô³ö¿Õ¼ä");
		return;
	}

	int cardslot = -1;
	BYTE jjsx = -1;
	switch(num)
	{
	case 1:
		cardslot = 8;
		break;
	case 2:
		cardslot = 9;
		break;
	case 3:
		cardslot= 10;
		break;
	default:
		break;
	}	
	if(cardslot == -1) return;
	if(m_UserItem[39].sSid != 0 && m_UserItem[39].tMagic[cardslot] != 0) jjsx = m_UserItem[39].tMagic[cardslot];
	if(jjsx == -1) return;
	m_UserItem[39].tMagic[cardslot] = 0;			
	GiveAllItem(1180,1,0,2,jjsx,0,0,0,0);
	SendCharData();
	CheckMagicItemMove();
	if( m_dwDN <= 600000 ) m_dwDN = 0;
	else m_dwDN = m_dwDN - 600000;
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();
}
void USER::Ebody39(int solt)
{

	int j = 0;
	ItemList	TempItem;
	m_UserItem[solt].sCount = 1;
	TempItem = m_UserItem[solt];	
	m_UserItem[solt] = m_UserItem[solt];
	m_UserItem[39] = TempItem;	
	
	CBufferEx TempBuf;
	TempBuf.Add(ITEM_MOVE_RESULT);
	TempBuf.Add(SUCCESS);
	TempBuf.Add(0);
	TempBuf.Add(2);	
	TempBuf.Add(solt);
	TempBuf.Add(m_UserItem[solt].sLevel);
	TempBuf.Add(m_UserItem[solt].sSid);
	TempBuf.Add(m_UserItem[solt].sDuration);
	TempBuf.Add(m_UserItem[solt].sBullNum);
	TempBuf.Add(m_UserItem[solt].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[solt].tMagic[j]);
	TempBuf.Add(m_UserItem[solt].tIQ); 

	TempBuf.Add(39);
	TempBuf.Add(m_UserItem[39].sLevel);
	TempBuf.Add(m_UserItem[39].sSid);
	TempBuf.Add(m_UserItem[39].sDuration);
	TempBuf.Add(m_UserItem[39].sBullNum);
	TempBuf.Add(m_UserItem[39].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[39].tMagic[j]);
	TempBuf.Add(m_UserItem[39].tIQ); 

	Send(TempBuf, TempBuf.GetLength());
	//HuanYuanBianShen();
	if(m_UserItem[39].sSid == -1 && m_iSkin != 0)
	{
		m_iSkin=0 , m_iHair=0;
		SendMyInfo( TO_INSIGHT, INFO_MODIFY );
	}
	SendCharData();

}
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	ÇØ´ç ¾ÆÀÌÅÛÀ» °¹¼ö¸¸Å­ ÁØ´Ù.
//
BOOL USER::GiveItem(int sid, int iCount) //¸ø¶«Î÷°É
{
	if( sid < 0 || sid >= g_arItemTable.GetSize() ) return FALSE;
	if( iCount <= 0) return FALSE;

	if (iCount >32767 ) iCount = 0;

	if (sid == 724)
	{
		if( FindItem(724) + iCount > 32000)
		{
			SendEventMsg("³¬¹ý×î´óÐ¯´øÁ¿");
			return FALSE;
		}
	}
	
	int iWeight = 0;
	ItemList GiveItem;
	ReSetItemSlot( &GiveItem );

	GiveItem.sLevel			= g_arItemTable[sid]->m_byRLevel;
	GiveItem.sSid			= sid;
	GiveItem.sCount			= iCount;
	GiveItem.sDuration		= g_arItemTable[sid]->m_sDuration;
	GiveItem.sBullNum		= g_arItemTable[sid]->m_sBullNum;
	GiveItem.tIQ			= NORMAL_ITEM;
	

	iWeight = g_arItemTable[sid]->m_byWeight * iCount;

	CWordArray		arEmptySlot, arSameSlot;

	int iSlot = GetSameItem( GiveItem, INVENTORY_SLOT);

	if(iSlot != -1)	
	{ 
		if(iCount != 0)
		{
			CheckMaxValue((short &)m_UserItem[iSlot].sCount, (short)iCount); 
			arSameSlot.Add(iSlot); 
		}
	}
	else			
	{
		iSlot = GetEmptySlot( INVENTORY_SLOT );

		if( iSlot < 0 ) return FALSE;

		ReSetItemSlot( &m_UserItem[iSlot] );

		m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
		m_UserItem[iSlot].sSid = sid;
		m_UserItem[iSlot].sCount = iCount;
		m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
		m_UserItem[iSlot].sBullNum = g_arItemTable[sid]->m_sBullNum;
		m_UserItem[iSlot].tIQ = NORMAL_ITEM;

		arEmptySlot.Add(iSlot); 
	}			

	m_iCurWeight += iWeight;
	GetRecoverySpeed();					// ¾ÆÀÌÅÛ ¹«°Ô¿¡ º¯µ¿ÀÌ »ý±â¸é È¸º¹¼Óµµ º¯È¯

	UpdateInvenSlot(&arEmptySlot, &arSameSlot);
/*
	int iSlot = GetEmptySlot(INVENTORY_SLOT);

	if(iSlot < 0) return FALSE;

	ReSetItemSlot(&m_UserItem[iSlot]);

	m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
	m_UserItem[iSlot].sSid = sid;
	m_UserItem[iSlot].sCount = iCount;
	m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
	m_UserItem[iSlot].sBullNum = g_arItemTable[sid]->m_sBullNum;
	m_UserItem[iSlot].tIQ = NORMAL_ITEM;
*/
	return TRUE;
}
BOOL USER::GiveItemAll(int sid, int iCount,int upg,
					   int x1,int x2,int x3,int x4,int x5,
					   int x6,int x7,int x8,int x9,int x10)//107ÈÎÎñ
{
	/*if( sid < 0 || sid >= g_arItemTable.GetSize() ) return FALSE;
	if( iCount <= 0 ) return FALSE;
	
	int shuxingcount = 0;
	if(x1 != 0) shuxingcount += 1;
	if(x2 != 0) shuxingcount += 1;
	if(x3 != 0) shuxingcount += 1;
	if(x4 != 0) shuxingcount += 1;
	if(x5 != 0) shuxingcount += 1;	
	if(x6 != 0) shuxingcount += 1;
	if(x7 != 0) shuxingcount += 1;
	if(x8 != 0) shuxingcount += 1;
	if(x9 != 0) shuxingcount += 1;
	if(x10 != 0) shuxingcount += 1;

	if(upg < 0 || upg > MAX_ITEM_UPGRADE_COUNT)	upg = 0;
	int max_sx = 190;
	if(x1 < 0 || x1 > max_sx)	x1 = 0;
	if(x2 < 0 || x2 > max_sx)	x2 = 0;
	if(x3 < 0 || x3 > max_sx)	x3 = 0;
	if(x4 < 0 || x4 > max_sx)	x4 = 0;
	if(x5 < 0 || x5 > max_sx)	x5 = 0;	
	if(x6 < 0 || x6 > max_sx)	x6 = 0;
	if(x7 < 0 || x7 > max_sx)	x7 = 0;
	if(x8 < 0 || x8 > max_sx)	x8 = 0;
	if(x9 < 0 || x9 > max_sx)	x9 = 0;
	if(x10 < 0 || x10 > max_sx)	x10 = 0;

	int iWeight = 0;
	ItemList GiveItemAll;
	ReSetItemSlot( &GiveItemAll );	

	GiveItemAll.sLevel			= g_arItemTable[sid]->m_byRLevel;
	GiveItemAll.sSid			= sid;
	GiveItemAll.sCount			= iCount;
	GiveItemAll.sDuration		= g_arItemTable[sid]->m_sDuration;
	GiveItemAll.sBullNum		= g_arItemTable[sid]->m_sBullNum;
	GiveItemAll.tMagic[0]		= (BYTE)x1;
	GiveItemAll.tMagic[1]		= (BYTE)x2;
	GiveItemAll.tMagic[2]		= (BYTE)x3;
	GiveItemAll.tMagic[3]		= (BYTE)x4;
	GiveItemAll.tMagic[4]		= (BYTE)x5;
	GiveItemAll.tMagic[5]		= (BYTE)upg;
	GiveItemAll.tMagic[6]		= (BYTE)x6;
	GiveItemAll.tMagic[7]		= (BYTE)x7;
	GiveItemAll.tMagic[8]		= (BYTE)x8;
	GiveItemAll.tMagic[9]		= (BYTE)x9;
	GiveItemAll.tMagic[10]		= (BYTE)x10;

	if(sid >= 726 && sid <= 754)		GiveItemAll.tIQ	= SET_ITEM;
	else if( g_arItemTable[sid]->m_byWear == 130 )	GiveItemAll.tIQ	= GUARDIAN_ITEM;		
	else if((shuxingcount >= 1 && shuxingcount <= 2)
		|| (g_arItemTable[sid]->m_byWear >= 122 && g_arItemTable[sid]->m_byWear <= 126)) GiveItemAll.tIQ = MAGIC_ITEM;
	else if(shuxingcount >= 3 && shuxingcount <= 4)	GiveItemAll.tIQ	= RARE_ITEM;	
	else if((shuxingcount >= 5 && shuxingcount <= 10) || g_arItemTable[sid]->m_byWear == 152) GiveItemAll.tIQ	= RARE2_ITEM;

	iWeight = g_arItemTable[sid]->m_byWeight * iCount;
	CWordArray		arEmptySlot, arSameSlot;
/////////////////µ÷ÕûÎÞÄÍ¾ÃÎïÆ·µþ¼Ó·À¸´ÖÆÎÊÌâ¿ªÊ¼/////////////////
//	 int iSlot = -1;
     int iSlot;
	    if(g_arItemTable[sid]->m_sDuration > 0)
	    {
		    ItemList tmpItem;
			int j; 
            for(j = 0; j < iCount; j++)
			{
			    iSlot = GetEmptySlot( INVENTORY_SLOT );
				if(iSlot == 0) return FALSE;
				
                if( iSlot < 0 ) 
				{
					SendSystemMsg( IDS_USER_FULL_INVEN, SYSTEM_ERROR, TO_ME);
					return FALSE;
			
				}

				ReSetItemSlot(&tmpItem);

				m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
				m_UserItem[iSlot].sSid = sid;
				m_UserItem[iSlot].sCount = 1;
				m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
				m_UserItem[iSlot].sBullNum = g_arItemTable[sid]->m_sBullNum;
				m_UserItem[iSlot].tMagic[0]		= x1;
		        m_UserItem[iSlot].tMagic[1]		= x2;
		        m_UserItem[iSlot].tMagic[2]		= x3;
		        m_UserItem[iSlot].tMagic[3]		= x4;
		        m_UserItem[iSlot].tMagic[4]		= x5;
		        m_UserItem[iSlot].tMagic[5]		= upg;
		        m_UserItem[iSlot].tMagic[6]		= x6;
		        m_UserItem[iSlot].tMagic[7]		= x7;
		        m_UserItem[iSlot].tMagic[8]		= x8;
		        m_UserItem[iSlot].tMagic[9]		= x9;
		        m_UserItem[iSlot].tMagic[10]	= x10;	

				if(sid >= 726 && sid <= 754)			m_UserItem[iSlot].tIQ = SET_ITEM;
		        else if( g_arItemTable[sid]->m_byWear == 130 )	m_UserItem[iSlot].tIQ = GUARDIAN_ITEM;
			    else if((shuxingcount >= 1 && shuxingcount <= 2)
		        || g_arItemTable[sid]->m_byWear >= 122 && g_arItemTable[sid]->m_byWear <= 126) m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		        else if(shuxingcount >= 3 && shuxingcount <= 4)	m_UserItem[iSlot].tIQ = RARE_ITEM;
		        else if(shuxingcount >= 5 && shuxingcount <= 10) m_UserItem[iSlot].tIQ	= RARE2_ITEM;
			
                arEmptySlot.Add(iSlot);
				UpdateInvenSlot(&arEmptySlot, &arSameSlot);
		 }
            
        }else
	    {
		    ItemList tmpItem;
		    ReSetItemSlot(&tmpItem);
		    tmpItem.sSid = sid;
		    iSlot = GetSameItem(tmpItem, INVENTORY_SLOT);
		if(iSlot < 0)
		{
			iSlot = GetEmptySlot( INVENTORY_SLOT );
		}
		if( iSlot < 0 ) 
				return FALSE;
		m_UserItem[iSlot].sCount += iCount;
		m_UserItem[iSlot].sSid = sid;
	    arEmptySlot.Add(iSlot); 

		m_iCurWeight += iWeight;
	    GetRecoverySpeed();	

		UpdateInvenSlot(&arEmptySlot, &arSameSlot);
		return FALSE;
	    }
/////////////////µ÷ÕûÎÞÄÍ¾ÃÎïÆ·µþ¼Ó·À¸´ÖÆÎÊÌâ½áÊø/////////////////

	return TRUE;*/
  if( sid < 0 || sid >= g_arItemTable.GetSize() ) return FALSE;
  if( iCount <= 0 ) return FALSE;
  if (iCount >32767 ) iCount = 0;

	if (sid == 724)
	{
		if( FindItem(724) + iCount > 32000)
		{
			SendEventMsg("³¬¹ý×î´óÐ¯´øÁ¿");
			return FALSE;
		}
	}

	int shuxingcount = 0;
	if(x1 != 0) shuxingcount += 1;
	if(x2 != 0) shuxingcount += 1;
	if(x3 != 0) shuxingcount += 1;
	if(x4 != 0) shuxingcount += 1;
	if(x5 != 0) shuxingcount += 1;	
	if(x6 != 0) shuxingcount += 1;
	if(x7 != 0) shuxingcount += 1;
	if(x8 != 0) shuxingcount += 1;
	if(x9 != 0) shuxingcount += 1;
	if(x10 != 0) shuxingcount += 1;

	if(upg < 0 || upg > MAX_ITEM_UPGRADE_COUNT)	upg = 0;
	int max_sx = 205;
	if(x1 < 0 || x1 > max_sx)	x1 = 0;
	if(x2 < 0 || x2 > max_sx)	x2 = 0;
	if(x3 < 0 || x3 > max_sx)	x3 = 0;
	if(x4 < 0 || x4 > max_sx)	x4 = 0;
	if(x5 < 0 || x5 > max_sx)	x5 = 0;	
	if(x6 < 0 || x6 > max_sx)	x6 = 0;
	if(x7 < 0 || x7 > max_sx)	x7 = 0;
	if(x8 < 0 || x8 > max_sx)	x8 = 0;
	if(x9 < 0 || x9 > max_sx)	x9 = 0;
	if(x10 < 0 || x10 > max_sx)	x10 = 0;

	int iWeight = 0;
	ItemList GiveItemAll;
	ReSetItemSlot( &GiveItemAll );	

	GiveItemAll.sLevel			= g_arItemTable[sid]->m_byRLevel;
	GiveItemAll.sSid			= sid;
	GiveItemAll.sCount			= iCount;
	GiveItemAll.sDuration		= g_arItemTable[sid]->m_sDuration;
	GiveItemAll.sBullNum		= g_arItemTable[sid]->m_sBullNum;
	GiveItemAll.tMagic[0]		= (BYTE)x1;
	GiveItemAll.tMagic[1]		= (BYTE)x2;
	GiveItemAll.tMagic[2]		= (BYTE)x3;
	GiveItemAll.tMagic[3]		= (BYTE)x4;
	GiveItemAll.tMagic[4]		= (BYTE)x5;
	GiveItemAll.tMagic[5]		= (BYTE)upg;
	GiveItemAll.tMagic[6]		= (BYTE)x6;
	GiveItemAll.tMagic[7]		= (BYTE)x7;
	GiveItemAll.tMagic[8]		= (BYTE)x8;
	GiveItemAll.tMagic[9]		= (BYTE)x9;
	GiveItemAll.tMagic[10]		= (BYTE)x10;
     
	
	if(sid >= 726 && sid <= 754)		GiveItemAll.tIQ	= SET_ITEM;
	else if( g_arItemTable[sid]->m_byWear == 130 )	GiveItemAll.tIQ	= GUARDIAN_ITEM;		
	else if((shuxingcount >= 1 && shuxingcount <= 2)
		|| (g_arItemTable[sid]->m_byWear >= 122 && g_arItemTable[sid]->m_byWear <= 126)) GiveItemAll.tIQ = MAGIC_ITEM;
	else if(shuxingcount >= 3 && shuxingcount <= 4)	GiveItemAll.tIQ	= RARE_ITEM;	
	else if((shuxingcount >= 5 && shuxingcount <= 10) || g_arItemTable[sid]->m_byWear == 152) GiveItemAll.tIQ	= RARE2_ITEM;

	iWeight = g_arItemTable[sid]->m_byWeight * iCount;
	CWordArray		arEmptySlot, arSameSlot;

	int iSlot = GetSameItem( GiveItemAll, INVENTORY_SLOT);

	if(iSlot != -1)	
	{ 
		if(iCount != 0)
		{
			CheckMaxValue((short &)m_UserItem[iSlot].sCount, (short)iCount); 
			arSameSlot.Add(iSlot); 
		}
	}
	else			
	{
		iSlot = GetEmptySlot( INVENTORY_SLOT );

		if( iSlot < 0 ) return FALSE;

		ReSetItemSlot( &m_UserItem[iSlot] );

		m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
		m_UserItem[iSlot].sSid = sid;
		m_UserItem[iSlot].sCount = iCount;
		m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
		m_UserItem[iSlot].sBullNum = g_arItemTable[sid]->m_sBullNum;
		m_UserItem[iSlot].tMagic[0]		= x1;
		m_UserItem[iSlot].tMagic[1]		= x2;
		m_UserItem[iSlot].tMagic[2]		= x3;
		m_UserItem[iSlot].tMagic[3]		= x4;
		m_UserItem[iSlot].tMagic[4]		= x5;
		m_UserItem[iSlot].tMagic[5]		= upg;
		m_UserItem[iSlot].tMagic[6]		= x6;
		m_UserItem[iSlot].tMagic[7]		= x7;
		m_UserItem[iSlot].tMagic[8]		= x8;
		m_UserItem[iSlot].tMagic[9]		= x9;
		m_UserItem[iSlot].tMagic[10]	= x10;		

		if(sid >= 726 && sid <= 754)			m_UserItem[iSlot].tIQ = SET_ITEM;
		else if( g_arItemTable[sid]->m_byWear == 130 )	m_UserItem[iSlot].tIQ = GUARDIAN_ITEM;
		else if((shuxingcount >= 1 && shuxingcount <= 2)
			|| g_arItemTable[sid]->m_byWear >= 122 && g_arItemTable[sid]->m_byWear <= 126) m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		else if(shuxingcount >= 3 && shuxingcount <= 4)	m_UserItem[iSlot].tIQ = RARE_ITEM;
		else if(shuxingcount >= 5 && shuxingcount <= 10) m_UserItem[iSlot].tIQ	= RARE2_ITEM;

		arEmptySlot.Add(iSlot); 
	}			

	m_iCurWeight += iWeight;
	GetRecoverySpeed();					// ¾ÆÀÌÅÛ ¹«°Ô¿¡ º¯µ¿ÀÌ »ý±â¸é È¸º¹¼Óµµ º¯È¯

	UpdateInvenSlot(&arEmptySlot, &arSameSlot);
	return TRUE;
}
////////////////////////////////////////////////////////////////////////////////////////////////////
///²âÊÔË¢10ÊôÐÔ×°±¸ÃüÁî
BOOL USER::GiveItemAll10(int sid, int iCount,int upg,int sIQ,
					   int x1,int x2,int x3,int x4,int x5,
					   int x6,int x7,int x8,int x9,int x10)//107ÈÎÎñ
{
	if( sid < 0 || sid >= g_arItemTable.GetSize() ) return FALSE;
	if( iCount <= 0) return FALSE;

	if (iCount >32767 ) iCount = 0;

	if (sid == 724)
	{
		if( FindItem(724) + iCount > 32000)
		{
			SendEventMsg("³¬¹ý×î´óÐ¯´øÁ¿");
			return FALSE;
		}
	}
	
	int shuxingcount = 0;
	if(x1 != 0) shuxingcount += 1;
	if(x2 != 0) shuxingcount += 1;
	if(x3 != 0) shuxingcount += 1;
	if(x4 != 0) shuxingcount += 1;
	if(x5 != 0) shuxingcount += 1;	
	if(x6 != 0) shuxingcount += 1;
	if(x7 != 0) shuxingcount += 1;
	if(x8 != 0) shuxingcount += 1;
	if(x9 != 0) shuxingcount += 1;
	if(x10 != 0) shuxingcount += 1;

	if(upg < 0 || upg > MAX_ITEM_UPGRADE_COUNT)	upg = 0;
	int max_sx = 205;
	if(x1 < 0 || x1 > max_sx)	x1 = 0;
	if(x2 < 0 || x2 > max_sx)	x2 = 0;
	if(x3 < 0 || x3 > max_sx)	x3 = 0;
	if(x4 < 0 || x4 > max_sx)	x4 = 0;
	if(x5 < 0 || x5 > max_sx)	x5 = 0;	
	if(x6 < 0 || x6 > max_sx)	x6 = 0;
	if(x7 < 0 || x7 > max_sx)	x7 = 0;
	if(x8 < 0 || x8 > max_sx)	x8 = 0;
	if(x9 < 0 || x9 > max_sx)	x9 = 0;
	if(x10 < 0 || x10 > max_sx)	x10 = 0;

	int iWeight = 0;
	ItemList GiveItemAll10;
	ReSetItemSlot( &GiveItemAll10 );	

	GiveItemAll10.sLevel			= g_arItemTable[sid]->m_byRLevel;
	GiveItemAll10.sSid			= sid;
	GiveItemAll10.sCount			= iCount;
	GiveItemAll10.sDuration		= g_arItemTable[sid]->m_sDuration;
	GiveItemAll10.sBullNum		= g_arItemTable[sid]->m_sBullNum;
	GiveItemAll10.tMagic[0]		= x1;
	GiveItemAll10.tMagic[1]		= x2;
	GiveItemAll10.tMagic[2]		= x3;
	GiveItemAll10.tMagic[3]		= x4;
	GiveItemAll10.tMagic[4]		= x5;
	GiveItemAll10.tMagic[5]		= upg;
	GiveItemAll10.tMagic[6]		= x6;
	GiveItemAll10.tMagic[7]		= x7;
	GiveItemAll10.tMagic[8]		= x8;
	GiveItemAll10.tMagic[9]		= x9;
	GiveItemAll10.tMagic[10]		= x10;
	GiveItemAll10.tIQ = sIQ;

	if(sid >= 726 && sid <= 754)		GiveItemAll10.tIQ	= SET_ITEM;
	else if( g_arItemTable[sid]->m_byWear == 122 )       GiveItemAll10.tIQ	= MAGIC_ITEM;
	else if( g_arItemTable[sid]->m_byWear == 123 )       GiveItemAll10.tIQ	= MAGIC_ITEM;
	else if( g_arItemTable[sid]->m_byWear == 124 )       GiveItemAll10.tIQ	= MAGIC_ITEM;
	else if( g_arItemTable[sid]->m_byWear == 125 )       GiveItemAll10.tIQ	= MAGIC_ITEM;
	else if( g_arItemTable[sid]->m_byWear == 130 )	GiveItemAll10.tIQ	= GUARDIAN_ITEM;
	else if(shuxingcount >= 1 && shuxingcount <= 2)	GiveItemAll10.tIQ = MAGIC_ITEM;
	else if(shuxingcount >= 3 && shuxingcount <= 4)	GiveItemAll10.tIQ	= RARE_ITEM;	
	else if(shuxingcount >= 5 && shuxingcount <= 10) GiveItemAll10.tIQ	= RARE2_ITEM;
	
	
    iWeight = g_arItemTable[sid]->m_byWeight * iCount;
	CWordArray		arEmptySlot, arSameSlot;

	int iSlot = GetSameItem( GiveItemAll10, INVENTORY_SLOT);

	if(iSlot != -1)	
	{ 
		if(iCount != 0)
		{
			CheckMaxValue((short &)m_UserItem[iSlot].sCount, (short)iCount); 
			arSameSlot.Add(iSlot); 
		}
	}
	else			
	{
		iSlot = GetEmptySlot( INVENTORY_SLOT );

		if( iSlot < 0 ) return FALSE;

		ReSetItemSlot( &m_UserItem[iSlot] );

		m_UserItem[iSlot].sLevel = g_arItemTable[sid]->m_byRLevel;
		m_UserItem[iSlot].sSid = sid;
		m_UserItem[iSlot].sCount = iCount;
		m_UserItem[iSlot].sDuration = g_arItemTable[sid]->m_sDuration;
		m_UserItem[iSlot].sBullNum = g_arItemTable[sid]->m_sBullNum;
		m_UserItem[iSlot].tMagic[0]		= x1;
		m_UserItem[iSlot].tMagic[1]		= x2;
		m_UserItem[iSlot].tMagic[2]		= x3;
		m_UserItem[iSlot].tMagic[3]		= x4;
		m_UserItem[iSlot].tMagic[4]		= x5;
		m_UserItem[iSlot].tMagic[5]		= upg;
		m_UserItem[iSlot].tMagic[6]		= x6;
		m_UserItem[iSlot].tMagic[7]		= x7;
		m_UserItem[iSlot].tMagic[8]		= x8;
		m_UserItem[iSlot].tMagic[9]		= x9;
		m_UserItem[iSlot].tMagic[10]	= x10;	
		GiveItemAll10.tIQ = sIQ;

		if(sid >= 726 && sid <= 754)			m_UserItem[iSlot].tIQ = SET_ITEM;
		else if( g_arItemTable[sid]->m_byWear == 122 )       m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		else if( g_arItemTable[sid]->m_byWear == 123 )       m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		else if( g_arItemTable[sid]->m_byWear == 124 )       m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		else if( g_arItemTable[sid]->m_byWear == 125 )       m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		else if( g_arItemTable[sid]->m_byWear == 130 )	m_UserItem[iSlot].tIQ = GUARDIAN_ITEM;
		else if(shuxingcount >= 1 && shuxingcount <= 2)	m_UserItem[iSlot].tIQ = MAGIC_ITEM;
		else if(shuxingcount >= 3 && shuxingcount <= 4)	m_UserItem[iSlot].tIQ = RARE_ITEM;
		else if(shuxingcount >= 5 && shuxingcount <= 10) m_UserItem[iSlot].tIQ	= RARE2_ITEM;
		
	    arEmptySlot.Add(iSlot); 
	}			

	m_iCurWeight += iWeight;
	GetRecoverySpeed();					// ¾ÆÀÌÅÛ ¹«°Ô¿¡ º¯µ¿ÀÌ »ý±â¸é È¸º¹¼Óµµ º¯È¯

	UpdateInvenSlot(&arEmptySlot, &arSameSlot);
	return TRUE;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	Áß°£ °ø¼ºÀüÀÌ ³¡°ú µ¿½Ã¿¡ ½ÃÀÛÀ» ¼ÂÆÃÇÑ´Ù.
//  ÒªÈû½áÊø´¦Àí
void USER::StoppingTheFortressWar(CGuildFortress *pFort)
{	
	int i, type = 0;
	int nLen = 0;
	USER *pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildFortress *pBackFort = NULL;

	if(m_dwGuild <= 0) return;

	if(pFort == NULL) return;

	pBackFort = pFort;

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		return;
	}

	nLen = strlen(pGuild->m_strMasterName);
	::ZeroMemory(pFort->m_strMasterName, sizeof(pFort->m_strMasterName));
	strncpy(pFort->m_strMasterName, pGuild->m_strMasterName, nLen);

	ReleaseGuild();				// ÇØÁ¦...

	nLen = CHAR_NAME_LENGTH;

	for(i = 0; i < GUILDFORTRESS_ATTACK_MAX_NUM; i++)
	{
		if(pFort->m_arAttackGuild[i].lGuild == m_dwGuild)
		{
			pFort->m_arAttackGuild[i].lGuild = pFort->m_iGuildSid;
			::ZeroMemory(pFort->m_arAttackGuild[i].strGuildName, CHAR_NAME_LENGTH + 1);		// °ø°ÝÃøÀ¸·Î ¹Ù²Ù°í
			strncpy(pFort->m_arAttackGuild[i].strGuildName, pFort->m_strGuildName, nLen);

			pFort->m_iGuildSid = m_dwGuild;
			::ZeroMemory(pFort->m_strGuildName, CHAR_NAME_LENGTH + 1);						// ÁÖÀÎ ÀÌ¸§ ¹Ù²Ù°í
			strncpy(pFort->m_strGuildName, m_strGuildName, nLen);
			break;
		}
	}

	CString strMsg = _T(""); 
	strMsg.Format( IDS_USER_GET_FORTRESS_SUCCESS, m_strGuildName);//%s ¾üÍÅÁÙÊ±»ñµÃÒªÈû
//	SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_ANNOUNCE, TO_ALL);

	for(i = 0; i < MAX_USER; i++)
	{
		type = 0;
		pUser = m_pCom->GetUserUid(i);

		if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;		

		type = pUser->CheckInvalidMapType();
		if((type == 8 || type == 10 || type == 15 || type == 9 || type == 11 || type == 16 || type == 17|| type == 18) &&( m_tFortressWar == GUILD_WARRING || m_tGuildWar == GUILD_WARRING) ) //Õ½ÇøÄÚ»Ø³Ì
		{												//±æµåÀüÀÌ ÀÏ¾î³ª´Â »óÁ¡Áö¿ªÀÌ¸é
			if(pFort->m_iGuildSid != pUser->m_dwGuild)
			{
				pUser->TownPotal();				
				pUser->SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_ANNOUNCE, TO_ME);
				SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_ANNOUNCE, TO_ALL);
			}
		}
	}

	CBufferEx TempBuf;

	CNpc *pNpc = NULL;

	TempBuf.Add(GUILD_FORTRESS_NCIRCLE);
	TempBuf.Add((BYTE)0x01);
	TempBuf.Add((int)pFort->m_sFortressID);
    //»Ö¸´ÄÜÁ¿ÇòÎªÐÂµÄ
	for(i = 0; i < FORTRESS_TARGET_MAX_NUM; i++)		// N_Circle¸¦ ÃÊ±âÈ­ÇØ¼­ ´ÙÀ½À» ±â¾à...
	{
		pNpc = GetNpc(pFort->m_arFortressTarget[i].sTargertID);

		if(!pNpc) continue;

		pNpc->m_tNCircle = NPC_NCIRCLE_DEF_STATE;
		pNpc->m_byColor = 0;
		pNpc->m_sHP = pNpc->m_sMaxHP;
		pNpc->m_lFortressState = 0;

		TempBuf.Add((int)(pNpc->m_sNid + NPC_BAND));
		//		pNpc->SendFortressNCircleColor(m_pCom);				// Color°¡ ¿ø»ó º¹±ÍµÊÀ» ¾Ë¸°´Ù.
	}

	for(i = 0; i < pFort->m_arRepairNpcList.GetSize(); i++)
	{
		pNpc = GetNpc(pFort->m_arRepairNpcList[i]);

		if(!pNpc) continue;

		if(pNpc->m_tNpcType == NPCTYPE_GUILD_DOOR)
		{
			pNpc->m_sHP = pNpc->m_sMaxHP;
			pNpc->m_bFirstLive = TRUE;
			break;
		}
	}

	SendInsight(TempBuf, TempBuf.GetLength());
	// ³ªÁß¿¡ Agent¿¡ Æ÷Æ®¸®½º¸¦ ³ÖÀÚ!!!
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	DB¿¡ UPDATEÇÑ´Ù.(½ÅÃ»±æµå¸¸ ¿À·ÎÁö Å×ÀÌºí¿¡ Ãß°¡ÇÑ´Ù)
//
BOOL USER::UpdateFortress(CGuildFortress *pFort)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];	
	if(pFort == NULL) return FALSE;

	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_FORTRESS_WARLIST(%d,%d,\'%s\')}"), 
	pFort->m_sFortressID, m_dwGuild, m_strGuildName);

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild_Store Data Only!!\n");

		//g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DBNew[m_iModSid].ReleaseDB(db_index);
			return FALSE;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return FALSE;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return FALSE;

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////////////////////
//	DB¿¡ ÃÖ°í·¦ EVENT·Î µî·ÏÇÑ´Ù
//
void USER::UpdateHighEventLevelUser(short sLevel)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		

	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call ADD_EVENT_USER(\'%s\',%d)}"), m_strUserID, sLevel);

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild_Store Data Only!!\n");

		//g_DBNew[m_iModSid].ReleaseDB(db_index);
		return;
	}

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DBNew[m_iModSid].ReleaseDB(db_index);
			return;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return;
}

void USER::SetTempStoreDN(DWORD dwDN, int sid)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		

	::ZeroMemory(szSQL, sizeof(szSQL));

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call TEMP_MONEY(%d,%d)}"), sid, dwDN);

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild_Store Data Only!!\n");

		//g_DB[m_iModSid].ReleaseDB(db_index);
		return;
	}

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			BREAKPOINT();

			g_DB[m_iModSid].ReleaseDB(db_index);
			return;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DB[m_iModSid].ReleaseDB(db_index);
		return;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
	
	if( !bQuerySuccess ) return;
}

void USER::AddressWindowOpen(int sid, int quality)
{
	CBufferEx TempBuf;
	
	if( sid == NPC_EVENT_FLOWER )
	{
		TempBuf.Add(ADDRESS_WINDOW_OPEN_NEW);
	}
	else
	{
		TempBuf.Add(ADDRESS_WINDOW_OPEN);
	}
	TempBuf.Add( (short)sid );
	TempBuf.Add( (short)quality );

	Send(TempBuf, TempBuf.GetLength());
}

void USER::RecvAddress(TCHAR *pBuf)
{
	int index = 0;

	char strAddress[512];
	CString			str;
	SYSTEMTIME time;
	GetLocalTime(&time);

	memset( strAddress, NULL, 512 );

	int length = (int)GetByte( pBuf, index );

	if( length < 0 || length > 512 ) { SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME); return; }

	GetString( strAddress, pBuf, length, index );

	int sid = GetShort( pBuf, index );
	int quality = GetShort( pBuf, index );

	// ²É¹Ù±¸´Ï ÀÌº¥Æ® Ã·°¡
	if( sid != 634 && sid != 773 ) { SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME); return; }

	char strTitle[128];
	
	if( sid == 634 )
	{
		if( quality == 202 )
			sprintf( strTitle, _ID(IDS_USER_MUNHWA_PRESENT) );
		else if( quality == 201 )
			sprintf( strTitle, _ID(IDS_USER_DEPT_PRESENT) );
		else
		{
			SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME); return;
		}
	}
	else if( sid == 773 )
	{
		sprintf( strTitle, _ID(IDS_USER_FLOWER_PRESENT) );
	}
	else
	{
		SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME); return;
	}

	str.Format("(%04d-%02d-%02d %02d:%02d:%02d) %s - Flower change event applied\r\n",
		time.wYear, time.wMonth, time.wDay, time.wHour, time.wMinute, time.wSecond,	m_strUserID );

	EnterCriticalSection( &m_CS_EventItemLogFileWrite );
	g_fpEventItem.Write( str, str.GetLength() );
	LeaveCriticalSection( &m_CS_EventItemLogFileWrite );

//	if( !EventRobItem( sid, quality ) )
//	{
//		SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME); return;
//	}

	SDWORD sTitleLen	= _tcslen(strTitle);
	SDWORD sContentLen	= _tcslen(strAddress);
	SDWORD sIDLen		= _tcslen(m_strUserID);

	SQLHSTMT	hstmt = NULL;
	SQLRETURN	retcode;
	TCHAR		szSQL[8000];	::ZeroMemory(szSQL, sizeof(szSQL));

	int bbsnum = 2;		// ÀÌº¥Æ®¿ë °Ô½ÃÆÇ

	_sntprintf(szSQL, sizeof(szSQL), TEXT( "{call BBS_WRITE ( %d, ?, ?, ? )}" ), bbsnum );

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) { SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME); return; }

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
//		TRACE("Fail To Write BBS (BBS:%d,Writer:%s,Title:%d) !!\n", bbsnum, m_strUserID, strTitle);

//		g_DBNew[m_iModSid].ReleaseDB(db_index);

		SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME);
		return;
	}

	int i = 1;
	SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, 20,		0, (TCHAR*)m_strUserID,	0, &sIDLen );
	SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, 50,		0, (TCHAR*)strTitle,	0, &sTitleLen );
	SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, 5000,	0, (TCHAR*)strAddress,	0, &sContentLen );

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));
	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
	}
	else if (retcode == SQL_ERROR)
	{
		DisplayErrorMsg(hstmt);
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		BREAKPOINT();

		g_DBNew[m_iModSid].ReleaseDB(db_index);

		SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME);
		return;
	}
	
	SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);

	str.Format("(%04d-%02d-%02d %02d:%02d:%02d) %s - Flower change event logged to bbs\r\n",
		time.wYear, time.wMonth, time.wDay, time.wHour, time.wMinute, time.wSecond,	m_strUserID );

	EnterCriticalSection( &m_CS_EventItemLogFileWrite );
	g_fpEventItem.Write( str, str.GetLength() );
	LeaveCriticalSection( &m_CS_EventItemLogFileWrite );

	if( !EventRobItem( sid, quality ) )
	{
		SendSystemMsg( IDS_USER_REG_ADDR_FAIL, SYSTEM_NORMAL, TO_ME); return;
	}

	str.Format("(%04d-%02d-%02d %02d:%02d:%02d) %s - Flower change event completed\r\n",
		time.wYear, time.wMonth, time.wDay, time.wHour, time.wMinute, time.wSecond,	m_strUserID );

	EnterCriticalSection( &m_CS_EventItemLogFileWrite );
	g_fpEventItem.Write( str, str.GetLength() );
	LeaveCriticalSection( &m_CS_EventItemLogFileWrite );

	SendSystemMsg( IDS_USER_REG_ADDR, SYSTEM_NORMAL, TO_ME);

	return;
}

void USER::GetResource()
{
	if(m_tIsOP == 0) return;

	//
	int nResourceFreeCount = 0;
	int CurUserCount = 0;
	int acceptedCount = 0;
	int connectedCount = 0;
	int disconnectedCount = 0;
	int logoutCount = 0;
	
	for ( int i = 0; i < MAX_USER; i++ )
	{
		if ( g_pUQM->m_pResources->IsFree( i ) == true )
		{
			nResourceFreeCount++;
			continue;
		}

		USER *pUser = (USER*)g_pUQM->m_pResources->GetDataValue( i );
		if ( pUser )
		{
			if ( pUser && pUser->m_state == STATE_GAMESTARTED )
				CurUserCount++;						
			else if( pUser && pUser->m_state == STATE_ACCEPTED )
				acceptedCount++;
			else if( pUser && pUser->m_state == STATE_CONNECTED )
				connectedCount++;
			else if( pUser && pUser->m_state == STATE_DISCONNECTED )
				disconnectedCount++;
			else if( pUser && pUser->m_state == STATE_LOGOUT )
				logoutCount++;
		}
	};

	int nLeftResource = g_pUQM->FreeResourcesLeft();
	//
//	sprintf( msg, _ID(IDS_USER_SYSTEM_MSG03), CurUserCount, nLeftResource, nResourceFreeCount );

	TCHAR strTitle[256];
	::ZeroMemory(strTitle, sizeof(strTitle));
	wsprintf(strTitle, _ID(IDS_USER_SYSTEM_MSG04), CurUserCount, acceptedCount, connectedCount, disconnectedCount, logoutCount, nLeftResource, nResourceFreeCount);
	
	SendSystemMsg(strTitle, SYSTEM_NORMAL, TO_ME);
}



//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	±æÀüÀ» ½ÅÃ»ÇÑ ÀüÃ¼ ±æµå ¸ñ·ÏÀ» º¸¿©ÁØ´Ù.(°ø¼ºÀü¸¸)
//
void USER::SendFortressAttackGuildList(TCHAR *pBuf)
{
	int i, j;
	short nCount = 0;
	short sFortID = 0;

	BOOL bSuc = FALSE;

	CGuild *pGuild = NULL;
	CStore *pStore = NULL;
	CGuildFortress *pFort = NULL;
	CGuildFortress *pTempFort = NULL;

	int index = 0;
	sFortID = GetShort(pBuf, index);

	if(m_tIsOP != 1)
	{
		if(m_dwGuild <= 0) return;
		if(!m_bGuildMaster)
		{
			SendSystemMsg( IDS_USER_NOT_GUILD_MASTER, SYSTEM_ERROR, TO_ME);
			return;
		}
		if(sFortID != 1000 && sFortID != 1001 && sFortID != 1002)
		{
			SendSystemMsg( IDS_USER_UNCLEAR_FORTRESS, SYSTEM_ERROR, TO_ME);
			return;
		}

		for(i = 0; i < g_arGuildFortress.GetSize(); i++)
		{
			if(g_arGuildFortress[i] == NULL) continue;

			pTempFort = g_arGuildFortress[i];
			if(pTempFort->m_sFortressID != sFortID) continue;

			if(pTempFort->m_iGuildSid == m_dwGuild) 
			{
				bSuc = TRUE;
				break;
			}

			for(j = 0; j < GUILDFORTRESS_ATTACK_MAX_NUM; j++)
			{
				if(pTempFort->m_arAttackGuild[j].lGuild == m_dwGuild)
				{
					bSuc = TRUE;
					break;
				}
			}

			if(bSuc) break;
		}
	}
	else bSuc = TRUE;

	if(!bSuc) 
	{
		SendSystemMsg( IDS_USER_NOT_APPLY_GUILD, SYSTEM_ERROR, TO_ME);
		return;
	}

	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		pFort = g_arGuildFortress[i];
		if(!pFort) continue;

		nCount = 0;
		if(pFort->m_sFortressID == sFortID)
		{
			if(pFort->m_lUsed == 1)
			{
				SendSystemMsg( IDS_USER_CANT_USE_IN_DEFENCE, SYSTEM_ERROR, TO_ME);
				return;
			}

			CBufferEx TempBuf, AddData;

			TempBuf.Add(CHALLENGE_GUILD);			
			
			for(j =0; j < GUILDFORTRESS_ATTACK_MAX_NUM; j++)
			{
				if(pFort->m_arAttackGuild[j].lUsed == 1)
				{
					AddData.AddString(pFort->m_arAttackGuild[j].strGuildName);
					nCount++;
				}
			}

			TempBuf.Add(nCount);
			TempBuf.AddData(AddData, AddData.GetLength());

			Send(TempBuf, TempBuf.GetLength());
			return;
		}
	}

	if(m_tIsOP == 1) SendSystemMsg( IDS_USER_UNKNOWN_ERROR, SYSTEM_ERROR, TO_ME);
}

void USER::SendRepairItem(int sid)
{
	int i, j;
	CNpc *pNpc = NULL;
	CGuild *pGuild = NULL;
	CGuildFortress *pFort = NULL;

	if(!m_dwGuild) return;

	pFort = GetFortress(sid);

	if(!pFort) return;
	if(!pFort->m_bHaveGuild) return;
	if(pFort->m_iGuildSid != m_dwGuild) return;

	if(pFort->m_lUsed == 1)
	{
		SendSystemMsg( IDS_USER_CANT_USE_IN_DEFENCE, SYSTEM_ERROR, TO_ME);
		return;
	}

	if(pFort->m_dwRepairCost <= 0) 
	{
		SendSystemMsg( IDS_USER_NO_MORE_REPAIR, SYSTEM_ERROR, TO_ME);
		return;
	}

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild)
	{
		ReleaseGuild();
		return;
	}

	int nLen = strlen(m_strUserID);

	if( nLen <= 0 || nLen > CHAR_NAME_LENGTH ) 
	{
		ReleaseGuild();
		return;
	}

	if(strcmp(pGuild->m_strMasterName, m_strUserID) != 0)
	{
		ReleaseGuild();
		SendSystemMsg( IDS_USER_ONLY_GUILD_MASTER_USE, SYSTEM_ERROR, TO_ME);
		return;
	}

	ReleaseGuild();

/*	if(InterlockedCompareExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)1, (LONG)0) == 0)
	{
		m_dwGuildDN = 0;
		InitGuildItem();								// º¯¼ö¸¦ ±ú²ýÀÌ ¼¼Å¹ÇÑ´Ù.

		if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) 
		{ 
			InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0); 
			SendSystemMsg( IDS_USER_FAIL, SYSTEM_ERROR, TO_ME);
			return; 
		}

		if(!LoadGuildWarehouse())						
		{ 
			InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0); 
			SendSystemMsg( IDS_USER_FAIL, SYSTEM_ERROR, TO_ME);
			return; 
		}

		if(m_dwGuildDN < pFort->m_dwRepairCost)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_REPAIR_DINA, SYSTEM_ERROR, TO_ME);
			return;
		}

		m_dwGuildDN -= pFort->m_dwRepairCost;

		UpdateGuildWarehouse();
		InterlockedExchange(&g_arGuildData[m_dwGuild]->m_lUsed, (LONG)0); 
*/
		if(m_dwDN < pFort->m_dwRepairCost)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_REPAIR_HAVEDINA, SYSTEM_ERROR, TO_ME);
			return;
		}
		else m_dwDN -= pFort->m_dwRepairCost;
//		if(m_dwDN < 0) m_dwDN = 0;

		UpdateUserItemDN();
		SendMoneyChanged();

		pFort->m_dwRepairCost = 0;

		for(i = 0; i < pFort->m_arRepairNpcList.GetSize(); i++)
		{
			pNpc = GetNpc(pFort->m_arRepairNpcList[i]);

			if(!pNpc) continue;

			for(j = 0; j < GUILD_REPAIR_MAX_NUM; j++)
			{			
				if(pFort->m_arRepairDBList[j].sUid == pNpc->m_sEZone)
				{
					pNpc->m_sHP = pNpc->m_sMaxHP;
					pNpc->m_tRepairDamaged = NPC_NON_REPAIR_STATE;
					pFort->m_arRepairDBList[j].sHP = pNpc->m_sMaxHP;
					break;
				}
			}
		}

		SendSystemMsg( IDS_USER_REPAIR_COMPLETED, SYSTEM_NORMAL, TO_ME);
		UpdateMemRepairNpc(sid);

}

void USER::SendPeopleSay(int sid)
{
	int degree = 0, say = -1;
	CGuildFortress *pFort = NULL;

	if(!m_dwGuild) return;

	pFort = GetFortress(sid);

	if(!pFort) return;

	if(!pFort->m_bHaveGuild) return;
	if(pFort->m_iGuildSid != m_dwGuild) return;

//	degree = pFort->m_iCityDegree + pFort->m_tTaxRate;
	degree = pFort->GetTotalCityValue();
	
	if(degree <= 20)
	{
		if(sid == 1000) say = 135;
		else if(sid == 1001) say = 155;
		else if(sid == 1002) say = 308;
	}
	else if(degree <= 40)
	{
		if(sid == 1000) say = 136;
		else if(sid == 1001) say = 156;
		else if(sid == 1002) say = 309;
	}
	else if(degree <= 60)
	{
		if(sid == 1000) say = 137;
		else if(sid == 1001) say = 157;
		else if(sid == 1002) say = 310;
	}
	else
	{
		if(sid == 1000) say = 138;
		else if(sid == 1001) say = 158;
		else if(sid == 1002) say = 311;
	}

	if(say >= 0) SendNpcSay(NULL, say);
}

void USER::UpdateMemRepairNpc(int iSid)
{
	int nSize, i;
	CGuildFortress *pFort = NULL;

	if(iSid >= FORTRESS_BAND)
	{
		nSize = g_arFortressSharedMemory.GetSize();
		CSharedMemory* pShared = NULL;
		CMemFortress* pData = NULL;

		pFort = GetFortress(iSid);
		if(!pFort) return;

		if(!pFort->m_bHaveGuild || pFort->m_iGuildSid != m_dwGuild) return;

		for(i = 0; i < nSize; i++)
		{
			pShared = g_arFortressSharedMemory[i];
			
			if(pShared == NULL) return;
			if(pShared->m_hMapping == NULL) return;
			
			pData = (CMemFortress*) pShared->m_lpData;
			
			if(pData == NULL) return;
			if(pData->m_sFortressID <= 0) return;
			if(pData->m_iGuildSid != m_dwGuild) return;
			
			pFort->FortressRepairListToStr(pData->m_RepairList);
			break;
		}
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	±æÀüÀ» ½ÅÃ»ÇÑ .(°ø¼ºÀü¸¸)
//
void USER::UpdateMemAttackListNpc(int iSid)
{
/*	int nSize, i;
	CGuildFortress *pFort = NULL;

	if(iSid >= FORTRESS_BAND)
	{
		nSize = g_arFortressSharedMemory.GetSize();
		CSharedMemory* pShared = NULL;
		CMemFortress* pData = NULL;

		pFort = GetFortress(iSid);
		if(!pFort) return;

		for(i = 0; i < nSize; i++)
		{
			pShared = g_arFortressSharedMemory[i];
			
			if(pShared == NULL) continue;
			if(pShared->m_hMapping == NULL) continue;
			
			pData = (CMemFortress*) pShared->m_lpData;
			
			if(pData == NULL) continue;
			if(pData->m_sFortressID <= 0) continue;
			if(pData->m_sFortressID != pFort->m_sFortressID) continue;
			
			pFort->GuildAttListToStr(pData->m_AttackList);
			break;
		}
	}
*/
}

BOOL USER::CheckInGuildWarring()
{
	int i, j;

	CStore *pStore = NULL;
	CGuildFortress *pFort = NULL;

	// °ø¼ºÀüÀÏ¶§...
	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		pFort = g_arGuildFortress[i];
		if(!pFort) continue;

		if(g_arGuildFortress[i]->m_lUsed == 1)
		{
			if(pFort->m_iGuildSid == m_dwGuild)	// ¹æ¾îÃøÀÎÁö
			{
				SendSystemMsg( IDS_USER_NO_PERMISSION_IN_WAR, SYSTEM_ERROR, TO_ME);
				return TRUE;
			}

			for(j =0; j < GUILDFORTRESS_ATTACK_MAX_NUM; j++)// °ø°ÝÃøÀÎÁö..
			{
				if(pFort->m_arAttackGuild[j].lGuild == m_dwGuild)
				{
					SendSystemMsg( IDS_USER_NO_PERMISSION_IN_WAR, SYSTEM_ERROR, TO_ME);
					return TRUE;
				}
			}
		}
	}
	// ±æµå»óÁ¡...
/*	for(i = 0; i < g_arStore.GetSize(); i++)
	{
		pStore = g_arStore[i];
		if(!pStore) continue;

		if(g_arStore[i]->m_lUsed == 1)
		{
			if(pStore->m_iGuildSid == m_dwGuild)	// ¹æ¾îÃøÀÎÁö
			{
				SendSystemMsg( IDS_USER_NO_PERMISSION_IN_WAR, SYSTEM_ERROR, TO_ME);
				return TRUE;
			}

			for(j =0; j < GUILD_ATTACK_MAX_NUM; j++)// °ø°ÝÃøÀÎÁö..
			{
				if(pStore->m_arAttackGuild[j] == m_dwGuild)
				{
					SendSystemMsg( IDS_USER_NO_PERMISSION_IN_WAR, SYSTEM_ERROR, TO_ME);
					return TRUE;
				}
			}
		}
	}
*/
	// Virtual Room¿¡ ÀÖÀ»¶§
	for(i = 0; i < g_arGuildHouseWar.GetSize(); i++)
	{
		if(!g_arGuildHouseWar[i]) continue;

		if(g_arGuildHouseWar[i]->m_CurrentGuild.lUsed == 1)
		{
			if(g_arGuildHouseWar[i]->m_CurrentGuild.lGuild == m_dwGuild)
			{
				SendSystemMsg( IDS_USER_NO_PERMISSION_IN_WAR, SYSTEM_ERROR, TO_ME);
				return TRUE;
			}
		}
	}

	return FALSE;
}

int USER::SocketDisConnect()
{
	BYTE len;
	LOGINOUTTHREADDATA *pLIOTD;
	pLIOTD = new LOGINOUTTHREADDATA;
	pLIOTD->UID = m_Sid;
	len = (BYTE)strlen(m_strUserID);
	memcpy(pLIOTD->ID, &len, sizeof(BYTE) );
	memcpy(pLIOTD->ID+sizeof(BYTE), m_strUserID, len);
	pLIOTD->ID[sizeof(BYTE)+len] = '\0';

	EnterCriticalSection( &m_CS_LogoutData );
	RecvLogoutData.AddTail(pLIOTD);
	nLogoutDataCount = RecvLogoutData.GetCount();
	LeaveCriticalSection( &m_CS_LogoutData );

	return 1;
}

void USER::CheckGuildUserInFortress()
{
	int i, j;
	int ilen = 0;

	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		if(!g_arGuildFortress[i] || !g_arGuildFortress[i]->m_bHaveGuild) continue;

		if(g_arGuildFortress[i]->m_iGuildSid == m_dwGuild)
		{
			for(j = 0; j < MAX_GUILD_USER; j++)
			{
				ilen = strlen(g_arGuildFortress[i]->m_arCityRankList[j].strUserID);
				if(ilen <= 0 || ilen > CHAR_NAME_LENGTH) continue;

				if(strcmp(m_strUserID, g_arGuildFortress[i]->m_arCityRankList[j].strUserID) == 0)
				{
					InterlockedExchange(&g_arGuildFortress[i]->m_arCityRankList[j].lCityRank, (long)m_sCityRank);
					break;
				}
			}
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////
//	±æµå¿¡ °¡ÀÔÇÒ¶§ ½Ã¹Îµî±Þ ¼öÄ¡¸¦ °»½ÅÇÑ´Ù.
//
void USER::AddGuildUserInFortress(USER *pUser)
{
	int i, j;

	if(!pUser) return;

	int nLen = strlen(pUser->m_strUserID);

	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return;

	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		if(!g_arGuildFortress[i] || !g_arGuildFortress[i]->m_bHaveGuild) continue;

		if(g_arGuildFortress[i]->m_iGuildSid == m_dwGuild)
		{
			for(j = 0; j < MAX_GUILD_USER; j++)
			{
				if(InterlockedCompareExchange((LONG*)&g_arGuildFortress[i]->m_arCityRankList[j].lUsed, (long)1, (long)0) == (long)0)
				{
					::ZeroMemory(g_arGuildFortress[i]->m_arCityRankList[j].strUserID, sizeof(g_arGuildFortress[i]->m_arCityRankList[j].strUserID));
					g_arGuildFortress[i]->m_arCityRankList[j].lCityRank = (long)pUser->m_sCityRank;
					strncpy(g_arGuildFortress[i]->m_arCityRankList[j].strUserID, pUser->m_strUserID, nLen);
					return;
				}
			}		
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////
//	±æµå¿¡¼­ °­Åð³ª Å»ÅðÇÒ¶§ ½Ã¹Îµî±Þ ¼öÄ¡¸¦ °»½ÅÇÑ´Ù.
//
void USER::DelGuildUserInFortress(TCHAR *strUserID, int iGuild)
{
	int i, j;
	int ilen = 0;

	if(iGuild <= 0) return;

	for(i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		if(!g_arGuildFortress[i] || !g_arGuildFortress[i]->m_bHaveGuild) continue;

		if(g_arGuildFortress[i]->m_iGuildSid == iGuild)
		{
			for(j = 0; j < MAX_GUILD_USER; j++)
			{
				ilen = strlen(g_arGuildFortress[i]->m_arCityRankList[j].strUserID);
				if(ilen <= 0 || ilen > CHAR_NAME_LENGTH) continue;

				if(strcmp(strUserID, g_arGuildFortress[i]->m_arCityRankList[j].strUserID) == 0)
				{
					::ZeroMemory(g_arGuildFortress[i]->m_arCityRankList[j].strUserID, sizeof(g_arGuildFortress[i]->m_arCityRankList[j].strUserID));
					g_arGuildFortress[i]->m_arCityRankList[j].lCityRank = 0;
					InterlockedExchange(&g_arGuildFortress[i]->m_arCityRankList[j].lUsed, (long)0);
					break;
				}
			}
		}
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////
//	³»°¡ Á×Àº ÀÚ¸®°¡ ÇÑÃ¢ °ø¼ºÀüÀÌ ¹ú¾îÁö´Â ÀÚ¸®¸é ´©±¸³ª ´Ù ¶È°°ÀÌ È®·ü¸¦ Àû¿ë¹Þ´Â´Ù.
//
BOOL USER::CheckGuildWarArea()
{
	int mapindex = 0;
	int index = 0;
	int type = CheckInvalidMapType();

	mapindex = GetGuildMapIndex(type);
	if(mapindex >= 0 && mapindex < g_arMapTable.GetSize())
	{
		if(g_arMapTable[mapindex] == NULL ) return FALSE;
		index = g_arMapTable[mapindex]->m_sStoreID;

		if(index >= FORTRESS_BAND)
		{
			CGuildFortress* pFort = NULL;
			pFort = GetFortress(index);

			if(pFort) 
			{
				if(pFort->m_lUsed == 1 && g_arMapTable[mapindex]->m_sStoreZone)
				{
					return TRUE;
				}
			}
		}
/*		else 
		{
			CStore *pStore = NULL;

			index = g_arMapTable[mapindex]->m_sStoreIndex;

			pStore = GetStore(index);

			if(pStore)
			{
				if(pStore->m_lUsed == 1)								// ÇØ´ç ¼Ó¼º ¸ÊÀÌ ±æµåÀü »óÅÂ	
				{
					return TRUE;
				}
			}
		}
*/	}

	return FALSE;
}

/////////////////////////////////////////////////////////////////////////////////////////////////
//	Æ÷Æ®¸®½º ¿Ü¼º¹®À» ¿­°í ´Ý´Â´Ù.
//
void USER::OpenFortressDoor()
{
	if(m_dwGuild <= 0 || !m_bGuildMaster) return;
	
	CNpc *pNpc = NULL;

	for(int i = 0; i < g_arGuildFortress.GetSize(); i++)
	{
		if(!g_arGuildFortress[i] || !g_arGuildFortress[i]->m_bHaveGuild) continue;

		if(g_arGuildFortress[i]->m_lUsed == 1) continue;
		if(g_arGuildFortress[i]->m_lViolenceUsed == 1) continue;

		if(g_arGuildFortress[i]->m_iGuildSid == m_dwGuild)
		{
			for(int j = 0; j < g_arGuildFortress[i]->m_arRepairNpcList.GetSize(); j++)
			{
				pNpc = GetNpc(g_arGuildFortress[i]->m_arRepairNpcList[j]);

				if(!pNpc) continue;

				if(pNpc->m_sHP > 0 && pNpc->m_tNpcType == NPCTYPE_GUILD_DOOR)
				{
					pNpc->m_sHP = 0;

					MAP* pMap = g_zone[pNpc->m_ZoneIndex];
					pMap->m_pMap[pNpc->m_sCurX][pNpc->m_sCurY].m_lUser = 0;

					pNpc->m_NpcState = NPC_DEAD;

					pNpc->m_Delay = pNpc->m_sRegenTime;
					pNpc->m_bFirstLive = FALSE;

					pNpc->SetMapAfterGuildWar();

					pNpc->SendDead(m_pCom);
					return;
				}
				else
				{
					if(pNpc->m_tNpcType == NPCTYPE_GUILD_DOOR)
					{
						pNpc->m_sHP = pNpc->m_sMaxHP;
						pNpc->m_bFirstLive = TRUE;
						return;
					}			
				}
			}
		}
	}
}

ZONEINFO* USER::GetZoneInfo(int zone)
{
	ZONEINFO* pZoneInfo = NULL;

	for( int i = 0; i < g_TownPotal.GetSize(); i++ )
	{
		if( g_TownPotal[i] )
		{
			pZoneInfo = g_TownPotal[i];

			if( pZoneInfo->iZone == zone )
			{
				return pZoneInfo;
			}
		}
	}

	return NULL;
}

void USER::UpdateCurrentUserTable()
{
	SQLHSTMT		hstmt;
	SQLRETURN		retcode;
	TCHAR			szSQL[1024];

	// session init
	m_bSessionLogOut = FALSE;
	m_iDisplayType = 0;			// ¸Þ¼¼Áö Å¸ÀÔ
	m_iValidTime = 0;			// À¯È¿ ½Ã°£
	m_iTimeInterval = 50;		// ¸Þ¼¼Áö °£°Ý

	BYTE bDisplay = 0;
	int remainTime = 0;
	TIMESTAMP_STRUCT endTime;

	SWORD	sParam1 = 0;
	SDWORD	cbParam1 = SQL_NTS, cbParam2 = SQL_NTS, cbParam3 = SQL_NTS, cbParam4 = SQL_NTS;

	endTime.year = 0;
	endTime.month = 0;
	endTime.day = 0;
	endTime.hour = 0;
	endTime.minute = 0;

	memset(szSQL, 0x00, 1024);
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_CURRENTUSER (\'%s\', \'%s\',?, ?,?,?)}"), m_strAccount, g_arServerIPAddr, sParam1,remainTime, endTime, bDisplay);

	hstmt = NULL;
	retcode = 0;

	int db_index = -1;
	CDatabase* pDB = g_DBSession[m_iModSid].GetDB( db_index );
	if( !pDB ) 
	{
		SoftClose();	// ·Î±× ¾Æ¿ô ÀýÂ÷¿¡ µé¾î°£´Ù.
		return;
	}
	
	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode!=SQL_SUCCESS)
	{
		SoftClose();	// ·Î±× ¾Æ¿ô ÀýÂ÷¿¡ µé¾î°£´Ù.
		return;
	}
	
	if( retcode != SQL_SUCCESS )
	{
		SQLFreeHandle((SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		SoftClose();	// ·Î±× ¾Æ¿ô ÀýÂ÷¿¡ µé¾î°£´Ù.
		return ;
	}

	retcode = SQLBindParameter(hstmt, 1,SQL_PARAM_OUTPUT, SQL_C_SSHORT, SQL_SMALLINT,0,0,&sParam1,0,&cbParam1);
	retcode = SQLBindParameter(hstmt, 2,SQL_PARAM_OUTPUT, SQL_C_SLONG, SQL_INTEGER,0,0,&remainTime,0,&cbParam2);
	retcode = SQLBindParameter(hstmt, 3,SQL_PARAM_OUTPUT, SQL_C_TIMESTAMP, SQL_TIMESTAMP,0,0,&endTime,0,&cbParam3);
	retcode = SQLBindParameter(hstmt, 4,SQL_PARAM_OUTPUT, SQL_C_UTINYINT, SQL_TINYINT,0,0,&bDisplay,0,&cbParam4);


    retcode = SQLExecDirect (hstmt, (unsigned char *)(LPCTSTR)szSQL, SQL_NTS);
	if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
	{
	}
	else if (retcode==SQL_ERROR)
	{
//		DisplayErrorMsg(hstmt);
	}
	else if (retcode==SQL_NO_DATA)
	{
	}
	
	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

	g_DBSession[m_iModSid].ReleaseDB(db_index);

	if(sParam1 != 1)
	{
		SoftClose();	// ·Î±× ¾Æ¿ô ÀýÂ÷¿¡ µé¾î°£´Ù.
		return;
	}

	GetLocalTime(&m_LoginTime);		// ·Î±×ÀÎÇÑ ½Ã°£À» ¼³Á¤
	m_bSessionLogOut = FALSE;
	m_iTimeInterval = (int)remainTime;// Ç¥½Ã¸¦ À§ÇØ
	m_iDisplayType = (int)bDisplay;	// °ÔÀÓ¹æÀÎÁö Á¤¾×Á¦ÀÎÁö ½Ã°£Á¦ÀÎÁö Ç¥½Ã
	m_iValidTime = (int)remainTime;	

	//----------------------------------------------------------------------------------------------
	//yskang 0.5 ¿¥°ÔÀÓ »ç¿ëÀÚ´Â 1±º 2±º¿¡¼­ ¹«·á·Î »ç¿ëÇÒ ¼ö ÀÖ´Ù.
	//----------------------------------------------------------------------------------------------
	m_bMGame = FALSE;//¿¥°ÔÀÓ »ç¿ëÀÚ°¡ ¾Æ´Ï´Ù·Î ÃÊ±âÈ­
	if(m_iDisplayType > 200)
	{
		m_iDisplayType -= 200;//¿¥°ÔÀÓ »ç¿ëÀÚ´Â Å¸ÀÔ¿¡ 200ÀÌ ´õÇØÁ® ÀÖ´Ù.
		m_bMGame = TRUE;//¿¥°ÔÀÓ »ç¿ëÀÚÀÌ°í 1±º 2±º¼­¹ö ÀÌ´Ù.
	}
	
	if(m_iDisplayType == 1 || m_iDisplayType == 3 || m_iDisplayType == 5) // ±â°£Á¦¶ó¸é 
	{
		m_validDate.wYear = endTime.year;
		m_validDate.wMonth = endTime.month;
		m_validDate.wDay = endTime.day;
		m_validDate.wHour = endTime.hour;
		m_validDate.wMinute = endTime.minute;
	}
	GetCheckValidTime();			// ½Ã°£À» Ç¥½ÃÇÑ´Ù.
	//-------------------------------------------------------------------------------------------------

	TRACE("SESSION DB UPDATE SUCCESS : %s\n", m_strAccount);

	return;
}

void USER::GetCheckValidTime()
{
 /*   CString strMsg = _T("");
	CString strMsgg = _T("");
	int temptime = (3600 * 1000);
	int hour = 0,min = 0;
    if(m_dwHtExpTime > 0)
	{
		hour = m_dwHtExpTime/temptime;	min = m_dwHtExpTime%temptime/(60000);
		strMsgg.Format( "»ÃÏëÁéÊ¯Ê£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",hour,min);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NPC, TO_ME);
	}
    if(m_dwMagicFtTime > 0)
	{
		hour = m_dwMagicFtTime/temptime;	min = m_dwMagicFtTime%temptime/(60000);
		strMsgg.Format( "»ÃÏë¾§Ê¯Ê£ÓàÊ±¼ä:%dÐ¡Ê±%d·Ö",hour,min);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsgg, SYSTEM_NPC, TO_ME);
	}
/*	if((m_bMGame == TRUE) && (m_iDisplayType == 5)) // yskang 0.5 ¿¥°ÔÀÓ 1±º 2±º »ç¿ëÀÚ Ã³¸® ½Ã°£ °è»êÀ» ÇÏÁö ¾Ê´Â´Ù.
		return;
	// ÇöÀç Á¢¼ÓÁßÀÎ °èÁ¤ÀÇ ½Ã°£, ±â°£À» ¾Ë·ÁÁØ´Ù.
	SYSTEMTIME currTime;
	GetLocalTime(&currTime);

	CTime curr(currTime);

	int tempValue = 0;

	CString strMsg = _T("");

	if(m_iDisplayType == 1 || m_iDisplayType == 3)
	{
		CTimeSpan DiffDay;
		CTime validDay(m_validDate);

		DiffDay = validDay - curr;
		tempValue = (int)DiffDay.GetDays();

		if(tempValue <= 3)
		{
			if(tempValue == 0)
			{
				strMsg.Format( IDS_USER_UNTIL_TODAY_YOUR_GAMETIME );
				SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE, TO_ME);
			}
			else
			{
				strMsg.Format( IDS_USER_REMAIN_ACCOUNT_USE, tempValue);
				SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE, TO_ME);
			}
			return;
		}	
	}
	else if(m_iDisplayType == 2 || m_iDisplayType == 4)
	{
		if(m_iDisplayType == 2)
		{
			if(m_iValidTime <= 50) //°³ÀÎ
			{
				strMsg.Format( IDS_USER_REMAIN_GAMETIME_MIN, m_iValidTime);
				SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE, TO_ME);
				return;
			}
		}
		else
		{
			if(m_iValidTime <= 3000) // °ÔÀÓ¹æ
			{
				int ihour = (int)(m_iValidTime / 60);
				int iMin = (int)(m_iValidTime % 60);

				strMsg.Format( IDS_USER_REMAIN_GAMEROOMTIME, ihour, iMin);
				SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE, TO_ME);
				return;
			}
		}
	}
/*	else if(m_iDisplayType == 6)
	{
		strMsg.Format("À¯Àú´ÔÀÌ Á¢¼ÓÇÏ½Å Ã¼ÇèÆÇ ¼­¹ö½º´Â ±â´É»ó Á¦¾àÀÌ ÀÖ½À´Ï´Ù.");
		SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_NORMAL, TO_ME);
	}
*/
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	ºÎ±æ¸¶¸¦ ÀÓ¸í, ±ÇÇÑ ÀÌ¾ç
//
void USER::DeputeGuildMasterOfPower(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	int index = 0;
	int nLen = 0;

	int uid = 0;
	USER* pUser = NULL;
	CGuild *pGuild = NULL;

	if(!m_bGuildMaster) return; 	// ±æµå ±ÇÇÑÀÌ ¾ø´Ù.

	BYTE error_code = 0;
	BOOL bRes = TRUE;

	uid = GetInt(pBuf, index);

	pUser = GetUser(uid - USER_BAND);

	if(!pUser || pUser->m_state != STATE_GAMESTARTED) return;	// À¯Àú°¡ ¾ø´Ù.

	if(IsThereUser(pUser) == FALSE || strcmp(m_strUserID, pUser->m_strUserID) == 0)
	{
		SendSystemMsg( IDS_USER_SEE_EACH_OTHER, SYSTEM_NORMAL, TO_ME);//"»¥ÏàÃæ¶ÔÃæ."
		return;
	}

	nLen = strlen(pUser->m_strUserID);
	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH) return;

	CString strMsg = _T("");
	USER *pGUser = NULL;			// ¸Þ¼¼Áö¸¦ ¾Ë¸°´Ù.

	CBufferEx TempBuf;

	if(pUser->m_dwGuild != m_dwGuild)  
	{
		error_code = ERR_9; 
		goto go_result;		
	}// ´Ù¸¥ ±æµå¿¡ °¡ÀÔÇÑ À¯Àú 
	
	if(CheckInGuildWarring()) return;// ±æÀüÁß¿¡´Â Çã¶ôÇÒ¼ö¾ø´Ù.

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_7;			// ÇØ´ç ±æµå°¡ ¾ø´Ù.
		goto go_result;				
	}
									// ¿À·ù...
	if(strcmp(pGuild->m_strMasterName, m_strUserID) != 0) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_10;		// 
		goto go_result;
	}

	if(pGuild->m_lSubMaster == 1)		// ÇöÀç ºÎ±æ¸¶°¡ ´©±ºÀÌÁö ¾Ë·ÁÁØ´Ù.
	{
		strMsg = _T("");
		strMsg.Format(IDS_USER_GUILD_SUBMASTER, pGuild->m_strSubMasterName);//"ÄãÈÎÃüÁË %s ×÷Îª¾üÍÅ¸±ÍÅ³¤."
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		ReleaseGuild();				// ÇØÁ¦...
		return;
	}

	index = -1;
	index = pGuild->GetUser(pUser->m_strUserID);
	ReleaseGuild();					// ÇØÁ¦...

	if(index < 0)
	{	
		error_code = ERR_8;			// 
		goto go_result;		
	}


	// Add By Youn Gyu
	g_pMainDlg->BridgeDeputeGuildMasterOfPowerReq( m_uid, pUser->m_uid, m_strUserID, pUser->m_strUserID, (int)m_dwGuild );
//0509

	UpdateGuildSubMaster(pUser->m_strUserID, TRUE);
	pUser->m_bRepresentationGuild = TRUE;
	pGuild->CheckGuildSubMaster();
	pGuild->SetSubGuildMaster( pUser->m_strUserID );
	
	ReleaseGuild();

	

	strMsg = _T("");
	strMsg.Format( IDS_USER_GUILD_SUBMASTER_ON, pUser->m_strUserID);//"%s ±»ÈÎÃüµ£ÈÎ¾üÍÅ¸±ÍÅ³¤."

	for(int i = 0; i < MAX_USER; i++)
	{
		pGUser = m_pCom->GetUserUid(i);

		if(pGUser == NULL || pGUser->m_state != STATE_GAMESTARTED) continue;		

		if(m_dwGuild == pGUser->m_dwGuild)
		{
			pGUser->SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
	}	
	return;
	//


	if(UpdateGuildSubMaster(pUser->m_strUserID, TRUE) <= 0)
	{
		return;
	}
	
	pGuild = GetGuild(m_dwGuild);

	if(pGuild == NULL) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_7;			// ÇØ´ç ±æµå°¡ ¾ø´Ù.
		goto go_result;				
	}

	pUser->m_bRepresentationGuild = TRUE;
	pGuild->CheckGuildSubMaster();
	pGuild->SetSubGuildMaster(pUser->m_strUserID);

	ReleaseGuild();				// ÇØÁ¦...
	bRes = FALSE;

go_result:
	if(bRes)
	{
		CBufferEx TempBuf;
		TempBuf.Add(CHAT_RESULT);
		TempBuf.Add((BYTE)0x00);		//½ÇÆÐ
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	±ÇÇÑ¸¦ »¯´Â´Ù.
//
void USER::RemoveGuildMasterOfPower(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	int index = 0;
	int nLen = 0;

	int uid = 0;
	USER* pUser = NULL;
	CGuild *pGuild = NULL;

	if(!m_bGuildMaster && !m_bRepresentationGuild) return; 	// ±æµå ±ÇÇÑÀÌ ¾ø´Ù.

	TCHAR strName[CHAR_NAME_LENGTH + 1];
	::ZeroMemory(strName, sizeof(strName));

	BYTE error_code = 0;
	BOOL bRes = TRUE;
	CString strMsg = _T("");
	USER *pGUser = NULL;			// ¸Þ¼¼Áö¸¦ ¾Ë¸°´Ù.

	CBufferEx TempBuf;

	if(CheckInGuildWarring()) return;// ±æÀüÁß¿¡´Â Çã¶ôÇÒ¼ö¾ø´Ù.

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_7;			// ÇØ´ç ±æµå°¡ ¾ø´Ù.
		goto go_result;				
	}
									// ¿À·ù...
//	if(strcmp(pGuild->m_strMasterName, m_strUserID) != 0) 
	if(!pGuild->IsMasterPower(m_strUserID))
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_10;		// 
		goto go_result;
	}

	nLen = 0;
	nLen = strlen(pGuild->m_strSubMasterName);
	if(pGuild->m_lSubMaster != 1 || (nLen <= 0 || nLen > CHAR_NAME_LENGTH) )		// ÇöÀç ºÎ±æ¸¶¾ø´Ù°í ¾Ë·ÁÁØ´Ù.
	{
		SendSystemMsg( IDS_USER_GUILD_SUBMASTER_NOT, SYSTEM_ERROR, TO_ME);
		ReleaseGuild();				// ÇØÁ¦...
		return;
	}

	ReleaseGuild();	

	// Add By Youn Gyu
	g_pMainDlg->BridgeRemoveGuildMasterOfPowerReq( m_uid, m_strUserID, (int)m_dwGuild );

	strMsg = _T("");
	strMsg.Format( IDS_USER_GUILD_SUBMASTER_OFF, pGuild->m_strSubMasterName);// "%s ±»È¡Ïûµ£ÈÎ¾üÍÅ¸±ÍÅ³¤."

	UpdateGuildSubMaster(NULL, FALSE) ;

	pGuild->RemoveSubGuildMaster();
	ReleaseGuild();	

	

	for(int i = 0; i < MAX_USER; i++)
	{
		pGUser = m_pCom->GetUserUid(i);

		if(pGUser == NULL || pGUser->m_state != STATE_GAMESTARTED) continue;		

		if(m_dwGuild == pGUser->m_dwGuild)
		{
			pGUser->SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		}
	}	

	return;
	//



	if(UpdateGuildSubMaster(NULL, FALSE) <= 0)
	{
		return;
	}
	
	pGuild = GetGuild(m_dwGuild);

	if(pGuild == NULL) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_7;			// ÇØ´ç ±æµå°¡ ¾ø´Ù.
		goto go_result;				
	}

	ReleaseGuild();				// ÇØÁ¦...

go_result:
	if(bRes)
	{
		CBufferEx TempBuf;
		TempBuf.Add(CHAT_RESULT);
		TempBuf.Add((BYTE)0x00);		//½ÇÆÐ
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
//	±ÇÇÑ ÀÌ¾ç¸¦ ¾÷µ«
//
int USER::UpdateGuildSubMaster(TCHAR *strSubMaster, BOOL bPower)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	BOOL			bQuerySuccess = TRUE;
	TCHAR			szSQL[8000];		

	::ZeroMemory(szSQL, sizeof(szSQL));

	SWORD	sRet = 0;
	SDWORD	cbRet = SQL_NTS;

	int index = 0;

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_GUILD_SUBMASTER (%d, \'%s\', \'%s\', %d,?)}"), m_dwGuild, m_strUserID, strSubMaster, bPower, sRet); 

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return -1;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return -1;

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLBindParameter(hstmt, 1,SQL_PARAM_OUTPUT, SQL_C_SSHORT, SQL_SMALLINT,0,0,&sRet,0,&cbRet);

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
	}
	
	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);

	if( sRet != 1 ) return FALSE;

	return TRUE;	
}

void USER::EncryptionStartReq(TCHAR *pBuf)
{
	if(m_isCryptionFlag != 0) return;
	
	int index = 0;
	BYTE tType = GetByte(pBuf, index);
	
	if(tType >= 3) return;

	index = 0;
	SetByte(m_TempBuf, ENCRYPTION_START_RESULT, index );
	SetString(m_TempBuf, (char *)&m_public_key, sizeof(_int64), index);
	SetByte(m_TempBuf, tType, index);

	m_isCryptionFlag = 0;

	Send( m_TempBuf, index );

	m_isCryptionFlag = 1;
}

void USER::SetPublicKey()
{
	// IKING 2001.1.
    srand( (unsigned)time( NULL ) );
	//
	BYTE rand1,rand2,rand3,rand4,rand5,rand6,rand7,rand8;

	int out_flag = 0;
	do
	{
		rand1 = rand();
		rand2 = rand();
		rand3 = rand();
		rand4 = rand();
		rand5 = rand();
		rand6 = rand();
		rand7 = rand();
		rand8 = rand();

		m_public_key = rand1;
		m_public_key <<= 8;

		m_public_key |= rand2;
		m_public_key <<= 8;

		m_public_key |= rand3;
		m_public_key <<= 8;

		m_public_key |= rand4;
		m_public_key <<= 8;

		m_public_key |= rand5;
		m_public_key <<= 8;

		m_public_key |= rand6;
		m_public_key <<= 8;

		m_public_key |= rand7;
		m_public_key <<= 8;

		m_public_key |= rand8;

		if(m_public_key != 0)
			out_flag = 1;

	} while( !out_flag );
//#ifdef _CHINA
	//±ê×¼ÈÕ·þ
//	m_public_key = 0x1010101010101010;// test code
	//¹ú·þ
	m_public_key = 0x8080808080808080;// test code
//#endif
}

void USER::SendGuildInviteReq(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	int index = 0;
	BYTE error_code = 0;

	int nLen = 0;

	int uid = 0;
	int iCount = 0;
	USER* pUser = NULL;
	CGuild *pGuild = NULL;
	CGuildUser *pGuildUser = NULL;

	BOOL bRes = TRUE;

	if(!m_bGuildMaster && !m_bRepresentationGuild) { error_code = ERR_10; goto go_result; }	// ±æµå ±ÇÇÑÀÌ ¾ø´Ù.

	uid = GetInt(pBuf, index);

	pUser = GetUser(uid - USER_BAND);

	if(!pUser) { error_code = ERR_3; goto go_result; }				// À¯Àú°¡ ¾ø´Ù.

	if(IsThereUser(pUser) == FALSE || strcmp(m_strUserID, pUser->m_strUserID) == 0)
	{
		SendSystemMsg( IDS_USER_SEE_EACH_OTHER, SYSTEM_NORMAL, TO_ME);
		return;
	}

	nLen = strlen(pUser->m_strUserID);
	if(nLen <= 0) return;

	if(pUser->m_dwGuild > 0)  { error_code = ERR_9; goto go_result; }// ÀÌ¹Ì ´Ù¸¥ ±æµå¿¡ °¡ÀÔÇÑ À¯Àú 
	
	if(CheckInGuildWarring()) return;								// ±æÀüÁß¿¡´Â Çã¶ôÁA¼ö¾ø´Ù.

	pGuild = GetGuild(m_dwGuild);

	if(!pGuild) 
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_7;			// ÇØ´ç ±æµå°¡ ¾ø´Ù.
		goto go_result;				
	}
									// ¿À·ù...
//	if(strcmp(pGuild->m_strMasterName, m_strUserID) != 0) 
	if( !pGuild->IsMasterPower(m_strUserID) )
	{
		ReleaseGuild();				// ÇØÁ¦...
		error_code = ERR_10;		// 
		goto go_result;
	}

	index = -1;
	index = pGuild->GetUser(pUser->m_strUserID);
	if(index >= 0) 
	{ 
		ReleaseGuild();				// ÇØÁ¦...

		pUser->m_dwGuild = m_dwGuild;			// ±æµå ¹øÈ£¸¦ ´Ù½Ã ¼ÂÆÃÇÑ´Ù.
		SendGuildInfo(pUser);

		error_code = ERR_9; 
		goto go_result; 
	}

	ReleaseGuild();				// ÇØÁ¦...
	bRes = FALSE;

go_result:

	CBufferEx TempBuf;

	if(bRes)
	{
		TempBuf.Add(GUILD_INVITE_RESULT);
		TempBuf.Add((BYTE)0x04);		//½ÇÆÐ
		TempBuf.Add(error_code);
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	TempBuf.Add(GUILD_INVITE_REQ);
	TempBuf.Add(m_uid + USER_BAND);

	pUser->Send(TempBuf, TempBuf.GetLength());
}

void USER::GuildInviteResult(TCHAR *pBuf)
{
	if ( pBuf == NULL ) return;

	int index = 0;
	BYTE error_code = 0;

	int uid = 0;
	USER* pUser = NULL;

	CBufferEx TempBuf;
	TCHAR szGuildName[CHAR_NAME_LENGTH + 1];
	::ZeroMemory(szGuildName, sizeof(szGuildName));

	BYTE tType = GetByte(pBuf, index);

	uid = GetInt(pBuf, index);
	if(uid < 0 || uid >= INVALID_BAND) { error_code = ERR_3; goto go_result; }

	pUser = GetUser(uid - USER_BAND);								// »ó´ë¹æ
	if(!pUser) { error_code = ERR_3; goto go_result; }				// À¯Àú°¡ ¾ø´Ù.

	if(tType == 1)
	{
		if(!pUser->m_bGuildMaster && !pUser->m_bRepresentationGuild) { error_code = ERR_10; goto go_result; }

		pUser->GuildInvite(m_uid + USER_BAND);

		TempBuf.Add(GUILD_INVITE_RESULT);
		TempBuf.Add((BYTE)0x01);

		Send(TempBuf, TempBuf.GetLength());
		pUser->Send(TempBuf, TempBuf.GetLength());
		return;
	}
	else
	{
		TempBuf.Add(GUILD_INVITE_RESULT);
		TempBuf.Add((BYTE)0x03);		// °ÅÀý ÁÖÃ¼ : 3, ÇÇ ÁÖÃ¼ : 2
		Send(TempBuf, TempBuf.GetLength());

		CBufferEx TempBuf1;
		TempBuf1.Add(GUILD_INVITE_RESULT);
		TempBuf1.Add((BYTE)0x02);
		pUser->Send(TempBuf1, TempBuf1.GetLength());
		return;
	}

go_result:														 // ÀÌ ºÎºÐ Ã³¸®´Â ³ªÁß¿¡ ´Ù½Ã °ËÅä
	TempBuf.Add(GUILD_INVITE_RESULT);
	TempBuf.Add((BYTE)0x04);		//½ÇÆÐ
	TempBuf.Add(error_code);
	Send(TempBuf, TempBuf.GetLength());

	if(pUser && pUser->m_state == STATE_GAMESTARTED)
	{
		pUser->Send(TempBuf, TempBuf.GetLength());
	}
}

//-----------------------------------------------------------------------------------------
//--yskang 0.1 ±æµå¿ø¿¡°Ô È£ÄªÀ» ºÎ¿©ÇÑ´Ù.
//³ÆºÅ
//-----------------------------------------------------------------------------------------
void USER::LoveName(TCHAR *pBuf)
{
	//------------------------------------------------------------------------------------------------
	/* ¿¡·¯ ÄÚµå
	01 : ±ÇÇÑÀÌ ¾ø´Ù.
	02 : Ã£´Â ¾ÆÀÌµð°¡ ¾ø´Ù.
	03 : °°Àº ±æµå¿øÀÌ ¾Æ´Ï´Ù.
	04 : È£Äª[¾ÖÄª]ÀÌ Àß¸øµÇ¾ú´Ù.
	05 : µðºñ¿¡ ÀúÀå ÇÒ ¼ö ¾ø¾ú´Ù.
	06 : ¿åÀÌ´Ù.
	*/
	//-------------------------------------------------------------------------------------------------
	CBufferEx ResultTempBuf; 
	CBufferEx TempBuf;
	BOOL bSuccess = FALSE;
	BYTE byCommand=(BYTE)1;
	int nLength = 0;
	int uid = 0;
	int index = 0;//¹è¿­ Æ÷ÀÎÅÍ À§Ä¡
	USER* pUser = NULL;
	BYTE error_code = ERR_1;
	byCommand = GetByte(pBuf,index);
	

	//È£ÄªÀ» ºÎ¿©ÇÏ°íÀÚ ÇÏ´Â À¯Àú¸¦ Ã£´Â´Ù.
	//--ÀÓ½Ã·Î
	uid = GetInt(pBuf, index);
	
	if(uid < USER_BAND || uid >= NPC_BAND) 
		return;
	pUser = GetUser(uid - USER_BAND);		
	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
	if(pUser->m_uid == m_uid)
	{
		if(m_sLevel < 70) { error_code = ERR_1; goto go_result; }//70·¹º§ ÀÌÇÏ¶ó È£ÄªÀ» ºÎ¿©ÇÒ ¼ö ¾ø´Ù.		
	}
	else //±æ¿ø¿¡°Ô È£ÄªºÎ¿©
	{
		if(m_sLevel < 70) { error_code = ERR_1; goto go_result; } //70·¹º§ ÀÌÇÏ¶ó È£ÄªÀ» ºÎ¿©ÇÒ ¼ö ¾ø´Ù.
			
		//È£ÄªÀ» ºÎ¿©ÇÒ¼öÀÖ´Â ÀÚ°ÝÀ» °®Ãß°í ÀÖ´Â°¡?
		if(!m_bGuildMaster) 
		{
			error_code = ERR_1; 
			goto go_result; 
		}	// È£Äª ºÎ¿© ÀÚ°ÝÀÌ ¾ø´Ù.

	}
	if(strcmp(pUser->m_strGuildName,m_strGuildName)!=0)//°°Àº ±æµå¿øÀÌ ¾Æ´Ï¶ó¸é....
	{ error_code = ERR_3; goto go_result; }

	//¸¸¾à »èÁ¦¶ó¸é
	if(byCommand == 0)
	{
		//È£ÄªÀ» ¸Þ¸ð¸® µðºñ¿¡ ÀúÀåÇÑ´Ù(?)
		::ZeroMemory(pUser->m_strLoveName,sizeof(pUser->m_strLoveName));
		strcpy(pUser->m_strLoveName,"");
		lstrcpy(pUser->m_pMD->m_strLoveName , pUser->m_strLoveName);
		//È£ÄªÀ» ´Ù¸¥ »ç¶÷µé¿¡°Ô ¾Ë¸°´Ù(°°Àº ½ºÅ©¸°¿¡ ÀÖ´Â»ç¶÷µé¿¡ ÇÑÇØ¼­?)
		TempBuf.Add(LOVE_NAME);
		TempBuf.Add(uid);
		TempBuf.AddString(pUser->m_strLoveName);
		pUser->SendExactScreen(TempBuf, TempBuf.GetLength());
		bSuccess = TRUE;
		goto go_result;
	}

	if(byCommand>1) return;

	//ÆÐÅ¶¿¡¼­ È£ÄªÀ» »Ì¾Æ³½´Ù.
	char strTemp[1024];
	//char strTemp1[1024];
	nLength = GetVarString(sizeof(strTemp), strTemp, pBuf, index);
	if(nLength < 1 || nLength > 25/*CHAR_NAME_LENGTH*/) // Àß¸øµÈ È£Äª
	{
		error_code = ERR_4;  goto go_result; 
	}
	if(IsReservedID(strTemp)) { error_code = ERR_6; goto go_result; }
		
	if(!UNI_CHAR::CheckString(strTemp)) {error_code=ERR_6; goto go_result;}

/*	strcpy(strTemp1,strTemp);

	sprintf(strTemp,"@9[Lv.%d]%s",m_sLevel,strTemp1);//³ÆºÅÏÔÊ¾µÈ¼¶ °¢´ó¹¤×÷ÊÒ*/

	//--------------------------------------------------------------------------------------
	//--yskang 0.6 À¯·á»ç¿ëÀÚ ÇÁ¸®¹Ì¾ö È£ÄªÀ» »ç¿ëÇÑ´Ù.
	if(pUser->m_iDisplayType != 5 && pUser->m_iDisplayType != 6)
		strcpy(pUser->m_strLoveName,strTemp);
	else {error_code = ERR_1; goto go_result; }
	//---------------------------------------------------------------------------------------

	
	if(pUser->m_bPseudoString==TRUE)
	{

		//------------------------------------------------------------------------------------
		//Ã³À½ È£ÄªÀÌ ºÎ¿©µÇ´Â °ÍÀÌ¶ó¸é µðºñ¿¡ InsertÇÑ´Ù.
		//------------------------------------------------------------------------------------
		index = 0;
		BYTE *pData;
		SQLDATAPACKET *pSDP;
		pSDP = new SQLDATAPACKET;
		pSDP->UID = m_uid;
		pSDP->code = LOVE_NAME_RESULT;
		int Datalength = pSDP->dcount = sizeof(uid);
		pData = new BYTE[Datalength+1];
		memset(pData, 0, Datalength+1);
		memcpy(pData, &uid,sizeof(uid));//±æ¿ø ¾ÆÀÌµð¸¦ Àü´Þ....
		pSDP->pData = pData;

		//------------------------------------------------------------------------------------
		//¾²·¹µå¿¡¼­ Ã³¸®ÇÑ´Ù.
		//------------------------------------------------------------------------------------
		EnterCriticalSection( &m_CS_SqlData );
		RecvSqlData.AddTail(pSDP);
		nSqlDataCount = RecvSqlData.GetCount();
		LeaveCriticalSection( &m_CS_SqlData );	

		//-------------------------------------------------------------------------------------
		//--µðºñ Insert³¡
		//-------------------------------------------------------------------------------------
	}
	else
	{

		//È£ÄªÀ» ¸Þ¸ð¸® µðºñ¿¡ ÀúÀåÇÑ´Ù(?)
		if( m_dwPD != 0)
		{
		     char szTest[30];
	         ZeroMemory(szTest,sizeof(szTest));
		     strcpy(szTest,pUser->m_strLoveName);
             sprintf(pUser->m_strLoveName,"@9[%d]%s",m_dwPD,szTest);
		}else strcpy(pUser->m_pMD->m_strLoveName , pUser->m_strLoveName);
		//È£ÄªÀ» ´Ù¸¥ »ç¶÷µé¿¡°Ô ¾Ë¸°´Ù(°°Àº ½ºÅ©¸°¿¡ ÀÖ´Â»ç¶÷µé¿¡ ÇÑÇØ¼­?)
		TempBuf.Add(LOVE_NAME);
		TempBuf.Add(uid);
		TempBuf.AddString(pUser->m_strLoveName);
		pUser->SendExactScreen(TempBuf, TempBuf.GetLength());
		bSuccess = TRUE;
go_result:
		ResultTempBuf.Add(LOVE_NAME_RESULT);
		if(bSuccess == FALSE)
		{
			ResultTempBuf.Add(FAIL);				// ½ÇÆÐ
			ResultTempBuf.Add(error_code);
			Send(ResultTempBuf,ResultTempBuf.GetLength());
			return;
		}
		ResultTempBuf.Add(SUCCESS);					// ¼º°ø	
		Send(ResultTempBuf, ResultTempBuf.GetLength());
	}
}
////////////////////////////////////////////////////////////////////////////////////////
//	tMyClass Å¬·¡½º°¡ tNeedClass ¸¦ ¾µ ¼ö ÀÖ´ÂÁö °Ë»ç.
//


void USER::UpdateUserDeadLog(TCHAR *pBuf)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	int				index = 0;

	TCHAR			szSQL[1024];
	::ZeroMemory(szSQL, sizeof(szSQL));

	//yskang 0.8 add dead log
	TCHAR			strPKName[100];
	::ZeroMemory(strPKName, sizeof(strPKName));

	DWORD minus = GetDWORD(pBuf, index);
	DWORD preExp = GetDWORD(pBuf, index);
	BYTE nLen = GetByte(pBuf,index);//yskang 0.8 add dead log 
	GetString((char *)strPKName,pBuf,nLen,index);//yskang 0.8  add dead log

	CPoint pt = ConvertToClient(m_curx, m_cury);
																	// id, level,z, x, y, iExp, minus exp, preExp, iCityValue					
	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call UPDATE_USER_DEAD_DATA (\'%s\',%d,%d,%d,%d,%d,%d,%d,%d,\'%s\',%d)}"), m_strUserID,m_sLevel,m_curz,pt.x,pt.y,m_dwExp,minus,preExp,m_iCityValue,strPKName,m_iDisplayType);//yskang 0.8 dead log ¼öÁ¤ Á×ÀÎ»ç¶÷ ÀÌ¸§, °èÁ¤ Á¢¼Ó Å¸ÀÔ Ãß°¡ 

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Update Guild Warehouse Data !!\n");

		//g_DB[m_iModSid].ReleaseDB(db_index);
		return;
	}
	
	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);		
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
			SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

			g_DBNew[m_iModSid].ReleaseDB(db_index);
			return;
		}
	}	
	else
	{
		DisplayErrorMsg( hstmt );
		SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DBNew[m_iModSid].ReleaseDB(db_index);
		return;
	}

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
}

void USER::UpdateUserDeadLog(DWORD minus, DWORD preExp, TCHAR *strPKName)
{
	int index = 0;
	TCHAR pBuf[100];

	::ZeroMemory(pBuf, sizeof(pBuf));

	SetDWORD(pBuf, minus, index);
	SetDWORD(pBuf, preExp, index);
	int nLen = strlen(strPKName);
		if(nLen < 1) nLen =1;
	SetByte(pBuf, (BYTE)nLen, index);
	SetString(pBuf,strPKName,nLen,index);
	
	int Datalength;
	BYTE *pData;
	SQLDATAPACKET *pSDP;
	pSDP = new SQLDATAPACKET;
	pSDP->code = DB_USER_DEAD;
	Datalength = index;
	pSDP->dcount = Datalength;
	pSDP->UID = m_uid;
	pData = new BYTE[Datalength+1];
	memset(pData, 0, Datalength+1);
	memcpy(pData, pBuf, Datalength);
	pSDP->pData = pData;

	EnterCriticalSection( &m_CS_SqlData );
	RecvSqlData.AddTail(pSDP);
	nSqlDataCount = RecvSqlData.GetCount();
	LeaveCriticalSection( &m_CS_SqlData );	
}

////////////////////////////////////////////////////////////////////////////////////////
//¼ì²éÖ°ÒµÎïÆ·
BOOL USER::CheckClassItem(BYTE tMyClass, BYTE tNeedClass)
{
	BYTE tTemp = 1;	
	BYTE tFire = 0;
	BYTE tEdge = 0;
	BYTE tStaff = 0;
	BYTE tBrawl = 0;
	BYTE tJudge = 0;

	tFire	 = tTemp & tNeedClass; tTemp = 2; 
	tEdge	 = tTemp & tNeedClass; tTemp = 4;
	tStaff	 = tTemp & tNeedClass; tTemp = 8;
    tJudge   = tTemp & tNeedClass; tTemp = 16;
	tBrawl	 = tTemp & tNeedClass;

	tFire = tFire & tMyClass;
	tEdge = tEdge & tMyClass;
	tStaff = tStaff & tMyClass;
	tBrawl = tBrawl & tMyClass;
	tJudge = tJudge & tMyClass;

	tTemp = tFire^tEdge^tStaff^tBrawl^tJudge;

	if(!tTemp) return FALSE;
	return TRUE;
}

//////////////////////////////////////////////////////////////////////////////////////
//	Moon Event Item Use...
//
BOOL USER::MoonEvent(short sSlot)
{
	CString strMsg = _T("");
	short sSid = 0;
	int iRandom = 0, iSummon = 0;
	ItemList Item;
	int iItemNum = 0;
	int iEmptySlot = -1, iSameSlot = -1;
	int i = 0;
	int iDeleteHP = 0;
	BYTE tSlot = 0;
	short sCount = 0;
	CPoint pt;
	BOOL bRet = FALSE;

	if(g_iMoonEvent == 0)
	{
		strMsg.Format(IDS_EVENT_END);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		return FALSE;
	}

	if(sSlot < EQUIP_ITEM_NUM || sSlot >= TOTAL_INVEN_MAX) return FALSE;
	
	sSid = m_UserItem[sSlot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return FALSE;
	if(m_UserItem[sSlot].sCount <= 0) return FALSE;

	switch(sSid)
	{
	case EVENTITEM_SID_MOON:
		if(m_dwAdamantineTime != 0 || m_dwMightyWeaponTime != 0 )
		{
			strMsg.Format(IDS_ANOTHER_PSI_RUN);
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
			return FALSE;
		}

		SetBerserker(60 * 5);
		SendPsiAttackResult(SUCCESS, m_uid + USER_BAND, 15);
		break;

/*	case EVENTITEM_SID_SONGPEON_01:
		GetExp(87);
		strMsg.Format(IDS_MOON_SONGPEON_01);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		break;
	case EVENTITEM_SID_SONGPEON_11:
		GetExp(654);
		strMsg.Format(IDS_MOON_SONGPEON_11);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		break;
	case EVENTITEM_SID_SONGPEON_31:
		GetExp(11185);
		strMsg.Format(IDS_MOON_SONGPEON_31);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		break;
	case EVENTITEM_SID_SONGPEON_51:
		GetExp(67550);
		strMsg.Format(IDS_MOON_SONGPEON_51);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		break;*/
	case EVENTITEM_SID_SONGPEON_71:
		//GetExp(200000000);
		if(m_sLevel >= o_yehuoini[0]->zgdj)
         return FALSE;
		GetExp(m_dwExpNext);
		strMsg.Format(IDS_MOON_SONGPEON_71);
		SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
		break;

	case EVENTITEM_SID_BOX: case 868:
		if(m_curz >= 56 && m_curz <= 59 || m_curz == 1005)
		{
			strMsg.Format(IDS_CANNOT_USE_BOX);
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
			return FALSE;
		}

		iRandom = myrand(0, 999);
		if(g_arBoxEventTable[iRandom]->m_tType == 1)	// Summoning Monster
		{
			iSummon = myrand(0, g_arSummonTable.GetSize() - 1);
			
			g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_bMove = 1;
			pt = FindNearAvailablePoint_S(m_curx, m_cury);
			g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_bMove = 0;

			if(pt.x == -1 || pt.y == -1) return FALSE;

			bRet = SummonMonster(g_arSummonTable[iSummon]->m_strName, pt);
			return bRet;
		}
		else //if(g_arBoxEventTable[iRandom]->m_tType >= 2 && g_arBoxEventTable[iRandom]->m_tType <= 37)	// Give Item
		{
			iItemNum = g_arBoxEventTable[iRandom]->m_sIid;

			Item.sSid		= g_arItemTable[iItemNum]->m_sSid;
			Item.sLevel		= g_arItemTable[iItemNum]->m_byRLevel;
			Item.sDuration	= g_arItemTable[iItemNum]->m_sDuration;
			Item.sCount		= g_arBoxEventTable[iRandom]->m_sCount;
			Item.sBullNum	= g_arItemTable[iItemNum]->m_sBullNum;
			Item.tIQ		= NORMAL_ITEM;
			Item.iItemSerial= 0;
			for(i = 0; i < MAGIC_NUM; i++) Item.tMagic[i] = 0;

			iSameSlot	=	GetSameItem(Item, INVENTORY_SLOT); 
			iEmptySlot	=	GetEmptySlot(INVENTORY_SLOT);
			
			if(iEmptySlot == -1)	// ÀÎº¥¿¡ ÃÖ¼ÒÇÑ ÇÏ³ªÀÇ ºó°ø°£ÀÌ ÀÖ¾î¾ß ·£´ýÇÏ°Ô ¾ÆÅÛÀ» ÁÙ ¼ö ÀÖ´Ù.
			{
				strMsg.Format(IDS_INVENTORY_FULL);
				SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);
				return FALSE;
			}

			if(Item.sCount == 1 && Item.sDuration > 0 ) MakeItemLog(&Item, ITEMLOG_EVENT_GIVE);

			for(i = 0; i < Item.sCount; i++) m_iCurWeight += g_arItemTable[iItemNum]->m_byWeight;
			GetRecoverySpeed();

			if(iSameSlot != -1) 
			{
				sCount = m_UserItem[iSameSlot].sCount;
				m_UserItem[iSameSlot] = Item;
				m_UserItem[iSameSlot].sCount += sCount;
				tSlot = (BYTE)iSameSlot;
			}
			else if(iEmptySlot != -1) 
			{
				m_UserItem[iEmptySlot] = Item;
				tSlot = (BYTE)iEmptySlot;
			}

			SendSystemMsg((LPTSTR)(LPCTSTR)g_arBoxEventTable[iRandom]->m_strText, SYSTEM_NORMAL, TO_ME);
			
			CBufferEx TempBuf;

			TempBuf.Add(ITEM_MOVE_RESULT);
			TempBuf.Add(SUCCESS);
			TempBuf.Add((BYTE)0);		// Type
			TempBuf.Add((BYTE)1);		// Count
			
			TempBuf.Add(tSlot);
			TempBuf.Add(m_UserItem[tSlot].sLevel);
			TempBuf.Add(m_UserItem[tSlot].sSid);
			TempBuf.Add(m_UserItem[tSlot].sDuration);
			TempBuf.Add(m_UserItem[tSlot].sBullNum);
			TempBuf.Add(m_UserItem[tSlot].sCount);
			for(i =0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tSlot].tMagic[i]);
			
			TempBuf.Add(m_UserItem[tSlot].tIQ); 
			
			Send(TempBuf, TempBuf.GetLength());
		}
		/*else if(g_arBoxEventTable[iRandom]->m_tType == 38 || g_arBoxEventTable[iRandom]->m_tType == 39)	// Minus HP 40% or 30%
		{
			if(g_arBoxEventTable[iRandom]->m_tType == 38)	iDeleteHP = (int)((double)m_sHP * 0.4);
			else if(g_arBoxEventTable[iRandom]->m_tType == 39)	iDeleteHP = (int)((double)m_sHP * 0.3);

			if(iDeleteHP > 0)
			{
				m_sHP -= iDeleteHP;
				if(m_sHP < 0) m_sHP = 0;
				SendSystemMsg((LPTSTR)(LPCTSTR)g_arBoxEventTable[iRandom]->m_strText, SYSTEM_NORMAL, TO_ME);
				SendHP();
			}			
		}*/

		break;

	default:
		return FALSE;
	}

	return TRUE;
}

///////////////////////////////////////////////////////////////////////
//	Summoning Monster
//
BOOL USER::SummonMonster(CString strName, CPoint pt)
{
	CNpc* pNpc = NULL;
	int i;
	CString strMsg = _T("");

	MYSHORT sAI;
	BYTE upTemp = 0;			// »óÀ§ 8ºñÆ®
	BYTE dwTemp = 0;			// ÇÏÀ§ 8ºñÆ®

//	int iDeleteIndex = 0;
//	TCHAR DeleteSend[2048];	

//	int iModifyIndex = 0;
//	TCHAR ModifySend[2048];	
    if (strName=="ÎÀ±ø") strName="¿¨ÌØ";
	int NpcState = NPC_DEAD;

	for(i = 0; i < g_arNpc.GetSize(); i++)
	{
		pNpc = g_arNpc[i];
		if( !pNpc ) continue;

		if(strName.CompareNoCase(pNpc->m_strName) == 0)
		{
			if(pNpc->m_sCurZ == 1005) continue;
			if(pNpc->m_NpcState != NPC_DEAD && pNpc->m_NpcState != NPC_STANDING) continue;
			if(pNpc->m_bSummon == TRUE) continue;

			if(::InterlockedExchange(&pNpc->m_lNowSummoning, 1) != 0) continue;

			NpcState = pNpc->m_NpcState;
			pNpc->m_Delay = 2000;

			if(pNpc->m_NpcState == NPC_STANDING)
			{
				pNpc->SetUidNPC(pNpc->m_sCurX, pNpc->m_sCurY, 0);

				pNpc->m_presx = pNpc->m_presy = -1;
				pNpc->SendNpcInfoBySummon(m_pCom);
			}

			pNpc->m_SummonZoneIndex = pNpc->m_ZoneIndex;
			pNpc->m_sSummonOrgZ = pNpc->m_sOrgZ;
			pNpc->m_sSummonOrgX = pNpc->m_sOrgX;
			pNpc->m_sSummonOrgY = pNpc->m_sOrgY;

			pNpc->m_sCurZ = pNpc->m_sOrgZ = m_curz;
			pNpc->m_sCurX = pNpc->m_sOrgX = pt.x;
			pNpc->m_sCurY = pNpc->m_sOrgY = pt.y;

			pNpc->m_ZoneIndex		= -1;

			pNpc->m_dwStepDelay	= GetTickCount();
			
			sAI.i = (short)pNpc->m_sAI;						// NPC AI¸¦ ¼ÂÆÃ
			upTemp = sAI.b[0];
			dwTemp = sAI.b[1];
			
			pNpc->m_tNpcAttType = upTemp >> 7;				// ³ªÁß¿¡ Ãß°¡ÇØ¾ßÇÑ´Ù.
			upTemp = upTemp << 1;
			pNpc->m_tNpcLongType = upTemp >> 7;
			upTemp = upTemp << 1;
			pNpc->m_tNpcGroupType = upTemp >> 7;
			
			if(pNpc->m_sClientSpeed <= 20) pNpc->m_sClientSpeed = 20;	// ¹æ¾î ÄÚµå;
			
			for(i = 0; i < g_zone.GetSize(); i++)
			{
				if(g_zone[i]->m_Zone == pNpc->m_sCurZ) 
				{
					pNpc->m_ZoneIndex = i;
					break;
				}
			}

			pNpc->m_bSummon = TRUE;
			pNpc->m_bSummonDead = TRUE;
			pNpc->EventNpcInit(pt.x, pt.y);

			if(NpcState == NPC_STANDING) 
			{
				pNpc->SetUidNPC(pt.x, pt.y, pNpc->m_sNid + NPC_BAND);

				pNpc->m_presx = pNpc->m_presy = -1;
				pNpc->SightRecalc(m_pCom);
			}

			if(::InterlockedExchange(&pNpc->m_lNowSummoning, 0) != 1) pNpc->m_lNowSummoning = 0;

			strMsg.Format( IDS_USER_CALL_WHAT, pNpc->m_strName);
			SendSystemMsg((LPTSTR)(LPCTSTR)strMsg, SYSTEM_NORMAL, TO_ME);

			return TRUE;
		}
	}

	return FALSE;
}

int USER::GetItemIndex(int sid)
{
	int i = 0;
	int nCount = g_arItemTable.GetSize();

	for(i = 0; i < nCount; i++)
	{
		if(sid == g_arItemTable[i]->m_sSid) return i;
	}

	return -1;
}

void USER::SoftClose()
{
	CBSocket::B_SoftClose();
}

////////////////////////////////////////////////////////////////////////////////////////////////////
// Æ¯¼öÇÑ ¼Ò¸ð¼º ¹°¾àÀ» »ç¿ëÇÑ´Ù.
//
BYTE USER::UseSpecialPotion(short sSlot)
{
	CBufferEx TempBuf;
	short sSid = 0;
	BYTE tRet = 0;
	int j = 0;
    int hour = 0;
	int Damage = 0;	//ÓÃÓÚÈº¹¥ÉËº¦Öµ±äÁ¿
	
	if(sSlot < EQUIP_ITEM_NUM || sSlot >= TOTAL_INVEN_MAX) return FALSE;
	
	sSid = m_UserItem[sSlot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return FALSE;
	if(m_UserItem[sSlot].sCount <= 0) return FALSE;

	switch(sSid)
	{
	case SPECIAL_ITEM_HIEXP	:
		if( (m_dwHiExpTime + HIEXP_TIME) > 3600*48*1000)
		{
			SendSystemMsg("ÐË·Ü¼Á×î¸ßÀÛ¼Æ48Ð¡Ê±", SYSTEM_NORMAL, TO_ME);
			return false;
		}
		if(m_iDisplayType == 5 || m_iDisplayType ==6) //¹«·á »ç¿ëÀÚÀÎ°¡?
		{
			SendSystemMsg("¹«·á »ç¿ëÀÚ´Â ÇÏÀÌ¸¦ »ç¿ëÇÒ ¼ö ¾ø½À´Ï´Ù.", SYSTEM_NORMAL, TO_ME);
			return tRet; //or m_dwHiExpTime = 0; //¹«·á »ç¿ëÀÚ´Â »ç¿ëÇÒ ¼ö ¾ø´Ù.
		}
		else m_dwHiExpTime += HIEXP_TIME;
		//----------------------------------------------------------------------------------------
		m_dwLastHiExpTime = GetTickCount();
		tRet = EXP_POTION;

		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		AddAbnormalInfo(ABNORMAL_HIEXP);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);	
		Send(TempBuf, TempBuf.GetLength());

		break;

	case 1212	:
		if(m_dwHiExpTime !=0){
			SendSystemMsg("ÄãÏÖÔÚÒÑ¾­ÓÐÐË·Ü×´Ì¬,ÎÞ·¨ÔÙÊ¹ÓÃ³¬¼¶ÐË·Ü.", SYSTEM_NORMAL, TO_ME);
			return false;
		}
		if(m_iDisplayType == 5 || m_iDisplayType ==6) //¹«·á »ç¿ëÀÚÀÎ°¡?
		{
			SendSystemMsg("¹«·á »ç¿ëÀÚ´Â ÇÏÀÌ¸¦ »ç¿ëÇÒ ¼ö ¾ø½À´Ï´Ù.", SYSTEM_NORMAL, TO_ME);
			return tRet; //or m_dwHiExpTime = 0; //¹«·á »ç¿ëÀÚ´Â »ç¿ëÇÒ ¼ö ¾ø´Ù.
		}
		else m_dwHiExpTime = HIEXP_TIME72;
		//----------------------------------------------------------------------------------------
		m_dwLastHiExpTime = GetTickCount();
		tRet = EXP_POTION;

		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		AddAbnormalInfo(ABNORMAL_HIEXP);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);	
		Send(TempBuf, TempBuf.GetLength());

		break;

	case SPECIAL_ITEM_MAGICFIND :
		if( (m_dwMagicFindTime+ MAGICFIND_TIME) > 3600*48*1000 ){
			SendSystemMsg("ÐÒÔËÒ©×î¸ßÀÛ¼Æ48Ð¡Ê±", SYSTEM_NORMAL, TO_ME);
			return false;
		}
		if(m_iDisplayType == 5 || m_iDisplayType ==6) //¹«·á »ç¿ëÀÚÀÎ°¡?
		{
			SendSystemMsg("¹«·á »ç¿ëÀÚ´Â MagicFind¸¦ »ç¿ëÇÒ¼ö ¾ø½À´Ï´Ù.", SYSTEM_NORMAL, TO_ME);
			return tRet; //or m_dwMagicFindTime = 0; //¹«·á »ç¿ëÀÚ´Â »ç¿ëÇÒ ¼ö ¾ø´Ù.
		}
		else m_dwMagicFindTime += MAGICFIND_TIME;
		//-----------------------------------------------------------------------------------------
		m_dwLastMagicFindTime = GetTickCount();
		tRet = MAGIC_POTION;

		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		AddAbnormalInfo(ABNORMAL_MAGICFIND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		Send(TempBuf, TempBuf.GetLength());

		break;

	case 1568 :
		if(m_dwMagicFindTime !=0){
			SendSystemMsg("ÄãÏÖÔÚÒÑ¾­ÓÐÐÒÔË×´Ì¬,ÎÞ·¨ÔÙÊ¹ÓÃ³¬¼¶ÐÒÔË.", SYSTEM_NORMAL, TO_ME);
			return false;
		}
		if(m_iDisplayType == 5 || m_iDisplayType ==6) //¹«·á »ç¿ëÀÚÀÎ°¡?
		{
			SendSystemMsg("¹«·á »ç¿ëÀÚ´Â MagicFind¸¦ »ç¿ëÇÒ¼ö ¾ø½À´Ï´Ù.", SYSTEM_NORMAL, TO_ME);
			return tRet; //or m_dwMagicFindTime = 0; //¹«·á »ç¿ëÀÚ´Â »ç¿ëÇÒ ¼ö ¾ø´Ù.
		}
		else m_dwMagicFindTime = MAGICFIND_TIME72;
		//-----------------------------------------------------------------------------------------
		m_dwLastMagicFindTime = GetTickCount();
		tRet = MAGIC_POTION;

		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		AddAbnormalInfo(ABNORMAL_MAGICFIND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		Send(TempBuf, TempBuf.GetLength());

		break;

    /*case SPECIAL_ITEM_HX_LS: //»ÃÏëÁéÊ¯
		hour = m_dwHtExpTime/3600000;
		if(hour < 500)
		{
			m_dwHtExpTime += HIEXP_TIME_ONE;
			m_dwLastHtExpTime = GetTickCount();			
			SendDGDuration(1035,sSlot);
			TempBuf.Add(SET_USER_STATE);
			TempBuf.Add(m_uid + USER_BAND);
			AddStateInfo(STATE_5);
			TempBuf.Add(m_dwAbnormalInfo);
			TempBuf.Add(m_dwAbnormalInfo_);					
			Send(TempBuf, TempBuf.GetLength());		
		}
		break;
	case SPECIAL_ITEM_HX_JS: //»ÃÏë¾§Ê¯
		hour = m_dwMagicFtTime/3600000;
		if(hour < 500)
		{
			m_dwMagicFtTime += HIEXP_TIME_ONE;
			m_dwLastMagicFtTime = GetTickCount();			
			SendDGDuration(1289,sSlot);
			TempBuf.Add(SET_USER_STATE);
			TempBuf.Add(m_uid + USER_BAND);
			AddStateInfo(STATE_28);			
			TempBuf.Add(m_dwAbnormalInfo);
			TempBuf.Add(m_dwAbnormalInfo_);					
			Send(TempBuf, TempBuf.GetLength());		
		}
		break;*/
		case SPECIAL_ITEM_HX_LS: //»ÃÁé
			if (m_dwHtExpTime != 0)
			{
				SendSystemMsg("ÄúÒÑ¾­Ê¹ÓÃÁË»ÃÏëÁéÊ¯,ÎÞÐèÖØ¸´Ê¹ÓÃ",SYSTEM_NPC,TO_ME);
			}
			else
			{
				SendSystemMsg("»¶Ó­ÄúÊ¹ÓÃ»ÃÏëÁéÊ¯,ÄúµÄÎäÆ÷¸ÄÊý+1£¡",SYSTEM_NPC,TO_ME);
				m_dwHtExpTime += HIEXP_TIME_ONE;
				m_dwLastHtExpTime = GetTickCount();
				SendUserStatusSkill();
				SendDGDuration(1035,sSlot);
				TempBuf.Add(SET_USER_STATE);
				TempBuf.Add(m_uid + USER_BAND);
				AddStateInfo(STATE_5);
				TempBuf.Add(m_dwAbnormalInfo);
				TempBuf.Add(m_dwAbnormalInfo_);					
				Send(TempBuf, TempBuf.GetLength());		
			}
			break;
  case SPECIAL_ITEM_HX_JS: //»ÃÏë¾§Ê¯ ºÍ³¬¼¶ÐÒÔË×÷ÓÃ
		
		if (m_dwMagicFtTime > 0)
		{
			SendSystemMsg("ÄúÒÑ¾­Ê¹ÓÃÁË»ÃÏë¾§Ê¯,ÎÞÐèÖØ¸´Ê¹ÓÃ",SYSTEM_NPC,TO_ME);
		}
		else
		{
			SendSystemMsg("»¶Ó­ÄúÊ¹ÓÃ»ÃÏë¾§Ê¯,ÄúµÄ×°±¸¸ÄÊý+1£¡",SYSTEM_NPC,TO_ME);
			m_dwMagicFtTime += HIEXP_TIME_ONE;
			m_dwLastMagicFtTime = GetTickCount();	
			SendUserStatusSkill();
			SendDGDuration(1289,sSlot);
			TempBuf.Add(SET_USER_STATE);
			TempBuf.Add(m_uid + USER_BAND);
			AddStateInfo(STATE_28);			
			TempBuf.Add(m_dwAbnormalInfo);
			TempBuf.Add(m_dwAbnormalInfo_);					
			Send(TempBuf, TempBuf.GetLength());	
		}
		break;
/////////////////////////////////////////////////////////////////////////////
//ÎïÆ·¡ª¡ª>ÊØ»¤ÌìÊ¹
	case SPECIAL_ITEM_TS: 
	    {
			if(m_dwShTsTime > 0)
			{	SendSystemMsg("ÄãÏÖÔÚÒÑÓÐÊØ»¤ÌìÊ¹×´Ì¬,ÎÞ·¨ÔÙÊ¹ÓÃÊØ»¤ÌìÊ¹.", SYSTEM_NORMAL, TO_ME);	}
			else
			{
				if(m_dwShTsTime == 0)
				{
                 m_dwShTsTime=SHTS_TIME;			
	             m_dwShTsLaseTime=GetTickCount();
	             TempBuf.Add(SET_USER_STATE);
				 TempBuf.Add(m_dwAbnormalInfo);
	             TempBuf.Add(m_dwAbnormalInfo_);
                 FreedomCB();
	             Send(TempBuf, TempBuf.GetLength());
	             SendMyInfo( TO_INSIGHT, INFO_MODIFY );
				 SendSystemMsg("Ê¹ÓÃ³É¹¦!»ñµÃ24Ð¡Ê±ÊØ»¤ÌìÊ¹×´Ì¬.", SYSTEM_NORMAL, TO_ME);
	             tRet = SERVER_ARK_WINNER;
	            }
			}
		} 
		break;
/////////////////////////////////////////////////////////////////////////////
//ÎïÆ·¡ª¡ª>VIP10Ìì¿¨240Ð¡Ê±
	case 1560:	
		{
			if(m_dwZaiXianTime > 0)
			{	SendSystemMsg("ÄúÄ¿Ç°ÒÑÊÇVIP,Çëµ½ÆÚºóÔÙ²¹³ä!", SYSTEM_NORMAL, TO_ME);	} //Äê¿¨
			else
			{
                   // m_dwGuarDianTianShi = 3600 * 24 * 1000;
					m_dwZaiXianTime = 7;
					m_dwPD = 7;
					//SetXingfen();//3±¶ÐË·ÜÍ¼±ê
				    //SetXingYun();//3±¶ÐÒÔËÍ¼±ê
					//FreedomCB();//ÊØ»¤ÌìÊ¹
					SendSystemMsg("ÄúÒÑ³ÉÎªÖÜ¿¨»áÔ±", SYSTEM_NORMAL, TO_ME);
					
					CString str;
	                str.Format("¹§Ï²!Íæ¼Ò[ %s ]Ê¹ÓÃ[ÖÜ¿¨»áÔ±]³ÉÎªVIPÓÃ»§!",m_strUserID);
	                SendSystemMsg(str.GetBuffer(str.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);

					CBufferEx TempBuf;
					TempBuf.Add(SET_USER_STATE);
				   // AddStateInfo(STATE_31);
					//AddAbnormalInfo(ABNORMAL_VIP);
					TempBuf.Add(m_uid + USER_BAND);
					TempBuf.Add(m_dwAbnormalInfo);
					TempBuf.Add(m_dwAbnormalInfo_);				
					Send(TempBuf, TempBuf.GetLength());
					SendInsight(TempBuf, TempBuf.GetLength());
					tRet = 14;
					SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢
	                SendUserStatusSkill();					// ·¢ËÍÓÃ»§ÊôÐÔÊý¾Ý
                    CheckMagicItemMove();
	
                    TCHAR strOP[1024]; ZeroMemory(strOP,sizeof(strOP));//´æ´¢¼ÇÂ¼
					SYSTEMTIME time;
		            GetLocalTime(&time);
					sprintf(strOP,"ÔÚ%d-%d-%d %d:%d·ÖÊ¹ÓÃÖÜ¿¨",time.wYear,time.wMonth,time.wDay ,time.wHour,time.wMinute);
					WriteOpratorLog(strOP,CHAT_LOG);
			}
		} 
		break;

			case 1561:	
        {
			if(m_dwZaiXianTime > 0)
			{	SendSystemMsg("ÄúÄ¿Ç°ÒÑÊÇVIP,Çëµ½ÆÚºóÔÙ²¹³ä!", SYSTEM_NORMAL, TO_ME);	}
			else
			{
                    //m_dwGuarDianTianShi = 3600 * 72 * 1000;
					m_dwZaiXianTime = 30;
					m_dwPD = 30;
					//SetXingfen();//3±¶ÐË·ÜÍ¼±ê
				 //   SetXingYun();//3±¶ÐÒÔËÍ¼±ê
					//FreedomCB();//ÊØ»¤ÌìÊ¹
					SendSystemMsg("ÄúÒÑ³ÉÎªÔÂ¿¨»áÔ±", SYSTEM_NORMAL, TO_ME);
					
					CString str;
	                str.Format("¹§Ï²!Íæ¼Ò[ %s ]Ê¹ÓÃ[ÔÂ¿¨»áÔ±]³ÉÎªVIPÓÃ»§!",m_strUserID);
	                SendSystemMsg(str.GetBuffer(str.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);

					CBufferEx TempBuf;
					TempBuf.Add(SET_USER_STATE);
				    //AddStateInfo(STATE_31);
					//AddAbnormalInfo(ABNORMAL_VIP);
					TempBuf.Add(m_uid + USER_BAND);
					TempBuf.Add(m_dwAbnormalInfo);
					TempBuf.Add(m_dwAbnormalInfo_);				
					Send(TempBuf, TempBuf.GetLength());
					SendInsight(TempBuf, TempBuf.GetLength());
					tRet = 14;
					SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢
	                SendUserStatusSkill();					// ·¢ËÍÓÃ»§ÊôÐÔÊý¾Ý
                    CheckMagicItemMove();

                    TCHAR strOP[1024]; ZeroMemory(strOP,sizeof(strOP));//´æ´¢¼ÇÂ¼
					SYSTEMTIME time;
		            GetLocalTime(&time);
					sprintf(strOP,"ÔÚ%d-%d-%d %d:%d·ÖÊ¹ÓÃÔÂ¿¨",time.wYear,time.wMonth,time.wDay ,time.wHour,time.wMinute);
					WriteOpratorLog(strOP,CHAT_LOG);
			}
		} 
		break;
			case 1562:	
        {
			if(m_dwZaiXianTime > 0)
			{	SendSystemMsg("ÄúÄ¿Ç°ÒÑÊÇVIP,Çëµ½ÆÚºóÔÙ²¹³ä!", SYSTEM_NORMAL, TO_ME);	}
			else
			{
                   // m_dwGuarDianTianShi = 3600 * 240 * 1000;
					m_dwZaiXianTime = 365;
					m_dwPD = 365;
					//SetXingfen();//3±¶ÐË·ÜÍ¼±ê
				 //   SetXingYun();//3±¶ÐÒÔËÍ¼±ê
					//FreedomCB();//ÊØ»¤ÌìÊ¹
					SendSystemMsg("ÄúÒÑ³ÉÎªÄê¿¨»áÔ±", SYSTEM_NORMAL, TO_ME);
					
					CString str;
	                str.Format("¹§Ï²!Íæ¼Ò[ %s ]Ê¹ÓÃ[Äê¿¨»áÔ±]³ÉÎªVIPÓÃ»§!",m_strUserID);
	                SendSystemMsg(str.GetBuffer(str.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);

					CBufferEx TempBuf;
					TempBuf.Add(SET_USER_STATE);
				    //AddStateInfo(STATE_31);
					//AddAbnormalInfo(ABNORMAL_VIP);
					TempBuf.Add(m_uid + USER_BAND);
					TempBuf.Add(m_dwAbnormalInfo);
					TempBuf.Add(m_dwAbnormalInfo_);				
					Send(TempBuf, TempBuf.GetLength());
					SendInsight(TempBuf, TempBuf.GetLength());
					tRet = 14;
					SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢
	                SendUserStatusSkill();					// ·¢ËÍÓÃ»§ÊôÐÔÊý¾Ý
                    CheckMagicItemMove();

                    TCHAR strOP[1024]; ZeroMemory(strOP,sizeof(strOP));//´æ´¢¼ÇÂ¼
					SYSTEMTIME time;
		            GetLocalTime(&time);
					sprintf(strOP,"ÔÚ%d-%d-%d %d:%d·ÖÊ¹ÓÃÄê¿¨",time.wYear,time.wMonth,time.wDay ,time.wHour,time.wMinute);
					WriteOpratorLog(strOP,CHAT_LOG);
			}
		} 
		break;
				case 1563:	
        {
			if(m_dwZaiXianTime > 0)
			{	SendSystemMsg("ÄúÄ¿Ç°ÒÑÊÇVIP,Çëµ½ÆÚºóÔÙ²¹³ä!", SYSTEM_NORMAL, TO_ME);	}
			else
			{
                   // m_dwGuarDianTianShi = 3600 * 240 * 1000;
					m_dwZaiXianTime = 9999;
					m_dwPD = 9999;
					//SetXingfen();//3±¶ÐË·ÜÍ¼±ê
				 //   SetXingYun();//3±¶ÐÒÔËÍ¼±ê
					//FreedomCB();//ÊØ»¤ÌìÊ¹
					SendSystemMsg("ÄúÒÑ³ÉÎªÖÕÉú»áÔ±", SYSTEM_NORMAL, TO_ME);
					
					CString str;
	                str.Format("¹§Ï²!Íæ¼Ò[ %s ]Ê¹ÓÃ[ÖÕÉí»áÔ±¿¨¿¨]³ÉÎªVIPÓÃ»§!",m_strUserID);
	                SendSystemMsg(str.GetBuffer(str.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);

					CBufferEx TempBuf;
					TempBuf.Add(SET_USER_STATE);
				    //AddStateInfo(STATE_31);
					//AddAbnormalInfo(ABNORMAL_VIP);
					TempBuf.Add(m_uid + USER_BAND);
					TempBuf.Add(m_dwAbnormalInfo);
					TempBuf.Add(m_dwAbnormalInfo_);				
					Send(TempBuf, TempBuf.GetLength());
					SendInsight(TempBuf, TempBuf.GetLength());
					tRet = 14;
					SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢
	                SendUserStatusSkill();					// ·¢ËÍÓÃ»§ÊôÐÔÊý¾Ý
                    CheckMagicItemMove();

                    TCHAR strOP[1024]; ZeroMemory(strOP,sizeof(strOP));//´æ´¢¼ÇÂ¼
					SYSTEMTIME time;
		            GetLocalTime(&time);
					sprintf(strOP,"ÔÚ%d-%d-%d %d:%d·ÖÊ¹ÓÃÖÕÉú¿¨",time.wYear,time.wMonth,time.wDay ,time.wHour,time.wMinute);
					WriteOpratorLog(strOP,CHAT_LOG);
			}
		} 
		break;

   case SPECIAL_ITEM_KILLREMOVE :	// kill count¸¦ ÇÏ³ª ÁÙ¿©ÁØ´Ù.
		m_iCityValue=m_iCityValue+1000;
		GetCityRank();
		if(m_sKillCount > 0){
			m_sKillCount -= 1;
			if( m_sKillCount < 0 ) m_sKillCount = 0;
		}
		tRet = KILLREMOVE_POTION;
		break;
	case EVENTITEM_SID_MOON: //ÀÏÍ·
		if(m_dwAdamantineTime != 0 || m_dwMightyWeaponTime != 0 )
		{
			return FALSE;
		}
		SetBerserker(60 * 5);
		tRet = 19;
		break;
	case 1280: //Éñ¼£±¦Ê¯(·âÓ¡)
		{
		 int iNum = -1;
		 ItemList TempItem;
	     iNum = GetSameItem(TempItem, INVENTORY_SLOT);
		 iNum = GetEmptySlot(INVENTORY_SLOT);
		 if(iNum < 1)						
		 {

		    SendSystemMsg("°ü¹ü¿Õ¼äÂúÁË,ÇëÖÁÉÙÁô1¸ö¿Õ¼ä½â·â!", SYSTEM_ERROR, TO_ME);
		 }else 
		 {
			 int iRandom = 0;
			 iRandom = myrand(1, 7);
			 switch(iRandom)
			 {
			 case 1: 
				 GiveAllItem(1287, 1, 0, 2, 162, 0, 0, 0, 0);//15Á¦
				 break;
			 case 2: 
				 GiveAllItem(1287, 1, 0, 2, 156, 0, 0, 0, 0);//15ÌåÖÊ
				 break;
			 case 3: 
				 GiveAllItem(1287, 1, 0, 2, 158, 0, 0, 0, 0);//15Ãô½Ý
				 break;
			 case 4: 
				 GiveAllItem(1287, 1, 0, 2, 164, 0, 0, 0, 0);//15ÖÇ»Û
				 break;
			 case 5:
				 GiveAllItem(1287, 1, 0, 2, 166, 0, 0, 0, 0);//15ÖÇÁ¦
				 break;
			 case 6: 
				 GiveAllItem(1287, 1, 0, 2, 190, 0, 0, 0, 0);//50¿¹
				 break;
			 case 7: 
				 GiveAllItem(1287, 1, 0, 2, 193, 0, 0, 0, 0);//150Ñª
				 break;
			
			 default:
		           return FALSE;
			 }
			 tRet = 18;
		  }	
		}
		 break;
		 /////////////////////
	//	case 998:
	//	if( FindItem( 998) >= 1 )
	//	{
	//		RobItem( 998, 1 );
	//		GiveItem( 724, 10 );
	  //      tRet = 17;
	//	}
	//	break;
	
		 //////////////////
	case 1110: //±¦Ïä ¹§Ï²·¢²Æ
		{
	
          int iNum = -1;
		  ItemList TempItem;
	      iNum = GetSameItem(TempItem, INVENTORY_SLOT);
		  if( m_sLevel >= 70)
		  {
		 
            if(iNum == -1)							
		    { 
			  iNum = GetEmptySlot(INVENTORY_SLOT);
			  if(iNum < 1)						
		      {

		    		SendSystemMsg("°ü¹ü¿Õ¼äÂúÁË,ÇëÖÁÉÙÁô1¸ö¿Õ¼ä¿ª±¦Ïä!", SYSTEM_ERROR, TO_ME);
			  }

			/*  	int iRandom = myrand(0, 100);	
				if(iRandom > 50 && iRandom < 53)  
				{
					GiveItemAll(443,1,10,0,0,0,0,0,0,0,0,0,0);
				}else if(iRandom > 55 && iRandom < 58)
				{
					GiveItemAll(643,1,10,0,0,0,0,0,0,0,0,0,0);
				}else { */

			       RandChouJiang();
			       tRet = 18;
			 }
		  }
		
		else{
                SendSystemMsg("ÄúµÈ¼¶²»×ã70,ÎÞ·¨¿ªÆô!", SYSTEM_ERROR, TO_ME);
				return FALSE;
		    }
		}
        break;
		//////////////////////////////////////////////
		
		case 938://×°±¸´ò°ü         //wear 116
	   {
		//================================================================================Ê×ÏÈ¼ì²âÉíÉÏ


		 bool bHaveItem = false;
		//ÉíÉÏÊÇ·ñÓÐ×°±¸
		for( int i = 0;i<10;i++)
		{
			if(m_UserItem[i].sSid != -1)
			{
				bHaveItem = true;
				break;
			}
		}
		if(bHaveItem)
		{
			SendEventMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ×°±¸Ê×ÊÎ");
			return FALSE ;
		}
		//ÉíÉÏÊÇ·ñÓÐ×°±¸
		for( int i = 34;i<40;i++)
		{
			if(m_UserItem[i].sSid != -1)
			{
				bHaveItem = true;
				break;
			}
		}
		if(bHaveItem)
		{
			SendEventMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ»úÐµÊØ»¤");
			return FALSE ;
		}
		if (o_yehuoini[0]->neice != 1) return FALSE ;
        //=============================================================================================
	     if (m_byClass==0)
	    {
		 // Î»ÖÃ ±àºÅ ÊýÁ¿ ÑÕÉ« ¸ÄÊý ÊôÐÔ0 ÊôÐÔ1 ÊôÐÔ2 ÊôÐÔ3 ÊôÐÔ4
		GiveNewerItem( 4 ,514, 1, 3, 10, 145, 137, 113, 128, 0 );//Ö÷ÎäÆ÷
		GiveNewerItem( 5 ,1, 1, 3, 0, 158, 158, 162, 162, 0 );//¸±ÎäÆ÷
		GiveNewerItem( 0 ,1056, 1, 12, 10, 135, 135, 107, 107, 107 );//Í·¿ø
		GiveNewerItem( 9 ,1092, 1, 12, 10, 135, 135, 107, 107, 107 );//Ð¬×Ó
		GiveNewerItem( 1 ,1060, 1, 12, 10, 135, 135, 107, 107, 107 );//ÒÂ·þ
		GiveNewerItem( 8 ,1064, 1, 12, 10, 135, 135, 107, 107, 107 );//¿ã×Ó
        GiveNewerItem( 2 ,704, 1, 3, 8, 141, 49, 137, 1, 0 );//¶ú»·
		GiveNewerItem( 3 ,703, 1, 3, 8, 141, 49, 137, 1, 0 );//ÏîÁ´
		GiveNewerItem( 6 ,643, 1, 3, 8, 141, 49, 137, 1, 0 );//½äÖ¸1
		GiveNewerItem( 7 ,643, 1, 3, 8, 141, 49, 137, 1, 0 );//½äÖ¸2
        GiveNewerItem( 34 ,877, 1, 2,  0, 9, 16, 16, 16, 16 );//»úÐµÃ±×Ó
		GiveNewerItem( 35 ,884, 1, 2, 0, 8, 16, 16, 16, 16 );//»úÐµÒÂ·þ
		GiveNewerItem( 37 ,901, 1, 2, 0, 5, 16, 16, 16, 16 );//»úÐµ¿ã×Ó
		GiveNewerItem( 36 ,987, 1, 2, 0, 59, 16, 16, 16, 16 );//±ØÉ±
        GiveNewerItem( 38 ,961, 1, 9, 2, 30, 12, 18, 6, 0 );//666ÊØ»¤¼¼ÄÜ
        GiveNewerItemFinish();
		tRet = 17;
	   }else if (m_byClass==1){
	    // Î»ÖÃ ±àºÅ ÊýÁ¿ ÑÕÉ« ¸ÄÊý ÊôÐÔ0 ÊôÐÔ1 ÊôÐÔ2 ÊôÐÔ3 ÊôÐÔ4
		GiveNewerItem( 4 ,479, 1, 18, 10, 145, 145, 117, 117, 0 );//Ö÷ÎäÆ÷
		GiveNewerItem( 5 ,3, 1, 3, 0, 158, 158, 162, 162, 0 );//¸±ÎäÆ÷
		GiveNewerItem( 0 ,1056, 1, 12, 10, 110, 135, 110, 135, 110 );//Í·¿ø
		GiveNewerItem( 9 ,1092, 1, 12, 10, 110, 135, 110, 135, 110 );//Ð¬×Ó
		GiveNewerItem( 1 ,1068, 1, 12, 10, 110, 135, 110, 135, 110 );//ÒÂ·þ
		GiveNewerItem( 8 ,1072, 1, 12, 10, 110, 135, 110, 135, 110 );//¿ã×Ó
        GiveNewerItem( 2 ,704, 1, 3, 8, 141, 53, 137, 4, 0 );//¶ú»·
		GiveNewerItem( 3 ,703, 1, 3, 8, 141, 53, 137, 4, 0 );//ÏîÁ´
		GiveNewerItem( 6 ,643, 1, 3, 8, 141, 53, 137, 4, 0 );//½äÖ¸1
		GiveNewerItem( 7 ,643, 1, 3, 8, 141, 53, 137, 4, 0 );//½äÖ¸2
        GiveNewerItem( 34 ,877, 1, 2,  0, 14, 27, 27, 27, 27 );//»úÐµÃ±×Ó
		GiveNewerItem( 35 ,884, 1, 2, 0, 10, 27, 27, 27, 27  );//»úÐµÒÂ·þ
		GiveNewerItem( 37 ,901, 1, 2, 0, 5, 27, 27, 27, 27  );//»úÐµ¿ã×Ó
		GiveNewerItem( 36 ,987, 1, 2, 0, 59, 27, 27, 27, 27 );//±ØÉ±
        GiveNewerItem( 38 ,961, 1, 9, 2, 30, 12, 18, 6, 0 );//666ÊØ»¤¼¼ÄÜ
        GiveNewerItemFinish();
		tRet = 17;
		}else  if (m_byClass==2){
		 // Î»ÖÃ ±àºÅ ÊýÁ¿ ÑÕÉ« ¸ÄÊý ÊôÐÔ0 ÊôÐÔ1 ÊôÐÔ2 ÊôÐÔ3 ÊôÐÔ4
		GiveNewerItem( 4 ,443, 1, 18, 10, 145, 137, 120, 128, 0 );//Ö÷ÎäÆ÷
		GiveNewerItem( 5 ,7, 1, 3, 0, 158, 158, 162, 162, 0 );//¸±ÎäÆ÷
		GiveNewerItem( 0 ,1056, 1, 12, 10, 107, 135, 135, 107, 107 );//Í·¿ø
		GiveNewerItem( 9 ,1092, 1, 12, 10, 107, 135, 135, 107, 107 );//Ð¬×Ó
		GiveNewerItem( 1 ,1076, 1, 12, 10, 107, 135, 135, 107, 107 );//ÒÂ·þ
		GiveNewerItem( 8 ,1080, 1, 12, 10, 107, 135, 135, 107, 107 );//¿ã×Ó
        GiveNewerItem( 2 ,704, 1, 3, 8, 141, 56, 137, 1, 0 );//¶ú»·
		GiveNewerItem( 3 ,703, 1, 3, 8, 141, 56, 137, 1, 0 );//ÏîÁ´
		GiveNewerItem( 6 ,643, 1, 3, 8, 141, 56, 137, 1, 0 );//½äÖ¸1
		GiveNewerItem( 7 ,643, 1, 3, 8, 141, 56, 137, 1, 0 );//½äÖ¸2
        GiveNewerItem( 34 ,877, 1, 2,  0, 9, 16, 16, 16, 16 );//»úÐµÃ±×Ó
		GiveNewerItem( 35 ,884, 1, 2, 0, 8, 16, 16, 16, 16 );//»úÐµÒÂ·þ
		GiveNewerItem( 37 ,901, 1, 2, 0, 5, 16, 16, 16, 16 );//»úÐµ¿ã×Ó
		GiveNewerItem( 36 ,987, 1, 2, 0, 59, 16, 16, 16, 16 );//±ØÉ±
        GiveNewerItem( 38 ,961, 1, 9, 2, 30, 12, 18, 6, 0 );//666ÊØ»¤¼¼ÄÜ
        GiveNewerItemFinish();
		tRet = 17;
		}else  if (m_byClass==3){
		 // Î»ÖÃ ±àºÅ ÊýÁ¿ ÑÕÉ« ¸ÄÊý ÊôÐÔ0 ÊôÐÔ1 ÊôÐÔ2 ÊôÐÔ3 ÊôÐÔ4
		GiveNewerItem( 4 ,409, 1, 18, 10, 145, 137, 125, 128, 0 );//Ö÷ÎäÆ÷
		GiveNewerItem( 5 ,10, 1, 3, 0, 158, 158, 162, 162, 0 );//¸±ÎäÆ÷
		GiveNewerItem( 0 ,1056, 1, 12, 10, 109, 135, 135, 109, 109 );//Í·¿ø
		GiveNewerItem( 9 ,1092, 1, 12, 10, 109, 135, 135, 109, 109 );//Ð¬×Ó
		GiveNewerItem( 1 ,1084, 1, 12, 10, 109, 135, 135, 109, 109 );//ÒÂ·þ
		GiveNewerItem( 8 ,1088, 1, 12, 10, 109, 135, 135, 109, 109 );//¿ã×Ó
        GiveNewerItem( 2 ,704, 1, 3, 8, 141, 61, 137, 3, 0 );//¶ú»·
		GiveNewerItem( 3 ,703, 1, 3, 8, 141, 61, 137, 3, 0 );//ÏîÁ´
		GiveNewerItem( 6 ,643, 1, 3, 8, 141, 61, 137, 3, 0 );//½äÖ¸1
		GiveNewerItem( 7 ,643, 1, 3, 8, 141, 61, 137, 3, 0 );//½äÖ¸2
        GiveNewerItem( 34 ,877, 1, 2,  0, 9, 24, 24, 24, 24 );//»úÐµÃ±×Ó
		GiveNewerItem( 35 ,884, 1, 2, 0, 8, 24, 24, 24, 24 );//»úÐµÒÂ·þ
		GiveNewerItem( 37 ,901, 1, 2, 0, 5, 24, 24, 24, 24 );//»úÐµ¿ã×Ó
		GiveNewerItem( 36 ,987, 1, 2, 0, 59, 24, 24, 24, 24 );//±ØÉ±
        GiveNewerItem( 38 ,961, 1, 9, 2, 30, 12, 18, 6, 0 );//666ÊØ»¤¼¼ÄÜ
        GiveNewerItemFinish();
		tRet = 17;
		
		}
	  }
	     break;
			
		/////////////////////////////////////////////////////////////////////²âÊÔÒ²³É¹¦
		
	case 1299://ÐÞÀí»ú¼×1299
		{
			if(m_UserItem[39].sSid == 1184){
				m_UserItem[39].sBullNum = 10800;
//				m_UserItem[39].sDuration = 10;							
				SendCharData();
				SendMyInfo( TO_INSIGHT, INFO_MODIFY );	
				tRet = 17;
			}
			else{
				SendSystemMsg("±ØÐë×°ÖÃ³¬¼¶»ú¼×²ÅÄÜÊ¹ÓÃ!", SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}
		break;
	case 1182:   //Ê¹ÓÃ»ú¼×¿ñ±©Ò©Ë®
		{
			if(m_UserItem[39].sSid == 1184){
	//			m_UserItem[39].sBullNum = 10800;
				m_UserItem[39].sDuration = 10;							
				SendCharData();
				SendMyInfo( TO_INSIGHT, INFO_MODIFY );	
				tRet = 19;
			}
			else{
				SendSystemMsg("×°ÖÃÁË³¬¼¶»ú¼×²ÅÄÜÊ¹ÓÃ.", SYSTEM_ERROR, TO_ME);
				return FALSE;
			    }
		   }
		   break;
		
	case 1304:
		{			
			if(m_UserItem[39].sSid != 1184)
			{
				SendSystemMsg("±ØÐë×°ÖÃ³¬¼¶»ú¼×,²ÅÄÜÉý¼¶¿ØÖÆÏµÍ³!", SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
			CBufferEx TempBuf;
			TempBuf.Add((BYTE)236);
			TempBuf.Add((BYTE)1);		
			Send(TempBuf, TempBuf.GetLength());
		  }
		  break;
	case SPECIAL_ITEM1441:
		{
			if((m_dwShopPingDN + 20) < 21000000000)
			{
			//	GiveShopPingDN(20);
				tRet = 13;
				SendSystemMsg("Ê¹ÓÃÔª±¦È¯»ñµÃ20Ôª±¦!", SYSTEM_NORMAL, TO_ME);
			//	SendUserStatusSkill();
			}
		}
		break;
	case SPECIAL_ITEM1442:
		{
			if((m_dwShopPingDN + 50) < 21000000000)
			{
		//		GiveShopPingDN(50);
				tRet = 13;
				SendSystemMsg("Ê¹ÓÃÔª±¦È¯»ñµÃ50Ôª±¦!", SYSTEM_NORMAL, TO_ME);
			//	SendUserStatusSkill();
			}
		}
		break;
	case SPECIAL_ITEM1443:
		{
			if((m_dwShopPingDN + 100) < 21000000000)
			{
		//		GiveShopPingDN(100);
				tRet = 13;
				SendSystemMsg("Ê¹ÓÃÔª±¦È¯»ñµÃ100Ôª±¦!", SYSTEM_NORMAL, TO_ME);
			//	SendUserStatusSkill();
			}
		}
		break;
	case SPECIAL_ITEM1444:
		{
		  if(g_Shop.m_QanBao_KG == 1)
          {
			if((m_dwShopPingDN + 500) < 21000000000)
			{
		//		GiveShopPingDN(500);
				tRet = 13;
				SendSystemMsg("Ê¹ÓÃÔª±¦È¯»ñµÃ500Ôª±¦!", SYSTEM_NORMAL, TO_ME);
			//	SendUserStatusSkill();
			}
		   }
		}
		break;
	case SPECIAL_ITEM1445:
		{
		  if(g_Shop.m_QanBao_KG == 1)
          {
			if((m_dwShopPingDN + 4000) < 21000000000)
			{
		//		GiveShopPingDN(4000);
				tRet = 13;
				SendSystemMsg("Ê¹ÓÃÔª±¦È¯»ñµÃ4000Ôª±¦!", SYSTEM_NORMAL, TO_ME);
			//	SendUserStatusSkill();
			}
		  }
		}
		break;
	case 1019: //Ñò
		{
		if((m_dwDN + 1000000) < 21000000000)
			{
				GiveDN(1000000);
				tRet = 13;
				SendSystemMsg("Äú»ñµÃ100Íò¾öÕ½±Ò!", SYSTEM_NORMAL, TO_ME);
				
			}
		}
		break;
	case 1042:
	    sSid = m_UserItem[33].sSid;	
	    if(sSid != 1053 && sSid != 1089 && sSid != 1054 && sSid != 1055 && sSid != 1056 && sSid != 1090 && 
	    sSid != 1091 && sSid != 1092 && sSid != 1065 && sSid != 1066 && sSid != 1067 && sSid != 1068 &&
	    sSid != 1057 && sSid != 1058 && sSid != 1059 && sSid != 1060 && sSid != 1069 && sSid != 1070 &&
	    sSid != 1071 && sSid != 1072 && sSid != 1061 && sSid != 1062 && sSid != 1063 && sSid != 1064 &&
	    sSid != 1082 && sSid != 1083 && sSid != 1084 && sSid != 1073 && sSid != 1074 && sSid != 1075 &&
	    sSid != 1076 && sSid != 1085 && sSid != 1086 && sSid != 1087 && sSid != 1088 && sSid != 1077 &&
	    sSid != 1078 && sSid != 1079 && sSid != 1080 && sSid != 1081 && sSid != 1709 && sSid != 1710 &&
		sSid != 1711 && sSid != 1712 && sSid != 1713 && sSid != 1714 && sSid != 1715 && sSid != 1716|| sSid == -1)
	    {
        SendSystemMsg( "Çë°ÑÒª»¹Ô­µÄ°Ù¼¶×°±¸·Å±³°ü×îºóÒ»ÐÐ×îºóÒ»¸ñ", SYSTEM_ERROR, TO_ME);
		return FALSE;
	    }	
		HuanYuan100();
		tRet = SERVER_ARK_WINNER;
		break;
	case 1147:
	    sSid = m_UserItem[33].sSid;	
	    if(  (sSid != 1199 && sSid != 1200 && sSid != 1201 && sSid != 1202 &&
		 sSid != 1203 && sSid != 1204 && sSid != 1205 && sSid != 1206  &&
		 sSid != 1207 && sSid != 1208 && sSid != 1209 && sSid != 1210  &&
		 sSid != 1211 && sSid != 1212 && sSid != 1213 && sSid != 1214 ) || sSid == -1)
	    {
        SendSystemMsg( "Çë°ÑÒª»¹Ô­µÄ130¼¶×°±¸·Å±³°ü×îºóÒ»ÐÐ×îºóÒ»¸ñ", SYSTEM_ERROR, TO_ME);
		return FALSE;
	    }	
		HuanYuan130();
		tRet = SERVER_ARK_WINNER;
		break;
	case 1108: // super posion
		if( m_iCityValue >= 64000) return FALSE;
        m_sCityRank=5;
        m_sKillCount=0;
        m_iCityValue=64000;
		SendUserStatusSkill();

		tRet = KILLREMOVE_POTION;

		TempBuf.Add(SET_USER_PK_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.Add((BYTE)0x01);
		TempBuf.Add(m_sCityRank);
		SendInsight(TempBuf, TempBuf.GetLength());
		break;
	case 1109: // add XP posion
        m_dwXP += 10000;
		SendXP();
		tRet = KILLREMOVE_POTION;	
		break;

	//case 724: // ceshiba
	//	
	//	if( FindItem( 724) >= 1000  &&  FindItem( 724) <= 32000) 
	//	{
	//		if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE ) return FALSE; 
	//		int iSlot = -1;
	//	    iSlot = GetEmptySlot(INVENTORY_SLOT);
	//		if (FindItem( 725) <=0 )
	//		{
	//			if( iSlot == -1 )
	//			{
	//				SendEventMsg("ÄúÃ»ÓÐ×ã¹»µÄ¿Õ¼ä!");
	//				return FALSE; 
	//			}
	//		}
	//		RobItem( 724, 1000 );
	//		GiveItemAll(725,1,0,0,0,0,0,0,0,0,0,0,0);
	//		SendEventMsg("1000[ÆÕÍ¨±êÖ¾]ÒÑ×ª»»Îª[½ð±ê]!");
	//	}else
	//			SendEventMsg("ÊýÁ¿²»×ã1000,ÎÞ·¨×ª»»Îª½ð±ê!");
	//		
	//		break;

  case 725: //±êÖ¾×ª»»
	  {
		if( FindItem( 725) < 1)  return FALSE; 
		if (m_bLive == USER_DEAD) return FALSE;	//ËÀÍöÇëÇó	
		if (m_bNoItemMove == TRUE) return FALSE;		//ÎïÆ·ÒÆ¶¯ÇëÇó
	    if (m_bViewingAShop == TRUE) return FALSE;	//²é¿´ÉÌµêÇëÇó	
	    if (m_state != STATE_GAMESTARTED) return FALSE; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
	    if ( m_bZoneLogOut )return FALSE;
		if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE) return FALSE;

		int iSlot = -1;
	    iSlot = GetEmptySlot(INVENTORY_SLOT);
		if (FindItem( 724) <=0 )
		{
			if( iSlot == -1 )
			{
				SendEventMsg("ÄúÃ»ÓÐ×ã¹»µÄ¿Õ¼ä!");
				return FALSE; 
			}
		}
		if( FindItem( 724) + 1000  > 32000) 
		{
			SendEventMsg("³¬¹ý¿ÉÐ¯´øµÄ×î´ó±êÖ¾ÊýÁ¿!");
			return FALSE; 
		}
		
		RobItem( 725, 1 );
		GiveItemAll(724,1000,0,0,0,0,0,0,0,0,0,0,0);
		SendEventMsg("×ª»»³É¹¦,Äú»ñµÃ1000[ÆÕÍ¨±êÖ¾]!");
		break;
	  }
//===================================================================================

	case 1670: // ÕÙ»½ÒÁÍ¿ÂÞ½ºÄÒ
		{
          if(m_tHuFaType != 0)
				return FALSE;
			return CallHuFa(0x01);
		    break;
		}
    case 1671: // ÕÙ»½ÆÕÀ×Ëþ½ºÄÒ
		{
          if(m_tHuFaType != 0)
				return FALSE;
			return CallHuFa(0x02);
		    break;
		}
	case 1672: // ÕÙ»½¿ËÀÍË¹½ºÄÒ
		{
          if(m_tHuFaType != 0)
				return FALSE;
			return CallHuFa(0x03);
		    break;
		}
	case 1673: // ÕÙ»½ÒÁÎ÷Ë¹½ºÄÒ
		{
          if(m_tHuFaType != 0)
				return FALSE;
			return CallHuFa(0x04);
		    break;
		}
/*    case 1132:
		ZoneMoveReq(409,97,55);
		tRet = 17;
		break;*/
	case 1498: // ³èÎïËÇÁÏ²¹³ä->ÖÒ³Ï¶È
		{
          if(m_tBabyCall != 1) return FALSE;//Ã»ÓÐ³èÊÇ²»ÄÜÓÃµÄ
		  if(m_sFealty != 100)//ÖÒ³Ï¶È²»Âú
		  {
			//	if((m_sFealty + 1) < 101) m_sFealty += 1;
			//	SendEventMsg("Ê¹ÓÃËÇÁÏ,³èÎï[ÖÒ³Ï¶È]Ôö¼Ó[ 1 ]");
			     m_sFealty = 100;
				SendEventMsg("Ê¹ÓÃËÇÁÏ,³èÎï[ÖÒ³Ï¶È]²¹Âú!");
				SendBabyInfo();
		   }  
		   tRet = 17;
		    break;
		}
	case 1007:
		ZoneMoveReq(409,68,88);
		tRet = 17;
		break;
	case 1100:
		if (m_curz == 59) 	tRet = 19;
		break;
	case 1017:
		if( FindItem( 854) >= 1 )
		{
			RobItem( 854, 1 );
			GiveItem( 862, 2 );
		//	ZoneMoveReq(409,97,55);
			tRet = 17;
		}
		break;
/*	case 862:
		GiveItem( 1118, 1 );
		ZoneMoveReq(409,97,55);
		tRet = 17;
		break;
		*/
		
  /* //±äÉíÎïÆ·¡ª¡ª>ÀÇ±ä
	case SPECIAL_ITEM_BIANLANG:
		if(m_dwBFindTime > 0)
		{
			m_sDramageUp = true;					// ´ò¿ªÉËº¦Ìá¸ß
			BianShen(0);
			CheckMagicItemMove();
			tRet = SERVER_GUILD_INVITE;
		}
		break;*/
		//±äÉíÎïÆ·¡ª¡ª>ÀÇ±ä
	case SPECIAL_ITEM_BIANLANG:
       {
		if(m_dwBFindTime > 0)
		
			SendEventMsg("ÄúÒÑÊÇ±äÉí×´Ì¬,ÇëÎðÖØ¸´Ê¹ÓÃ!");
       else
			{
            m_sDramageUp = true;					// ´ò¿ªÉËº¦Ìá¸ß
			BianShen(0);
			CheckMagicItemMove();
			tRet = SERVER_GUILD_INVITE;
			SendEventMsg("10Ð¡Ê±ÄÚÉúÃüÔö¼Ó100,·ÀÓùÔö¼Ó15,Ä§¿¹Ôö¼Ó30,¹¥»÷Ôö¼Ó15,ÃüÖÐÔö¼Ó20!");
		    }
		}
		break;

		
/////////////////////////////////////////////////////////////////////////////
//±äÉíÎïÆ·¡ª¡ª>ÐÜ±ä
	case SPECIAL_ITEM_BIANXIONG:
		if(m_iSkin == 0)
		{
		//	m_sDramageUp = true;					// ´ò¿ªÉËº¦Ìá¸ß
		//	BianShen(2);
			CheckMagicItemMove();
			tRet = SERVER_GUILD_INVITE;
		}
		break;
	case 1016:  //»ÃÏë
		 
	  if(m_dwHXTime > 0)
	  {
		  SendEventMsg("Äúµ±Ç°ÒÑ¾­ÊÇ»ÃÏë×´Ì¬ÎÞ·¨ÖØ¸´Ê¹ÓÃ!");return FALSE; }

	  else   
	        {
			
		    m_dwHXTime = 3600*3*1000;
			m_dwLastHXTime = GetTickCount();
			CheckMagicItemMove();
			tRet = SERVER_ARK_WINNER;
			SendEventMsg("Äú»ñµÃ3Ð¡Ê±»ÃÏëÎäÆ÷Ê¹ÓÃÈ¨(²»Åå´÷»ÃÏëÎäÆ÷²»¼ÆÊ±)");
			}
	   break;
	   case 1742:  //á÷ÁÔÒ©Ë®
		 
	  if(m_dwSGTime > 0)
	  {
		  SendEventMsg("Äúµ±Ç°ÒÑÊÇá÷ÁÔÊ±¼äÎÞ·¨ÖØ¸´Ê¹ÓÃ!");return FALSE; 

	  
	  }else if(m_dwZaiXianTime > 0)
	  {
		   SendEventMsg("VIP»áÔ±ÒÑ»ñµÃá÷ÁÔÊ±¼ä!");return FALSE; 
	  }else{  
	        
		    m_dwSGTime = 3600*1*1000;	
			m_dwLastSGTime = GetTickCount();
			CheckMagicItemMove();
			tRet = 25;
			SendEventMsg("Äú»ñµÃ1Ð¡Ê±·è¿ñá÷ÁÔÊ±¼ä");
	  }
	   break;
	/*case 1015:
		if (m_sLevel >=105  && m_byClass == 1 && m_dwXP >=30000) 
		{

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == 30) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		m_UserPsi[m_nHavePsiNum].sSid = 30;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= 30000;

    	TempBuf.Add(BUY_PSY_RESULT);
	    TempBuf.Add((BYTE)1);
    	TempBuf.Add((short)1);
    	TempBuf.Add(30);
    	Send(TempBuf, TempBuf.GetLength());
        SendXP();

        tRet = 15;
		}
     	break;
		*/
	}


	return tRet;
}
void USER::JJSpeed() //¿ìËÙ±äÍâ¹Û
{
	if(m_UserItem[39].sSid == -1) return;
	if(m_UserItem[39].sSid == 1184)
	{
		if(m_UserItem[39].tMagic[7] == 7)//¼ì²â»ú¼×¸½¼þ2µÄÊôÐÔÎª7Ôò±äÉíÕ½Éñ
		{
			SendPsiAttackResult(SUCCESS, m_uid + USER_BAND, (BYTE)204);//Ôö¼Ó±äÉíÐ§¹û
			BianShen(8);		
		}else if (m_iSkin == 0)
        {
		   SendPsiAttackResult(SUCCESS, m_uid + USER_BAND, (BYTE)204);//Ôö¼Ó±äÉíÐ§¹û
		   BianShen(5);
	    }
	}
}
void USER::BianShen(int x)
{
	//HuanYuanBianShen();
	m_iSkin = x;							// ¸Ä±äÉíÌåÄ£ÐÍ
	if(m_UserItem[39].sSid == 1184 && x == 5){
		if(m_dwTransTime != 0) m_iHair = 10015;
		else
		{
			if(m_UserItem[39].tMagic[5] == 1) {
				m_iHair = 10001;
			}else if(m_UserItem[39].tMagic[5] == 2) {
				m_iHair = 10002;
			}
		}		
	}
//	TempBuf.Add(USE_POTION);		//ÇÐ»»»ú¼× ÏÔÊ¾Ð§¹û
//	TempBuf.Add(m_uid + USER_BAND);
//	TempBuf.Add((BYTE)16);
//	Send( TempBuf, TempBuf.GetLength() );
	UpdateUserData();						// ¸üÐÂÓÃ»§Êý¾Ý  neo°æ±¾
		switch(m_iSkin)
		{
		case 1:
			SetUserToMagicUser(2);
			break;
		case 2:
		case 4:
		case 7:
		case 8:
			SetUserToMagicUser(3);
			break;
		}
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	UpdateUserData();						// ¸üÐÂÓÃ»§Êý¾Ý		
	CheckMagicItemMove();
	m_dwBFindTime = BIANSHEN_TIME;
	m_dwLastBFindTime = GetTickCount();		
}
void USER::HuanYuanBianShen()    //¸üÐÂ±äÉíÊ±¼ä
{
	m_iHair = 0;
	m_iSkin = 0;	
	m_dwBFindTime = 0;
	CheckMagicItemMove();

	CBufferEx PotionBuf;
	PotionBuf.Add(USE_POTION);
	PotionBuf.Add(m_uid + USER_BAND);
	PotionBuf.Add(BIAN_SHEN);
	SendExactScreen( PotionBuf, PotionBuf.GetLength() );
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	DeleteAbnormalInfo(ABNORMAL_BIANSHEN);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());	
}
void USER::HuanYuanXf()    //¸üÐÂÐË·ÜÊ±¼ä
{
	
	m_dwHiExpTime = 0;
	CheckMagicItemMove();

	CBufferEx PotionBuf;
	PotionBuf.Add(USE_POTION);
	PotionBuf.Add(m_uid + USER_BAND);
	PotionBuf.Add(TEST_21);
	SendExactScreen( PotionBuf, PotionBuf.GetLength() );
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	DeleteAbnormalInfo(ABNORMAL_HIEXP);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());	
}

void USER::HuanYuanXy()    //¸üÐÂÐÒÔËÊ±¼ä
{
	
	m_dwMagicFindTime = 0;
	CheckMagicItemMove();

	CBufferEx PotionBuf;
	PotionBuf.Add(USE_POTION);
	PotionBuf.Add(m_uid + USER_BAND);
	PotionBuf.Add(TEST_21);
	SendExactScreen( PotionBuf, PotionBuf.GetLength() );
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	DeleteAbnormalInfo(ABNORMAL_MAGICFIND);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());	
}
void USER::HuanYuanFD()    //¸üÐÂÐÒ¸£Ê±¹â
{
	
	m_dwVIPTime = 0;
	CheckMagicItemMove();

	CBufferEx PotionBuf;
	PotionBuf.Add(USE_POTION);
	PotionBuf.Add(m_uid + USER_BAND);
	PotionBuf.Add(TEST_21);
	SendExactScreen( PotionBuf, PotionBuf.GetLength() );
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	DeleteAbnormalInfo(ABNORMAL_FUDAI);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());	
}
void USER::HuanYuanHl()    //¸üÐÂ»ÃÁéÊ±¼ä
{
	
	m_dwHtExpTime = 0;
	CheckMagicItemMove();

	CBufferEx PotionBuf;
	PotionBuf.Add(USE_POTION);
	PotionBuf.Add(m_uid + USER_BAND);
	PotionBuf.Add(TEST_21);
	SendExactScreen( PotionBuf, PotionBuf.GetLength() );
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	DeleteStateInfo(STATE_5);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());	
}
void USER::HuanYuanHj()    //¸üÐÂ»Ã¾§Ê±¼ä
{
	
	m_dwMagicFtTime = 0;
	CheckMagicItemMove();

	CBufferEx PotionBuf;
	PotionBuf.Add(USE_POTION);
	PotionBuf.Add(m_uid + USER_BAND);
	PotionBuf.Add(TEST_21);
	SendExactScreen( PotionBuf, PotionBuf.GetLength() );
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	DeleteStateInfo(STATE_28);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());	
}
void USER::HuanYuanVip()    //¸üÐÂVIPÊ±¼ä
{
	
	m_dwGuarDianTianShi = 0;
	CheckMagicItemMove();

	CBufferEx PotionBuf;
	PotionBuf.Add(USE_POTION);
	PotionBuf.Add(m_uid + USER_BAND);
	PotionBuf.Add(TEST_21);
	SendExactScreen( PotionBuf, PotionBuf.GetLength() );
	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢	
	DeleteAbnormalInfo(ABNORMAL_VIP);

	CBufferEx TempBuf;
	TempBuf.Add(SET_USER_STATE);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(m_dwAbnormalInfo);
	TempBuf.Add(m_dwAbnormalInfo_);
	Send(TempBuf, TempBuf.GetLength());	
}
/////////////////////////////////////////////////////////////////////////////////
//	¼Ò¸ð¼º ¾Ç¼¼»ç¸®ÀÇ ³»±¸µµ¸¦ º¸³½´Ù. ´Ù¾²¸é ³¯¸°´Ù.
//

void USER::SendAccessoriDuration(short sSid)
{
	BYTE tSlot = 0;
	int i;
	CBufferEx TempBuf;
	
	for(i = 0; i < MAX_ACCESSORI; i++)
	{
		tSlot = g_iAccessoriSlot[i];
		if(m_UserItem[tSlot].sSid == sSid)
		{
			m_UserItem[tSlot].sDuration--;
			if(m_UserItem[tSlot].sDuration <= 0) 
			{
				MakeItemLog( &m_UserItem[tSlot], ITEMLOG_ACC_USE );
				FlushItemLog( TRUE );
				
				ReSetItemSlot(&m_UserItem[tSlot]);
				
				TempBuf.Add(ITEM_MOVE_RESULT);
				TempBuf.Add(SUCCESS);
				TempBuf.Add((BYTE)0);		
				TempBuf.Add((BYTE)1);		// Count
				
				TempBuf.Add(tSlot);
				TempBuf.Add(m_UserItem[tSlot].sLevel);
				TempBuf.Add(m_UserItem[tSlot].sSid);
				TempBuf.Add(m_UserItem[tSlot].sDuration);
				TempBuf.Add(m_UserItem[tSlot].sBullNum);
				TempBuf.Add(m_UserItem[tSlot].sCount);
				for(i =0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tSlot].tMagic[i]);
				TempBuf.Add(m_UserItem[tSlot].tIQ); 
				
				Send(TempBuf, TempBuf.GetLength());				
			}
			else
			{
				TempBuf.Add(ITEM_DURATION);
				TempBuf.Add(tSlot);
				TempBuf.Add(m_UserItem[tSlot].sDuration);
				Send(TempBuf, TempBuf.GetLength());
			}

			return;
		}
	}
}
void USER::SendDGDuration(short sSid,int slot)
{
	int i = 0;
	BYTE tSlot = slot;
	CBufferEx TempBuf;
	if(m_UserItem[tSlot].sSid == sSid)
	{
		m_UserItem[tSlot].sDuration--;
		if(m_UserItem[tSlot].sDuration <= 0) 
		{
			MakeItemLog( &m_UserItem[tSlot], ITEMLOG_ACC_USE );
			FlushItemLog( TRUE );
				
			ReSetItemSlot(&m_UserItem[tSlot]);
				
			TempBuf.Add(ITEM_MOVE_RESULT);
			TempBuf.Add(SUCCESS);
			TempBuf.Add((BYTE)0);		// Type
			TempBuf.Add((BYTE)1);		// Count
			
			TempBuf.Add(tSlot);
			TempBuf.Add(m_UserItem[tSlot].sLevel);
			TempBuf.Add(m_UserItem[tSlot].sSid);
			TempBuf.Add(m_UserItem[tSlot].sDuration);
			TempBuf.Add(m_UserItem[tSlot].sBullNum);
			TempBuf.Add(m_UserItem[tSlot].sCount);
			for(i =0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tSlot].tMagic[i]);
			TempBuf.Add(m_UserItem[tSlot].tIQ); 
				
			Send(TempBuf, TempBuf.GetLength());				
		}
		else
		{
			TempBuf.Add(ITEM_DURATION);
			TempBuf.Add(tSlot);
			TempBuf.Add(m_UserItem[tSlot].sDuration);
			Send(TempBuf, TempBuf.GetLength());
		}
	}
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//	User ÀÇ ÀÌ¸§ÀÌ ÀÌ¹Ì Á¸ÀçÇÏ´ÂÁö Ã¼Å©ÇÑ´Ù.
//
void USER::CheckIDReq(TCHAR* pBuf)
{
	TCHAR szName[CHAR_NAME_LENGTH + 1];
	int nLen = 0;
	BYTE tResult = FAIL;
	int index = 0;
	CBufferEx TempBuf;

	::ZeroMemory(szName, sizeof(szName));
	nLen = GetVarString(sizeof(szName), szName, pBuf, index);
	if(nLen <= 0 || nLen > CHAR_NAME_LENGTH - 3) goto go_result;

	switch(m_iMyServer)
	{
	case	0:	// Å×½ºÆ®
		break;
	case	1:	// ÀÌÄ«·ç½º
		strcat( szName, "[I]" );
		break;
	case	2:	// ¿¤ÆÄµµ¸£
		strcat( szName, "[E]" );
		break;
	case	3:	// °¡³×Áö¾Æ
		strcat( szName, "[K]" );
		break;
	case	4:	// ÇÊ¸³Æ÷
		strcat( szName, "[F]" );
		break;
	case	5:	// ¾Æ½ºÆ®
		strcat( szName, "[A]" );
		break;
	case	6:	// ±×¶ûµð¿¡
		strcat( szName, "[G]" );
		break;
	case	7:	// Æä¼¼¿ì½º
		strcat( szName, "[P]" );
		break;
	case	8:	// ¹Ð¶óµð
		strcat( szName, "[M]" );
		break;
	case	9:	// ·çÀÌ³×Æ®
		strcat( szName, "[R]" );
		break;
	case	10:	// Å¸¸£»þ
		strcat( szName, "[T]" );
		break;
	default:
		return;
	}

	if(!IsExistCharId(szName)) tResult = SUCCESS;

go_result:

	TempBuf.Add(CHECK_ID_RESULT);
	TempBuf.Add(tResult);

	Send(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////////////////
//	»çÀÌ¿À´Ð ½Àµæ ±¸½½À» »ç¿ëÇÏ¿© »çÀÌ¿À´ÐÀ» ½ÀµæÇÑ´Ù.
//
BOOL USER::UsePsiStone(short sSlot)
{
	CBufferEx TempBuf;
	short sSid = 0;
	short sPsionicSid = 0;
	int j;

	if(sSlot < EQUIP_ITEM_NUM || sSlot >= TOTAL_INVEN_MAX) return FALSE;
	
	sSid = m_UserItem[sSlot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return FALSE;
	if(m_UserItem[sSlot].sCount <= 0) return FALSE;
	
	switch(sSid)
	{
	case PSI_STONE_FAST_RUN	:  //È­80¼¶¼¼ÄÜ
		if(m_byClass != BRAWL)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 80) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
// 		if(FindEvent(6) == FALSE) 
// 		{
// 			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
// 			return FALSE;
// 		}
		if(g_arPsiTable[PSIONIC_FAST_RUN]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_FAST_RUN) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_FAST_RUN;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_FAST_RUN]->m_iNeedXP;
		break;
   
	case PSI_STONE_BAO_YAN :		//È­ ±©Ñ×	
		if(m_byClass != BRAWL)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 50) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}
        if(g_arPsiTable[PSIONIC_BAO_YAN]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_BAO_YAN) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_BAO_YAN;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_BAO_YAN]->m_iNeedXP;
		break;

	case PSI_STONE_CHAO_FAN_TAN :		//È­ ³¬¼¶·´µ¯	
		if(m_byClass != BRAWL)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 135) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}
        if(g_arPsiTable[PSIONIC_CHAO_FAN_TAN]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_CHAO_FAN_TAN) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_CHAO_FAN_TAN;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_CHAO_FAN_TAN]->m_iNeedXP;
		break;
	
	case PSI_STONE_MIND_SHOCK :		//·¨ ÐÄÁé·ç±©			
		if(m_byClass != STAFF)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 80) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}

		if(g_arPsiTable[PSIONIC_MIND_SHOCK]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_MIND_SHOCK) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_MIND_SHOCK;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_MIND_SHOCK]->m_iNeedXP;
		break;

	case PSI_STONE_CHAO_YI_NENG :		//·¨ ³¬¼¶ÒìÄÜ			
		if(m_byClass != STAFF)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 135) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}

		if(g_arPsiTable[PSIONIC_CHAO_YI_NENG]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_CHAO_YI_NENG) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_CHAO_YI_NENG;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_CHAO_YI_NENG]->m_iNeedXP;
		break;

	case PSI_STONE_MIND_GUARD :					
		if(m_byClass != STAFF)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 90) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}
		if(g_arPsiTable[PSIONIC_MIND_GUARD]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_MIND_GUARD) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_MIND_GUARD;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_MIND_GUARD]->m_iNeedXP;
		break;

	case PSI_STONE_PSI_SHIELD :					
		if(m_byClass != EDGED)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 80) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}	

		if(g_arPsiTable[PSIONIC_PSI_SHIELD]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_PSI_SHIELD) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_PSI_SHIELD;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_PSI_SHIELD]->m_iNeedXP;
		break;

	case PSI_STONE_BA_QI :		//½£ î¸Æø	
		if(m_byClass != EDGED)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 50) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(g_arPsiTable[PSIONIC_BA_QI]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_BA_QI) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_BA_QI;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_BA_QI]->m_iNeedXP;
		break;

	case PSI_STONE_CHAO_FENG_LI :		//½£ ³¬¼¶·æÀû	
		if(m_byClass != EDGED)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 135) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(g_arPsiTable[PSIONIC_CHAO_FENG_LI]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_CHAO_FENG_LI) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_CHAO_FENG_LI;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_CHAO_FENG_LI]->m_iNeedXP;
		break;

	case PSI_STONE_CHONG_RAN :		//ÖØÈ¼	
/*		if(m_byClass != EDGED)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}*/
		if(m_sLevel < 50) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(g_arPsiTable[PSIONIC_CHONG_RAN]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_CHONG_RAN) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_CHONG_RAN;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_CHONG_RAN]->m_iNeedXP;
		break;

	case PSI_STONE_LI_HU_SHUO_LIAN :		//Áé»êËøÁ´
		if(m_byClass != JUDGE)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 80) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(g_arPsiTable[PSIONIC_LI_HU_SHUO_LIAN]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_LI_HU_SHUO_LIAN) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_LI_HU_SHUO_LIAN;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_LI_HU_SHUO_LIAN]->m_iNeedXP;
		break;
	
	case PSI_STONE_PIERCING_SHIELD :		//Ç¹ Á¦³¡´©´Ì	
		if(m_byClass != FIREARMS)
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 80) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}

		if(g_arPsiTable[PSIONIC_PIERCING_SHIELD]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_PIERCING_SHIELD) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_PIERCING_SHIELD;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_PIERCING_SHIELD]->m_iNeedXP;
		break;

	case PSI_STONE_CHAO_DUO_CHONG :		//Ç¹ºÍÖÙ²Ã ³¬¼¶¶àÖØ	
		if(m_byClass != FIREARMS && m_byClass != JUDGE)//²»ÊÇÇ¹ÐµÊ¦»òÖÙ²ÃÎÞ·¨Ñ§Ï°
		{
			SendSystemMsg(IDS_PSI_ERROR_CLASS, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
		if(m_sLevel < 135) 
		{
			SendSystemMsg(IDS_PSI_ERROR_LEVEL, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}
//		if(FindEvent(6) == FALSE) 
//		{
//			SendSystemMsg(IDS_NEED_QUEST, SYSTEM_ERROR, TO_ME);
//			return FALSE;
//		}

		if(g_arPsiTable[PSIONIC_CHAO_DUO_CHONG]->m_iNeedXP > m_dwXP)
		{
			SendSystemMsg(IDS_PSI_ERROR_XP, SYSTEM_ERROR, TO_ME);
			return FALSE;
		}

		for(j = 0; j < m_nHavePsiNum; j++)
		{
			if(m_UserPsi[j].sSid == PSIONIC_CHAO_DUO_CHONG) 
			{
				SendSystemMsg(IDS_PSI_ERROR_EXIST, SYSTEM_ERROR, TO_ME);
				return FALSE;
			}
		}

		sPsionicSid = m_UserPsi[m_nHavePsiNum].sSid = PSIONIC_CHAO_DUO_CHONG;
		m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
		m_nHavePsiNum++;
		m_dwXP -= g_arPsiTable[PSIONIC_CHAO_DUO_CHONG]->m_iNeedXP;
		break;
	}

	TempBuf.Add(BUY_PSY_RESULT);
	TempBuf.Add((BYTE)1);
	TempBuf.Add((short)1);
	TempBuf.Add(sPsionicSid);
	Send(TempBuf, TempBuf.GetLength());

	SendXP();

	return TRUE;
}

//////////////////////////////////////////////////////////////////////////////////
//	Quest Window ¸¦ ¿¬´Ù(À¯Àú°¡ °¡Áö°í ÀÖ´Â Äù½ºÆ® Á¤º¸¸¦ º¸³»ÁØ´Ù.)
//  CTRL+Q   ÈÎÎñÀ¸´ò¿ª
void USER::QuestWindowOpenReq(TCHAR *pBuf)
{
	CBufferEx TempBuf;
	int iCount = m_arEventNum.GetSize();

	if(iCount >= MAX_EVENT_NUM) iCount = MAX_EVENT_NUM;

	TempBuf.Add(QUESTWINDOW_OPEN_RESULT);

	TempBuf.Add((short)iCount);
	for( int i = 0; i < iCount; i++)
	{
		TempBuf.Add((short)(*m_arEventNum[i]));
	}

	Send(TempBuf, TempBuf.GetLength());
}

//////////////////////////////////////////////////////////////////////////////////
//	Quest say¸¦ º¸³½´Ù
//
void USER::SendMonsterSay(CNpc *pNpc, int iType, char *strSay)
{
	if( !pNpc ) return;
	if( strlen( strSay ) >= 128 ) return;
	
	CBufferEx TempBuf;

	TempBuf.Add(CHAT_RESULT);
	TempBuf.Add(SUCCESS);
	TempBuf.Add(NORMAL_CHAT);
	TempBuf.Add(pNpc->m_sNid + NPC_BAND);
	TempBuf.AddString(pNpc->m_strName);

	TempBuf.AddString((LPTSTR)(LPCTSTR)strSay);

	switch(iType)
	{
	case 0:
		Send(TempBuf, TempBuf.GetLength());
		break;
	case 1:
		SendExactScreen(TempBuf, TempBuf.GetLength());
		break;
	}
}

//////////////////////////////////////////////////////////////////////////////////
//	Quest ¸¦ ½ÇÇàÇÑ´Ù. (ÀÌº¥Æ® À¯Áö½Ã°£, ½Â¸®Á¶°Ç, ¸÷ SID, ¸¶¸®¼ö, Á¸, ...)
//
BOOL USER::ExcuteSingleQuestEvent(int time, int type, int sid, int count, int z, int x, int y)
{
	int iEvent = g_QuestEventZone.GetEmptyEventZone();

	if(iEvent < 0)
	{
		SendNpcSay( NULL, 513 );										// ½ÇÆÐ say
		return FALSE;													
	}

	g_QuestEventZone.m_SingleEventZone[iEvent].m_sEventZone = z;
	g_QuestEventZone.m_SingleEventZone[iEvent].m_tEventTime = time;		// ÀÌº¥Æ® ÁøÇà½Ã°£
	g_QuestEventZone.m_SingleEventZone[iEvent].m_tSuccessType = type;	// ½Â¸®Á¶°Ç

	g_QuestEventZone.m_SingleEventZone[iEvent].m_arUserList[0].uid = m_uid; // Âü°¡ À¯Àú 

	int nLen = strlen(m_strUserID);
	::CopyMemory(g_QuestEventZone.m_SingleEventZone[iEvent].m_arUserList[0].strUserName, m_strUserID, nLen);

	m_tQuestWar = GUILD_WARRING;
	 
	int iNid = -1;
	for(int i = 0; i < count; i++)
	{
		iNid = -1;
		iNid = SummonQuestMonster(sid, z, x, y);									// ¸÷ ¼ÒÈ¯
		if(iNid > -1) g_QuestEventZone.m_SingleEventZone[iEvent].m_arNpcList.Add(iNid);	// ÇØ´ç ¸÷
	}

	return TRUE;
}

//////////////////////////////////////////////////////////////////////////////////
//	Quest ¸÷À» Æ¯Á¤ ÁÂÇ¥·Î ¼ÒÈ¯ÇÑ´Ù.
//
int USER::SummonQuestMonster(int sid, int z, int x, int y)
{
	CNpc* pNpc = NULL;
	int i;

	MYSHORT sAI;
	BYTE upTemp = 0;			// »óÀ§ 8ºñÆ®
	BYTE dwTemp = 0;			// ÇÏÀ§ 8ºñÆ®

	CPoint pt;

	int NpcState = NPC_DEAD;

	for(i = 0; i < g_arNpc.GetSize(); i++)
	{
		pNpc = g_arNpc[i];
		if( !pNpc ) continue;
		if(pNpc->m_tNpcType != NPCTYPE_MONSTER) continue;

		if(pNpc->m_sSid == sid)
		{
			if(pNpc->m_sCurZ == 1005) continue;
			if(pNpc->m_NpcState != NPC_DEAD && pNpc->m_NpcState != NPC_STANDING) continue;
			if(pNpc->m_bSummon == TRUE) continue;

			if(::InterlockedExchange(&pNpc->m_lNowSummoning, 1) != 0) continue;

			NpcState = pNpc->m_NpcState;
			pNpc->m_Delay = 2000;

			if(pNpc->m_NpcState == NPC_STANDING)
			{
				pNpc->SetUidNPC(pNpc->m_sCurX, pNpc->m_sCurY, 0);

				pNpc->m_presx = pNpc->m_presy = -1;
				pNpc->SendNpcInfoBySummon(m_pCom);
			}

			pNpc->m_SummonZoneIndex = pNpc->m_ZoneIndex;
			pNpc->m_sSummonOrgZ = pNpc->m_sOrgZ;
			pNpc->m_sSummonOrgX = pNpc->m_sOrgX;
			pNpc->m_sSummonOrgY = pNpc->m_sOrgY;

			pNpc->m_sCurZ = pNpc->m_sOrgZ = z;
			pNpc->m_sCurX = pNpc->m_sOrgX = x;
			pNpc->m_sCurY = pNpc->m_sOrgY = y;

			pNpc->m_ZoneIndex		= -1;

			pNpc->m_dwStepDelay	= GetTickCount();
			
			sAI.i = (short)pNpc->m_sAI;						// NPC AI¸¦ ¼ÂÆÃ
			upTemp = sAI.b[0];
			dwTemp = sAI.b[1];
			
			pNpc->m_tNpcAttType = upTemp >> 7;				// ³ªÁß¿¡ Ãß°¡ÇØ¾ßÇÑ´Ù.
			upTemp = upTemp << 1;
			pNpc->m_tNpcLongType = upTemp >> 7;
			upTemp = upTemp << 1;
			pNpc->m_tNpcGroupType = upTemp >> 7;
			
			if(pNpc->m_sClientSpeed <= 20) pNpc->m_sClientSpeed = 20;	// ¹æ¾î ÄÚµå;
			
			for(i = 0; i < g_zone.GetSize(); i++)
			{
				if(g_zone[i]->m_Zone == pNpc->m_sCurZ) 
				{
					pNpc->m_ZoneIndex = i;
					break;
				}
			}

			pNpc->m_bSummon = TRUE;
			pNpc->m_bSummonDead = TRUE;
			pNpc->EventNpcInit(x, y);

			pt = pNpc->FindNearRandomPoint(x, y);
			if(pt.x < 0 || pt.y < 0)
			{
				pNpc->m_bFirstLive = FALSE;
				pNpc->m_NpcState = NPC_DEAD;
				pNpc->m_sHP = 0;
				pNpc->m_Delay = pNpc->m_sRegenTime;

				pNpc->m_bSummon = FALSE;
				pNpc->m_bSummonDead = TRUE;

				if(::InterlockedExchange(&pNpc->m_lNowSummoning, 0) != 1) pNpc->m_lNowSummoning = 0;
				return -1;
			}

			if(NpcState == NPC_STANDING) 
			{
				pNpc->m_sCurX = pNpc->m_sOrgX = pt.x;
				pNpc->m_sCurY = pNpc->m_sOrgY = pt.y;

				pNpc->SetUidNPC(pt.x, pt.y, pNpc->m_sNid + NPC_BAND);

				pNpc->m_presx = pNpc->m_presy = -1;
				pNpc->SightRecalc(m_pCom);
			}

			// ¼ÒÈ¯µÈ ¸÷Àº ¼ÒÈ¯µÈ ÁÂÇ¥¸¦ Áß½ÉÀ¸·Î Çàµ¿¹Ý°æÀ» °¡Áø´Ù.
			MAP* pMap = g_zone[pNpc->m_ZoneIndex];
			pNpc->m_nInitMinX = pNpc->m_sOrgX - pNpc->m_sMinX;		if(pNpc->m_nInitMinX < 1) pNpc->m_nInitMinX = 1; 
			pNpc->m_nInitMinY = pNpc->m_sOrgY - pNpc->m_sMinY;		if(pNpc->m_nInitMinY < 1) pNpc->m_nInitMinY = 1; 
			pNpc->m_nInitMaxX = pNpc->m_sOrgX + pNpc->m_sMaxX;		if(pNpc->m_nInitMaxX >= pMap->m_sizeMap.cx) pNpc->m_nInitMaxX = pMap->m_sizeMap.cx - 1;
			pNpc->m_nInitMaxY = pNpc->m_sOrgY + pNpc->m_sMaxY;		if(pNpc->m_nInitMaxY >= pMap->m_sizeMap.cy) pNpc->m_nInitMaxY = pMap->m_sizeMap.cy - 1;

			if(::InterlockedExchange(&pNpc->m_lNowSummoning, 0) != 1) pNpc->m_lNowSummoning = 0;

			return pNpc->m_sNid;
		}
	}

	return -1;
}

BOOL USER::CheckZoneWho(int zone, int passtype, int zonetype)
{
	int i;
	BOOL bCheck = FALSE;

	switch(zonetype)
	{
	case 1:		// 80·¾ »çÀÌ¿À´Ð °ü·Ã - ¸âÇÇ½º ºñ¹ÐÁöÇÏ¿¬±¸¼Ò ¸Ê ÀÌº¥Æ®		
		for(i = 0; i < MAX_SINGLE_EVENT; i++)
		{
			if(g_QuestEventZone.m_SingleEventZone[i].m_lUsed == 1)
			{
				if(g_QuestEventZone.m_SingleEventZone[i].m_sEventZone == zone) bCheck = TRUE;
			}
		}

		if(bCheck) // ÇØ´ç Á¸¿¡ »ç¶÷ÀÌ ÀÖ°í 
		{
			if(passtype == 1) return TRUE;	// Åë°ú Å¸ÀÔÀÌ 1ÀÌ¸é À¯Àú Åë°ú
		}
		else		// ÇØ´ç Á¸¿¡ À¯Àú°¡ ¾øÀ¸¸é
		{
			if(passtype == 0) return TRUE;	// Åë°ú Å¸ÀÔÀÌ 0ÀÌ¸é À¯Àú Åë°ú
		}
		break;

	default:
		break;
	}

	return FALSE;
}

void USER::SendCharDataToOPUser(USER *pUser)//·¢ËÍ½ÇÉ«×°±¸ÊôÐÔÐÅÏ¢
{
/*    if(!pUser) return;
	
	int i = 0;
    CBufferEx TempBuf;
    
    TempBuf.Add(CHAR_DATA);//Ö§³Ö¿´¶Ô·½ÊôÐÔÀ¸
    TempBuf.AddString(pUser->m_strUserID);
    TempBuf.Add(pUser->m_sMagicSTR);
    TempBuf.Add(pUser->m_sMagicCON);
    TempBuf.Add(pUser->m_sMagicDEX);
    TempBuf.Add(pUser->m_sMagicVOL);
    TempBuf.Add(pUser->m_sMagicWIS);

    TempBuf.Add((short)1);  // ÀÓ½Ã ÄÚµå 

    TempBuf.Add(pUser->m_iSkin);
    TempBuf.Add(pUser->m_iHair);
    TempBuf.Add((BYTE)pUser->m_sGender);
    TempBuf.AddData(pUser->m_strFace, 10);

    TempBuf.Add(pUser->m_dwExp);
    TempBuf.Add(pUser->m_dwXP);

    TempBuf.Add(pUser->m_sSkillPoint);
    TempBuf.Add(pUser->m_sPA);
    TempBuf.Add(pUser->m_sSkillPoint_);

    TempBuf.Add(pUser->m_sMagicMaxHP);
    TempBuf.Add(pUser->m_sHP);
    TempBuf.Add(pUser->m_sMagicMaxPP);
    TempBuf.Add(pUser->m_sPP);
    TempBuf.Add(pUser->m_sMagicMaxSP);
    TempBuf.Add(pUser->m_sSP);

    TempBuf.Add(pUser->m_dwDN);     
    TempBuf.Add(pUser->m_sCityRank);
	
    TempBuf.Add(pUser->m_sLevel);
    TempBuf.Add(pUser->m_byClass); 

    TCHAR strSkill[_SKILL_DB], strItem[_ITEM_DB], strPsi[_PSI_DB],strSkill_[12*3];
    ::ZeroMemory(strSkill, sizeof(strSkill));
    ::ZeroMemory(strItem, sizeof(strItem));
    ::ZeroMemory(strPsi, sizeof(strPsi));

    UserSkillToStr((LPTSTR)strSkill);
    pUser->UserItemToStrForSend( (LPTSTR)strItem );
    UserPsiToStr((LPTSTR)strPsi);
    //130SUPER SKILL
    int index=0;
    for(i = 0; i < 12; i++)
    {
    SetShort(strSkill_, m_UserSkill_[i].sSid,index);
    SetByte (strSkill_, m_UserSkill_[i].tLevel, index);
    }

    TempBuf.AddData(strSkill, USER_SKILL_LEN); // Skill
    TempBuf.AddData(strSkill_,12*3);

    TempBuf.Add((BYTE)m_nHavePsiNum); // Psionic
    if(m_nHavePsiNum > 0) TempBuf.AddData(strPsi, m_nHavePsiNum * _PSI_SIZE); 
    TempBuf.AddData(strItem, USER_ITEM_LEN); // Item

    TempBuf.Add(m_dwExpNext); // Next Exp 
    TempBuf.Add(m_dwAbnormalInfo); // »óÅÂÀÌ»ó Á¤º¸
    TempBuf.Add(m_dwAbnormalInfo_);

    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    // Finito added 12 bytes below
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0x00);

    TempBuf.Add((BYTE)0x01);
    TempBuf.Add((BYTE)0x01);
    TempBuf.Add((BYTE)0x01);
    TempBuf.Add((BYTE)0x01);

    TempBuf.Add((int)pUser->m_dwGuild); 
    TempBuf.AddString(m_strGuildName); 
    TempBuf.Add(m_sGuildVersion);
    if(m_dwGuild >= 1)
    {
 //   TempBuf.Add((BYTE)0xF4);
 //   TempBuf.Add((BYTE)0x02);
//    TempBuf.Add((BYTE)0x41);
    }
    else
    {
 //   TempBuf.Add((BYTE)0x00);
//    TempBuf.Add((BYTE)0x00);
 //   TempBuf.Add((BYTE)0x00);
    }
    TempBuf.Add((BYTE)0x02);
 //   TempBuf.Add((BYTE)0xFF);
//	TempBuf.Add((BYTE)0xFF);
//	TempBuf.Add((BYTE)0x00);
//	TempBuf.Add((BYTE)0x00);
    TempBuf.Add((BYTE)0xFF);
    TempBuf.Add((short)-1);//¿ª»úÀ¶ÁúÐÄ
    TempBuf.Add((BYTE)0x84); // Finito Added
    TempBuf.Add((BYTE)0x99); // Finito Added
    TempBuf.Add((BYTE)0x2c); // Finito Added
    TempBuf.Add((BYTE)0x02); // Finito Added

    CBufferEx TempBuf1;
    TempBuf1.Add( (short)(TempBuf.GetLength()) );
    TempBuf1.AddData( TempBuf, TempBuf.GetLength() );
    m_CompMng.FlushAddData();
    m_CompMng.AddData( TempBuf1, TempBuf1.GetLength() );
    m_CompMng.PreCompressWork();
    m_CompMng.Compress();
    int comp_data_len = m_CompMng.GetCompressedDataCount();
    int org_data_len = m_CompMng.GetUnCompressDataLength();
    DWORD crc_value = m_CompMng.GetCrcValue();
    CBufferEx SendBuf;
    SendBuf.Add( SIGHT_INFO_COMPRESSED );
    SendBuf.Add( (short)comp_data_len );
    SendBuf.Add( (short)org_data_len );
    SendBuf.Add( crc_value );
    SendBuf.Add( (short)1 );
    char* packet = m_CompMng.GetExtractedBufferPtr();
    SendBuf.AddData( packet, comp_data_len );
    TRACE( "%d -> %d\n", org_data_len, comp_data_len );
    SEND_DATA* pNewData = NULL;
    pNewData = new SEND_DATA;
    if(pNewData == NULL)
    {
    m_CompMng.FlushAddData();
    return;
    }
    pNewData->flag = SEND_USER;
    pNewData->len = SendBuf.GetLength();
    ::CopyMemory(pNewData->pBuf, SendBuf, SendBuf.GetLength());
    pNewData->uid = m_uid;
    m_pCom->Send(pNewData);
    if(pNewData) delete pNewData;
    m_CompMng.FlushAddData();*/
} 
/////////////////////////////////////////////////////////////////
//ÉÌµêÎïÆ·¹ºÂò¼ÇÂ¼
void USER::WriteOnlineShop_Log(CString strUname,CString osName,short price,short inum,short upg,short sx1,short sx2,short sx3,short sx4,short sx5,short sx6,short sx7,short sx8,short sx9,short sx10)
{
	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	TCHAR			szSQL[1024];		

	::ZeroMemory(szSQL, sizeof(szSQL));

	int index = 0;

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call INSERT_ONLINESHOP_LOG (\'%s\',\'%s\',%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d)}"), 
	strUname,osName,price,inum,upg,sx1,sx2,sx3,sx4,sx5,sx6,sx7,sx8,sx9,sx10); 

	int db_index = 0;
	CDatabase* pDB = g_DBNew[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode != SQL_SUCCESS)
		return;

	if (retcode == SQL_SUCCESS)
	{
		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
		}
	}
	
	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DBNew[m_iModSid].ReleaseDB(db_index);
}
//-------------------------------------------------------------------------
//yskang 0.4 ¿î¿µÀÚ ·Î±× ±â·Ï
//nOption 0:Á¢¼Ó¾ÆÀÌÇÇ 1:´ëÈ­ 2:¾ÆÀÌÅÛ Á¦°øÁ¤º¸ 3:PKÁ¤º¸
//-------------------------------------------------------------------------
void USER::WriteOpratorLog(TCHAR *strContents, int nOption)//yskang 0.4
{
//	if( m_tIsOP == 0 ) return;

	SQLHSTMT		hstmt = NULL;
	SQLRETURN		retcode = 0;
	TCHAR			szSQL[1024];	
	int				i;

	::ZeroMemory(szSQL, sizeof(szSQL));

	SDWORD sSLen = strlen(strContents);
	if(sSLen <= 0 || sSLen >= 200) return;

	_sntprintf(szSQL, sizeof(szSQL), TEXT("{call WRITE_OPERATOR_LOG(\'%s\', \'%s\',%d)}"), m_strUserID, strContents,nOption ); 

	int db_index = 0;
	CDatabase* pDB = g_DB[m_iModSid].GetDB( db_index );
	if( !pDB ) return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if (retcode == SQL_SUCCESS)
	{
		i = 1;
//		SQLBindParameter( hstmt, i++, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_VARBINARY, sizeof(strSentence), 0, (TCHAR*)strSentence, 0, &sSLen );

		retcode = SQLExecDirect(hstmt, (unsigned char *)szSQL, SQL_NTS);
		if (retcode ==SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
		{
		}
		else if (retcode==SQL_ERROR)
		{
			DisplayErrorMsg( hstmt );
		}
	}
	else return;

	if (hstmt!=NULL) SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(db_index);
}

/////////////////////////////////////////////////////////////////////////////////////////////
//
void USER::SetPsiOne(BYTE tKind, DWORD dwTime)
{
	m_dwHasteTime = m_dwShieldTime = m_dwDexUpTime = m_dwMaxHPUpTime = 0;
	m_dwFastRunTime = m_dwBigShieldTime = m_dwMindShockTime = m_dwPsiShieldTime = m_dwPiercingShieldTime = 0;

	switch(tKind)
	{
	case PSIONIC_HASTE: //¼ÓËÙ
		m_dwHasteTime = dwTime;
		break;
	case PSIONIC_SHIELD://·À»¤
		m_dwShieldTime = dwTime;
		break;
	case PSIONIC_DEXUP://¼²·çÖ®Óê
		m_dwDexUpTime = dwTime;
		break;
	case PSIONIC_HPUP://ÉúÃüÖ®¹â
		m_dwMaxHPUpTime = dwTime;
		break;
	case PSIONIC_FAST_RUN:
		m_dwFastRunTime = dwTime;
		break;
	case PSIONIC_MIND_SHOCK:
		m_dwMindShockTime = dwTime;
		break;
	case PSIONIC_PSI_SHIELD:
		m_dwPsiShieldTime = dwTime;
		break;
	case 30:
		m_dwBigShieldTime = dwTime;
		break;
	case PSIONIC_PIERCING_SHIELD:
		m_dwPiercingShieldTime = dwTime;
		break;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////
//	DB ·Î ºÎÅÍ ¹æ¾î·Â¾÷, °ø°Ý·Â¾÷, ¹ö¼­Ä¿ Á¤º¸¸¦ ¼ÂÆÃÇÑ´Ù.
//
void USER::SetPsiTwo(BYTE tKind, DWORD dwTime)
{
	m_dwAdamantineTime = m_dwMightyWeaponTime = m_dwBerserkerTime = 0;

	switch(tKind)
	{
	case PSIONIC_ADAMANTINE:
		m_dwAdamantineTime = dwTime;
		break;
	case PSIONIC_MIGHTYWEAPON:
		m_dwMightyWeaponTime = dwTime;
		break;
	case PSIONIC_BERSERKER:
		m_dwBerserkerTime = dwTime;
		break;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////
//	DB ·Î ºÎÅÍ ¸¶ÀÎµå°¡µå Á¤º¸¸¦ ¼ÂÆÃÇÑ´Ù.
//
void USER::SetPsiThree(BYTE tKind, DWORD dwTime)
{
	m_dwMindGuardTime = 0;

	switch(tKind)
	{
	case PSIONIC_MIND_GUARD:
		m_dwMindGuardTime = dwTime;
		break;
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////
//	Ä§°ø ÀÌº¥Æ®¸¦ À§ÇÏ¿© ¸÷À» ¼ÒÈ¯ÇÑ´Ù.
//  ÎÞ¾¡µÄÕÙ»½
BOOL USER::InvaderSummon(BYTE tSlot)
{
	if(tSlot < 0 || tSlot >= TOTAL_INVEN_MAX) return FALSE;

	short sItemSid = m_UserItem[tSlot].sSid;
	if(sItemSid < 0 || sItemSid >= g_arItemTable.GetSize()) return FALSE;

	CPoint pt(-1, -1);

	short sMonsterID = myrand(184, 190);
	switch (sItemSid)
	{
	case 715:
		sMonsterID = 184;
		break;
	case 716:
		sMonsterID = 185;
		break;
	case 717:
        sMonsterID = 186;
		break;
	case 718:
		sMonsterID = 187;
		break;
	case 719:
		sMonsterID = 188;
		break;
	case 720:
		sMonsterID = 189;
		break;
	case 721:
		sMonsterID = 190;
		break;
	}
	
	if(sMonsterID < 0 || sMonsterID >= g_arNpc.GetSize()) return FALSE;
	

	g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_bMove = 1;
	pt = FindNearAvailablePoint_S(m_curx, m_cury);
	g_zone[m_ZoneIndex]->m_pMap[m_curx][m_cury].m_bMove = 0;
	
	if(pt.x == -1 || pt.y == -1) return FALSE;
	
	if(SummonQuestMonster(sMonsterID, m_curz, pt.x, pt.y) == -1) return FALSE;
//	if(SummonQuestMonster(sMonsterID, m_curz, m_curx, m_cury) == -1) return FALSE;
	return TRUE;
}

/////////////////////////////////////////////////////////////////////////////////
//	¾µ¸ð¾ø´Â ¸ÅÁ÷, ·¹¾î ¾ÆÀÌÅÛÀ» µ¹·Á¼­ »õ·Î¿î ¿É¼ÇÀ» ¾ò´Â´Ù.
//
void USER::RemagicItemReq(TCHAR *pBuf, BOOL bEvent)
{
	if(m_dwDN < ITEM_REMAGIC_COST) 
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}

	CBufferEx TempBuf;

	int iStart = 0, iCount = 3;
	int index = 0, iSuccess = 0;
	int i, j;
	int iWeight = 0;
	BYTE tItemSlot = -1;
	BYTE tMaterialSlot[3] = {0, 0, 0};
	BYTE bySlot = 0;
	short sMaterialSid[3] = {-1, -1, -1};
	CString szName1, szName2, szName3;
	ItemList RemagicItem;

	CByteArray arMaterial;
	arMaterial.RemoveAll();

	short sSourceSlot = GetShort(pBuf, index);	// ¼±ÅÃÇÑ ¾ÆÀÌÅÛ ½½·Ô¹øÈ£

	if(sSourceSlot != -1) return;				// ¸®¸ÅÁ÷Àº ¼Ò½º½½·ÔÀÌ ¾ø´Ù.

	if(bEvent)	// Å©¸®½º¸¶½º ÀÌº¥Æ® ¾ÆÀÌÅÛÀ» »ç¿ëÇÑ °æ¿ì
	{
//		if(!0)
//		{
			SendSystemMsg(IDS_EVENT_END, SYSTEM_NORMAL, TO_ME);
			return;
//		}
		iStart = 1;
		tItemSlot = GetShort(pBuf, index);
		if(tItemSlot < EQUIP_ITEM_NUM && tItemSlot >= TOTAL_INVEN_MAX) return;
		if(m_UserItem[tItemSlot].sSid != 872) return;		// Å©¸®½º¸¶½º ¸·´ë»çÅÁÀÌ ¾Æ´Ï¸é ¸®ÅÏ
		if(m_UserItem[tItemSlot].sCount < 1) return;		// °³¼ö°¡ ¸ðÀß·¯µµ ¸®ÅÏ

		arMaterial.Add(tItemSlot);
		iWeight += g_arItemTable[872]->m_byWeight;			// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.
	}

	j = 0;
	for(i = iStart; i < iCount + iStart; i++, j++)				// ¸ÅÁ÷ Àç·á °Ë»ç	
	{
		tMaterialSlot[j] = GetShort(pBuf, index);				// Àç·á ( ¾øÀ¸¸é -1 )
		if(tMaterialSlot[j] < EQUIP_ITEM_NUM && tMaterialSlot[j] >= TOTAL_INVEN_MAX) return;

		sMaterialSid[j] = m_UserItem[tMaterialSlot[j]].sSid;
		if(m_UserItem[tMaterialSlot[j]].sCount <= 0) return;
		if(m_UserItem[tMaterialSlot[j]].tIQ != UNIQUE_ITEM) if(m_UserItem[tMaterialSlot[j]].tMagic[5] != 0) return;		// ¾÷±×·¹ÀÌµå ¾ÆÀÌÅÛÀº ¸®¸ÅÁ÷ÀÌ ¾ÈµÈ´Ù.
		if(m_UserItem[tMaterialSlot[j]].tIQ == REMODEL_ITEM || m_UserItem[tMaterialSlot[j]].tIQ == REMODEL_MAGIC_ITEM) return; //°³Á¶ ¾ÆÀÌÅÛÀº ¸®¸ÅÁ÷ÀÌ ¾ÈµÈ´Ù.
		if(m_UserItem[tMaterialSlot[j]].tIQ != RARE_ITEM) return;//²»ÊÇ½ðÉ«×°±¸²»ÄÜºÏ³ÉÄ§·¨Ê¢×°
		if(sMaterialSid[j] < 0 || sMaterialSid[j] >= g_arItemTable.GetSize()) return;
		if(g_arItemTable[sMaterialSid[j]]->m_byWear < 1 || g_arItemTable[sMaterialSid[j]]->m_byWear > 5) return;	//¹«±â, ¹æ¾î±¸¸¸
	}

	// °°Àº Á¾·ùÀÇ ¾ÆÀÌÅÛÀÎÁö °Ë»çÇÑ´Ù.
	szName1 = g_arItemTable[sMaterialSid[0]]->m_strName;
	szName2 = g_arItemTable[sMaterialSid[1]]->m_strName;
	szName3 = g_arItemTable[sMaterialSid[2]]->m_strName;

	RemagicItem = m_UserItem[tMaterialSlot[0]];
	if(szName1 != szName2 || szName1 != szName3 || szName2 != szName3) return;

	iSuccess = GetMagicOption(&RemagicItem, 3, bEvent);
	RemagicItem.tIQ = RARE_ITEM;
	if(iSuccess == 0) return;

	
	m_UserItem[tMaterialSlot[0]] = RemagicItem;		// ¸ÅÁ÷¾ÆÀÌÅÛ¿¡ »õ·Î¿î ¿É¼ÇºÎ¿©

	for(i = 0; i < 3; i++)	
	{
		if(i != 0) 
		{
			iWeight += g_arItemTable[sMaterialSid[i]]->m_byWeight;			// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.
			MakeItemLog(&m_UserItem[tMaterialSlot[i]], ITEMLOG_REMAGIC_DELETE );
			ReSetItemSlot(&m_UserItem[tMaterialSlot[i]]);
		}
		arMaterial.Add(tMaterialSlot[i]);
	}

	if(tItemSlot != -1)
	{
		if(m_UserItem[tItemSlot].sCount <= 1)
		{
			MakeItemLog(&m_UserItem[tItemSlot], ITEMLOG_REMAGIC_DELETE );
			ReSetItemSlot(&m_UserItem[tItemSlot]);
		}
		else
		{
			m_UserItem[tItemSlot].sCount -= 1;
		}
	}

	FlushItemLog( TRUE );

	if( m_dwDN <= ITEM_REMAGIC_COST ) m_dwDN = 0;
	else m_dwDN = m_dwDN - ITEM_REMAGIC_COST;
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();							// µ·º¯°æ Á¤º¸¸¦ º¸³½´Ù.

	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();

	TempBuf.Add((BYTE)0x03); // ¸®¸ÅÁ÷ ¼º°ø
	TempBuf.Add((BYTE)index);

	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		bySlot = (BYTE)arMaterial[i];
	
		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

	Send(TempBuf, TempBuf.GetLength());

	arMaterial.RemoveAll();
}

///////////////////////////////////////////////////////////////////////////////////////
//	»õ·Î¿î ¸ÅÁ÷ ¿É¼ÇÀ» ¾ò´Â´Ù.
//
BOOL USER::GetMagicOption(ItemList* pItem, BYTE tIQ, BYTE tSame)
{
	int iMagicCount = 0;
	int nLoop = 0;
	int i = 0, j = 0, iRandom = 0;
	int iCount = 0, iTemp = 0;
	short sSid = -1;

	if(pItem == NULL) return FALSE;
	sSid = pItem->sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return FALSE;

	if(tIQ == MAGIC_ITEM) nLoop = 2;
	else if(tIQ == RARE_ITEM) nLoop = 4;
	else return FALSE;             //É¾³ýÀ¬»øÊôÐÔ     ///neo°æ±¾

	if(m_sLevel <= 20)			iMagicCount = 205;		// ¸ÅÁ÷ÀÎµ¦½º ¹üÀ§¸¦ ·¹º§¿¡ µû¶ó Á¦ÇÑÇÑ´Ù. 
	else if(m_sLevel <= 40)		iMagicCount = 205;
	else if(m_sLevel <= 90)		iMagicCount = 205;
	else						iMagicCount = 205;

	if(iMagicCount >= g_arMagicItemTable.GetSize()) iMagicCount = g_arMagicItemTable.GetSize() - 1;

	pItem->tMagic[0] = pItem->tMagic[1] = pItem->tMagic[2] = pItem->tMagic[3] = pItem->tMagic[4] = pItem->tMagic[5] = 0;

	i = 0;
	while(nLoop > i)										
	{    
	//	sRandom = myrand(1,42);
		iRandom = myrand(1, iMagicCount);

		if(!g_arMagicItemTable[iRandom]->m_tUse) continue;
		if(g_arMagicItemTable[iRandom]->m_sSubType == 32) continue;	// ³»±¸µµ ¿É¼ÇÀº ºÙÀÌÁö ¾Ê´Â´Ù.
		
		if(CheckClassWear(sSid, iRandom) == FALSE)			// Npc.cpp ÀÇ CheckClassItem °ú °°Àº ±â´ÉÀ» ¼öÇà. User ÀÇ CheckClassItem À» È£ÃâÇÏ¸é ¾ÈµÊ
		{
			if(i == 0) continue;							// ¸ÅÁ÷Àº ±âº»ÀÌ 1°³
			else if(tIQ == RARE_ITEM && i <= 2) continue;	// ·¡¾î´Â ±âº»ÀÌ 3°³
			else { i++; continue; }
		}

		for(j = 0; j < 4; j++)
		{
			if(tSame != TRUE)
			{
				iCount = g_arMagicItemTable[pItem->tMagic[j]]->m_sSubType;
				if(iCount != 0 && iCount == g_arMagicItemTable[iRandom]->m_sSubType)	// ¼Ó¼ºÀÌ °ãÄ¥¼ö ÀÖÀ¸¹Ç·Î ÀÌÁß Å«°ª¸¸ ¼±ÅÃ	
				{
					iCount = g_arMagicItemTable[pItem->tMagic[j]]->m_sChangeValue;
					if(iCount < g_arMagicItemTable[iRandom]->m_sChangeValue)
					{
						iTemp = g_arMagicItemTable[pItem->tMagic[j]]->m_tLevel;
						if(pItem->sLevel - iTemp > 0) pItem->sLevel -= iTemp;
						pItem->sLevel += g_arMagicItemTable[iRandom]->m_tLevel;
						pItem->tMagic[j] = iRandom; 
						
						break;
					}
					else if(iCount == g_arMagicItemTable[iRandom]->m_sChangeValue) break;
				}
			}

			if(pItem->tMagic[j] > 0) continue;										// ÀÌ¹Ì ½½·Ô¿¡ °ªÀÌ ÀÖÀ¸¸é ³Ñ¾î°¨
			else
			{ 
				pItem->tMagic[j] = iRandom; i++;
				if(g_arMagicItemTable[iRandom]->m_tLevel > 0) pItem->sLevel += g_arMagicItemTable[iRandom]->m_tLevel;
				break; 
			}
		}
	}

	return TRUE;
}

////////////////////////////////////////////////////////////////////////////////////////////////
//	ÇöÀç ºÎ¿©ÇÏ·Á´Â ¸ÅÁ÷¼Ó¼ºÀÌ ÇØ´ç ¾ÆÀÌÅÛ¿¡ Àû¿ëµÉ ¼ö ÀÖ´ÂÁö Å¬·¡½ºÁ¤º¸¿Í ¿þ¾îÁ¤º¸¸¦ °Ë»çÇÑ´Ù.
//
BOOL USER::CheckClassWear(int iItemSid, int iMagicSid)
{
	if(iItemSid < 0 || iItemSid >= g_arItemTable.GetSize()) return FALSE;
	if(iMagicSid < 0 || iMagicSid >= g_arMagicItemTable.GetSize()) return FALSE;

	BYTE tItemWear = g_arItemTable[iItemSid]->m_byWear;				// ¾ÆÀÌÅÛ ¿þ¾îÁ¤º¸
	BYTE tMagicWear = g_arMagicItemTable[iMagicSid]->m_tWearInfo;	// ¸ÅÁ÷¿É¼Ç ¿þ¾î Á¤º¸

	BYTE tNeedClass = g_arItemTable[iItemSid]->m_byClass;			
	BYTE tMagicClass = g_arMagicItemTable[iMagicSid]->m_tNeedClass;	// ¸ÅÁ÷¼Ó¼º Å¬·¡½º

	// Class Ã¼Å©
	if(tMagicClass != 15)		// ¸ðµç°è¿­¿¡ ºÙÀ» ¼ö ÀÖ´Â ¿É¼ÇÀÌ ¾Æ´Ï¸é
	{
		BYTE tTemp = 1;	
		BYTE tFire = 0;
		BYTE tEdge = 0;
		BYTE tStaff = 0;
		BYTE tBrawl = 0;

		tFire	 = tTemp & tNeedClass; tTemp = 2; 
		tEdge	 = tTemp & tNeedClass; tTemp = 4;
		tStaff	 = tTemp & tNeedClass; tTemp = 8;
		tBrawl	 = tTemp & tNeedClass;

		tFire = tFire & tMagicClass;
		tEdge = tEdge & tMagicClass;
		tStaff = tStaff & tMagicClass;
		tBrawl = tBrawl & tMagicClass;

		tTemp = tFire^tEdge^tStaff^tBrawl;
		if(!tTemp) return FALSE;
	}

	// WearInfo Ã¼Å©
	if(tMagicWear == 0) return TRUE;
	else if(tMagicWear == 1)											
	{														// 1¹øÀÌ¸é ¹«±â·ù¿¡ ºÙ´Â´Ù.
		if(tItemWear != 1) return FALSE;
		else return TRUE;
	}
	else if(tMagicWear == 2)								
	{
		if(tItemWear <= 1 || tItemWear >= 9) return FALSE;
		else return TRUE;
	}
	else return FALSE;
}

/////////////////////////////////////////////////////////////////////////////////
//	EBody ¸¦ ¾÷±×·¹ÀÌµå ÇÑ´Ù.
//
void USER::EBodyUpgradeReq(TCHAR *pBuf)
{
#ifdef _ACTIVE_USER
	if(m_iDisplayType == 6) return; //yskang 0.5
#endif

	if(m_dwDN < EBODY_UPGRADE_COST) 
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return;		// ¾÷±×·¹ÀÌµå ÇÒ µ·ÀÌ ¾øÀ¸¸é ¸®ÅÏ
	}
	if(m_dwXP < EBODY_UPGRADE_XP) 
	{
		SendSystemMsg( IDS_XP_ERROR, SYSTEM_ERROR, TO_ME);
		return;		// ¾÷±×·¹ÀÌµå XP°¡ ¾øÀ¸¸é ¸®ÅÏ
	}

	CBufferEx TempBuf;

	int iCount = 1, iUpgradeCount = 0;
	int index = 0, iSuccess = 0;
	int i, j;
	int iWeight = 0;
	BYTE tItemSlot = -1;
	short sMaterialSlot[2] = {0};  //short sMaterialSlot = 0;
	BYTE bySlot = 0;
	short sMaterialSid = -1;
	short sSourceSid = -1;
	BYTE tSourceWear = 0;
	int iRandom = 0;
	int iRate1 = 0, iRate2 = 0;

	ItemList TempItem;

	CByteArray arMaterial;
	arMaterial.RemoveAll();

	short sSourceSlot = GetShort(pBuf, index);	
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;	// ÀÎº¥¿¡¼­¸¸ ¾÷±×·¹ÀÌµå °¡´É

	sSourceSid = m_UserItem[sSourceSlot].sSid;
	if(sSourceSid < 0 || sSourceSid >= g_arItemTable.GetSize()) return;
	if(m_UserItem[sSourceSlot].tMagic[0] != 0 && m_UserItem[sSourceSlot].tMagic[1] != 0 && m_UserItem[sSourceSlot].tMagic[2] != 0
		&& m_UserItem[sSourceSlot].tMagic[3] != 0 && m_UserItem[sSourceSlot].tMagic[4] != 0) return;

	for(i = 1; i < 5; i++)
	{
		if(m_UserItem[sSourceSlot].tMagic[i] <= 0) 
		{
			iUpgradeCount = i - 1;
			break;
		}
	}
	if(iUpgradeCount < 0 || iUpgradeCount > 3) return;	// EBdoy Upgrade ¸¦ ÀÌ¹Ì 4¹ø ´ÙÇß´Ù.
	if(iUpgradeCount >= g_arEBodyUpgradeTable.GetSize()) return;	// Àß¸øµÈ ¾÷±×·¹ÀÌµå °ª

	tSourceWear = g_arItemTable[sSourceSid]->m_byWear;
	if(tSourceWear < 122 || tSourceWear > 125)			// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ EBody °¡ ¾Æ´Ï¶ó¸é
	{
		SendSystemMsg( IDS_USER_CANT_UPGRADE_ITEM, SYSTEM_ERROR, TO_ME);
		return;
	}

	j = 0;
	//ÅÐ¶ÏÊÇ·ñÎª³¬¼¶»úÐµ
	if(IsSuperEbodyItem(sSourceSid))
        iCount = 2;
    BYTE bEM[2] ={ 0xff, 0xff};
	for(i = 0; i < iCount ; i++)				// ¸ÅÁ÷ Àç·á °Ë»ç	
	{
		sMaterialSlot[i] = GetShort(pBuf, index);	// Àç·á ( ¾øÀ¸¸é -1 )
		if(sMaterialSlot[i] < EQUIP_ITEM_NUM && sMaterialSlot[i] >= TOTAL_INVEN_MAX) return;

		sMaterialSid = m_UserItem[sMaterialSlot[i]].sSid;
		if(m_UserItem[sMaterialSlot[i]].sCount != 1) return;			
		if(m_UserItem[sMaterialSlot[i]].tIQ != MAGIC_ITEM) return;		// ¿¡ÀÌ´õ´Â ¹«Á¶°Ç ¸ÅÁ÷ ¾ÆÀÌÅÛ
		
		if(sMaterialSid < 0 || sMaterialSid >= g_arItemTable.GetSize()) return;
		if(g_arItemTable[sMaterialSid]->m_byWear != 126) return;	// ¿¡ÀÌ´õ°¡ ¾Æ´Ï¸é ¸®ÅÏ
		bEM[i] = m_UserItem[sMaterialSlot[i]].tMagic[0];
	}
    //ÅÐ¶ÏÊôÐÔÊÇ·ñÒ»ÖÂ
	if(iCount == 2)
	{
		if(bEM[0]!=bEM[1]&&bEM[0]!=0xff)
			return;
	}
	iRandom = myrand(1, 100);
	iRate1 = g_arEBodyUpgradeTable[iUpgradeCount]->m_tRandom1;
	iRate2 = g_arEBodyUpgradeTable[iUpgradeCount]->m_tRandom2;

	if(iRandom <= iRate1) iSuccess = 1;
	else if(iRate1 < iRandom && iRandom <= iRate1 + iRate2) iSuccess = 0;
	else iSuccess = -1;

	if(iSuccess == -1)		// ¿ÏÀü½ÇÆÐ, º£ÀÌ½º¿Í ¿¡ÀÌ´õ±îÁö ³¯¶ó°£´Ù.
	{
		MakeItemLog(&m_UserItem[sSourceSlot], ITEMLOG_EBODY_BASE_DELETE );
		MakeItemLog(&m_UserItem[sMaterialSlot[0]], ITEMLOG_EBODY_ADDER_DELETE );
		//³¬¼¶»úÐµ
		if(iCount ==2)
			MakeItemLog(&m_UserItem[sMaterialSlot[1]], ITEMLOG_EBODY_ADDER_DELETE );

		ReSetItemSlot(&m_UserItem[sSourceSlot]);
		ReSetItemSlot(&m_UserItem[sMaterialSlot[0]]);
		if(iCount ==2)
			ReSetItemSlot(&m_UserItem[sMaterialSlot[1]]);

		iWeight += g_arItemTable[sSourceSid]->m_byWeight;			// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.
		iWeight += g_arItemTable[sMaterialSid]->m_byWeight;		

		arMaterial.Add((BYTE)sSourceSlot);
		arMaterial.Add((BYTE)sMaterialSlot[0]);
		if(iCount == 2)
			arMaterial.Add((BYTE)sMaterialSlot[1]);
	}
	else if(iSuccess == 0)	// ¿¡ÀÌ´õ¸¸ ³¯¶ó°£´Ù.
	{
		MakeItemLog(&m_UserItem[sMaterialSlot[0]], ITEMLOG_EBODY_ADDER_DELETE );
		if(iCount == 2)
			MakeItemLog(&m_UserItem[sMaterialSlot[1]], ITEMLOG_EBODY_ADDER_DELETE );
		ReSetItemSlot(&m_UserItem[sMaterialSlot[0]]);
		if(iCount == 2)
			ReSetItemSlot(&m_UserItem[sMaterialSlot[1]]);
		iWeight += g_arItemTable[sMaterialSid]->m_byWeight;		// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.

		arMaterial.Add((BYTE)sMaterialSlot[0]);
		if(iCount == 2)	
			arMaterial.Add((BYTE)sMaterialSlot[1]);
	}
	else					// ¼º°ø, ¿¡ÀÌ´õ´Â ³¯¸®°í, º£ÀÌ½º¿¡´Â »õ·Î¿î ¸ÅÁ÷¼Ó¼ºÀ» Ãß°¡ÇÑ´Ù.
	{
		m_UserItem[sSourceSlot].tMagic[iUpgradeCount + 1] = m_UserItem[sMaterialSlot[0]].tMagic[0];
		m_UserItem[sSourceSlot].sLevel += m_UserItem[sMaterialSlot[0]].sLevel;		// EBody ´Â ¾÷±×·¹ÀÌµå µÉ¶§¸¶´Ù ·¹º§ÀÌ °°ÀÌ ¿Ã¶ó°£´Ù.

		MakeItemLog(&m_UserItem[sSourceSlot], ITEMLOG_EBODY_UPGRADE_SUCCESS );
		MakeItemLog(&m_UserItem[sMaterialSlot[0]], ITEMLOG_EBODY_ADDER_DELETE );
		if(iCount == 2)
			MakeItemLog(&m_UserItem[sMaterialSlot[1]], ITEMLOG_EBODY_ADDER_DELETE );

		ReSetItemSlot(&m_UserItem[sMaterialSlot[0]]);
		if(iCount == 2)
			ReSetItemSlot(&m_UserItem[sMaterialSlot[1]]);

		iWeight += g_arItemTable[sMaterialSid]->m_byWeight;		// ¹«°Ôº¯È­¸¦ Ã¼Å©ÇÑ´Ù.

		arMaterial.Add((BYTE)sSourceSlot);
		arMaterial.Add((BYTE)sMaterialSlot[0]);
		if(iCount==2)
			arMaterial.Add((BYTE)sMaterialSlot[1]);
	}

	FlushItemLog( TRUE );

	if( m_dwDN <= EBODY_UPGRADE_COST ) m_dwDN = 0;
	else m_dwDN = m_dwDN - EBODY_UPGRADE_COST;
	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();							// µ·º¯°æ Á¤º¸¸¦ º¸³½´Ù.

	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();

	if(iSuccess == 1) TempBuf.Add((BYTE)0x01);	// EBody Upgrade ¼º°ø
	else TempBuf.Add((BYTE)0x00);				// EBody Upgrade ½ÇÆÐ

	TempBuf.Add((BYTE)index);

	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		bySlot = (BYTE)arMaterial[i];
	
		TempBuf.Add(bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}

	m_iCurWeight -= iWeight;
	if(m_iCurWeight < 0) m_iCurWeight = 0;

	GetRecoverySpeed();							// È¸º¹¼Óµµ Ã¼Å©...

	Send(TempBuf, TempBuf.GetLength());

	arMaterial.RemoveAll();
}

//////////////////////////////////////////////////////////////////////////////////
//	È®ÀÎÇÒ ¼ö ÀÖ´Â EBody ¸®½ºÆ®¸¦ ¸¸µç´Ù.
//
void USER::EBodyIdentifyOpen(int iStoreID)
{
#ifdef _ACTIVE_USER
	if(m_iDisplayType == 6) return; //yskang 0.5
#endif

	int rank = m_sCityRank + CITY_RANK_INTERVAL;
	if(rank == CHAONISE_RANK && IsCity()) 
	{
		SendSystemMsg( IDS_USER_CANT_USE_YOUR_CITY_RANK, SYSTEM_NORMAL, TO_ME);
		return;
	}

	int i;
	short sStoreID = iStoreID;

	int iStart = EQUIP_ITEM_NUM;
	int iEnd = TOTAL_INVEN_MAX;

	CStore* pStore = GetStore(sStoreID);
	if(pStore == NULL) return;

	CBufferEx CostBuf;
	BYTE tSlot = 0;
	short sCount = 0;
	for(i = iStart; i < iEnd; i++)
	{
		if(m_UserItem[i].sSid == 908)	// ¹ÌÈ®ÀÎ »óÅÂÀÇ EBody ÀÇ Sid
		{
			tSlot = (BYTE)i;
			sCount++;
			CostBuf.Add(tSlot);
		}
	}

	CBufferEx TempBuf;
	TempBuf.Add(EBODY_IDENTIFY_OPEN);
	TempBuf.Add(sStoreID);
	TempBuf.Add(sCount);
	if(sCount > 0) TempBuf.AddData(CostBuf, CostBuf.GetLength());

	Send(TempBuf, TempBuf.GetLength());
}

//////////////////////////////////////////////////////////////////////////////////
//	¼ø¶¨Ñ©»ê
//
void USER::EBodyIdentifyReq(TCHAR* pBuf)
{
	int index = 0, i, j;
	int iRandom = 0;
	DWORD dwIdentifyCost = 0;
	DWORD dwNeedXP = 0;
	CByteArray	arSlot;
	ItemList MyItem[TOTAL_INVEN_MAX - EQUIP_ITEM_NUM];

	short sSid = -1, sEBodySid = -1;
	BYTE tSlot = 0;

	short sStoreID = GetShort(pBuf, index);
	if(sStoreID < 0) return;

	// ÀÌº¥Æ® À§Ä¡¸¦ °Ë»ç -----------------------------------------//
	CPoint pt = ConvertToClient(m_curx, m_cury);
    if(!g_pEventBlock->CheckUserEvent(m_curz, pt.x, pt.y, REPAIR_BLOCK)) return;

	short sCount = GetShort(pBuf, index);

	if(sCount <= 0 || sCount >= TOTAL_INVEN_MAX - EQUIP_ITEM_NUM) return;

	for(i = 0; i < sCount; i++)
	{
		tSlot = GetByte(pBuf, index);
		if(tSlot < EQUIP_ITEM_NUM || tSlot >= TOTAL_INVEN_MAX) return;	// ÀÎº¥¿¡¼­¸¸ È®ÀÎ °¡´É
		if(m_UserItem[tSlot].sCount != 1) return;						// °ãÄ¥ ¼ö ¾ø´Â ¾ÆÀÌÅÛÀÌ´Ù.

		sSid = m_UserItem[tSlot].sSid;
		if (sSid != 908)
		{
			return ;
		}
		if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return;

		dwIdentifyCost += EBODY_IDENTIFY_COST;
		dwNeedXP += EBODY_IDENTIFY_XP;

		if(dwIdentifyCost > m_dwDN)
		{
			SendSystemMsg( IDS_USER_NOT_ENOUGH_DINA1, SYSTEM_ERROR, TO_ME);
			return;
		}
		if(dwNeedXP > m_dwXP)
		{
			SendSystemMsg( IDS_XP_ERROR, SYSTEM_ERROR, TO_ME);
			return;
		}

		arSlot.Add((BYTE)tSlot);
		MyItem[i] = m_UserItem[tSlot];
	}

	for(i = 0; i < arSlot.GetSize(); i++)
	{
		tSlot = arSlot[i];
		sSid = m_UserItem[tSlot].sSid;

		iRandom = myrand(0, g_arEBodyIdentifyTable.GetSize() -1);
		sEBodySid = g_arEBodyIdentifyTable[iRandom]->m_sSid;
		if(sEBodySid < 0 || sEBodySid >= g_arItemTable.GetSize()) 
		{
			for(j = 0; j < arSlot.GetSize(); j++)
			{
				m_UserItem[arSlot[j]] = MyItem[j];
				return;
			}
		}

		m_UserItem[tSlot].sLevel	= g_arItemTable[sEBodySid]->m_byRLevel;
		m_UserItem[tSlot].sSid		= g_arItemTable[sEBodySid]->m_sSid;
		m_UserItem[tSlot].sDuration = g_arItemTable[sEBodySid]->m_sDuration;
		m_UserItem[tSlot].sBullNum	= g_arItemTable[sEBodySid]->m_sBullNum;
		m_UserItem[tSlot].sCount	= 1;
		for(j =0; j < MAGIC_NUM; j++) 
		{
			if(j == 0)	m_UserItem[tSlot].tMagic[j] = g_arItemTable[sEBodySid]->m_bySpecial;
			else		m_UserItem[tSlot].tMagic[j] = 0;
		}
		m_UserItem[tSlot].tIQ = MAGIC_ITEM; 
	}

	//-----------------[ Send Packet ]---------------------------------------//
	if(m_dwDN<=dwIdentifyCost)
		m_dwDN = 0;
	else
		m_dwDN = m_dwDN - dwIdentifyCost;
	

	m_dwXP = m_dwXP - dwNeedXP;
	if(m_dwXP < 0) m_dwXP = 0;

	UpdateUserItemDN();							// ¾ÆÀÌÅÛÀÌ´Ï±ñ ¹Ù·Î Àû¿ëÇÑ´Ù.
	SendMoneyChanged();

	SendXP();

	CBufferEx TempBuf;

	TempBuf.Add(ITEM_MOVE_RESULT);
	TempBuf.Add((BYTE)0x01);				// ¼º°ø
	TempBuf.Add((BYTE)0x00);				// ÀÏ¹Ý ¾ÆÀÌÅÛ
	TempBuf.Add((BYTE)arSlot.GetSize());	// º¯È­µÈ ½½·ÔÀÇ ¼ö

	for(i = 0;  i < arSlot.GetSize(); i++)
	{
		tSlot = arSlot[i];
		TempBuf.Add((BYTE)tSlot);
		TempBuf.Add(m_UserItem[tSlot].sLevel);
		TempBuf.Add(m_UserItem[tSlot].sSid);
		TempBuf.Add(m_UserItem[tSlot].sDuration);
		TempBuf.Add(m_UserItem[tSlot].sBullNum);
		TempBuf.Add(m_UserItem[tSlot].sCount);
		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[tSlot].tMagic[j]);
		TempBuf.Add(m_UserItem[tSlot].tIQ); 
	}

	Send(TempBuf, TempBuf.GetLength());

	arSlot.RemoveAll();
}

//////////////////////////////////////////////////////////////////////////////////
//	Finito - Sends server date and tiem to  client for screen capture.
//
void USER::ScreenCaptureReq()
{
	CBufferEx TempBuf;

    SYSTEMTIME st;
    GetSystemTime(&st);

	TempBuf.Add(SCREEN_CAPTURE_REQ);
	TempBuf.Add(st.wYear);
	TempBuf.Add(st.wMonth);
	TempBuf.Add(st.wDay);
	TempBuf.Add(st.wHour);
	TempBuf.Add(st.wMinute);
	TempBuf.Add(st.wSecond);

	Send(TempBuf, TempBuf.GetLength());
}

//////////////////////////////////////////////////////////////////////////////////
//	Finito - Sends Expression data to client
//
void USER::ExpressionReq(TCHAR* pBuf)
{
	int index = 0;
	short sExpression;

	sExpression = GetShort(pBuf, index);

	CBufferEx TempBuf;

	TempBuf.Add(EXPRESSION_REQ);
	TempBuf.Add((BYTE)0);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add(sExpression);

	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
}

//////////////////////////////////////////////////////////////////////////////////
//	Finito - Opens expression dialog
//
void USER::ExpressionOpen()
{
	CBufferEx TempBuf;

	TempBuf.Add(EXPRESSION_OPEN);
	TempBuf.Add((short)1);
	TempBuf.Add((short)77);

	Send(TempBuf, TempBuf.GetLength());
}

/////////////////////////////////////////////////////////////////////////
//	Cures HP, PP, SP and restores energy / bullets for level 10 and below
//
void USER::SendHelperCure()
{
	BYTE result = SUCCESS;

	CBufferEx TempBuf;

	// ÀÌº¥Æ® À§Ä¡¸¦ °Ë»ç ----------------------------------------//
	CPoint pt = ConvertToClient(m_curx, m_cury);
	if(!g_pEventBlock->CheckUserEvent(m_curz, pt.x, pt.y, CURE_BLOCK)) return;

	if(m_sHP >= m_sMagicMaxHP && m_sPP >= m_sMagicMaxPP && m_sSP >= m_sMagicMaxSP)
	{
		if(m_UserItem[RIGHT_HAND].sBullNum >= 250 && m_byClass == EDGED || m_byClass == FIREARMS && m_UserItem[RIGHT_HAND].sSid != -1)
		{		
			SendSystemMsg( IDS_HELPER_NOT_NEED_CURE, SYSTEM_NORMAL, TO_ME);
			result = FAIL;
			goto go_result;
		}
		else if(m_UserItem[RIGHT_HAND].sSid == -1)
		{	
			SendSystemMsg( IDS_HELPER_NOT_NEED_CURE, SYSTEM_NORMAL, TO_ME);
			result = FAIL;
			goto go_result;
		}
		else if(m_UserItem[RIGHT_HAND].sSid != -1 &&  m_byClass == BRAWL || m_byClass == STAFF)
		{
			SendSystemMsg( IDS_HELPER_NOT_NEED_CURE, SYSTEM_NORMAL, TO_ME);
			result = FAIL;
			goto go_result;
		}
	}

	m_sHP = m_sMagicMaxHP;
	m_sPP = m_sMagicMaxPP;
	m_sSP = m_sMagicMaxSP;


	if ((m_byClass == EDGED) || (m_byClass == FIREARMS))
	{
		if(m_UserItem[RIGHT_HAND].sSid != -1)
		{
			m_UserItem[RIGHT_HAND].sBullNum = 250; 
		}
	}

go_result:
	TempBuf.Add(CURE_RESULT);

	if(result == FAIL) 
	{
		TempBuf.Add(result);			// ½ÇÆÐ
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	TempBuf.Add((BYTE)0x01);			// È¸º¹

	TempBuf.Add(m_sHP);
	TempBuf.Add(m_sPP);
	TempBuf.Add(m_sSP);

	Send(TempBuf, TempBuf.GetLength());
	if(m_bNowBuddy == TRUE) SendBuddyUserChange(BUDDY_CHANGE);		// ¹öµðÁßÀÌ¸é ´Ù¸¥ ¹öµð¿ø¿¡°Ô ³¯¸°´Ù.
	
	if ((m_byClass == EDGED) || (m_byClass == FIREARMS))
	{
		if (m_UserItem[RIGHT_HAND].sSid != -1)
		{
			SendBullNum(RIGHT_HAND);
		}
	}
	if (m_byClass == FIREARMS)
	{
		SendSystemMsg( IDS_HELPER_CURE_COMPLETED, SYSTEM_NORMAL, TO_ME);
		if (m_UserItem[RIGHT_HAND].sSid == -1)
		{
			SendSystemMsg( IDS_HELPER_CURE_COMPLETED2, SYSTEM_NORMAL, TO_ME);
		}
		else
		{
			TCHAR strHealMsg[128];
			::ZeroMemory(strHealMsg, sizeof(strHealMsg));
			wsprintf(strHealMsg, _ID(IDS_HELPER_CURE_COMPLETED2_CLASS), "Rifle");
			SendSystemMsg( strHealMsg, SYSTEM_NORMAL, TO_ME);
		}
	}
	else if (m_byClass == EDGED)
	{
		SendSystemMsg( IDS_HELPER_CURE_COMPLETED, SYSTEM_NORMAL, TO_ME);
		if (m_UserItem[RIGHT_HAND].sSid == -1)
		{
			SendSystemMsg( IDS_HELPER_CURE_COMPLETED2, SYSTEM_NORMAL, TO_ME);
		}
		else
		{
			TCHAR strHealMsg[128];
			::ZeroMemory(strHealMsg, sizeof(strHealMsg));
			wsprintf(strHealMsg, _ID(IDS_HELPER_CURE_COMPLETED2_CLASS), "Sabre");
			SendSystemMsg( strHealMsg, SYSTEM_NORMAL, TO_ME);
		}
	}
	else
	{
		SendSystemMsg( IDS_HELPER_CURE_COMPLETED, SYSTEM_NORMAL, TO_ME);
		SendSystemMsg( IDS_HELPER_CURE_COMPLETED2, SYSTEM_NORMAL, TO_ME);
	}
}

void USER::TogglePKButton(TCHAR* pBuf)  //»ú¼×µÄctrl+zÇÐ»»¹¦ÄÜ
{
	CBufferEx TempBuf;

	int index=0;
//	short Slot = GetShort(pBuf, index);
	BYTE Slot = GetByte(pBuf, index);
	//////////////////////////////////////////
	SYSTEMTIME messageTime;
	GetLocalTime(&messageTime);

	DWORD dwCurrTick = GetTickCount();					

	COleDateTime CurrTime = COleDateTime(messageTime); //µ±Ç°Ê±¼ä
	////////////////////////////////////////////////
	



	
    if(pBuf[0] == 3)
	{
		if(pBuf[1] == 1)
		{
			JJSpeed();
		} 
		if(pBuf[1] == 2){
			m_iSkin=0 , m_iHair=0;
		    SendMyInfo( TO_INSIGHT, INFO_MODIFY );	
		}
		if(m_UserItem[39].sSid == 1184){
			if(m_dwDN > 200000)
			{											
				if(pBuf[1] == 3){				
					m_UserItem[39].sCount = 1;					
					SendCharData();
					SendMyInfo(TO_INSIGHT, INFO_MODIFY);
					CheckMagicItemMove();					
					RobDN(200000);
				}else if(pBuf[1] == 4){				
					m_UserItem[39].sCount = 2;	
					SendMyInfo(TO_INSIGHT, INFO_MODIFY);
					SendCharData();
					CheckMagicItemMove();
					RobDN(200000);
				}
			}
		}		
		return;
	}/*else if(pBuf[0] == 17){ //shopµã¿ªÔª±¦ÉÌµê
		BOOL op = OpenOnShop();
		return;
	}*/
	
	if(pBuf[0] == 0x05)
	{
		TempBuf.Add((BYTE)0x3E);
		TempBuf.Add((BYTE)0x05);
		
		if(pBuf[1] == 0x00){
			TempBuf.Add((BYTE)0x00);
		    m_isUser = false;
			m_bPkKeyDown = FALSE;

		}
		if(pBuf[1] == 0x01)
		{
			m_bPkKeyDown = TRUE;

			if (!m_MItemLock && o_yehuoini[0]->mimabaohu == 1)
			{
				SendSystemMsg( "½â³ýÃÜÂë±£»¤ºó²Å¿ÉÒÔ´ò¿ªPK¼ü", SYSTEM_ERROR, TO_ME);
				return;
			}
		if ( messageTime.wHour == 20 && messageTime.wMinute < 5  &&  m_curz == 67 ) 
			{
				SendSystemMsg( "»î¶¯ÉÐÎ´¿ªÊ¼,ÔÝÊ±²»ÄÜ´ò¿ªPK", SYSTEM_ERROR, TO_ME);
				return;
			}

			TempBuf.Add((BYTE)0x01);
			m_isUser = true;
        }
		Send(TempBuf, TempBuf.GetLength());
	    
	}

	///////////////////////////////////////////////////////////////////////////////////////////////////////////
		if(pBuf[0] == 0x05)
	{
		TempBuf.Add((BYTE)0x3E);
		TempBuf.Add((BYTE)0x05);
		
		if(pBuf[1] == 0x00){
			TempBuf.Add((BYTE)0x00);
		    m_isUser = false;
			m_bPkKeyDown = FALSE;

		}
		if(pBuf[1] == 0x01)
		{
			m_bPkKeyDown = TRUE;

			if (m_PKStart== FALSE && m_curz == 67)
			{
			//	SendSystemMsg( "20:05·Ö²ÅÄÜ¿ªÆôPK°´Å¥,±ÈÈüÕýÊ½¿ªÆô!", SYSTEM_ERROR, TO_ME);
				return;
			}
			TempBuf.Add((BYTE)0x01);
			m_isUser = true;
        }
		Send(TempBuf, TempBuf.GetLength());
	    
	}
	//////////////////////////////////////////////////////////////////////////////////////////////////////////

	//²é¿´×°±¸
	if(pBuf[0] == 0x4f)
	{
		int uid = *(int*)&pBuf[1];
		ViewUserInfo(uid);
	}
//	BYTE bCmd = GetByte(pBuf,index);
	switch(Slot)
	{
		case 0x0d://140¼¶¼¼ÄÜ
		{
			/*if(m_sSkillPoint_ <= 0 || m_sSkillPoint_ > 70) 
				return ;
			BYTE bCmd1 = GetByte(pBuf,index);
			BYTE bCmd2 = GetByte(pBuf,index);
			if(bCmd1 == 1&&m_sLevel<150)
				return ;
			if(bCmd1 == 0 && m_sLevel<140)
				return ;
			m_sSkillPoint_ --;
			m_UserSkill140[bCmd1].sSid = bCmd2;
			m_UserSkill140[bCmd1].tLevel = 1;
			CheckMagicItemMove();
			UpdateUserData();

			CString strMsg;
			if(bCmd1 ==0)
				strMsg.Format("ÇëÑ¡ÔñÄúµÄ140¼¶³¬ÄÜ");
			else
				strMsg.Format("ÇëÑ¡ÔñÄúµÄ150¼¶³¬ÄÜ");

			CBufferEx TempBuf;
			TempBuf.Add(SYSTEM_MSG);
			TempBuf.Add((BYTE)0x01);
			TempBuf.Add(strMsg.GetBuffer(0),strMsg.GetLength());
			Send(TempBuf, TempBuf.GetLength());
			break;*/
		}
		case 0x25://Î¹baby ³ÔÈâÈâ
		{//0x3e 0x25 0x95 0xa7 0x16 0x00 
			short sReceive = GetShort(pBuf,index);
			short sSolt = GetShort(pBuf,index);
			GiveBabyItem(sSolt);
			break;
		}
	}
}

BOOL USER::GivePSI(BYTE tType, int iTime)  /////¸øVIPÊ±¼ä
{
	CBufferEx TempBuf;
	switch (tType)
	{
	case PSIONIC_SHIELD:
		{
			SetShield(iTime);
			return TRUE;
		}
		break;
	case 30:
		{
			SetBigShield(iTime);
			return TRUE;
		}
		break;
	case 100://ÐË·ÜÐ§¹û
		 m_dwHiExpTime = iTime*1000;
		m_dwLastHiExpTime = GetTickCount();
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		AddAbnormalInfo(ABNORMAL_HIEXP);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);	
		Send(TempBuf, TempBuf.GetLength());
		return TRUE;
		break;

		
	case 101://ÐÒÔËÐ§¹û
		m_dwMagicFindTime = iTime*1000;
		//-----------------------------------------------------------------------------------------
		m_dwLastMagicFindTime = GetTickCount();
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		AddAbnormalInfo(ABNORMAL_MAGICFIND);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		Send(TempBuf, TempBuf.GetLength());
		return TRUE;
		break;

		case 102://±äÉíÐ§¹û
		m_sDramageUp = true;					// ´ò¿ªÉËº¦Ìá¸ß
		m_dwBFindTime = iTime*1000;
        m_dwLastBFindTime = GetTickCount();	
		AddStateInfo(STATE_2);//ÏÔÊ¾Í¼±ê
        SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// ·¢ËÍ×Ô¼ºÐÅÏ¢
	    SendUserStatusSkill();					// ·¢ËÍÓÃ»§ÊôÐÔÊý¾Ý
        CheckMagicItemMove();
		return TRUE;
		break;

		case 103://»ÃÁé
		 m_dwHtExpTime = iTime*1000;
		m_dwLastHtExpTime = GetTickCount();	
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
        TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);	
		Send(TempBuf, TempBuf.GetLength());
		CheckMagicItemMove();
		return TRUE;
		break;

		case 104://»Ã¾§
		 m_dwMagicFtTime = iTime*1000;
		m_dwLastMagicFtTime = GetTickCount();	
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
	    TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);	
		Send(TempBuf, TempBuf.GetLength());
		CheckMagicItemMove();
		return TRUE;
		break;

		case 105://»ÃÁé Ã¿ÌìÁìÈ¡
		m_dwVIPTime = iTime*1000;
		m_dwLastVIPTime = GetTickCount();
		AddAbnormalInfo(ABNORMAL_FUDAI);
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
        TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);	
		Send(TempBuf, TempBuf.GetLength());
		CheckMagicItemMove();
		return TRUE;
		break;
	default:
		break;
	}

	return FALSE;
}


void USER::PersonalShopReq(TCHAR* pBuf)
{
	int uid = 0, index = 0, i = 0, nNameLength = 0;
	BYTE byType;
	ItemList tempItem;
	ShopItem* pNewItem;
	
	if(m_bNowTrading == TRUE || m_bNoItemMove == TRUE) return;

	byType = GetByte(pBuf, index);

	switch(byType)
	{
	case 0x00:
		break;
	case 0x01:
		{
			USER* pUser = NULL;
									
			if(m_iPShopViewuid != -1)
			{
				pUser = GetUser(m_iPShopViewuid);
				if(pUser==NULL) return ;
				if(pUser != NULL || pUser->m_state == STATE_GAMESTARTED)
				{
					pUser->m_bViewingAShop = FALSE;
				}	
			}
			m_bPShopView = 0;
			m_iPShopViewuid = -1;
			m_bPShopOpen = FALSE; // Set FALSE because User now has no personal shop

			EnterCriticalSection( &m_CS_ShopItem );
			for(i = 0; i < m_arShopItem.GetSize(); i++)
			{
				if ( m_arShopItem[i] != NULL )
				{
					delete m_arShopItem[i];
					m_arShopItem[i] = NULL;
				}
			}
			m_arShopItem.RemoveAll();
			LeaveCriticalSection( &m_CS_ShopItem );

			::ZeroMemory(m_PersonalShopName, sizeof(m_PersonalShopName));

			CBufferEx TempBuf;
			TempBuf.Add((BYTE)0xEF);
			TempBuf.Add((BYTE)0x07); // Shop Closed
			Send(TempBuf, TempBuf.GetLength());
			PersonalShopClose();
		}
		break;
	case 0x02:
		{
			if(m_state != STATE_GAMESTARTED) return; 
	        if(m_bLive == USER_DEAD) return; 
			
			int iSlot = GetEmptySlot( INVENTORY_SLOT );
		    if( iSlot < 1 ) 
		    {
			SendSystemMsg( "°ü¹ü¿Õ¼äÉÙÓÚ2¸ö¿ÕÎ»ÖÃ£¬ÎÞ·¨¿ªµê! ", SYSTEM_ERROR, TO_ME); 
			m_bPShopOpen = FALSE;
			return;
		    }
			_tcscpy_s(m_strTradeUser, _T(""));//bug  ½»Ò×bug  test
			m_bNowTrading = m_bTradeWaiting = FALSE;
			m_bExchangeOk = m_bTradeItem	= FALSE;// 
			m_iTradeUid = -1;
			m_TradeMoney = 0;				// 

			for(i = 0; i < TOTAL_ITEM_NUM; i++) // 
			{ 
				m_TradeItemNum[i].sSid = -1; 
				m_TradeItemNum[i].sNum = 0; 
			}

			EnterCriticalSection( &m_CS_ExchangeItem );
			for(i = 0; i < m_arExchangeItem.GetSize(); i++)
			{
				if ( m_arExchangeItem[i] )
				{
					delete m_arExchangeItem[i];
					m_arExchangeItem[i] = NULL;
				}
			}
			m_arExchangeItem.RemoveAll();
			LeaveCriticalSection( &m_CS_ExchangeItem );

			///////////////////////////////NPC¸½½ü²»ÔÊÐí¿ªÉèÉÌµê/////////////////////////////////
			int dir[9][2];
			int ix, iy;
			int nTarget = 0;
			CNpc* pNpc = NULL;
			MAP* pMap = g_zone[m_ZoneIndex];
			if(!pMap) return;
			dir[0][0]  =  0;	dir[0][1] =  0;
			dir[1][0]  = -1;	dir[1][1] =  0; 
			dir[2][0]  = -1;	dir[2][1] =  1;	
			dir[3][0]  =  0;	dir[3][1] =  1;
			dir[4][0]  =  1;	dir[4][1] =  1;
			dir[5][0]  =  1;	dir[5][1] =  0;
			dir[6][0]  =  1;	dir[6][1] = -1;
			dir[7][0]  =  0;	dir[7][1] = -1;
			dir[8][0]  = -1;	dir[8][1] = -1; 
			for(i = 1; i < 9; i++)
			{
				ix = m_curx + dir[i][0];
				iy = m_cury + dir[i][1];

				if(ix < 0) ix = 0;
				if(iy < 0) iy = 0;
				if(ix >= pMap->m_sizeMap.cx) ix = pMap->m_sizeMap.cx - 1;
				if(iy >= pMap->m_sizeMap.cy) iy = pMap->m_sizeMap.cy - 1;

				nTarget = pMap->m_pMap[ix][iy].m_lUser;
				if(nTarget >= NPC_BAND)
				{
					pNpc = GetNpc(nTarget - NPC_BAND);
					if(pNpc->m_byType == 1)
					{
						SendSystemMsg("ÔÚNPCÈËÎï¸½½üÎÞ·¨¿ªÆôÉÌµê.",SYSTEM_ERROR,TO_ME);
						m_bPShopOpen = FALSE;
						return;
					}
				}
			}
			//////////////////////////////
		//	m_bPShopOpen = TRUE; // Set TRUE because User now has a personal shop open
			if(!m_MItemLock && o_yehuoini[0]->mimabaohu == 1)
			{
				SendSystemMsg("ÎïÆ·±£»¤ÉÐÎ´½â³ý,Çë°´HOMEÔÚÄÚ¹Ò½â³ý",SYSTEM_ERROR,TO_ME);
				m_bPShopOpen = FALSE;
				return;
			}      ///neo°æ±¾
		     if(!IsCity())
	           {
		         SendEventMsg("±ØÐëÔÚ³ÇÊÐÖÐ²Å¿ÉÒÔ´ò¿ª¸öÈËÉÌµê");
				 m_bPShopOpen = FALSE;
		          return;   
		     }
			////////////////////////////////
			if(m_bNowTrading == TRUE )
			{
				SendSystemMsg( "ÔÚ½»Ò××´Ì¬ÎÞ·¨¿ªÆôÉÌµê", SYSTEM_NORMAL, TO_ME);
				m_bPShopOpen = FALSE;
				return;
			}

			m_bPShopOpen = TRUE; // Set TRUE because User now has a personal shop open
			::ZeroMemory(m_PersonalShopName, sizeof(m_PersonalShopName));
			nNameLength = GetVarString( sizeof( m_PersonalShopName ), m_PersonalShopName, pBuf, index);
	
			if(nNameLength == 0 || nNameLength > SHOP_NAME_LENGTH)	
			{
				SendSystemMsg( IDS_USER_INVALID_SHOP_NAME, SYSTEM_NORMAL, TO_ME);
				m_bPShopOpen = FALSE; // Set FALSE because User now has no personal shop
				return;
			}
			short ItemAmount;
			ItemAmount = GetShort(pBuf, index);
			if (ItemAmount > TOTAL_PERSONALSHOP_ITEM_NUM)
			{
				SendSystemMsg( IDS_USER_INVALID_SHOP_ITEMAMOUNT, SYSTEM_NORMAL, TO_ME);
				m_bPShopOpen = FALSE; // Set FALSE because User now has no personal shop
				return;
			}
			  int dwItemPriceTotal = 0;

             for(i=0;i< ItemAmount;i++)
			{
				short sItemSlot;
				short sItemCount;
				DWORD dwItemPrice;
				sItemSlot = GetShort(pBuf, index);
				if(sItemSlot<10||sItemSlot>34)//ÐÞ¸´¿ªÉÌµêÂôÉíÉÏÎïÆ·³ö´íBUG
				{
					SendEventMsg( "×°±¸ÖÐµÄÎïÆ·ÎÞ·¨··Âô!");
					m_bPShopOpen = FALSE; 
					return ;
				}
				sItemCount = GetShort(pBuf, index);
				dwItemPrice = GetDWORD(pBuf, index);

				if (m_UserItem[sItemSlot].sSid != -1)
				{
					if (sItemCount > m_UserItem[sItemSlot].sCount) 
					{
						SendSystemMsg( IDS_USER_INVALID_SHOP_ITEMCOUNT, SYSTEM_NORMAL, TO_ME);
						m_bPShopOpen = FALSE; // Set FALSE because User now has no personal shop
						SoftClose();
						return;
					}
					///////////////////////////////////////////////////
					if(m_UserItem[sItemSlot].sDuration == 0)
					{
						for(i = 0; i < m_arShopItem.GetSize(); i++)
						{
							if (m_UserItem[sItemSlot].sSid == m_arShopItem[i]->ShopList.sSid)
							{
								m_bPShopOpen = FALSE;
								SoftClose();
								return;
							}
						}
					}
					if (m_UserItem[sItemSlot].sDuration > 0)//ÖØ¸´ÊôÐÔÎïÆ·ÏÞÖÆ ½ûÖ¹Âô
				    {
						if (sItemCount > 1)
						{
						  m_bPShopOpen = FALSE;
						  SoftClose();
						return;
						}				
					}
					if(IsReservedID(m_PersonalShopName))
					{
						SendSystemMsg("ÇëÎðÊäÈëÌØÊâ·ûºÅ",SYSTEM_ERROR,TO_ME);
						m_bPShopOpen = FALSE; // Set FALSE because User now has no personal shop				return;
						::ZeroMemory(m_PersonalShopName, sizeof(m_PersonalShopName));
						return;
					}
					if( g_arItemTable[m_UserItem[sItemSlot].sSid]->m_sEvent >= EVENT_RR_ITEM_BAND)
					{
						SendSystemMsg( "ÈÎÎñÎïÆ·ÎÞ·¨··Âô", SYSTEM_ERROR, TO_ME);
						m_bPShopOpen = FALSE;
						SoftClose();
						return;
					}

					if( (m_dwNoChatTime == 1 || m_dwNoChatTime == 2) && ( m_UserItem[sItemSlot].sSid == 724 || m_UserItem[sItemSlot].sSid == 725) )
					{
						SendEventMsg("±êÖ¾ÉÌµêÄ£Ê½ÎÞ·¨··Âô±êÖ¾!");
						m_bPShopOpen = FALSE;
						return;
					}
					if (sItemSlot<=0 )
					{ 
						::ZeroMemory(m_PersonalShopName, sizeof(m_PersonalShopName));	
						SendSystemMsg( IDS_USER_INVALID_SHOP_ITEMCOUNT, SYSTEM_SPECIAL, TO_ME);
						m_bPShopOpen = FALSE; //"Ã»ÓÐ¿ªÆô¸öÈËÉÌµê.ÒòÎªÉÌµêÎïÆ·ÊýÁ¿ÓëÍæ¼ÒµÄÎïÆ·ÊýÁ¿²»·ûºÏ."
						return;

					}					
					if (sItemCount > m_UserItem[sItemSlot].sCount) 
					{
						::ZeroMemory(m_PersonalShopName, sizeof(m_PersonalShopName));	
						SendSystemMsg( IDS_USER_INVALID_SHOP_ITEMCOUNT, SYSTEM_SPECIAL, TO_ME);
						m_bPShopOpen = FALSE; //"Ã»ÓÐ¿ªÆô¸öÈËÉÌµê.ÒòÎªÉÌµêÎïÆ·ÊýÁ¿ÓëÍæ¼ÒµÄÎïÆ·ÊýÁ¿²»·ûºÏ."
						return;
					}
					
					
						INT64 price = dwItemPrice;
						INT64 tempNum = price * sItemCount; //ÉÌµê×Ü¼Û
						short biaoNum = FindItem(SPECIAL_BIAOZHI);
	                    short JbiaoNum = FindItem(725);

						if( m_dwNoChatTime == 0)
						{
							if (tempNum  +  m_dwDN + dwItemPriceTotal >= 2100000000)
							{
								SendEventMsg( "½ð±ÒÉÌµê×Ü¼ÛÓëÉíÉÏ½ð±ÒÊýÁ¿²»ÄÜ³¬¹ý21ÒÚ!");
								m_bPShopOpen = FALSE; 
							    return;
							}
						}else if( m_dwNoChatTime == 1)
						{
								if (tempNum  + biaoNum + dwItemPriceTotal > 32000)
							{
								SendEventMsg( "±êÖ¾ÉÌµê×Ü¼ÛÓëÉíÉÏ±êÖ¾ÊýÁ¿²»ÄÜ³¬¹ý3.2W!");
								m_bPShopOpen = FALSE; 
							    return;
							}
						}else if( m_dwNoChatTime == 2)
						{
							if (tempNum  + JbiaoNum + dwItemPriceTotal > 32000)
							{
								SendEventMsg( "½ð±êÉÌµê×Ü¼ÛÓëÉíÉÏ½ð±êÊýÁ¿²»ÄÜ³¬¹ý3.2W!");
								m_bPShopOpen = FALSE; 
							    return;
							}
						}
				
					dwItemPriceTotal += (int)tempNum;

					pNewItem = new ShopItem;
					pNewItem->sSlot = sItemSlot;
					pNewItem->dwItemPrice = dwItemPrice;
					pNewItem->ShopList.sLevel = m_UserItem[sItemSlot].sLevel;
					pNewItem->ShopList.sSid = m_UserItem[sItemSlot].sSid;
					pNewItem->ShopList.sDuration = m_UserItem[sItemSlot].sDuration;
					pNewItem->ShopList.sBullNum = m_UserItem[sItemSlot].sBullNum;
					pNewItem->ShopList.sCount =  sItemCount;         //m_UserItem[sItemSlot].sCount;ÐÞ¸´¿ªÉÌµêÐ¡BUG
					
					for(int j =0; j < MAGIC_NUM; j++)
					pNewItem->ShopList.tMagic[j] = m_UserItem[sItemSlot].tMagic[j];
					pNewItem->ShopList.tIQ = m_UserItem[sItemSlot].tIQ;
					pNewItem->ShopList.iItemSerial = m_UserItem[sItemSlot].iItemSerial;

					EnterCriticalSection( &m_CS_ShopItem );
					m_arShopItem.Add(pNewItem);
					LeaveCriticalSection( &m_CS_ShopItem );

					
				}
				else
				{
					m_bPShopOpen = FALSE; // Set FALSE because User now has no personal shop
					return;
				}
			}
			if(m_bPShopOpen == TRUE)
			{
				CBufferEx TempBuf;
				TempBuf.Add((BYTE)0xEF);
				TempBuf.Add((BYTE)0x08);
				Send(TempBuf, TempBuf.GetLength());
				PersonalShopOpen();	
				
			}
			break;
		}
	case 0x03:
		if(m_bPShopOpen == FALSE && m_bViewingAShop == FALSE)
		{
			uid = GetInt(pBuf, index);	
			ViewPersonalShop(0x03, uid);
		}
		break;
	case 0x04:
		PersonalShopBuy(pBuf + index);
		break;
	case 0x05:
		{
			USER* pUser = NULL;
			uid = GetInt(pBuf , index);

			if(uid < 0 || uid >= INVALID_BAND) return;
			pUser = GetUser(uid - USER_BAND);
			if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;
			
			pUser->m_bPShopView = 0;
			pUser->m_iPShopViewuid = -1;	
			m_bViewingAShop = FALSE;
		}
		break;
	case 0x06:
		ViewPersonalShop(0x0B, (m_uid+USER_BAND));
		break;
	default:
		break;
	}
}



void USER::PersonalShopOpen()
{      
	char szDest[40];
	ZeroMemory(szDest,sizeof(szDest));
	strcpy(szDest,m_PersonalShopName);

	if(m_dwNoChatTime == 0)
	{
		char jzb[20] = "[¾öÕ½±Ò]";
		sprintf_s(m_PersonalShopName,"%s%s",jzb,szDest);
	}
	else if(m_dwNoChatTime == 1)
	{
		char bz[20] = "[±êÖ¾]";
		sprintf_s(m_PersonalShopName,"%s%s",bz,szDest);
	} 

		CBufferEx TempBuf;
		TempBuf.Add((BYTE)0xEF);
		TempBuf.Add((BYTE)0x09);
		TempBuf.Add(m_uid + USER_BAND);
		TempBuf.AddString(m_PersonalShopName);
		Send(TempBuf, TempBuf.GetLength());
		SendInsight(TempBuf, TempBuf.GetLength());
}

void USER::PersonalShopClose()
{			
	CBufferEx TempBuf;

	TempBuf.Add((BYTE)0xEF);
	TempBuf.Add((BYTE)0x0A);
	TempBuf.Add(m_uid + USER_BAND);
	Send(TempBuf, TempBuf.GetLength());
	SendInsight(TempBuf, TempBuf.GetLength());
}
/////////////////////////////////////////////////////////////////////
//PK¾ºÈü
//
void USER::CheckPKTime() 
{
	SYSTEMTIME messageTime;
	GetLocalTime(&messageTime);

	DWORD dwCurrTick = GetTickCount();					

	COleDateTime CurrTime = COleDateTime(messageTime); //µ±Ç°Ê±¼ä

      if(o_yehuoini[0]->PKDSKG == 1)
	      {
 //==========================================================================================================
	       if( messageTime.wHour == 20 && messageTime.wMinute < 5 ) //8µã05·Ö¹Ø //
	         {
		if (m_bNowBuddy == TRUE)
		{
			//SendSystemMsg("²Î¼ÓPK´óÈü²»ÄÜ×é¶Ó,ÇëÍË³ö×é¶ÓÔÙ½øÈë£¡", SYSTEM_ERROR, TO_ME);
			SendEventMsg("²Î¼ÓPK´óÈü²»ÄÜ×é¶Ó,ÇëÍË³ö×é¶ÓÔÙ½øÈë£¡");
			return;
		}
		else if(m_isUser)	
		{
			//SendSystemMsg("½øÈëPK³¡Ç°²»ÄÜ´ò¿ªPK×´Ì¬£¬Çë¹Ø±ÕºóÔÙ½øÈë£¡", SYSTEM_ERROR, TO_ME);
            SendEventMsg("½øÈëPK³¡Ç°²»ÄÜ´ò¿ªPK×´Ì¬£¬Çë¹Ø±ÕºóÔÙ½øÈë£¡");
			return;
		}
		else
		ZoneMoveReq( 67, 36, 28);
	}
//==================================================================================================
	else
	{
	   SendEventMsg("PKÍõÈü³¡´¦ÓÚ¹Ø±Õ×´Ì¬,ÍíÉÏ20:00-20:05¿ª·Å½øÈë!");
	  }

    } 
	  else 
		   SendEventMsg("»¹Î´µ½PK´óÈüÊ±¼ä!");

   
}

/////////////////////////////////////////////////////////
//PKÉ±ÈË¿ñ
//
void USER::CheckPKShaRen() 
{
	SYSTEMTIME messageTime;
	GetLocalTime(&messageTime);

	DWORD dwCurrTick = GetTickCount();					

	COleDateTime CurrTime = COleDateTime(messageTime); //µ±Ç°Ê±¼ä



	if( messageTime.wHour == 20 && messageTime.wMinute>=20  && messageTime.wMinute < 50) //8µã50·Ö¹Ø
	{
		if (m_bNowBuddy == TRUE)
		{
			//SendSystemMsg("²Î¼ÓPKÉ±ÈË¿ñ´óÈü,ÇëÍË³ö×é¶ÓÔÙ½øÈë£¡", SYSTEM_ERROR, TO_ME);
			SendEventMsg("²Î¼ÓPKÉ±ÈË¿ñ´óÈü,ÇëÍË³ö×é¶ÓÔÙ½øÈë£¡");
			return;
		}
		else
		{
			int x; int y; int random;
			random = myrand( 1,10);
			switch(random)
			{
			case	1:
				x =14,y=36;
				break;
			case	2:
				x =4,y=48;
				break;
			case	3:
				x =10,y=62;
				break;
			case	4:
				x =34,y=58;
				break;
			case	5:
				x =46,y=42;
				break;
			case	6:
				x =34,y=28;
				break;
			case	7:
				x =26,y=40;
				break;
			case	8:
				x =19,y=51;
				break;
			case	9:
				x =13,y=57;
				break;
			case	10:
				x =29,y=51;
				break;
			}
			ZoneMoveReq( 66, x, y);
		}
			
		
	}
	else
	{
		//SendSystemMsg("É±ÈË¿ñ´óÈüÒÑ¹Ø±Õ,ÍíÉÏ20:20-20:50¿ª·Å½øÈë!", SYSTEM_ERROR, TO_ME);
		SendEventMsg("É±ÈË¿ñ´óÈüÒÑ¹Ø±Õ,ÍíÉÏ20:20-20:50¿ª·Å½øÈë!");
	}
}
void USER::ViewYuanBaoShop(int start)
{
	CString strTemp;
	strTemp.Format( "ÄúµÄ¾öÕ½±ÒÊýÁ¿Îª: %d ", m_dwDN);
	SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);
	
	int k = 0;
	m_dwYuanBaoStart =start;
	CBufferEx TempBuf;
	CBufferEx TempBuf2;
	DWORD dwTemp = 0;
	int end = start + 7;
	if(end > g_arSxOnlineShopTable.GetSize())
		end = g_arSxOnlineShopTable.GetSize();
		for(int i = start; i < end ;i++)
		{
			if(g_arSxOnlineShopTable[i]->m_iSid==0)
			{
				continue;
			}
			TempBuf2.Add((DWORD)g_arSxOnlineShopTable[i]->m_prices);
			TempBuf2.Add((short)g_arSxOnlineShopTable[i]->m_sLevel);
			TempBuf2.Add((short)g_arSxOnlineShopTable[i]->m_iSid);
			TempBuf2.Add((short)g_arSxOnlineShopTable[i]->m_sDuration);
			TempBuf2.Add((short)g_arSxOnlineShopTable[i]->m_sBullNum);
			TempBuf2.Add((short)g_arSxOnlineShopTable[i]->m_iNum);
			TempBuf2.Add((short)g_arSxOnlineShopTable[i]->m_oSid);

			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx1);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx2);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx3);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx4);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx5);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_upgrade);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx6);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx7);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx8);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx9);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_sx10);
			TempBuf2.Add((BYTE)g_arSxOnlineShopTable[i]->m_tIQ);
			k++;
		}
	
	TempBuf.Add((BYTE)0xEF);
	TempBuf.Add((BYTE)0x03);
	TempBuf.Add(m_uid + USER_BAND);
	TempBuf.Add((BYTE)k);
	TempBuf.Add((BYTE)0x00);
	TempBuf.AddData(TempBuf2, TempBuf2.GetLength());
	Send(TempBuf, TempBuf.GetLength());
	return;
}
void USER::ViewPersonalShop(BYTE mode, int uid)
{
	CBufferEx TempBuf;
	CBufferEx TempBuf2;
	USER* pUser = NULL;
    int i, n;
	n = 0;
	
	if(uid < 0 || uid >= INVALID_BAND) return;

	pUser = GetUser(uid - USER_BAND);
	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;

	if(mode == 0x03)
	{
		if ( pUser->m_UserStatus == 0 && pUser->m_UserFlag == FALSE )
		{
			goto fail_result;
		}	

		if( strcmp(pUser->m_PersonalShopName, "") == 0) 
		{
			goto fail_result;
		}

		if(pUser->m_iPShopViewuid != -1)
		{
			USER* pUser2 = NULL;
			pUser2 = GetUser(pUser->m_iPShopViewuid);
			if(pUser2 == NULL || pUser2->m_state != STATE_GAMESTARTED)
			{
				pUser->m_bPShopView = FALSE;
				pUser->m_iPShopViewuid = -1;
			}
			else if(pUser2->m_bViewingAShop == FALSE)
			{
				pUser->m_bPShopView = FALSE;
				pUser->m_iPShopViewuid = -1;
			}
		}

		if(pUser->m_bPShopView == TRUE)
		{
			SendSystemMsg( IDS_USER_INVALID_SHOP_BEINGVIEWED, SYSTEM_NORMAL, TO_ME);
			return;
		}

		if(InterlockedCompareExchange((LONG*)&pUser->m_bPShopView, (long)1, (long)0) == (long)0)
		{
			InterlockedExchange((LONG*)&pUser->m_iPShopViewuid, (LONG)m_uid); // Set uid so that can keep track of who is viewing shop
			m_bViewingAShop = TRUE;
			if(pUser->m_dwNoChatTime == 0)
			{
				SendEventMsg("´ËÉÌµêÄ£Ê½Îª[¾öÕ½±Ò]");
			}else if(pUser->m_dwNoChatTime == 1)
			{
				SendEventMsg("´ËÉÌµêÄ£Ê½Îª[±êÖ¾]");
			}else if(pUser->m_dwNoChatTime == 2)
			{
				SendEventMsg("´ËÉÌµêÄ£Ê½Îª[½ð±ê] ±êÖ¾Óë½ð±ê±ÈÀý1:1000");
			}
		}

		if(pUser->m_bPShopView == FALSE)
		{
			goto fail_result;
		}
	}

	EnterCriticalSection( &pUser->m_CS_ShopItem );
	for(i = 0; i < pUser->m_arShopItem.GetSize(); i++)
	{
		if ( pUser->m_arShopItem[i] == NULL ) continue;

		TempBuf2.Add(pUser->m_arShopItem[i]->dwItemPrice);
		TempBuf2.Add(pUser->m_arShopItem[i]->ShopList.sLevel);
		TempBuf2.Add(pUser->m_arShopItem[i]->ShopList.sSid);
		TempBuf2.Add(pUser->m_arShopItem[i]->ShopList.sDuration);
		TempBuf2.Add(pUser->m_arShopItem[i]->ShopList.sBullNum);
		TempBuf2.Add(pUser->m_arShopItem[i]->ShopList.sCount);
		TempBuf2.Add(pUser->m_arShopItem[i]->sSlot);

		for(int j =0; j < MAGIC_NUM; j++)
			TempBuf2.Add(pUser->m_arShopItem[i]->ShopList.tMagic[j]);
		TempBuf2.Add(pUser->m_arShopItem[i]->ShopList.tIQ);

		n++;
	}
	LeaveCriticalSection(&pUser->m_CS_ShopItem);

	TempBuf.Add((BYTE)0xEF);
	TempBuf.Add((BYTE)mode);
	TempBuf.Add(uid);
	TempBuf.Add((BYTE)n);
	TempBuf.Add((BYTE)0x00);
	TempBuf.AddData(TempBuf2, TempBuf2.GetLength());
	Send(TempBuf, TempBuf.GetLength());
	return;

fail_result:
	pUser->m_bPShopView = 0;
	pUser->m_iPShopViewuid = -1;
	m_bViewingAShop = FALSE;
}

void USER::PersonalShopBuy(TCHAR* pBuf)  ///neo°æ±¾
{
	CString strMsg;

	CBufferEx TempBuf;
	CBufferEx TempBuf2;
	USER* pUser = NULL;
	BYTE result = FAIL;
	DWORD TotalCost = 0;
	ShopItem* ShopBackupItem[TOTAL_PERSONALSHOP_ITEM_NUM];
	short sShopAmount, sUserSlot, sShopCount, sShopSid = -1;
	ItemList		TempItem;
	ItemList		BuyerItem[TOTAL_ITEM_NUM], ShopItem[TOTAL_ITEM_NUM];
	ItemListArray	arItemListBuyer, arItemListShop;
	CWordArray		arEmptySlotBuyer, arSameSlotBuyer, arEmptySlotShop, arSameSlotShop;

    int i,k, j, n, index = 0, iWeight = 0, iSameSlot, iEmptySlot, iWeightOwner, ShopSize;
	n = 0;

	int uid = GetInt(pBuf, index);
	
	if(uid == m_uid + USER_BAND  ) //µ÷ÓÃÏÔÊ¾ÊôÐÔµÄÔª±¦ÉÌµê
	{
					
					sShopAmount = GetShort(pBuf, index);
					if(sShopAmount >TOTAL_PERSONALSHOP_ITEM_NUM)
						return ;
					for(k = 0; k < sShopAmount; k++)
					{
						
						sUserSlot = GetShort(pBuf, index);
						sShopCount = GetShort(pBuf, index);
					    DWORD ItemPrice;
						CWordArray		arEmptySlot, arSameSlot;
						int iSlot = GetEmptySlot( INVENTORY_SLOT );
			            
						if( iSlot < 0 ) 
						{
							SendSystemMsg( IDS_USER_SHOP_NO_IVEN_SLOT, SYSTEM_ERROR, TO_ME); //"Ã»ÓÐ×ã¹»µÄ°ü¹ü¿Õ¼ä¹ºÂòÕâ¼Ò¸öÈËÉÌµêµÄÎïÆ·."
							return;
						}

						ReSetItemSlot( &m_UserItem[iSlot]);
						
						for(int i = m_dwYuanBaoStart; i < g_arSxOnlineShopTable.GetSize();i++)
						{
						  if(m_dwGuarDianTianShi > 0)//Èç¹ûÊÇVIP¹ºÎï9ÕÛ
			              {
							if(sUserSlot == g_arSxOnlineShopTable[i]->m_oSid)
							{
								TotalCost=0;
								///////////////////////////////½­ºþ
						if (sShopCount > g_arSxOnlineShopTable[i]->m_iNum || sShopCount <= 0)	
						         return;
                         ///////////////////////////////////½­ºþ
								ItemPrice =(DWORD)g_arSxOnlineShopTable[i]->m_prices;
								int iCost = (int)(g_arSxOnlineShopTable[i]->m_prices * 0.9);//VIPÔÚÔ­»ù´¡ÉÏX9ÕÛ
								DWORD dwCast= (ItemPrice-iCost)*sShopCount;//ÓÅ»ÝÖµ
								TotalCost += (iCost * sShopCount);
								//if(TotalCost > m_dwShopPingDN )
								if(TotalCost > m_dwDN )
								{
									SendSystemMsg( IDS_SHOPDN_ERROR, SYSTEM_ERROR, TO_ME); //"ÄãÃ»ÓÐ×ã¹»µÄ [ Ôª ±¦ ] ¹ºÂò´ËÎïÆ·."
									return;
								}

								m_UserItem[iSlot].sLevel = g_arSxOnlineShopTable[i]->m_sLevel;
								m_UserItem[iSlot].sSid = g_arSxOnlineShopTable[i]->m_iSid;
								m_UserItem[iSlot].sCount = sShopCount;
								m_UserItem[iSlot].sDuration = g_arSxOnlineShopTable[i]->m_sDuration;
								m_UserItem[iSlot].sBullNum = g_arSxOnlineShopTable[i]->m_sBullNum;

								m_UserItem[iSlot].tMagic[0] = (BYTE)g_arSxOnlineShopTable[i]->m_sx1;
								m_UserItem[iSlot].tMagic[1] = (BYTE)g_arSxOnlineShopTable[i]->m_sx2;
								m_UserItem[iSlot].tMagic[2] = (BYTE)g_arSxOnlineShopTable[i]->m_sx3;
								m_UserItem[iSlot].tMagic[3] = (BYTE)g_arSxOnlineShopTable[i]->m_sx4;
								m_UserItem[iSlot].tMagic[4] = (BYTE)g_arSxOnlineShopTable[i]->m_sx5;
								m_UserItem[iSlot].tMagic[5] =(BYTE)g_arSxOnlineShopTable[i]->m_upgrade;
								m_UserItem[iSlot].tMagic[6] =(BYTE)g_arSxOnlineShopTable[i]->m_sx6; //Ôö¼Ó»ú¼×ÊôÐÔµÄÏÔÊ¾
								m_UserItem[iSlot].tMagic[7] =(BYTE)g_arSxOnlineShopTable[i]->m_sx7;
								m_UserItem[iSlot].tMagic[8] =(BYTE)g_arSxOnlineShopTable[i]->m_sx8;
								m_UserItem[iSlot].tMagic[9] =(BYTE)g_arSxOnlineShopTable[i]->m_sx9;
								m_UserItem[iSlot].tMagic[10] =(BYTE)g_arSxOnlineShopTable[i]->m_sx10;
								m_UserItem[iSlot].tIQ = (BYTE)g_arSxOnlineShopTable[i]->m_tIQ;		//»ú¼×ÎªIQ£º13
								m_UserItem[iSlot].iItemSerial = 0;	

								//m_dwShopPingDN -= TotalCost;
								//SendUserStatusSkill();
								m_dwDN -= TotalCost;
								UpdateUserItemDN();
								SendMoneyChanged();
                                arEmptySlot.Add(iSlot); 
								UpdateInvenSlot(&arEmptySlot, &arSameSlot);

								CString strMsg= "";
					            strMsg.Format("¹º[%s]¿Û%d¾öÕ½±Ò,½ÚÊ¡%d¾öÕ½±Ò",g_arSxOnlineShopTable[i]->m_iSname,TotalCost,dwCast);
					            SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg,SYSTEM_ERROR,TO_ME);
				                CString strTemp;
					            strTemp.Format( "ÄúµÄ¾öÕ½±ÒÊ£ÓàÊýÁ¿Îª: %d ", m_dwShopPingDN);
					            SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);

							}
						  }else
							if(sUserSlot == g_arSxOnlineShopTable[i]->m_oSid)
							{
								TotalCost=0;
								
								ItemPrice =(DWORD)g_arSxOnlineShopTable[i]->m_prices;
								TotalCost += (ItemPrice * sShopCount);
								//if(TotalCost > m_dwShopPingDN )
								if(TotalCost > m_dwDN )

								{
									SendSystemMsg( IDS_SHOPDN_ERROR, SYSTEM_ERROR, TO_ME); //"ÄãÃ»ÓÐ×ã¹»µÄ [ Ôª ±¦ ] ¹ºÂò´ËÎïÆ·."
									return;
								}

								m_UserItem[iSlot].sLevel = g_arSxOnlineShopTable[i]->m_sLevel;
								m_UserItem[iSlot].sSid = g_arSxOnlineShopTable[i]->m_iSid;
								m_UserItem[iSlot].sCount = sShopCount;
								m_UserItem[iSlot].sDuration = g_arSxOnlineShopTable[i]->m_sDuration;
								m_UserItem[iSlot].sBullNum = g_arSxOnlineShopTable[i]->m_sBullNum;

								m_UserItem[iSlot].tMagic[0] = (BYTE)g_arSxOnlineShopTable[i]->m_sx1;
								m_UserItem[iSlot].tMagic[1] = (BYTE)g_arSxOnlineShopTable[i]->m_sx2;
								m_UserItem[iSlot].tMagic[2] = (BYTE)g_arSxOnlineShopTable[i]->m_sx3;
								m_UserItem[iSlot].tMagic[3] = (BYTE)g_arSxOnlineShopTable[i]->m_sx4;
								m_UserItem[iSlot].tMagic[4] = (BYTE)g_arSxOnlineShopTable[i]->m_sx5;
								m_UserItem[iSlot].tMagic[5] =(BYTE)g_arSxOnlineShopTable[i]->m_upgrade;
								m_UserItem[iSlot].tMagic[6] =(BYTE)g_arSxOnlineShopTable[i]->m_sx6; //Ôö¼Ó»ú¼×ÊôÐÔµÄÏÔÊ¾
								m_UserItem[iSlot].tMagic[7] =(BYTE)g_arSxOnlineShopTable[i]->m_sx7;
								m_UserItem[iSlot].tMagic[8] =(BYTE)g_arSxOnlineShopTable[i]->m_sx8;
								m_UserItem[iSlot].tMagic[9] =(BYTE)g_arSxOnlineShopTable[i]->m_sx9;
								m_UserItem[iSlot].tMagic[10] =(BYTE)g_arSxOnlineShopTable[i]->m_sx10;
								m_UserItem[iSlot].tIQ = (BYTE)g_arSxOnlineShopTable[i]->m_tIQ;		//»ú¼×ÎªIQ£º13
								m_UserItem[iSlot].iItemSerial = 0;	

								//m_dwShopPingDN -= TotalCost;
								//SendUserStatusSkill();
								m_dwDN -= TotalCost;
								UpdateUserItemDN();
								SendMoneyChanged();

								arEmptySlot.Add(iSlot); 
								UpdateInvenSlot(&arEmptySlot, &arSameSlot);

								CString strMsg= "";
					            strMsg.Format("Äú¹ºÂò[%s] ¼õÉÙ%d¾öÕ½±Ò£¨²»ÊÇVIPÓÃ»§ÎÞÈÎºÎÕÛ¿Û£©",g_arSxOnlineShopTable[i]->m_iSname,TotalCost);
					            SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg,SYSTEM_ERROR,TO_ME);
					            CString strTemp;
					            strTemp.Format( "ÄúµÄ¾öÕ½±ÒÊ£ÓàÊýÁ¿Îª: %d ", m_dwShopPingDN);
					            SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);	

							}

						}

					}

					return;

	}
    else				//¸öÈËÉÌµê
	{
	pUser = GetUser(uid - USER_BAND);
	short biaoNum = FindItem(SPECIAL_BIAOZHI);
	short JbiaoNum = FindItem(725);
   

	if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) return;

	if ( pUser->m_UserStatus == 0 && pUser->m_UserFlag == FALSE ) return;

	if( strcmp(pUser->m_PersonalShopName, "") == 0) return; 
	
	for(i = 0; i < TOTAL_ITEM_NUM; i++)			// Backup Inven data
	{
		BuyerItem[i] = m_UserItem[i];
		ShopItem[i] = pUser->m_UserItem[i];
	}

	EnterCriticalSection( &pUser->m_CS_ShopItem );
	ShopSize = pUser->m_arShopItem.GetSize();
	if(ShopSize >TOTAL_PERSONALSHOP_ITEM_NUM) {
		LeaveCriticalSection( &pUser->m_CS_ShopItem );
		return ;
	}
	for(i = 0; i < ShopSize; i++)
	{
		ShopBackupItem[i] = pUser->m_arShopItem[i];
	}
	LeaveCriticalSection( &pUser->m_CS_ShopItem );
	
	sShopAmount = GetShort(pBuf, index);
	if(sShopAmount >TOTAL_PERSONALSHOP_ITEM_NUM)
		return ;
    if(pUser->m_bNowTrading == TRUE || pUser->m_bPShopOpen == FALSE) return;

	for(k = 0; k < sShopAmount; k++)
	{
		// Source Item
		sUserSlot = GetShort(pBuf, index);
		sShopCount = GetShort(pBuf, index);

		if ( pUser->m_UserItem[sUserSlot].sSid == -1 ) goto fail_result;
		if(sUserSlot < EQUIP_ITEM_NUM || sUserSlot >= TOTAL_INVEN_MAX) goto fail_result;		
		if ( pUser->m_UserItem[sUserSlot].sCount < sShopCount ) goto fail_result;

		sShopSid = pUser->m_UserItem[sUserSlot].sSid;
		if( sShopSid < 0 || sShopSid >= g_arItemTable.GetSize() ) goto fail_result;
		if( sShopCount <= 0 ) goto fail_result;

		// Get Item Cost
		DWORD ItemPrice;
		EnterCriticalSection( &pUser->m_CS_ShopItem );
		for(int i = 0; i < pUser->m_arShopItem.GetSize(); i++)
		{
			if(pUser->m_arShopItem[i]->sSlot == sUserSlot)
			{
				ItemPrice = pUser->m_arShopItem[i]->dwItemPrice;
				break;
			}
		}
		LeaveCriticalSection(&pUser->m_CS_ShopItem);

		//Update Dina
		TotalCost += (ItemPrice * sShopCount);
		if((ItemPrice * sShopCount) >= 2147483647 || (ItemPrice * sShopCount) < 0) return;
		////////////////////////½»Ò×ÃÜÂë
		if(!m_MItemLock && o_yehuoini[0]->mimabaohu == 1 ){ SendSystemMsg( "½â³ý[°²È«Ëø]ºó,²ÅÄÜ¹ºÂòÕâ¼Ò¸öÈËÉÌµêµÄÎïÆ·!.", SYSTEM_ERROR, TO_ME);goto fail_result;}

		if ( m_bPShopOpen == TRUE || pUser->m_bPShopOpen == FALSE || m_bNowTrading == TRUE || pUser->m_bNowTrading == TRUE)
		{
			goto fail_result; //Î´ÖªBUG
			
		}
		if (TotalCost <= 0) goto fail_result;
		if (pUser->m_dwNoChatTime == 0)
			{
				if(TotalCost > m_dwDN)
				{
					 SendEventMsg("Ã»ÓÐ×ã¹»µÄ[¾öÕ½±Ò¹ºÂò]");
					goto fail_result;//"Ã»ÓÐ×ã¹»µÄ½ðÇ®¹ºÂòÕâ¼Ò¸öÈËÉÌµêµÄÎïÆ·."
				}
			}
		 else if(pUser->m_dwNoChatTime == 1)
			{
				if((int)TotalCost > biaoNum)
				{
					 SendEventMsg("Ã»ÓÐ×ã¹»µÄ[±êÖ¾]¹ºÂò!");
					goto fail_result;
				}
			}
		else if(pUser->m_dwNoChatTime == 2)
			{
				if((int)TotalCost > JbiaoNum)
				{
					SendEventMsg("Ã»ÓÐ×ã¹»µÄ[½ð±ê]¹ºÂò!");
					goto fail_result;
				}
			}
		 
		iWeight = 0;
		iWeight = g_arItemTable[sShopSid]->m_byWeight * sShopCount;
		if(m_iMaxWeight < m_iCurWeight + iWeight)
		{
			SendSystemMsg( IDS_USER_SHOP_NOTENOUGH_WEIGHT, SYSTEM_ERROR, TO_ME);
			goto fail_result;
		}

		ReSetItemSlot(&TempItem);
		TempItem = pUser->m_UserItem[sUserSlot];
		TempItem.sCount = sShopCount;

		if(TempItem.sSid < 0 || TempItem.sSid >= g_arItemTable.GetSize()) goto fail_result;
		///////////////////////////////////////////////´Ì¼¤
		CString strDate ="";
			SYSTEMTIME st;
			GetLocalTime(&st);
			strDate.Format("%d-%d-%d %d:%d:%d [%s]¹ºÂò[%s]ÉÌµêµÄ[%s], %d %d %d %d %d %d %d %d %d %d %d %d %d %d",st.wYear,st.wMonth,st.wDay ,st.wHour,
				st.wMinute,st.wSecond,m_strUserID,pUser->m_strUserID,g_arItemTable[TempItem.sSid]->m_strName,
				TempItem.sSid,sShopCount,TempItem.tMagic[5],TempItem.tIQ,TempItem.tMagic[0],TempItem.tMagic[1],TempItem.tMagic[2],
				TempItem.tMagic[3],TempItem.tMagic[4],TempItem.tMagic[6],TempItem.tMagic[7],TempItem.tMagic[8],TempItem.tMagic[9],TempItem.tMagic[10]);
			TCHAR m_Log[500];
			if(pUser->m_bSessionOnline && pUser->m_dwNoChatTime == 0)
			{
				sprintf_s(m_Log,"%s ÀëÏß¼Û¸ñ:%d ¾öÕ½±Ò,ÊýÁ¿ %d¸ö,Î»ÖÃ:%d\r\n",strDate,ItemPrice,sShopCount,sUserSlot);
			}
			
			else if(pUser->m_bSessionOnline && pUser->m_dwNoChatTime == 1)
			{
				sprintf_s(m_Log,"%s ÀëÏß¼Û¸ñ:%d ±êÖ¾,ÊýÁ¿ %d¸ö,Î»ÖÃ:%d\r\n",strDate,ItemPrice,sShopCount,sUserSlot);
			}
			else if(pUser->m_bSessionOnline && pUser->m_dwNoChatTime == 2)
			{
				sprintf_s(m_Log,"%s ÀëÏß¼Û¸ñ:%d ½ð±ê,ÊýÁ¿ %d¸ö,Î»ÖÃ:%d\r\n",strDate,ItemPrice,sShopCount,sUserSlot);
			}
			else if( pUser->m_dwNoChatTime == 0)
			{
				sprintf_s(m_Log,"%s ¼Û¸ñ:%d ¾öÕ½±Ò,ÊýÁ¿ %d¸ö,Î»ÖÃ:%d\r\n",strDate,ItemPrice,sShopCount,sUserSlot);
			}
			else if( pUser->m_dwNoChatTime == 1)
			{
				sprintf_s(m_Log,"%s ¼Û¸ñ:%d ±êÖ¾,ÊýÁ¿ %d¸ö,Î»ÖÃ:%d\r\n",strDate,ItemPrice,sShopCount,sUserSlot);
			}
			else if( pUser->m_dwNoChatTime == 2)
			{
				sprintf_s(m_Log,"%s ¼Û¸ñ:%d ½ðÖ¾,ÊýÁ¿ %d¸ö,Î»ÖÃ:%d\r\n",strDate,ItemPrice,sShopCount,sUserSlot);
			}

			WriteUserShopLog(m_Log);
			///////////////////////////////////////////////////±êÖ¾¼ÇÂ¼999
		
		///////////////////////////////////////////////////´Ì¼¤
		iSameSlot = GetSameItem(TempItem, INVENTORY_SLOT);

		if(iSameSlot == -1)
		{
			iEmptySlot = GetEmptySlot(INVENTORY_SLOT);
			if(iEmptySlot == -1)		
			{
				SendSystemMsg( IDS_USER_SHOP_NO_IVEN_SLOT, SYSTEM_ERROR, TO_ME);
				goto fail_result;
			}

			m_UserItem[iEmptySlot] = TempItem;

			m_UserItem[iEmptySlot].sSid = TempItem.sSid;
			//////////////////////////////////////////////////////½­ºþ
			if (m_UserItem[iEmptySlot].sSid < 0 || m_UserItem[iEmptySlot].sSid >= g_arItemTable.GetSize()) goto fail_result;
			////////////////////////////////////////////////////////////
		
			m_UserItem[iEmptySlot].sLevel  = TempItem.sLevel;
			m_UserItem[iEmptySlot].sBullNum  = TempItem.sBullNum;
			m_UserItem[iEmptySlot].sDuration  = TempItem.sDuration;
			m_UserItem[iEmptySlot].sCount  = TempItem.sCount;
			for(j =0; j < MAGIC_NUM; j++) m_UserItem[iEmptySlot].tMagic[j] = TempItem.tMagic[j];
			m_UserItem[iEmptySlot].tIQ = TempItem.tIQ; 
			m_UserItem[iEmptySlot].iItemSerial = TempItem.iItemSerial;
			iWeightOwner = (g_arItemTable[m_UserItem[iEmptySlot].sSid]->m_byWeight * sShopCount);
			arEmptySlotBuyer.Add((BYTE)iEmptySlot);
		}
		else								
		{
			m_UserItem[iSameSlot].sSid = TempItem.sSid;
			if(m_UserItem[iSameSlot].sSid < 0 || m_UserItem[iSameSlot].sSid >= g_arItemTable.GetSize()) goto fail_result;
			m_UserItem[iSameSlot].sLevel  = TempItem.sLevel;
			m_UserItem[iSameSlot].sBullNum  = TempItem.sBullNum;
			m_UserItem[iSameSlot].sDuration  = TempItem.sDuration;
			CheckMaxValue((short &)m_UserItem[iSameSlot].sCount,(short)TempItem.sCount);

			for(j =0; j < MAGIC_NUM; j++) m_UserItem[iSameSlot].tMagic[j] = TempItem.tMagic[j];
			m_UserItem[iSameSlot].tIQ = TempItem.tIQ; 
			m_UserItem[iSameSlot].iItemSerial = TempItem.iItemSerial;
			iWeightOwner = (g_arItemTable[m_UserItem[iSameSlot].sSid]->m_byWeight * sShopCount);
			arSameSlotBuyer.Add((BYTE)iSameSlot);
		}

		// Update Shop Owner weight
		
		//MakeItemLog( &m_UserItem[tSlot], ITEMLOG_EXCHANGE_GIVE, pUser->m_strUserID );

		pUser->ReSetItemSlot(&TempItem);
		TempItem = pUser->m_UserItem[sUserSlot];
		TempItem.sCount = sShopCount;

		if(TempItem.sSid < 0 || TempItem.sSid >= g_arItemTable.GetSize()) goto fail_result;
		iSameSlot = pUser->GetSameItem(TempItem, INVENTORY_SLOT);
		if(iSameSlot == -1)
		{
			//MakeItemLog( &m_UserItem[iEmptySlot], ITEMLOG_EXCHANGE_RECEIVE, pUser->m_strUserID );
			pUser->ReSetItemSlot( &pUser->m_UserItem[sUserSlot] );
			EnterCriticalSection( &pUser->m_CS_ShopItem );
			for(int l = 0; l < pUser->m_arShopItem.GetSize(); l++)
			{
				if(pUser->m_arShopItem[l]->sSlot == sUserSlot)
				{
					pUser->m_arShopItem.RemoveAt(l);
					break;
				}
			}
			LeaveCriticalSection(&pUser->m_CS_ShopItem);

			arEmptySlotShop.Add((BYTE)sUserSlot);

		}
		else								
		{
			if(pUser->m_UserItem[iSameSlot].sCount - TempItem.sCount < 0) 
			{
				goto fail_result;
			}
			else if(pUser->m_UserItem[iSameSlot].sCount - TempItem.sCount == 0)
			{
				pUser->ReSetItemSlot( &pUser->m_UserItem[sUserSlot] );
			}
			/////////////////////////////////////////½­ºþ
		    else if(pUser->m_UserItem[iSameSlot].sCount < TempItem.sCount) //bug 
				{
					goto fail_result;
				}
             //////////////////////////////////////////////
			else
			{
				pUser->m_UserItem[iSameSlot].sCount -= TempItem.sCount;
                if(pUser->m_UserItem[iSameSlot].sCount < 0)pUser->m_UserItem[iSameSlot].sCount = 0;
				pUser->m_UserItem[iSameSlot].sSid = pUser->m_UserItem[iSameSlot].sSid;
				pUser->m_UserItem[iSameSlot].sLevel = pUser->m_UserItem[iSameSlot].sLevel;
				pUser->m_UserItem[iSameSlot].sBullNum = pUser->m_UserItem[iSameSlot].sBullNum;
				pUser->m_UserItem[iSameSlot].sDuration = pUser->m_UserItem[iSameSlot].sDuration;
				pUser->m_UserItem[iSameSlot].sCount = pUser->m_UserItem[iSameSlot].sCount;
			
				for(j =0; j < MAGIC_NUM; j++) pUser->m_UserItem[iSameSlot].tMagic[j] = pUser->m_UserItem[iSameSlot].tMagic[j];
				pUser->m_UserItem[iSameSlot].tIQ = pUser->m_UserItem[iSameSlot].tIQ; 
				pUser->m_UserItem[iSameSlot].iItemSerial = pUser->m_UserItem[iSameSlot].iItemSerial;
			}
			EnterCriticalSection( &pUser->m_CS_ShopItem );
			for(int l = 0; l < pUser->m_arShopItem.GetSize(); l++)
			{
				if(pUser->m_arShopItem[l]->sSlot == sUserSlot)
				{
					if(pUser->m_arShopItem[l]->ShopList.sCount - TempItem.sCount == 0)
					{
						pUser->m_arShopItem.RemoveAt(l);
					}
					/////////////////////////////////////////////////½­ºþ
					else if(pUser->m_arShopItem[l]->ShopList.sCount < TempItem.sCount)
						{
							LeaveCriticalSection(&pUser->m_CS_ShopItem);				//bug 
							goto fail_result;
						}
					//////////////////////////////////////////////////////////

					else
					{
						pUser->m_arShopItem[l]->ShopList.sCount -= TempItem.sCount;
						////////////////////////////////½­ºþ
						if(pUser->m_arShopItem[l]->ShopList.sCount < 0) pUser->m_arShopItem[l]->ShopList.sCount = 0;
						///////////////////////////////////////

					}
					break;
				}
			}
			LeaveCriticalSection(&pUser->m_CS_ShopItem);

			arSameSlotShop.Add((BYTE)iSameSlot);
		}
	}

	

	if (TotalCost <= 0 || TotalCost>= 2147483647)return;//¼ì²âÊý¾ÝÒç³öÎ»ÖÃ¶þ
			

	if (pUser->m_dwNoChatTime == 0)//¸öÈË½ð±ÒÉÌµê
	{
	    if( TotalCost>m_dwDN)  return ;
        pUser->m_dwDN += TotalCost;//Update Buyer and Shop
		pUser->m_iCurWeight -= iWeightOwner;
		if(pUser->m_iCurWeight < 0) pUser->m_iCurWeight = 0;
		pUser->SendMoneyChanged();
		pUser->GetRecoverySpeed();
		pUser->UpdateInvenSlot(&arEmptySlotShop, &arSameSlotShop);
		m_dwDN -= TotalCost;
		if(m_dwDN<0) m_dwDN=0;
		m_iCurWeight += iWeight;
		SendMoneyChanged();
		GetRecoverySpeed();
		UpdateInvenSlot(&arEmptySlotBuyer, &arSameSlotBuyer);
		pUser->UpdateUserItemDN();
		UpdateUserItemDN();
		pUser->m_bPShopView = 0;
		pUser->m_iPShopViewuid = -1;
		m_bViewingAShop = FALSE;
	}
	else if (pUser->m_dwNoChatTime == 1)
	{
		if ((int)TotalCost > biaoNum)  return ;
		BYTE SOLT = pUser->FindItem(SPECIAL_BIAOZHI);

		pUser->GiveItemAll(SPECIAL_BIAOZHI,TotalCost,0,0,0,0,0,0,0,0,0,0,0);
		pUser->m_iCurWeight -= iWeightOwner;
		if(pUser->m_iCurWeight < 0) pUser->m_iCurWeight = 0;
		pUser->GetRecoverySpeed();
		pUser->UpdateInvenSlot(&arEmptySlotShop, &arSameSlotShop);
        RobItem(SPECIAL_BIAOZHI,TotalCost);
		if(( FindItem(SPECIAL_BIAOZHI) < 0)) return;
		m_iCurWeight += iWeight;
		GetRecoverySpeed();
		UpdateInvenSlot(&arEmptySlotBuyer, &arSameSlotBuyer);
        ///////////////////////////////////////////////////////////±êÖ¾¼ÇÂ¼88888
		CString str = _T("");
        SYSTEMTIME st;
		CString strDate;
		GetLocalTime(&st);
		strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
        str.Format("[%s]Íæ¼Ò [%s]Âô¶«Î÷»ñµÃ±ê %d  \r\n",strDate,pUser->m_strUserID,TotalCost);
		EnterCriticalSection( &m_CS_FileWrite );
		g_fpSpeedHack1.Write( str, str.GetLength() );
		LeaveCriticalSection( &m_CS_FileWrite);

			////////////////////////////////////////////////////////////////////////
		pUser->m_bPShopView = 0;
		pUser->m_iPShopViewuid = -1;
		m_bViewingAShop = FALSE;
	}

	else if (pUser->m_dwNoChatTime == 2)
	{
		if ((int)TotalCost > JbiaoNum)  return ;
		BYTE SOLT = pUser->FindItem(725);

		pUser->GiveItemAll(725,TotalCost,0,0,0,0,0,0,0,0,0,0,0);
		pUser->m_iCurWeight -= iWeightOwner;
		if(pUser->m_iCurWeight < 0) pUser->m_iCurWeight = 0;
		pUser->GetRecoverySpeed();
		pUser->UpdateInvenSlot(&arEmptySlotShop, &arSameSlotShop);
        
		RobItem(725,TotalCost);
		m_iCurWeight += iWeight;
		GetRecoverySpeed();
		UpdateInvenSlot(&arEmptySlotBuyer, &arSameSlotBuyer);
        ///////////////////////////////////////////////////////////±êÖ¾¼ÇÂ¼88888
		CString str = _T("");
        SYSTEMTIME st;
		CString strDate;
		GetLocalTime(&st);
		strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
        str.Format("[%s]Íæ¼Ò [%s]Âô¶«Î÷»ñµÃ½ð±ê %d  \r\n",strDate,pUser->m_strUserID,TotalCost);
		EnterCriticalSection( &m_CS_FileWrite );
		g_fpSpeedHack1.Write( str, str.GetLength() );
		LeaveCriticalSection( &m_CS_FileWrite);

			////////////////////////////////////////////////////////////////////////
		pUser->m_bPShopView = 0;
		pUser->m_iPShopViewuid = -1;
		m_bViewingAShop = FALSE;
	}
	if(m_curz != pUser->m_curz)
		{
			pUser->m_bPShopView = 0;
			pUser->m_iPShopViewuid = -1;
			m_bViewingAShop = FALSE;
			goto fail_result;
		}

	

	if(sShopAmount == 1)
		strMsg.Format(IDS_USER_SHOP_BUY_SUCCESS, "Item");
	else
		strMsg.Format(IDS_USER_SHOP_BUY_SUCCESS, "Items");

	SendSystemMsg( strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_ERROR, TO_ME);

	return;
	}

fail_result:
	for(i = 0; i < TOTAL_ITEM_NUM; i++)		// Item Information Backup
	{
		m_UserItem[i] = BuyerItem[i];
		pUser->m_UserItem[i] = ShopItem[i];
	}
	EnterCriticalSection( &pUser->m_CS_ShopItem );
	pUser->m_arShopItem.RemoveAll();
	for(i = 0; i < ShopSize; i++)
	{
		pUser->m_arShopItem.Add(ShopBackupItem[i]); 
	}
	LeaveCriticalSection( &pUser->m_CS_ShopItem );

	pUser->m_bPShopView = 0;
	pUser->m_iPShopViewuid = -1;
	m_bViewingAShop = FALSE;
	////////////////////////´Ì¼¤
	TCHAR c_Log[500];
	sprintf_s(c_Log,"[%s]ÔÚ[%s]µÄÉÌµê¹ºÂòÎïÆ·Ê§°Ü\r\n",m_strUserID,pUser->m_strUserID);
	WriteUserShopLog(c_Log);
	////////////////////////´Ì¼¤

	UpdateUserData(TRUE); 
	pUser->UpdateUserData(TRUE);
	if(sShopAmount == 1)
		strMsg.Format(IDS_USER_SHOP_BUY_FAIL, "Item");
	else
		strMsg.Format(IDS_USER_SHOP_BUY_FAIL, "Items");
	SendSystemMsg( strMsg.GetBuffer(strMsg.GetLength()), SYSTEM_ERROR, TO_ME);
	return;
  
}

BOOL USER::GetTransformOption(ItemList* pItem)///É¾³ýÀ¬»øÊôÐÔ      NEO°æ±¾
{
	int iMagicCount = 0;
	int nLoop = 0;
	int i = 0, j = 0, iRandom = 0;
	int iCount = 0, iTemp = 0;
	short sSid = -1;

	if(pItem == NULL) return FALSE;
	sSid = pItem->sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return FALSE;

	nLoop = 4;

	//if(m_sLevel <= 20)					// ¸ÅÁ÷ÀÎµ¦½º ¹üÀ§¸¦ ·¹º§¿¡ µû¶ó Á¦ÇÑÇÑ´Ù. 
	if(m_sLevel <= 20) iMagicCount = 205;
	else iMagicCount = 205;

	if(iMagicCount >= g_arMagicItemTable.GetSize()) iMagicCount = g_arMagicItemTable.GetSize() - 1;

	i = 0;
	srand( (unsigned)time( NULL ) );

	while(nLoop > i)										
	{
		iRandom = myrand(1, iMagicCount);

		if(!g_arMagicItemTable[iRandom]->m_tUse) continue;
		if(g_arMagicItemTable[iRandom]->m_sSubType == 32) continue;	// ³»±¸µµ ¿É¼ÇÀº ºÙÀÌÁö ¾Ê´Â´Ù.
		
		if(CheckClassWear(sSid, iRandom) == FALSE)			// Npc.cpp ÀÇ CheckClassItem °ú °°Àº ±â´ÉÀ» ¼öÇà. User ÀÇ CheckClassItem À» È£ÃâÇÏ¸é ¾ÈµÊ
		{
			if(i == 0) continue;							// ¸ÅÁ÷Àº ±âº»ÀÌ 1°³
			else if(i <= 3) continue;	// ·¡¾î´Â ±âº»ÀÌ 3°³
			else { i++; continue; }
		}

		for(j = 0; j < 4; j++)
		{
			iCount = g_arMagicItemTable[pItem->tMagic[j]]->m_sSubType;
			if(iCount != 0 && iCount == g_arMagicItemTable[iRandom]->m_sSubType)	// ¼Ó¼ºÀÌ °ãÄ¥¼ö ÀÖÀ¸¹Ç·Î ÀÌÁß Å«°ª¸¸ ¼±ÅÃ	
			{
				iCount = g_arMagicItemTable[pItem->tMagic[j]]->m_sChangeValue;
				if(iCount < g_arMagicItemTable[iRandom]->m_sChangeValue)
				{
					iTemp = g_arMagicItemTable[pItem->tMagic[j]]->m_tLevel;
					if(pItem->sLevel - iTemp > 0) pItem->sLevel -= iTemp;
					pItem->sLevel += g_arMagicItemTable[iRandom]->m_tLevel;
					pItem->tMagic[j] = iRandom; 
					break;
						
				}
				else if(iCount == g_arMagicItemTable[iRandom]->m_sChangeValue) break;
			}
			if(pItem->tMagic[j] > 0) continue;										// ÀÌ¹Ì ½½·Ô¿¡ °ªÀÌ ÀÖÀ¸¸é ³Ñ¾î°¨
			else
			{ 
				pItem->tMagic[j] = iRandom; i++;
				if(g_arMagicItemTable[iRandom]->m_tLevel > 0) pItem->sLevel += g_arMagicItemTable[iRandom]->m_tLevel;
				break;
			}
		}
	}
	return TRUE;
}

void USER::TransformWindow()
{
	if(FindEvent(24) == TRUE) return;
	if(m_sLevel < 20) return;

	CBufferEx TempBuf;

	TempBuf.Add((BYTE)0xEC);
	TempBuf.Add((BYTE)0x00);
	Send(TempBuf, TempBuf.GetLength());

}

void USER::TransformReq(TCHAR* pBuf)
{
	short sSourceSid = -1;
	int index = 0, j = 0;
	BYTE result = TRUE;

	if(FindEvent(24) == TRUE) return;

	if(m_sLevel < 20) return;

	// Source Item
	short sSourceSlot = GetShort(pBuf, index);			// ¼±ÅÃÇÑ ¾ÆÀÌÅÛ ½½·Ô¹øÈ£
	if(sSourceSlot < EQUIP_ITEM_NUM || sSourceSlot >= TOTAL_INVEN_MAX) return;
	
	sSourceSid = m_UserItem[sSourceSlot].sSid;
	if(sSourceSid < 0 || sSourceSid >= g_arItemTable.GetSize()) return;
	
	if( sSourceSid == 669 || sSourceSid == 670 )		// ¾÷±×·¹ÀÌµå ÇÏ·Á´Â ¾ÆÀÌÅÛÀÌ ±Û·¯±×Á¾·ù¶ó¸é
	{
		result = FALSE;
		goto result;
	}

	if(g_arItemTable[sSourceSid]->m_byWear < 1 && g_arItemTable[sSourceSid]->m_byWear > 5) // ¹«±â, ¹æ¾î±¸°¡ ¾Æ´Ï¸é °³Á¶ÇÒ ¼ö ¾ø´Ù.
	{
		result = FALSE;
		goto result;
	}

	if(m_UserItem[sSourceSlot].tMagic[5] >= 1)			// ¾÷±×·¹ÀÌµåµÈ ¾ÆÀÌÅÛÀº °³Á¶ÇÒ ¼ö ¾ø´Ù.
	{
		result = FALSE;
		goto result;
	}

	if(m_UserItem[sSourceSlot].sLevel > 40)	
	{
		result = FALSE;
		goto result;
	}

	if(!GetTransformOption(&m_UserItem[sSourceSlot]))
	{
		result = FALSE;
		goto result;
	}

	m_UserItem[sSourceSlot].tIQ = RARE_ITEM;

result:
	CBufferEx TempBuf;
	TempBuf.Add((BYTE)TRANSFORM_REQ);
	TempBuf.Add(result);
	if(result == FALSE)
	{
		Send(TempBuf, TempBuf.GetLength());
		return;
	}

	AddMyEventNum(24);

	TempBuf.Add((short)sSourceSlot);						
	TempBuf.Add(m_UserItem[sSourceSlot].sLevel);
	TempBuf.Add(m_UserItem[sSourceSlot].sSid);
	TempBuf.Add(m_UserItem[sSourceSlot].sDuration);
	TempBuf.Add(m_UserItem[sSourceSlot].sBullNum);
	TempBuf.Add(m_UserItem[sSourceSlot].sCount);
	for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[sSourceSlot].tMagic[j]);
	TempBuf.Add(m_UserItem[sSourceSlot].tIQ);
	
	Send(TempBuf, TempBuf.GetLength());
}

BOOL USER::ChuanSongChiJiu()
{

	for(int i = 10; i < 34 ; i++)
	{
		if (m_UserItem[i].sSid == 1425 && m_UserItem[i].sDuration >= 1 )
		 {
			
			 if ( (m_UserItem[i].sDuration - 1) <=0 )
			 {
				 ReSetItemSlot(&m_UserItem[i]);
				 SendCharData();
				 return true;
			 
			 }else{
			  m_UserItem[i].sDuration -=1;
			  SendCharData();
			  return true;
			 }
			 
		}
   }
              
	return false;
}

void USER::CheckDevilTime() //¶ñÄ§¹ã³¡
{
	SYSTEMTIME messageTime;
	GetLocalTime(&messageTime);
	
	DWORD dwCurrTick = GetTickCount();					

	COleDateTime CurrTime = COleDateTime(messageTime); //µ±Ç°Ê±¼ä
	
	if(o_yehuoini[0]->EMGCKG != 1)
	{

		SendEventMsg("¶ñÄ§¹ã³¡ÔÝÎ´¿ª·Å");
		return;
	}
	
	   if( messageTime.wHour == 20 && messageTime.wMinute < 30)
		{
			ZoneMoveReq(92, 20, 20);
		}
		else
		{
		//	SendSystemMsg("½øÈë¶ñÄ§¹ã³¡Ê±¼äÎ´µ½!Ã¿Íí19:00--19:30¿ª·Å.", SYSTEM_ERROR, TO_ME);
            SendEventMsg("»¹Î´µ½½øÈëÊ±¼ä,20µãÖ®ºóÔÙÀ´°É!");
		}
}
//²é¿´×°±¸
void USER::ViewUserInfo(int uid)
{
	USER *pUser = GetUser(uid- USER_BAND);
	if(pUser == NULL)
		return ;
	TCHAR  pBuf[_ITEM_DB];
	::ZeroMemory(pBuf, sizeof(pBuf));
	int index = 0;
	int i, j;
	short sCount = 0;
	///////////////////////////////////////////////////////////////ÐÂÔö¼Ó²é¿´×°±¸
	if(pUser && pUser->m_state == STATE_GAMESTARTED )
	{
	
	CString sayStr;
	CBufferEx TempBuf, TempSayBuf , TempBuf3;
	
	sayStr.Format("%s",pUser->m_strUserID);//½ÇÉ«Ãû×Ö
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );                  

	sayStr.Format("%d",pUser->m_sLevel);//µÈ¼¶  
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );

    sayStr.Format("%d",pUser->m_sMagicSTR);//Á¦Á¿ 
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );

	   sayStr.Format("%d",pUser->m_sMagicCON);//ÌåÖÊ
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );

	   sayStr.Format("%d",pUser->m_sMagicDEX);//Ãô½Ý
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );

	   sayStr.Format("%d",pUser->m_sMagicVOL);//ÖÇ»Û
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );

	   sayStr.Format("%d",pUser->m_sMagicWIS);//ÖÇÁ¦
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );

     if( pUser->m_dwDN > 0 )
	 {

	 sayStr.Format("%d",pUser->m_dwDN);//¾öÕ½±ÒÊýÁ¿
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
	 }
	 else
	 {
		 sayStr.Format("0",pUser->m_dwDN);//¾öÕ½±ÒÊýÁ¿
	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );

	 }    
	if( pUser->m_dwShaGuai > 0 )
	{
	sayStr.Format("%d",pUser->m_dwShaGuai);//É±¹ÖÊýÁ¿
	 TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
	}
	else 
	{
		sayStr.Format("0");
		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
	}
	 //sayStr.Format("%d",pUser->GetUserSpellAttack(TRUE));//²é¿´Ä§·¨¹¥»÷  
	 //TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );


	
	TempBuf.Add(CLIENT_EVENT_SAY);
	TempBuf.Add((BYTE)SUCCESS);
	TempBuf.Add((short)5009);
	TempBuf.Add((BYTE)0x09);
	TempBuf.AddData(TempSayBuf, TempSayBuf.GetLength());
	Send(TempBuf, TempBuf.GetLength());
 }
	//===================================================================================================
	for(i = 0; i < 10; i++)
	{
		sCount++;
		SetShort(pBuf,  pUser->m_UserItem[i].sLevel,	index);
		SetShort(pBuf,  pUser->m_UserItem[i].sSid,		index);
		SetShort(pBuf,  pUser->m_UserItem[i].sDuration,	index);
		SetShort(pBuf,  pUser->m_UserItem[i].sBullNum,	index);
		SetShort(pBuf,  pUser->m_UserItem[i].sCount,	index);

		for(j = 0; j < MAGIC_NUM; j++) 
			SetByte(pBuf,  pUser->m_UserItem[i].tMagic[j], index);

		SetByte(pBuf,  pUser->m_UserItem[i].tIQ, index);
	}
	//»úÐµ
	for(i = 34; i < 40; i++)
	{
		sCount++;
		SetShort(pBuf,  pUser->m_UserItem[i].sLevel,	index);
		SetShort(pBuf,  pUser->m_UserItem[i].sSid,		index);
		SetShort(pBuf,  pUser->m_UserItem[i].sDuration,	index);
		SetShort(pBuf,  pUser->m_UserItem[i].sBullNum,	index);
		SetShort(pBuf,  pUser->m_UserItem[i].sCount,	index);

		for(j = 0; j < MAGIC_NUM; j++) 
			SetByte(pBuf,  pUser->m_UserItem[i].tMagic[j], index);

		SetByte(pBuf,  pUser->m_UserItem[i].tIQ, index);
	}
	CBufferEx TempBuf;

	TempBuf.Add(PK_BUTTON_REQ);
	TempBuf.Add((BYTE)0x50);
	TempBuf.Add((short)sCount);
	TempBuf.AddData(pBuf,index);
	Send(TempBuf, TempBuf.GetLength());
}

//ÊÇ·ñÎª130¼¶×°±¸
BOOL USER::Is130Item(int sSid)										
{
	if(sSid<=0||sSid>g_arItemTable.GetSize())
		return FALSE;
	if(g_arItemTable[sSid]->m_byRLevel == 130&&g_arItemTable[sSid]->m_byWear != 1)
		return TRUE;
	return FALSE;
}
//ÊÇ·ñÎª130¼¶ÎäÆ÷
BOOL USER::Is130Wearp(int sSid)										
{
	if(sSid<=0||sSid>g_arItemTable.GetSize())
		return FALSE;
	if(g_arItemTable[sSid]->m_byRLevel == 130 &&g_arItemTable[sSid]->m_byWear == 1)
		return TRUE;
	return FALSE;
}
//ÊÇ·ñÎª100¼¶
BOOL USER::Is100Item(int sSid)										
{
	if(sSid<=0||sSid>g_arItemTable.GetSize())
		return FALSE;
	if(g_arItemTable[sSid]->m_byRLevel == 100 && g_arItemTable[sSid]->m_byWear != 1)
	/*if( (g_arItemTable[sSid]->m_sPid == 316||
		g_arItemTable[sSid]->m_sPid == 317||
		g_arItemTable[sSid]->m_sPid == 318||
		g_arItemTable[sSid]->m_sPid == 319)

		&& (g_arItemTable[sSid]->m_byWear != 1))*/
		return TRUE;
	return FALSE;
}
//ÊÇ·ñÎª100¼¶
BOOL USER::Is100Wearp(int sSid)										
{
	if(sSid<=0||sSid>g_arItemTable.GetSize())
		return FALSE;
	if(g_arItemTable[sSid]->m_byRLevel == 100 &&g_arItemTable[sSid]->m_byWear == 1)
		return TRUE;
	return FALSE;
}	

//Ìí¼Ó¼¼ÄÜµã
void USER::AddMagicPoint(short sPoint)									
{
	m_DynamicUserData[MAGIC_STR_UP]+=sPoint;//×°±¸×ÛºÏÖµÁ¦Á¿	
	m_DynamicUserData[MAGIC_CON_UP]+=sPoint;//×°±¸×ÛºÏÖµÌåÖÊ
	m_DynamicUserData[MAGIC_DEX_UP]+=sPoint;//×°±¸×ÛºÏÖµÃô½Ý
	m_DynamicUserData[MAGIC_VOL_UP]+=sPoint;//×°±¸×ÛºÏÖµÖÇ»Û
	m_DynamicUserData[MAGIC_WIS_UP]+=sPoint;//×°±¸×ÛºÏÖµÖÇÁ¦
}
//ÑªÁ¿°Ù·Ö±È
void USER::AddMaxHPPoint(short sPoint)									
{
	//
	m_nHPPoint +=sPoint;
	//m_DynamicUserData[MAGIC_HP_RATING_UP]+=sPoint;
}
//130ÎäÆ÷×ª»»
int USER::Wearp130Convert(int sourceSolt)
{
	int i;
	int sSid = m_UserItem[sourceSolt].sSid;
	if(sSid < 0||sSid > g_arItemTable.GetSize() )
		return FALSE;
	//Ô­ÎïÆ·
	switch(sSid)
	{
		//130ÎäÆ÷1577Ç¹,1574µ¶,1580ÕÈ,1583È­
	case 330://ÁúÖ®Å­
        m_UserItem[sourceSolt].sSid = 1578;
		break;
    case 475://Ç¿»¯ÁúÖ®Å­
	case 476://Ç¿»¯ÁúÖ®Å­
	case 477://Ç¿»¯ÁúÖ®Å­
       {
		    m_UserItem[sourceSolt].sSid = 1579;
		    break;
		}
	case 478://ÁúÉñÖ®Å­¡ªS
	case 479://ÁúÉñÖ®Å­¡ªS
	    m_UserItem[sourceSolt].sSid = 1580;
		break;
	case 323://·´I
		m_UserItem[sourceSolt].sSid = 1572;
		break;
	case 440://·´II
	case 441://·´II
	case 442://·´II
		{
            m_UserItem[sourceSolt].sSid = 1573;
		    break;
         }
	case 443://·´III
	case 444://·´III
	    m_UserItem[sourceSolt].sSid = 1574;
		break;
	case 337://ÁúÖ®Òí
		m_UserItem[sourceSolt].sSid = 1581;
		break;
	case 510://Ç¿»¯ÁúÖ®Òí
	case 511://Ç¿»¯ÁúÖ®Òí
	case 512://Ç¿»¯ÁúÖ®Òí
		{
            m_UserItem[sourceSolt].sSid = 1582;
		    break;
		}
	case 513://ÁúÖ®Òís
	case 514://ÁúÖ®Òís
	    m_UserItem[sourceSolt].sSid = 1583;
		break;
	case 316://ÁúÉñÅÚg2
		m_UserItem[sourceSolt].sSid = 1575;
		break;
	case 405://ÁúÉñÅÚg4
    case 406://ÁúÉñÅÚg4
	case 407://ÁúÉñÅÚg4
       {
            m_UserItem[sourceSolt].sSid = 1576;
			break;
		}
	case 408://ÁúÉñÅÚg6
    case 409://ÁúÉñÅÚg6
	    m_UserItem[sourceSolt].sSid = 1577;
		break;
	case 1698://ÁúÉñÔ¦
		m_UserItem[sourceSolt].sSid = 1584;
		break;
	case 1699://Ç¿»¯ÁúÉñÔ¦
		m_UserItem[sourceSolt].sSid = 1585;
		break;
	case 1700://ÁúÉñÔ¦-S
		m_UserItem[sourceSolt].sSid = 1586;
		break;
	default:
	
        return FALSE;
		break;
	}
	//¼¶±ðÖØÐÂ¼ÆËã
	if(m_UserItem[sourceSolt].sSid<0 || m_UserItem[sourceSolt].sSid > g_arItemTable.GetSize())
		return FALSE;
	//ÊôÐÔ¼¶±ð
	m_UserItem[sourceSolt].sLevel = g_arItemTable[m_UserItem[sourceSolt].sSid]->m_byRLevel;
	m_UserItem[sourceSolt].sDuration = g_arItemTable[m_UserItem[sourceSolt].sSid]->m_sDuration;
	int itemCount = 0;
	//130¼¶×°±¸
	m_UserItem[sourceSolt].tIQ = 0x12;//Ê¹ÓÃ18ÎÞ·¨¿´µ½ËÄÅÅÒÔºóµÄÊôÐÔ
	m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT] -=2;//ºÏ³ÉºóÎäÆ÷µô2¸Ä
	if(m_UserItem[sourceSolt].tIQ > NORMAL_ITEM)
	{
		if(m_UserItem[sourceSolt].tIQ == UNIQUE_ITEM) 
			itemCount = MAGIC_NUM;	
		else 
			itemCount = 4;								
		for(i = 0; i < itemCount; i++)
		{
			BYTE bMagic = m_UserItem[sourceSolt].tMagic[i];
			if(bMagic >= 0 && bMagic < g_arMagicItemTable.GetSize())
			{
				m_UserItem[sourceSolt].sLevel += g_arMagicItemTable[bMagic]->m_tLevel;
			}
		}
	}
	CString strMsg;
	CString GoodsMagic;
	for(int i = 0; i <= 4; i++)
	{
		if(m_UserItem[sourceSolt].tMagic[0] != 0)
		{
			GoodsMagic+=g_arMagicItemTable[m_UserItem[sourceSolt].tMagic[i]]->m_strText;
			GoodsMagic+=",";
		}
	}
	strMsg.Format("Íæ¼Ò %s ÖÆ×÷ [%s] : ", this->m_strUserID,g_arItemTable[m_UserItem[sourceSolt].sSid]->m_strName );
	strMsg+=GoodsMagic;
	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
	return TRUE;
}
//×°±¸×ª»»
int USER::Item130Convert(int sourceSolt)
{
	int i;
	int sSid = m_UserItem[sourceSolt].sSid;
	if(sSid < 0||sSid > g_arItemTable.GetSize() )
		return FALSE;
	//Ô­ÎïÆ·
	switch(sSid)
	{
	case 1053://ÁúÑÀÃ±
	case 1054://Ç¿»¯ÁúÑÀÃ±
	case 1055://ÌØÊâÁúÑÀ¿ø
	case 1056://ÁúÑÀ¿øSÐÍ
		{
			//È­1590,·¨1594,µ¶1598,Ç¹1602,ÖÙ²Ã1606
			int s = 1590;
			switch(m_byClass)
			{
			case 0:
				break;
			case 1:
				s = 1594;
				break;
			case 2:
				s = 1598;
				break;
			case 3:
				s = 1602;
				break;
			case 4:
				s = 1606;
				break;
			}
			m_UserItem[sourceSolt].sSid = s;
			break;
		}
	case 1057://ÁÒÑæÕ½¼×
		m_UserItem[sourceSolt].sSid = 1607;
		break;
	case 1058://Ç¿»¯ÁÒÑæÕ½¼×
		m_UserItem[sourceSolt].sSid = 1608;
		break;
	case 1059://ÁÒÑæÕ½¼×GÐÍ
		m_UserItem[sourceSolt].sSid = 1609;
		break;
	case 1060://ÁÒÑæÕ½¼×SÐÍ
		m_UserItem[sourceSolt].sSid = 1610;
		break;
	case 1061://ÁÒÑæ»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1611;
		break;
	case 1062://Ç¿»¯ÁÒÑæ»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1612;
		break;
	case 1063://ÁÒÑæ»¤ÍÈGÐÍ
		m_UserItem[sourceSolt].sSid = 1613;
		break;
	case 1064://ÁÒÑæ»¤ÍÈSÐÍ
		m_UserItem[sourceSolt].sSid = 1614;
		break;
	case 1065://²ÔÔÂÖ®îø
		m_UserItem[sourceSolt].sSid = 1615;
		break;
	case 1066://Ç¿»¯²ÔÔÂÖ®îø
		m_UserItem[sourceSolt].sSid = 1616;
		break;
	case 1067://²ÔÔÂÖ®îøIIÐÍ
		m_UserItem[sourceSolt].sSid = 1617;
		break;
	case 1068://²ÔÔÂÖ®îøMÐÍ
		m_UserItem[sourceSolt].sSid = 1618;
		break;
	case 1069://²ÔÔÂ»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1619;
		break;
	case 1070://Ç¿»¯²ÔÔÂ»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1620;
		break;
	case 1071://²ÔÔÂ»¤ÍÈIIÐÍ
		m_UserItem[sourceSolt].sSid = 1621;
		break;
	case 1072://²ÔÔÂ»¤ÍÈMÐÍ
		m_UserItem[sourceSolt].sSid = 1622;
		break;
	case 1073://º®±ùÖ®îø
		m_UserItem[sourceSolt].sSid = 1623;
		break;
	case 1074://Ç¿»¯º®±ùÖ®îø
		m_UserItem[sourceSolt].sSid = 1624;
		break;
	case 1075://º®±ùÖ®îøGÐÍ
		m_UserItem[sourceSolt].sSid = 1625;
		break;
	case 1076://º®±ùÖ®îøSÐÍ
		m_UserItem[sourceSolt].sSid = 1626;
		break;
	case 1077://º®±ù»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1627;
		break;
	case 1078://Ç¿»¯º®±ù»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1628;
		break;
	case 1079://º®±ù»¤ÍÈGÐÍ
		m_UserItem[sourceSolt].sSid = 1629;
		break;
	case 1080://º®±ù»¤ÍÈSÐÍ
		m_UserItem[sourceSolt].sSid = 1630;
		break;
	case 1081://¼²·çÕ½¼×
		m_UserItem[sourceSolt].sSid = 1631;
		break;
	case 1082://Ç¿»¯¼²·çÕ½¼×
		m_UserItem[sourceSolt].sSid = 1632;
		break;
	case 1083://¼²·çÕ½¼×IIÐÍ
		m_UserItem[sourceSolt].sSid = 1633;
		break;
	case 1084://¼²·çÕ½¼×MÐÍ
		m_UserItem[sourceSolt].sSid = 1634;
		break;
	case 1085://¼²·ç»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1635;
		break;
	case 1086://Ç¿»¯¼²·ç»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1636;
		break;
	case 1087://¼²·ç»¤ÍÈIIÐÍ
		m_UserItem[sourceSolt].sSid = 1637;
		break;
	case 1088://¼²·ç»¤ÍÈMÐÍ
		m_UserItem[sourceSolt].sSid = 1638;
		break;
	case 1709://¹âÃ÷îø¼×
		m_UserItem[sourceSolt].sSid = 1639;
		break;
	case 1710://Ç¿»¯¹âÃ÷îø¼×
		m_UserItem[sourceSolt].sSid = 1640;
		break;
	case 1711://¹âÃ÷îø¼×IIÐÍ
		m_UserItem[sourceSolt].sSid = 1641;
		break;
	case 1712://¹âÃ÷îø¼×MÐÍ
		m_UserItem[sourceSolt].sSid = 1642;
		break;
	case 1713://¹âÃ÷»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1643;
		break;
	case 1714://Ç¿»¯¹âÃ÷»¤ÍÈ
		m_UserItem[sourceSolt].sSid = 1644;
		break;
	case 1715://¹âÃ÷»¤ÍÈIIÐÍ
		m_UserItem[sourceSolt].sSid = 1645;
		break;
	case 1716://¹âÃ÷»¤ÍÈMÐÍ
		m_UserItem[sourceSolt].sSid = 1646;
		break;
	case 1089://Áú¹ÇÑ¥
	case 1090://Ç¿»¯Áú¹ÇÑ¥
	case 1091://ÌØÊâÁú¹ÇÑ¥
	case 1092://Áú¹ÇÑ¥SÐÍ
		{
			//È­Ð¬1650,·¨Ð¬1654,µ¶Ð¬1658,Ç¹Ð¬1662,ÖÙ²Ã1666
			int s = 1650;
			switch(m_byClass)
			{
			case 0:
				break;
			case 1:
				s = 1654;
				break;
			case 2:
				s = 1658;
				break;
			case 3:
				s = 1662;
				break;
			case 4:
				s = 1666;
				break;
			}
			m_UserItem[sourceSolt].sSid = s;
			break;
		}
	default:
		return FALSE;
		break;
	}
	//¼¶±ðÖØÐÂ¼ÆËã
	if(m_UserItem[sourceSolt].sSid<0 || m_UserItem[sourceSolt].sSid > g_arItemTable.GetSize())
		return FALSE;
	//ÊôÐÔ¼¶±ð
	m_UserItem[sourceSolt].sLevel = g_arItemTable[m_UserItem[sourceSolt].sSid]->m_byRLevel;
	m_UserItem[sourceSolt].sDuration = g_arItemTable[m_UserItem[sourceSolt].sSid]->m_sDuration;
	int itemCount = 0;
	//130¼¶×°±¸
	m_UserItem[sourceSolt].tIQ = 18;
	m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT] -=2;//ºÏ³Éºó×°±¸µô2¸Ä
	if(m_UserItem[sourceSolt].tIQ > NORMAL_ITEM)
	{
		if(m_UserItem[sourceSolt].tIQ == UNIQUE_ITEM) 
			itemCount = MAGIC_NUM;	
		else if(m_UserItem[sourceSolt].tIQ == 12||m_UserItem[sourceSolt].tIQ == 18)
			itemCount = 5;								
		else
			itemCount = 4;								
		for(i = 0; i < itemCount; i++)
		{
			BYTE bMagic = m_UserItem[sourceSolt].tMagic[i];
			if(bMagic >= 0 && bMagic < g_arMagicItemTable.GetSize())
			{
				m_UserItem[sourceSolt].sLevel += g_arMagicItemTable[bMagic]->m_tLevel;
			}
		}
	}
	//ÖÆ×÷130×°±¸ÌáÐÑ=====================================================================
	
    CString strMsg;
	CString GoodsMagic;
	for(int i = 0; i <= 4; i++)
	{
		if(m_UserItem[sourceSolt].tMagic[0] != 0)
		{
			GoodsMagic+=g_arMagicItemTable[m_UserItem[sourceSolt].tMagic[i]]->m_strText;
			GoodsMagic+=",";
		}
	}
	strMsg.Format("Íæ¼Ò %s ÖÆ×÷ [%s] : ", this->m_strUserID,g_arItemTable[m_UserItem[sourceSolt].sSid]->m_strName );
	strMsg+=GoodsMagic;
	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
	//=========================================================================================
	return TRUE;
}

void USER::Item130Convert(int sourceSolt,int materialSolt1,int materialSolt2,int materialSolt3)		//°Ù¼¶×ª130¼¶×°±¸
{
	//ÅÐ¶ÏÎ»ÖÃ
	if(sourceSolt<10||materialSolt1<10||materialSolt2<10||materialSolt3<10
		||sourceSolt>=34||materialSolt1>=34||materialSolt2>=34||materialSolt3>=34)
		return ;
	//ÅÐ¶ÏID
	int sSid = m_UserItem[sourceSolt].sSid,s1 = m_UserItem[materialSolt1].sSid,
		s2 = m_UserItem[materialSolt2].sSid,s3 = m_UserItem[materialSolt3].sSid;
	if(sSid < 0||sSid > g_arItemTable.GetSize() )
		return ;

	if(s1 < 0||s1 > g_arItemTable.GetSize() )
		return ;

	if(s2 < 0||s2 > g_arItemTable.GetSize() )
		return ;

	if(s3 < 0||s3 > g_arItemTable.GetSize() )
		return ;
	//²ÄÁÏID
	if(s1 != 1674||s2 !=1675||s3 != 1676)
		return ;
	//Ç®ÊýÊÇ·ñ¹»
	if(m_dwDN < 10000000)
	{
		SendSystemMsg("×ª»»130¼¶×°±¸ÐèÒª1000Íò,ÄãµÄ½ðÇ®²»×ã",SYSTEM_ERROR,TO_ME);
		return;
	}
	//Ö÷ÌåÊÇ·ñ¹»¸ÄÊý
	//ÎäÆ÷»¹ÊÇ×°±¸
	if(g_arItemTable[sSid]->m_byWear == 1)
	{
		//70¼¶ÎäÆ÷ÐèÒª10¸Ä
		if(m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT] <10)
			return ;
		//ÎäÆ÷×ª»»
		if(!Wearp130Convert(sourceSolt))
			return ;	
	}else 
	{
		//100¼¶·À¾ß8¸Ä
		if(m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT] <8)
			return ;
		//·À¾ß×ª»»
		if(!Item130Convert(sourceSolt))
			return ;
	}
	//130¼¶tIQ=18

	m_UserItem[materialSolt1].sCount-=1;//¼õÈ¥²ÄÁÏ
	if(m_UserItem[materialSolt1].sCount<=0)
		ReSetItemSlot(&m_UserItem[materialSolt1]);

	//¼õÈ¥²ÄÁÏ
	m_UserItem[materialSolt2].sCount-=1;
	if(m_UserItem[materialSolt2].sCount<=0)
		ReSetItemSlot(&m_UserItem[materialSolt2]);
	//¼õÈ¥²ÄÁÏ
	m_UserItem[materialSolt3].sCount-=1;
	if(m_UserItem[materialSolt3].sCount<=0)
		ReSetItemSlot(&m_UserItem[materialSolt3]);

	//¼õÈ¥Ç®
	if( m_dwDN <= 10000000 )
		m_dwDN = 0;
	else
		m_dwDN = m_dwDN - 10000000;
	UpdateUserItemDN();					
	SendMoneyChanged();
	
	//·¢ËÍÎïÆ·±ä»¯
	CByteArray arMaterial;
	arMaterial.RemoveAll();
	arMaterial.Add((BYTE)sourceSolt);
	arMaterial.Add((BYTE)materialSolt1);
	arMaterial.Add((BYTE)materialSolt2);
	arMaterial.Add((BYTE)materialSolt3);

	CBufferEx TempBuf;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	int index = arMaterial.GetSize();
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)index);
	int i,j;
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) 
			TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	FlushItemLog( TRUE );
}

//Éý¼¶130¼¶×°±¸
void USER::Update130Item(int sourceSolt,int materialSolt1,BYTE bReceive,int nAdd1,int nAdd2,int nAdd3,int nAdd4)		
{
/*	//ÅÐ¶ÏÎ»ÖÃ
	if(sourceSolt<10||materialSolt1<10||sourceSolt>=34||materialSolt1>=34)
		return ;
	//ÅÐ¶ÏID
	int sSid = m_UserItem[sourceSolt].sSid,s1 = m_UserItem[materialSolt1].sSid;
	if(sSid < 0||sSid > g_arItemTable.GetSize() )
		return ;

	if(s1 < 0||s1 > g_arItemTable.GetSize() )
		return ;
	//ÍõÕßÁéÊ¯1438,ÍõÕß¾§Ê¯1437
	if(s1 != 1438 && s1 != 1437)
		return ;
	//·Ç130¼¶×°±¸
	//if(g_arItemTable[sSid]->m_byRLevel!= 130)
	//	return ;
	//·Ç130¼¶×°±¸
	if(!Is130Wearp(sSid) && !Is130Item(sSid))
	{
		SendSystemMsg( "ÍõÕß¾§Ê¯,ÍõÕßÁéÊ¯Ö»ÄÜÉý¼¶130¼¶×°±¸ÓëÎäÆ÷", SYSTEM_ERROR, TO_ME);
		return ;
	}
	//130×°±¸ÇÒÍõÕßÁéÊ¯
	if( Is130Wearp(sSid)&& s1 != 1438)
	{
		return ;
	}
	//130×°±¸ÇÒÍõÕß¾§Ê¯
	if( Is130Item(sSid)&& s1 != 1437)
	{
		return ;
	}
	//ÐèÒªËÄ¸öÉñÊ¯»òÒ»¸ö³¬Éñ
	int nAddSid,nNAddCount=0;
	if(nAdd1<10||nAdd1>=34)
	{
		goto ErrorNoMeartial;
	}
	nAddSid = m_UserItem[nAdd1].sSid;
	//³¬¼¶ÉñÊ¯986,626ÉñÊ¯
	if(nAddSid != 986 &&nAddSid != 626)
	{
		goto ErrorNoMeartial;
	}
	nNAddCount++;
	if(nAddSid == 986)
	{
		goto SucMeartial;
	}
	//µÚ¶þ¿éÉñÊ¯
	if(nAdd2<10||nAdd2>=34)
	{
		goto ErrorNoMeartial ;
	}
	nAddSid = m_UserItem[nAdd2].sSid;
	if(nAddSid != 626)
	{
		goto ErrorNoMeartial;
	}
	nNAddCount++;
	//µÚÈý¿éÉñÊ¯
	if(nAdd3<10||nAdd3>=34)
	{
		goto ErrorNoMeartial ;
	}
	nAddSid = m_UserItem[nAdd3].sSid;
	if(nAddSid != 626)
	{
		goto ErrorNoMeartial;
	}
	nNAddCount++;
	//µÚËÄ¿éÉñÊ¯
	if(nAdd4<10||nAdd4>=34)
	{
		goto ErrorNoMeartial ;
	}
	nAddSid = m_UserItem[nAdd4].sSid;
	if(nAddSid != 626)
	{
		goto ErrorNoMeartial;
	}
	nNAddCount++;
	goto SucMeartial;

ErrorNoMeartial:
	SendSystemMsg(IDS_USER_SHENGSHI, SYSTEM_ERROR, TO_ME);
	return ;
SucMeartial:
	int iRandom = 0;

	BYTE tCount = m_UserItem[sourceSolt].tMagic[5];
	if(tCount >= MAX_ITEM_UPGRADE_COUNT) 
		return ;		
	iRandom = myrand(1, 10000);						// ¼º°ø·ü°ú ºñ±³À§ÇØ ·£´ý¼ö¸¦ ±¸ÇÔ
	int iSuccess = 0;
	if(iRandom <= g_ItemAttUpgrade[tCount])
	{			
		iRandom = myrand(1, 10000);				// Ãà¾ÆÀÌÅÛÀÏ°æ¿ì +3¾÷±îÁö º¸³Ê½º·Î µµÀüÇÒ¼ö ÀÖ´Ù
		for(int i = 0; i < 3; i++)
		{
			iSuccess += 1;						// Ãà ¾ÆÀÌÅÛ¿¡ÀÇÇØ ¸î¹ø ¾÷±ÛÇß´ÂÁö ¾Ë·Á ÁØ´Ù.

			if(iRandom <= g_ItemBlessingUpgrade[i])
				break;
			if((tCount + iSuccess) >= MAX_ITEM_UPGRADE_COUNT)
				break;
		}
	}
	BOOL bSuc = (iSuccess>=1);
	if(iSuccess >= 1)									// ÇØ´ç ¹øÂ°ÀÇ ¼º°ø·üº¸´Ù ÀÛÀ¸¸é
	{	
		if(m_UserItem[sourceSolt].tIQ==12)
			m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT]++;
		else
			m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT] = tCount + iSuccess;
		MakeItemLog( &m_UserItem[sourceSolt], ITEMLOG_BLESS_UPGRADE_SUCCESS );
	}else
	{
		int iUp = m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT];
		iRandom = myrand(1, 10000);
		//½µ¼¶
		if(iRandom <= g_ItemNormalDownUpgrade[0]) 
		{
			iUp-=1;
		}
		if(iUp < 0) 
			iUp = 0;
		m_UserItem[sourceSolt].tMagic[ITEM_UPGRADE_COUNT] = iUp;
	}
	//¿ªÊ¼ÇåÀíÊý¾Ý
	//¼õÈ¥²ÄÁÏ
	m_UserItem[materialSolt1].sCount-=1;
	if(m_UserItem[materialSolt1].sCount<=0)
		ReSetItemSlot(&m_UserItem[materialSolt1]);
	m_UserItem[nAdd1].sCount-=nNAddCount;
	if(m_UserItem[nAdd1].sCount<=0)
		ReSetItemSlot(&m_UserItem[nAdd1]);


	//·¢ËÍÎïÆ·±ä»¯
	CByteArray arMaterial;
	arMaterial.RemoveAll();
	arMaterial.Add((BYTE)sourceSolt);
	arMaterial.Add((BYTE)materialSolt1);
	arMaterial.Add((BYTE)nAdd1);

	CBufferEx TempBuf;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	int index = arMaterial.GetSize();
	TempBuf.Add((BYTE)bSuc);
	TempBuf.Add((BYTE)index);
	int i,j;
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) 
			TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	FlushItemLog( TRUE );
	return ;*/
}
/////////////////////////////////////////////////////////////////////////////
//	sSid,sitemmagic
// 
BOOL USER::IsMagicVSItem(int artable,int armagic)
{
	if(artable < 0 || artable >= g_arItemTable.GetSize())
		return FALSE;	

	if(armagic < 0 || armagic >= g_arMagicItemTable.GetSize())
		return FALSE;

	int iWear;

	BYTE armWear = g_arItemTable[artable]->m_byWear;			// ¾ÆÀÌÅÛ °è¿­ 1: ¹«±â 2~8 : Âø¿ë¾ÆÀÌÅÛ
	BYTE tNeedClass = g_arItemTable[artable]->m_byClass;
	BYTE armMagic = g_arMagicItemTable[armagic]->m_tNeedClass;	// ¸ÅÁ÷¼Ó¼º °è¿­

	//15±íÊ¾ËùÓÐÖ°Òµ
	if(armMagic != ALL_JOBS)
	{
		BYTE tTemp = 1;	
		BYTE tFire = 0;
		BYTE tEdge = 0;
		BYTE tStaff = 0;
		BYTE tBrawl = 0;

		tFire	 = tTemp & tNeedClass; tTemp = 2; 
		tEdge	 = tTemp & tNeedClass; tTemp = 4;
		tStaff	 = tTemp & tNeedClass; tTemp = 8;
		tBrawl	 = tTemp & tNeedClass;

		tFire = tFire & armMagic;
		tEdge = tEdge & armMagic;
		tStaff = tStaff & armMagic;
		tBrawl = tBrawl & armMagic;

		tTemp = tFire^tEdge^tStaff^tBrawl;
		if(!tTemp)
			return FALSE;
		//		if(tNeedClass != armMagic) return FALSE;
	}

	iWear = g_arMagicItemTable[armagic]->m_tWearInfo;		// 0±íÊ¾Ã»ÓÐÏÞÖÆ£¬1±íÊ¾ÎäÆ÷ÊôÐÔ,2±íÊ¾×°±¸ÊôÐÔ

	if(iWear == 0)
		return TRUE;
	else if(iWear == 1)											
	{														// 1¹øÀÌ¸é ¹«±â·ù¿¡ ºÙ´Â´Ù.
		if(armWear != 1)
			return FALSE;
		else return TRUE;
	}
	else if(iWear == 2)										// 2¹øÀÌ¸é ¹«±â¸¦ Á¦¿ÜÇÑ Âø¿ë¾ÆÀÌÅÛ¿¡ ºÙ´Â´Ù.
	{
		if((armWear <= 1 || armWear >= 9)&&armWear!= 143)//130¼¶×°±¸ÊôÐÔ
			return FALSE;
		else 
			return TRUE;
	}
	else return FALSE;
}
//	100-130¼¶×°±¸¸ÄÊýÄ§·À
short USER::Get100ItemPsiDefense(short sSid, int slot)          ////Ä§·¨·ÀÓù¼ÆËã    //////////////////////////////////NEO°æ±¾ÐèÒª¿ª·ÅµÄ
{
	short sDefense = 0;

	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) 
		return 0;
	if(slot < 0 || slot > EQUIP_ITEM_NUM) 
		return 0;
	if(m_UserItem[slot].tIQ!=12&&m_UserItem[slot].tIQ!=18)
		return 0;
	//¸ÄÊý×ª³É·À																
	if(m_UserItem[slot].tIQ != UNIQUE_ITEM)	
	{
		int up_count = 0;
		up_count = m_UserItem[slot].tMagic[ITEM_UPGRADE_COUNT];
		if(up_count > 0 && up_count <= MAX_ITEM_UPGRADE_COUNT)
		{
			//100¼¶Ä§·¨·À¸Ä+3,ºóÃæ+5,130¼¶Ä§¿¹6¸Ä5µã,6¸ÄÒÔÉÏµã
			if(Is130Item(sSid)&&m_UserItem[slot].tIQ==18)
			{
				if(up_count<=6)
				{
					sDefense = up_count*5;
				}
				else
				{
					sDefense = (up_count-6)*7+6*5;
				}
			}else
			{
				if(up_count<=7)
				{
					sDefense = up_count*3;
				}
				else
				{
					sDefense = (up_count-7)*5+7*3;
				}
			}
		}
	}
	//Ô­Ê¼×°±¸µÄ·À
	return sDefense;
} 
//////////////////////»úÐµ×ª»»Îª³¬¼¶»úÐµ/////////////////////////////
void USER::EbodyConvertSuperEbody(int sMaster,int sMetral1,int sMetral2)
{
	//ÅÐ¶ÏÎ»ÖÃ
	short sSid;
	if(sMaster < EQUIP_ITEM_NUM || sMaster >= TOTAL_INVEN_MAX)
		return;
	sSid = m_UserItem[sMaster].sSid;
	if(sSid <0||sSid>g_arItemTable.GetSize())
		return;
	if(!IsEbodyItem(sSid))
		return;	
	if( m_UserItem[sMaster].tMagic[5]<7)
	{
		return;
	}
	if(m_UserItem[sMaster].tIQ!=2)
		return ;
	if(m_UserItem[sMaster].tMagic[MAGIC_100_ADD_POS]!=0)
		return ;

	if(sMetral1 < EQUIP_ITEM_NUM || sMetral1 >= TOTAL_INVEN_MAX)//²ÄÁÏ1ÊÇ·ñºÏ·¨
		return;
	sSid = m_UserItem[sMetral1].sSid;
	if(sSid <0||sSid>g_arItemTable.GetSize())
		return;
	if(!IsEbodyItem(sSid))
		return;	
	if( m_UserItem[sMetral1].tMagic[5]<7)
	{
		return;
	}
	if(m_UserItem[sMetral1].tIQ!=2)
		return ;
	if(m_UserItem[sMetral1].tMagic[MAGIC_100_ADD_POS]!=1)
		return ;

	if(sMetral2 < EQUIP_ITEM_NUM || sMetral2 >= TOTAL_INVEN_MAX)//²ÄÁÏ2ÊÇ·ñºÏ·¨
		return;
	sSid = m_UserItem[sMetral2].sSid;
	if(sSid <0||sSid>g_arItemTable.GetSize())
		return;
	if(!IsEbodyItem(sSid))
		return;	
	if( m_UserItem[sMetral2].tMagic[5]<7)
	{
		return;
	}
	if(m_UserItem[sMetral2].tIQ!=2)
		return ;
	if(m_UserItem[sMetral2].tMagic[MAGIC_100_ADD_POS]!=1)
		return ;
	//ÊôÐÔÊýÊÇ·ñ<
	int magicount1  = 0,magicount2= 0,magicount3 = 0;
	int i ;
	for(i = 1;i<4;i++)
	{
		BYTE bMagic = m_UserItem[sMaster].tMagic[i];
		if(bMagic >0 && bMagic<g_arEBodyTable.GetSize())
			magicount1++;

		bMagic = m_UserItem[sMetral1].tMagic[i];
		if(bMagic >0 && bMagic<g_arEBodyTable.GetSize())
			magicount2++;

		bMagic = m_UserItem[sMetral2].tMagic[i];
		if(bMagic >0 && bMagic<g_arEBodyTable.GetSize())
			magicount3++;
	}
	if(magicount1<1||magicount1>magicount2 ||magicount1>magicount3)
		return;

	//ÊÇ·ñ¹»Ç®ÊýÓë¾­Ñé
	if(m_dwDN < 20000000)
	{
		SendSystemMsg( IDS_USER_NOT_ENOUGH_PAY, SYSTEM_ERROR, TO_ME);
		return ;		
	}
	if(m_dwXP < 1500)
	{
		SendSystemMsg( "Õ½¶·¾­Ñé²»×ã", SYSTEM_ERROR, TO_ME);
		return ;		
	}
	if( m_dwDN <= 20000000 ) 
		m_dwDN = 0;
	else 
		m_dwDN = m_dwDN - 20000000;
	//Õ½¶·¾­Ñé
	if( m_dwXP <= 1500 ) 
		m_dwXP = 0;
	else 
		m_dwXP = m_dwXP - 1500;

	//1247-1252Í·
	//1253-1267ÒÂ·þ
	//1268-1270ÊÖ±Û
	//1271-1276¿ã×Ó
	//1277 Í·
	short sEbodyID[]={877,878,879,880,881,883,910,//Í·
					  884,885,886,887,888,889,890,891,892,893,890,891,892,893,
	                  894,895,896,897,898,899,987,//±ØÉ±-->³¬¼¶°¢Å«±ÈË¹
					  901,902,903,904,905,906};
	short sConvertEbodyID[]={1247,1248,1249,1250,1251,1252,1252,//Í·
					  1253,1254,1255,1256,1257,1258,1259,1260,1261,1262,1263,1264,1265,1266,
	                  1268,1269,1270,1268,1269,1269,1270,
					  1271,1272,1273,1274,1275,1276};

	/*
	//ËÀÍöÊ¹Õß-->³¬¼¶°¢Å«±ÈË¹
	//°¬±´ÒÀ¶à->³¬¼¶°¢±´ÒÁ
	//°¢¿¨µÚ°²->³¬¼¶°¢¿¨µÏ°²
	//°¢ÀÕÃô->³¬¼¶°¢¶ûÃô
	//ÑÇ¿Ë->³¬¼¶°¢¿Ë
	//½ÜÂÞË¾-->³¬¼¶½ÜÂÞË¹
	//°¢Ã×Åµ->³¬¼¶°¢Ã×Å«
	//ÈÖçä-->³¬¼¶ÂÞÃ×
	//ÔÑ½ð->³¬¼¶À­¶û
	//Í®±ÌÖ¾->³¬¼¶ÌÔÃ××È
	//²·ÀûÍ¢->³¬¼¶²¼¶ûÌà
	//°Â¶¡->³¬¼¶°ÂØê
	//Èå±´Ë¾->³¬¼¶Â³±´Ë¹
	//ÖÙéò->³¬¼¶Â³×È
	//°²¼ªÀ­->³¬¼¶¸ñ¶û
	//Âê×È->³¬¼¶Âí×È
	//¼²Ãô->³¬¼¶¼ªÃ×
	//µÂÁ¦Âí->³¬¼¶À×Àû°¢
	//¼ÓË¹->³¬¼¶¼ÓË¹
	//ÂêÙ¯->³¬¼¶ÂíÅ«
	//µÂÒÁ°¢->³¬¼¶À×ÒÁ°¢
	//Õ§°ÍÎÖ¿Ë->³¬¼¶Ôú°ÍÎÖ¿Ë
	//çäÀû->³¬¼¶Ä·Àû
	//çêÒÁÂê->³¬¼¶çê¶ûÂê
	//¿­ÂÞ±´×È->³¬¼¶¿¨±´¶û
	//¼²Ãô->³¬¼¶°ÍÃ×ÀïÎÂ
	//°¢Â·Î÷Ë¹-->³¬¼¶°¢¶ûÏ£Ë¹
	//ÅÁÂÞÄá->³¬¼¶°ÍÂåÄá
	//¿â±´->³¬¼¶¿â±´¶û
	//¾Áçä->
	short sEbodyID[]={987,877,888,899,902,889,896,903,885,900,904,881,890,897,905,
	880,891,898,906,955,884,895,879,886,887,878,892,893,910,883};
	short sConvertEbodyID[]={1270,1247,1257,1268,1272,1258,1265,1273,1254,1269,1274,1251,1259,1266,1275,
	1250,1260,1267,1276,1253,1264,1249,1255,1256,1248,1261,1262,1277,1252};
	*/
	int nECount = sizeof(sEbodyID)/sizeof(sEbodyID[0]);
	int j;
	//Ö÷Ìåid
	sSid = m_UserItem[sMaster].sSid;
	for(i = 0;i<nECount;i++)
	{
		if(sSid == sEbodyID[i])
		{
			break;
		}
	}
	if(i>=nECount)
		return ;
	ReSetItemSlot(&m_UserItem[sMetral1]);
	ReSetItemSlot(&m_UserItem[sMetral2]);
	m_UserItem[sMaster].sSid = sConvertEbodyID[i];
	m_UserItem[sMaster].tIQ = SUPER_EBODY_ITEM;
	m_UserItem[sMaster].tMagic[5] -= 7;
	//¼¶±ðÖØÐÂ¼ÆËã
	if(m_UserItem[sMaster].sSid<0 || m_UserItem[sMaster].sSid > g_arItemTable.GetSize())
		return ;
	//ÊôÐÔ¼¶±ð
	m_UserItem[sMaster].sLevel = g_arItemTable[m_UserItem[sMaster].sSid]->m_byRLevel;
	m_UserItem[sMaster].sDuration = g_arItemTable[m_UserItem[sMaster].sSid]->m_sDuration;
	int itemCount = 0;
	if(m_UserItem[sMaster].tIQ > NORMAL_ITEM)
	{
		if(m_UserItem[sMaster].tIQ == UNIQUE_ITEM) 
			itemCount = MAGIC_NUM;	
		else 
			itemCount = 4;								
		for(i = 0; i < itemCount; i++)
		{
			BYTE bMagic = m_UserItem[sMaster].tMagic[i];
			if(bMagic >= 0 && bMagic < g_arEBodyTable.GetSize())
			{
				m_UserItem[sMaster].sLevel += g_arEBodyTable[bMagic]->m_tLevel;
			}
		}
	}

	//·¢ËÍÎïÆ·±ä»¯
	CByteArray arMaterial;
	arMaterial.RemoveAll();
	arMaterial.Add((BYTE)sMaster);
	arMaterial.Add((BYTE)sMetral1);
	arMaterial.Add((BYTE)sMetral2);

	CBufferEx TempBuf;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	int index = arMaterial.GetSize();
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) 
			TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	FlushItemLog( TRUE );
}
//×ªÖ°
void USER::ChangeJob(int nNewJob,int npcsay)
{
	int i = 0;
	int nOldClass = m_byClass;
	if(m_byClass == nNewJob)
	{
		//SendSystemMsg("ÄãÒÑ¾­ÊÇÖÙ²ÃÕß,ÎÞÐè×ªÖ°!", SYSTEM_ERROR, TO_ME);
		SendEventMsg("ÄãÒÑ¾­ÊÇÖÙ²ÃÕß,ÎÞÐè×ªÖ°!");
        return ;
	}
	bool bHaveItem = false;
	//ÉíÉÏÊÇ·ñÓÐ×°±¸
	for(i = 0;i<10;i++)
	{
		if(m_UserItem[i].sSid != -1)
		{
			bHaveItem = true;
			break;
		}
	}
	if(bHaveItem)
	{
	//	SendSystemMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ×°±¸ºó,ÔÙÀ´×ªÖ°.", SYSTEM_ERROR, TO_ME);
		SendEventMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ×°±¸ºó,ÔÙÀ´×ªÖ°.");
		return ;
	}
	//ÉíÉÏÊÇ·ñÓÐ×°±¸
	for(i = 34;i<40;i++)
	{
		if(m_UserItem[i].sSid != -1)
		{
			bHaveItem = true;
			break;
		}
	}
	if(bHaveItem)
	{
		//SendSystemMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ»úÐµÊØ»¤ºó,ÔÙÀ´×ªÖ°.", SYSTEM_ERROR, TO_ME);
        SendEventMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ»úÐµÊØ»¤ºó,ÔÙÀ´×ªÖ°.");
		return ;
	}
	m_byClass = nNewJob;

	//¼¼ÄÜÇåÁã
	for( i = 0; i < SKILL_COUNT; i++)
	{
		m_UserSkill[i].sSid=i;
		m_UserSkill[i].tLevel = 0;
	}
	for( i = 0; i < 12; i++)
	{
		m_UserSkill_[i].sSid=i;
		m_UserSkill_[i].tLevel = 0;
	}
    for( i = 0; i < 2; i++)
	{
		m_UserSkill140[i].sSid = 0;
		m_UserSkill140[i].tLevel = 0;
	}

	switch (m_byClass)
	{
	case 0://È­
		m_sSTR = 14;
		m_sCON = 15;
		m_sDEX = 10;
		m_sVOL = 9;	
		m_sWIS = 9;
		break;
	case 1:
		m_sSTR = 9;
		m_sCON = 10;
		m_sDEX = 9;
		m_sVOL = 17;
		m_sWIS = 12;
		break;
	case 2:
		m_sSTR = 15;
		m_sCON = 14;
		m_sDEX = 10;
		m_sVOL = 9;
		m_sWIS = 9;
		break;
	case 3:
		m_sSTR = 10;
		m_sCON = 12;
		m_sDEX = 17;
		m_sVOL = 9;
		m_sWIS = 9;
		break;
	case 4:
		m_sSTR = 10;
		m_sCON = 12;
		m_sDEX = 17;
		m_sVOL = 9;
		m_sWIS = 9;
		break;
	}
	DelMyEventNum(251);//120¼¶¼¼ÄÜ
	//DelMyEventNum(300);//ÐÂÊÖ×°±¸¼¼ÄÜ
	//ÇåÀíÄ§·¨
	m_nHavePsiNum = 0;

	for(i = 0; i < TOTAL_PSI_NUM; i++)					// ÃÊ±âÈ­¸¦ ²À ÇØ¾ß ÇÑ´Ù.
	{
		m_UserPsi[i].sSid = -1;
		m_UserPsi[i].tOnOff = FALSE;
	}

	//¼¼ÄÜµã
	m_sPA = (short)(m_sLevel-1)+8;
	int skill_point = 0;
	if( m_sLevel <= 60 )
		skill_point = (int)( (double)m_sLevel / 2 + 0.5 );
	else if( m_sLevel > 60 && m_sLevel <= 99 )
		skill_point = (int)( 30 + (double)m_sLevel - 60 + 0.5 );
	else if( m_sLevel > 99 )
		skill_point = (int)( 30 + 99 - 60 + 0.5 );
	m_sSkillPoint = (short)skill_point;

	if(m_sLevel >= 130 && o_yehuoini[0]->chaoneng == 1)//130¼¶¼¼ÄÜ
	{
		m_sSkillPoint_= m_sLevel - 129;
		if(m_sSkillPoint_ >70)
			m_sSkillPoint_=70;
	}
	for( i = 0;i<2;i++)
	{
		m_UserSkill140[i].sSid = 0;
		m_UserSkill140[i].tLevel = 0;
	}
	//
	GetMagicItemSetting();

	SendMyInfo( TO_INSIGHT, INFO_MODIFY );	// || 

	SendUserStatusSkill();

	SendCharData();

	TCHAR szMsg[200],szOldJob[40],szNewJob[40];
	switch(nOldClass)
	{
	case 0:
		wsprintf(szOldJob,"¸ñ¶·¼Ò");
		break;
	case 1:
		wsprintf(szOldJob,"Ä§·¨Ê¦");
		break;
	case 2:
		wsprintf(szOldJob,"½£ÎäÊ¿");
		break;
	case 3:
		wsprintf(szOldJob,"Ç¹ÐµÊ¦");
		break;
	case 4:
		wsprintf(szOldJob,"ÖÙ²ÃÕß");
		break;
	}
	switch(nNewJob)
	{
	case 0:
		wsprintf(szNewJob,"¸ñ¶·¼Ò");
		break;
	case 1:
		wsprintf(szNewJob,"Ä§·¨Ê¦");
		break;
	case 2:
		wsprintf(szNewJob,"½£ÎäÊ¿");
		break;
	case 3:
		wsprintf(szNewJob,"Ç¹ÐµÊ¦");
		break;
	case 4:
		wsprintf(szNewJob,"ÖÙ²ÃÕß");
		break;
	}
	wsprintf(szMsg,"%s ×ªÖ°³ÉÎª %s",szOldJob,szNewJob);
	SendSayAddStr(npcsay,szMsg);
	//SendSystemMsg("×ªÖ°³É¹¦.Ð»Ð»²ÎÓë", SYSTEM_ANNOUNCE, TO_ME);
}

void USER::StudyNewJobPsi(int sPsi)
{
//	if(m_byClass!=JUDGE)
//		return ;
	BYTE tResult = 1;
	for(int i = 0;i<m_nHavePsiNum;i++)
	{
		if(m_UserPsi[i].sSid == sPsi)
			return ;
	}
	m_UserPsi[m_nHavePsiNum].sSid = sPsi;
	m_UserPsi[m_nHavePsiNum].tOnOff = FALSE;
	m_nHavePsiNum++;
	CBufferEx TempBuf;

	TempBuf.Add(BUY_PSY_RESULT);
	TempBuf.Add(tResult);
	TempBuf.Add(1);

	TempBuf.Add((short)sPsi);
	Send(TempBuf, TempBuf.GetLength());
	SendCharData();
}

//ÅÐ¶ÏÄÜ·ñ¸øÐÂÊÖ×°±¸
BOOL USER::CanGiveNewerItem()
{
	if(FindEvent(300))
	{
	//	SendSystemMsg("ÄãÒÑ¾­ÁìÈ¡ÐÂÊÖ×°±¸,ÇëÎðÖØ¸´ÁìÈ¡.", SYSTEM_ERROR, TO_ME);
		SendEventMsg("ÄãÒÑ¾­ÁìÈ¡ÐÂÊÖ×°±¸,ÇëÎðÖØ¸´ÁìÈ¡.");
		return FALSE;
	}
	int i;
	bool bHaveItem = false;
	//ÉíÉÏÊÇ·ñÓÐ×°±¸
	for(i = 0;i<10;i++)
	{
		if(m_UserItem[i].sSid != -1)
		{
			bHaveItem = true;
			break;
		}
	}
	if(bHaveItem)
	{
		//SendSystemMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ×°±¸ºó,ÔÙÀ´ÁìÈ¡ÐÂÊÖ×°±¸.", SYSTEM_ERROR, TO_ME);
		SendEventMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ×°±¸ºó,ÔÙÀ´ÁìÈ¡ÐÂÊÖ×°±¸.");
		return FALSE;
	}
	//ÉíÉÏÊÇ·ñÓÐ×°±¸
	for(i = 34;i<40;i++)
	{
		if(m_UserItem[i].sSid != -1)
		{
			bHaveItem = true;
			break;
		}
	}
	if(bHaveItem)
	{
		//SendSystemMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ»úÐµÊØ»¤ºó,ÔÙÀ´ÁìÈ¡ÐÂÊÖ×°±¸.", SYSTEM_ERROR, TO_ME);
          SendEventMsg("ÇëÈ¡ÏÂÄúÉíÉÏµÄ»úÐµÊØ»¤ºó,ÔÙÀ´ÁìÈ¡ÐÂÊÖ×°±¸.");
		return FALSE;
	}
	return TRUE;
}
//ÐÂÊÖ×°±¸
void  USER::GiveNewerItem(int nSolt,int sSid,int sCount,int sIQ,int nUpg,int magic0,int magic1,int magic2,int magic3,int magic4)	
{
	if(nSolt<0||nSolt>40)
	{
		return ;
	}
	int itemSize = g_arItemTable.GetSize();
	if(sSid<0||sSid>itemSize)
		return ;

	if(sCount<=0)
		return ;
	if(nUpg>MAX_ITEM_UPGRADE_COUNT)
		return ;
	
	/*
	//ÒÂ¿ãÓë×°±¸
	if(g_arItemTable[sSid]->m_byWear == 1&&(nSolt !=LEFT_HAND||nSolt!=RIGHT_HAND))
	return ;
	if(g_arItemTable[sSid]->m_byWear == 2&&nSolt != HEAD)
	return ;
	if(g_arItemTable[sSid]->m_byWear == 3&&nSolt != BODY)
	return ;
	if(g_arItemTable[sSid]->m_byWear == 4&&nSolt != PANTS)
	return ;
	if(g_arItemTable[sSid]->m_byWear == 5&&nSolt != SHOES)
	return ;
	//»úÐµ
	*/
	ReSetItemSlot(&m_UserItem[nSolt]);
	m_UserItem[nSolt].sSid = sSid;
	m_UserItem[nSolt].sCount = sCount;
	m_UserItem[nSolt].tMagic[0] = magic0;
	m_UserItem[nSolt].tMagic[1] = magic1;
	m_UserItem[nSolt].tMagic[2] = magic2;
	m_UserItem[nSolt].tMagic[3] = magic3;
	m_UserItem[nSolt].tMagic[4] = magic4;
	m_UserItem[nSolt].tMagic[5] = nUpg;
	m_UserItem[nSolt].tIQ = sIQ;

	m_UserItem[nSolt].sDuration = g_arItemTable[sSid]->m_sDuration;
	ResetItemLevelBySolt(nSolt);
}
//ÐÂÊÖ×°±¸·¢ËÍÍê³É
void USER::GiveNewerItemFinish()
{
	GetMagicItemSetting();
	SendCharData();
	SendUserStatusSkill();
    SendMyInfo(TO_INSIGHT, INFO_MODIFY);
	return ;
}
//ÖØÖÃ×°±¸¼¶±ð
void USER::ResetItemLevelBySolt(int sourceSolt)
{
	int i;
	if(sourceSolt < EQUIP_ITEM_NUM || sourceSolt >= TOTAL_INVEN_MAX) 
		return;
	m_UserItem[sourceSolt].sLevel = g_arItemTable[m_UserItem[sourceSolt].sSid]->m_byRLevel;

	//ÖØÖÃ¼¶±ð
	int itemCount;
	if(m_UserItem[sourceSolt].tIQ > NORMAL_ITEM)
	{
		if(m_UserItem[sourceSolt].tIQ == UNIQUE_ITEM) 
			itemCount = MAGIC_NUM;	
		else if(m_UserItem[sourceSolt].tIQ == 12
			||m_UserItem[sourceSolt].tIQ == 18)
			itemCount = 5;								
		else
			itemCount = 4;								
		for(i = 0; i < itemCount; i++)
		{
			BYTE bMagic = m_UserItem[sourceSolt].tMagic[i];
			if(bMagic >= 0 && bMagic < g_arMagicItemTable.GetSize())
			{
				m_UserItem[sourceSolt].sLevel += g_arMagicItemTable[bMagic]->m_tLevel;
			}
		}
	}
}		

//·¢ËÍNPCÌáÊ¾³öÏÖÃû³Æ
void USER::SendSayAddStr(int npcsay,TCHAR *pStrMsg)
{
	if(pStrMsg == NULL)
		return;
	DWORD dwCuttime = GetTickCount();
	static DWORD dwLastTime = 0;
	if(dwCuttime - dwLastTime<1000)
	{
		return ;
	}
	dwLastTime = dwCuttime;
	CBufferEx TempBuf, TempSayBuf;
	TempSayBuf.AddString( pStrMsg );

	TempBuf.Add(CLIENT_EVENT_SAY);
	TempBuf.Add((BYTE)SUCCESS);
	TempBuf.Add((short)npcsay);
	TempBuf.Add((BYTE)0x01);
	TempBuf.AddData(TempSayBuf, TempSayBuf.GetLength());
	Send(TempBuf, TempBuf.GetLength());
	return ;
}		

//ÐÂÖ°ÒµÐèÒª¹¥»÷Á¦ÓëÌåÖÊ×ª³É»¤·¨ÉúÃü
void USER::GetSkillSetting()
{
	if(m_byClass != JUDGE)
	{
		return ;
	}
	//ÖÙ²Ã¼¼ÄÜ
	for (int i=SKILL_JUDGE_QIANGHUAHUFA;i<SKILL_COUNT;i++)
	{
		switch(i)
		{
		case SKILL_JUDGE_QIANGHUAHUFA://Ç¿»¯»¤·¨
			{
				break;
			}
		case SKILL_JUDGE_RENMINBUXI://Éú»î²»Ï¢
			{
				int iLevel = m_UserSkill[i].tLevel;		
				if(iLevel < 0)
					iLevel = 0;
				if(iLevel >= 1) 
					iLevel += m_DynamicUserData[MAGIC_ALL_SKILL_UP];

				if(iLevel >= g_arSkillTable[i]->m_arSuccess.GetSize()) 
					return ;
				if(iLevel >= SKILL_LEVEL) 
					iLevel = SKILL_LEVEL - 1;

				if(i >= g_arSkillTable.GetSize())
					return ;
				int iPos = g_arSkillTable[i]->m_arInc.GetAt(iLevel);
				m_DynamicUserData[MAGIC_MAX_HP_UP]+=m_sCON*iPos/100;
				break;
			}
		}
	}
}

void USER::UserJudgeSkill_ToStr(TCHAR *pBuf)
{
	int	index = 0;
	int i ;
	//ÁíÍâ5¸öÐÂÖ°Òµ¼¼ÄÜ
	//0x19,0x1a,0x1b,0x1c,0x18
	for(i = 25;i<SKILL_COUNT;i++)
	{
		SetShort(pBuf, m_UserSkill[i].sSid,		index);
		SetByte (pBuf, m_UserSkill[i].tLevel,	index);
	}
	SetShort(pBuf, m_UserSkill[24].sSid,		index);
	SetByte (pBuf, m_UserSkill[24].tLevel,	index);
}

void USER::User140SkillToStr(TCHAR *pBuf)
{
	int	index = 0;
	int i ;
	//140¼¶¼¼ÄÜ
	//0x10,0x11,0x12
	for(i = 16;i<19;i++)
    {
		SetShort(pBuf, i,	index);
		//¶ÁÈ¡³ö´í,±ØÐëÖØÖÃ
		if(m_UserSkill_[i].tLevel > 20 || m_sLevel <130)
			m_UserSkill_[i].tLevel = 0;

		SetByte (pBuf, m_UserSkill_[i].tLevel,	index);
	}
}

void USER::AddHuFaStatus(DWORD dwAbnormal)
{
	m_dwJudgePsiState |= dwAbnormal;
}

void USER::DelHuFaStatus(DWORD dwAbnormal)
{

	m_dwJudgePsiState &= (~dwAbnormal);
}

BOOL USER::CheckHuFaStatus(DWORD dwAbnormal)
{
	if((m_dwJudgePsiState & dwAbnormal) == dwAbnormal) 
		return TRUE;
	else
		return FALSE;
}
//ÊÇ·ñ´æÔÚÕÙ»½µÀ¾ã
 BOOL USER::SubInvernItemBySsid(int iSid)
 {
	 int tSlot ;
	 for( tSlot = EQUIP_ITEM_NUM;tSlot<TOTAL_INVEN_MAX;tSlot++)
	 {
		 if(m_UserItem[tSlot].sSid ==0xffff)
			 continue;
		if(m_UserItem[tSlot].sSid == iSid)
		{
			break;
		}
	 }
	 if(tSlot >=TOTAL_INVEN_MAX)
	 {
		 if(iSid<0||iSid>g_arItemTable.GetSize())
			 return FALSE;
		 CString strMsg;
		 strMsg.Format("ÄãÐèÒªµÀ¾ß %s ",g_arItemTable[iSid]->m_strName);
		 SendSystemMsg(strMsg.GetBuffer(0), SYSTEM_NORMAL, TO_ME);
		 return FALSE;
	 }
	 m_UserItem[tSlot].sCount--;
	 if(m_UserItem[tSlot].sCount<=0)
		 ReSetItemSlot(&m_UserItem[tSlot]);

	 CBufferEx TempBuf;
	 TempBuf.Add(ITEM_USE_RESULT);
	 TempBuf.Add(SUCCESS);
	 TempBuf.Add((BYTE)QUICK_ITEM_TELEPORT);
	 TempBuf.Add((BYTE)tSlot);
	 TempBuf.Add(m_UserItem[tSlot].sLevel);
	 TempBuf.Add(m_UserItem[tSlot].sSid);
	 TempBuf.Add(m_UserItem[tSlot].sDuration);
	 TempBuf.Add(m_UserItem[tSlot].sBullNum);
	 TempBuf.Add(m_UserItem[tSlot].sCount);
	 for(int i = 0; i < MAGIC_NUM; i++) 
		 TempBuf.Add(m_UserItem[tSlot].tMagic[i]);
	 TempBuf.Add(m_UserItem[tSlot].tIQ);
	 Send(TempBuf, TempBuf.GetLength());
	 return TRUE;
 }
 BOOL USER::SubInvernItemBySolt(short tSlot)
 {
	 if(tSlot<EQUIP_ITEM_NUM||tSlot>=TOTAL_INVEN_MAX)
		 return FALSE;
	if(m_UserItem[tSlot].sSid ==0xffff)
		return FALSE;
	int iSid = m_UserItem[tSlot].sSid;

	 if(tSlot >=TOTAL_INVEN_MAX)
	 {
		 if(iSid<0||iSid>g_arItemTable.GetSize())
			 return FALSE;
		 CString strMsg;
		 strMsg.Format("ÄãÃ»ÓÐµÀ¾ã %s ",g_arItemTable[iSid]->m_strName);
		 SendSystemMsg(strMsg.GetBuffer(0), SYSTEM_NORMAL, TO_ME);
		 return FALSE;
	 }
	 m_UserItem[tSlot].sCount--;
	 if(m_UserItem[tSlot].sCount<=0)
		 ReSetItemSlot(&m_UserItem[tSlot]);

	 CBufferEx TempBuf;
	 TempBuf.Add(ITEM_USE_RESULT);
	 TempBuf.Add(SUCCESS);
	 TempBuf.Add((BYTE)QUICK_ITEM_TELEPORT);//Ê¹ÓÃ³èÎïËÇÁÏ£¬´ËÖµÎª116
	 TempBuf.Add((BYTE)tSlot);
	 TempBuf.Add(m_UserItem[tSlot].sLevel);
	 TempBuf.Add(m_UserItem[tSlot].sSid);
	 TempBuf.Add(m_UserItem[tSlot].sDuration);
	 TempBuf.Add(m_UserItem[tSlot].sBullNum);
	 TempBuf.Add(m_UserItem[tSlot].sCount);
	 for(int i = 0; i < MAGIC_NUM; i++) 
		 TempBuf.Add(m_UserItem[tSlot].tMagic[i]);
	 TempBuf.Add(m_UserItem[tSlot].tIQ);
	 Send(TempBuf, TempBuf.GetLength());
	 return TRUE;
 }									

BOOL USER::CallHuFa(BYTE tType)
{
//	static DWORD dw = 1000*60*10,dwLast = 0;

//	if(m_byClass!=JUDGE)
//		return FALSE;
	if(m_dwXiShengTime !=0){
			SendSystemMsg("ÎþÉü»¤·¨×´Ì¬ÏÂ²»ÄÜÕÙ»½»¤·¨,ÇëµÈ´ý5·ÖÖÓºóÕÙ»½.", SYSTEM_ERROR, TO_ME);
			return false;
		}

/*	DWORD dwCur = GetTickCount();
	DWORD dwSpace = dwCur - dwLast;
	if(dwSpace < dw)
	{
		CString str;
		str.Format("ÄúÕÙ»½»¤·¨»¹ÐèµÈ´ý%d·Ö%dÃë.",(dw - dwSpace)/60/1000,((dw - dwSpace)/1000)%60);
		SendSystemMsg(str.GetBuffer(0), SYSTEM_ERROR, TO_ME);
		return FALSE;
	}
	dwLast = dwCur;*/
	switch(tType)
	{
	case 1://ÒÁÍ¿ÂÞ8000+
		{
			//80¼¶  10010
			//120¼¶ 17500
			m_nHuFaMaxHP = 16000+m_sLevel*40+50*m_sMagicWIS;
			//130¼¶¼¼ÄÜÔö¼Ó»¤·¨Ñª
			//Æðµã17%,Ã¿¼¶Ôö¼Ó2%µã
			if(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel>0&&m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel<20)
			{
				int nAdd = m_nHuFaMaxHP*(17+2*(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel-1))/100;
				m_nHuFaMaxHP +=nAdd;
			}
			m_nHuFaHP = m_nHuFaMaxHP;
			break;
		}
	case 2://ÆÕÀ×Ëþ15000+	
		{//120¼¶ 31250
			m_nHuFaMaxHP = 30000+m_sLevel*40+50*m_sMagicWIS;
			//130¼¶¼¼ÄÜÔö¼Ó»¤·¨Ñª
			//Æðµã17%,Ã¿¼¶Ôö¼Ó2%µã
			if(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel>0&&m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel<20)
			{
				int nAdd = m_nHuFaMaxHP*(17+2*(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel-1))/100;
				m_nHuFaMaxHP +=nAdd;
			}
			m_nHuFaHP = m_nHuFaMaxHP;
			break;
		}
	case 3://
		{
			m_nHuFaMaxHP = 48000+m_sLevel*40+50*m_sMagicWIS;
			//130¼¶¼¼ÄÜÔö¼Ó»¤·¨Ñª
			//Æðµã17%,Ã¿¼¶Ôö¼Ó2%µã
			if(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel>0&&m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel<20)
			{
				int nAdd = m_nHuFaMaxHP*(17+2*(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel-1))/100;
				m_nHuFaMaxHP +=nAdd;
			}
			m_nHuFaHP = m_nHuFaMaxHP;
			break;
		}
	case 4:
		{
			m_nHuFaMaxHP = 80000+m_sLevel*40+50*m_sMagicWIS;
			//130¼¶¼¼ÄÜÔö¼Ó»¤·¨Ñª
			//Æðµã17%,Ã¿¼¶Ôö¼Ó2%µã
			if(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel>0&&m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel<20)
			{
				int nAdd = m_nHuFaMaxHP*(17+2*(m_UserSkill_[SKILL_130_REN_MI_FU_HA].tLevel-1))/100;
				m_nHuFaMaxHP +=nAdd;
			}
			m_nHuFaHP = m_nHuFaMaxHP;
			break;
		}
	case 0:
	default:
		return FALSE;
		break;
	}
	//²âÊÔ
//#ifdef _DEBUG
//		m_nHuFaMaxHP = 1000;
//		m_nHuFaHP = 1000;	
//#endif
//	m_dwLastCallHuFaTime = dwCur;
	m_dwLevealHuFaTime = 1000*60*60;
	m_tHuFaType = tType;

	CPoint pt = FindNearAvailablePoint_S(m_curx,m_cury);
	if(pt.x == -1||pt.y == -1)
		return FALSE;
	m_xHuFa = pt.x;
	m_yHuFa = pt.y;

	SendNewHufaInfo();
	//CPoint pt = FindNearAvailablePoint_S(m_curx,m_cury);
	//if(pt.x == -1||pt.y == -1)
	//	return ;
	//CPoint ptNew = ConvertToClient( pt.x, pt.y );

	//if( ptNew.x == -1 || ptNew.y == -1 ) 
	//	return;
	//
	//CBufferEx TempBuf;
	//TempBuf.Add(PK_BUTTON_REQ);
	//TempBuf.Add((BYTE)0x43);
	//TempBuf.Add((BYTE)0x01);
	//TempBuf.Add((int)m_uid+USER_BAND+USER_HUFA_BAND);
	//TempBuf.Add((BYTE)m_tHuFaType);
	//TempBuf.Add((int)m_nHuFaMaxHP);
	//TempBuf.Add((int)m_nHuFaHP);
	//TempBuf.Add((BYTE)m_tDir);
	//TempBuf.Add((int)m_curz);
	//TempBuf.Add((int)ptNew.x);
	//TempBuf.Add((int)ptNew.y);
	//Send(TempBuf, TempBuf.GetLength());

#ifdef _USE_Guo_Fu_
	SendHuFaInfo(this,TO_INSIGHT);
#endif
	return TRUE;
}
void USER::SendHuFaInfo(USER *pUser,BYTE towho)
{
	if(pUser ==NULL)
		return ;
	if(pUser->m_tHuFaType == 0)
		return ;
	CPoint pt = FindNearAvailablePoint_S(pUser->m_curx,pUser->m_cury);
	if(pt.x == -1||pt.y == -1)
		return ;

	CPoint ptNew = ConvertToClient( pt.x, pt.y );

	if( ptNew.x == -1 || ptNew.y == -1 ) 
		return;

	CBufferEx TempBuf2;

	TempBuf2.Add(PK_BUTTON_REQ);
	TempBuf2.Add((BYTE)0x44);
	TempBuf2.Add((int)pUser->m_uid+USER_BAND+USER_HUFA_BAND);
	TempBuf2.Add((BYTE)pUser->m_tHuFaType);
	TempBuf2.Add((int)pUser->m_nHuFaHP);
	TempBuf2.Add((int)pUser->m_nHuFaMaxHP);
	TempBuf2.Add((BYTE)pUser->m_tDir);
	TempBuf2.Add((int)pUser->m_curz);
	TempBuf2.Add((int)ptNew.x-1);//»¤·¨µÄ×ø±ê,½â¾öµ²×¡½ÇÉ«µÄBUG
	TempBuf2.Add((int)ptNew.y-2);//»¤·¨µÄ×ø±ê,½â¾öµ²×¡½ÇÉ«µÄBUG
	switch(towho)
	{
	case TO_ALL:
		SendAll(TempBuf2, TempBuf2.GetLength());
		break;

	case TO_ME:
		Send(TempBuf2, TempBuf2.GetLength());
		break;

	case TO_ZONE:
		SendZone(TempBuf2, TempBuf2.GetLength());
		break;

	case TO_INSIGHT:
	default:
		SendInsight(TempBuf2, TempBuf2.GetLength());
		break;
	}
	SendJudgePsiStatus();
}
//·¢ËÍ»¤·¨ÒÆ¶¯ÏûÏ¢
void USER::SendHuFaMoveInfo(BYTE bMoveType)
{
	if(m_tHuFaType == 0)
		return ;
	CPoint pt;// = FindNearAvailablePoint_S(m_curx,m_cury);
	pt.x = m_curx+1;
	pt.y = m_cury+2;

	if(pt.x == -1||pt.y == -1)
		return;

	CPoint ptNew = ConvertToClient(pt.x,pt.y );
	if( ptNew.x == -1 || ptNew.y == -1 ) 
	{
		return ;
	}
	BYTE bSuc = 0x01;
	int index = 0;
	SetByte(m_TempBuf, bMoveType, index);
	SetByte(m_TempBuf, bSuc, index);
	SetInt(m_TempBuf, m_uid + USER_BAND + USER_HUFA_BAND, index);
	SetShort(m_TempBuf, ptNew.x, index);
	SetShort(m_TempBuf, ptNew.y, index);
	SendInsight(m_TempBuf, index);
}
//ÐÂ³öÉú»¤·¨ÐÅÏ¢
void USER::SendNewHufaInfo()
{
	if(m_tHuFaType == 0)
		return ;
	CPoint pt = FindNearAvailablePoint_S(m_curx,m_cury);
	if(pt.x == -1||pt.y == -1)
		return ;
	CPoint ptNew = ConvertToClient( pt.x, pt.y );

	if( ptNew.x == -1 || ptNew.y == -1 ) 
		return;

	CBufferEx TempBuf;
	TempBuf.Add(PK_BUTTON_REQ);
	TempBuf.Add((BYTE)0x43);
	TempBuf.Add((BYTE)0x01);
	TempBuf.Add((int)m_uid+USER_BAND+USER_HUFA_BAND);
	TempBuf.Add((BYTE)m_tHuFaType);
	TempBuf.Add((int)m_nHuFaHP);
	TempBuf.Add((int)m_nHuFaMaxHP);
	TempBuf.Add((BYTE)m_tDir);
	TempBuf.Add((int)m_curz);
	TempBuf.Add((int)ptNew.x);
	TempBuf.Add((int)ptNew.y);

	Send(TempBuf, TempBuf.GetLength());
}

//¼ÓÈë»¤·¨·¢ËÍ¶ÓÁÐ
void USER::AddHuFaDataBuf(USER *pUser,TCHAR *pData,int &nIndex)
{	
	if(pUser == NULL)
		return ;
	if(pUser->m_tHuFaType == 0)
		return ;
	CPoint pt = FindNearAvailablePoint_S(pUser->m_curx,pUser->m_cury);
	if(pt.x == -1||pt.y == -1)
		return ;
	CPoint ptNew = ConvertToClient( pt.x, pt.y );

	if( ptNew.x == -1 || ptNew.y == -1 ) 
		return;

	////0x43
	//SetByte(pData,PK_BUTTON_REQ,nIndex);
	//SetByte(pData,0x43,nIndex);
	//SetByte(pData,0x01,nIndex);
	//SetInt(pData,(int)pUser->m_uid+USER_BAND+USER_HUFA_BAND,nIndex);
	//SetByte(pData,(BYTE)pUser->m_tHuFaType,nIndex);
	//SetInt(pData,(int)pUser->m_nHuFaMaxHP,nIndex);
	//SetInt(pData,(int)pUser->m_nHuFaHP,nIndex);
	//SetByte(pData,(BYTE)pUser->m_tDir,nIndex);
	//SetInt(pData,(int)pUser->m_curz,nIndex);
	//SetInt(pData,(int)ptNew.x,nIndex);
	//SetInt(pData,(int)ptNew.y,nIndex);

	//0x44
	SetByte(pData,PK_BUTTON_REQ,nIndex);
	SetByte(pData,0x44,nIndex);
	SetInt(pData,(int)pUser->m_uid+USER_BAND+USER_HUFA_BAND,nIndex);
	SetByte(pData,(BYTE)pUser->m_tHuFaType,nIndex);
	SetInt(pData,(int)pUser->m_nHuFaHP,nIndex);
	SetInt(pData,(int)pUser->m_nHuFaMaxHP,nIndex);
	SetByte(pData,(BYTE)pUser->m_tDir,nIndex);
	SetInt(pData,(int)pUser->m_curz,nIndex);
	SetInt(pData,(int)ptNew.x,nIndex);
	SetInt(pData,(int)ptNew.y,nIndex);
}

//ÖÇÁ¦ÉÏÉý
void USER::SendJudgePsiStatus(BYTE bType)
{
	CBufferEx TempBuf2;

	TempBuf2.Add(PK_BUTTON_REQ);
	TempBuf2.Add((BYTE)0x17);
	TempBuf2.Add((int)m_uid+USER_BAND);
	TempBuf2.Add((int)m_dwJudgePsiState);
	TempBuf2.Add((int)m_dwJudgePsiExState);
	switch(bType)
	{
/*	case TO_ME:
		Send(TempBuf2, TempBuf2.GetLength());
	default:
		SendInsight(TempBuf2, TempBuf2.GetLength());
		break;*/

	case TO_ALL:
		SendAll(TempBuf2, TempBuf2.GetLength());
		break;

	case TO_ME:
		Send(TempBuf2, TempBuf2.GetLength());
		break;

	case TO_ZONE:
		SendZone(TempBuf2, TempBuf2.GetLength());
		break;

	case TO_INSIGHT:
	default:
		SendInsight(TempBuf2, TempBuf2.GetLength());
		break;

	}
}

//¸üÐÂ»¤·¨ÑªÁ¿
//0x4c,0x5c,0x44,0x00,0x00,0x5c,0x44,0x00,0x00,
void USER::SendHuFaHPInfo()
{
	CBufferEx TempBuf2;
	TempBuf2.Add(PK_BUTTON_REQ);
	TempBuf2.Add((BYTE)0x4c);
	TempBuf2.Add(m_nHuFaHP);
	TempBuf2.Add(m_nHuFaMaxHP);
	SendInsight(TempBuf2, TempBuf2.GetLength());
}													

//»¤·¨ÏûÊ§
//0x3e,0x45,0xc8,0x79,0x00,0x00,
void USER::SendHuFaPostion(int nType)
{
	CBufferEx TempBuf2;
	TempBuf2.Add(PK_BUTTON_REQ);
	TempBuf2.Add((BYTE)0x45);
	TempBuf2.Add((int)m_uid+USER_BAND+USER_HUFA_BAND);
	SendInsight(TempBuf2, TempBuf2.GetLength());
	if(nType)
	{
		m_tHuFaType = 0;
		m_nHuFaHP = 0;
		m_nHuFaMaxHP =0 ;
		//SendSystemMsg("ÕÙ»½µÄ»¤·¨ÒÑ¾­ËÀÍö",SYSTEM_NORMAL,TO_ME);
	}
}
//ÉèÖÃ»¤·¨ÉËº¦
void USER::SetHuFaDamage(int nDamage)
{
	if(nDamage <= 0) 
		return;
	if(m_bLive == USER_DEAD)
		return;
	//ÓÃ»§µôÑªÏÔÊ¾
	SendDamageNum(0,m_uid+USER_BAND+USER_HUFA_BAND,nDamage);	
	m_nHuFaHP -= nDamage;
	if( m_nHuFaHP <= 0 )
	{
		m_nHuFaHP = 0;
		SendHuFaPostion(HUFA_DEA);
	}
	else
	{
		SendNpcHP(m_uid+USER_BAND+USER_HUFA_BAND,m_nHuFaHP);
		SendHuFaHPInfo();	
	}
}		
//»ñÈ¡»¤·¨ÉËº¦¹¥»÷Öµ
int  USER::GetHuFaDamage()										
{
	int nBase = 15;
	switch(m_tHuFaType)
	{
	case 0x01:
		nBase+=80;
		break;
	case 0x02:
		nBase+=160;
		break;
	case 0x03:
		nBase+=320;
		break;
	case 0x04:
		nBase+=480;
		break;
	}
	
	//Ç¿»¯»¤·¨,ÖÇÁ¦±ä³É»¤·¨¹¥»÷Á¦
	int iLevel = m_UserSkill[SKILL_JUDGE_QIANGHUAHUFA].tLevel;		
	if(iLevel < 0)
		iLevel = 0;
	if(iLevel >= 1) 
		iLevel += m_DynamicUserData[MAGIC_ALL_SKILL_UP];

	if(iLevel >= g_arSkillTable[SKILL_JUDGE_QIANGHUAHUFA]->m_arSuccess.GetSize()) 
		return nBase;
	if(iLevel >= SKILL_LEVEL) 
		iLevel = SKILL_LEVEL - 1;

	if(SKILL_JUDGE_QIANGHUAHUFA >= g_arSkillTable.GetSize())
		return nBase;
	int iPos = g_arSkillTable[SKILL_JUDGE_QIANGHUAHUFA]->m_arInc.GetAt(iLevel);
	nBase+=m_sWIS*iPos/100;
	return nBase;
}
//»ñÈ¡·´»÷¹¥»÷
int  USER::HuFaAttack(int npcid)	
{
	int sHP = 0,sMaxHP = 0;
	DWORD dwCur = GetTickCount();
	//»¤·¨¹¥»÷2ÃëÒ»´Î
	if(dwCur - m_dwHuFaLastAttack<2000)
		return 0;
	m_dwHuFaLastAttack = dwCur;
	//»¤·¨¹¥»÷
	if(m_tHuFaType !=0&&m_nHuFaHP>0)
	{
		int nDamage = GetHuFaDamage();
		if(nDamage<15)
			nDamage = 15;
		//»¤·¨¹¥»÷Ä¿±êÈ¥Ñª
		if(npcid >= USER_BAND && npcid < NPC_BAND)
		{
			USER *pUser = GetUser(npcid-USER_BAND);
			if(pUser)
			{
				pUser->SetDamage(nDamage);
				sHP = pUser->m_sHP;
				sMaxHP = pUser->m_sMaxHP;
			}
			//ÓÃ»§µôÑªÏÔÊ¾
			SendDamageNum(0,npcid,nDamage);	
		}else
		{
			CNpc *pNpc = GetNpc(npcid-NPC_BAND);
			if(pNpc)
			{
				pNpc->SetHuFaFinalDamage(this,nDamage);
				sHP = pNpc->m_sHP;
				sMaxHP = pNpc->m_sMaxHP;
			}
			//npcµôÑª
			//SendDamageNum(1,npcid,nDamage);	

			SendNpcHP(npcid,sHP);
		}
		CBufferEx TempBuf2;

		TempBuf2.Add(ATTACK_RESULT);//¹ú·þÒÑ¾­ÐÞÕý

		TempBuf2.Add(ATTACK_SUCCESS);

		TempBuf2.Add((int)(m_uid + USER_BAND+USER_HUFA_BAND));
		TempBuf2.Add(npcid);
#ifdef _USE_Guo_Fu_
		TempBuf2.Add((int)sHP);
		TempBuf2.Add((int)sMaxHP);
#else
		TempBuf2.Add((short)sHP);
		TempBuf2.Add((short)sMaxHP);
#endif
		if(m_curz == 61 || m_curz == 62 || m_curz == 63)
			SendInsight(TempBuf2, TempBuf2.GetLength());
		else 
			SendExactScreen(TempBuf2, TempBuf2.GetLength());
	}
	return 0;
}
//Èº¹¥ÉËº¦
void USER::SendWideRangeAttack(int x, int y,int psi,int damage)
{
	if( m_ZoneIndex < 0 || m_ZoneIndex >= g_zone.GetSize() ) return;

	int dir[9][2];
	int ix, iy;
	int nTarget = 0;
	int nDamage = 0;

	USER* pUser = NULL;
	CNpc* pNpc = NULL;
	MAP* pMap = g_zone[m_ZoneIndex];
	if(!pMap) return;

	dir[0][0]  =  0;		dir[0][1] =  0;		// 
	dir[1][0]  = -1;		dir[1][1] =  0;		// 
	dir[2][0]  = -1;		dir[2][1] =  1;		// 
	dir[3][0]  =  0;		dir[3][1] =  1;		// 
	dir[4][0]  =  1;		dir[4][1] =  1;		// 

	dir[5][0]  =  1;		dir[5][1] =  0;		// 
	dir[6][0]  =  1;		dir[6][1] = -1;		// 
	dir[7][0]  =  0;		dir[7][1] = -1;		// 
	dir[8][0]  = -1;		dir[8][1] = -1;		// 

	for(int i = 1; i < 9; i++)
	{
		ix = x + dir[i][0];
		iy = y + dir[i][1];

		if(ix < 0) ix = 0;
		if(iy < 0) iy = 0;
		if(ix >= pMap->m_sizeMap.cx) ix = pMap->m_sizeMap.cx - 1;
		if(iy >= pMap->m_sizeMap.cy) iy = pMap->m_sizeMap.cy - 1;

		nTarget = pMap->m_pMap[ix][iy].m_lUser;

		if(nTarget >= USER_BAND && nTarget < NPC_BAND)	// USER
		{
			pUser = GetUser(nTarget - USER_BAND);			// User Pointer ¸¦ ¾ò´Â´Ù.
			if(pUser == NULL || pUser->m_state != STATE_GAMESTARTED) continue;	
			if(pUser->m_bLive == USER_DEAD || pUser->m_uid == m_uid)	continue;		// Target User °¡ ÀÌ¹Ì Á×¾îÀÖÀ¸¸é ¸®ÅÏ
			if(!pUser->m_bPkStatus) continue;				// ÀÏ½ÃÀû Ä«¿À°¡ ¾Æ´Ï¸é °ø°ÝÀÌ ¾ÈµÈ´Ù.

			if(m_dwGuild > 0)
			{
				if(m_tGuildWar == GUILD_WARRING && pUser->m_tGuildWar == GUILD_WARRING)
				{												
					if(pUser->m_dwGuild == m_dwGuild)  return;
				}

				if(m_tFortressWar == GUILD_WARRING && pUser->m_tFortressWar == GUILD_WARRING)
				{												// ±æµåÀüÀÏ¶§ ÀÏ½ÃÀû Ä«¿À´Â °°Àº±æµå¿ø¿¡°Ô´Â ¹«½Ã
					if(pUser->m_dwGuild == m_dwGuild)  return;
				}																			
			}

			nDamage = (int)((double)damage *  ((double)m_sMagicVOL / (m_sMagicVOL + pUser->m_sMagicVOL + pUser->m_DynamicUserData[MAGIC_PSI_RESIST_UP] + \
				(int)((double)pUser->m_DynamicEBodyData[EBODY_PSI_RESIST_UP] / 100) \
				)));
			nDamage = (int)((double)nDamage/2 + 0.5);	// µ¥¹ÌÁöÀÇ 50%¸¸ µé¾î°£´Ù.

			pUser->SetDamage(nDamage);
			if(pUser->m_sHP > 0)		// »ìÀº °æ¿ì Àü±âµ¥¹ÌÁö Ãß°¡
			{
				//				pUser->SetColdDamage();
			}
			else if(pUser->m_lDeadUsed == 1)
			{
				int tempRank = m_sCityRank + CITY_RANK_INTERVAL;
				IsChangeCityRank(m_sCityRank, pUser);
				pUser->GetLevelDownExp(USER_PK, tempRank, FALSE,m_strUserID);			// °æÇèÄ¡¿Í ±×¿Ü º¯È­·®¸¦ ¹Ý¿µÇÑ´Ù.
			}
		}
		else if(nTarget >= NPC_BAND)				// NPC
		{
			pNpc = GetNpc(nTarget - NPC_BAND);				// NPC Point ¸¦ ¾ò´Â´Ù.
			if(pNpc == NULL) continue;					// Àß¸øµÈ NPC ÀÌ¸é ¸®ÅÏ
			if(pNpc->m_NpcState == NPC_DEAD || pNpc->m_tNpcType != NPCTYPE_MONSTER) continue;	// NPC °¡ ÀÌ¹Ì Á×¾î ÀÖÀ¸¸é ¸®ÅÏ
			if(pNpc->m_sHP <= 0) continue;
			if(pNpc->m_byAX == 0 && pNpc->m_byAZ == 0 && pNpc->m_tNpcType == 0) continue;			// °ø°Ý´É·ÂÀÌ ¾ø´Â ¸ó½ºÅÍ(ÇöÀç ¿ø¼®)Àº ÀÏ¹Ý °ø°ÝÀÌ µÇÁö ¾Ê´Â´Ù.

			nDamage = (int)(damage *  ((double)m_sMagicVOL / (m_sMagicVOL + pNpc->m_sVOL)));
			nDamage = (int)((double)nDamage/2 + 0.5);	// µ¥¹ÌÁöÀÇ 50%¸¸ µé¾î°£´Ù.

			//			if(pNpc->SetDamage(nDamage, m_strUserID, m_uid + USER_BAND, m_pCom) == FALSE)
			if(pNpc->SetDamage(nDamage, m_uid + USER_BAND, m_pCom) == FALSE)
			{
				if(m_tGuildHouseWar == GUILD_WARRING && pNpc->m_NpcVirtualState == NPC_WAIT)
				{
					CheckGuildHouseWarEnd();
				}

				pNpc->SendExpToUserList(m_pCom); // °æÇèÄ¡ ºÐ¹è!!
				int diffLevel = abs(m_sLevel - pNpc->m_byClassLevel);
				if(diffLevel <= o_yehuoini[0]->djxz || pNpc->m_sEvent != 0 )
				{
					if (m_isDoubleBAOLV  > 0 || g_sanBaoLv == TRUE || m_dwGuarDianTianShi > 0)
						pNpc->SendDead(m_pCom,1,TRUE);
					else
						pNpc->SendDead(m_pCom);
				}
				else
				{
					pNpc->SendDead(m_pCom,0);
					SendSystemMsg("ÄúºÍµ±Ç°¹ÖÎïµÈ¼¶Ïà²î20,Ã»ÓÐÈÎºÎËùµÃ", SYSTEM_ERROR,TO_ME);
				}
			/*if (m_dwShaGuai >= 3000 ) 
			{
	            SendSystemMsg("Äú½ñÈÕÉ±¹ÖÊýÁ¿ÒÑÂú,´ò¹ÖÎÞ·¨»ñµÃÈÎºÎ¾­ÑéÖµ", SYSTEM_ERROR,TO_ME);
			}  */
		 //if(diffLevel <= o_yehuoini[0]->djxz  &&  pNpc->m_tNpcType == 0 )
			//   {
			//	   CString strMsg;
			//	   if (m_dwShaGuai == 1000)
			//	   {
			//		   SetUserToMagicUser();
			//           CheckMagicItemMove();
			//           UpdateUserData();
			//		   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 5 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
			//		   m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
			//	   }else if (m_dwShaGuai == 2000)
			//	   {
			//		    SetUserToMagicUser();
			//           CheckMagicItemMove();
			//           UpdateUserData();
			//		   
			//		   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 10 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
			//		  m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
			//	   }else if (m_dwShaGuai == 3000)
			//	   {
			//		    SetUserToMagicUser();
			//           CheckMagicItemMove();
			//           UpdateUserData();
			//		    
			//		   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 15 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
			//		m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
			//	   }else if (m_dwShaGuai == 4000)
			//	   {
			//		   SetUserToMagicUser();
			//           CheckMagicItemMove();
			//           UpdateUserData();
			//		    
			//		   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 20 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
			//		m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
			//	   }else if (m_dwShaGuai == 5000)
			//	   {
			//		    SetUserToMagicUser();
			//           CheckMagicItemMove();
			//           UpdateUserData();
			//		   
			//		   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 30 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
			//		m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
			//	   }
			//   }

			
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

				if(diffLevel < 40)
				{
					m_iCityValue=m_iCityValue+250;
					m_dwShaGuai=m_dwShaGuai+1;
					GetCityRank();
					CheckMaxValue(m_dwXP, 1);		
					SendXP();
					SendUserStatusSkill();
				}
			}
			else									// »ìÀº °æ¿ì Àü±âµ¥¹ÌÁö Ãß°¡
			{
				//				pNpc->SetColdDamage();
			}
			SendDamageNum(1,nTarget,nDamage);
			SendNpcHP(nTarget,pNpc->m_sHP);		
		}
	}
	return ;
}


//ÁìÈ¡³äÖµ½á¹ûÎªÎïÆ·Àà
/*void USER::OnlineExchange(int nErrorSay,int nSucSay)
{
	DWORD dwCuttime = GetTickCount();
	static DWORD dwLastTime = 0;
	if(dwCuttime - dwLastTime<5000)
	{
		return ;
	}
	dwLastTime = dwCuttime;
	//»ñÈ¡ÊÇ·ñ´æÔÚÎ´¶Ò»»µÄÌõÄ¿
	//¶Ò»»±àÂë
	int exCount = 0;
	typedef struct _Ex_Code_Array_
	{
		int nSID;
		int nrmbCode;
	}Ex_Code_Array;
	Ex_Code_Array exCodeArray[10] = {{0,0}};
	CDatabase*	pDB;
	SQLHSTMT	hstmt = NULL;
	TCHAR		szSQL[1024];	
	SQLRETURN	retcode;

	int	nDBIndex;
	int	i;
	::ZeroMemory( szSQL, sizeof(szSQL) );

	nDBIndex = 0;

	pDB = g_DB[m_iModSid].GetDB( nDBIndex );
	if( !pDB ) 
		return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS ) 
		return;

	_sntprintf(szSQL, sizeof(szSQL), TEXT( "select sid,rmbpoint from rmbshop where struserid='%s' and state=0" ),m_strUserID );
	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));

	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		SQLINTEGER		iSID;
		SQLINTEGER		nCode;
		SQLINTEGER		ivd;

		while (TRUE)
		{
			retcode = SQLFetch(hstmt);

			if (retcode ==SQL_SUCCESS || retcode ==SQL_SUCCESS_WITH_INFO)
			{
				i = 1;

				SQLGetData( hstmt, i++, SQL_C_SLONG, &iSID, sizeof(iSID), &ivd );
				SQLGetData( hstmt, i++, SQL_C_SLONG, &nCode, sizeof(nCode), &ivd );
                //×î¶àÖ»¶Ò»»Ê®Ïî
				exCodeArray[exCount].nSID = iSID;
				exCodeArray[exCount].nrmbCode = nCode;

				if(exCount++>=10)
					break;
			}
			else break;
		}	
	}
	else
	{
		DisplayErrorMsg(hstmt);
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		g_DB[m_iModSid].ReleaseDB(nDBIndex);
		return;
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(nDBIndex);

	//ÅÐ¶Ï¸üÐÂÌõÄ¿ÊÇ·ñºÏ·¨
	if(exCount<=0)
	{
		SendNpcSay(0,nErrorSay);
		return ;
	}
	int nRmbCount = g_arOnlineRMBShopTable.GetSize();
	int nPos=0;
	for(i = 0;i<exCount;i++)
	{
		//ÅÐ¶ÏÄÜ¹»¶Ò»»
		for( nPos = 0;nPos<nRmbCount;nPos++)
		{
			if(exCodeArray[i].nrmbCode == g_arOnlineRMBShopTable[nPos]->m_rmbCode)
			{
				break;
			}
		}
		if(nPos>=nRmbCount)
			return ;
		//¸üÐÂ¶Ò»»ÌõÄ¿
		::ZeroMemory( szSQL, sizeof(szSQL) );
		nDBIndex = 0;
		pDB = g_DB[m_iModSid].GetDB( nDBIndex );
		if( !pDB ) 
			return;

		retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
		if( retcode != SQL_SUCCESS ) 
			return;

		_sntprintf(szSQL, sizeof(szSQL), TEXT( "update  rmbshop set state=1 where struserid='%s' and sid=%d" ),m_strUserID,exCodeArray[i].nSID );
		retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));

		if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
		{
		}
		else
		{
			DisplayErrorMsg(hstmt);
			retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			g_DB[m_iModSid].ReleaseDB(nDBIndex);
			return;
		}

		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DB[m_iModSid].ReleaseDB(nDBIndex);

		//¶Ò»»ÎïÆ·³É¹¦
		GiveAllItem(g_arOnlineRMBShopTable[nPos]->m_iSid,g_arOnlineRMBShopTable[nPos]->m_iNum,g_arOnlineRMBShopTable[nPos]->m_upgrade,
			g_arOnlineRMBShopTable[nPos]->m_tIQ,g_arOnlineRMBShopTable[nPos]->m_sx1,g_arOnlineRMBShopTable[nPos]->m_sx2,
			g_arOnlineRMBShopTable[nPos]->m_sx3,g_arOnlineRMBShopTable[nPos]->m_sx4);
       
		CString strMsg1 = _T("");
		strMsg1.Format( "Äã³É¹¦ÁìÈ¡ÁË %s ",g_arOnlineRMBShopTable[nPos]->m_iText);
		CBufferEx	TempBuf,TempBuf1;
		TempBuf.Add((byte)CHAT_RESULT);
		TempBuf.Add((byte)1);
		TempBuf.Add(WHISPER_CHAT);
		TempBuf.Add((int)0x01);
		TempBuf.Add("GM", _tcslen("GM"));
		TempBuf.Add(strMsg1.GetBuffer(0), strMsg1.GetLength());
		Send(TempBuf, TempBuf.GetLength());
	}
	return ;
}*/
//ÁìÈ¡³äÖµ½á¹ûÎª¾öÕ½±Ò/Ôª±¦...
void USER::OnlineExchange(int nErrorSay,int nSucSay)
{
	DWORD dwCuttime = GetTickCount();
	static DWORD dwLastTime = 0;
	if(dwCuttime - dwLastTime<5000)
	{
		return ;
	}
	if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
	if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
	if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
	if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
	if( m_bZoneLogOut ) return;
	if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
	dwLastTime = dwCuttime;
	int iSlot = -1;
	iSlot = GetEmptySlot(INVENTORY_SLOT);
	if ( iSlot == -1)
	{
		SendNpcSay( NULL, 9000);
        return ;
	}
	//»ñÈ¡ÊÇ·ñ´æÔÚÎ´¶Ò»»µÄÌõÄ¿
	//¶Ò»»±àÂë
	int exCount = 0;
	typedef struct _Ex_Code_Array_
	{
		int nSID;
		int nrmbPoint;
	}Ex_Code_Array;
	Ex_Code_Array exCodeArray[10] = {{0,0}};
	CDatabase*	pDB;
	SQLHSTMT	hstmt = NULL;
	TCHAR		szSQL[1024];	
	SQLRETURN	retcode;

	int	nDBIndex;
	int	i;
	::ZeroMemory( szSQL, sizeof(szSQL) );

	nDBIndex = 0;

	pDB = g_DB[m_iModSid].GetDB( nDBIndex );
	if( !pDB ) 
		return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS ) 
		return;
   //½ÇÉ«ÁìÈ¡
//	_sntprintf(szSQL, sizeof(szSQL), TEXT( "select sid,rmbpoint from rmbshop where struserid='%s' and state=0" ),m_strUserID);
    //ÕÊ»§ÁìÈ¡
	_sntprintf(szSQL, sizeof(szSQL), TEXT( "select sid,rmbpoint from rmbshop where struserid='%s' and state=0" ),m_strAccount);
	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));

	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		SQLINTEGER		iSID;
		SQLINTEGER		nCode;
		SQLINTEGER		ivd;

		while (TRUE)
		{
			retcode = SQLFetch(hstmt);

			if (retcode ==SQL_SUCCESS || retcode ==SQL_SUCCESS_WITH_INFO)
			{
				i = 1;

				SQLGetData( hstmt, i++, SQL_C_SLONG, &iSID, sizeof(iSID), &ivd );
				SQLGetData( hstmt, i++, SQL_C_SLONG, &nCode, sizeof(nCode), &ivd );

				//×î¶àÖ»¶Ò»»Ê®Ïî
				exCodeArray[exCount].nSID = iSID;
				exCodeArray[exCount].nrmbPoint = nCode;

				if(exCount++>=10)
					break;
			}
			else break;
		}	
	}
	else
	{
		DisplayErrorMsg(hstmt);
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		g_DB[m_iModSid].ReleaseDB(nDBIndex);
		return;
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(nDBIndex);

	//ÅÐ¶Ï¸üÐÂÌõÄ¿ÊÇ·ñºÏ·¨
	if(exCount<=0)
	{
		SendNpcSay(0,nErrorSay);
		return ;
	}
	int PointCount = 0;
	int nPos=0;
	for(i = 0;i<exCount;i++)
	{
		//¸üÐÂ¶Ò»»ÌõÄ¿
		::ZeroMemory( szSQL, sizeof(szSQL) );
		nDBIndex = 0;
		pDB = g_DB[m_iModSid].GetDB( nDBIndex );
		if( !pDB ) 
			return;

		retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
		if( retcode != SQL_SUCCESS ) 
			return;
        //½ÇÉ«ÁìÈ¡
	//	_sntprintf(szSQL, sizeof(szSQL), TEXT( "update  rmbshop set state=1 where struserid='%s' and sid=%d" ),m_strUserID,exCodeArray[i].nSID );
		//ÕÊ»§ÁìÈ¡
		_sntprintf(szSQL, sizeof(szSQL), TEXT( "update  rmbshop set state=1 where struserid='%s' and sid=%d" ),m_strAccount,exCodeArray[i].nSID );
		retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));

		if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
		{
		}
		else
		{
			DisplayErrorMsg(hstmt);
			retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			g_DB[m_iModSid].ReleaseDB(nDBIndex);
			return;
		}

		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);

		g_DB[m_iModSid].ReleaseDB(nDBIndex);

		PointCount+=exCodeArray[i].nrmbPoint;
		//CString strMsg1 = _T("");
		//strMsg1.Format( "Äã³É¹¦¶Ò»»ÁË%d",exCodeArray[i].nrmbPoint);
		//CBufferEx	TempBuf,TempBuf1;
		//TempBuf.Add((byte)CHAT_RESULT);
		//TempBuf.Add((byte)1);
		//TempBuf.Add(WHISPER_CHAT);
		//TempBuf.Add((int)0x01);
		//TempBuf.Add("³äÖµ", _tcslen("³äÖµ"));
		//TempBuf.Add(strMsg1.GetBuffer(0), strMsg1.GetLength());
		//Send(TempBuf, TempBuf.GetLength());
	}
	TCHAR szCount[40]="";
	TCHAR szVal[40]="";
	wsprintf(szCount,"%d",exCount);
	wsprintf(szVal,"%d",PointCount);
//	GiveMoney(PointCount);
//	GiveShopPingDN(PointCount);//ÁìÈ¡µ½Ôª±¦
//	SendUserStatusSkill();//ÏÔÊ¾µ½ÊôÐÔÔª±¦ÊýÁ¿
	//GiveDN(PointCount);//ÁìÈ¡µ½JZB
	if( PointCount < 32000 )
	{
	  GiveItemAll( 724,PointCount ,0,0,0,0,0,0,0,0,0,0,0 );
	
	}else if ( PointCount > 32000)
	{
		int zhuanhuan = (PointCount - 30000)/100;
		GiveItemAll( 724,30000 ,0,0,0,0,0,0,0,0,0,0,0 );
		GiveItemAll( 725,zhuanhuan ,0,0,0,0,0,0,0,0,0,0,0 );
        SendEventMsg("±¾´Î³äÖµ²¿·Ö×ª»»Îª[½ð±êÖ¾]ÓÒ¼ü¼´¿É×ª»»!");
		
    }
	m_dwShopPingDN = 1;
	//³äÖµÁìÈ¡ÌáÊ¾
	CString strMsg = _T("");
	strMsg.Format("Íæ¼Ò[ %s ]³äÖµ»ñµÃ[ %d ]±êÖ¾",m_strUserID,PointCount);
	SendSystemMsg(strMsg.GetBuffer(strMsg.GetLength()),SYSTEM_ANNOUNCE,TO_ALL);
	////////////////////////////////////////// ±êÖ¾¼ÇÂ¼
	CString str = _T("");
	 SYSTEMTIME st;
			CString strDate;
			GetLocalTime(&st);
			strDate.Format("%d-%d-%d %d:%d",st.wYear,st.wMonth,st.wDay ,st.wHour,st.wMinute);
            str.Format("[%s]Íæ¼Ò [%s]ÁìÈ¡±êÖ¾ %d  \r\n",strDate,m_strUserID,PointCount);
			EnterCriticalSection( &m_CS_FileWrite );
			g_fpSpeedHack1.Write( str, str.GetLength() );
			LeaveCriticalSection( &m_CS_FileWrite);
	/////////////////////////////////////////////////////
	SendMoneyChanged();
	UpdateUserItemDN();
	SendBoCaiAddStr(nSucSay,szCount,szVal,"");
	
/*
	TCHAR strOP[1024]; ZeroMemory(strOP,sizeof(strOP));//ÕÊ»§ÁìÈ¡Ê±ÐèÒª´æ´¢ÁìÈ¡¼ÇÂ¼
	SYSTEMTIME time;
	GetLocalTime(&time);
	sprintf(strOP,"%d-%d-%d %d:%d·Ö ÁìÈ¡ÁËÕÊ»§%s³äÖµ",time.wYear,time.wMonth,time.wDay ,time.wHour,time.wMinute,m_strAccount);
	WriteOpratorLog(strOP,CHAT_LOG);
*/
	//CString strMsg1 = _T("");
	//strMsg1.Format( "Äã³É¹¦¶Ò»»ÁË%d",exCodeArray[i].nrmbPoint);
	//CBufferEx	TempBuf,TempBuf1;
	//TempBuf.Add((byte)CHAT_RESULT);
	//TempBuf.Add((byte)1);
	//TempBuf.Add(WHISPER_CHAT);
	//TempBuf.Add((int)0x01);
	//TempBuf.Add("³äÖµ", _tcslen("³äÖµ"));
	//TempBuf.Add(strMsg1.GetBuffer(0), strMsg1.GetLength());
	//Send(TempBuf, TempBuf.GetLength());

	return ;
} 
void USER::SendBoCaiAddStr(int npcsay,TCHAR *pBase,TCHAR *szResult,TCHAR *szLoster)
{
	CBufferEx TempBuf, TempSayBuf;
	TempSayBuf.AddString( pBase );
	TempSayBuf.AddString( szResult );
	TempSayBuf.AddString( szLoster );

	TempBuf.Add(CLIENT_EVENT_SAY);
	TempBuf.Add((BYTE)SUCCESS);
	TempBuf.Add((short)npcsay);
	TempBuf.Add((BYTE)0x03);
	TempBuf.AddData(TempSayBuf, TempSayBuf.GetLength());
	Send(TempBuf, TempBuf.GetLength());
	return ;
}	
void USER::ChangeAttributeItem(int srcSid,int srcCount,int srcIQ,int src1,int src2,int src3,int src4,
							   int dstSid,int dstCount,int dstIQ,int dst1,int dst2,int dst3,int dst4,int dst5)
{
	//É¾³ýÎïÆ·
	if(srcSid < 0 || srcSid >= g_arItemTable.GetSize())
		return;
	//É¾³ýÎïÆ·
	if(dstSid < 0 || dstSid >= g_arItemTable.GetSize())
		return;
	if(srcCount<=0 || dstCount<=0)
		return ;
	int n,i,j;
	int nCount= 0,nSolt[24] = {0};
	BOOL bTogether  = FALSE;
	for(i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + INVENTORY_NUM; i++)
	{
		if(m_UserItem[i].sSid == srcSid)  //idÏàÍ¬
		{
			//ÊôÐÔÏàÍ¬
			if(m_UserItem[i].tMagic[0] == src1
				&&m_UserItem[i].tMagic[1] == src2
				&&m_UserItem[i].tMagic[2] == src3
				&&m_UserItem[i].tMagic[3] == src4
				&&m_UserItem[i].tIQ == dstIQ)
			{ 
				nSolt[nCount++] = i;
				if(m_UserItem[i].sCount > 1)
				{
					bTogether = TRUE;
					nCount = m_UserItem[i].sCount;
					break;
				}
			}
		}
	}
	//ÅÐ¶ÏÊýÁ¿ÊÇ·ñ¶Ô
	if(nCount < srcCount)
		return ;
	if(m_dwDN < 1000000)
	{
	//	SendSystemMsg("Ç®²»¹»!¸ø°×ï¯×¢ÈëÊôÐÔÐè»¨·Ñ100Íò!", SYSTEM_ERROR, TO_ME);
        SendEventMsg("Ç®²»¹»!¸ø°×ï¯×¢ÈëÊôÐÔÐè»¨·Ñ100Íò!");
		return ;		// °ø°Ý¿ë¾÷±×·¹ÀÌµåºñ¿ëº¸´ÙÀÛÀ¸¸é
	}
	if( m_dwDN <= 1000000 )
		m_dwDN = 0;
	else
		m_dwDN = m_dwDN - 1000000;
	//´ò°üÎïÆ·
	if(bTogether)
	{
		int iSlot = nSolt[0];
		CBufferEx TempBuf;
		ItemList	TempItem;
		ReSetItemSlot(&TempItem);

		TempItem.sSid		= g_arItemTable[srcSid]->m_sSid;
		TempItem.sBullNum	= g_arItemTable[srcSid]->m_sBullNum;
		TempItem.sDuration	= g_arItemTable[srcSid]->m_sDuration;
		for(i =0; i < MAGIC_NUM; i++) 
			TempItem.tMagic[i] = 0;
		TempItem.tIQ = NORMAL_ITEM;


		if((m_UserItem[iSlot].sCount - srcCount) <= 0)				// ´ÙÀ½³»ÀÎº¥¸¦»©ÁØ´Ù.		
		{														// Äü¾ÆÀÌÅÛº¯È­°¡ÀÖÀ¸¸é		
			ReSetItemSlot(&m_UserItem[iSlot]);
		}
		else
		{
			m_UserItem[iSlot].sCount -= srcCount;
		}

		int iWeight = srcCount * g_arItemTable[srcSid]->m_byWeight;

		m_iCurWeight -= iWeight;
		if(m_iCurWeight < 0) 
			m_iCurWeight = 0;


		TempBuf.Add(ITEM_GIVE_RESULT);
		TempBuf.Add((BYTE)0x01);
		TempBuf.Add((BYTE)iSlot);
		TempBuf.Add(m_UserItem[iSlot].sLevel);
		TempBuf.Add(m_UserItem[iSlot].sSid);
		TempBuf.Add(m_UserItem[iSlot].sDuration);
		TempBuf.Add(m_UserItem[iSlot].sBullNum);
		TempBuf.Add(m_UserItem[iSlot].sCount);
		for(j = 0; j < MAGIC_NUM; j++) 
			TempBuf.Add(m_UserItem[iSlot].tMagic[j]);

		TempBuf.Add(m_UserItem[iSlot].tIQ);

		Send(TempBuf, TempBuf.GetLength());
	}else
	{
		for(n = 0;n<srcCount;n++)
		{
			int iSlot = nSolt[n];
			CBufferEx TempBuf;
			ItemList	TempItem;
			ReSetItemSlot(&TempItem);

			TempItem.sSid		= g_arItemTable[srcSid]->m_sSid;
			TempItem.sBullNum	= g_arItemTable[srcSid]->m_sBullNum;
			TempItem.sDuration	= g_arItemTable[srcSid]->m_sDuration;
			for(i =0; i < MAGIC_NUM; i++) 
				TempItem.tMagic[i] = 0;
			TempItem.tIQ = NORMAL_ITEM;

			if((m_UserItem[iSlot].sCount - 1) <= 0)				// ´ÙÀ½³»ÀÎº¥¸¦»©ÁØ´Ù.		
			{														// Äü¾ÆÀÌÅÛº¯È­°¡ÀÖÀ¸¸é		
				ReSetItemSlot(&m_UserItem[iSlot]);
			}
			else m_UserItem[iSlot].sCount -= srcCount;

			int iWeight = srcCount * g_arItemTable[srcSid]->m_byWeight;

			m_iCurWeight -= iWeight;
			if(m_iCurWeight < 0) 
				m_iCurWeight = 0;


			TempBuf.Add(ITEM_GIVE_RESULT);
			TempBuf.Add((BYTE)0x01);
			TempBuf.Add((BYTE)iSlot);
			TempBuf.Add(m_UserItem[iSlot].sLevel);
			TempBuf.Add(m_UserItem[iSlot].sSid);
			TempBuf.Add(m_UserItem[iSlot].sDuration);
			TempBuf.Add(m_UserItem[iSlot].sBullNum);
			TempBuf.Add(m_UserItem[iSlot].sCount);
			for(j = 0; j < MAGIC_NUM; j++) 
				TempBuf.Add(m_UserItem[iSlot].tMagic[j]);

			TempBuf.Add(m_UserItem[iSlot].tIQ);

			Send(TempBuf, TempBuf.GetLength());
		}
	}
	//¸øÎïÆ·
	GiveAllItem(dstSid,dstCount,0,dstIQ,dst1,dst2,dst3,dst4,0);

	SendMoneyChanged();
	SendSystemMsg("×¢Èë³É¹¦", SYSTEM_ERROR, TO_ME);
}
/////////////////////////////////////////////////////////////////////////////////
//Èº¹¥¼¼ÄÜ---
int USER::GetQunGongAttack(int x, int y, int dDamage)	
{
	int sx = m_curx / 10;		//·¶Î§
	int sy = m_cury / 10;

	int min_x = (sx-1)*10; if( min_x < 0 ) min_x = 0;
	int max_x = (sx+2)*10;
	int min_y = (sy-1)*10; if( min_y < 0 ) min_y = 0;
	int max_y = (sy+2)*10;
	int zzzz=m_curz;
	MAP* pMap = g_zone[m_ZoneIndex];
	if( !pMap ) return -1;

	if( max_x >= pMap->m_sizeMap.cx ) max_x = pMap->m_sizeMap.cx - 1;
	if( max_y >= pMap->m_sizeMap.cy ) max_y = pMap->m_sizeMap.cy - 1;

	int nTarget;
	int num = 0; //±êÊ¶ÓÐ¶àÉÙ¸ö¹ÖÎï

	CNpc* pNpc = NULL;
	int radom = myrand(50,200);
	dDamage = dDamage + radom; //Ëæ»úÔö¼Ó¹¥»÷
	for( int i = min_x; i < max_x; i++ )
	{
		for( int j = min_y; j < max_y; j++ )
		{				
			nTarget = pMap->m_pMap[i][j].m_lUser;
			if(nTarget >= NPC_BAND)
			{

				pNpc = GetNpc(nTarget - NPC_BAND);
				if(pNpc->m_byType == 0)
				{
					num++; 
					switch(m_byClass)		//ÅÐ¶ÏÖ°Òµ
					{
					case 0:
						SendPsiAttackResult(SUCCESS, nTarget, (BYTE)212);   //È­Ê¦Ê¹ÓÃ35±àºÅÐ§¹û
						break;
					case 1:
						SendPsiAttackResult(SUCCESS, nTarget, (BYTE)8);   //·¨Ê¦Ê¹ÓÃ122±àºÅÐ§¹û
						break;
					case 2:
						SendPsiAttackResult(SUCCESS, nTarget, (BYTE)36);   //½£Ê¦Ê¹ÓÃ36±àºÅÐ§¹û
						break;
					case 3:
						SendPsiAttackResult(SUCCESS, nTarget, (BYTE)190);   //Ç¹Ê¦Ê¹ÓÃ190±àºÅÐ§¹û
						break;
					case 4:
						SendPsiAttackResult(SUCCESS, nTarget, (BYTE)41);   //ÖÙ²ÃÊ¹ÓÃ122±àºÅÐ§¹û
						break;
					}
					short sOldNpcHP = pNpc->m_sHP;

					if(pNpc->SetDamage(dDamage, m_uid + USER_BAND, m_pCom) == FALSE)
					{
						pNpc->SendExpToUserList(m_pCom); 
						int diffLevel = abs(m_sLevel - pNpc->m_byClassLevel); //¹ÖÎïµÈ¼¶Ïà²î30¼¶Ã»¾­Ñé
						if(diffLevel <= o_yehuoini[0]->djxz || pNpc->m_sEvent != 0 )
						{
							if (m_isDoubleBAOLV  > 0 || g_sanBaoLv == TRUE || m_dwGuarDianTianShi > 0)
								pNpc->SendDead(m_pCom,1,TRUE);
							else
								pNpc->SendDead(m_pCom);
						}
						else
						{
							pNpc->SendDead(m_pCom,0);
							SendSystemMsg("ÄúºÍµ±Ç°¹ÖÎïµÈ¼¶Ïà²î20,Ã»ÓÐÈÎºÎËùµÃ", SYSTEM_ERROR,TO_ME);
						}
			/*if (m_dwShaGuai >= 3000 ) 
			{
	            SendSystemMsg("Äú½ñÈÕÉ±¹ÖÊýÁ¿ÒÑÂú,´ò¹ÖÎÞ·¨»ñµÃÈÎºÎ¾­ÑéÖµ", SYSTEM_ERROR,TO_ME);
			}  */
			 //if(diffLevel <= o_yehuoini[0]->djxz  &&  pNpc->m_tNpcType == 0 )
			 //  {
				//   CString strMsg;
				//   if (m_dwShaGuai == 1000)
				//   {
				//	   SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 5 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	   m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 2000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 10 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	  m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 3000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	    
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 15 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 4000)
				//   {
				//	   SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	    
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 20 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }else if (m_dwShaGuai == 5000)
				//   {
				//	    SetUserToMagicUser();
			 //          CheckMagicItemMove();
			 //          UpdateUserData();
				//	   
				//	   strMsg.Format("Íæ¼Ò¡º %s ¡»É±¹Ö %d ½ñÈÕËùÓÐÊôÐÔµãÉÏÉý 30 !", this->m_strUserID,m_dwShaGuai);//¹«¸æÌáÊ¾
				//	m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
				//   }
			 //  }

			
		
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

						if(m_tGuildHouseWar == GUILD_WARRING && pNpc->m_NpcVirtualState == NPC_WAIT)
						{
							CheckGuildHouseWarEnd();
						}
						else
						{
							
							if(diffLevel < 40)
							{
								CheckMaxValue(m_dwXP, 1);		
								SendXP();			//·¢ËÍ¾­Ñé
							}
						}
					}
				    SendDamageNum(1,nTarget,(short)dDamage);	//·¢ËÍÉËº¦Öµ
					SendNpcHP(nTarget,pNpc->m_sHP);				//·¢ËÍÑªÁ¿
				}//if
			}
		}
	}//for
	return num;
}
//³èÎïÐÅÏ¢
void USER::GetBabySetting()										
{
	if(m_tBabyCall !=1)
		return ;
	if(m_sBabyLevel>20)
		return ;
	switch(m_sBabyID)
	{
	case 256://Áú
	case 512:
	case 768:
		{
			int attDown = m_sBabyLevel*3;
			if(attDown>60)
				attDown = 60;
			m_DynamicUserData[MAGIC_FINALLY_ATTACK_UP]+= attDown;
		//	m_DynamicMagicItem[5]+= attDown;
			break;
		}
	case 257://Ê¨
	case 513:
	case 769:
		{
			int hpAdd = m_sBabyLevel*15;
			if(hpAdd>300)
				hpAdd = 300;
			m_DynamicUserData[MAGIC_MAX_HP_UP]+= hpAdd;
			break; 
		}
	default:
		return ;
	}
	//¼¼ÄÜ
	/*
	1 »ù±¾¼¼ÄÜÎ¹Ñø 
	2 1½×¶Î¼¼ÄÜ ÉúÃü»Ö¸´ 
	3 1½×¶Î¼¼ÄÜ ×îÖÕÉËº¦¼õÉÙ10 
	4 2½×¶Î¼¼ÄÜ Ò©Ë®±ä»»È«ÏµÁÐ
	5 2½×¶Î¼¼ÄÜ ÎýÆ¬±ä»»È«ÏµÁÐ
	6 2½×¶Î¼¼ÄÜ ÖÂÃüÖ®´Ï¸ñ¶·¼Ò
	7 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â¸ñ°ë¼Ò
	8 2½×¶Î¼¼ÄÜ ³¬¼¶î¸Æø
	9 2½×¶Î¼¼ÄÜ ³ÖÐøÄ§·¨Ê¦
	10 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â Ä§·¨Ê¦
	11 2½×¶Î¼¼ÄÜ ÁéÃôÖ®»Û Ä§·¨Ê¦
	12 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â ½£ÎäÊ¿
	13 2½×¶Î¼¼ÄÜ ¿¹³â ½£ÎäÊ¿
	14 2½×¶Î¼¼ÄÜ ±£»¤î¸Æø ½£ÎäÊ¿
	15 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â Ç¹ÐµÊ¦
	16 2½×¶Î¼¼ÄÜ ¿¹³â Ç¹ÐµÊ¦
	17 2½×¶Î¼¼ÄÜ ÁéÃôÖ®»Û Ç¹ÐµÊ¦
	18 3½×¶Î¼¼ÄÜ ËùÓÐÄÜÁ¦ÖµÔö¼Ó3
	19 3½×¶Î¼¼ÄÜ ËùÓÐ¼¼ÄÜÔö¼Ó1
	*/
	for(int i = 1;i<4;i++)        /////³èÎïÊôÐÔ
	{
		if(m_tBabySkill[i] == 0)
			continue;
		switch(m_tBabySkill[i])
		{
			case 3:
			//	m_DynamicMagicItem[5]+= 10;
				m_DynamicUserData[MAGIC_FINALLY_ATTACK_DOWN]+= 10;
				break;
			/*case 6://ÖÂÃüÖ®´Ï¸ñ¶·¼Ò
				m_UserSkill_[0].tLevel++;
				break;
			case 7://ÉúÃüÖ®¹â¸ñ°ë¼Ò
				m_UserSkill_[1].tLevel++;
				break;
			case 8://³¬¼¶î¸Æø
				m_UserSkill_[2].tLevel++;
				break;
			case 9://³ÖÐøÄ§·¨Ê¦
				m_UserSkill_[3].tLevel++;
				break;
			case 10://ÉúÃüÖ®¹â Ä§·¨Ê¦
				m_UserSkill_[4].tLevel++;
				break;	
			case 11://ÁéÃôÖ®»Û Ä§·¨Ê¦
				m_UserSkill_[5].tLevel++;
				break;
			case 12://ÉúÃüÖ®¹â ½£ÎäÊ¿
				m_UserSkill_[6].tLevel++;
				break;
			case 13://¿¹³â ½£ÎäÊ¿
				//m_UserSkill_[6].tLevel++;
				break;
			case 14://±£»¤î¸Æø ½£ÎäÊ¿
				m_UserSkill_[8].tLevel++;
				break;
			case 15://ÉúÃüÖ®¹â Ç¹ÐµÊ¦
				m_UserSkill_[9].tLevel++;
				break;
			case 16://¿¹³â Ç¹ÐµÊ¦
				m_UserSkill_[10].tLevel++;
				break;
			case 17://ÁéÃôÖ®»Û Ç¹ÐµÊ¦
				m_UserSkill_[11].tLevel++;
				break;*/
			case 18:
				AddMagicPoint(3);
				break;
			case 19:
				m_DynamicUserData[MAGIC_ALL_SKILL_UP]+= 1;
				break;
		}
	}
}
BOOL USER::UserBabyCall(int nSolt)
{
	if(m_tBabyCall ==1)
		return FALSE;
	//100¼¶²Å¿ÉÒÔÕÙ»½
	if(m_sLevel<110)
	{
		SendEventMsg("110¼¶ÒÔÉÏ²Å¿ÉÕÙ»½³èÎï!");
		return FALSE;
	}
	if(!SubInvernItemBySsid(1490))
		return FALSE;
	int nRand = myrand(1,1000);
	m_tBabyCall = 1;
	if(nRand<500)
	{
		m_sBabyID = 256;
	}else
	{
		m_sBabyID = 257;
	}
	m_sBabyLevel = 1;
	m_sBabyNormal = 0;
	m_nBabyExp = 1000;//0;//³èµ±Ç°¾­ÑéÖµ
	m_nBabyNextLevelExp = 1000;//³èÉý¼¶¾­ÑéÖµ
	m_sFealty = 100;
	m_sBabyStatus = 512;
	m_sMaxHungry = 512;
	m_sHungry = 512;
	m_tBabySkill[0] = 1;
	switch(m_byClass)
	{
	case 0:
		m_tBabySkill[1] = 10;
		break;
	case 1:
		m_tBabySkill[1] = 7;
		break;
	case 2:
		m_tBabySkill[1] = 12;
		break;
	case 3:
		m_tBabySkill[1] = 15;
		break;
	case 4:
		m_tBabySkill[1] = 0;
		break;
	default:
		m_tBabySkill[1] = 0;
		break;
	}
	m_tBabySkill[1] = 3;
	m_tBabySkill[2] = 0;
	m_tBabySkill[3] = 0;
	//m_tBabySkill[2] = 18;
	//m_tBabySkill[3] = 19;
	SendMyInfo(TO_INSIGHT,INFO_MODIFY);

	SendBabyInfo();
	return TRUE;
}
void USER::UserKillBaby(int nDN,int nSucSay,int nErrSay)
{
	if(m_tBabyCall==0)
	{
		CString str;
		str.Format("ÄãÃ»ÓÐ³èÎï¿ÉÂô!");
		SendSayAddStr(nErrSay,str.GetBuffer(0));
		return ;
	}
	m_tBabyCall = 0;
	m_sBabyNormal = 0;
	m_sBabyLevel= 0;
	m_sBabyID = 0;
	m_sFealty = 0;
	m_sHungry = 0;
	m_sMaxHungry = 0;
	m_sBabyStatus = 0;
	m_tBabySkill[0] = 0;
	m_tBabySkill[1] = 0;
	m_tBabySkill[2] = 0;
	m_tBabySkill[3] = 0;

	SendMyInfo(TO_INSIGHT,INFO_MODIFY);
	CString str;
	str.Format("Íæ¼Ò[ %s ]½«×Ô¼ºµÄ³èÎïÂô¸øÕ§Ò½ÔºNPC¡¾ÀÙÀòÑÇ¡¿»ñµÃ[ %d ]¾öÕ½±Ò!",m_strUserID,nDN);
	SendSystemMsg(str.GetBuffer(0),SYSTEM_ANNOUNCE,TO_ALL);
	
	str.Format("%d",nDN);
	SendSayAddStr(nSucSay,str.GetBuffer(0));

	if(nDN<=0)
		return ;
	GiveDN(nDN);//¸ø½ð±Ò
//	GiveShopPingDN(nDN);//¸øÔª±¦
	//SendUserStatusSkill();	//¸üÐÂÔª±¦ÊýÁ¿.
	SendMoneyChanged();
	UpdateUserItemDN();

}
void USER::SendBabyInfo()
{
/*
	0x3e,0x20,0x01,0x00,0x13,0x01,0x00,0x00,0x01,
	0x04,0xb3,0xe8,0xce,0xef,//babyname
	0x04,0x66,0x64,0x73,0x66,//username
	0x00,0x00,				//baby level;
	0x01,0x00,0x00,0x00,
	0x0a,0x00,0x00,0x00,
	0x01,0x02,//babyid
	0x50,0x00,//ÖÒ³Ï¶È
	0x00,0x00,
	0x00,0x02,
	0xf4,0x01,
	0xd0,0x2a,0x4e,0x4d,
	0x00,0x00,0x00,0x00,//¼¼ÄÜ
*/
	if(m_sBabyID <= 0 )
		return ;
	CBufferEx TempBuf2;
	TempBuf2.Add(PK_BUTTON_REQ);
	TempBuf2.Add((BYTE)0x20);
	TempBuf2.Add((BYTE)0x01);
	TempBuf2.Add((BYTE)0x00);
	TempBuf2.Add((BYTE)0x13);
	TempBuf2.Add((BYTE)0x01);
	TempBuf2.Add((BYTE)0x00);
	TempBuf2.Add((BYTE)0x00);
	TempBuf2.Add((BYTE)0x01);
	TempBuf2.Add(g_szBabyName[m_sBabyID%2],strlen(g_szBabyName[m_sBabyID%2]));
	TempBuf2.Add(m_strUserID,strlen(m_strUserID));
	TempBuf2.Add((short)m_sBabyLevel);			//baby level Áú1¼¶¼Ó3µã×îÖÕÉËº¦,Ê¨×Ó1¼¶Ôö¼Ó15µãÑª
	TempBuf2.Add((int)m_nBabyExp);				//cur baby exp
	TempBuf2.Add((int)m_nBabyNextLevelExp);		//cur next level exp
	TempBuf2.Add((short)m_sBabyID);				//baby ssid
	TempBuf2.Add((short)m_sFealty);				//ÖÒ³Ï¶È
	TempBuf2.Add((short)m_sBabyStatus);			//×´Ì¬
	TempBuf2.Add((short)m_sMaxHungry);			//±¥Öµ×´Ì¬ÁÙ½ç
	TempBuf2.Add((short)m_sHungry);				//¼¢¶öÖµ
	//
	SYSTEMTIME systime;
	CTime cTime(2012,12,12,0,0,0);
	cTime.GetAsSystemTime(systime);//×ª³Ésystime
	double dtime;
	SystemTimeToVariantTime(&systime,&dtime);

	TempBuf2.Add((BYTE)0xe0);
	TempBuf2.Add((BYTE)0x24);
	TempBuf2.Add((BYTE)0xe4);
	TempBuf2.Add((BYTE)0x40);
	//¼¼ÄÜ
	/*
	1 »ù±¾¼¼ÄÜÎ¹Ñø 
	2 1½×¶Î¼¼ÄÜ ÉúÃü»Ö¸´ 
	3 1½×¶Î¼¼ÄÜ ×îÖÕÉËº¦¼õÉÙ10 
	4 2½×¶Î¼¼ÄÜ Ò©Ë®±ä»»È«ÏµÁÐ
	5 2½×¶Î¼¼ÄÜ ÎýÆ¬±ä»»È«ÏµÁÐ
	6 2½×¶Î¼¼ÄÜ ÖÂÃüÖ®´Ï¸ñ¶·¼Ò
	7 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â¸ñ°ë¼Ò
	8 2½×¶Î¼¼ÄÜ ³¬¼¶î¸Æø
	9 2½×¶Î¼¼ÄÜ ³ÖÐøÄ§·¨Ê¦
	10 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â Ä§·¨Ê¦
	11 2½×¶Î¼¼ÄÜ ÁéÃôÖ®»Û Ä§·¨Ê¦
	12 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â ½£ÎäÊ¿
	13 2½×¶Î¼¼ÄÜ ¿¹³â ½£ÎäÊ¿
	14 2½×¶Î¼¼ÄÜ ±£»¤î¸Æø ½£ÎäÊ¿
	15 2½×¶Î¼¼ÄÜ ÉúÃüÖ®¹â Ç¹ÐµÊ¦
	16 2½×¶Î¼¼ÄÜ ¿¹³â Ç¹ÐµÊ¦
	17 2½×¶Î¼¼ÄÜ ÁéÃôÖ®»Û Ç¹ÐµÊ¦
	18 3½×¶Î¼¼ÄÜ ËùÓÐÄÜÁ¦ÖµÔö¼Ó3
	19 3½×¶Î¼¼ÄÜ ËùÓÐ¼¼ÄÜÔö¼Ó1
	*/
	TempBuf2.Add((BYTE)m_tBabySkill[0]);
	TempBuf2.Add((BYTE)m_tBabySkill[1]);
	TempBuf2.Add((BYTE)m_tBabySkill[2]);
	TempBuf2.Add((BYTE)m_tBabySkill[3]);

	SendInsight(TempBuf2, TempBuf2.GetLength());
}
//Î¹³èÎï
//Î¹Ñøºó¶îÍâ·¢ÁËÒ»¸ö°ü
//0x77 0x1f 0x27 0x00 0x00 0x15 
void USER::GiveBabyItem(short sSolt)
{
	if(!SubInvernItemBySolt(sSolt))
		return ;
	BYTE bSuc = 0x01;
	//1498 1491Èâ
	m_sHungry+=100;
	if(m_sHungry>m_sMaxHungry)
		m_sHungry = m_sMaxHungry;
/*	if((m_sFealty + 1) < 101)
        m_sFealty+=1;
	SendEventMsg("Ê¹ÓÃËÇÁÏ.³èÎï[ÖÒ³Ï¶È]Ôö¼Ó[ 1 ]");*/
	SendBabyInfo();

	CBufferEx TempBuf;
	TempBuf.Add(PK_BUTTON_REQ);
	TempBuf.Add((BYTE)0x26);
	TempBuf.Add((BYTE)bSuc);
	TempBuf.Add((short)100);
	TempBuf.Add((short)150);

	Send(TempBuf, TempBuf.GetLength());
}
void USER::BabyUpgradeLevel()
{
	if(m_sLevel<100)
		return ;
	short sOldLevel = m_sBabyLevel;

	m_sBabyLevel = (m_sLevel-100)/10 +1;

	if(m_sBabyLevel>=4)
	{
		if(m_sBabyID==256||m_sBabyID == 257)
			m_sBabyID+=256;
		m_tBabySkill[2] = 18;
	}else
	{
		if(m_sBabyID==512||m_sBabyID == 513)
			m_sBabyID-=256;

		m_tBabySkill[2] = 0;
	}

	if(m_sBabyLevel>=7)
	{
		if(m_sBabyID==512||m_sBabyID == 513)
			m_sBabyID+=256;
		m_tBabySkill[3] = 19;
	}else
	{
		if(m_sBabyID==768||m_sBabyID == 769)
			m_sBabyID-=256;
		m_tBabySkill[3] = 0;
	}

	if(sOldLevel != m_sBabyLevel)
		SendBabyInfo();
}

/////////////// ´Ì¼¤
void USER::WriteUserShopLog(TCHAR *strContents)
{
	SDWORD sSLen = strlen(strContents);
	if(sSLen <= 0 || sSLen >= 500) return;
	CFile file_log;
	file_log.Open("UserShop.Log", CFile::modeWrite | CFile::modeCreate | CFile::modeNoTruncate | CFile::shareDenyNone );
	file_log.SeekToEnd();
	file_log.Write(strContents,sSLen );
	file_log.Close();
}
///////////////´Ì¼¤
////////////////////////////////////////////////////////
//¿ÛË° Ð¡À¶-2012-1-1
//////////////////////////////////////////
DWORD USER::SubTaxRate(DWORD dwCost,short sStoreID)		
{
	int nPos = 0;

	CGuildFortress *pGuild= GetGuildWarWin();
	if(pGuild!= NULL)
	{
		nPos = pGuild->m_tTaxRate;
	}
    
	DWORD dwTax = (dwCost * nPos)/1000;//ÐÞ¸ÄÎª·þÎñÆ÷Ç§·Ö±È
	DWORD dwCast= dwCost-dwTax;

	if(nPos > 0)
	{
		CString strTemp;
	    strTemp.Format( " ×Ü¼Û%d,ÒªÈûË°ÂÊ%d,ËùµÃË°%d,µ½ÕË½ð¶î%d", dwCost,nPos,dwTax,dwCast);
	    SendSystemMsg( strTemp.GetBuffer(), SYSTEM_NORMAL, TO_ME);	
	}
	

	//CString strMsg1 = _T("");
	//strMsg1.Format( "Äú½»Ò×½ð¶î%d,Ë°ÂÊ%d%% ËùµÃË°ÊÕ%d,Êµ¼Ê½ð¶î%d ",dwCost,nPos,dwTax,dwCast);
	//CBufferEx	TempBuf,TempBuf1;
	//TempBuf.Add((byte)CHAT_RESULT);
	//TempBuf.Add((byte)1);
	//TempBuf.Add(WHISPER_CHAT);
	//TempBuf.Add((int)0x01);
	//TempBuf.Add("ÒªÈûÍÅ³¤", _tcslen("ÒªÈûÍÅ³¤"));
	//TempBuf.Add(strMsg1.GetBuffer(0), strMsg1.GetLength());
	//Send(TempBuf, TempBuf.GetLength());
	////
	if(pGuild!= NULL)
		AddTaxToGuildBank(dwTax,sStoreID);
	return dwCast;
}
/////////////////////////////////////////
//Ë°ÊÕ·¢µ½ÒªÈû¾üÍÅ²Ö¿â-Ð¡À¶-2012-1-1
///////////////////////////////////////////
void USER::AddTaxToGuildBank(DWORD dwTax,short sStoreID)
{
	//ÒªÈûËùÓÐÕß
	CGuildFortress *pGuild= GetGuildWarWin();
	if(pGuild== NULL)
	{
		return ;
	}

	int dwVal =dwTax;

	CDatabase*	pDB;
	SQLHSTMT	hstmt = NULL;
	TCHAR		szSQL[1024];	
	SQLRETURN	retcode;

	int	nDBIndex;
	int	i;
	::ZeroMemory( szSQL, sizeof(szSQL) );

	nDBIndex = 0;

	pDB = g_DB[m_iModSid].GetDB( nDBIndex );
	if( !pDB ) 
		return;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS ) 
		return;

	_sntprintf(szSQL, sizeof(szSQL), TEXT( "select isid,idn from guild where strmastername='%s'" ),pGuild->m_strMasterName );
	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));

	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		retcode = SQLFetch(hstmt);

		if (retcode ==SQL_SUCCESS || retcode ==SQL_SUCCESS_WITH_INFO)
		{
			SQLINTEGER		iSID;
			SQLINTEGER		nCode;
			SQLINTEGER		ivd;
			i = 1;
			SQLGetData( hstmt, i++, SQL_C_SLONG, &iSID, sizeof(iSID), &ivd );
			SQLGetData( hstmt, i++, SQL_C_SLONG, &nCode, sizeof(nCode), &ivd );
			dwVal = nCode;
			CheckMaxValue(dwVal,dwTax);
		}
	}
	else
	{
		DisplayErrorMsg(hstmt);
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		g_DB[m_iModSid].ReleaseDB(nDBIndex);
		return;
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[m_iModSid].ReleaseDB(nDBIndex);
	{
		pDB = g_DB[m_iModSid].GetDB( nDBIndex );
		if( !pDB ) 
			return;

		retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
		if( retcode != SQL_SUCCESS ) 
			return;
		/////////////////////²âÊÔÐÞ¸´·¢ËÍË°ÊÕ³¬³ö21EÎÊÌâ/////////////////////
		if(dwVal < 0 )	dwVal = 0;
		memset(szSQL,0,sizeof(szSQL));
		if(dwVal >= _MAX_INT/2) dwVal = 0; 
		/////////////////////²âÊÔÐÞ¸´·¢ËÍË°ÊÕ³¬³ö21EÎÊÌâ /////////////////////

		_sntprintf(szSQL, sizeof(szSQL), TEXT( "update guild set idn=%d where strmastername='%s'" ),dwVal,pGuild->m_strMasterName );
		retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));
		if( retcode == SQL_SUCCESS)
		{
			retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			g_DB[m_iModSid].ReleaseDB(nDBIndex);
			return ;
		}
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		g_DB[m_iModSid].ReleaseDB(nDBIndex);

	}
}
/////////////////////////////////////////////////////////////
//¸üÐÂË°ÂÊ - Ð¡À¶2012-1-1
//////////////////////////////////////////////////////////////
void USER::UpdateTaxToDB(CGuildFortress *pGuild,int itax)
{
	CDatabase*	pDB;
	SQLHSTMT	hstmt = NULL;
	TCHAR		szSQL[1024];	
	SQLRETURN	retcode;

	int	nDBIndex;
	::ZeroMemory( szSQL, sizeof(szSQL) );

	nDBIndex = 0;
	{
		pDB = g_DB[m_iModSid].GetDB( nDBIndex );
		if( !pDB ) 
			return;

		retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
		if( retcode != SQL_SUCCESS ) 
			return;

		_sntprintf(szSQL, sizeof(szSQL), TEXT( "update guild_Fortress set staxRate=%d where sFortressID=%d" ),itax,pGuild->m_sFortressID );
		retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, sizeof(szSQL));
		if( retcode == SQL_SUCCESS)
		{
			retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
			g_DB[m_iModSid].ReleaseDB(nDBIndex);
			return ;
		}
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		g_DB[m_iModSid].ReleaseDB(nDBIndex);

	}
}
//=======================================================================================================Ñ°»¶ÐÂÔö
void USER::huishou( int sid,int yanse,int sx0,int sx1,int sx2,int sx3,int zongjia)
{
	BOOL bTogether  = FALSE;
	int success =0;
	CBufferEx TempBuf;
	if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
	if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
	if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
	if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
	if( m_bZoneLogOut ) return;
	if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
	int iSlot = -1;
	iSlot = GetEmptySlot(INVENTORY_SLOT);
	if(sid < 0 || sid >= g_arItemTable.GetSize()) return;
	if (zongjia >=30000) return;


	int nCount= 0,nSolt[24] = {0};

	for( int i = 10; i < 34; i++) 
	{
		if( m_UserItem[i].sSid == sid && m_UserItem[i].tIQ == yanse && m_UserItem[i].tMagic[0] == sx0 && m_UserItem[i].tMagic[1] == sx1 && m_UserItem[i].tMagic[2] == sx2 && m_UserItem[i].tMagic[3] == sx3 && m_UserItem[i].sCount == 1)
		{
			nSolt[nCount++] = i;
			bTogether = TRUE;
			break;
		}
	}
	if (bTogether)
	{
		if( FindItem(SPECIAL_BIAOZHI) <=0 )
		{
			if( iSlot == -1 )
			{
				SendEventMsg("ÄúÃ»ÓÐ×ã¹»µÄ¿Õ¼ä´æ·Å±êÖ¾!");
                return ;
			}
		}
		if( FindItem(SPECIAL_BIAOZHI) + zongjia >=32000)
		{
			SendEventMsg("³¬¹ý¿ÉÐ¯´ø±êÖ¾×ÜÊý!");
			return;
		}
		int iSlot = nSolt[0];
		
		ReSetItemSlot(&m_UserItem[iSlot]);
		GiveItemAll( 724,zongjia,0,0,0,0,0,0,0,0,0,0,0 );
		
		TempBuf.Add(ITEM_GIVE_RESULT);
		TempBuf.Add((BYTE)0x01);
		TempBuf.Add((BYTE)iSlot);
		TempBuf.Add(m_UserItem[iSlot].sLevel);
		TempBuf.Add(m_UserItem[iSlot].sSid);
		TempBuf.Add(m_UserItem[iSlot].sDuration);
		TempBuf.Add(m_UserItem[iSlot].sBullNum);
		TempBuf.Add(m_UserItem[iSlot].sCount);
		for(int j = 0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[iSlot].tMagic[j]);
		TempBuf.Add(m_UserItem[iSlot].tIQ);
		Send(TempBuf, TempBuf.GetLength());
		success = 1;
	}
	if (success == 1)
	{
		CString str;
		str.Format( "··Âô³É¹¦»ñµÃ±ê %d", zongjia);
		SendEventMsg(str.GetBuffer(0));
	}else
		SendEventMsg("Î´¼ì²âµ½¸ÃÎïÆ·");

}
void USER::AddShuxing3PaiReq(int Slot, int SlotDJ)
{
	int index = 0, i, j = 0 ,k= 0;
	short sSid = -1;
    int random = 0 , random2 = 0,success =0;
    int iWeight = 0;
    CByteArray arMaterial;
	arMaterial.RemoveAll();

	if (m_dwDN < 2000000)
	{
		SendEventMsg("ÖÆ×÷»ÃÏëÎäÆ÷ÐèÒª200Íò");
		return;
	}
	if(Slot < EQUIP_ITEM_NUM || Slot >= TOTAL_INVEN_MAX) return;	
	if(m_UserItem[Slot].sCount >= 2) return;
	sSid = m_UserItem[Slot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return;
//===========================================================================
	if  (FindItem( 1188) < 1 )  return;

	if ( m_UserItem[Slot].tIQ == 18 )
	{
		SendEventMsg("130¼¶ÎäÆ÷ÎÞ·¨ÖÆ×÷");
		return;
    }

	if ( m_UserItem[Slot].tIQ != 2 && m_UserItem[Slot].tIQ != 3 )
	{
		SendEventMsg("Ã»ÓÐÊôÐÔµÄÎäÆ÷ÎÞ·¨ÖÆ×÷");
		return;
    }
	
     int solt = GetEmptySlot( INVENTORY_SLOT );
    if(solt == -1)
	{
		SendEventMsg("ÄúÃ»ÓÐ×ã¹»µÄÎ»ÖÃ´æ·Å»ÃÏëÎäÆ÷");
		return;

	}
    int tClass = g_arItemTable[m_UserItem[Slot].sSid]->m_byWear;

	if ( tClass != 1 ) 
	{
		SendEventMsg("±ØÐëÊÇÎäÆ÷²Å¿ÉÒÔÖÆ×÷");
		return;
    }

    if ( tClass == 1 && m_UserItem[Slot].iItemSerial == 0 )
	{
	    BYTE magic = m_UserItem[Slot].tMagic[0];
		if (magic < 0 || magic >= g_arMagicItemTable.GetSize())  return;
        GiveAllItem(  m_UserItem[Slot].sSid,1,m_UserItem[Slot].tMagic[5],14,m_UserItem[Slot].tMagic[0],m_UserItem[Slot].tMagic[1],m_UserItem[Slot].tMagic[2],m_UserItem[Slot].tMagic[3],0);
        success =1;
		m_UserItem[Slot].iItemSerial = 1;
        iWeight += g_arItemTable[sSid]->m_byWeight;		
		arMaterial.Add((BYTE)Slot);

		FlushItemLog( TRUE );
		if( m_dwDN <= 2000000 ) m_dwDN = 0;
		else m_dwDN = m_dwDN - 2000000;	
		ReSetItemSlot(&m_UserItem[SlotDJ]);
		UpdateUserItemDN();							
		SendMoneyChanged();	
		SendCharData();
	    SendMyInfo(TO_INSIGHT, INFO_MODIFY);

		CBufferEx TempBuf;
		TempBuf.Add(UPGRADE_ITEM_RESULT);
		index = arMaterial.GetSize();

		if(success == 1) TempBuf.Add((BYTE)0x01);	// EBody Upgrade ¼º°ø
		else TempBuf.Add((BYTE)0x00);				// EBody Upgrade ½ÇÆÐ

		TempBuf.Add((BYTE)index);

		for(i = 0;  i < arMaterial.GetSize(); i++)
		{
			Slot = arMaterial[i];
			TempBuf.Add((BYTE)Slot);
			TempBuf.Add(m_UserItem[Slot].sLevel);
			TempBuf.Add(m_UserItem[Slot].sSid);
			TempBuf.Add(m_UserItem[Slot].sDuration);
			TempBuf.Add(m_UserItem[Slot].sBullNum);
			TempBuf.Add(m_UserItem[Slot].sCount);
			for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[Slot].tMagic[j]);
			TempBuf.Add(m_UserItem[Slot].tIQ); 
		}
		m_iCurWeight -= iWeight;
		if(m_iCurWeight < 0) m_iCurWeight = 0;
		GetRecoverySpeed();	
		Send(TempBuf, TempBuf.GetLength());
		arMaterial.RemoveAll();
		//=======================================================================
		if (success==1)
		{
			SendEventMsg("ÖÆ×÷³É¹¦");
            CString strMsg;
		    CString GoodsMagic;
			for(int i = 0; i < 4; i++)
		    {
				if(m_UserItem[Slot].tMagic[i] != 0)
				{
					GoodsMagic+=g_arMagicItemTable[m_UserItem[Slot].tMagic[i]]->m_strText;
				    GoodsMagic+=",";
				}
			}
			strMsg.Format("%s ÖÆ×÷»ÃÏëÎäÆ÷ %s %d¸Ä:", this->m_strUserID,g_arItemTable[m_UserItem[Slot].sSid]->m_strName,m_UserItem[Slot].tMagic[5] );//¹«¸æÌáÊ¾
		    strMsg+=GoodsMagic;
		    m_pCom->Announce((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
		}
	}else{
		SendEventMsg("´ËÎäÆ÷ÒÑ¾­ÖÆ×÷¹ý»ÃÏëÎäÆ÷ÁË");
        return;
	}
}


void USER::XuanYun() //ÐÂÔöÑ£ÔÎ¹¦ÄÜ 
{
	   
	    m_dwXYTime = 5 * 1000;
		m_dwLastXYTime = GetTickCount();

		CBufferEx TempBuf;
		TempBuf.Add(SET_USER_STATE);
		TempBuf.Add(m_uid + USER_BAND);
		AddAbnormalInfo(ABNORMAL_CONFUSION);
		TempBuf.Add(m_dwAbnormalInfo);
		TempBuf.Add(m_dwAbnormalInfo_);
		SendExactScreen(TempBuf, TempBuf.GetLength());
}
void USER::DelXuanYun() //ÐÂÔöÑ£ÔÎ¹¦ÄÜ 
{
	  int index = 0;
	  DWORD dwRemainTime = 0;
	  DWORD dwCurrTick = GetTickCount();
	  
       if( m_dwXYTime != 0)	// Ñ£ÔÎ
		{
			if((dwCurrTick - m_dwLastXYTime) > m_dwXYTime)		// ¸ÅÁ÷Âù½º 5¹è ½Ã°£ÀÌ ³¡³µÀ¸¸é
			{
			
				m_dwXYTime = 0;
				DeleteAbnormalInfo(ABNORMAL_CONFUSION);
				m_dwLastXYTime = dwCurrTick;
				SendSystemMsg("±äÇåÐÑ",SYSTEM_ERROR,TO_ME);

				index = 0;
				SetByte(m_TempBuf, SET_USER_STATE, index);
				SetInt(m_TempBuf, m_uid + USER_BAND, index);
				SetDWORD(m_TempBuf, m_dwAbnormalInfo, index);
				SetDWORD(m_TempBuf, m_dwAbnormalInfo_, index);
				Send(m_TempBuf, index);
			}
			else
			{
				dwRemainTime = m_dwXYTime - (dwCurrTick - m_dwLastXYTime);
				m_dwXYTime = dwRemainTime;
				m_dwLastXYTime = dwCurrTick;
				
			}
		}
	   if ( m_dwXYTime != 0  &&  ( IsCity())  )
	   {
		        m_dwXYTime = 0;
				DeleteAbnormalInfo(ABNORMAL_CONFUSION);
				m_dwLastXYTime = dwCurrTick;
				SendSystemMsg("ÄúÒÑ»Øµ½³ÇÊÐÖÐ,ÏµÍ³ÎªÄúÇåÀíµôÑ£ÔÎ×´Ì¬",SYSTEM_ERROR,TO_ME);

				index = 0;
				SetByte(m_TempBuf, SET_USER_STATE, index);
				SetInt(m_TempBuf, m_uid + USER_BAND, index);
				SetDWORD(m_TempBuf, m_dwAbnormalInfo, index);
				SetDWORD(m_TempBuf, m_dwAbnormalInfo_, index);
				Send(m_TempBuf, index);
	   }

}

void USER::SXzhuizong(short sSid)//Ë¢ÐÂ×·×Ù¿¨ÄÍ¾Ã
{
	BYTE tSlot = 0;
	int i;
	CBufferEx TempBuf;
	
	for(i = 10; i < 34; i++)
	{
		tSlot = g_iSSSlot[i];
		if(m_UserItem[tSlot].sSid == sSid)
		{
			m_UserItem[tSlot].sDuration--;
			if(m_UserItem[tSlot].sDuration <= 0) 
			{
				MakeItemLog( &m_UserItem[tSlot], ITEMLOG_ACC_USE );
				FlushItemLog( TRUE );
				
				ReSetItemSlot(&m_UserItem[tSlot]);
				
				TempBuf.Add(ITEM_MOVE_RESULT);
				TempBuf.Add(SUCCESS);
				TempBuf.Add((BYTE)0);		
				TempBuf.Add((BYTE)1);		// Count
				
				TempBuf.Add(tSlot);
				TempBuf.Add(m_UserItem[tSlot].sLevel);
				TempBuf.Add(m_UserItem[tSlot].sSid);
				TempBuf.Add(m_UserItem[tSlot].sDuration);
				TempBuf.Add(m_UserItem[tSlot].sBullNum);
				TempBuf.Add(m_UserItem[tSlot].sCount);
				for(i =0; i < MAGIC_NUM; i++) TempBuf.Add(m_UserItem[tSlot].tMagic[i]);
				TempBuf.Add(m_UserItem[tSlot].tIQ); 
				
				Send(TempBuf, TempBuf.GetLength());				
			}
			else
			{
				TempBuf.Add(ITEM_DURATION);
				TempBuf.Add(tSlot);
				TempBuf.Add(m_UserItem[tSlot].sDuration);
				Send(TempBuf, TempBuf.GetLength());
			}

			return;
		}
	}
}
void USER::YJmzb()
{
    BOOL Haveitem = FALSE;
    short sNum = 1;
    int iWeight = 0;
    DWORD dwSellCost, dwResultCost = 0;
    DWORD dwMaxCost = 0, tempCost = 0;

    // ×´Ì¬¼ì²é
    if(m_bLive == USER_DEAD || m_bNoItemMove == TRUE || m_bViewingAShop == TRUE || 
       m_state != STATE_GAMESTARTED || m_bZoneLogOut || 
       m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)
    {
        return;
    }

    for(int i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + 12; i++)
    {
        if(m_UserItem[i].sSid < 0 || m_UserItem[i].sSid >= g_arItemTable.GetSize()) continue;
        //if(m_UserItem[i].iItemSerial == 1) continue;
        if(g_arItemTable[m_UserItem[i].sSid]->m_byRLevel == 100) continue; // °Ù¼¶×°±¸²»¿ÉÂô
        if(g_arItemTable[m_UserItem[i].sSid]->m_byWear < 1 || g_arItemTable[m_UserItem[i].sSid]->m_byWear > 5) continue; // ²»ÊÇÎäÆ÷ºÍ×°±¸Ìø³ö
        if(m_UserItem[i].sCount != 1) continue; // ÊýÁ¿²»µÈÓÚ1Ìø³ö
        if(m_UserItem[i].tMagic[5] != 0) continue; // ¸Ä¹ýµÄ²»Âô

        int sSid = m_UserItem[i].sSid;
        
        // ¼ÆËãÎïÆ·ÆÀ·Ö
        int itemScore = CalcItemPingfen(&m_UserItem[i]);
        if(itemScore >= 170) 
        {
            CString strKeepMsg;
            strKeepMsg.Format("[%s] ÆÀ·Ö:%d - ±£Áô", g_arItemTable[sSid]->m_strName, itemScore);
            SendSystemMsg((LPTSTR)(LPCTSTR)strKeepMsg, SYSTEM_NORMAL, TO_ME);
            continue;
        }

        CBufferEx TempBuf;
        dwSellCost = GetSellCost(i);
        if(dwSellCost > 0)
        {
            Haveitem = TRUE;
            tempCost = dwResultCost + dwSellCost * sNum;
            if(!CheckMaxValueReturn((DWORD &)tempCost, (DWORD)(dwResultCost + dwSellCost * sNum))) continue;
            iWeight += g_arItemTable[m_UserItem[i].sSid]->m_byWeight * sNum;
            dwResultCost = tempCost;
        }

        ReSetItemSlot(&m_UserItem[i]);
        
        // ·¢ËÍÎïÆ·¸üÐÂÊý¾Ý°ü
        TempBuf.Add(ITEM_GIVE_RESULT);
        TempBuf.Add((BYTE)0x01);
        TempBuf.Add((BYTE)i);
        TempBuf.Add(m_UserItem[i].sLevel);
        TempBuf.Add(m_UserItem[i].sSid);
        TempBuf.Add(m_UserItem[i].sDuration);
        TempBuf.Add(m_UserItem[i].sBullNum);
        TempBuf.Add(m_UserItem[i].sCount);
        for(int j = 0; j < MAGIC_NUM; j++) 
            TempBuf.Add(m_UserItem[i].tMagic[j]);
        TempBuf.Add(m_UserItem[i].tIQ);    
        Send(TempBuf, TempBuf.GetLength());

        // ·¢ËÍÂô³öÌáÊ¾ÏûÏ¢
       /* CString strSellMsg;
        strSellMsg.Format("[%s] ÆÀ·Ö:%d - ÒÑÂô³ö", g_arItemTable[sSid]->m_strName, itemScore);
        SendSystemMsg((LPTSTR)(LPCTSTR)strSellMsg, SYSTEM_ERROR, TO_ME);*/
    }

    // Èç¹ûÓÐÎïÆ·±»Âô³ö£¬´¦Àí½ðÇ®ºÍÖØÁ¿¸üÐÂ
    if(Haveitem == TRUE)
    {
        dwResultCost = SubTaxRate(dwResultCost, 30);    // Ë°ÊÕ
        CheckMaxValue((DWORD &)m_dwDN, (DWORD)dwResultCost);
        MakeMoneyLog(dwResultCost, ITEMLOG_SELL_MONEY);
        UpdateUserItemDN();
        m_iCurWeight -= iWeight;
        if(m_iCurWeight < 0) m_iCurWeight = 0;
        GetRecoverySpeed();
        SendMoneyChanged();
    }
}
//void USER::YJmzb()
//{
//	BOOL Haveitem = FALSE;
//	short sNum = 1;
//	int iWeight = 0;
//	DWORD dwSellCost, dwResultCost = 0;
//	DWORD dwMaxCost = 0, tempCost = 0;
//	if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
//    if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
//	if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
//	if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
//	if( m_bZoneLogOut ) return;
//	if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
// 
//
//	for(int i = EQUIP_ITEM_NUM; i < EQUIP_ITEM_NUM + 12; i++)
//	{
//		if(m_UserItem[i].sSid < 0 || m_UserItem[i].sSid >= g_arItemTable.GetSize()) continue;
//		if(m_UserItem[i].iItemSerial == 1) continue;
//		if( g_arItemTable[m_UserItem[i].sSid]->m_byRLevel == 100) continue;//°Ù¼¶×°±¸²»¿ÉÂô
//		if( g_arItemTable[m_UserItem[i].sSid]->m_byWear < 1|| g_arItemTable[m_UserItem[i].sSid]->m_byWear> 5 ) continue;//²»ÊÇÎäÆ÷ºÍ×°±¸Ìø³ö
//		if(m_UserItem[i].sCount!=1) continue;//ÊýÁ¿²»µÈÓÚ1Ìø³ö
//		if(m_UserItem[i].tMagic[5] != 0) continue;//¸Ä¹ýµÄ²»Âô
//		CBufferEx TempBuf;
//		int sSid;
//		sSid = m_UserItem[i].sSid;
//
//		dwSellCost = GetSellCost(i);
//		if(dwSellCost > 0)
//		{
//			Haveitem = TRUE;
//			tempCost = dwResultCost + dwSellCost * sNum;
//			if(!CheckMaxValueReturn((DWORD &)tempCost, (DWORD)(dwResultCost + dwSellCost * sNum)))continue;
//			iWeight += g_arItemTable[m_UserItem[i].sSid]->m_byWeight * sNum;
//			dwResultCost = tempCost;
//		}
//		ReSetItemSlot(&m_UserItem[i]);
//		
//		TempBuf.Add(ITEM_GIVE_RESULT);
//		TempBuf.Add((BYTE)0x01);
//		TempBuf.Add((BYTE)i);
//		TempBuf.Add(m_UserItem[i].sLevel);
//		TempBuf.Add(m_UserItem[i].sSid);
//		TempBuf.Add(m_UserItem[i].sDuration);
//		TempBuf.Add(m_UserItem[i].sBullNum);
//		TempBuf.Add(m_UserItem[i].sCount);
//		for(int j = 0; j < MAGIC_NUM; j++) 
//		TempBuf.Add(m_UserItem[i].tMagic[j]);
//
//		TempBuf.Add(m_UserItem[i].tIQ);	
//		Send(TempBuf, TempBuf.GetLength())	;
//		CString strMsg;
//		strMsg = _T("");
//		strMsg.Format( "Ò»¼üÂôµôÁË[%s]"  ,g_arItemTable[sSid]->m_strName);
//		//strMsg.Format( "°ü¹üÎ»ÖÃ%d:ÂôµôÁË[%s]ÊôÐÔÎª:%d %d %d %d %d."  ,i-9,g_arItemTable[sSid]->m_strName,m_UserItem[i].tMagic[0],m_UserItem[i].tMagic[1],m_UserItem[i].tMagic[2],
//		//	m_UserItem[i].tMagic[3],m_UserItem[i].tMagic[4]);
//		SendSystemMsg( (LPTSTR)(LPCTSTR)strMsg,SYSTEM_ERROR, TO_ME);
//	}
//	if ( Haveitem == TRUE)
//	{
//		dwResultCost = SubTaxRate(dwResultCost,30);	//Ë°ÊÕ
//		CheckMaxValue((DWORD &)m_dwDN, (DWORD)dwResultCost);
//		MakeMoneyLog( dwResultCost, ITEMLOG_SELL_MONEY );
//		UpdateUserItemDN();
//		m_iCurWeight -= iWeight;
//		if(m_iCurWeight < 0) m_iCurWeight = 0;
//		GetRecoverySpeed();
//		SendMoneyChanged();
//	}
//}
void USER::KuaiSuZuDui() //×Ô¶¯×é¶Ó
{
	
	USER *pUser = NULL;
	CBufferEx TempBuf;
	int i ,j ;
	int diffLevel = 0;
	CString msg;
	if(m_bMakeBuddy || m_bNowBuddy || m_bBuddyMode == TRUE) return;	
	/*{
		msg.Format( "ÄãÓÐ¶ÓÎé." );
		SendSystemMsg((LPTSTR)(LPCTSTR)msg, SYSTEM_NORMAL, TO_ME);*/
	for (i = 0; i < MAX_USER; i++ )	
	{
		pUser = m_pCom->GetUserUid(i);
		if(!(pUser && pUser->m_state == STATE_GAMESTARTED)) continue;	
		if(strcmp(m_strUserID, pUser->m_strUserID) == 0)  continue;	
		diffLevel = abs(m_sLevel - pUser->m_sLevel);
		if( diffLevel > 20) continue;
		if(pUser->m_bMakeBuddy) 
		{ 
			for(j = 0; j < MAX_BUDDY_USER_NUM; j++)	
			{	
				if(pUser->m_MyBuddy[j].uid == -1)
				{	
					TempBuf.AddString(m_strUserID);
					pUser->BuddyUserChange(TempBuf, 6);	
					return;
				}
            }
         }
	}
}

void USER::DUBOxitong(TCHAR *pBuf)
{
    if(m_dwDN < 200000)
	{
		SendSystemMsg("±ä¸üÊôÐè20Íò¾öÕ½±Ò!",SYSTEM_ERROR,TO_ME);
		return;
	}
	bool SxUse = false;
	BYTE tWear = -1;
	int iRandom = 0;
	BYTE newSX = -1;
	int index = 0;
	int iCount = 0;//ÊôÐÔÀà±ðÅÅÊý³õÊ¼»¯
	short sid1 = -1;
	short sid2 = -1;
	short Slot1 = GetShort(pBuf, index);
	short Slot2 = GetShort(pBuf, index);
	short Slot3 = GetShort(pBuf, index);
	if(Slot1 < EQUIP_ITEM_NUM || Slot1 >= TOTAL_INVEN_MAX) return;//Ö÷Ìå
	if(Slot2 < EQUIP_ITEM_NUM || Slot2 >= TOTAL_INVEN_MAX) return;//°ÂÊõ
	if(Slot3 < 0 || Slot3 > 3) return;//ÊôÐÔÖ¸Õë

	sid1 = m_UserItem[Slot1].sSid;
	sid2 = m_UserItem[Slot2].sSid;
	if(sid1 < 0 || sid2 < 0 || sid1 > g_arItemTable.GetSize() || sid2 > g_arItemTable.GetSize()) return;
	if(m_UserItem[Slot1].tMagic[3] == 0) return;//²»ÊÇËÄÌõÊôÐÔµÄ×°±¸ÎäÆ÷·µ»Ø
	if(m_UserItem[Slot1].tMagic[5] >= 1) return ;//Ö÷Ìå¸ÄÊý´óÓÚ0·µ»Ø
	tWear = g_arItemTable[sid1]->m_byWear;	
	if(tWear != 1 && tWear != 2 && tWear != 3 && tWear != 4 && tWear != 5) return;
	if(sid2 != 1439) return;
	do
	{
	  iRandom = myrand(1, 145);
        if(g_arMagicItemTable[iRandom]->m_tUse == 1 )//ÒÑ¿ª·ÅµÄÊôÐÔÇ°ÌáÏÂ
		{
			if(tWear == 1)//ÎäÆ÷
			{
			  if(CheckClassItem(g_arItemTable[sid1]->m_byClass, g_arMagicItemTable[iRandom]->m_tNeedClass))	// ¼ì²âÊôÐÔÊôÓÚÄÄ¸öÖ°Òµ
			  {
				if(g_arMagicItemTable[iRandom]->m_tWearInfo == 1 || g_arMagicItemTable[iRandom]->m_tWearInfo == 0)//ÊôÐÔÀà±ðÇø·Ö,0=ÌØÊâÊôÐÔÎäÆ÷×°±¸Í¨ÓÃ,1=ÎäÆ÷ 2=×°±¸ 
				{
					newSX = (unsigned)g_arMagicItemTable[iRandom]->m_sSid;
					if(newSX == m_UserItem[Slot1].tMagic[0] || newSX == m_UserItem[Slot1].tMagic[1] || newSX == m_UserItem[Slot1].tMagic[2] || newSX == m_UserItem[Slot1].tMagic[3]) continue;//ÊôÐÔ²»¿ÉÖØ¸´
					SxUse = true;
				 }
			  }
			 }else if(tWear == 2 || tWear == 3 || tWear == 4|| tWear==5)//×°±¸
			   { 
				if(g_arMagicItemTable[iRandom]->m_tWearInfo == 2 || g_arMagicItemTable[iRandom]->m_tWearInfo == 0)//10ÊôÐÔ,100ÑªÕâÀàÌØÊâÊôÐÔµÄÎäÆ÷/×°±¸Çø·ÖÊÇ0
				{ 
					newSX = (unsigned)g_arMagicItemTable[iRandom]->m_sSid;
					if(newSX == m_UserItem[Slot1].tMagic[0] || newSX == m_UserItem[Slot1].tMagic[1] || newSX == m_UserItem[Slot1].tMagic[2] || newSX == m_UserItem[Slot1].tMagic[3]) continue;//ÊôÐÔ²»¿ÉÖØ¸´
					SxUse = true;
				}
			}
		}
    }while(!SxUse);
	
	if(newSX == -1) return;	
	
	ItemList	TempItem;
	TempItem = m_UserItem[Slot1];	
	ReSetItemSlot(&m_UserItem[Slot1]);
	if(m_UserItem[Slot2].sCount <= 1) ReSetItemSlot(&m_UserItem[Slot2]);// ¼Òºñ¼º ÀÌ¹Ç·Î ¸ÕÀú ÃÊ±âÈ­ÇÏ°í 
	else							   m_UserItem[Slot2].sCount -= 1;
	m_UserItem[Slot1] = TempItem;		
	m_UserItem[Slot1].tMagic[Slot3] = newSX;

   
	CUIntArray arMaterial;
	arMaterial.Add(Slot1);
	arMaterial.Add(Slot2);
	CBufferEx TempBuf;
	int i,j;
	TempBuf.Add(UPGRADE_ITEM_RESULT);
	index = arMaterial.GetSize();
	TempBuf.Add((BYTE)1);
	TempBuf.Add((BYTE)index);
	for(i = 0; i < arMaterial.GetSize(); i++)
	{
		BYTE bySlot = (BYTE)arMaterial[i];
		TempBuf.Add((BYTE)bySlot);
		TempBuf.Add(m_UserItem[bySlot].sLevel);
		TempBuf.Add(m_UserItem[bySlot].sSid);
		TempBuf.Add(m_UserItem[bySlot].sDuration);
		TempBuf.Add(m_UserItem[bySlot].sBullNum);
		TempBuf.Add(m_UserItem[bySlot].sCount);

		for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[bySlot].tMagic[j]);

		TempBuf.Add(m_UserItem[bySlot].tIQ); 
	}
	Send(TempBuf, TempBuf.GetLength());
	FlushItemLog( TRUE );	
	
	if(m_dwDN <= 200000) m_dwDN = 0;
	else m_dwDN = m_dwDN - 200000;
	UpdateUserItemDN();							
	SendMoneyChanged();

}  

void USER::DELSX(TCHAR* pBuf) //xiaoke
{
	int index = 0, i, j = 0 ,k= 0;
	short sSid = -1;
	BYTE tSlot = 0;
	int iWeight = 0;
	int random = 0 , random2 = 0,success =0;


	CByteArray arMaterial;
	arMaterial.RemoveAll();

    tSlot = GetByte(pBuf, index);
	if(tSlot < EQUIP_ITEM_NUM || tSlot >= TOTAL_INVEN_MAX) return;	
	if(m_UserItem[tSlot].sCount >= 2) return;
	sSid = m_UserItem[tSlot].sSid;
	if(sSid < 0 || sSid >= g_arItemTable.GetSize()) return;

	if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
	if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
	if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
	if( m_bZoneLogOut ) return;
	if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;


	if (m_UserItem[tSlot].tIQ == 12) return;

	if( FindItem( 724) < 3000)
	{
		SendEventMsg("É¾³ý×îºóÒ»ÌõÊôÐÔÐèÒª3000±êÖ¾");
		return;
	}

	    BYTE magic = m_UserItem[tSlot].tMagic[0];
		if (magic < 0 || magic >= g_arMagicItemTable.GetSize()) return;
				
			
		if( m_UserItem[tSlot].tMagic[3] !=0)	//4ÅÅ
		{
			m_UserItem[tSlot].tMagic[3]=0;
			MakeItemLog(&m_UserItem[tSlot], ITEMLOG_EBODY_UPGRADE_SUCCESS );
			iWeight += g_arItemTable[sSid]->m_byWeight;		
			arMaterial.Add((BYTE)tSlot);
			FlushItemLog( TRUE );
			RobItem( 724, 3000 );
			UpdateUserItemDN();							
			SendMoneyChanged();							
			CBufferEx TempBuf;
			TempBuf.Add(UPGRADE_ITEM_RESULT);
			index = arMaterial.GetSize();
			if(success == 1) TempBuf.Add((BYTE)0x01);	// EBody Upgrade ¼º°ø
			else TempBuf.Add((BYTE)0x00);				// EBody Upgrade ½ÇÆÐ

			TempBuf.Add((BYTE)index);
			
			for(i = 0;  i < arMaterial.GetSize(); i++)
			{
				tSlot = arMaterial[i];
				TempBuf.Add((BYTE)tSlot);
				TempBuf.Add(m_UserItem[tSlot].sLevel);
				TempBuf.Add(m_UserItem[tSlot].sSid);
				TempBuf.Add(m_UserItem[tSlot].sDuration);
				TempBuf.Add(m_UserItem[tSlot].sBullNum);
				TempBuf.Add(m_UserItem[tSlot].sCount);
				for(j =0; j < MAGIC_NUM; j++) TempBuf.Add(m_UserItem[tSlot].tMagic[j]);
				TempBuf.Add(m_UserItem[tSlot].tIQ); 
			}
			m_iCurWeight -= iWeight;
			if(m_iCurWeight < 0) m_iCurWeight = 0;
			GetRecoverySpeed();	
			Send(TempBuf, TempBuf.GetLength());
			arMaterial.RemoveAll();
			SendEventMsg("ÊôÐÔÉ¾³ý³É¹¦");
			
		}else

			SendEventMsg("±ØÐëÎªËÄÅÅÊôÐÔ");
}

void USER::Shenshengzhufu()
{
	DWORD dwCurrTick = GetTickCount();
    // ¼ì²é¸÷ÖÖ×´Ì¬£¬ÌáÇ°·µ»Ø
    if (m_bLive == USER_DEAD || m_bNoItemMove == TRUE || m_bViewingAShop == TRUE || 
        m_state != STATE_GAMESTARTED || m_bZoneLogOut || m_bPShopOpen == TRUE || 
        m_bNowTrading == TRUE || m_bSessionOnline == TRUE)
    {
        return;
    }
	if (dwCurrTick - m_dwLastItemZFTime < 1*1000)
	{
		return ;
	}else{
		m_dwLastItemZFTime = dwCurrTick;
	}

    // ³õ´ÎÇëÇó×£¸£
    if (m_DianJinum == 0)
    {
        SendNpcSay(NULL, 2307);
        m_DianJinum++;
        return;
    }

    // ¼ì²é±êÖ¾ÊýÁ¿
    if (FindItem(724) < 100)
    {
        SendEventMsg("³éÈ¡×£¸£Ê±¼äÐèÒª100±êÖ¾");
        return;
    }

    // ÏûºÄ100±êÖ¾
    RobItem(724, 100);

    // Ëæ»úÉú³É×£¸£ÀàÐÍ(±ÜÃâÓëµ±Ç°ÏàÍ¬)
    int iRandom;
    const int MAX_RETRY = 3;  // ×î´óÖØÊÔ´ÎÊý
    int retryCount = 0;
    
    do {
        iRandom = myrand(1, 16);
        retryCount++;
    } while(iRandom == m_dwZF && retryCount < MAX_RETRY);  // Ê¹ÓÃm_dwZF×÷ÎªÉÏ´ÎµÄ×£¸£ÀàÐÍ

    m_dwZF = iRandom;  // ÉèÖÃÐÂµÄ×£¸£ÀàÐÍ

    // ¸ù¾ÝÖ°ÒµºÍ×£¸£ÀàÐÍ»ñÈ¡ÌáÊ¾ÏûÏ¢
    char szMsg[256] = {0};
    switch (iRandom)
    {
        case 1:
            if (m_byClass == 0 || m_byClass == 2)
            {
                strcpy(szMsg, "Á¦Öµ5Ôö¼Ó");
            }
            else if (m_byClass == 1)
            {
                strcpy(szMsg, "ÖÇ»Û5Ôö¼Ó");
            }
            else if (m_byClass == 3)
            {
                strcpy(szMsg, "Ãô½Ý5Ôö¼Ó");
            }
            break;
            
        case 2:
            strcpy(szMsg, "ÉúÃüÖµ100Ôö¼Ó");
            break;
            
        case 3:
            if(m_byClass != 1)
            {
                strcpy(szMsg, "ÎïÀíËðÉË80Ôö¼Ó");
            }
            else
            {
                strcpy(szMsg, "Ä§·¨ËðÉË50Ôö¼Ó");
            }
            break;
            
        case 4:
            strcpy(szMsg, "·ÀÓùÁ¦100Ôö¼Ó");
            break;
            
        case 5:
            strcpy(szMsg, "Ä§·¨¿¹³â50Ôö¼Ó");
            break;
            
        case 6:
            strcpy(szMsg, "ËùÓÐÊôÐÔµã5Ôö¼Ó");
            break;
            
        case 7:
            strcpy(szMsg, "ÎïÀíÉËº¦¼õÉÙ50");
            break;
            
        case 8:
            strcpy(szMsg, "Ä§·¨ÉËº¦¼õÉÙ50");
            break;
            
        case 9:
            strcpy(szMsg, "×îÖÕÉËº¦¼õÉÙ30");
            break;
            
        case 10:
            strcpy(szMsg, "·ÀÓùÁ¦ÌáÉý°Ù·ÖÖ®10");
            break;
            
        case 11:
            if(m_byClass != 1)
            {
                strcpy(szMsg, "ÎïÀíÉËº¦ÌáÉý°Ù·ÖÖ®5");
            }
            else
            {
                strcpy(szMsg, "Ä§·¨ÉËº¦ÌáÉý°Ù·ÖÖ®5");
            }
            break;
            
        case 12:
            strcpy(szMsg, "É±¹Ö¾­ÑéÖµÌáÉý°Ù·ÖÖ®5");
            break;
            
        case 13:
            strcpy(szMsg, "»Ø±ÜÂÊÌáÉý15");
            break;
            
        case 14:
            if(m_byClass != 1)
            {
                strcpy(szMsg, "ÃüÖÐÂÊÌáÉý10");
            }
            else
            {
                strcpy(szMsg, "¿¹Ä§µÄ°Ù·ÖÖ®20×ª¹¥»÷");
            }
            break;
            
        case 15:
            strcpy(szMsg, "ËùÓÐ¼¼ÊõµÈ¼¶1");
            break;
            
        case 16:
            if(m_byClass == 0)
            {
                strcpy(szMsg, "ÐË·Ü¼¼ÊõµÈ¼¶2");
            }
            else if(m_byClass == 1)
            {
                strcpy(szMsg, "·¨Ê¦´óÊ¦µÈ¼¶2");
            }
            else if(m_byClass == 2)
            {
                strcpy(szMsg, "´©´Ì¼¼ÊõµÈ¼¶2");
            }
            else if(m_byClass == 3)
            {
                strcpy(szMsg, "Á¬Éä¼¼ÊõµÈ¼¶2");
            }
            break;
    }

    // ·¢ËÍÌáÊ¾ÏûÏ¢
    char szFinal[512] = {0};
    sprintf(szFinal, "Äú³éÈ¡×£¸£Îª£º%s", szMsg);
    SendEventMsg(szFinal);

    // ÉèÖÃ×£¸£Ê±¼ä²¢·¢ËÍÐ§¹û
    m_dwZFTime = 3600 * 2 * 1000;
    CheckMagicItemMove();

    // ·¢ËÍÑÌ»¨Ð§¹û
    CBufferEx TempBuf3;
    TempBuf3.Add(USE_POTION);
    TempBuf3.Add(m_uid + USER_BAND);
    TempBuf3.Add((BYTE)12);
    Send(TempBuf3, TempBuf3.GetLength());
}

//void USER::Shenshengzhufu()//ÉñÊ¥×£¸£
//{
//	if(m_bLive == USER_DEAD) return;	//ËÀÍöÇëÇó	
//    if(m_bNoItemMove == TRUE) return;		//ÎïÆ·ÒÆ¶¯ÇëÇó
//	if(m_bViewingAShop == TRUE) return;	//²é¿´ÉÌµêÇëÇó	
//	if(m_state != STATE_GAMESTARTED) return; //ÓÎÏ·Î´¿ªÊ¼ÇëÇó
//	if( m_bZoneLogOut ) return;
//	if(m_bPShopOpen == TRUE || m_bNowTrading == TRUE || m_bSessionOnline == TRUE)  return;
//	CBufferEx TempBuf, TempSayBuf , TempBuf3;
//	
//	if (m_DianJinum == 0)
//	{
//		SendNpcSay(NULL, 2307);
//	    m_DianJinum++;
//		return;
//	}
//	if( FindItem( 724) < 100)
//	{
//		SendEventMsg("³éÈ¡×£¸£Ê±¼äÐèÒª100±êÖ¾");
//		return;
//	}
//	RobItem( 724, 100 );
//
//	int iRandom;
//	iRandom = myrand(1,16);//Ëæ»úÄÚÊý
//	
//	if(iRandom == 1)
//	{
//		m_dwZF = 1;
//
//		if( m_byClass == 0 || m_byClass == 2)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÁ¦Öµ5Ôö¼Ó");
//	    }else if( m_byClass == 1 )
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÖÇ»Û5Ôö¼Ó");
//	    }else if( m_byClass == 3)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÃô½Ý5Ôö¼Ó");
//	    }
//	}
//	if(iRandom == 2)
//	{
//		m_dwZF = 2;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÉúÃüÖµ100Ôö¼Ó");
//	}
//	if(iRandom == 3)
//	{
//		m_dwZF = 3;
//
//		if( m_byClass != 1)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÎïÀíËðÉË80Ôö¼Ó");
//		}else if( m_byClass == 1)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÄ§·¨ËðÉË50Ôö¼Ó");
//		}
//	}
//	if(iRandom == 4)
//	{
//		m_dwZF = 4;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£º·ÀÓùÁ¦100Ôö¼Ó");
//	    
//	}
//	if(iRandom == 5)
//	{
//		m_dwZF = 5;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÄ§·¨¿¹³â50Ôö¼Ó");
//	    
//	}
//	if(iRandom == 6)
//	{
//		m_dwZF = 6;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºËùÓÐÊôÐÔµã5Ôö¼Ó");
//	}
//	if(iRandom == 7)
//	{
//		m_dwZF = 7;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÎïÀíÉËº¦¼õÉÙ50");
//	}
//	if(iRandom == 8)
//	{
//		m_dwZF = 8;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÄ§·¨ÉËº¦¼õÉÙ50");
//	}
//	if(iRandom == 9)
//	{
//		m_dwZF = 9;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£º×îÖÕÉËº¦¼õÉÙ30");
//	 }
//	if(iRandom == 10)
//	{
//		m_dwZF = 10;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£º·ÀÓùÁ¦ÌáÉý°Ù·ÖÖ®10");
//	}
//	if(iRandom == 11)
//	{
//		m_dwZF = 11;
//		if( m_byClass != 1)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÎïÀíÉËº¦ÌáÉý°Ù·ÖÖ®5");
//		}else if( m_byClass == 1)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÄ§·¨ÉËº¦ÌáÉý°Ù·ÖÖ®5");
//		}
//	}
//	if(iRandom == 12)
//	{
//		m_dwZF = 12;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÉ±¹Ö¾­ÑéÖµÌáÉý°Ù·ÖÖ®5");
//	}
//    if(iRandom == 13)
//	{
//		m_dwZF = 13;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£º»Ø±ÜÂÊÌáÉý15");
//	}
//	if(iRandom == 14)
//	{
//		m_dwZF = 14;
//		if( m_byClass != 1)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÃüÖÐÂÊÌáÉý10");
//		}else if( m_byClass == 1)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£º¿¹Ä§µÄ°Ù·ÖÖ®20×ªÄ§·¨¹¥»÷");
//		}
//	}
//    if(iRandom == 15)
//	{
//		m_dwZF = 15;
//		SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºËùÓÐ¼¼ÊõµÈ¼¶1");
//	 }
//	if(iRandom == 16)
//	{
//		m_dwZF = 16;
//		if( m_byClass == 0)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÐË·Ü¼¼ÊõµÈ¼¶2");
//		}else if( m_byClass == 1)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£º·¨Ê¦´óÊ¦µÈ¼¶2");
//		}else if( m_byClass == 2)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£º´©´Ì¼¼ÊõµÈ¼¶2");
//		}else if( m_byClass == 3)
//		{
//			SendEventMsg("¹§Ï²Äú³éÈ¡×£¸£Îª£ºÁ¬Éä¼¼ÊõµÈ¼¶2");
//		}
//	}
//	
//	m_dwZFTime = 3600 * 2 * 1000;
//	CheckMagicItemMove();
//    TempBuf3.Add(USE_POTION);		
//	TempBuf3.Add(m_uid + USER_BAND);
//	TempBuf3.Add((BYTE)12);	//ÖÐ½±Ê±´øÑÌ»¨Ð§¹û
//	Send( TempBuf3, TempBuf3.GetLength() );
//}

BOOL USER::AginOnlineShop()//ÖØ¶ÁÏûºÄÆ·ÉÌµê
{
	int i;

	for(i = 0; i < g_arOnlineShopTable.GetSize(); i++) g_arOnlineShopTable.RemoveAll();

	SQLHSTMT		hstmt;
	SQLRETURN		retcode;
	TCHAR			szSQL[2048];

	::ZeroMemory(szSQL, sizeof(szSQL));
	wsprintf(szSQL,TEXT("SELECT * FROM OnlineShop"));

	SQLSMALLINT		oSid;
	SQLSMALLINT		iSid;
	SQLCHAR			iSname[20];
	SQLSMALLINT		price;
	SQLSMALLINT		iNum;
	SQLSMALLINT		sx1;
	SQLSMALLINT		sx2;
	SQLSMALLINT		sx3;
	SQLSMALLINT		sx4;
	SQLSMALLINT		sx5;
	SQLSMALLINT		upgrade;
	SQLSMALLINT		sx6;
	SQLSMALLINT		sx7;
	SQLSMALLINT		sx8;
	SQLSMALLINT		sx9;
	SQLSMALLINT		sx10;
	SQLCHAR			iText[50];

	SQLINTEGER		sInd;

	::ZeroMemory(iSname, sizeof(iSname));
	::ZeroMemory(iText, sizeof(iText));
	oSid = 0;	iSid = 0;	price = 0;	iNum = 0;
	sx1 = 0;	sx2 = 0;	sx3 = 0;	sx4	= 0;	sx5 = 0;
	upgrade = 0;
	sx6 = 0;	sx7 = 0;	sx8 = 0;	sx9 = 0;	sx10 = 0;

	int db_index = 0;
	CDatabase* pDB = g_DB[AUTOMATA_THREAD].GetDB( db_index );
	if( !pDB ) return FALSE;

	retcode = SQLAllocHandle( (SQLSMALLINT)SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt );
	if( retcode != SQL_SUCCESS )
	{
		TRACE("Fail To Load UserSort Data !!\n");
		AfxMessageBox(_T("OnlineShop Table Open Fail!"));
		//g_DB[AUTOMATA_THREAD].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLExecDirect( hstmt, (unsigned char*)szSQL, SQL_NTS);
	if( retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO )
	{
		while (TRUE)
		{
			retcode = SQLFetch(hstmt);

			if (retcode ==SQL_SUCCESS || retcode ==SQL_SUCCESS_WITH_INFO)
			{
				i = 1;

				SQLGetData( hstmt, i++, SQL_C_SSHORT, &oSid, sizeof(oSid), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &iSid, sizeof(iSid), &sInd );
				SQLGetData( hstmt, i++, SQL_C_CHAR,	  &iSname, sizeof(iSname), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &price, sizeof(price), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &iNum, sizeof(iNum), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx1, sizeof(sx1), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx2, sizeof(sx2), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx3, sizeof(sx3), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx4, sizeof(sx4), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx5, sizeof(sx5), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &upgrade, sizeof(upgrade), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx6, sizeof(sx6), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx7, sizeof(sx7), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx8, sizeof(sx8), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx9, sizeof(sx9), &sInd );
				SQLGetData( hstmt, i++, SQL_C_SSHORT, &sx10, sizeof(sx10), &sInd );
				SQLGetData( hstmt, i++, SQL_C_CHAR,	  &iText, sizeof(iText), &sInd );
				
				OnlineShop *OSP = new OnlineShop;
				
				OSP->m_oSid = oSid;
				OSP->m_iSid = iSid;
				strcpy_s(OSP->m_iSname, (CHAR*)iSname);
				OSP->m_price = price;
				OSP->m_iNum	 = iNum;
				OSP->m_sx1	 = sx1;
				OSP->m_sx2	 = sx2;
				OSP->m_sx3	 = sx3;
				OSP->m_sx4	 = sx4;
				OSP->m_sx5	 = sx5;
				OSP->m_upgrade = upgrade;
				OSP->m_sx6	 = sx6;
				OSP->m_sx7	 = sx7;
				OSP->m_sx8	 = sx8;
				OSP->m_sx9	 = sx9;
				OSP->m_sx10	 = sx10;
				strcpy_s(OSP->m_iText, (CHAR*)iText);

				g_arOnlineShopTable.Add(OSP);
			}
			else break;
		}		
	}
	else if (retcode==SQL_NO_DATA)
	{
		g_DB[AUTOMATA_THREAD].ReleaseDB(db_index);
		return FALSE;
	}
	else
	{
		retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
		g_DB[AUTOMATA_THREAD].ReleaseDB(db_index);
		return FALSE;
	}

	retcode = SQLFreeHandle( (SQLSMALLINT)SQL_HANDLE_STMT, hstmt);
	g_DB[AUTOMATA_THREAD].ReleaseDB(db_index);

	return TRUE;


}

//void USER:: GetItem(ItemList* pItem, int type)//112233
//{
//	if( !pItem ) return;   
//	
//	CString GoodsMagic;CString strMsg; int pingfen =0; 

//	int CheckItem_Str = 0; //¼ì²éÁ¦Á¿
//	int CheckItem_Dex = 0; //¼ì²éÃô½Ý
//	int CheckItem_Vol = 0; //¼ì²éÖÇ»Û
//
//    if (pItem->sSid < 0 || pItem->sSid >= g_arItemTable.GetSize()) return;
//
//	for(int i = 0; i< MAGIC_NUM; i++)
//	{
//		if(pItem->tMagic[i]<=0 || pItem->tMagic[i] >= g_arMagicItemTable.GetSize()) continue;
//			
//		int shuxing = pItem->tMagic[i];
//		int tClass = g_arItemTable[pItem->sSid]->m_byWear;
//		int zhiye = g_arItemTable[pItem->sSid]->m_byClass;
//		
//		if ( tClass == 1 )//¼ì²âÀàÐÍÎªÎäÆ÷¸øÆÀ·Ö    zhiye 8È­  4·¨  2µ¶ 1Ç¹
//		{
//            if (zhiye == 8 || zhiye == 2 || zhiye == 1 )//ÎïÀíÖ°Òµ
//			{    //ÃüÖÐ10              ËðÉË25             3ËÙ               ËùÓÐ2             ÐË·Ü2               Á¬Éä2        ´©´Ì2
//				if (shuxing == 138 || shuxing == 128 || shuxing == 93 || shuxing == 145|| shuxing == 113  || shuxing == 125|| shuxing == 120) {pingfen += 50;}  
//				 //ÃüÖÐ9               ËðÊ§20                               ËùÓÐ1             ÐË·Ü1               Á¬Éä1        ´©´Ì1
//				if (shuxing == 95  || shuxing == 91  ||                  shuxing == 137|| shuxing == 49   || shuxing == 61|| shuxing == 56)  {pingfen += 45;}  //2¼¶ÊôÐÔ
//				//ÃüÖÐ8                ËðÊ§15             ÃüÖÐ7            ËðÉË15
//				if (shuxing == 94 || shuxing == 64  || shuxing == 74 || shuxing == 64) {pingfen += 40;}  //Ê£ÏÂµÄ   
//			}else if(zhiye == 4)// ·¨Ê¦Ö°Òµ
//			{       //Ä§¹¥25            ËùÓÐ2              ·¨Êõ2
//				if (shuxing == 136 || shuxing == 145 || shuxing == 117){pingfen += 50;}  //1¼¶ÊôÐÔ
//				if (shuxing == 106 || shuxing == 137 || shuxing == 53){pingfen += 45;}  //1¼¶ÊôÐÔ
//			}
////==============================================================================================================================================ÏÂÃæÏÔÊ¾¼à²â×°±¸
//		/*  50Ñª 141  +50      40Ñª 132   +40     30Ñª  102   +30
//            25¿¹ 135  +50      20¿¹ 105   +40     15¿¹   84   +30
//            10»Ø 139  +50      9»Ø  97    +40     8»Ø    96   +30
//			5Á¦  107  +50      4Á¦  86    +40     3Á¦    43   +30
//			5Ãô  109  +50      4Ãô  88    +40     3Ãô    45   +30
//			5ÖÇ  110  +50      4ÖÇ  89    +40     3ÖÇ    46   +30
//                                                  10·À 130  +30       
//		 
//                    */
//		}else if( tClass > 1 && tClass < 6 )
//		{
//			if( pItem->tMagic[i]==43 || pItem->tMagic[i]==86 || pItem->tMagic[i]==107) CheckItem_Str = 1;//¼ì²éÁ¦
//			if( pItem->tMagic[i]==45 || pItem->tMagic[i]==88 || pItem->tMagic[i]==109) CheckItem_Dex = 1;//¼ì²éÃô
//			if( pItem->tMagic[i]==46 || pItem->tMagic[i]==89 || pItem->tMagic[i]==110) CheckItem_Vol = 1;//¼ì²éÖÇ»Û
//
//			if (shuxing == 141 || shuxing == 135 || shuxing == 139|| shuxing == 107|| shuxing == 109 || shuxing == 110) 
//			{
//				pingfen += 50;
//			}if (shuxing == 132 || shuxing == 105 || shuxing == 97 || shuxing == 86  || shuxing == 88 || shuxing == 89 ) 
//			{
//				pingfen += 40;
//			}if (shuxing == 102 || shuxing == 84  || shuxing == 96 || shuxing == 43  || shuxing == 45 || shuxing == 46  || shuxing == 130) 
//			{
//				pingfen += 30;
//			}
//			if( CheckItem_Str == 1 &&  CheckItem_Dex == 1)  pingfen = 0; //Á¦Á¿ºÍÃô½ÝÍ¬Ê±³öÏÖ ·ÖÊý0
//	        if( CheckItem_Dex == 1 &&  CheckItem_Vol == 1)  pingfen = 0; //Ãô½ÝºÍÖÇ»ÛÍ¬Ê±³öÏÖ ·ÖÊý0
//	        if( CheckItem_Str == 1 &&  CheckItem_Vol == 1)  pingfen = 0; //Á¦Á¿ºÍÖÇ»ÛÍ¬Ê±³öÏÖ ·ÖÊý0
//
//			if((zhiye == 8 ||zhiye == 2) && ( CheckItem_Vol == 1 || CheckItem_Dex == 1))  pingfen = 0; //È­ºÍµ¶²»ÒªÃôºÍÖÇ»Û
//
//			if(zhiye == 4 && (CheckItem_Str == 1 || CheckItem_Dex == 1))  pingfen = 0; //·¨Ê¦²»ÒªÃôºÍÁ¦
//			if(zhiye == 1 && (CheckItem_Vol == 1 || CheckItem_Str == 1))  pingfen = 0; //Ç¹²»ÒªÖÇ»ÛºÍÁ¦
//
//				
//
//		}
//			
//}//==========Ìø³öÑ­»·²éÑ¯
//
//	if( ITEMLOG_PICKUP==type)
//	{
//		if ( g_arItemTable[pItem->sSid]->m_byWear == 1 && pingfen >= 170 && g_pingfen == FALSE )//ÎïÆ·ÎªÎäÆ÷
//		{
//			for(int i = 0; i <= 4; i++)
//			{
//				if(pItem->tMagic[i] != 0 )
//				{
//					pItem->iItemSerial = 1;
//					GoodsMagic+= g_arMagicItemTable[pItem->tMagic[i]]->m_strText;
//					GoodsMagic+=",";
//				}
//			}
//			strMsg.Format("[%s] Ê°È¡ %s ÆÀ·Ö %d ", this->m_strUserID,g_arItemTable[pItem->sSid]->m_strName ,pingfen);//¹«¸æÌáÊ¾
//			strMsg+=GoodsMagic;
//			m_pCom->Announce2((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
//		}
//		else if ( g_arItemTable[pItem->sSid]->m_byWear != 1 && pingfen >= 170 && g_pingfen == FALSE )//ÎïÆ·Îª×°±¸ 
//		{
//			for(int i = 0; i <= 4; i++)
//			{
//				if(pItem->tMagic[i] != 0 )
//				{
//					pItem->iItemSerial = 1;
//					GoodsMagic+= g_arMagicItemTable[pItem->tMagic[i]]->m_strText;
//					GoodsMagic+=",";
//				}
//			}
//			strMsg.Format("[%s] Ê°È¡ %s ÆÀ·Ö %d ", this->m_strUserID,g_arItemTable[pItem->sSid]->m_strName ,pingfen);//¹«¸æÌáÊ¾
//			strMsg+=GoodsMagic;
//			m_pCom->Announce2((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
//		}
//	}
//	int iSlot = GetEmptySlot( INVENTORY_SLOT );
//	if( iSlot < 1 && m_AutoD == 1  && !IsCity())
//	{
//		YJmzb();
//		SendEventMsg("ÎïÆ·À¸¼´½«Âú[×Ô¶¯ÎªÄúÂôµôÇ°Á½ÅÅ]");
//	}
//
//	if(pingfen >= 170) //Ð´ÈÕÖ¾
//	{
//		CString str = _T("");
//		SYSTEMTIME st;
//		CString strDate;
//		GetLocalTime(&st);
//		CString sx1 = g_arMagicItemTable[pItem->tMagic[0]]->m_strText;
//		CString sx2 = g_arMagicItemTable[pItem->tMagic[1]]->m_strText;
//		CString sx3 = g_arMagicItemTable[pItem->tMagic[2]]->m_strText;
//		CString sx4 = g_arMagicItemTable[pItem->tMagic[3]]->m_strText;
//		strDate.Format("%d-%d %d:%d",st.wMonth,st.wDay ,st.wHour,st.wMinute);
//		str.Format("[%s] Íæ¼Ò [%s] Ê°È¡ %s ÆÀ·Ö %d ÊôÐÔ %s %s %s %s \r\n",strDate,m_strUserID,g_arItemTable[pItem->sSid]->m_strName,pingfen,sx1,sx2,sx3,sx4);
//		EnterCriticalSection( &m_CS_FileWrite );
//		g_fpSpeedHack0.Write( str, str.GetLength() );
//		LeaveCriticalSection( &m_CS_FileWrite);
//	}
//}
void USER::GetItem(ItemList* pItem, int type)//ÆÀ·Ö¹«¸æ
{
    if(!pItem || !g_arItemTable.GetSize()) return;
    if(pItem->sSid < 0 || pItem->sSid >= g_arItemTable.GetSize()) return;

    // ¼ÆËãÆÀ·Ö
    int pingfen = CalcItemPingfen(pItem);
    
    // Ö»´¦ÀíÆÀ·Ö´óÓÚµÈÓÚ170µÄÎïÆ·
    if(pingfen >= 170 && g_pingfen == FALSE)
    {
        CString GoodsMagic;
       // const bool isWeapon = (g_arItemTable[pItem->sSid]->m_byWear == 1);
        
        // ÊÕ¼¯ÎïÆ·ÊôÐÔ
        for(int i = 0; i <= 4; i++)
        {
            if(pItem->tMagic[i] > 0 && pItem->tMagic[i] < g_arMagicItemTable.GetSize())
            {
                GoodsMagic += g_arMagicItemTable[pItem->tMagic[i]]->m_strText;
                GoodsMagic += ",";
            }
        }

        // ·¢ËÍ¹«¸æ
        if(ITEMLOG_PICKUP == type)
        {
            CString strMsg;
            strMsg.Format("[%s]Ê°È¡ %s ÆÀ·Ö %d ", 
                         m_strUserID,
                         g_arItemTable[pItem->sSid]->m_strName,
                         pingfen);
            strMsg += GoodsMagic;
            m_pCom->Announce2((LPTSTR)(LPCTSTR)strMsg, SYSTEM_ANNOUNCE);
        }

        // ¼ÇÂ¼ÈÕÖ¾
        SYSTEMTIME st;
        GetLocalTime(&st);
        
        CString strDate, strLog;
        strDate.Format("%d-%d %d:%d", st.wMonth, st.wDay, st.wHour, st.wMinute);
        
        // »ñÈ¡Ç°4¸öÊôÐÔ
        CString attributes[4];
        for(int i = 0; i < 4; i++)
        {
            if(pItem->tMagic[i] > 0 && pItem->tMagic[i] < g_arMagicItemTable.GetSize())
            {
                attributes[i] = g_arMagicItemTable[pItem->tMagic[i]]->m_strText;
            }
            else
            {
                attributes[i] = "";
            }
        }
        
        strLog.Format("[%s] Íæ¼Ò [%s] Ê°È¡ %s ÆÀ·Ö %d ÊôÐÔ %s %s %s %s \r\n",
                      strDate, m_strUserID, g_arItemTable[pItem->sSid]->m_strName,
                      pingfen, attributes[0], attributes[1], attributes[2], attributes[3]);

        EnterCriticalSection(&m_CS_FileWrite);
        g_fpSpeedHack0.Write(strLog, strLog.GetLength());
        LeaveCriticalSection(&m_CS_FileWrite);
    }

    // ¼ì²é±³°ü¿Õ¼ä
    int iSlot = GetEmptySlot(INVENTORY_SLOT);
    if(iSlot < 1 && m_AutoD == 1 && !IsCity())
    {
        YJmzb();
        SendEventMsg("ÎïÆ·À¸¼´½«Âú[µÍÓÚ170·Ö]ÒÑÂô");
    }
}
void USER::MyTime()
{
    CString sayStr;
    CBufferEx TempBuf, TempSayBuf;
    const int HOUR_IN_MS = 3600 * 1000;  // Ò»Ð¡Ê±µÄºÁÃëÊý
    int hour = 0, min = 0;

    // ÏÔÊ¾ÐË·ÜÊ±¼ä
    if(m_dwHiExpTime > 0)
    {
        hour = m_dwHiExpTime/HOUR_IN_MS;
        min = m_dwHiExpTime%HOUR_IN_MS/(60000);
        sayStr.Format("%dÐ¡Ê±%d·Ö", hour, min);
    }
    else 
    {
        sayStr.Format(" 0 ·ÖÖÓ");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾ÐÒÔËÊ±¼ä
    if(m_dwMagicFindTime > 0)
    {
        hour = m_dwMagicFindTime/HOUR_IN_MS;
        min = m_dwMagicFindTime%HOUR_IN_MS/(60000);
        sayStr.Format("%dÐ¡Ê±%d·Ö", hour, min);
    }
    else 
    {
        sayStr.Format(" 0 ·ÖÖÓ");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾ÌìÊ¹Ê±¼ä
    if(m_dwVIPTime > 0)
    {
        hour = m_dwVIPTime/HOUR_IN_MS;
        min = m_dwVIPTime%HOUR_IN_MS/(60000);
        sayStr.Format("%dÐ¡Ê±%d·Ö", hour, min);
    }
    else 
    {
        sayStr.Format(" 0 ·ÖÖÓ");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾»ÃÁéÊ±¼ä
    if(m_dwHtExpTime > 0)
    {
        hour = m_dwHtExpTime/HOUR_IN_MS;
        min = m_dwHtExpTime%HOUR_IN_MS/(60000);
        sayStr.Format("%dÐ¡Ê±%d·Ö", hour, min);
    }
    else 
    {
        sayStr.Format(" 0 ·ÖÖÓ");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾»Ã¾§Ê±¼ä
    if(m_dwMagicFtTime > 0)
    {
        hour = m_dwMagicFtTime/HOUR_IN_MS;
        min = m_dwMagicFtTime%HOUR_IN_MS/(60000);
        sayStr.Format("%dÐ¡Ê±%d·Ö", hour, min);
    }
    else 
    {
        sayStr.Format(" 0 ·ÖÖÓ");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾ÀÇ±äÊ±¼ä
    if(m_dwBFindTime > 0)
    {
        hour = m_dwBFindTime/HOUR_IN_MS;
        min = m_dwBFindTime%HOUR_IN_MS/(60000);
        sayStr.Format("%dÐ¡Ê±%d·Ö", hour, min);
    }
    else 
    {
        sayStr.Format(" 0 ·ÖÖÓ");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾á÷ÁÔÊ±¼ä
    if(m_dwSGTime > 0)
    {
        hour = m_dwSGTime/HOUR_IN_MS;
        min = m_dwSGTime%HOUR_IN_MS/(60000);
        sayStr.Format("%dÐ¡Ê±%d·Ö", hour, min);
    }
    else 
    {
        sayStr.Format(" 0 ·ÖÖÓ");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾É±¹ÖÊýÁ¿
    if(m_dwShaGuai > 0)
    {
        sayStr.Format("%d Ö»", m_dwShaGuai);
    }
    else 
    {
        sayStr.Format(" 0 Ö»");
    }
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);


	

    // ÏÔÊ¾·±ÈÙÏµÍ³¼Ó³É

	double beishu = GetBeiShu();
	
	sayStr.Format("+ %.2f±¶", beishu);
    
    TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);

    // ÏÔÊ¾×£¸£Ð§¹û
    if(m_dwZFTime > 0)
    {
        hour = m_dwZFTime/HOUR_IN_MS;
        min = m_dwZFTime%HOUR_IN_MS/(60000);
        
        // ¸ù¾Ý×£¸£ÀàÐÍÏÔÊ¾Ð§¹û
        switch(m_dwZF)
        {
        case 1:  // ÊôÐÔÔö¼Ó
            if(m_byClass == 0 || m_byClass == 2)
                sayStr.Format("%dÐ¡Ê±%d·Ö Á¦Öµ5Ôö¼Ó", hour, min);
            else if(m_byClass == 1)
                sayStr.Format("%dÐ¡Ê±%d·Ö ÖÇ»Û5Ôö¼Ó", hour, min);
            else if(m_byClass == 3)
                sayStr.Format("%dÐ¡Ê±%d·Ö Ãô½Ý5Ôö¼Ó", hour, min);
            break;

        case 2:  // ÉúÃüÖµ
            sayStr.Format("%dÐ¡Ê±%d·Ö ÉúÃüÖµ100Ôö¼Ó", hour, min);
            break;

        case 3:  // ÉËº¦Ôö¼Ó
            if(m_byClass != 1)
                sayStr.Format("%dÐ¡Ê±%d·Ö ÎïÀíËðÉË80Ôö¼Ó", hour, min);
            else
                sayStr.Format("%dÐ¡Ê±%d·Ö Ä§·¨ËðÉË50Ôö¼Ó", hour, min);
            break;

        case 4:  // ·ÀÓùÁ¦
            sayStr.Format("%dÐ¡Ê±%d·Ö ·ÀÓùÁ¦100Ôö¼Ó", hour, min);
            break;

        case 5:  // Ä§·¨¿¹ÐÔ
            sayStr.Format("%dÐ¡Ê±%d·Ö Ä§·¨¿¹³â50Ôö¼Ó", hour, min);
            break;

        case 6:  // ËùÓÐÊôÐÔ
            sayStr.Format("%dÐ¡Ê±%d·Ö ËùÓÐÊôÐÔµã5Ôö¼Ó", hour, min);
            break;

        case 7:  // ÎïÀíÉËº¦¼õÉÙ
            sayStr.Format("%dÐ¡Ê±%d·Ö ÎïÀíÉËº¦¼õÉÙ50", hour, min);
            break;

        case 8:  // Ä§·¨ÉËº¦¼õÉÙ
            sayStr.Format("%dÐ¡Ê±%d·Ö Ä§·¨ÉËº¦¼õÉÙ50", hour, min);
            break;

        case 9:  // ×îÖÕÉËº¦¼õÉÙ
            sayStr.Format("%dÐ¡Ê±%d·Ö ×îÖÕÉËº¦¼õÉÙ30", hour, min);
            break;

        case 10:  // ·ÀÓùÁ¦ÌáÉý
            sayStr.Format("%dÐ¡Ê±%d·Ö ·ÀÓùÁ¦ÌáÉý°Ù·ÖÖ®10", hour, min);
            break;

        case 11:  // ÉËº¦ÌáÉý
            if(m_byClass != 1)
                sayStr.Format("%dÐ¡Ê±%d·Ö ÎïÀíÉËº¦ÌáÉý°Ù·ÖÖ®5", hour, min);
            else
                sayStr.Format("%dÐ¡Ê±%d·Ö Ä§·¨ÉËº¦ÌáÉý°Ù·ÖÖ®5", hour, min);
            break;

        case 12:  // ¾­ÑéÌáÉý
            sayStr.Format("%dÐ¡Ê±%d·Ö É±¹Ö¾­ÑéÌáÉý°Ù·ÖÖ®5", hour, min);
            break;

        case 13:  // »Ø±ÜÂÊ
            sayStr.Format("%dÐ¡Ê±%d·Ö »Ø±ÜÂÊÌáÉý15", hour, min);
            break;

        case 14:  // ÃüÖÐ/¿¹Ä§×ª»»
            if(m_byClass != 1)
                sayStr.Format("%dÐ¡Ê±%d·Ö ÃüÖÐÂÊÌáÉý10", hour, min);
            else
                sayStr.Format("%dÐ¡Ê±%d·Ö ¿¹Ä§µÄ°Ù·ÖÖ®20×ª¹¥»÷", hour, min);
            break;

        case 15:  // ¼¼ÊõµÈ¼¶
            sayStr.Format("%dÐ¡Ê±%d·Ö ËùÓÐ¼¼ÊõµÈ¼¶1", hour, min);
            break;

        case 16:  // Ö°ÒµÌØÊâ¼¼ÄÜ
            if(m_byClass == 0)
                sayStr.Format("%dÐ¡Ê±%d·Ö ÐË·Ü¼¼ÊõµÈ¼¶2", hour, min);
            else if(m_byClass == 1)
                sayStr.Format("%dÐ¡Ê±%d·Ö ·¨Ê¦´óÊ¦µÈ¼¶2", hour, min);
            else if(m_byClass == 2)
                sayStr.Format("%dÐ¡Ê±%d·Ö ´©´Ì¼¼ÊõµÈ¼¶2", hour, min);
            else if(m_byClass == 3)
                sayStr.Format("%dÐ¡Ê±%d·Ö Á¬Éä¼¼ÊõµÈ¼¶2", hour, min);
            break;
        }
        TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);
    }
    else
    {
        sayStr.Format(" ÎÞ¼Ó³É");
        TempSayBuf.AddString((LPTSTR)(LPCTSTR)sayStr);
    }

    // ·¢ËÍÊý¾Ý
    TempBuf.Add(CLIENT_EVENT_SAY);
    TempBuf.Add((BYTE)SUCCESS);
    TempBuf.Add((short)79);
    TempBuf.Add((BYTE)0x0A);
    TempBuf.AddData(TempSayBuf, TempSayBuf.GetLength());
    Send(TempBuf, TempBuf.GetLength());
}
//void USER::MyTime()//12ÔÂ22ÈÕ
//{
//	CString sayStr;
//	CBufferEx TempBuf, TempSayBuf , TempBuf3;
//	int temptime = (3600 * 1000);
//	int Day = 0,hour = 0,min = 0,day = 0;
//	
//
//	if(m_dwHiExpTime > 0)
//	{
//	hour = m_dwHiExpTime/temptime;	min = m_dwHiExpTime%temptime/(60000);
//	sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//ÐË·Ü
//	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}else 
//	{
//		sayStr.Format(" 0 ·ÖÖÓ.");
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}if(m_dwMagicFindTime > 0)
//	{
//	hour = m_dwMagicFindTime/temptime;	min = m_dwMagicFindTime%temptime/(60000);
//	sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//ÐÒÔË
//	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}else 
//	{
//		sayStr.Format(" 0 ·ÖÖÓ.");
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}if(m_dwVIPTime > 0)
//	{
//	hour = m_dwVIPTime/temptime;	min = m_dwVIPTime%temptime/(60000);
//	sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//ÌìÊ¹
//	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}else 
//	{
//		sayStr.Format(" 0 ·ÖÖÓ.");
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}
//	if(m_dwHtExpTime > 0)
//	{
//	hour = m_dwHtExpTime/temptime;	min = m_dwHtExpTime%temptime/(60000);
//	sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//»ÃÁé
//	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}else 
//	{
//		sayStr.Format(" 0 ·ÖÖÓ.");
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}
//	if(m_dwMagicFtTime > 0)
//	{
//	hour = m_dwMagicFtTime/temptime;	min = m_dwMagicFtTime%temptime/(60000);
//	sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//»Ã¾§
//	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}else 
//	{
//		sayStr.Format(" 0 ·ÖÖÓ.");
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}
//	if(m_dwBFindTime > 0)
//	{
//	hour = m_dwBFindTime/temptime;	min = m_dwBFindTime%temptime/(60000);
//	sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//ÀÇ±ä
//	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}else 
//	{
//		sayStr.Format(" 0 ·ÖÖÓ.");
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}
//	if(m_dwSGTime > 0)
//	{
//	hour = m_dwSGTime/temptime;	min = m_dwSGTime%temptime/(60000);
//	sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//á÷ÁÔ
//	TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}else 
//	{
//		sayStr.Format(" 0 ·ÖÖÓ");
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//	}
//	if(m_dwShaGuai > 0)
//	{
//		sayStr.Format("%d Ö»",m_dwShaGuai);//É±¹Ö
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//		}else 
//		{
//			sayStr.Format(" 0 Ö»");
//			TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//		}
//		if(m_dwZFTime > 0)
//		{
//		hour = m_dwZFTime/temptime;	min = m_dwZFTime%temptime/(60000);
//		sayStr.Format("%dÐ¡Ê±%d·Ö",hour,min);//×£¸£Ê±¼ä
//		TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//		}else 
//		{
//			sayStr.Format(" 0 ·ÖÖÓ.");
//			TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//		}
//		int Maxslevel = ShowUserRank();
//        int Cha = Maxslevel- m_sLevel;
//		double beishu = 0;
//		beishu = Cha*0.03;
//
//		if( m_sLevel < Maxslevel)  //·±ÈÙÏµÍ³¼Ó³É
//		{
//			sayStr.Format("+ %.2f±¶",beishu);//×£¸£Ê±¼ä
//		    TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//		}else{
//			sayStr.Format(" ÎÞ¼Ó³É");
//			TempSayBuf.AddString( (LPTSTR)(LPCTSTR)sayStr );
//		}
//
//
//
//
//
//
//
//		TempBuf.Add(CLIENT_EVENT_SAY);
//	    TempBuf.Add((BYTE)SUCCESS);
//	    TempBuf.Add((short)79);
//	    TempBuf.Add((BYTE)0x0A);//·¢ËÍµÄÏÔÊ¾¶àÉÙÐÐ
//	    TempBuf.AddData(TempSayBuf, TempSayBuf.GetLength());
//	    Send(TempBuf, TempBuf.GetLength());
//	}

//int USER::ShowUserRank()
//{
//	SQLHSTMT hstmt = NULL;
//    SQLRETURN retcode;
//    TCHAR szSQL[1024];
//    ::ZeroMemory(szSQL, sizeof(szSQL));
//
//    int maxLevel = -1; // Ê¹ÓÃÊÊºÏµÄÀàÐÍÀ´´æ´¢×î´óÖµ
//    SQLINTEGER sInd;
//
//    // ¹¹½¨ SQL ²éÑ¯
//    _sntprintf_s(szSQL, sizeof(szSQL) / sizeof(TCHAR), TEXT("SELECT MAX(sLevel) AS sLevel FROM GameUser"));
//
//    int db_index = 0;
//    CDatabase* pDB = g_DBNew[AUTOMATA_THREAD].GetDB(db_index);
//    if (!pDB) return -1; // Èç¹ûÊý¾Ý¿âÁ¬½ÓÊ§°Ü£¬·µ»Ø -1
//
//    // ·ÖÅä¾ä±ú
//    retcode = SQLAllocHandle(SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt);
//
//
//    if (retcode != SQL_SUCCESS)
//	{
//        g_DBNew[AUTOMATA_THREAD].ReleaseDB(db_index);
//        return -1; // ·µ»Ø -1 ±íÊ¾·¢Éú´íÎó
//    }
//
//    // Ö´ÐÐ SQL ²éÑ¯
//    retcode = SQLExecDirect(hstmt, (unsigned char*)szSQL, SQL_NTS);
//    if (retcode != SQL_SUCCESS && retcode != SQL_SUCCESS_WITH_INFO) {
//        SQLFreeHandle(SQL_HANDLE_STMT, hstmt);
//        g_DBNew[AUTOMATA_THREAD].ReleaseDB(db_index);
//        return -1; // ·µ»Ø -1 ±íÊ¾·¢Éú´íÎó
//    }
//
//    // »ñÈ¡½á¹û
//    retcode = SQLFetch(hstmt);
//    if (retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO) {
//        SQLGetData(hstmt, 1, SQL_C_LONG, &maxLevel, sizeof(maxLevel), &sInd); // ¼ÙÉè sLevel ÊÇÒ»¸öÕûÊýÀàÐÍ
//    }
//
//    SQLFreeHandle(SQL_HANDLE_STMT, hstmt);
//    g_DBNew[AUTOMATA_THREAD].ReleaseDB(db_index);
//
//
//
//    return maxLevel; // ·µ»Ø×î´óÖµ
//}
int USER::ShowUserRank()
{
    SQLHSTMT hstmt = NULL;
    SQLRETURN retcode;
    TCHAR szSQL[1024];
    int maxLevel = 1;  // ±£³ÖÄ¬ÈÏµÈ¼¶1
    SQLINTEGER sInd;

    // SQL²éÑ¯Óï¾ä - Ö»ÐèÒªÅÅ³ý¹ÜÀíÔ±¼´¿É
    _sntprintf_s(szSQL, sizeof(szSQL), _TRUNCATE, 
        TEXT("SELECT MAX(sLevel) FROM GameUser WHERE tIsOP = 0"));

    // »ñÈ¡Êý¾Ý¿âÁ¬½Ó
    int db_index = 0;
    CDatabase* pDB = g_DBNew[AUTOMATA_THREAD].GetDB(db_index);
    if (!pDB) 
    {
        TRACE("ShowUserRank: Êý¾Ý¿âÁ¬½ÓÊ§°Ü\n");
        return 1;
    }

    // ·ÖÅäSQL¾ä±ú
    retcode = SQLAllocHandle(SQL_HANDLE_STMT, pDB->m_hdbc, &hstmt);
    if (retcode != SQL_SUCCESS)
    {
        g_DBNew[AUTOMATA_THREAD].ReleaseDB(db_index);
        return 1;
    }

    // Ö´ÐÐ²éÑ¯
    retcode = SQLExecDirect(hstmt, (SQLCHAR*)szSQL, SQL_NTS);
    if (retcode != SQL_SUCCESS && retcode != SQL_SUCCESS_WITH_INFO)
    {
        SQLFreeHandle(SQL_HANDLE_STMT, hstmt);
        g_DBNew[AUTOMATA_THREAD].ReleaseDB(db_index);
        return 1;
    }

    // »ñÈ¡½á¹û
    retcode = SQLFetch(hstmt);
    if (retcode == SQL_SUCCESS || retcode == SQL_SUCCESS_WITH_INFO)
    {
        SQLGetData(hstmt, 1, SQL_C_LONG, &maxLevel, sizeof(maxLevel), &sInd);
    }

    // ÇåÀí×ÊÔ´
    SQLFreeHandle(SQL_HANDLE_STMT, hstmt);
    g_DBNew[AUTOMATA_THREAD].ReleaseDB(db_index);

    return maxLevel;
}
int USER::CalcItemPingfen(ItemList* pItem) //ÆÀ·ÖÖµ¼ÆËã
{
    // »ù´¡¼ì²é
    if(!pItem || !g_arItemTable.GetSize()) return 0;
    if(pItem->sSid < 0 || pItem->sSid >= g_arItemTable.GetSize()) return 0;
    
    const int tClass = g_arItemTable[pItem->sSid]->m_byWear;
    const int zhiye = g_arItemTable[pItem->sSid]->m_byClass;
    
    // Ö»ÆÀ·ÖÎäÆ÷ºÍ×°±¸
    if(tClass < 1 || tClass > 5) return 0;
    
    int pingfen = 0;
    bool hasStr = false;  // ³õÊ¼»¯±ê¼Ç±äÁ¿
    bool hasDex = false;
    bool hasVol = false;

    // ÏÈ¼ì²éÊÇ·ñÓÐÈýÎ¬ÊôÐÔ
    for(int i = 0; i < MAGIC_NUM; i++) {
        if(pItem->tMagic[i] <= 0 || pItem->tMagic[i] >= g_arMagicItemTable.GetSize()) continue;
        
        const int shuxing = pItem->tMagic[i];
        
        // ¼ì²éÁ¦Á¿
        if(shuxing == 43 || shuxing == 86 || shuxing == 107) {
            hasStr = true;
        }
        // ¼ì²éÃô½Ý
        if(shuxing == 45 || shuxing == 88 || shuxing == 109) {
            hasDex = true;
        }
        // ¼ì²éÖÇ»Û
        if(shuxing == 46 || shuxing == 89 || shuxing == 110) {
            hasVol = true;
        }
    }

    // ÊôÐÔ³åÍ»¼ì²é  Á¦+Ãô        Ãô+ÖÇ»Û            Á¦ºÍÖÇ»Û
    if((hasStr && hasDex) || (hasDex && hasVol) || (hasStr && hasVol)) {
        return 0;
    }

    // Ö°ÒµÊôÐÔ¼ì²é - Èç¹ûÓÐ²»·ûºÏÖ°ÒµµÄÊôÐÔÖ±½Ó·µ»Ø0
    switch(zhiye) {
        case 8: // È­
        case 2: // µ¶
            if(hasVol || hasDex) return 0;
            break;
        case 4: // ·¨
            if(hasStr || hasDex) return 0;
            break;
        case 1: // Ç¹
            if(hasVol || hasStr) return 0;
            break;
    }

    // ¿ªÊ¼¼ÆËãÆÀ·Ö
    for(int i = 0; i < MAGIC_NUM; i++) {
        if(pItem->tMagic[i] <= 0 || pItem->tMagic[i] >= g_arMagicItemTable.GetSize()) continue;
            
        const int shuxing = pItem->tMagic[i];
        
        if(tClass == 1)  // ÎäÆ÷ÆÀ·Ö
        {
            if(shuxing == 93)  // 3ËÙ
            {
                if(zhiye != 4)  // ·Ç·¨Ê¦
                {
                    pingfen += 50;
                }
                continue;
            }
            // Ò»¼¶ÊôÐÔ(50·Ö)
            if(shuxing == 138 ||    // ÃüÖÐ10
               shuxing == 128 ||    // ËðÉË25
               shuxing == 93  ||    // 3ËÙ
               shuxing == 145 ||    // ËùÓÐ2
               shuxing == 113 ||    // ÐË·Ü2
               shuxing == 125 ||    // Á¬Éä2
               shuxing == 120 ||    // ´©´Ì2
               shuxing == 136 ||    // Ä§¹¥25
               shuxing == 117)      // ·¨Êõ2
            {
                pingfen += 50;
            }
            // ¶þ¼¶ÊôÐÔ(45·Ö)
            else if(shuxing == 95  ||    // ÃüÖÐ9
                    shuxing == 91  ||    // ËðÊ§20
                    shuxing == 137 ||    // ËùÓÐ1
                    shuxing == 49  ||    // ÐË·Ü1
                    shuxing == 61  ||    // Á¬Éä1
                    shuxing == 56  ||    // ´©´Ì1
                    shuxing == 106 ||    // Ä§¹¥20
                    shuxing == 53)       // ·¨Êõ1
            {
                pingfen += 45;
            }
            // Èý¼¶ÊôÐÔ(40·Ö)
            else if(shuxing == 94 ||     // ÃüÖÐ8
                    shuxing == 64 ||     // ËðÊ§15
                    shuxing == 74)       // ÃüÖÐ7
            {
                pingfen += 40;
            }
        }
        else if(tClass > 1 && tClass < 6)  // ×°±¸ÆÀ·Ö
        {
            // Ò»¼¶ÊôÐÔ(50·Ö)
            if(shuxing == 141 ||    // 50Ñª
               shuxing == 135 ||    // 25¿¹
               shuxing == 139 ||    // 10»Ø
               shuxing == 107 ||    // 5Á¦
               shuxing == 109 ||    // 5Ãô
               shuxing == 110)      // 5ÖÇ
            {
                pingfen += 50;
            }
            // ¶þ¼¶ÊôÐÔ(40·Ö)
            else if(shuxing == 132 ||    // 40Ñª
                    shuxing == 105 ||    // 20¿¹
                    shuxing == 97  ||    // 9»Ø
                    shuxing == 86  ||    // 4Á¦
                    shuxing == 88  ||    // 4Ãô
                    shuxing == 89)       // 4ÖÇ
            {
                pingfen += 40;
            }
            // Èý¼¶ÊôÐÔ(30·Ö)
            else if(shuxing == 102 ||    // 30Ñª
                    shuxing == 84  ||    // 15¿¹
                    shuxing == 96  ||    // 8»Ø
                    shuxing == 43  ||    // 3Á¦
                    shuxing == 45  ||    // 3Ãô
                    shuxing == 46  ||    // 3ÖÇ
                    shuxing == 130)      // 10·À
            {
                pingfen += 30;
            }
        }
    }

    return pingfen;
}